CLASS zrm_cl_lic_badi_dades_exped_rt DEFINITION
  PUBLIC
  FINAL
  CREATE PUBLIC .

*"* public components of class ZRM_CL_LIC_BADI_DADES_EXPED_RT
*"* do not include other source files here!!!
  PUBLIC SECTION.

    INTERFACES if_badi_interface .
    INTERFACES zrm_if_badi_dades_expedient .

    CONSTANTS gc_oferta_base TYPE z_tipus_oferta VALUE 'B' ##NO_TEXT.
    CONSTANTS gc_oferta_variant TYPE z_tipus_oferta VALUE 'V' ##NO_TEXT.

    CLASS-METHODS get_company_name
      IMPORTING
        !im_company    TYPE bukrs
      RETURNING
        VALUE(re_name) TYPE string .
    METHODS get_z_certificat_ok
      IMPORTING
        !im_docclass  TYPE sdok_class
        !im_objectid  TYPE sdok_docid
        !im_tipus_doc TYPE z_tip_doc
      EXPORTING
        !ex_return    TYPE flag
      EXCEPTIONS
        not_found .
    CLASS-METHODS get_vendor_name
      IMPORTING
        !im_vendor     TYPE lifnr
      RETURNING
        VALUE(re_name) TYPE string .
    CLASS-METHODS get_dades_director_divisio
      IMPORTING
        !im_docclass   TYPE bapidclass
        !im_objectid   TYPE bapiguid
      RETURNING
        VALUE(re_data) TYPE REF TO zerm_dades_direc_div
      EXCEPTIONS
        not_found .
    CLASS-METHODS get_dades_gerent
      IMPORTING
        !im_docclass   TYPE bapidclass
        !im_objectid   TYPE bapiguid
      RETURNING
        VALUE(re_data) TYPE REF TO zerm_dades_gerent
      EXCEPTIONS
        not_found .
    METHODS get_exclusio_s12pt
      IMPORTING
        !im_docclass TYPE sdok_class
        !im_objectid TYPE sdok_docid
      EXPORTING
        !ex_data     TYPE ztt_ofertes_exclos .
    METHODS get_motiu_s2
      IMPORTING
        !im_docclass   TYPE sdok_class
        !im_objectid   TYPE sdok_docid
      RETURNING
        VALUE(ex_data) TYPE REF TO data
      EXCEPTIONS
        not_found .
    METHODS get_empreses_tem
      IMPORTING
        !im_docclass TYPE sdok_class
        !im_objectid TYPE sdok_docid
      EXPORTING
        !ex_data     TYPE ztt_empreses_tem .
  PROTECTED SECTION.

    TYPES:
      BEGIN OF zt_oferta,
        docclass         TYPE bapidclass,
        objectid         TYPE bapiguid,
        proveidor        TYPE z_proveidor,
        num_ofer         TYPE z_num_ofer,
        tipus_oferta     TYPE z_tipus_oferta,
        agrupador        TYPE zrm_dm_docs-z_agrup_doc,
        motiu_esmena     TYPE zrm_dm_docs-z_motiu_esmena,
        provcompute      TYPE zrm_dt_val_crit-zprovcompute,
        num_doc          TYPE zrm_dt_val_crit-z_num_doc,
        lliurat          TYPE zrm_dt_val_crit-z_lliurat,
        correcte         TYPE zrm_dt_val_crit-z_correcte,
        esmenat          TYPE zrm_dt_val_crit-z_esmenat,
        exclos_s1s2      TYPE zrm_dt_val_crit-z_exclos_s1s2,
        excl_pos_esm     TYPE zrm_dt_val_crit-z_excl_pos_esm,
        exclos_s3        TYPE zrm_dt_ofertes-z_exclos_s3,  "EDASB 22/06/07
        temerari         TYPE zrm_dt_ofertes-z_temerari,   "EDASB 22/06/07
        excl_homog       TYPE zrm_dt_ofertes-z_excl_homog, "EDASB 22/06/07
        z_import_homog   TYPE zrm_dt_ofertes-z_import_homog,   "EDASB 13/11/07
        z_presump_temer  TYPE zrm_dt_ofertes-z_presump_temer,  "EDASB 13/11/07
        z_pres_tem_homog TYPE zrm_dt_ofertes-z_pres_tem_homog, "EDASB 13/11/07
        z_exclos_s2      TYPE z_exclos_s2,
        z_tipus_exc_s2   TYPE z_tipus_exc_s2,
        z_exclos_s1      TYPE z_exclos_s1,
        z_pres_proposta  TYPE zrm_dt_ofertes-z_pres_proposta,  "EDLSM 05/01/07
        z_no_aplica      TYPE zrm_dt_val_crit-z_no_aplica, "SPEC-49881
      END   OF zt_oferta .
    TYPES:
      ztt_oferta TYPE STANDARD TABLE OF zt_oferta .
    TYPES:
      BEGIN OF ty_s_quadre3_cache,
        tipus_oferta TYPE zrm_dt_ofertes-z_tipus_oferta,
        sort_by      TYPE fieldname,
        quadre       TYPE REF TO data,
        vincles      TYPE REF TO data,
      END OF ty_s_quadre3_cache .
    TYPES:
      ty_crit_punt TYPE STANDARD TABLE OF zrm_dm_crit_punt .
    TYPES:
      ty_t_quadre3_cache TYPE HASHED TABLE OF ty_s_quadre3_cache WITH UNIQUE KEY tipus_oferta sort_by .
    TYPES:
      ty_t_esmena_sx TYPE STANDARD TABLE OF zerm_gmd_lic_esmena_s1 WITH NON-UNIQUE DEFAULT KEY .
    TYPES:
      ty_t_motiu_esm_s2 TYPE STANDARD TABLE OF zerm_motiu_esmena_s2 WITH NON-UNIQUE DEFAULT KEY .
    TYPES:
      ty_t_quadre5 TYPE STANDARD TABLE OF zerm_quadre5 WITH NON-UNIQUE DEFAULT KEY .
    TYPES:
      BEGIN OF ty_s_valcrit,
        proveidor          TYPE zrm_dt_ofertes-proveidor,
        z_num_ofer         TYPE zrm_dt_ofertes-z_num_ofer,
        z_tipus_oferta     TYPE zrm_dt_ofertes-z_tipus_oferta,
        z_exclos_s3        TYPE zrm_dt_ofertes-z_exclos_s3,
        z_exclos_s2        TYPE zrm_dt_ofertes-z_exclos_s2,
        z_codi_excl_s3     TYPE zrm_dt_ofertes-z_codi_excl_s3,
        z_esmena_s3        TYPE zrm_dt_ofertes-z_esmena_s3, "ETODR SPEC-53131
        z_exclos_s3_postob TYPE zrm_dt_ofertes-z_exclos_s3_postob, "ETODR SPEC-53131
        z_exclos_var_tec   TYPE zrm_dt_ofertes-z_exclos_var_tec,
        z_num_sob          TYPE zrm_dm_sobres-z_num_sob,
        z_num_doc          TYPE zrm_dt_val_crit-z_num_doc,
        zprovcompute       TYPE zrm_dt_val_crit-zprovcompute,
        z_lliurat          TYPE zrm_dt_val_crit-z_lliurat,
        z_correcte         TYPE zrm_dt_val_crit-z_correcte,
        z_esmenat          TYPE zrm_dt_val_crit-z_esmenat,
        z_data_esmena      TYPE zrm_dt_val_crit-z_data_esmena,
        z_exclos_s1s2      TYPE zrm_dt_val_crit-z_exclos_s1s2,
        z_excl_pos_esm     TYPE zrm_dt_val_crit-z_excl_pos_esm,
        z_pres_proposta    TYPE zrm_dt_ofertes-z_pres_proposta,  "EDLSM
        z_sec_s1           TYPE zrm_dt_val_crit-z_sec_s1,
        z_tipus_sob        TYPE zrm_dt_val_crit-z_tipus_sob,
        objectid           TYPE zrm_dt_exp_cont-objectid,
        z_llei92017        TYPE zrm_dt_exp_cont-z_llei92017,
        z_exclos_clau      TYPE zrm_dt_ofertes-z_exclos_clau, "SPEC-55767
      END OF ty_s_valcrit .
    TYPES:
      ty_t_group TYPE TABLE OF konzs WITH NON-UNIQUE DEFAULT KEY .
    TYPES:
      BEGIN OF ty_s_group_key,
        konzs   TYPE lfa1-konzs,
        t_lifnr TYPE HASHED TABLE OF lifnr WITH UNIQUE DEFAULT KEY,
      END OF ty_s_group_key .
    TYPES:
      ty_t_group_key TYPE HASHED TABLE OF ty_s_group_key WITH UNIQUE KEY konzs .
    TYPES:
      BEGIN OF ty_s_proveidor,
        nom_proveidor TYPE string,
        real_konzs    TYPE lfa1-konzs,
        zute          TYPE lfa1-zute,
      END OF ty_s_proveidor .
    TYPES:
      BEGIN OF ty_s_compute.
        INCLUDE TYPE zmm_dt_ute.
        INCLUDE TYPE ty_s_proveidor AS vendor_data.
      TYPES: END OF ty_s_compute .
    TYPES:
      ty_t_compute TYPE STANDARD TABLE OF ty_s_compute WITH NON-UNIQUE KEY lifnr .
    TYPES:
      BEGIN OF ty_s_vincle,
        text TYPE string,
      END OF ty_s_vincle .
    TYPES:
      ty_t_vincle TYPE STANDARD TABLE OF ty_s_vincle WITH NON-UNIQUE DEFAULT KEY .
    TYPES:
      BEGIN OF ty_s_oferta.
        INCLUDE TYPE zrm_dt_ofertes AS offer_data.
        INCLUDE TYPE ty_s_proveidor AS vendor_data.
        TYPES:  related_offers TYPE HASHED TABLE OF lifnr WITH UNIQUE DEFAULT KEY,
        all_konzs      TYPE HASHED TABLE OF konzs WITH UNIQUE DEFAULT KEY,
        z_num_variant  TYPE z_num_variant,
      END OF ty_s_oferta .
    TYPES:
      ty_t_oferta TYPE STANDARD TABLE OF ty_s_oferta WITH NON-UNIQUE KEY z_num_ofer .
    TYPES:
      BEGIN OF ty_s_entitat,
        proveidor       TYPE lifnr,
        nom_proveidor   TYPE string,
        llista_nom_prov TYPE string,
      END OF ty_s_entitat .
    TYPES:
      ty_t_entitat           TYPE STANDARD TABLE OF ty_s_entitat WITH NON-UNIQUE KEY proveidor .
    TYPES:
      ty_t_valcrit           TYPE STANDARD TABLE OF ty_s_valcrit WITH DEFAULT KEY .
    TYPES ty_t_exclusio_sx TYPE ty_t_esmena_sx .
    TYPES ty_t_exclusiopostes_sx TYPE ty_t_esmena_sx .
    TYPES ty_t_ent_ex_sobre1 TYPE ty_t_entitat .
    TYPES ty_t_ent_ober_pliq TYPE ty_t_entitat .
    TYPES ty_t_ex_sobre3 TYPE ty_t_entitat .
    TYPES:
      ty_t_quadrecp3 TYPE TABLE OF zerm_quadrecp3 .
    TYPES:
      ty_t_quadre_lots TYPE TABLE OF zerm_quadre_lots .
    TYPES:
      ty_t_qdc_rapli TYPE TABLE OF zerm_qdc_rapli .
    TYPES:
      ty_t_quadre_matco2 TYPE TABLE OF zerm_quadre_matco2 .
    TYPES: ty_t_qdc_docs TYPE TABLE OF zerm_qdc_docs.
    TYPES: ty_t_qdc_clo_lic TYPE TABLE OF zerm_qdc_clo_lic.

    DATA my_data_term48h TYPE REF TO data .
    DATA my_com_ex_sobre1 TYPE REF TO data .
    DATA my_admes_sobre1 TYPE REF TO data .
    DATA my_ent_ex_sobre1 TYPE REF TO data .
    DATA my_ent_ex_sobre123 TYPE REF TO data .
    DATA my_ent_ex_sobre12 TYPE REF TO data .
    DATA my_ent_ex_sobre2 TYPE REF TO data .
    DATA my_ent_ex_s2 TYPE REF TO data .
    DATA my_ent_ex_var_sobre3 TYPE REF TO data .
    DATA my_ent_es_sobre3 TYPE REF TO data .
    DATA my_ent_ex_post_ob_sobre2 TYPE REF TO data .
    DATA my_ent_ex_post_ob_sobre3 TYPE REF TO data .
    DATA my_ent_ex_sobre3 TYPE REF TO data .
    DATA my_ent_noex_sobre123 TYPE REF TO data .
    DATA my_ent_noex_sobre12 TYPE REF TO data .
    DATA my_ent_noex_var_sobre3 TYPE REF TO data .
    DATA my_ent_ober_pliq TYPE REF TO data .
    DATA my_siesm_noexcl_s3 TYPE REF TO data .
    DATA my_siesm_noexcl_s1 TYPE REF TO data .
    DATA my_noesm_noexcl_s3 TYPE REF TO data .
    DATA my_noesm_noexcl_s1 TYPE REF TO data .
    DATA my_esmena_s1 TYPE REF TO data .
    DATA my_esmena_s2 TYPE REF TO data .
    DATA my_esmena_s3 TYPE REF TO data .
    DATA my_motius_esmena_s2 TYPE REF TO data .
    DATA my_exclusiopostes_s1 TYPE REF TO data .
    DATA my_exclusiopostes_s2 TYPE REF TO data .
    DATA my_exclusiopostes_s3 TYPE REF TO data .
    DATA my_exclusio_s1 TYPE REF TO data .
    DATA my_exclusio_s2 TYPE REF TO data .
    DATA my_exclusio_s3 TYPE REF TO data .
    DATA my_imp_cap TYPE zmm_dt_imp_cap .
    DATA my_exp_cont TYPE zrm_dt_exp_cont .
    DATA:
      BEGIN OF my_extra,
        z_pres_lic_amb_comp_finan     TYPE zrm_dt_exp_cont-z_pressup_licit,
        z_pres_lic_amb_comp_finan_iva TYPE zrm_dt_exp_cont-z_pressup_licit,
        z_lim_sup                     TYPE zrm_dt_exp_cont-z_bm,
        z_lim_inf                     TYPE zrm_dt_exp_cont-z_bm,
        z_lim_sup_homog               TYPE zrm_dt_exp_cont-z_bm,
        z_lim_inf_homog               TYPE zrm_dt_exp_cont-z_bm,
        z_es_quadre_3_esborrany       TYPE xfeld,
        import_adj_30_b               TYPE zrm_dt_exp_cont-z_import_adj_b,
        import_adj_70_b               TYPE zrm_dt_exp_cont-z_import_adj_b,
      END OF my_extra .
    DATA:
      BEGIN OF my_extra2,
        z_empate           TYPE i, "Se marca en caso de que haya empate en la puntuación total
        z_2_dies_abans_con TYPE zzconsprev, "Calcula el martes antes del consejo previsto
      END OF my_extra2 .
    DATA my_ofertes TYPE ty_t_oferta .
    DATA my_prov_altern TYPE REF TO data .
    DATA my_quadre5 TYPE REF TO data .
    DATA my_quadre3_cache TYPE ty_t_quadre3_cache .
    DATA my_valoracio_criteris TYPE ty_t_valcrit .
    DATA my_sel2v TYPE REF TO data .
    DATA my_inclou_tem TYPE REF TO data .
    DATA my_no_inclou_tem TYPE REF TO data .
    DATA my_esmex_s1 TYPE REF TO data .
    DATA my_esmex_s2 TYPE REF TO data .
    DATA my_ent_ex_homog TYPE REF TO data .
    DATA my_ict_ent_ex_sobre3 TYPE REF TO data .
    DATA my_ict_ent_ex_sobre2 TYPE REF TO data .
    DATA my_ent_ex_vartec TYPE REF TO data .
    DATA my_met_press TYPE REF TO data .
    DATA my_dades_recurrent TYPE REF TO zrm_dt_ofertes .
    DATA my_inclou_tem_nsp TYPE REF TO data .
    DATA my_no_inclou_tem_n TYPE REF TO data .
    DATA my_crit_punt TYPE zrm_dm_crit_punt .
    DATA my_ent_inf_temerari TYPE REF TO data .
    DATA my_ict_ent_ex_post_ob TYPE REF TO data .
    DATA my_quadrecp3 TYPE REF TO data .
    DATA my_esmenat_s3_sde TYPE REF TO data .
    DATA my_si_exclos_no_esmenat_sde TYPE REF TO data .
    DATA my_no_exclos_no_esmena_s3_sde TYPE REF TO data .
    DATA my_qdc_rapli TYPE REF TO data .
    DATA my_quadre_lots TYPE REF TO data .
    DATA my_text_imp_lots TYPE REF TO data .
    DATA my_text_sapscript TYPE REF TO data.
    DATA my_hora_pres_ofer_add1 TYPE REF TO data .
    DATA my_quadre_matco2 TYPE REF TO data .
    DATA my_qdc_docs TYPE REF TO data .
    DATA my_qdc_clo_lic TYPE REF TO data.

    METHODS get_noesm_no_excl_sx
      IMPORTING
        !im_docclass   TYPE sdok_class
        !im_objectid   TYPE sdok_docid
        !im_num_sob    TYPE z_num_sob
      RETURNING
        VALUE(ex_data) TYPE REF TO data
      EXCEPTIONS
        not_found .
    METHODS get_areal_col
      IMPORTING
        !im_docclass   TYPE bapidclass
        !im_objectid   TYPE bapiguid
      RETURNING
        VALUE(re_data) TYPE REF TO data
      EXCEPTIONS
        not_found .
    METHODS get_com_ex_sobre1
      IMPORTING
        !im_docclass   TYPE sdok_class
        !im_objectid   TYPE sdok_docid
      RETURNING
        VALUE(ex_data) TYPE REF TO data
      EXCEPTIONS
        not_found .
    METHODS get_ent_ex_sobre123
      IMPORTING
        !im_docclass   TYPE sdok_class
        !im_objectid   TYPE sdok_docid
      RETURNING
        VALUE(ex_data) TYPE REF TO data
      EXCEPTIONS
        not_found .
    METHODS get_ent_ex_sobre12
      IMPORTING
        !im_docclass   TYPE sdok_class
        !im_objectid   TYPE sdok_docid
      RETURNING
        VALUE(ex_data) TYPE REF TO data
      EXCEPTIONS
        not_found .
    METHODS get_ent_ex_var_sobre3
      IMPORTING
        !im_docclass   TYPE sdok_class
        !im_objectid   TYPE sdok_docid
      RETURNING
        VALUE(ex_data) TYPE REF TO data
      EXCEPTIONS
        not_found .
    METHODS get_ent_ex_sobre3_new
      IMPORTING
        !im_docclass   TYPE sdok_class
        !im_objectid   TYPE sdok_docid
      RETURNING
        VALUE(ex_data) TYPE REF TO data
      EXCEPTIONS
        not_found .
    METHODS get_ent_ex_sobre3
      IMPORTING
        !im_docclass   TYPE sdok_class
        !im_objectid   TYPE sdok_docid
      RETURNING
        VALUE(ex_data) TYPE REF TO data
      EXCEPTIONS
        not_found .
    METHODS get_ent_ex_s3
      IMPORTING
        !im_docclass   TYPE sdok_class
        !im_objectid   TYPE sdok_docid
      RETURNING
        VALUE(ex_data) TYPE REF TO data
      EXCEPTIONS
        not_found .
    METHODS get_ent_noex_sobre123_pt
      IMPORTING
        !im_docclass   TYPE sdok_class
        !im_objectid   TYPE sdok_docid
      RETURNING
        VALUE(ex_data) TYPE REF TO data
      EXCEPTIONS
        not_found .
    METHODS get_ent_noex_sobre123_notem
      IMPORTING
        !im_docclass   TYPE sdok_class
        !im_objectid   TYPE sdok_docid
        !iv_temerari   TYPE xfeld
      RETURNING
        VALUE(ex_data) TYPE REF TO data
      EXCEPTIONS
        not_found .
    METHODS get_ent_noex_sobre123_tem
      IMPORTING
        !im_docclass   TYPE sdok_class
        !im_objectid   TYPE sdok_docid
        !iv_temerari   TYPE xfeld
      RETURNING
        VALUE(ex_data) TYPE REF TO data
      EXCEPTIONS
        not_found .
    METHODS get_ict_ent_ex_sobre2
      IMPORTING
        !im_docclass   TYPE sdok_class
        !im_objectid   TYPE sdok_docid
      RETURNING
        VALUE(ex_data) TYPE REF TO data
      EXCEPTIONS
        not_found .
    METHODS get_ict_ent_ex_sobre3
      IMPORTING
        !im_docclass   TYPE sdok_class
        !im_objectid   TYPE sdok_docid
      RETURNING
        VALUE(ex_data) TYPE REF TO data
      EXCEPTIONS
        not_found .
    METHODS get_ent_ex_vartec
      IMPORTING
        !im_docclass   TYPE sdok_class
        !im_objectid   TYPE sdok_docid
      RETURNING
        VALUE(ex_data) TYPE REF TO data
      EXCEPTIONS
        not_found .
    METHODS get_ent_ex_homog
      IMPORTING
        !im_docclass   TYPE sdok_class
        !im_objectid   TYPE sdok_docid
      RETURNING
        VALUE(ex_data) TYPE REF TO data
      EXCEPTIONS
        not_found .
    METHODS get_ent_ex_sobrex
      IMPORTING
        !im_docclass   TYPE sdok_class
        !im_objectid   TYPE sdok_docid
        !im_num_sob    TYPE z_num_sob
      RETURNING
        VALUE(ex_data) TYPE REF TO data
      EXCEPTIONS
        not_found .
    METHODS get_z_dades_recurrent
      IMPORTING
        !im_docclass   TYPE bapidclass
        !im_objectid   TYPE bapiguid
      RETURNING
        VALUE(ex_data) TYPE REF TO zrm_dt_ofertes
      EXCEPTIONS
        not_found .
    METHODS get_ent_noex_sobre123
      IMPORTING
        !im_docclass   TYPE sdok_class
        !im_objectid   TYPE sdok_docid
      RETURNING
        VALUE(ex_data) TYPE REF TO data
      EXCEPTIONS
        not_found .
    METHODS get_ent_noex_sobre12
      IMPORTING
        !im_docclass   TYPE sdok_class
        !im_objectid   TYPE sdok_docid
      RETURNING
        VALUE(ex_data) TYPE REF TO data
      EXCEPTIONS
        not_found .
    METHODS get_ent_noex_var_sobre3
      IMPORTING
        !im_docclass   TYPE sdok_class
        !im_objectid   TYPE sdok_docid
      RETURNING
        VALUE(ex_data) TYPE REF TO data
      EXCEPTIONS
        not_found .
    METHODS get_ent_ober_pliq
      IMPORTING
        !im_docclass   TYPE sdok_class
        !im_objectid   TYPE sdok_docid
      RETURNING
        VALUE(ex_data) TYPE REF TO data
      EXCEPTIONS
        not_found .
    METHODS get_ent_ober_pliq_s1_s2
      IMPORTING
        !im_docclass   TYPE sdok_class
        !im_objectid   TYPE sdok_docid
      RETURNING
        VALUE(ex_data) TYPE REF TO data
      EXCEPTIONS
        not_found .
    METHODS get_esmena_sx
      IMPORTING
        !im_docclass   TYPE sdok_class
        !im_objectid   TYPE sdok_docid
        !im_num_sob    TYPE z_num_sob
      RETURNING
        VALUE(ex_data) TYPE REF TO data
      EXCEPTIONS
        not_found .
    METHODS get_esmex_sx
      IMPORTING
        !im_docclass   TYPE sdok_class
        !im_objectid   TYPE sdok_docid
        !im_num_sob    TYPE z_num_sob
      RETURNING
        VALUE(ex_data) TYPE REF TO data
      EXCEPTIONS
        not_found .
    METHODS get_exclusiopostes_sx
      IMPORTING
        !im_docclass   TYPE sdok_class
        !im_objectid   TYPE sdok_docid
        !im_num_sob    TYPE z_num_sob
      RETURNING
        VALUE(ex_data) TYPE REF TO data
      EXCEPTIONS
        not_found .
    METHODS get_exclusio_sx
      IMPORTING
        !im_docclass   TYPE sdok_class
        !im_objectid   TYPE sdok_docid
        !im_num_sob    TYPE z_num_sob
        !im_carta      TYPE flag
      RETURNING
        VALUE(ex_data) TYPE REF TO data
      EXCEPTIONS
        not_found .
    METHODS get_inclou_tem
      IMPORTING
        !im_docclass   TYPE sdok_class
        !im_objectid   TYPE sdok_docid
      RETURNING
        VALUE(ex_data) TYPE REF TO data
      EXCEPTIONS
        not_found .
    METHODS get_no_inclou_tem
      IMPORTING
        !im_docclass   TYPE sdok_class
        !im_objectid   TYPE sdok_docid
      RETURNING
        VALUE(ex_data) TYPE REF TO data
      EXCEPTIONS
        not_found .
    METHODS get_prov_altern
      IMPORTING
        !im_docclass   TYPE sdok_class
        !im_objectid   TYPE sdok_docid
      RETURNING
        VALUE(ex_data) TYPE REF TO data
      EXCEPTIONS
        not_found .
    METHODS get_quadre_obertura_simpl
      IMPORTING
        !im_docclass     TYPE sdok_class
        !im_objectid     TYPE sdok_docid
        !im_sort_by      TYPE fieldname
        !im_tipus_oferta TYPE zrm_dt_ofertes-z_tipus_oferta
        !iv_simplificat  TYPE xfeld OPTIONAL
      EXPORTING
        !ex_quadre       TYPE REF TO data
        !ex_vincles      TYPE REF TO data
      EXCEPTIONS
        not_found .
    METHODS get_quadre3
      IMPORTING
        !im_docclass     TYPE sdok_class
        !im_objectid     TYPE sdok_docid
        !im_sort_by      TYPE fieldname
        !im_tipus_oferta TYPE zrm_dt_ofertes-z_tipus_oferta
        !im_obertura     TYPE xfeld OPTIONAL
      EXPORTING
        !ex_quadre       TYPE REF TO data
        !ex_vincles      TYPE REF TO data
      EXCEPTIONS
        not_found .
    CLASS-METHODS get_quadre3_baixa
      IMPORTING
        !im_numerator   TYPE numeric DEFAULT 0
        !im_denominator TYPE numeric DEFAULT 0
      EXPORTING
        !ex_baixa       TYPE stringval
        !ex_baixa_int   TYPE z_perc_baixa .
    CLASS-METHODS get_quadre3_durada
      IMPORTING
        !im_durada       TYPE numeric
        !im_unit         TYPE z_un_term_exec DEFAULT zrm_cl_time_utils=>co_rms_mes
      RETURNING
        VALUE(re_string) TYPE string .
    METHODS get_met_press
      IMPORTING
        !im_docclass   TYPE sdok_class
        !im_objectid   TYPE sdok_docid
      RETURNING
        VALUE(ex_data) TYPE REF TO data
      EXCEPTIONS
        not_found .
    METHODS get_sel2v
      IMPORTING
        !im_docclass   TYPE sdok_class
        !im_objectid   TYPE sdok_docid
      RETURNING
        VALUE(ex_data) TYPE REF TO data
      EXCEPTIONS
        not_found .
    METHODS get_met_press2
      IMPORTING
        !im_docclass   TYPE sdok_class
        !im_objectid   TYPE sdok_docid
      RETURNING
        VALUE(ex_data) TYPE REF TO data
      EXCEPTIONS
        not_found .
    METHODS get_tipus_exclus_s2
      IMPORTING
        !im_objectid   TYPE sdok_docid
        !im_docclass   TYPE sdok_class
      RETURNING
        VALUE(ex_data) TYPE REF TO data
      EXCEPTIONS
        not_found .
    METHODS get_criteris_punt
      IMPORTING
        !im_objectid   TYPE sdok_docid
        !im_docclass   TYPE sdok_class
      RETURNING
        VALUE(ex_data) TYPE REF TO data .
    METHODS get_licitadors_empatats
      IMPORTING
        !im_objectid   TYPE sdok_docid
        !im_docclass   TYPE sdok_class
      RETURNING
        VALUE(ex_data) TYPE REF TO data .
    METHODS get_quadre_2b_pt
      IMPORTING
        !im_objectid   TYPE sdok_docid
        !im_docclass   TYPE sdok_class
      RETURNING
        VALUE(ex_data) TYPE REF TO data .
    METHODS get_quadre_3_import
      IMPORTING
        !im_objectid   TYPE sdok_docid
        !im_docclass   TYPE sdok_class
      RETURNING
        VALUE(ex_data) TYPE REF TO data .
    METHODS get_quadre_4_punt_total
      IMPORTING
        !im_objectid   TYPE sdok_docid
        !im_docclass   TYPE sdok_class
      RETURNING
        VALUE(ex_data) TYPE REF TO data .
    METHODS get_ent_inf_temerari
      IMPORTING
        !im_docclass   TYPE sdok_class
        !im_objectid   TYPE sdok_docid
      RETURNING
        VALUE(ex_data) TYPE REF TO data
      EXCEPTIONS
        not_found .
    METHODS get_admes_sobre1
      IMPORTING
        !im_docclass   TYPE sdok_class
        !im_objectid   TYPE sdok_docid
        !im_num_sob    TYPE z_num_sob
      RETURNING
        VALUE(ex_data) TYPE REF TO data
      EXCEPTIONS
        not_found .
    METHODS get_exclos_sobre1
      IMPORTING
        !im_docclass   TYPE sdok_class
        !im_objectid   TYPE sdok_docid
        !im_num_sob    TYPE z_num_sob
      RETURNING
        VALUE(ex_data) TYPE REF TO data
      EXCEPTIONS
        not_found .
    METHODS get_data_term48h
      IMPORTING
        !im_docclass   TYPE sdok_class
        !im_objectid   TYPE sdok_docid
      RETURNING
        VALUE(ex_data) TYPE datum
      EXCEPTIONS
        not_found .
    METHODS get_quadre_2a_cp
      IMPORTING
        !im_docclass     TYPE sdok_class
        !im_objectid     TYPE sdok_docid
        !im_sort_by      TYPE fieldname
        !im_tipus_oferta TYPE zrm_dt_ofertes-z_tipus_oferta
      EXPORTING
        !ex_quadre       TYPE REF TO data
        !ex_vincles      TYPE REF TO data
      EXCEPTIONS
        not_found .
    METHODS get_dt_ofertes
      IMPORTING
        !im_docclass TYPE sdok_class
        !im_objectid TYPE sdok_docid
        !im_sort_by  TYPE fieldname OPTIONAL
        !im_obertura TYPE xfeld OPTIONAL
      EXPORTING
        !ex_quadre   TYPE REF TO data
        !ex_vincles  TYPE REF TO data
      EXCEPTIONS
        not_found .
private section.

*"* private components of class ZRM_CL_LIC_BADI_DADES_EXPED_RT
*"* do not include other source files here!!!
  data MY_EXCLOS_SOBRE1 type ref to DATA .

  methods GET_HORA_PRES_OFER_MES_1
    importing
      !IV_DOCCLASS type SDOK_CLASS
      !IV_OBJECTID type SDOK_DOCID
    returning
      value(RO_DATA) type ref to DATA .
  methods GET_ZERM_QUADRE_LOTS
    importing
      !IV_DOCCLASS type SDOK_CLASS
      !IV_OBJECTID type SDOK_DOCID
    returning
      value(RO_DATA) type ref to DATA .
  methods GET_TEXT_SAPSCRIPT
    importing
      !IV_DOCCLASS type SDOK_CLASS
      !IV_OBJECTID type SDOK_DOCID
      !IV_TDID type THEAD-TDID
      !IV_TDOBJECT type THEAD-TDOBJECT
      !IV_TDNAME type THEAD-TDNAME
    returning
      value(RO_DATA) type ref to DATA .
  methods GET_Z_IMPORT_VAR_ADJ
    importing
      !IM_DOCCLASS type SDOK_CLASS
      !IM_OBJECTID type SDOK_DOCID
    returning
      value(EX_DATA) type ref to DATA .
  methods GET_Z_IMPORT_FIX_ADJ
    importing
      !IM_DOCCLASS type SDOK_CLASS
      !IM_OBJECTID type SDOK_DOCID
    returning
      value(EX_DATA) type ref to DATA .
  methods GET_TIPOL_FIX
    importing
      !IM_DOCCLASS type SDOK_CLASS
      !IM_OBJECTID type SDOK_DOCID
    returning
      value(EX_DATA) type ref to DATA .
  methods GET_QUADRECP3
    importing
      !IM_DOCCLASS type SDOK_CLASS
      !IM_OBJECTID type SDOK_DOCID
    returning
      value(EX_DATA) type ref to DATA .
  methods GET_EXCL_POST_OB_S2
    importing
      !IM_DOCCLASS type SDOK_CLASS
      !IM_OBJECTID type SDOK_DOCID
    returning
      value(EX_DATA) type ref to DATA
    exceptions
      NOT_FOUND .
  methods GET_IMPORT_TIPOL_FIX
    importing
      !IM_DOCCLASS type SDOK_CLASS
      !IM_OBJECTID type SDOK_DOCID
    returning
      value(EX_DATA) type ref to DATA .
  methods GET_IMP_TIP_FIX_OFERTA
    importing
      !IM_DOCCLASS type SDOK_CLASS
      !IM_OBJECTID type SDOK_DOCID
      !IM_NUM_OFER type Z_NUM_OFER
    returning
      value(EX_DATA) type ref to DATA .
  methods GET_QUADRE5
    importing
      !IM_DOCCLASS type SDOK_CLASS
      !IM_OBJECTID type SDOK_DOCID
    returning
      value(EX_DATA) type ref to DATA .
  methods GET_EXCLOS_POST_OB_S3
    importing
      !IM_DOCCLASS type SDOK_CLASS
      !IM_OBJECTID type SDOK_DOCID
    returning
      value(EX_DATA) type ref to DATA
    exceptions
      NOT_FOUND .
  methods GET_ADMESOS_FINAL_S2
    importing
      !IM_DOCCLASS type SDOK_CLASS
      !IM_OBJECTID type SDOK_DOCID
    returning
      value(EX_DATA) type ref to DATA
    exceptions
      NOT_FOUND .
  methods GET_SIESM_NO_EXCL_SX
    importing
      !IM_DOCCLASS type SDOK_CLASS
      !IM_NUM_SOB type Z_NUM_SOB
      !IM_OBJECTID type SDOK_DOCID
    returning
      value(EX_DATA) type ref to DATA
    exceptions
      NOT_FOUND .
  methods GET_IMP_TIP_VARIABLE_OFERTA
    importing
      !IM_DOCCLASS type SDOK_CLASS
      !IM_OBJECTID type SDOK_DOCID
      !IM_NUM_OFER type Z_NUM_OFER
    returning
      value(EX_DATA) type ref to DATA .
  methods GET_IMPORT_TIPOL_VARIABLE
    importing
      !IM_DOCCLASS type SDOK_CLASS
      !IM_OBJECTID type SDOK_DOCID
    returning
      value(EX_DATA) type ref to DATA .
  methods GET_TEXT_TIPOL_VARIABLE
    importing
      !IM_DOCCLASS type SDOK_CLASS
      !IM_OBJECTID type SDOK_DOCID
    returning
      value(EX_DATA) type ref to DATA .
  methods GET_TIPOL_VARIABLE
    importing
      !IM_DOCCLASS type SDOK_CLASS
      !IM_OBJECTID type SDOK_DOCID
    returning
      value(EX_DATA) type ref to DATA .
  methods GET_ENT_ES_SOBRE3
    importing
      !IM_DOCCLASS type SDOK_CLASS
      !IM_OBJECTID type SDOK_DOCID
    returning
      value(EX_DATA) type ref to DATA
    exceptions
      NOT_FOUND .
  methods GET_ICT_ENT_EX_POST_OB
    importing
      !IM_DOCCLASS type SDOK_CLASS
      !IM_OBJECTID type SDOK_DOCID
    returning
      value(EX_DATA) type ref to DATA
    exceptions
      NOT_FOUND .
  methods GET_EXCLOS_POST_OB
    importing
      !IM_DOCCLASS type SDOK_CLASS
      !IM_OBJECTID type SDOK_DOCID
    returning
      value(EX_DATA) type ref to DATA .
  methods GET_MET_PRESSUPOSTARI
    importing
      !PSPNR type PS_POSNR
    exporting
      !PRART type PS_PRART .
  class-methods ADD_VENDOR_TO_GROUP_KEY
    importing
      !IM_LIFNR type LFA1-LIFNR
      !IM_KONZS type LFA1-KONZS
    changing
      !CH_GROUP_KEY type TY_T_GROUP_KEY .
  class-methods COMPLETE_VENDOR_DATA
    importing
      !IM_LIFNR type LFA1-LIFNR
    returning
      value(RE_DATA) type TY_S_PROVEIDOR .
  methods FILL_ESMENA
    importing
      !IM_VALCRIT type TY_S_VALCRIT
      !I_EXCLUSIO type XFELD optional
    changing
      !CS_ESMENA type ZERM_GMD_LIC_ESMENA_S1 .
  methods GET_OFERTES
    importing
      !IM_DOCCLASS type SDOK_CLASS
      !IM_OBJECTID type SDOK_DOCID
    exporting
      !EX_OFERTES type TY_T_OFERTA .
  class-methods GET_UTE_DATA
    importing
      !IM_LIFNR type LFA1-LIFNR
    returning
      value(RE_UTE_DATA) type TY_T_COMPUTE .
  methods GET_VALCRIT
    importing
      !IM_DOCCLASS type SDOK_CLASS
      !IM_OBJECTID type SDOK_DOCID
    exporting
      !EX_VALCRIT type TY_T_VALCRIT .
  class-methods GET_VINCLES
    importing
      !IM_OFERTES type TY_T_OFERTA
      !IM_GROUP type TY_T_GROUP
      !IM_REQ_HOMOG type Z_REQ_HOMOG
    changing
      !CH_VINCLES type TY_T_VINCLE .
  class-methods GET_VINCLES_LOOP
    importing
      !IM_OFERTES type TY_T_OFERTA
      !IM_KONZS type KONZS
      !IM_REQ_HOMOG type Z_REQ_HOMOG
      !IM_NUMBER type I
    changing
      !CH_VINCLES type TY_T_VINCLE .
  class-methods RECALCULATE_GROUP
    changing
      !CH_OFERTES type TY_T_OFERTA .
  class-methods GET_DADES_DIRECTOR_GENERAL
    importing
      !IM_DOCCLASS type BAPIDCLASS
      !IM_OBJECTID type BAPIGUID
    returning
      value(RE_DATA) type ref to ZERM_DADES_DIREC_GENERAL
    exceptions
      NOT_FOUND .
  class-methods GET_DADES_XXXX_IMPULS
    importing
      !IM_DOCCLASS type BAPIDCLASS
      !IM_OBJECTID type BAPIGUID
    exporting
      !EX_DEPARTAMENT type ZMM_DT_IMP_CAP-Z_CODI_DEPAR
      !EX_SOCIETAT type ZMM_DT_IMP_CAP-SOCIETAT
      !EX_DIRECCIO type ZMM_DT_IMP_CAP-Z_CODI_DIREC
    exceptions
      NOT_FOUND .
  class-methods GET_DADES_XXXX_CARREC
    importing
      !IM_PERSNO type PERSNO
      !IM_DIREC type ORGEH optional
    returning
      value(RE_CARREC) type HRP1000-STEXT
    exceptions
      NOT_FOUND .
  class-methods COMPLETE_DADES_PERSONA
    importing
      !IM_GERENT type XFELD default SPACE
    changing
      !CH_DATA type ZERM_DADES_ORGANITZATIVES
    exceptions
      NOT_FOUND .
  class-methods REPLACE_AMOUNT
    importing
      !IM_AMOUNT type NUMERIC
      !IM_AMOUNT_HOLDER type C
      !IM_SPELL_HOLDER type C
    changing
      !C_STRING type STRING .
  methods GET_NO_INCLOU_TEM_NSP
    importing
      !IM_DOCCLASS type SDOK_CLASS
      !IM_OBJECTID type SDOK_DOCID
    returning
      value(EX_DATA) type ref to DATA
    exceptions
      NOT_FOUND .
  methods GET_INCLOU_TEM_NSP
    importing
      !IM_DOCCLASS type SDOK_CLASS
      !IM_OBJECTID type SDOK_DOCID
    returning
      value(EX_DATA) type ref to DATA
    exceptions
      NOT_FOUND .
  methods GET_DADES_SISTEMA_DINAMIC
    importing
      !IM_DOCCLASS type SDOK_CLASS
      !IM_OBJECTID type SDOK_DOCID
    returning
      value(RE_DATA) type ref to ZERM_DADES_GEN_SDE
    exceptions
      NOT_FOUND .
  methods GET_ESMENAT_S3_SDE
    importing
      !IM_DOCCLASS type SDOK_CLASS
      !IM_OBJECTID type SDOK_DOCID
    returning
      value(EX_DATA) type ref to DATA
    exceptions
      NOT_FOUND .
  methods GET_SI_EXCLOS_NO_ESMENAT_SDE
    importing
      !IM_DOCCLASS type SDOK_CLASS
      !IM_OBJECTID type SDOK_DOCID
    returning
      value(EX_DATA) type ref to DATA
    exceptions
      NOT_FOUND .
  methods GET_NO_EXCLOS_NO_ESMENA_S3_SDE
    importing
      !IM_DOCCLASS type SDOK_CLASS
      !IM_OBJECTID type SDOK_DOCID
    returning
      value(EX_DATA) type ref to DATA
    exceptions
      NOT_FOUND .
  methods GET_NOM_PROVEIDOR
    importing
      !IM_DOCCLASS type SDOK_CLASS
      !IM_OBJECTID type SDOK_DOCID
    returning
      value(EX_DATA) type ref to DATA .
  methods GET_OFERTES_2
    importing
      !IM_DOCCLASS type SDOK_CLASS
      !IM_OBJECTID type SDOK_DOCID
    exporting
      !EX_OFERTES type TY_T_OFERTA .
ENDCLASS.



CLASS ZRM_CL_LIC_BADI_DADES_EXPED_RT IMPLEMENTATION.


  METHOD add_vendor_to_group_key.
    FIELD-SYMBOLS <ls_group_key> LIKE LINE OF ch_group_key.
    DATA:          ls_group_key  LIKE LINE OF ch_group_key.

    CHECK NOT im_konzs IS INITIAL .

    READ TABLE ch_group_key ASSIGNING <ls_group_key> WITH TABLE KEY konzs = im_konzs .
    IF sy-subrc NE 0 .
      CLEAR ls_group_key .
      ls_group_key-konzs = im_konzs .
      INSERT im_lifnr INTO TABLE ls_group_key-t_lifnr .
      INSERT ls_group_key INTO TABLE ch_group_key .
    ELSE .
      INSERT im_lifnr INTO TABLE <ls_group_key>-t_lifnr .
    ENDIF .

  ENDMETHOD.


  METHOD complete_dades_persona.

    CONCATENATE ch_data-nom ch_data-cognom1 ch_data-cognom2
           INTO ch_data-nom_sencer
      SEPARATED BY space.

    CONCATENATE ch_data-nom ch_data-cognom1 'i' ch_data-cognom2
           INTO ch_data-nom_sencer_i
      SEPARATED BY space.

    IF NOT ch_data-codi_empleat IS INITIAL .
      IF im_gerent IS NOT INITIAL .
        DATA: l_orgeh TYPE orgeh .
        l_orgeh = ch_data-unitat_org .
      ENDIF .
      CALL METHOD get_dades_xxxx_carrec
        EXPORTING
          im_persno = ch_data-codi_empleat
          im_direc  = l_orgeh
        RECEIVING
          re_carrec = ch_data-carrec
        EXCEPTIONS
          OTHERS    = 1.


      SELECT SINGLE t522t~atext t522t~anrlt
               INTO (ch_data-trctmnt, ch_data-tractament)
               FROM pa0002 JOIN t522t ON t522t~anred EQ pa0002~anred
                                     AND t522t~sprsl EQ sy-langu
              WHERE     pernr EQ ch_data-codi_empleat
                    AND begda LE sy-datum
                    AND endda GE sy-datum.
    ENDIF .
  ENDMETHOD.


  METHOD complete_vendor_data.
    DATA: l_name1 TYPE lfa1-name1,
          l_name2 TYPE lfa1-name2,
          l_name3 TYPE lfa1-name3,
          l_name4 TYPE lfa1-name4.

    SELECT SINGLE name1 name2 name3 name4 konzs zute
             INTO (l_name1, l_name2, l_name3, l_name4, re_data-real_konzs, re_data-zute)
             FROM lfa1 WHERE lifnr EQ im_lifnr .

*-- Nom sencer del proveidor ------------------------------------
    CONCATENATE l_name1 l_name2 l_name3 l_name4
           INTO re_data-nom_proveidor
      SEPARATED BY space.
    CONDENSE re_data-nom_proveidor .

  ENDMETHOD.


  METHOD fill_esmena.
    DATA: l_vendor_name TYPE string .
    DATA: l_zrm_dm_docs TYPE zrm_dm_docs,
          lt_text       TYPE ism_tline_tab,
          lv_text       TYPE thead-tdname.

    CLEAR cs_esmena .
    cs_esmena-z_num_ofer    = im_valcrit-z_num_ofer .
    cs_esmena-proveidor     = im_valcrit-proveidor .
    cs_esmena-nom_proveidor = get_vendor_name( cs_esmena-proveidor ) .

    IF im_valcrit-z_llei92017 IS INITIAL.

      SELECT SINGLE * INTO l_zrm_dm_docs
               FROM zrm_dm_docs
              WHERE z_num_doc EQ im_valcrit-z_num_doc .

      CONCATENATE l_zrm_dm_docs-z_motiu_esmena l_zrm_dm_docs-z_motiu_esmena2
      l_zrm_dm_docs-z_motiu_esmena3  l_zrm_dm_docs-z_motiu_esmena4
       INTO cs_esmena-z_motiu_esmena  SEPARATED BY space.


    ELSE.

      IF im_valcrit-z_sec_s1 IS INITIAL.

        CONCATENATE  im_valcrit-objectid im_valcrit-z_num_ofer im_valcrit-z_tipus_sob  im_valcrit-z_num_doc
               INTO lv_text.

        IF i_exclusio EQ abap_true.
          CONCATENATE lv_text 'S1_EXCL' INTO lv_text.
        ENDIF.

        CLEAR lt_text.
        CALL FUNCTION 'READ_TEXT'
          EXPORTING
            client                  = sy-mandt
            id                      = 'ZDES'
            language                = sy-langu
            name                    = lv_text
            object                  = 'Z_RM_HEAD'
          TABLES
            lines                   = lt_text
          EXCEPTIONS
            id                      = 1
            language                = 2
            name                    = 3
            not_found               = 4
            object                  = 5
            reference_check         = 6
            wrong_access_to_archive = 7
            OTHERS                  = 8.
        CLEAR cs_esmena-z_motiu_esmena.
        LOOP AT lt_text ASSIGNING FIELD-SYMBOL(<fs_t>).
          CONCATENATE cs_esmena-z_motiu_esmena <fs_t>-tdline INTO cs_esmena-z_motiu_esmena SEPARATED BY space.
        ENDLOOP.


      ELSE.

        SELECT SINGLE *
          FROM zrm_dm_docs_esm
          INTO @DATA(ls_doc)
         WHERE z_num_doc EQ @im_valcrit-z_num_doc
           AND z_sec     EQ @im_valcrit-z_sec_s1.

        CHECK sy-subrc EQ 0.

        CONCATENATE ls_doc-z_motiu_esmena ls_doc-z_motiu_esmena2 ls_doc-z_motiu_esmena3 ls_doc-z_motiu_esmena4
     INTO cs_esmena-z_motiu_esmena  SEPARATED BY space.

      ENDIF.


    ENDIF.

    IF im_valcrit-proveidor NE im_valcrit-zprovcompute .
      l_vendor_name = get_vendor_name( im_valcrit-zprovcompute ) .
      CONCATENATE cs_esmena-z_motiu_esmena 'per part de' l_vendor_name
             INTO cs_esmena-z_motiu_esmena
             SEPARATED BY space .
    ENDIF .
  ENDMETHOD.


  METHOD get_admesos_final_s2.

    FIELD-SYMBOLS: <ls_data> TYPE i.

    DATA: lt_ofertes              TYPE ty_t_oferta,
          lv_num_licit_admesos_s2 TYPE i.

    CREATE DATA ex_data TYPE i .
    ASSIGN ex_data->* TO <ls_data> .


    CALL METHOD get_ofertes
      EXPORTING
        im_docclass = im_docclass
        im_objectid = im_objectid
      IMPORTING
        ex_ofertes  = lt_ofertes.

    CLEAR: lv_num_licit_admesos_s2.
    LOOP AT lt_ofertes TRANSPORTING NO FIELDS WHERE z_exclos_s1            = abap_false
                                                AND z_exclos_s2            = abap_false
                                                AND z_exclos_po_pt         = abap_false
                                                AND z_exclos_carrecs       = abap_false
*      >>>SPEC:65648, Inici modificació  - ECACM
                                                AND z_exclos_cont_s3_a_s2  = abap_false.
*      >>>SPEC:65648, Inici modificació  - ECACM
      ADD 1 TO lv_num_licit_admesos_s2.
    ENDLOOP.

    <ls_data> = lv_num_licit_admesos_s2.

  ENDMETHOD.


  METHOD get_admes_sobre1.
    DATA: ls_entitat TYPE ty_s_entitat,
          ls_lfa1    TYPE lfa1.
*          ls_kna1    TYPE kna1.

    DATA: lt_zrm_dt_ofertes TYPE TABLE OF zrm_dt_ofertes,
          ls_zrm_dt_ofertes LIKE LINE  OF lt_zrm_dt_ofertes.

    FIELD-SYMBOLS: <lt_entitat> TYPE ty_t_entitat,
                   <my_cached>  TYPE REF TO data.


    CASE im_num_sob.
      WHEN '1'.
        ASSIGN my_admes_sobre1 TO <my_cached>.
      WHEN OTHERS.
        RETURN.
    ENDCASE.

    IF <my_cached> IS BOUND.
      ex_data = <my_cached>.
      RETURN.
    ENDIF.

    CREATE DATA <my_cached> TYPE ty_t_entitat.
    ex_data = <my_cached>.
    ASSIGN ex_data->* TO <lt_entitat>.

    CLEAR lt_zrm_dt_ofertes.

    SELECT *
     FROM zrm_dt_ofertes
        INTO CORRESPONDING FIELDS OF TABLE lt_zrm_dt_ofertes
        WHERE docclass = im_docclass
        AND objectid = im_objectid
        AND z_tipus_oferta = gc_oferta_base
        AND z_exclos_s1 = ' '.

    CLEAR ls_zrm_dt_ofertes.

    LOOP AT lt_zrm_dt_ofertes INTO ls_zrm_dt_ofertes.
      ls_entitat-proveidor =   ls_zrm_dt_ofertes-proveidor.

*      CLEAR ls_kna1.
      CLEAR ls_lfa1.

      SELECT SINGLE *
       FROM lfa1
       INTO ls_lfa1
        WHERE lifnr = ls_zrm_dt_ofertes-proveidor.

      IF sy-subrc = 0.
        CLEAR ls_entitat-nom_proveidor.
        CLEAR ls_entitat-llista_nom_prov.
        CONCATENATE ls_lfa1-name1 ls_lfa1-name2 ls_lfa1-name3 ls_lfa1-name4 INTO ls_entitat-nom_proveidor SEPARATED BY space.
        CONCATENATE ls_lfa1-name1 ls_lfa1-name2 ls_lfa1-name3 ls_lfa1-name4 INTO ls_entitat-llista_nom_prov SEPARATED BY space.
        CONDENSE ls_entitat-nom_proveidor.
        CONDENSE ls_entitat-llista_nom_prov.
        APPEND ls_entitat TO <lt_entitat> .
        CLEAR ls_zrm_dt_ofertes.
      ELSE.
      ENDIF.
    ENDLOOP.

    SORT <lt_entitat> BY nom_proveidor .

  ENDMETHOD.


  METHOD get_areal_col.
    TYPES: BEGIN OF ty_s_data,
             capcalera TYPE string,
             cos       TYPE string,
             login     TYPE z_login_ac,
             mot       TYPE lfa1-stcd1,
           END   OF ty_s_data.
    FIELD-SYMBOLS: <ls_data> TYPE ty_s_data .
    DATA: l_alta_ac   TYPE zrm_dt_exp_cont-z_alta_ac,
          l_societat  TYPE zrm_dt_exp_cont-societat,
          lr_treb_lic TYPE REF TO zrm_cl_treballs_licitacio,
          lt_pep      TYPE zrm_cl_treballs_licitacio=>ty_peps_area_col_ext,
          ls_pep      LIKE LINE OF lt_pep.

    CREATE DATA re_data TYPE ty_s_data .
    ASSIGN re_data->* TO <ls_data> .

    SELECT SINGLE z_alta_ac societat
             INTO (l_alta_ac, l_societat )
             FROM zrm_dt_exp_cont
            WHERE     docclass EQ im_docclass
                  AND objectid EQ im_objectid .

    CASE l_alta_ac .
      WHEN zrm_cl_integracio_area_col=>co_alta_ac_error_user.    RAISE not_found .
      WHEN zrm_cl_integracio_area_col=>co_alta_ac_not_relevant.  RETURN .
      WHEN zrm_cl_integracio_area_col=>co_alta_ac_unknown.       RAISE not_found .
      WHEN zrm_cl_integracio_area_col=>co_alta_ac_error_ps .     RAISE not_found .
    ENDCASE .

    CREATE OBJECT lr_treb_lic
      EXPORTING
        objectid = im_objectid
        docclass = im_docclass.

    CALL METHOD lr_treb_lic->obtenir_dades_area_col
      IMPORTING
        ex_dades_area_col_ext = lt_pep.
    CHECK NOT lt_pep IS INITIAL .

    READ TABLE lt_pep INTO ls_pep INDEX 1 .

    SELECT SINGLE z_login_ac stcd1
             INTO (<ls_data>-login, <ls_data>-mot)
             FROM lfa1
            WHERE lifnr EQ ls_pep-lifnr .

    <ls_data>-capcalera = zrm_cl_documents=>get_docu_as_string( 'L190_TEXT_1' ) .
    CONCATENATE cl_abap_char_utilities=>form_feed <ls_data>-capcalera INTO <ls_data>-capcalera .
    CASE ls_pep-niv4_zz_estat_ac .
      WHEN zrm_cl_usuari_area_col=>co_status_new_user .
        IF l_societat = 'GISA'.
          <ls_data>-cos       = zrm_cl_documents=>get_docu_as_string( 'L190_TEXT_2B' ) .
        ELSEIF l_societat = 'REGS'.
          <ls_data>-cos       = zrm_cl_documents=>get_docu_as_string( 'L190_TEXT_3B' ) .
        ENDIF.
      WHEN zrm_cl_usuari_area_col=>co_status_user_exists .
        IF l_societat = 'GISA'.
          <ls_data>-cos       = zrm_cl_documents=>get_docu_as_string( 'L190_TEXT_2A' ) .
        ELSEIF l_societat = 'REGS'.
          <ls_data>-cos       = zrm_cl_documents=>get_docu_as_string( 'L190_TEXT_3A' ) .
        ENDIF.
    ENDCASE .


    REPLACE '&LOGIN_AC' IN <ls_data>-cos WITH <ls_data>-login  .
    REPLACE '&MOT_AC'   IN <ls_data>-cos WITH <ls_data>-mot  .

  ENDMETHOD.


  METHOD get_company_name.
    DATA: l_adrnr TYPE t001-adrnr .

    SELECT SINGLE adrnr INTO l_adrnr
             FROM t001 WHERE bukrs EQ im_company .

    SELECT SINGLE name1 INTO re_name                        "#EC *
             FROM adrc WHERE     addrnumber EQ l_adrnr
                             AND date_from LE sy-datum .

    IF im_company <> 'GISA'.
      TRANSLATE re_name TO UPPER CASE .
    ENDIF.

  ENDMETHOD.


  METHOD get_com_ex_sobre1.
    TYPES: ty_t_data     TYPE STANDARD TABLE OF zerm_quadre_com_ex_sobre1
                         WITH NON-UNIQUE DEFAULT KEY .
    DATA: lt_valcrit TYPE ty_t_valcrit,
          ls_data    TYPE zerm_quadre_com_ex_sobre1.

    FIELD-SYMBOLS: <ls_valcrit> TYPE ty_s_valcrit,
                   <lt_data>    TYPE ty_t_data.

    IF my_com_ex_sobre1 IS BOUND .
      ex_data = my_com_ex_sobre1 .
      RETURN .
    ENDIF .

    CREATE DATA my_com_ex_sobre1 TYPE ty_t_data .
    ex_data = my_com_ex_sobre1 .
    ASSIGN ex_data->* TO <lt_data> .

    CALL METHOD get_valcrit
      EXPORTING
        im_docclass = im_docclass
        im_objectid = im_objectid
      IMPORTING
        ex_valcrit  = lt_valcrit.

* Els Quadres de S1 no han de tenir en compte les ofertes variants perquè la
* revisió de S1 només es fa per a l'oferta base. A la ZRM_DT_VAL_CRIT hi trobarem
* registres, però son còpia exacta dels corresponents a l'oferta base.
    DELETE lt_valcrit WHERE     z_tipus_oferta EQ gc_oferta_variant
                            AND z_num_sob      EQ '1' .

    LOOP AT lt_valcrit ASSIGNING <ls_valcrit> WHERE z_num_sob EQ '1'
                                                AND (    z_exclos_s1s2  EQ 'X'
                                                      OR z_excl_pos_esm EQ 'X' ) .
      CALL METHOD fill_esmena
        EXPORTING
          im_valcrit = <ls_valcrit>
          i_exclusio = abap_true
        CHANGING
          cs_esmena  = ls_data.
      APPEND ls_data TO <lt_data> .
    ENDLOOP .
    SORT <lt_data> BY nom_proveidor z_motiu_esmena.

  ENDMETHOD.


  METHOD get_criteris_punt.

    FIELD-SYMBOLS: <lt_crit_p> TYPE ty_crit_punt,
                   <my_cached> TYPE REF TO data.

    ASSIGN my_exclusio_s2 TO <my_cached>.

    CREATE DATA <my_cached> TYPE ty_crit_punt.
    ASSIGN <my_cached>->* TO <lt_crit_p>.

    SELECT SINGLE z_mod_crit_punt
         FROM zrm_dm_plecs
         INTO @DATA(ls_codi)
         WHERE z_num_plec EQ @my_exp_cont-z_num_plec.
    CHECK ls_codi IS NOT INITIAL.
    SELECT *
      FROM zrm_dm_crit_punt
      INTO TABLE @DATA(lt_crit_punt)
      WHERE z_mod_crit_punt EQ @ls_codi.

    <lt_crit_p> = lt_crit_punt.

    ex_data = <my_cached>.

  ENDMETHOD.


  METHOD get_dades_director_divisio.
    DATA: l_sobid            TYPE hrp1001-sobid,
          l_societat         TYPE t001-bukrs,
          l_subtipus_cont    TYPE zrm_dt_exp_cont-z_subtipus_cont,
          lv_zzsec           TYPE zzsec,
          lv_pep             TYPE ps_posnr,
          lv_pep3            TYPE ps_posnr,
          lv_pep1            TYPE ps_posnr,
          ls_zrm_dt_exp_cont TYPE zrm_dt_exp_cont.
    FIELD-SYMBOLS: <ls_dades_direc_div> TYPE zerm_dades_direc_div .

* Per petició de Sílvia, si hi cap error en l'obtenció de les dades de càrrec
* hem de retornar els camps en blanc enlloc d'interrompre la generació del document
* Això, almenys, mentre durin els problems amb l'estructura organitzativa
    CREATE DATA re_data .
    ASSIGN re_data->* TO <ls_dades_direc_div> .

    CLEAR <ls_dades_direc_div> .
    CALL METHOD get_dades_xxxx_impuls
      EXPORTING
        im_docclass = im_docclass
        im_objectid = im_objectid
      IMPORTING
        ex_direccio = <ls_dades_direc_div>-unitat_org
        ex_societat = l_societat
      EXCEPTIONS
        OTHERS      = 1.
    IF sy-subrc NE 0 .
      RETURN .
    ENDIF .

    CASE l_societat .
      WHEN 'REGS' .
        <ls_dades_direc_div>-carrec     = 'Director General de REGSA'(dvr) .
        <ls_dades_direc_div>-nom        = 'Marc' .
        <ls_dades_direc_div>-cognom1    = 'Arqué' .
        <ls_dades_direc_div>-cognom2    = 'Gutiérrez' .
        <ls_dades_direc_div>-tractament = 'Senyor' .
        <ls_dades_direc_div>-trctmnt    = 'Sr.' .

      WHEN OTHERS .
        SELECT SINGLE * INTO ls_zrm_dt_exp_cont
          FROM zrm_dt_exp_cont
          WHERE     docclass EQ im_docclass
                AND objectid EQ im_objectid .

*     Busquem la secció
        SELECT SINGLE clau_pep
                FROM zrm_dt_treb_expc
                INTO lv_pep
                WHERE docclass = im_docclass AND
                      objectid = im_objectid.

*     Primer es determina a nivell 3
        CALL FUNCTION 'Z_GET_PEP_FOR_LEVEL'
          EXPORTING
            i_posnr     = lv_pep
            i_stufe     = '3'
          IMPORTING
            e_posnr     = lv_pep3
          EXCEPTIONS
            stufe_error = 1
            OTHERS      = 2.

        SELECT SINGLE zzsec
          FROM prps
          INTO lv_zzsec
          WHERE pspnr = lv_pep3.

        IF sy-subrc <> 0.
*       Si no ho troba es busca a nivell 1
          CALL FUNCTION 'Z_GET_PEP_FOR_LEVEL'
            EXPORTING
              i_posnr     = lv_pep
              i_stufe     = '1'
            IMPORTING
              e_posnr     = lv_pep1
            EXCEPTIONS
              stufe_error = 1
              OTHERS      = 2.

          SELECT SINGLE zzsec
            FROM prps
            INTO lv_zzsec
            WHERE pspnr = lv_pep1.
        ENDIF.

        IF l_societat = 'GISA' AND lv_zzsec = '002' AND
           ( ( ls_zrm_dt_exp_cont-z_subtipus_cont EQ 'PR' OR
               ls_zrm_dt_exp_cont-z_subtipus_cont EQ 'PI' ) AND
               ls_zrm_dt_exp_cont-z_proc_adj <> 'NF' AND
               ls_zrm_dt_exp_cont-z_proc_adj <> 'NS' AND
               ls_zrm_dt_exp_cont-z_proc_adj <> 'PS' ). "ADD P100031 PS

          <ls_dades_direc_div>-nom = 'Mònica'.
          <ls_dades_direc_div>-cognom1 = 'Vila'.
          <ls_dades_direc_div>-cognom2 = 'Cases'.
          <ls_dades_direc_div>-carrec = 'Directora de Projectes i Coordinació'.
          <ls_dades_direc_div>-trctmnt = 'Sra'.
          <ls_dades_direc_div>-tractament = 'Senyora'.

        ELSE.

          IF ls_zrm_dt_exp_cont-z_subtipus_cont EQ 'CS' .
            SELECT SINGLE sobid INTO l_sobid
                 FROM hrp1001
                 WHERE     otype EQ 'S'
*                     AND objid EQ '50000090'
                       AND objid EQ '50000080' "SPEC-38255 ETRFV, canviem la posició del director general per la del president
                       AND plvar EQ '01'
                       AND rsign EQ 'A'
                       AND begda LE sy-datum
                       AND endda GE sy-datum
                       AND sclas EQ 'P'.

            <ls_dades_direc_div>-codi_empleat = l_sobid .
            SELECT SINGLE vorna nachn nach2
              INTO (<ls_dades_direc_div>-nom, <ls_dades_direc_div>-cognom1, <ls_dades_direc_div>-cognom2)
              FROM pa0002
              WHERE     pernr EQ <ls_dades_direc_div>-codi_empleat
                    AND begda LE sy-datum
                    AND endda GE sy-datum .
          ELSE .
            CHECK NOT <ls_dades_direc_div>-unitat_org IS INITIAL .
            CALL FUNCTION 'ZHR_FM_GET_DIRDIV'
              EXPORTING
                pi_unitat_org   = <ls_dades_direc_div>-unitat_org
              IMPORTING
                pe_codi_empleat = <ls_dades_direc_div>-codi_empleat
                pe_nom          = <ls_dades_direc_div>-nom
                pe_cognom1      = <ls_dades_direc_div>-cognom1
                pe_cognom2      = <ls_dades_direc_div>-cognom2
              EXCEPTIONS
                ex_no_pos       = 1
                ex_no_emp       = 2
                ex_no_dad       = 3
                OTHERS          = 4.
            IF sy-subrc NE 0.
              RETURN .
            ENDIF.
          ENDIF .
        ENDIF.
    ENDCASE .

    complete_dades_persona( CHANGING ch_data = <ls_dades_direc_div> ) .

  ENDMETHOD.


  METHOD get_dades_director_general.
*  DATA: l_codi_direccio        TYPE zmm_dt_imp_cap-z_codi_direc,
*        ls_dades_direc_general TYPE zerm_dades_direc_general .
*
*  CALL METHOD get_dades_xxxx_impuls
*    EXPORTING
*      im_docclass = im_docclass
*      im_objectid = im_objectid
*    IMPORTING
*      ex_direccio = l_codi_direccio
*    EXCEPTIONS
*      OTHERS      = 1.
*  IF sy-subrc NE 0 .
*    RAISE not_found .
*  ENDIF .
*
**>>>>>>> Codi copiat de ZRM_CL_LIC_BADI_DADES_EXPED->GET_CARREC_DIRGEN
*  DATA: l_sobid      TYPE hrp1001-sobid,
*        l_sobid2     TYPE hrp1001-sobid,
*        l_sobid3     TYPE hrp1001-sobid,
*        ls_hrp       TYPE hrp1000,
*        l_flag       TYPE xfeld,
*        lt_1001      TYPE p1001tab,
*        ls_1001      TYPE p1001,
*        lt_objecttab TYPE hrobject_t,
*        ls_objecttab TYPE hrobject.
*
*  DO 2 TIMES.
*    IF sy-index EQ 2.
**Seleccionem la O superior.
*      SELECT SINGLE sobid INTO l_sobid
*               FROM hrp1001
*              WHERE     otype EQ 'O'
*                    AND objid EQ l_codi_direccio
*                    AND plvar EQ '01'
*                    AND rsign EQ 'A'
*                    AND begda LE sy-datum
*                    AND endda GE sy-datum
*                    AND sclas EQ 'O'.
*      l_codi_direccio = l_sobid .
*    ENDIF.
*
**Seleccionem les s de la o pare
*    SELECT sobid INTO l_sobid3
*      FROM hrp1001
*     WHERE     otype EQ 'O'
*           AND objid EQ l_codi_direccio
*           AND plvar EQ '01'
*           AND rsign EQ 'B'
*           AND begda LE sy-datum
*           AND endda GE sy-datum
*           AND sclas EQ 'S'.
**Seleccionem les c que poden ser director general.
*      SELECT sobid INTO lv_sobid2
*        FROM hrp1001
*        WHERE     otype EQ 'S'
*              AND objid EQ lv_sobid3
*              AND plvar EQ '01'
*              AND rsign EQ 'B'
*              AND begda LE sy-datum
*              AND endda GE sy-datum
*              AND sclas EQ 'C'.
*
*        SELECT SINGLE * INTO ls_hrp
*          FROM hrp1000
*          WHERE     plvar EQ '01'
*                AND otype EQ 'C'
*                AND objid EQ l_sobid2
*                AND begda LE sy-datum
*                AND endda GE sy-datum
*                AND (    short = 'DIRECTORGEN'
*                      OR short = 'DIRECTORTECI'
*                      OR short = 'DIRECTORGENR' ).
*
*        IF sy-subrc EQ 0.
*          l_flag = 'X'.
*          EXIT .
*        ENDIF.
*      ENDSELECT.
*
*      IF l_flag = 'X'.
*        EXIT.
*      ENDIF.
*    ENDSELECT.
*
*    IF l_flag = 'X'.
*      SELECT SINGLE sobid INTO l_sobid
*              FROM hrp1001
*             WHERE     otype EQ 'S'
*                   AND objid EQ l_sobid3
*                   AND plvar EQ '01'
*                   AND rsign EQ 'A'
*                   AND begda LE sy-datum
*                   AND endda GE sy-datum
*                   AND sclas EQ 'P'.
*
*      ls_objecttab-objid = l_sobid .
*      ls_objecttab-plvar = '01'.
*      ls_objecttab-otype = 'P'.
*      APPEND ls_objecttab TO lt_objecttab.
*      CALL FUNCTION 'HR_HCP_GET_POSITION_FOR_EMPL'
*        EXPORTING
*          im_objecttab    = lt_objecttab
*          im_begda        = sy-datum
*          im_endda        = sy-datum
*        IMPORTING
*          ex_1001_tab     = lt_1001
*        EXCEPTIONS
*          read_1001_error = 1
*          OTHERS          = 2.
*      IF sy-subrc <> 0.
** MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
**         WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
*      ENDIF.
*
*      READ TABLE lt_1001 INDEX 1 INTO ls_1001.
*
*      SELECT SINGLE stext INTO ls_dades_direc_general-carrec
*               FROM hrp1000
*              WHERE     plvar EQ ls_1001-plvar
*                    AND begda LE sy-datum
*                    AND endda GE sy-datum
*                    AND otype EQ ls_1001-sclas
*                    AND objid EQ ls_1001-sobid.
*    ENDIF.
*
*
*    IF carrec IS NOT INITIAL.
*      EXIT.
*    ENDIF.
*
*  ENDDO.
*
  ENDMETHOD.


  METHOD get_dades_gerent.
    FIELD-SYMBOLS: <ls_dades_gerent> TYPE zerm_dades_gerent .

* Per petició de Sílvia, si hi cap error en l'obtenció de les dades de càrrec
* hem de retornar els camps en blanc enlloc d'interrompre la generació del document
* Això, almenys, mentre durin els problems amb l'estructura organitzativa
    CREATE DATA re_data .
    ASSIGN re_data->* TO <ls_dades_gerent> .

    CLEAR <ls_dades_gerent> .
    CALL METHOD get_dades_xxxx_impuls
      EXPORTING
        im_docclass    = im_docclass
        im_objectid    = im_objectid
      IMPORTING
        ex_departament = <ls_dades_gerent>-unitat_org
      EXCEPTIONS
        OTHERS         = 1.
    IF sy-subrc NE 0 .
      RETURN .
    ENDIF .

    CALL FUNCTION 'ZHR_FM_GET_GERENT'
      EXPORTING
        pi_unitat_org   = <ls_dades_gerent>-unitat_org
      IMPORTING
        pe_codi_empleat = <ls_dades_gerent>-codi_empleat
        pe_nom          = <ls_dades_gerent>-nom
        pe_cognom1      = <ls_dades_gerent>-cognom1
        pe_cognom2      = <ls_dades_gerent>-cognom2
      EXCEPTIONS
        ex_no_pos       = 1
        ex_no_emp       = 2
        ex_no_dad       = 3
        OTHERS          = 4.
    IF sy-subrc NE 0.
      RETURN .
    ENDIF.

    complete_dades_persona( EXPORTING im_gerent = 'X' CHANGING ch_data = <ls_dades_gerent> ) .

  ENDMETHOD.


  METHOD get_dades_sistema_dinamic.

    DATA is_ofer  TYPE zrm_dt_ofertes.

    FIELD-SYMBOLS: <ls_dades_gen_sde> TYPE zerm_dades_gen_sde.

    CREATE DATA re_data .
    ASSIGN re_data->* TO <ls_dades_gen_sde> .

    CLEAR <ls_dades_gen_sde>.
    SELECT SINGLE docclass       AS docclass_exp_cont
                  objectid       AS objectid_exp_cont
                  z_codi_exp     AS codi_exp_cont
                  sol_ped
                  z_adjudicatari AS adjudicatari
                  z_import_adj_b AS import_adj_tot
                  z_pres_licit_b
      FROM zrm_dt_exp_cont INTO CORRESPONDING FIELDS OF <ls_dades_gen_sde>
      WHERE docclass EQ im_docclass AND objectid EQ im_objectid.

    IF sy-subrc NE 0.
      RAISE not_found.
    ENDIF.

    SELECT COUNT( * ) INTO <ls_dades_gen_sde>-empresas_impuls
      FROM zmm_dt_prov_sol WHERE z_codi_exp EQ <ls_dades_gen_sde>-sol_ped.

    SELECT SINGLE * INTO is_ofer FROM zrm_dt_ofertes
      WHERE docclass  EQ im_docclass AND objectid EQ im_objectid AND
            proveidor EQ <ls_dades_gen_sde>-adjudicatari.

    SELECT SINGLE import INTO <ls_dades_gen_sde>-import_adj_va1 FROM zrm_dt_ofer_tip
      WHERE docclass  EQ im_docclass        AND objectid   EQ im_objectid AND
            num_ofer  EQ is_ofer-z_num_ofer AND tipus_ofer EQ 1.

    SELECT SINGLE SUM( import ) INTO <ls_dades_gen_sde>-import_adj_fix FROM zrm_dt_ofer_tip
      WHERE docclass  EQ im_docclass        AND objectid   EQ im_objectid AND
            num_ofer  EQ is_ofer-z_num_ofer AND tipus_ofer NE 1.

    <ls_dades_gen_sde>-import_pbl_6_0 = <ls_dades_gen_sde>-z_pres_licit_b * 6 / 100.
    <ls_dades_gen_sde>-import_pbl_2_5 = <ls_dades_gen_sde>-z_pres_licit_b * 25 / 1000.
    <ls_dades_gen_sde>-moneda         = 'EUR'.

  ENDMETHOD.


  METHOD get_dades_xxxx_carrec.
    DATA: l_plans  TYPE plans,
          lt_plans TYPE TABLE OF plans.

    SELECT        objid INTO TABLE lt_plans
             FROM hrp1001
            WHERE     begda LE sy-datum
                  AND endda GE sy-datum
                  AND plvar EQ '01'
                  AND otype EQ 'S'
                  AND sclas EQ 'P'
                  AND sobid = im_persno .
    IF sy-subrc NE 0 .
      RAISE not_found .
    ENDIF .

    IF im_direc IS SUPPLIED AND im_direc IS NOT INITIAL .
* Podria ser que la persona tingues més d'un càrrec. En aquest cas ens interessa només
* el càrrec associat a la direcció impulsora de l'impuls
      DESCRIBE TABLE lt_plans .
      IF sy-tfill GT 1 .
        SELECT        objid INTO l_plans
                 FROM hrp1001
                  FOR ALL ENTRIES IN lt_plans
                WHERE     begda LE sy-datum
                      AND endda GE sy-datum
                      AND plvar EQ '01'
                      AND otype EQ 'S'
                      AND sclas EQ 'O'
                      AND objid EQ lt_plans-table_line
                      AND sobid EQ im_direc .
          EXIT .
        ENDSELECT .
      ENDIF .
      IF l_plans IS INITIAL .
        READ TABLE lt_plans INTO l_plans INDEX 1 .
      ENDIF .
    ELSE .
      READ TABLE lt_plans INTO l_plans INDEX 1 .
    ENDIF .

    SELECT SINGLE stext INTO re_carrec
             FROM hrp1000
            WHERE     plvar EQ '01'
                  AND otype EQ 'S'
                  AND objid EQ l_plans
                  AND begda LE sy-datum
                  AND endda GE sy-datum
                  AND langu EQ 'c' .
    IF sy-subrc NE 0 .
      RAISE not_found .
    ENDIF .

  ENDMETHOD.


  METHOD get_dades_xxxx_impuls.
    DATA: l_sol_ped  TYPE zrm_dt_exp_cont-sol_ped.

    SELECT SINGLE sol_ped INTO l_sol_ped
             FROM zrm_dt_exp_cont
             WHERE     docclass EQ im_docclass
                  AND objectid  EQ im_objectid .
    IF sy-subrc NE 0 .
      RAISE not_found .
    ENDIF .

    SELECT SINGLE z_codi_depar z_codi_direc societat
             INTO (ex_departament, ex_direccio, ex_societat)
             FROM zmm_dt_imp_cap
            WHERE sol_ped EQ l_sol_ped.
    IF sy-subrc NE 0 .
      SELECT SINGLE z_codi_depar z_codi_direc societat
                INTO (ex_departament, ex_direccio, ex_societat)
                FROM  zmm_dt_imp_cap
               WHERE z_codi_exp EQ l_sol_ped.
    ENDIF.

    IF sy-subrc NE 0 .
      RAISE not_found .
    ENDIF .

  ENDMETHOD.


  METHOD get_data_term48h.

    DATA: lv_termini_negoc  TYPE zrm_dt_exp_cont-z_termini_negoc.
    DATA: lv_data_invit_negoc TYPE zrm_dt_exp_cont-z_data_invit_negoc.
    DATA: lv_is_negociat      TYPE zrm_dt_exp_cont-z_negociacio. " SPEC-47908
    DATA: time_stamp     TYPE timestamp,
          time_stamp2    TYPE ad_tstamp,
          time_stamp_out TYPE timestamp,
          lv_date_out    TYPE sydatum.

    CLEAR lv_termini_negoc.
    CLEAR lv_data_invit_negoc .

    SELECT SINGLE z_termini_negoc z_data_invit_negoc
                  z_negociacio " SPEC-47908
      FROM zrm_dt_exp_cont
         INTO ( lv_termini_negoc,  lv_data_invit_negoc , lv_is_negociat  )
            WHERE docclass = im_docclass
              AND objectid = im_objectid.

    CHECK lv_is_negociat = abap_on. " SPEC-47908

    CALL FUNCTION 'ADDR_CONVERT_DATE_TO_TIMESTAMP'
      EXPORTING
        iv_date      = lv_data_invit_negoc
      IMPORTING
        ev_timestamp = time_stamp2.

    time_stamp = time_stamp2.

    CALL FUNCTION 'TIMESTAMP_DURATION_ADD'
      EXPORTING
        timestamp_in    = time_stamp
*       TIMEZONE        = 'UTC'
        duration        = lv_termini_negoc
        unit            = 'H'
      IMPORTING
        timestamp_out   = time_stamp_out
      EXCEPTIONS
        timestamp_error = 1
        OTHERS          = 2.

    time_stamp2 = time_stamp_out.

    IF time_stamp2+8(6) <> '000000'.
      time_stamp2(8)   = time_stamp2(8) + 1.
      time_stamp2+8(6) = '000000'.
    ELSE.
    ENDIF.
** >> INI MODIF ETODR SPEC-47908
    DATA: lv_timestamp_p TYPE timestamp,
          lv_timezone    TYPE timezone,
          lv_date_aux    TYPE sydatum.

    CLEAR: lv_timestamp_p, lv_timezone,  lv_date_aux.

    lv_timestamp_p = time_stamp2.

    CONVERT TIME STAMP lv_timestamp_p
            TIME ZONE lv_timezone
            INTO DATE lv_date_aux.
    CHECK sy-subrc = 0.
** << FI MODIF ETODR SPEC-47908
    CALL FUNCTION 'ADDR_CONVERT_TIMESTAMP_TO_DATE'
      EXPORTING
        iv_timestamp = time_stamp2
*       IV_HIGH      = ' '
      IMPORTING
        ev_date      = lv_date_out.

    ex_data = lv_date_out.

  ENDMETHOD.


  METHOD get_dt_ofertes.

    TYPES: ty_t_quadre TYPE STANDARD TABLE OF zerm_dt_ofertes
                        WITH NON-UNIQUE DEFAULT KEY .

    DATA: lt_ofertes TYPE ty_t_oferta,
          ls_ofertes TYPE ty_s_oferta,
          ls_quadre  TYPE LINE OF ty_t_quadre.

    FIELD-SYMBOLS: <lt_quadre> TYPE ty_t_quadre,
                   <ls_oferta> TYPE ty_s_oferta.

    DATA: ls_quadre_cache      TYPE ty_s_quadre3_cache.

    ls_quadre_cache-sort_by      = 'sort_by'.
    ls_quadre_cache-tipus_oferta = 'A'.
    READ TABLE my_quadre3_cache INTO ls_quadre_cache FROM ls_quadre_cache .

    IF sy-subrc EQ 0
     AND ls_quadre_cache-quadre IS BOUND .
      ex_quadre  = ls_quadre_cache-quadre .
      ex_vincles = ls_quadre_cache-vincles .
      RETURN.
    ENDIF .

    CREATE DATA ls_quadre_cache-quadre  TYPE ty_t_quadre.
    INSERT ls_quadre_cache INTO TABLE my_quadre3_cache .

    ex_quadre = ls_quadre_cache-quadre .
    ASSIGN ex_quadre->* TO <lt_quadre> .


*  CALL METHOD get_ofertes
    CALL METHOD get_ofertes_2
      EXPORTING
        im_docclass = im_docclass
        im_objectid = im_objectid
      IMPORTING
        ex_ofertes  = lt_ofertes.

    SELECT * FROM kna1 INTO TABLE @DATA(lt_kna1)
      FOR ALL ENTRIES IN @lt_ofertes
      WHERE kunnr = @lt_ofertes-proveidor.


    LOOP AT lt_ofertes ASSIGNING <ls_oferta>.
      CLEAR: ls_quadre.

      ls_quadre-docclass = <ls_oferta>-docclass.
      ls_quadre-objectid = <ls_oferta>-objectid.
      ls_quadre-z_num_ofer = <ls_oferta>-z_num_ofer.
      ls_quadre-proveidor = <ls_oferta>-proveidor.
      ls_quadre-z_renun_ofert = <ls_oferta>-z_renun_ofert.
      ls_quadre-z_punt_total = <ls_oferta>-z_punt_total.

      IF <ls_oferta>-z_renun_ofert = 'X' OR <ls_oferta>-z_exclos_s3_postob = 'X' OR <ls_oferta>-z_exclos_s3 = 'X'.
        ls_quadre-z_exclos_s3_postob = 'No'.
        ls_quadre-z_renun_ofert = 'No'.
      ELSE.
        ls_quadre-z_exclos_s3_postob = 'Si'.
        ls_quadre-z_renun_ofert = 'Si'.
      ENDIF.

      IF lt_kna1 IS NOT INITIAL.
        READ TABLE lt_kna1 WITH KEY kunnr = <ls_oferta>-proveidor INTO DATA(ls_kna1).
        IF sy-subrc = 0.
          ls_quadre-name1 = ls_kna1-name1.
          ls_quadre-name2 = ls_kna1-name2.
          CONCATENATE ls_quadre-name1 ls_quadre-name2 INTO ls_quadre-nom SEPARATED BY space.
        ENDIF.
      ENDIF.

      APPEND ls_quadre TO <lt_quadre> .
    ENDLOOP.

    SORT <lt_quadre> BY z_renun_ofert DESCENDING z_punt_total DESCENDING.

    DATA odre_int TYPE i.
    odre_int = 1.

    LOOP AT <lt_quadre> ASSIGNING FIELD-SYMBOL(<ls_quadre_2>).
      <ls_quadre_2>-z_num_ofer = odre_int.
      odre_int = odre_int + 1.
    ENDLOOP.

  ENDMETHOD.


  METHOD get_empreses_tem.

    DATA:

      l_textid   TYPE string,
      l_societat TYPE zrm_dt_exp_cont-societat,
      lt_ofertes TYPE ty_t_oferta,
      ls_ofertes TYPE ty_s_oferta,
      ls_data    TYPE zty_empreses_tem.

    CALL METHOD get_ofertes
      EXPORTING
        im_docclass = im_docclass
        im_objectid = im_objectid
      IMPORTING
        ex_ofertes  = lt_ofertes.

    DELETE lt_ofertes WHERE z_temerari NE 'X'.
    CHECK NOT lt_ofertes IS INITIAL .

    LOOP AT lt_ofertes INTO ls_ofertes.
      ls_data-guion     = '-'.
      ls_data-nom_prove = ls_ofertes-nom_proveidor.
      APPEND ls_data TO ex_data.
    ENDLOOP.

  ENDMETHOD.


  METHOD get_ent_es_sobre3.
    TYPES: ty_s_data TYPE zerm_quadre_ent_es_sobre3,
           ty_t_data TYPE STANDARD TABLE OF ty_s_data
                      WITH NON-UNIQUE DEFAULT KEY .

    DATA: lt_ofertes TYPE ty_t_oferta,
          ls_data    TYPE ty_s_data.

    FIELD-SYMBOLS: <lt_data>   TYPE ty_t_data,
                   <ls_oferta> TYPE ty_s_oferta.

    IF my_ent_es_sobre3 IS BOUND .
      ex_data = my_ent_es_sobre3 .
      RETURN .
    ENDIF .

    CREATE DATA my_ent_es_sobre3 TYPE ty_t_data .
    ex_data = my_ent_es_sobre3 .
    ASSIGN ex_data->* TO <lt_data> .

    CALL METHOD get_ofertes
      EXPORTING
        im_docclass = im_docclass
        im_objectid = im_objectid
      IMPORTING
        ex_ofertes  = lt_ofertes.


    SORT lt_ofertes BY proveidor.
    LOOP AT lt_ofertes ASSIGNING <ls_oferta> WHERE z_codi_esm_s3 IS NOT INITIAL.
      AT END OF proveidor .
        CLEAR ls_data .
        ls_data-proveidor          = <ls_oferta>-proveidor .
        ls_data-nom_proveidor      = get_vendor_name( <ls_oferta>-proveidor ) .
        ls_data-z_tipus_oferta     = <ls_oferta>-z_tipus_oferta .

        SELECT SINGLE z_descripcio INTO ls_data-z_motiu_esmena
                 FROM zrm_dm_esm_s3t
                WHERE      z_codi_esm_s3  EQ <ls_oferta>-z_codi_esm_s3
                       AND spras          EQ 'c' .
        SHIFT ls_data-z_motiu_esmena LEFT DELETING LEADING space .
        IF NOT ls_data-z_motiu_esmena IS INITIAL .
          TRANSLATE ls_data-z_motiu_esmena TO LOWER CASE . "#EC TRANSLANG
        ENDIF .

*        CONCATENATE ls_data-nom_proveidor ', atès que ' ls_data-z_motiu_esmena '.'
*          INTO ls_data-z_motiu_esmena RESPECTING BLANKS.

        CONDENSE ls_data-z_motiu_esmena.
        APPEND ls_data TO <lt_data> .
      ENDAT .
    ENDLOOP .
  ENDMETHOD.


  METHOD get_ent_ex_homog.
    TYPES: ty_s_data TYPE zerm_quadre_ent_ex_homog,
           ty_t_data TYPE STANDARD TABLE OF ty_s_data
                      WITH NON-UNIQUE DEFAULT KEY .

    DATA: l_name1 TYPE name1_gp,
          l_name2 TYPE name2_gp,
          l_name3 TYPE name3_gp,
          l_name4 TYPE name4_gp.

    FIELD-SYMBOLS: <lt_data> TYPE ty_t_data,
                   <ls_data> TYPE ty_s_data.

    IF my_ent_ex_homog IS BOUND .
      ex_data = my_ent_ex_homog .
      RETURN .
    ENDIF .

    CREATE DATA my_ent_ex_homog TYPE ty_t_data .
    ex_data = my_ent_ex_homog .
    ASSIGN ex_data->* TO <lt_data> .

    SELECT * FROM zrm_dt_ofertes INTO CORRESPONDING FIELDS OF TABLE <lt_data>
      WHERE docclass = im_docclass AND
            objectid = im_objectid AND
            z_excl_homog = 'X' .

    IF sy-subrc = 0.
      LOOP AT <lt_data> ASSIGNING <ls_data>.

        SELECT SINGLE name1 name2 name3 name4 FROM lfa1 INTO (l_name1, l_name2, l_name3, l_name4)
          WHERE lifnr = <ls_data>-proveidor .

        IF sy-subrc = 0.
          CONCATENATE l_name1 l_name2 l_name3 l_name4 INTO <ls_data>-nom_proveidor RESPECTING BLANKS.
          CONDENSE <ls_data>-nom_proveidor.
        ENDIF.

        TRY.
            <ls_data>-text = zrm_cl_documents=>get_docu_as_string( 'ICT_EXCLOS_HOMOG' ) .
          CATCH  zcx_rm_documents .
            RAISE not_found .
        ENDTRY .

        REPLACE ALL OCCURRENCES OF '&NOM_PROVEIDOR&' IN <ls_data>-text
                WITH <ls_data>-nom_proveidor .

        TRANSLATE <ls_data>-z_com_excl_homog TO LOWER CASE.
        REPLACE ALL OCCURRENCES OF '&MOT_EXCL_HOMOG&' IN <ls_data>-text
                WITH <ls_data>-z_com_excl_homog .

        CONDENSE <ls_data>-text.

      ENDLOOP.
    ENDIF.

  ENDMETHOD.


  METHOD get_ent_ex_s3.

    CONSTANTS: lc_oferta_base    TYPE z_tipus_oferta VALUE 'B',
               lc_oferta_variant TYPE z_tipus_oferta VALUE 'V'.

    TYPES:
      BEGIN OF ty_s_oferta.
        INCLUDE TYPE zrm_dt_ofertes    AS offer_data.
        TYPES:  z_num_variant TYPE z_num_variant,
      END   OF ty_s_oferta .

    TYPES: ty_s_data TYPE zerm_quadre_ent_ex_sobre3,
           ty_t_data TYPE STANDARD TABLE OF ty_s_data
                      WITH NON-UNIQUE DEFAULT KEY .
    DATA: lt_valcrit   TYPE ty_t_valcrit,
          ls_data      TYPE ty_s_data,
          lt_ent_ex_s3 TYPE REF TO data.


    DATA: lc_wa_data    TYPE zerm_ent_exc_punt_tec,
          lc_it_lfa1    TYPE STANDARD TABLE OF lfa1,
          lc_wa_lfa1    TYPE lfa1,
          lc_it_ofertes TYPE STANDARD TABLE OF ty_s_oferta,
          lc_wa_ofertes TYPE ty_s_oferta,
          l_num_variant TYPE z_num_ofer,
          lv_tabix      TYPE sy-tabix,
          lv_proc_adj   TYPE zrm_dt_exp_cont-z_proc_adj.


    FIELD-SYMBOLS: <lt_data>      TYPE ty_t_data.

    CREATE DATA lt_ent_ex_s3 TYPE ty_t_data .
    ex_data = lt_ent_ex_s3 .
    ASSIGN ex_data->* TO <lt_data> .

* Es selecciona el tipus de procediment d'adjudicació
    SELECT SINGLE z_proc_adj
      INTO lv_proc_adj
      FROM zrm_dt_exp_cont
      WHERE docclass       EQ im_docclass AND
            objectid       EQ im_objectid.

* Es seleccionen les ofertes
    SELECT * INTO TABLE lc_it_ofertes
      FROM zrm_dt_ofertes
      WHERE docclass       EQ im_docclass AND
            objectid       EQ im_objectid.

    DELETE lc_it_ofertes WHERE z_exclos_s3 EQ space .

    SORT lc_it_ofertes BY proveidor z_tipus_oferta z_num_ofer .
    LOOP AT lc_it_ofertes INTO  lc_wa_ofertes.
      lv_tabix = sy-tabix.

*-- Asignem el número d'oferta variant --------------------------
      IF lc_wa_ofertes-z_tipus_oferta EQ lc_oferta_base.
        CLEAR lc_wa_ofertes-z_num_variant .
        l_num_variant = 1 .
      ELSEIF lc_wa_ofertes-z_tipus_oferta EQ lc_oferta_variant.
        lc_wa_ofertes-z_num_variant = l_num_variant .
        ADD 1 TO l_num_variant .
      ENDIF .
      MODIFY lc_it_ofertes FROM lc_wa_ofertes INDEX lv_tabix.
    ENDLOOP .

* En cas que sigui un restringit, només es seleccionaran les ofertes que presenten proposta
    IF lv_proc_adj = 'CR'.
      DELETE lc_it_ofertes WHERE z_pres_proposta EQ space.
    ENDIF.

    CHECK lc_it_ofertes[] IS NOT INITIAL.

    LOOP AT lc_it_ofertes INTO lc_wa_ofertes.
      CLEAR ls_data .
      ls_data-proveidor          = lc_wa_ofertes-proveidor .
      ls_data-nom_proveidor      = get_vendor_name( ls_data-proveidor ) .

      IF lc_wa_ofertes-z_tipus_oferta = lc_oferta_variant.
        SHIFT lc_wa_ofertes-z_num_variant LEFT DELETING LEADING '0' .
        CONDENSE lc_wa_ofertes-z_num_variant.
        CONCATENATE ls_data-nom_proveidor ' (variant número '
                    lc_wa_ofertes-z_num_variant
                    INTO ls_data-nom_proveidor RESPECTING BLANKS.
        CONDENSE ls_data-nom_proveidor.
        CONCATENATE ls_data-nom_proveidor ')' INTO ls_data-nom_proveidor.
      ENDIF.

      ls_data-z_tipus_oferta     = lc_wa_ofertes-z_tipus_oferta .

      SELECT SINGLE z_descripcio INTO ls_data-z_emp_motiu_esmena
               FROM zrm_dm_exlc_s3t
              WHERE      z_codi_excl_s3 EQ lc_wa_ofertes-z_codi_excl_s3
                     AND spras          EQ 'c' .
      SHIFT ls_data-z_emp_motiu_esmena LEFT DELETING LEADING space .
      IF NOT ls_data-z_emp_motiu_esmena IS INITIAL .
        TRANSLATE ls_data-z_emp_motiu_esmena TO LOWER CASE . "#EC TRANSLANG
      ENDIF .

      CONCATENATE ls_data-nom_proveidor ', atès que ' ls_data-z_emp_motiu_esmena '.'
        INTO ls_data-z_emp_motiu_esmena RESPECTING BLANKS.

      CONDENSE ls_data-z_emp_motiu_esmena.
      APPEND ls_data TO <lt_data> .

    ENDLOOP.
    SORT <lt_data> BY nom_proveidor.

  ENDMETHOD.


  METHOD get_ent_ex_sobre12.
    TYPES: ty_s_data TYPE zerm_quadre_ent_ex_s12,
           ty_t_data TYPE STANDARD TABLE OF ty_s_data WITH NON-UNIQUE DEFAULT KEY.

    DATA: lt_valcrit TYPE ty_t_valcrit,
          ls_entitat TYPE ty_s_data,
          lt_ofertes TYPE ty_t_oferta.

    FIELD-SYMBOLS: <ls_valcrit> TYPE ty_s_valcrit,
                   <lt_entitat> TYPE ty_t_data,
                   <ls_oferta>  TYPE ty_s_oferta.

    IF my_ent_ex_sobre12 IS BOUND .
      ex_data = my_ent_ex_sobre12 .
      RETURN .
    ENDIF .

    CREATE DATA my_ent_ex_sobre12 TYPE ty_t_data .
    ex_data = my_ent_ex_sobre12 .
    ASSIGN ex_data->* TO <lt_entitat> .

    CALL METHOD get_valcrit
      EXPORTING
        im_docclass = im_docclass
        im_objectid = im_objectid
      IMPORTING
        ex_valcrit  = lt_valcrit.

    CALL METHOD get_ofertes
      EXPORTING
        im_docclass = im_docclass
        im_objectid = im_objectid
      IMPORTING
        ex_ofertes  = lt_ofertes.

    LOOP AT lt_valcrit ASSIGNING <ls_valcrit> WHERE z_tipus_oferta EQ gc_oferta_variant.
*                        AND (        z_num_sob CA '12'
*                             AND (    z_exclos_s1s2  IS NOT INITIAL "EQ 'X'
*                                   OR z_exclos_s2    IS NOT INITIAL "EQ 'X'
*                                   OR z_excl_pos_esm IS NOT INITIAL ) )  . "EQ 'X'
      READ TABLE lt_ofertes ASSIGNING <ls_oferta>
                        WITH KEY z_num_ofer = <ls_valcrit>-z_num_ofer .
      CHECK sy-subrc IS INITIAL.
      IF (        <ls_valcrit>-z_num_sob CA '12'
             AND (    <ls_valcrit>-z_exclos_s1s2  IS NOT INITIAL
                   OR <ls_valcrit>-z_exclos_s2    IS NOT INITIAL
                   OR <ls_valcrit>-z_excl_pos_esm IS NOT INITIAL ) )
          OR <ls_oferta>-z_excl_punt_tec IS NOT INITIAL.


        READ TABLE <lt_entitat> TRANSPORTING NO FIELDS
              WITH KEY proveidor   = <ls_valcrit>-proveidor
                       num_variant = <ls_oferta>-z_num_variant.
        CHECK sy-subrc NE 0 .
        ls_entitat-proveidor     = <ls_valcrit>-proveidor .
        ls_entitat-num_variant   = <ls_oferta>-z_num_variant .
        ls_entitat-nom_proveidor = <ls_oferta>-z_num_variant .
        SHIFT ls_entitat-nom_proveidor LEFT DELETING LEADING '0' .
        CONCATENATE <ls_oferta>-nom_proveidor ` (variant número ` ls_entitat-nom_proveidor `)`
               INTO ls_entitat-nom_proveidor .


        APPEND ls_entitat TO <lt_entitat> .
      ENDIF.
    ENDLOOP .
    SORT <lt_entitat> BY nom_proveidor .
  ENDMETHOD.


  METHOD get_ent_ex_sobre123.
    TYPES: ty_s_data TYPE zerm_quadre_ent_ex_s123,
           ty_t_data TYPE STANDARD TABLE OF ty_s_data WITH NON-UNIQUE DEFAULT KEY.

    DATA: lt_valcrit TYPE ty_t_valcrit,
          ls_entitat TYPE ty_s_data,
          lt_ofertes TYPE ty_t_oferta.

    FIELD-SYMBOLS: <ls_valcrit> TYPE ty_s_valcrit,
                   <lt_entitat> TYPE ty_t_data,
                   <ls_oferta>  TYPE ty_s_oferta.

    IF my_ent_ex_sobre123 IS BOUND .
      ex_data = my_ent_ex_sobre123  .
      RETURN .
    ENDIF .

    CREATE DATA my_ent_ex_sobre123 TYPE ty_t_data .
    ex_data = my_ent_ex_sobre123 .
    ASSIGN ex_data->* TO <lt_entitat> .

    CALL METHOD get_valcrit
      EXPORTING
        im_docclass = im_docclass
        im_objectid = im_objectid
      IMPORTING
        ex_valcrit  = lt_valcrit.

    CALL METHOD get_ofertes
      EXPORTING
        im_docclass = im_docclass
        im_objectid = im_objectid
      IMPORTING
        ex_ofertes  = lt_ofertes.

    LOOP AT lt_valcrit ASSIGNING <ls_valcrit> WHERE z_tipus_oferta EQ gc_oferta_variant
                     AND ( z_exclos_s3    NE space
                          OR z_exclos_s2  NE space
                          OR (        z_num_sob CA '12'
                               AND (    z_exclos_s1s2  EQ 'X'
                                     OR z_excl_pos_esm EQ 'X' ) ) ) .
* << INI MODIF EDLSM 17/11/09
      READ TABLE lt_ofertes ASSIGNING <ls_oferta>
                            WITH KEY z_num_ofer = <ls_valcrit>-z_num_ofer .
      CHECK sy-subrc EQ 0 .
      READ TABLE <lt_entitat> TRANSPORTING NO FIELDS
            WITH KEY proveidor   = <ls_valcrit>-proveidor
                     num_variant = <ls_oferta>-z_num_variant .
* >> END MODIF EDLSM
      CHECK sy-subrc NE 0 .

      ls_entitat-proveidor     = <ls_valcrit>-proveidor .
      ls_entitat-num_variant   = <ls_oferta>-z_num_variant .
      ls_entitat-nom_proveidor = <ls_oferta>-z_num_variant .
      SHIFT ls_entitat-nom_proveidor LEFT DELETING LEADING '0' .
      CONCATENATE <ls_oferta>-nom_proveidor ` (variant número ` ls_entitat-nom_proveidor `)`
             INTO ls_entitat-nom_proveidor .


      APPEND ls_entitat TO <lt_entitat> .
    ENDLOOP .
    SORT <lt_entitat> BY nom_proveidor .

  ENDMETHOD.


  METHOD get_ent_ex_sobre3.
    TYPES: ty_s_data TYPE zerm_quadre_ent_ex_sobre3,
           ty_t_data TYPE STANDARD TABLE OF ty_s_data
                      WITH NON-UNIQUE DEFAULT KEY .
    DATA: lt_valcrit TYPE ty_t_valcrit,
          ls_data    TYPE ty_s_data.

    FIELD-SYMBOLS: <ls_valcrit> TYPE ty_s_valcrit,
                   <lt_data>    TYPE ty_t_data,
                   <ls_oferta>  TYPE ty_s_oferta.

    IF my_ent_ex_sobre3 IS BOUND .
      ex_data = my_ent_ex_sobre3 .
      RETURN .
    ENDIF .

    CREATE DATA my_ent_ex_sobre3 TYPE ty_t_data .
    ex_data = my_ent_ex_sobre3 .
    ASSIGN ex_data->* TO <lt_data> .

    CALL METHOD get_valcrit
      EXPORTING
        im_docclass = im_docclass
        im_objectid = im_objectid
      IMPORTING
        ex_valcrit  = lt_valcrit.


    SORT lt_valcrit BY proveidor .
    DELETE lt_valcrit WHERE z_exclos_s3 EQ space .
    LOOP AT lt_valcrit ASSIGNING <ls_valcrit> .
      AT END OF proveidor .
        CLEAR ls_data .
        ls_data-proveidor          = <ls_valcrit>-proveidor .
        ls_data-nom_proveidor      = get_vendor_name( ls_data-proveidor ) .
        ls_data-z_tipus_oferta     = <ls_valcrit>-z_tipus_oferta .

        SELECT SINGLE z_descripcio INTO ls_data-z_emp_motiu_esmena
                 FROM zrm_dm_exlc_s3t
                WHERE      z_codi_excl_s3 EQ <ls_valcrit>-z_codi_excl_s3
                       AND spras          EQ 'c' .
        SHIFT ls_data-z_emp_motiu_esmena LEFT DELETING LEADING space .
        IF NOT ls_data-z_emp_motiu_esmena IS INITIAL .
          TRANSLATE ls_data-z_emp_motiu_esmena TO LOWER CASE . "#EC TRANSLANG
        ENDIF .

        CONCATENATE ls_data-nom_proveidor ', atès que ' ls_data-z_emp_motiu_esmena '.'
          INTO ls_data-z_emp_motiu_esmena RESPECTING BLANKS.

        CONDENSE ls_data-z_emp_motiu_esmena.
        APPEND ls_data TO <lt_data> .
      ENDAT .
    ENDLOOP .

  ENDMETHOD.


  METHOD get_ent_ex_sobre3_new.
    TYPES: ty_s_data TYPE zerm_quadre_ent_ex_sobre3,
           ty_t_data TYPE STANDARD TABLE OF ty_s_data
                      WITH NON-UNIQUE DEFAULT KEY .
    DATA: lt_valcrit TYPE ty_t_valcrit,
          ls_data    TYPE ty_s_data.

    FIELD-SYMBOLS: <ls_valcrit> TYPE ty_s_valcrit,
                   <lt_data>    TYPE ty_t_data,
                   <ls_oferta>  TYPE ty_s_oferta.

    IF my_ent_ex_sobre3 IS BOUND .
      ex_data = my_ent_ex_sobre3 .
      RETURN .
    ENDIF .

    CREATE DATA my_ent_ex_sobre3 TYPE ty_t_data .
    ex_data = my_ent_ex_sobre3 .
    ASSIGN ex_data->* TO <lt_data> .

    CALL METHOD get_valcrit
      EXPORTING
        im_docclass = im_docclass
        im_objectid = im_objectid
      IMPORTING
        ex_valcrit  = lt_valcrit.


    SORT lt_valcrit BY proveidor .
    DELETE lt_valcrit WHERE z_exclos_s3 EQ space .
    LOOP AT lt_valcrit ASSIGNING <ls_valcrit> .
      AT END OF proveidor .
        CLEAR ls_data .
        ls_data-proveidor          = <ls_valcrit>-proveidor .
        ls_data-nom_proveidor      = get_vendor_name( ls_data-proveidor ) .
        ls_data-z_tipus_oferta     = <ls_valcrit>-z_tipus_oferta .

        SELECT SINGLE z_descripcio INTO ls_data-z_emp_motiu_esmena
                 FROM zrm_dm_exlc_s3t
                WHERE      z_codi_excl_s3 EQ <ls_valcrit>-z_codi_excl_s3
                       AND spras          EQ 'c' .
        SHIFT ls_data-z_emp_motiu_esmena LEFT DELETING LEADING space .
        IF NOT ls_data-z_emp_motiu_esmena IS INITIAL .
          TRANSLATE ls_data-z_emp_motiu_esmena TO LOWER CASE . "#EC TRANSLANG
        ENDIF .

*      CONCATENATE ls_data-nom_proveidor ', atès que ' ls_data-z_emp_motiu_esmena '.'
*        INTO ls_data-z_emp_motiu_esmena RESPECTING BLANKS.

        CONDENSE ls_data-z_emp_motiu_esmena.
        APPEND ls_data TO <lt_data> .
      ENDAT .
    ENDLOOP .

  ENDMETHOD.


  METHOD get_ent_ex_sobrex.
    DATA: lt_valcrit TYPE ty_t_valcrit,
          ls_entitat TYPE ty_s_entitat.

    FIELD-SYMBOLS: <ls_valcrit> TYPE ty_s_valcrit,
                   <lt_entitat> TYPE ty_t_entitat,
                   <my_cached>  TYPE REF TO data.

    CASE im_num_sob .
      WHEN '1' .    ASSIGN my_ent_ex_sobre1 TO <my_cached> .
      WHEN '2' .    ASSIGN my_ent_ex_sobre2 TO <my_cached> .
      WHEN OTHERS . RETURN .
    ENDCASE .

    IF <my_cached> IS BOUND .
      ex_data = <my_cached> .
      RETURN .
    ENDIF .

    CREATE DATA <my_cached> TYPE ty_t_entitat .
    ex_data = <my_cached> .
    ASSIGN ex_data->* TO <lt_entitat> .

    CALL METHOD get_valcrit
      EXPORTING
        im_docclass = im_docclass
        im_objectid = im_objectid
      IMPORTING
        ex_valcrit  = lt_valcrit.

* Els Quadres de S1 no han de tenir en compte les ofertes variants perquè la
* revisió de S1 només es fa per a l'oferta base. A la ZRM_DT_VAL_CRIT hi trobarem
* registres, però son còpia exacta dels corresponents a l'oferta base.
    IF im_num_sob EQ '1' .
      DELETE lt_valcrit WHERE z_tipus_oferta EQ gc_oferta_variant .
    ENDIF .

    LOOP AT lt_valcrit ASSIGNING <ls_valcrit> WHERE z_num_sob EQ im_num_sob
                                                AND (    z_exclos_s1s2  EQ 'X'
                                                      OR z_excl_pos_esm EQ 'X' ) .
      READ TABLE <lt_entitat> TRANSPORTING NO FIELDS
            WITH TABLE KEY proveidor =  <ls_valcrit>-proveidor .
      CHECK sy-subrc NE 0 .
      ls_entitat-proveidor     = <ls_valcrit>-proveidor .
      ls_entitat-nom_proveidor = get_vendor_name( ls_entitat-proveidor ) .
      CONCATENATE '-' ls_entitat-nom_proveidor INTO ls_entitat-llista_nom_prov SEPARATED BY space.
      APPEND ls_entitat TO <lt_entitat> .
    ENDLOOP .
    SORT <lt_entitat> BY nom_proveidor .

  ENDMETHOD.


  METHOD get_ent_ex_vartec.
    TYPES: ty_s_data TYPE zerm_quadre_ent_ex_vartec,
           ty_t_data TYPE STANDARD TABLE OF ty_s_data
                      WITH NON-UNIQUE DEFAULT KEY .
    DATA: lt_valcrit TYPE ty_t_valcrit,
          lt_ofertes TYPE ty_t_oferta,
          ls_data    TYPE ty_s_data.

    FIELD-SYMBOLS: <ls_valcrit> TYPE ty_s_valcrit,
                   <lt_data>    TYPE ty_t_data,
                   <ls_oferta>  TYPE ty_s_oferta.

    IF my_ent_ex_vartec IS BOUND .
      ex_data = my_ent_ex_vartec .
      RETURN .
    ENDIF .

    CREATE DATA my_ent_ex_vartec TYPE ty_t_data .
    ex_data = my_ent_ex_vartec .
    ASSIGN ex_data->* TO <lt_data> .

    CALL METHOD get_valcrit
      EXPORTING
        im_docclass = im_docclass
        im_objectid = im_objectid
      IMPORTING
        ex_valcrit  = lt_valcrit.

    CALL METHOD get_ofertes
      EXPORTING
        im_docclass = im_docclass
        im_objectid = im_objectid
      IMPORTING
        ex_ofertes  = lt_ofertes.

    SORT lt_valcrit BY proveidor z_num_ofer.
    DELETE lt_valcrit WHERE z_exclos_var_tec EQ space .
    LOOP AT lt_valcrit ASSIGNING <ls_valcrit> .
      AT END OF z_num_ofer . "proveidor .
        IF <ls_valcrit>-z_tipus_oferta = gc_oferta_variant.
          CLEAR ls_data .
          ls_data-proveidor          = <ls_valcrit>-proveidor .
          ls_data-nom_proveidor      = get_vendor_name( ls_data-proveidor ) .

          READ TABLE lt_ofertes ASSIGNING <ls_oferta> WITH KEY z_num_ofer = <ls_valcrit>-z_num_ofer.
          SHIFT <ls_oferta>-z_num_variant LEFT DELETING LEADING '0' .
          CONDENSE <ls_oferta>-z_num_variant.
          CONCATENATE ls_data-nom_proveidor ' (variant número ' <ls_oferta>-z_num_variant ').'
                      INTO ls_data-z_literal RESPECTING BLANKS.
          CONDENSE ls_data-z_literal.

          APPEND ls_data TO <lt_data> .
        ENDIF.
      ENDAT .
    ENDLOOP .

  ENDMETHOD.


  METHOD get_ent_ex_var_sobre3.

    TYPES: ty_s_data TYPE zerm_quadre_ent_ex_var_s3,
           ty_t_data TYPE STANDARD TABLE OF ty_s_data WITH NON-UNIQUE DEFAULT KEY.

    DATA: lt_valcrit TYPE ty_t_valcrit,
          ls_entitat TYPE ty_s_data,
          lt_ofertes TYPE ty_t_oferta.

    FIELD-SYMBOLS: <ls_valcrit> TYPE ty_s_valcrit,
                   <lt_entitat> TYPE ty_t_data,
                   <ls_oferta>  TYPE ty_s_oferta.

    IF my_ent_ex_var_sobre3 IS BOUND .
      ex_data = my_ent_ex_var_sobre3  .
      RETURN .
    ENDIF .

    CREATE DATA my_ent_ex_var_sobre3 TYPE ty_t_data .
    ex_data = my_ent_ex_var_sobre3 .
    ASSIGN ex_data->* TO <lt_entitat> .

    CALL METHOD get_valcrit
      EXPORTING
        im_docclass = im_docclass
        im_objectid = im_objectid
      IMPORTING
        ex_valcrit  = lt_valcrit.

    CALL METHOD get_ofertes
      EXPORTING
        im_docclass = im_docclass
        im_objectid = im_objectid
      IMPORTING
        ex_ofertes  = lt_ofertes.

    LOOP AT lt_valcrit ASSIGNING <ls_valcrit> WHERE z_tipus_oferta EQ gc_oferta_variant
                                                AND z_exclos_s3    NE space .

      READ TABLE lt_ofertes ASSIGNING <ls_oferta>
                          WITH KEY z_num_ofer = <ls_valcrit>-z_num_ofer .
      CHECK sy-subrc EQ 0.

      READ TABLE <lt_entitat> TRANSPORTING NO FIELDS
            WITH KEY proveidor   = <ls_valcrit>-proveidor
                     num_variant = <ls_oferta>-z_num_variant.
      CHECK sy-subrc NE 0 .

      ls_entitat-proveidor     = <ls_valcrit>-proveidor .
      ls_entitat-num_variant   = <ls_oferta>-z_num_variant .
      ls_entitat-nom_proveidor = <ls_oferta>-z_num_variant .
      SHIFT ls_entitat-nom_proveidor LEFT DELETING LEADING '0' .
      CONCATENATE <ls_oferta>-nom_proveidor ` (variant número ` ls_entitat-nom_proveidor `)`
             INTO ls_entitat-nom_proveidor .


      APPEND ls_entitat TO <lt_entitat> .
    ENDLOOP .
    SORT <lt_entitat> BY nom_proveidor .
  ENDMETHOD.


  METHOD get_ent_inf_temerari.

***>>> INICI Insert SPEC-46405 ETXGL
    TYPES: ty_s_data TYPE zerm_quadre_inf_temerari,
           ty_t_data TYPE STANDARD TABLE OF ty_s_data WITH NON-UNIQUE DEFAULT KEY.
    DATA: ls_data    TYPE ty_s_data,
          lt_ofertes TYPE ty_t_oferta.

    FIELD-SYMBOLS: <lt_data>   TYPE ty_t_data,
                   <ls_oferta> TYPE ty_s_oferta.

    IF my_ent_inf_temerari IS BOUND.
      ex_data = my_ent_inf_temerari.
      RETURN.
    ENDIF.

    CREATE DATA my_ent_inf_temerari TYPE ty_t_data.
    ex_data = my_ent_inf_temerari.
    ASSIGN my_ent_inf_temerari->* TO <lt_data>.


    CALL METHOD get_ofertes
      EXPORTING
        im_docclass = im_docclass
        im_objectid = im_objectid
      IMPORTING
        ex_ofertes  = lt_ofertes.


    DELETE lt_ofertes WHERE z_temerari NE 'X'
                         OR z_codi_com_temer EQ '03'.

    CHECK NOT lt_ofertes IS INITIAL.

    LOOP AT lt_ofertes ASSIGNING <ls_oferta> WHERE z_temerari EQ 'X'.
      CLEAR ls_data.

      ls_data-proveidor     = <ls_oferta>-proveidor.
      ls_data-nom_proveidor = <ls_oferta>-nom_proveidor.
      ls_data-z_num_ofer    = <ls_oferta>-z_num_ofer.

      APPEND ls_data TO <lt_data>.
    ENDLOOP.
***<<< FI Insert SPEC-46405 ETXGL
  ENDMETHOD.


  METHOD get_ent_noex_sobre12.
    TYPES: ty_s_data TYPE zerm_quadre_ent_noex_s12,
           ty_t_data TYPE STANDARD TABLE OF ty_s_data WITH NON-UNIQUE DEFAULT KEY.
    DATA: ls_data        TYPE ty_s_data,
          l_ref_excloses TYPE REF TO data,
          lt_ofertes     TYPE ty_t_oferta.
    FIELD-SYMBOLS: <lt_noexcloses> TYPE ty_t_data,
                   <lt_excloses>   TYPE ty_t_data,
                   <ls_oferta>     TYPE ty_s_oferta.

    IF my_ent_noex_sobre12  IS BOUND .
      ex_data = my_ent_noex_sobre12 .
      RETURN .
    ENDIF .

* Obtenim les entitats excloses.
    CALL METHOD get_ent_ex_sobre12
      EXPORTING
        im_objectid = im_objectid
        im_docclass = im_docclass
      RECEIVING
        ex_data     = l_ref_excloses.

    CHECK l_ref_excloses IS BOUND .

    CREATE DATA my_ent_noex_sobre12 TYPE ty_t_data .
    ex_data = my_ent_noex_sobre12 .
    ASSIGN ex_data->*        TO <lt_noexcloses> .
    ASSIGN l_ref_excloses->* TO <lt_excloses> .

    CALL METHOD get_ofertes
      EXPORTING
        im_docclass = im_docclass
        im_objectid = im_objectid
      IMPORTING
        ex_ofertes  = lt_ofertes.

    LOOP AT lt_ofertes ASSIGNING <ls_oferta> WHERE z_tipus_oferta EQ gc_oferta_variant .
      READ TABLE <lt_excloses> TRANSPORTING NO FIELDS WITH
               KEY proveidor   = <ls_oferta>-proveidor
                   num_variant = <ls_oferta>-z_num_variant .
      CHECK sy-subrc NE 0 .
      ls_data-proveidor     = <ls_oferta>-proveidor .
      ls_data-num_variant   = <ls_oferta>-z_num_variant .
      ls_data-nom_proveidor = <ls_oferta>-z_num_variant .
      SHIFT ls_data-nom_proveidor LEFT DELETING LEADING '0' .
      CONCATENATE <ls_oferta>-nom_proveidor ` (variant número ` ls_data-nom_proveidor `)`
             INTO ls_data-nom_proveidor .
      APPEND ls_data TO <lt_noexcloses> .
    ENDLOOP .

    SORT <lt_noexcloses> BY nom_proveidor .
  ENDMETHOD.


  METHOD get_ent_noex_sobre123.
    TYPES: ty_s_data TYPE zerm_quadre_ent_noex_s123,
           ty_t_data TYPE STANDARD TABLE OF ty_s_data WITH NON-UNIQUE DEFAULT KEY.
    DATA: ls_data        TYPE ty_s_data,
          l_ref_excloses TYPE REF TO data,
          lt_ofertes     TYPE ty_t_oferta.
    FIELD-SYMBOLS: <lt_noexcloses> TYPE ty_t_data,
                   <lt_excloses>   TYPE ty_t_data,
                   <ls_oferta>     TYPE ty_s_oferta.

    IF my_ent_noex_sobre123  IS BOUND .
      ex_data = my_ent_noex_sobre123 .
      RETURN .
    ENDIF .

* Obtenim les entitats excloses..
    CALL METHOD get_ent_ex_sobre123
      EXPORTING
        im_objectid = im_objectid
        im_docclass = im_docclass
      RECEIVING
        ex_data     = l_ref_excloses.

    CHECK l_ref_excloses IS BOUND .

    CREATE DATA my_ent_noex_sobre123 TYPE ty_t_data .
    ex_data = my_ent_noex_sobre123 .
    ASSIGN ex_data->*        TO <lt_noexcloses> .
    ASSIGN l_ref_excloses->* TO <lt_excloses> .

    CALL METHOD get_ofertes
      EXPORTING
        im_docclass = im_docclass
        im_objectid = im_objectid
      IMPORTING
        ex_ofertes  = lt_ofertes.

    LOOP AT lt_ofertes ASSIGNING <ls_oferta> WHERE z_tipus_oferta EQ gc_oferta_variant .
      READ TABLE <lt_excloses> TRANSPORTING NO FIELDS WITH
               KEY proveidor   = <ls_oferta>-proveidor
                   num_variant = <ls_oferta>-z_num_variant .
      CHECK sy-subrc NE 0 .
      ls_data-proveidor     = <ls_oferta>-proveidor .
      ls_data-num_variant   = <ls_oferta>-z_num_variant .
      ls_data-nom_proveidor = <ls_oferta>-z_num_variant .
      SHIFT ls_data-nom_proveidor LEFT DELETING LEADING '0' .
      CONCATENATE <ls_oferta>-nom_proveidor ` (variant número ` ls_data-nom_proveidor `)`
             INTO ls_data-nom_proveidor .
      APPEND ls_data TO <lt_noexcloses> .
    ENDLOOP .

    SORT <lt_noexcloses> BY nom_proveidor .
  ENDMETHOD.


  METHOD get_ent_noex_sobre123_notem.
*-----------------------------------------------------------------------
* AUTOR: ECFA
* DATA CREACIÓ: 24.02.2020 10:36:51
* SPEC/TASCA: SPEC-57443
*-----------------------------------------------------------------------


    CONSTANTS: lc_oferta_base    TYPE z_tipus_oferta VALUE 'B',
               lc_oferta_variant TYPE z_tipus_oferta VALUE 'V'.
    TYPES:
      BEGIN OF ty_s_oferta.
        INCLUDE TYPE zrm_dt_ofertes    AS offer_data.
        TYPES:  z_num_variant TYPE z_num_variant,
      END   OF ty_s_oferta .

    TYPES: ty_s_data TYPE zerm_ent_noex_sobre123_pt,
           ty_t_data TYPE STANDARD TABLE OF ty_s_data WITH NON-UNIQUE DEFAULT KEY.

    DATA: lc_wa_data     TYPE ty_s_data,
          lc_it_lfa1     TYPE STANDARD TABLE OF lfa1,
          lc_wa_lfa1     TYPE lfa1,
          lc_it_ofertes  TYPE STANDARD TABLE OF ty_s_oferta,
          lc_wa_ofertes  TYPE ty_s_oferta,
          l_num_variant  TYPE z_num_ofer,
          lv_tabix       TYPE sy-tabix,
          lv_proc_adj    TYPE zrm_dt_exp_cont-z_proc_adj,
          lv_obert_simpl TYPE z_obert_simpl.

    DATA: lt_ent_ex_sobre123 TYPE REF TO data.

    FIELD-SYMBOLS: <lt_entitat>   TYPE ty_t_data.

    CREATE DATA lt_ent_ex_sobre123 TYPE ty_t_data.
    ex_data = lt_ent_ex_sobre123.
    ASSIGN ex_data->* TO <lt_entitat>.

* Es selecciona el tipus de procediment d'adjudicació
    SELECT SINGLE z_proc_adj z_obert_simpl
      INTO (lv_proc_adj, lv_obert_simpl)
      FROM zrm_dt_exp_cont
      WHERE docclass       EQ im_docclass AND
            objectid       EQ im_objectid.

* Es seleccionen les ofertes
    SELECT * INTO TABLE lc_it_ofertes
      FROM zrm_dt_ofertes
      WHERE docclass       EQ im_docclass AND
            objectid       EQ im_objectid.

    IF lv_obert_simpl EQ 'D'.
      DELETE lc_it_ofertes WHERE z_exclos_plec EQ abap_true.
    ENDIF.

    SORT lc_it_ofertes BY proveidor z_tipus_oferta z_num_ofer .
    LOOP AT lc_it_ofertes INTO  lc_wa_ofertes.
      lv_tabix = sy-tabix.

*-- Asignem el número d'oferta variant --------------------------
      IF lc_wa_ofertes-z_tipus_oferta EQ lc_oferta_base.
        CLEAR lc_wa_ofertes-z_num_variant .
        l_num_variant = 1 .
      ELSEIF lc_wa_ofertes-z_tipus_oferta EQ lc_oferta_variant.
        lc_wa_ofertes-z_num_variant = l_num_variant .
        ADD 1 TO l_num_variant .
      ENDIF .
      MODIFY lc_it_ofertes FROM lc_wa_ofertes INDEX lv_tabix.
    ENDLOOP .

* En cas que sigui un restringit, només es seleccionaran les ofertes que
* presenten proposta
    IF lv_proc_adj = 'CR'.
      DELETE lc_it_ofertes WHERE z_pres_proposta EQ space.
    ENDIF.

    CHECK lc_it_ofertes[] IS NOT INITIAL.

* Es seleccionen els atributs dels proveïdors de les ofertes
    SELECT *
    FROM  lfa1
    INTO  TABLE lc_it_lfa1
    FOR ALL ENTRIES IN lc_it_ofertes
    WHERE lifnr EQ lc_it_ofertes-proveidor.


    LOOP AT lc_it_ofertes INTO lc_wa_ofertes
                     WHERE   z_exclos_s3     EQ space
                         AND z_exclos_s1     EQ space
                         AND z_exclos_s2     EQ space.


      CLEAR lc_wa_data.
      lc_wa_data-proveidor = lc_wa_ofertes-proveidor.
      READ TABLE lc_it_lfa1 INTO lc_wa_lfa1 WITH KEY lifnr = lc_wa_ofertes-proveidor.
      IF sy-subrc IS INITIAL.
        CONCATENATE lc_wa_lfa1-name1 lc_wa_lfa1-name2 lc_wa_lfa1-name3 lc_wa_lfa1-name4
               INTO lc_wa_data-nom_proveidor SEPARATED BY space.
      ENDIF.

      IF lc_wa_ofertes-z_tipus_oferta = lc_oferta_base.
        lc_wa_data-z_prov_variant = lc_wa_data-nom_proveidor.
      ELSEIF lc_wa_ofertes-z_tipus_oferta = lc_oferta_variant.
        SHIFT lc_wa_ofertes-z_num_variant LEFT DELETING LEADING '0' .
        CONDENSE lc_wa_ofertes-z_num_variant.
        CONCATENATE lc_wa_data-nom_proveidor ' (variant número '
                    lc_wa_ofertes-z_num_variant
                    INTO lc_wa_data-z_prov_variant RESPECTING BLANKS.
        CONDENSE lc_wa_data-z_prov_variant.
        CONCATENATE lc_wa_data-z_prov_variant ').' INTO lc_wa_data-z_prov_variant.
      ENDIF.


      APPEND lc_wa_data TO <lt_entitat>.

    ENDLOOP.
    SORT <lt_entitat> BY nom_proveidor .

  ENDMETHOD.


  METHOD get_ent_noex_sobre123_pt.
    CONSTANTS: lc_oferta_base    TYPE z_tipus_oferta VALUE 'B',
               lc_oferta_variant TYPE z_tipus_oferta VALUE 'V'.
    TYPES:
      BEGIN OF ty_s_oferta.
        INCLUDE TYPE zrm_dt_ofertes    AS offer_data.
        TYPES:  z_num_variant TYPE z_num_variant,
      END   OF ty_s_oferta .

    TYPES: ty_s_data TYPE zerm_ent_noex_sobre123_pt,
           ty_t_data TYPE STANDARD TABLE OF ty_s_data WITH NON-UNIQUE DEFAULT KEY.

    DATA: lc_wa_data     TYPE ty_s_data,
          lc_it_lfa1     TYPE STANDARD TABLE OF lfa1,
          lc_wa_lfa1     TYPE lfa1,
          lc_it_ofertes  TYPE STANDARD TABLE OF ty_s_oferta,
          lc_wa_ofertes  TYPE ty_s_oferta,
          l_num_variant  TYPE z_num_ofer,
          lv_tabix       TYPE sy-tabix,
          lv_proc_adj    TYPE zrm_dt_exp_cont-z_proc_adj,
          lv_obert_simpl TYPE z_obert_simpl.

    DATA: lt_ent_ex_sobre123 TYPE REF TO data.

    FIELD-SYMBOLS: <lt_entitat>   TYPE ty_t_data.

    CREATE DATA lt_ent_ex_sobre123 TYPE ty_t_data.
    ex_data = lt_ent_ex_sobre123.
    ASSIGN ex_data->* TO <lt_entitat>.

* Es selecciona el tipus de procediment d'adjudicació
    SELECT SINGLE z_proc_adj z_obert_simpl
      INTO (lv_proc_adj, lv_obert_simpl)
      FROM zrm_dt_exp_cont
      WHERE docclass       EQ im_docclass AND
            objectid       EQ im_objectid.

* Es seleccionen les ofertes
    SELECT * INTO TABLE lc_it_ofertes
      FROM zrm_dt_ofertes
      WHERE docclass       EQ im_docclass AND
            objectid       EQ im_objectid.

    IF lv_obert_simpl EQ 'D'.
      DELETE lc_it_ofertes WHERE z_exclos_plec EQ abap_true.
    ENDIF.

    SORT lc_it_ofertes BY proveidor z_tipus_oferta z_num_ofer .
    LOOP AT lc_it_ofertes INTO  lc_wa_ofertes.
      lv_tabix = sy-tabix.

*-- Asignem el número d'oferta variant --------------------------
      IF lc_wa_ofertes-z_tipus_oferta EQ lc_oferta_base.
        CLEAR lc_wa_ofertes-z_num_variant .
        l_num_variant = 1 .
      ELSEIF lc_wa_ofertes-z_tipus_oferta EQ lc_oferta_variant.
        lc_wa_ofertes-z_num_variant = l_num_variant .
        ADD 1 TO l_num_variant .
      ENDIF .
      MODIFY lc_it_ofertes FROM lc_wa_ofertes INDEX lv_tabix.
    ENDLOOP .

* En cas que sigui un restringit, només es seleccionaran les ofertes que presenten proposta
    IF lv_proc_adj = 'CR'.
      DELETE lc_it_ofertes WHERE z_pres_proposta EQ space.
    ENDIF.

    CHECK lc_it_ofertes[] IS NOT INITIAL.

* Es seleccionen els atributs dels proveïdors de les ofertes
    SELECT *
    FROM  lfa1
    INTO  TABLE lc_it_lfa1
    FOR ALL ENTRIES IN lc_it_ofertes
    WHERE lifnr EQ lc_it_ofertes-proveidor.


    LOOP AT lc_it_ofertes INTO lc_wa_ofertes
                     WHERE   z_exclos_s3     EQ space
                         AND z_exclos_s1     EQ space
                         AND z_exclos_s2     EQ space
                         AND z_excl_punt_tec EQ space.
      CLEAR lc_wa_data.
      lc_wa_data-proveidor = lc_wa_ofertes-proveidor.
      READ TABLE lc_it_lfa1 INTO lc_wa_lfa1 WITH KEY lifnr = lc_wa_ofertes-proveidor.
      IF sy-subrc IS INITIAL.
        CONCATENATE lc_wa_lfa1-name1 lc_wa_lfa1-name2 lc_wa_lfa1-name3 lc_wa_lfa1-name4
               INTO lc_wa_data-nom_proveidor SEPARATED BY space.
      ENDIF.

      IF lc_wa_ofertes-z_tipus_oferta = lc_oferta_base.
        lc_wa_data-z_prov_variant = lc_wa_data-nom_proveidor.
      ELSEIF lc_wa_ofertes-z_tipus_oferta = lc_oferta_variant.
        SHIFT lc_wa_ofertes-z_num_variant LEFT DELETING LEADING '0' .
        CONDENSE lc_wa_ofertes-z_num_variant.
        CONCATENATE lc_wa_data-nom_proveidor ' (variant número '
                    lc_wa_ofertes-z_num_variant
                    INTO lc_wa_data-z_prov_variant RESPECTING BLANKS.
        CONDENSE lc_wa_data-z_prov_variant.
        CONCATENATE lc_wa_data-z_prov_variant ').' INTO lc_wa_data-z_prov_variant.
      ENDIF.


      APPEND lc_wa_data TO <lt_entitat>.

    ENDLOOP.
    SORT <lt_entitat> BY nom_proveidor .

  ENDMETHOD.


  METHOD get_ent_noex_sobre123_tem.
    CONSTANTS: lc_oferta_base    TYPE z_tipus_oferta VALUE 'B',
               lc_oferta_variant TYPE z_tipus_oferta VALUE 'V'.
    TYPES:
      BEGIN OF ty_s_oferta.
        INCLUDE TYPE zrm_dt_ofertes    AS offer_data.
        TYPES:  z_num_variant TYPE z_num_variant,
      END   OF ty_s_oferta .

    TYPES: ty_s_data TYPE zerm_ent_noex_sobre123_pt,
           ty_t_data TYPE STANDARD TABLE OF ty_s_data WITH NON-UNIQUE DEFAULT KEY.

    DATA: lc_wa_data     TYPE ty_s_data,
          lc_it_lfa1     TYPE STANDARD TABLE OF lfa1,
          lc_wa_lfa1     TYPE lfa1,
          lc_it_ofertes  TYPE STANDARD TABLE OF ty_s_oferta,
          lc_wa_ofertes  TYPE ty_s_oferta,
          l_num_variant  TYPE z_num_ofer,
          lv_tabix       TYPE sy-tabix,
          lv_proc_adj    TYPE zrm_dt_exp_cont-z_proc_adj,
          lv_obert_simpl TYPE z_obert_simpl.

    DATA: lt_ent_ex_sobre123 TYPE REF TO data.

    FIELD-SYMBOLS: <lt_entitat>   TYPE ty_t_data.

    CREATE DATA lt_ent_ex_sobre123 TYPE ty_t_data.
    ex_data = lt_ent_ex_sobre123.
    ASSIGN ex_data->* TO <lt_entitat>.

* Es selecciona el tipus de procediment d'adjudicació
    SELECT SINGLE z_proc_adj z_obert_simpl
      INTO (lv_proc_adj, lv_obert_simpl)
      FROM zrm_dt_exp_cont
      WHERE docclass       EQ im_docclass AND
            objectid       EQ im_objectid.

* Es seleccionen les ofertes
    SELECT * INTO TABLE lc_it_ofertes
      FROM zrm_dt_ofertes
      WHERE docclass       EQ im_docclass AND
            objectid       EQ im_objectid.

    IF lv_obert_simpl EQ 'D'.
      DELETE lc_it_ofertes WHERE z_exclos_plec EQ abap_true.
    ENDIF.

    SORT lc_it_ofertes BY proveidor z_tipus_oferta z_num_ofer .
    LOOP AT lc_it_ofertes INTO  lc_wa_ofertes.
      lv_tabix = sy-tabix.

*-- Asignem el número d'oferta variant --------------------------
      IF lc_wa_ofertes-z_tipus_oferta EQ lc_oferta_base.
        CLEAR lc_wa_ofertes-z_num_variant .
        l_num_variant = 1 .
      ELSEIF lc_wa_ofertes-z_tipus_oferta EQ lc_oferta_variant.
        lc_wa_ofertes-z_num_variant = l_num_variant .
        ADD 1 TO l_num_variant .
      ENDIF .
      MODIFY lc_it_ofertes FROM lc_wa_ofertes INDEX lv_tabix.
    ENDLOOP .

* En cas que sigui un restringit, només es seleccionaran les ofertes que presenten proposta
    IF lv_proc_adj = 'CR'.
      DELETE lc_it_ofertes WHERE z_pres_proposta EQ space.
    ENDIF.

    CHECK lc_it_ofertes[] IS NOT INITIAL.

* Es seleccionen els atributs dels proveïdors de les ofertes
    SELECT *
    FROM  lfa1
    INTO  TABLE lc_it_lfa1
    FOR ALL ENTRIES IN lc_it_ofertes
    WHERE lifnr EQ lc_it_ofertes-proveidor.


    LOOP AT lc_it_ofertes INTO lc_wa_ofertes
                     WHERE   z_exclos_s3     EQ space
                         AND z_exclos_s1     EQ space
                         AND z_exclos_s2     EQ space
                         ">>>SPEC:57443, Inici modificació  - ECFA
*                       AND z_temerari      EQ space.
                         AND z_temerari      EQ iv_temerari.
      "<<<SPEC:57443, Final modificació - ECFA

      CLEAR lc_wa_data.
      lc_wa_data-proveidor = lc_wa_ofertes-proveidor.
      READ TABLE lc_it_lfa1 INTO lc_wa_lfa1 WITH KEY lifnr = lc_wa_ofertes-proveidor.
      IF sy-subrc IS INITIAL.
        CONCATENATE lc_wa_lfa1-name1 lc_wa_lfa1-name2 lc_wa_lfa1-name3 lc_wa_lfa1-name4
               INTO lc_wa_data-nom_proveidor SEPARATED BY space.
      ENDIF.

      IF lc_wa_ofertes-z_tipus_oferta = lc_oferta_base.
        lc_wa_data-z_prov_variant = lc_wa_data-nom_proveidor.
      ELSEIF lc_wa_ofertes-z_tipus_oferta = lc_oferta_variant.
        SHIFT lc_wa_ofertes-z_num_variant LEFT DELETING LEADING '0' .
        CONDENSE lc_wa_ofertes-z_num_variant.
        CONCATENATE lc_wa_data-nom_proveidor ' (variant número '
                    lc_wa_ofertes-z_num_variant
                    INTO lc_wa_data-z_prov_variant RESPECTING BLANKS.
        CONDENSE lc_wa_data-z_prov_variant.
        CONCATENATE lc_wa_data-z_prov_variant ').' INTO lc_wa_data-z_prov_variant.
      ENDIF.


      APPEND lc_wa_data TO <lt_entitat>.

    ENDLOOP.
    SORT <lt_entitat> BY nom_proveidor .

  ENDMETHOD.


  METHOD get_ent_noex_var_sobre3.

    TYPES: ty_s_data     TYPE zerm_quadre_ent_noex_var_s3,
           ty_t_data     TYPE STANDARD TABLE OF ty_s_data WITH NON-UNIQUE DEFAULT KEY,
           ty_s_data_s12 TYPE zerm_quadre_ent_noex_s12,
           ty_t_data_s12 TYPE STANDARD TABLE OF ty_s_data_s12 WITH NON-UNIQUE DEFAULT KEY.

    DATA: ls_data            TYPE ty_s_data,
          l_ref_excloses     TYPE REF TO data,
          l_ref_excloses_s12 TYPE REF TO data,
          lt_ofertes         TYPE ty_t_oferta.
    FIELD-SYMBOLS: <lt_noexcloses>   TYPE ty_t_data,
                   <lt_excloses>     TYPE ty_t_data,
                   <lt_excloses_s12> TYPE ty_t_data_s12,
                   <ls_oferta>       TYPE ty_s_oferta.

    IF my_ent_noex_var_sobre3  IS BOUND .
      ex_data = my_ent_noex_var_sobre3 .
      RETURN .
    ENDIF .

* Obtenim les entitats excloses per sobre 3.
    CALL METHOD get_ent_ex_var_sobre3
      EXPORTING
        im_objectid = im_objectid
        im_docclass = im_docclass
      RECEIVING
        ex_data     = l_ref_excloses.

    CHECK l_ref_excloses IS BOUND .

    CREATE DATA my_ent_noex_var_sobre3 TYPE ty_t_data .
    ex_data = my_ent_noex_var_sobre3 .
    ASSIGN ex_data->*        TO <lt_noexcloses> .
    ASSIGN l_ref_excloses->* TO <lt_excloses> .

* Obtenim les entitats excloses per sobre 1 o 2 .
    CALL METHOD get_ent_ex_sobre12
      EXPORTING
        im_objectid = im_objectid
        im_docclass = im_docclass
      RECEIVING
        ex_data     = l_ref_excloses_s12.

    CHECK l_ref_excloses_s12 IS BOUND .
    ASSIGN l_ref_excloses_s12->* TO <lt_excloses_s12> .

    CALL METHOD get_ofertes
      EXPORTING
        im_docclass = im_docclass
        im_objectid = im_objectid
      IMPORTING
        ex_ofertes  = lt_ofertes.

    DELETE lt_ofertes WHERE z_excl_punt_tec IS NOT INITIAL .
    LOOP AT lt_ofertes ASSIGNING <ls_oferta> WHERE z_tipus_oferta EQ gc_oferta_variant .
      READ TABLE <lt_excloses_s12> TRANSPORTING NO FIELDS WITH
               KEY proveidor   = <ls_oferta>-proveidor
                   num_variant = <ls_oferta>-z_num_variant.
      CHECK sy-subrc NE 0.

      READ TABLE <lt_excloses> TRANSPORTING NO FIELDS WITH
               KEY proveidor   = <ls_oferta>-proveidor
                   num_variant = <ls_oferta>-z_num_variant .
      CHECK sy-subrc NE 0 .
      ls_data-proveidor     = <ls_oferta>-proveidor .
      ls_data-num_variant   = <ls_oferta>-z_num_variant .
      ls_data-nom_proveidor = <ls_oferta>-z_num_variant .
      SHIFT ls_data-nom_proveidor LEFT DELETING LEADING '0' .
      CONCATENATE <ls_oferta>-nom_proveidor ` (variant número ` ls_data-nom_proveidor `)`
             INTO ls_data-nom_proveidor .
      APPEND ls_data TO <lt_noexcloses> .
    ENDLOOP .

    SORT <lt_noexcloses> BY nom_proveidor .

  ENDMETHOD.


  METHOD get_ent_ober_pliq.
    DATA: lt_valcrit  TYPE ty_t_valcrit,
          ls_entitat  TYPE ty_s_entitat,
          ls_valcrit  TYPE ty_s_valcrit,
          lv_proc_adj TYPE zrm_dt_exp_cont-z_proc_adj.

    FIELD-SYMBOLS: <lt_entitat>   TYPE ty_t_entitat .

    IF my_ent_ex_sobre1 IS BOUND .
      ex_data = my_ent_ober_pliq .
      RETURN .
    ENDIF .

    CREATE DATA my_ent_ober_pliq TYPE ty_t_entitat .
    ex_data = my_ent_ober_pliq .
    ASSIGN ex_data->* TO <lt_entitat> .

* Es selecciona el tipus de procediment d'adjudicació
    SELECT SINGLE z_proc_adj
      INTO lv_proc_adj
      FROM zrm_dt_exp_cont
      WHERE docclass       EQ im_docclass AND
            objectid       EQ im_objectid.

    CALL METHOD get_valcrit
      EXPORTING
        im_docclass = im_docclass
        im_objectid = im_objectid
      IMPORTING
        ex_valcrit  = lt_valcrit.

* En cas que sigui un restringit, només es seleccionaran les ofertes que presenten proposta
    IF lv_proc_adj = 'CR'.
      DELETE lt_valcrit WHERE z_pres_proposta EQ space.
    ENDIF.

*-- Llista d'empreses no excloses per S1 ni per S3
*a) Primer ens carreguem les ofertes excloses per S3
    DELETE lt_valcrit WHERE z_exclos_s3 NE space
                         OR z_num_sob NE '1' .

*b) Desprès ens carreguem les ofertes excloses per S1
    LOOP AT lt_valcrit INTO ls_valcrit WHERE    z_exclos_s1s2  EQ 'X'
                                             OR z_excl_pos_esm EQ 'X'  .
      DELETE lt_valcrit   WHERE proveidor EQ ls_valcrit-proveidor .
    ENDLOOP .

* Els Quadres de S1 no han de tenir en compte les ofertes variants perquè la
* revisió de S1 només es fa per a l'oferta base. A la ZRM_DT_VAL_CRIT hi trobarem
* registres, però son còpia exacta dels corresponents a l'oferta base.
    DELETE lt_valcrit WHERE     z_tipus_oferta EQ gc_oferta_variant
                            AND z_num_sob      EQ '1' .

*c) I els proveïdors que queden són els que volem
    SORT lt_valcrit BY proveidor .
    LOOP AT lt_valcrit INTO ls_valcrit .
      AT END OF proveidor .
        ls_entitat-proveidor     = ls_valcrit-proveidor .
        ls_entitat-nom_proveidor = get_vendor_name( ls_entitat-proveidor ) .
        APPEND ls_entitat TO <lt_entitat> .
      ENDAT .
    ENDLOOP .
    SORT <lt_entitat> BY nom_proveidor .

  ENDMETHOD.


  METHOD get_ent_ober_pliq_s1_s2.

    CONSTANTS: lc_oferta_base    TYPE z_tipus_oferta VALUE 'B',
               lc_oferta_variant TYPE z_tipus_oferta VALUE 'V'.

    DATA: lt_valcrit   TYPE ty_t_valcrit,
          ls_entitat   TYPE ty_s_entitat,
          ls_valcrit   TYPE ty_s_valcrit,
          lt_ober_pliq TYPE REF TO data.
    TYPES:
      BEGIN OF ty_s_oferta.
        INCLUDE TYPE zrm_dt_ofertes    AS offer_data.
        TYPES:  z_num_variant TYPE z_num_variant,
      END   OF ty_s_oferta .
    DATA: lc_wa_data    TYPE zerm_ent_exc_sobre2,
          lc_it_lfa1    TYPE STANDARD TABLE OF lfa1,
          lc_wa_lfa1    TYPE lfa1,
          lc_it_ofertes TYPE STANDARD TABLE OF ty_s_oferta,
          lc_wa_ofertes TYPE ty_s_oferta,
          l_num_variant TYPE z_num_ofer,
          lv_proc_adj   TYPE zrm_dt_exp_cont-z_proc_adj,
          lv_tabix      TYPE sy-tabix.

    FIELD-SYMBOLS: <lt_entitat>   TYPE ty_t_entitat .

*  IF my_ent_ex_sobre1 IS BOUND .
*    ex_data = my_ent_ober_pliq .
*    RETURN .
*  ENDIF .

    CREATE DATA lt_ober_pliq  TYPE ty_t_entitat .
    ex_data = lt_ober_pliq.
    ASSIGN ex_data->* TO <lt_entitat> .

* Es selecciona el tipus de procediment d'adjudicació.
    SELECT SINGLE z_proc_adj INTO lv_proc_adj
      FROM zrm_dt_exp_cont
      WHERE docclass       EQ im_docclass AND
            objectid       EQ im_objectid.
* Es seleccionen les ofertes
    SELECT * INTO TABLE lc_it_ofertes
      FROM zrm_dt_ofertes
      WHERE docclass       EQ im_docclass AND
            objectid       EQ im_objectid.

    SORT lc_it_ofertes BY proveidor z_tipus_oferta z_num_ofer .
    LOOP AT lc_it_ofertes INTO  lc_wa_ofertes.
      lv_tabix = sy-tabix.

*-- Asignem el número d'oferta variant --------------------------
      IF lc_wa_ofertes-z_tipus_oferta EQ lc_oferta_base.
        CLEAR lc_wa_ofertes-z_num_variant .
        l_num_variant = 1 .
      ELSEIF lc_wa_ofertes-z_tipus_oferta EQ lc_oferta_variant.
        lc_wa_ofertes-z_num_variant = l_num_variant .
        ADD 1 TO l_num_variant .
      ENDIF .
      MODIFY lc_it_ofertes FROM lc_wa_ofertes INDEX lv_tabix.
    ENDLOOP .
    CHECK lc_it_ofertes[] IS NOT INITIAL.

* En cas que sigui un restringit, només es seleccionaran les ofertes que presenten proposta
    IF lv_proc_adj = 'CR'.
      DELETE lc_it_ofertes WHERE z_pres_proposta EQ space.
    ENDIF.

    LOOP AT lc_it_ofertes INTO lc_wa_ofertes WHERE z_exclos_s1 IS INITIAL.
      IF lc_wa_ofertes-z_exclos_s2 IS NOT INITIAL AND lc_wa_ofertes-z_tipus_exc_s2 = 'OB'.
        CONTINUE.
      ENDIF.
      CLEAR lc_wa_data.
      ls_entitat-proveidor     = lc_wa_ofertes-proveidor .
      ls_entitat-nom_proveidor = get_vendor_name( lc_wa_ofertes-proveidor ) .
      IF lc_wa_ofertes-z_tipus_oferta = lc_oferta_variant.

        SHIFT lc_wa_ofertes-z_num_variant LEFT DELETING LEADING '0' .
        CONDENSE lc_wa_ofertes-z_num_variant.
        CONCATENATE ls_entitat-nom_proveidor' (variant número ' lc_wa_ofertes-z_num_variant
                    INTO ls_entitat-nom_proveidor RESPECTING BLANKS.
        CONDENSE ls_entitat-nom_proveidor.
        CONCATENATE ls_entitat-nom_proveidor ')' INTO ls_entitat-nom_proveidor.
      ENDIF.


      APPEND ls_entitat TO <lt_entitat> .
    ENDLOOP.
    SORT <lt_entitat> BY nom_proveidor .


  ENDMETHOD.


  METHOD get_esmenat_s3_sde.

    DATA: ls_esmena_sx TYPE LINE OF ty_t_esmena_sx.
    DATA: lt_ofertes   TYPE TABLE OF zrm_dt_ofertes.
    DATA: ls_oferta    TYPE          zrm_dt_ofertes.

    FIELD-SYMBOLS: <lt_esmena_sx> TYPE ty_t_esmena_sx.

    IF my_esmenat_s3_sde IS BOUND.
      ex_data = my_esmenat_s3_sde.
      RETURN.
    ENDIF.

    CREATE DATA my_esmenat_s3_sde TYPE ty_t_esmena_sx.
    ex_data = my_esmenat_s3_sde.

    ASSIGN ex_data->* TO <lt_esmena_sx>.

    REFRESH lt_ofertes. CLEAR ls_oferta.

    SELECT * INTO TABLE lt_ofertes FROM zrm_dt_ofertes
      WHERE docclass  EQ im_docclass AND objectid EQ im_objectid.

    IF sy-subrc NE 0.
      RAISE not_found.
    ENDIF.

    DELETE lt_ofertes WHERE NOT ( z_esmena_s3           EQ 'X'   AND
                                  z_exclos_s3           EQ space AND
                                  z_excl_homog          EQ space AND
                                  z_excl_punt_tec       EQ space AND
                                  z_exclos_s1           EQ space AND
                                  z_exc_relrol          EQ space AND
                                  z_exclos_clau         EQ space AND
                                  z_exclos_s2           EQ space AND
                                  z_exclos_var_tec      EQ space AND
                                  z_excl_solv_tec       EQ space AND
                                  z_exclos_s3_postob    EQ space AND
                                  z_exclos_req          EQ space AND
                                  z_exclos_plec         EQ space AND
                                  z_exclos_carrecs      EQ space AND
                                  z_exclos_po_pt        EQ space AND
                                  z_exclos_cont_s3_a_s2 EQ space ).

    REFRESH <lt_esmena_sx>.
    LOOP AT lt_ofertes INTO ls_oferta.

      CLEAR ls_esmena_sx.

      ls_esmena_sx-proveidor     = ls_oferta-proveidor.
      ls_esmena_sx-nom_proveidor = get_vendor_name( ls_esmena_sx-proveidor ).
      ls_esmena_sx-z_num_ofer    = ls_oferta-z_codi_esm_s3.

      SELECT SINGLE z_descripcio INTO ls_esmena_sx-z_motiu_esmena
        FROM zrm_dm_esm_s3t WHERE spras         EQ sy-langu AND
                                 z_codi_esm_s3 EQ ls_oferta-z_codi_esm_s3.


      APPEND ls_esmena_sx TO <lt_esmena_sx>.

    ENDLOOP.

  ENDMETHOD.


  METHOD get_esmena_sx.

    DATA: lt_valcrit   TYPE ty_t_valcrit,
          ls_esmena_sx TYPE LINE OF ty_t_esmena_sx,
          ls_lfa1      TYPE lfa1.


    FIELD-SYMBOLS: <ls_valcrit>   TYPE ty_s_valcrit,
                   <lt_esmena_sx> TYPE ty_t_esmena_sx,
                   <my_cached>    TYPE REF TO data.

    CASE im_num_sob .
      WHEN '1' .    ASSIGN my_esmena_s1 TO <my_cached> .
      WHEN '2' .    ASSIGN my_esmena_s2 TO <my_cached> .
      WHEN '3' .    ASSIGN my_esmena_s3 TO <my_cached> .
      WHEN OTHERS . RETURN .
    ENDCASE .

    IF <my_cached> IS BOUND .
      ex_data = <my_cached> .
      RETURN .
    ENDIF .

    CASE im_num_sob.
      WHEN '3'.

*      CREATE DATA <my_cached> TYPE ty_t_esmena_sx .
*      ASSIGN <my_cached>->* TO <lt_esmena_sx> .
*
*      SELECT z_num_ofer proveidor z_codi_esm_s3 FROM zrm_dt_ofertes INTO CORRESPONDING FIELDS OF TABLE <lt_esmena_sx>
*        WHERE docclass    = im_docclass AND
*              objectid    = im_objectid AND
*              z_esmena_s3 = 'X'.
*
*
*      LOOP AT <lt_esmena_sx> INTO ls_esmena_sx .
*
*        IF ls_esmena_sx-proveidor IS NOT INITIAL.
*          ls_esmena_sx-nom_proveidor = get_vendor_name( ls_esmena_sx-proveidor ) .
*        ENDIF.
*
*        SELECT SINGLE z_descripcio FROM zrm_dm_esm_s3t INTO ls_esmena_sx-z_motiu_esmena
*          WHERE spras = 'CA' AND
*                z_codi_esm_s3 = ls_esmena_sx-z_codi_esm_s3 .
*
*
*
*      ENDLOOP.

      WHEN OTHERS.

        CALL METHOD get_valcrit
          EXPORTING
            im_docclass = im_docclass
            im_objectid = im_objectid
          IMPORTING
            ex_valcrit  = lt_valcrit.


        CREATE DATA <my_cached> TYPE ty_t_esmena_sx .
        ASSIGN <my_cached>->* TO <lt_esmena_sx> .

* Quam volem el S2, hem d'ignorar les ofertes excloses per S1 o S3
        IF im_num_sob EQ '2' .
          DELETE lt_valcrit WHERE z_exclos_s3 EQ 'X' .
        ENDIF .

* Els Quadres de S1 no han de tenir en compte les ofertes variants perquè la
* revisió de S1 només es fa per a l'oferta base. A la ZRM_DT_VAL_CRIT hi trobarem
* registres, però son còpia exacta dels corresponents a l'oferta base.
        IF im_num_sob EQ '1' .
          DELETE lt_valcrit WHERE z_tipus_oferta EQ gc_oferta_variant .
        ENDIF .

        LOOP AT lt_valcrit ASSIGNING <ls_valcrit> WHERE ( z_exclos_s1s2 EQ 'X'
                                                          OR z_excl_pos_esm EQ 'X' ) .
          CASE im_num_sob .
            WHEN '1' . CHECK <ls_valcrit>-z_num_sob EQ im_num_sob .
            WHEN OTHERS .
          ENDCASE .
          DELETE lt_valcrit WHERE z_num_ofer EQ <ls_valcrit>-z_num_ofer .
        ENDLOOP .

        LOOP AT lt_valcrit ASSIGNING <ls_valcrit> WHERE z_esmenat  EQ space
                                                    AND z_correcte EQ space
                                                    AND z_num_sob  EQ im_num_sob .
          CALL METHOD fill_esmena
            EXPORTING
              im_valcrit = <ls_valcrit>
            CHANGING
              cs_esmena  = ls_esmena_sx.
**      >> INI MODIF ETODR SPEC-52867
          READ TABLE <lt_esmena_sx> ASSIGNING FIELD-SYMBOL(<fs_esmena_act>) WITH KEY z_num_ofer = ls_esmena_sx-z_num_ofer
                                                                                     proveidor  = ls_esmena_sx-proveidor.
          IF sy-subrc = 0.
            REPLACE ALL OCCURRENCES OF cl_abap_char_utilities=>cr_lf IN  ls_esmena_sx-z_motiu_esmena WITH space.
            CONCATENATE <fs_esmena_act>-z_motiu_esmena cl_abap_char_utilities=>cr_lf ls_esmena_sx-z_motiu_esmena INTO <fs_esmena_act>-z_motiu_esmena SEPARATED BY space.
          ELSE.
**      << FI MODIF ETODR SPEC-52867
            APPEND ls_esmena_sx TO <lt_esmena_sx> .
          ENDIF.
        ENDLOOP .
        SORT <lt_esmena_sx> BY nom_proveidor .

        ex_data = <my_cached>.

    ENDCASE.

  ENDMETHOD.


  METHOD get_esmex_sx.
    DATA: lt_valcrit   TYPE ty_t_valcrit,
          ls_esmena_sx TYPE LINE OF ty_t_esmena_sx.

    FIELD-SYMBOLS: <ls_valcrit>   TYPE ty_s_valcrit,
                   <lt_esmena_sx> TYPE ty_t_esmena_sx,
                   <my_cached>    TYPE REF TO data.

    CASE im_num_sob .
      WHEN '1' .    ASSIGN my_esmex_s1 TO <my_cached> .
      WHEN '2' .    ASSIGN my_esmex_s2 TO <my_cached> .
      WHEN OTHERS . RETURN .
    ENDCASE .

    IF <my_cached> IS BOUND .
      ex_data = <my_cached> .
      RETURN .
    ENDIF .

    CALL METHOD get_valcrit
      EXPORTING
        im_docclass = im_docclass
        im_objectid = im_objectid
      IMPORTING
        ex_valcrit  = lt_valcrit.


    CREATE DATA <my_cached> TYPE ty_t_esmena_sx .
    ASSIGN <my_cached>->* TO <lt_esmena_sx> .

* Quam volem el S2, hem d'ignorar les ofertes excloses per S1 o S3
    IF im_num_sob EQ '2' .
      DELETE lt_valcrit WHERE z_exclos_s3 EQ 'X' .
    ENDIF .

* Els Quadres de S1 no han de tenir en compte les ofertes variants perquè la
* revisió de S1 només es fa per a l'oferta base. A la ZRM_DT_VAL_CRIT hi trobarem
* registres, però son còpia exacta dels corresponents a l'oferta base.
    IF im_num_sob EQ '1' .
      DELETE lt_valcrit WHERE z_tipus_oferta EQ gc_oferta_variant .
    ENDIF .

    LOOP AT lt_valcrit ASSIGNING <ls_valcrit> WHERE z_num_sob  EQ im_num_sob
                                                AND (    z_exclos_s1s2  EQ 'X'
                                                      OR z_excl_pos_esm EQ 'X'
                                                      OR (     z_correcte   EQ space
                                                           AND z_esmenat    EQ space ) ).

      IF <ls_valcrit>-z_exclos_s1s2 EQ abap_true OR
         <ls_valcrit>-z_excl_pos_esm EQ abap_true.
        CALL METHOD fill_esmena
          EXPORTING
            im_valcrit = <ls_valcrit>
            i_exclusio = abap_true
          CHANGING
            cs_esmena  = ls_esmena_sx.

      ELSE.
        CALL METHOD fill_esmena
          EXPORTING
            im_valcrit = <ls_valcrit>
          CHANGING
            cs_esmena  = ls_esmena_sx.
      ENDIF.

      APPEND ls_esmena_sx TO <lt_esmena_sx> .
    ENDLOOP .
*Inici modif. PLANT-222 ACCENT(easas)  09.07.2010
*  SORT <lt_esmena_sx> BY nom_proveidor .
    SORT <lt_esmena_sx> BY nom_proveidor AS TEXT.
*Fi modif. PLANT-222 ACCENT(easas)  09.07.2010
    ex_data = <my_cached>.


  ENDMETHOD.


  METHOD get_exclos_post_ob.

    TYPES: BEGIN OF ty_s_data,
             exclos TYPE flag,
           END   OF ty_s_data.
    DATA: lt_ofertes TYPE ty_t_oferta,
          lv_exclos  TYPE bool.
    FIELD-SYMBOLS: <ls_data> TYPE ty_s_data .

    CREATE DATA ex_data TYPE ty_s_data .
    ASSIGN ex_data->* TO <ls_data> .

    CALL METHOD get_ofertes
      EXPORTING
        im_docclass = im_docclass
        im_objectid = im_objectid
      IMPORTING
        ex_ofertes  = lt_ofertes.

    lv_exclos = abap_false.

    LOOP AT lt_ofertes ASSIGNING FIELD-SYMBOL(<fs_ofer>)
      WHERE z_exclos_s3_postob EQ abap_true.
      lv_exclos = abap_true.
      EXIT.
    ENDLOOP.

    <ls_data>-exclos = lv_exclos.

  ENDMETHOD.


  METHOD get_exclos_post_ob_s3.

    TYPES: ty_s_data TYPE zerm_quadre_ent_ex_sobre3,
           ty_t_data TYPE STANDARD TABLE OF ty_s_data
                      WITH NON-UNIQUE DEFAULT KEY .
    DATA: lt_ofertes TYPE ty_t_oferta,
          ls_data    TYPE ty_s_data.

    FIELD-SYMBOLS: <lt_data>   TYPE ty_t_data,
                   <ls_oferta> TYPE ty_s_oferta.

    IF my_ent_ex_post_ob_sobre3 IS BOUND .
      ex_data = my_ent_ex_post_ob_sobre3 .
      RETURN .
    ENDIF .

    CREATE DATA my_ent_ex_post_ob_sobre3 TYPE ty_t_data .
    ex_data = my_ent_ex_post_ob_sobre3 .
    ASSIGN ex_data->* TO <lt_data> .

    CALL METHOD get_ofertes
      EXPORTING
        im_docclass = im_docclass
        im_objectid = im_objectid
      IMPORTING
        ex_ofertes  = lt_ofertes.

    LOOP AT lt_ofertes ASSIGNING FIELD-SYMBOL(<fs_ofer>) WHERE z_exclos_s3_postob EQ abap_true.
      CLEAR ls_data .
      ls_data-proveidor          = <fs_ofer>-proveidor .
      ls_data-nom_proveidor      = get_vendor_name( ls_data-proveidor ) .
      ls_data-z_tipus_oferta     = <fs_ofer>-z_tipus_oferta .

      SELECT SINGLE z_descripcio
        INTO ls_data-z_emp_motiu_esmena
        FROM zrm_dm_exlc_s3t
        WHERE z_codi_excl_s3 EQ <fs_ofer>-z_codi_excl_s3_postob
          AND spras          EQ 'c' .
      SHIFT ls_data-z_emp_motiu_esmena LEFT DELETING LEADING space .
      IF NOT ls_data-z_emp_motiu_esmena IS INITIAL .
        TRANSLATE ls_data-z_emp_motiu_esmena TO LOWER CASE . "#EC TRANSLANG
      ENDIF .

      CONDENSE ls_data-z_emp_motiu_esmena.
      APPEND ls_data TO <lt_data> .
    ENDLOOP.

  ENDMETHOD.


  METHOD get_exclos_sobre1.
*    DATA: ls_entitat TYPE ty_s_entitat,
*          ls_kna1    TYPE kna1.
*
*    DATA: lt_zrm_dt_ofertes TYPE TABLE OF zrm_dt_ofertes,
*          ls_zrm_dt_ofertes LIKE LINE  OF lt_zrm_dt_ofertes.
*
*    FIELD-SYMBOLS: <lt_entitat> TYPE ty_t_entitat,
*                   <my_cached>  TYPE REF TO data.
*
*
*
*    CASE im_num_sob.
*      WHEN '1'.
*        ASSIGN my_exclos_sobre1 TO <my_cached>.
*      WHEN OTHERS.
*        RETURN.
*    ENDCASE.
*
*    IF <my_cached> IS BOUND.
*      ex_data = <my_cached>.
*      RETURN.
*    ENDIF.
*
*    CREATE DATA <my_cached> TYPE ty_t_entitat.
*    ex_data = <my_cached>.
*    ASSIGN ex_data->* TO <lt_entitat>.
*
*    CLEAR lt_zrm_dt_ofertes.
*
*    SELECT *
*     FROM zrm_dt_ofertes
*       INTO CORRESPONDING FIELDS OF TABLE lt_zrm_dt_ofertes
*                             WHERE docclass = im_docclass
*                               AND objectid = im_objectid
*                            AND z_exclos_s1 = 'X'.
*
*    CLEAR ls_zrm_dt_ofertes.
*
*    LOOP AT lt_zrm_dt_ofertes INTO ls_zrm_dt_ofertes.
*      ls_entitat-proveidor =   ls_zrm_dt_ofertes-proveidor.
*
*      CLEAR ls_kna1.
*
*      SELECT SINGLE *
*       FROM kna1
*       INTO ls_kna1
*        WHERE kunnr = ls_zrm_dt_ofertes-proveidor.
*
*      IF sy-subrc = 0.
*        CLEAR ls_entitat-nom_proveidor.
*        CONCATENATE ls_kna1-name1 ls_kna1-name2 INTO ls_entitat-nom_proveidor SEPARATED BY space.
*        CONDENSE ls_entitat-nom_proveidor.
*        APPEND ls_entitat TO <lt_entitat> .
*        CLEAR ls_zrm_dt_ofertes.
*      ELSE.
*      ENDIF.
*    ENDLOOP.
*
*    SORT <lt_entitat> BY nom_proveidor .

    DATA: lt_valcrit TYPE ty_t_valcrit,
          ls_entitat TYPE ty_s_entitat.

    FIELD-SYMBOLS: <ls_valcrit> TYPE ty_s_valcrit,
                   <lt_entitat> TYPE ty_t_entitat,
                   <my_cached>  TYPE REF TO data.

    CASE im_num_sob .
      WHEN '1' .    ASSIGN my_exclos_sobre1 TO <my_cached> .
*    WHEN '2' .    ASSIGN my_ent_ex_sobre2 TO <my_cached> .
      WHEN OTHERS . RETURN .
    ENDCASE .

    IF <my_cached> IS BOUND .
      ex_data = <my_cached> .
      RETURN .
    ENDIF .

    CREATE DATA <my_cached> TYPE ty_t_entitat .
    ex_data = <my_cached> .
    ASSIGN ex_data->* TO <lt_entitat> .

    CALL METHOD get_valcrit
      EXPORTING
        im_docclass = im_docclass
        im_objectid = im_objectid
      IMPORTING
        ex_valcrit  = lt_valcrit.

* Els Quadres de S1 no han de tenir en compte les ofertes variants perquè la
* revisió de S1 només es fa per a l'oferta base. A la ZRM_DT_VAL_CRIT hi trobarem
* registres, però son còpia exacta dels corresponents a l'oferta base.
    IF im_num_sob EQ '1' .
      DELETE lt_valcrit WHERE z_tipus_oferta EQ gc_oferta_variant .
    ENDIF .

    LOOP AT lt_valcrit ASSIGNING <ls_valcrit> WHERE z_num_sob EQ im_num_sob
                                                AND (    z_exclos_s1s2  EQ 'X'
                                                      OR z_excl_pos_esm EQ 'X' ) .
      READ TABLE <lt_entitat> TRANSPORTING NO FIELDS
            WITH TABLE KEY proveidor =  <ls_valcrit>-proveidor .
      CHECK sy-subrc NE 0 .
      ls_entitat-proveidor     = <ls_valcrit>-proveidor .
      ls_entitat-nom_proveidor = get_vendor_name( ls_entitat-proveidor ) .
      ls_entitat-llista_nom_prov = ls_entitat-nom_proveidor.
*    CONCATENATE '-' ls_entitat-nom_proveidor INTO ls_entitat-llista_nom_prov SEPARATED BY space.
      APPEND ls_entitat TO <lt_entitat> .
    ENDLOOP .
    SORT <lt_entitat> BY nom_proveidor .

  ENDMETHOD.


  METHOD get_exclusiopostes_sx.

    DATA: lt_valcrit           TYPE ty_t_valcrit,
          ls_exclusiopostes_sx TYPE LINE OF ty_t_exclusiopostes_sx.

    FIELD-SYMBOLS: <ls_valcrit>           TYPE ty_s_valcrit,
                   <lt_exclusiopostes_sx> TYPE ty_t_exclusiopostes_sx,
                   <my_cached>            TYPE REF TO data.

    CASE im_num_sob .
      WHEN '1' .    ASSIGN my_exclusiopostes_s1 TO <my_cached> .
      WHEN '2' .    ASSIGN my_exclusiopostes_s2 TO <my_cached> .
      WHEN '3' .    ASSIGN my_exclusiopostes_s3 TO <my_cached> . " SPEC-58412
      WHEN OTHERS . RETURN .
    ENDCASE .

    IF <my_cached> IS BOUND .
      ex_data = <my_cached> .
      RETURN .
    ENDIF .

    CALL METHOD get_valcrit
      EXPORTING
        im_docclass = im_docclass
        im_objectid = im_objectid
      IMPORTING
        ex_valcrit  = lt_valcrit.


    CREATE DATA <my_cached> TYPE ty_t_exclusiopostes_sx .
    ASSIGN <my_cached>->* TO <lt_exclusiopostes_sx> .

* Els Quadres de S1 no han de tenir en compte les ofertes variants perquè la
* revisió de S1 només es fa per a l'oferta base. A la ZRM_DT_VAL_CRIT hi trobarem
* registres, però son còpia exacta dels corresponents a l'oferta base.
    IF im_num_sob EQ '1' .
      DELETE lt_valcrit WHERE z_tipus_oferta EQ gc_oferta_variant .
    ENDIF .

    LOOP AT lt_valcrit ASSIGNING <ls_valcrit> WHERE z_excl_pos_esm EQ 'X'
                                                AND z_num_sob      EQ im_num_sob .
      CALL METHOD fill_esmena
        EXPORTING
          im_valcrit = <ls_valcrit>
          i_exclusio = abap_true
        CHANGING
          cs_esmena  = ls_exclusiopostes_sx.
      APPEND ls_exclusiopostes_sx TO <lt_exclusiopostes_sx> .
    ENDLOOP .
    SORT <lt_exclusiopostes_sx> BY nom_proveidor .


    ex_data = <my_cached>.

  ENDMETHOD.


  METHOD get_exclusio_s12pt.

    TYPES:
        tt_string TYPE TABLE OF stringval.
    DATA:
      ls_exclcusio    TYPE REF TO data,
      lt_exclusio_aux TYPE ty_t_exclusio_sx,
      lt_exclusio_s1  TYPE ty_t_exclusio_sx,
      ls_exclusio_aux LIKE LINE OF lt_exclusio_aux,
      ls_exclusio_s1  LIKE LINE OF lt_exclusio_s1,
      ls_data         LIKE LINE OF ex_data,
      lt_ofertes      TYPE STANDARD TABLE OF zrm_dt_ofertes,
      wa_ofertes      TYPE zrm_dt_ofertes.

    FIELD-SYMBOLS: <ls_valcrit>     TYPE ty_s_valcrit,
                   <lt_exclusio_sx> TYPE ty_t_exclusio_sx,
                   <ls_excluiso_sx> TYPE LINE OF ty_t_exclusio_sx,
                   <my_cached>      TYPE REF TO data.

* Es seleccionen les ofertes
    SELECT * INTO TABLE lt_ofertes
      FROM zrm_dt_ofertes
      WHERE docclass       EQ im_docclass AND
            objectid       EQ im_objectid.

    ASSIGN ls_exclcusio  TO <my_cached>.
    IF <my_cached> IS BOUND.
      FREE <my_cached>.
    ENDIF.

    CREATE DATA <my_cached> TYPE ty_t_exclusio_sx .


    CALL METHOD get_exclusio_sx
      EXPORTING
        im_docclass = im_docclass
        im_objectid = im_objectid
        im_num_sob  = '1'
        im_carta    = 'X'
      RECEIVING
        ex_data     = <my_cached>
      EXCEPTIONS
        not_found   = 1.

    ASSIGN <my_cached>->* TO <lt_exclusio_sx> .
    LOOP AT <lt_exclusio_sx> ASSIGNING <ls_excluiso_sx>.
      APPEND <ls_excluiso_sx> TO lt_exclusio_s1.
    ENDLOOP.


    CALL METHOD get_exclusio_sx
      EXPORTING
        im_docclass = im_docclass
        im_objectid = im_objectid
        im_num_sob  = '2'
        im_carta    = 'X'
      RECEIVING
        ex_data     = <my_cached>
      EXCEPTIONS
        not_found   = 1
        OTHERS      = 2.

    ASSIGN <my_cached>->* TO <lt_exclusio_sx> .
    LOOP AT <lt_exclusio_sx> ASSIGNING <ls_excluiso_sx>.
      APPEND <ls_excluiso_sx> TO lt_exclusio_s1.
    ENDLOOP.

    ">>>  SPEC-57810 Inici Modificació ETXGL
    CALL METHOD get_exclusio_sx
      EXPORTING
        im_docclass = im_docclass
        im_objectid = im_objectid
        im_num_sob  = '3'
        im_carta    = 'X'
      RECEIVING
        ex_data     = <my_cached>
      EXCEPTIONS
        not_found   = 1
        OTHERS      = 2.

    ASSIGN <my_cached>->* TO <lt_exclusio_sx> .
    LOOP AT <lt_exclusio_sx> ASSIGNING <ls_excluiso_sx>.
      APPEND <ls_excluiso_sx> TO lt_exclusio_s1.
    ENDLOOP.
    "<<<  SPEC-57810 Final Modificació ETXGL


    lt_exclusio_aux[] = lt_exclusio_s1[].
    DELETE ADJACENT DUPLICATES FROM lt_exclusio_aux COMPARING nom_proveidor.

    LOOP AT lt_exclusio_aux INTO ls_exclusio_aux.
      ls_data-text = ls_exclusio_aux-nom_proveidor.
      ls_data-guion = '-'.
      APPEND ls_data TO ex_data.
      LOOP AT lt_exclusio_s1 INTO ls_exclusio_s1 WHERE nom_proveidor EQ ls_exclusio_aux-nom_proveidor.
        CLEAR ls_data.
        ls_data-guion = '.'.
        ls_data-text = ls_exclusio_s1-z_motiu_esmena.
        APPEND ls_data TO ex_data.
      ENDLOOP.

      LOOP AT lt_ofertes INTO wa_ofertes
        WHERE proveidor       EQ ls_exclusio_aux-proveidor
          AND z_excl_punt_tec EQ abap_true.
        ls_data-guion = '.'.
        ls_data-text = 'Per no assolir la qualitat tècnica mínima requerida segons el Plec de Bases.'.
        DELETE lt_ofertes INDEX sy-tabix.
        APPEND ls_data TO ex_data.
      ENDLOOP.

    ENDLOOP.

    LOOP AT lt_ofertes INTO wa_ofertes
      WHERE z_excl_punt_tec EQ abap_true.
      ls_data-text = get_vendor_name( wa_ofertes-proveidor ).
      ls_data-guion = '-'.
      APPEND ls_data TO ex_data.
      ls_data-guion = '.'.
      ls_data-text = 'Per no assolir la qualitat tècnica mínima requerida segons el Plec de Bases.'.
      DELETE lt_ofertes INDEX sy-tabix.
      APPEND ls_data TO ex_data.
    ENDLOOP.


  ENDMETHOD.


  METHOD get_exclusio_sx.
    DATA: lt_valcrit         TYPE ty_t_valcrit,
          ls_valcrit         TYPE ty_s_valcrit,
          ls_exclusio_sx     TYPE LINE OF ty_t_exclusio_sx,
          lt_zrm_dt_ofertes  TYPE TABLE OF zrm_dt_ofertes,
          ls_zrm_dt_ofertes  TYPE zrm_dt_ofertes,
          ls_zrm_dm_exlc_s3t TYPE zrm_dm_exlc_s3t,
          ">>>  SPEC-57810 Inici Modificació ETXGL
          lv_z_exclos_clau   TYPE zrm_dt_ofertes-z_exclos_clau,
          lt_valcrit_aux     TYPE ty_t_valcrit,
          ls_valcrit_aux     TYPE ty_s_valcrit,
          lv_majuscula       TYPE string,
          lv_text            TYPE char255,
          lv_exist           TYPE c.
    "<<<  SPEC-57810 Final Modificació ETXGL

    FIELD-SYMBOLS: <ls_valcrit>     TYPE ty_s_valcrit,
                   <lt_exclusio_sx> TYPE ty_t_exclusio_sx,
                   <my_cached>      TYPE REF TO data.

    CASE im_num_sob.
      WHEN '1' .
        ASSIGN my_exclusio_s1 TO <my_cached>.

      WHEN '2' .
        ASSIGN my_exclusio_s2 TO <my_cached>.

        ">>>  SPEC-57810 Inici Modificació ETXGL
      WHEN '3' .
        ASSIGN my_exclusio_s3 TO <my_cached>.
        "<<<  SPEC-57810 Final Modificació ETXGL

      WHEN OTHERS.
        RETURN.
    ENDCASE.

    IF <my_cached> IS BOUND .
      ex_data = <my_cached> .
      RETURN .
    ENDIF .

    CALL METHOD get_valcrit
      EXPORTING
        im_docclass = im_docclass
        im_objectid = im_objectid
      IMPORTING
        ex_valcrit  = lt_valcrit.


    CREATE DATA <my_cached> TYPE ty_t_exclusio_sx.
    ASSIGN <my_cached>->* TO <lt_exclusio_sx>.

* Tractament Sobre 1 (DG)
* Els Quadres de S1 no han de tenir en compte les ofertes variants perquè la
* revisió de S1 només es fa per a l'oferta base. A la ZRM_DT_VAL_CRIT hi trobarem
* registres, però son còpia exacta dels corresponents a l'oferta base.
    IF im_num_sob EQ '1' .
      DELETE lt_valcrit WHERE z_tipus_oferta EQ gc_oferta_variant.
    ENDIF .

    LOOP AT lt_valcrit ASSIGNING <ls_valcrit> WHERE z_num_sob EQ im_num_sob
                                                AND (    z_exclos_s1s2  EQ 'X'
                                                      OR z_excl_pos_esm EQ 'X'  ).
      CALL METHOD fill_esmena
        EXPORTING
          im_valcrit = <ls_valcrit>
          i_exclusio = abap_true
        CHANGING
          cs_esmena  = ls_exclusio_sx.

      IF im_carta IS NOT INITIAL.
        CONCATENATE text-009 ls_exclusio_sx-z_motiu_esmena
                  INTO ls_exclusio_sx-z_motiu_esmena SEPARATED BY space.
      ENDIF.
**      >> INI MODIF ETODR SPEC-52867
      READ TABLE <lt_exclusio_sx> ASSIGNING FIELD-SYMBOL(<fs_exclusio_act>)
                            WITH KEY z_num_ofer = ls_exclusio_sx-z_num_ofer
                                     proveidor  = ls_exclusio_sx-proveidor.
      IF sy-subrc = 0.
        REPLACE ALL OCCURRENCES OF cl_abap_char_utilities=>cr_lf
                   IN  ls_exclusio_sx-z_motiu_esmena WITH space.

        CONCATENATE <fs_exclusio_act>-z_motiu_esmena
                    cl_abap_char_utilities=>cr_lf ls_exclusio_sx-z_motiu_esmena
                       INTO <fs_exclusio_act>-z_motiu_esmena SEPARATED BY space.
      ELSE.
**      << FI MODIF ETODR SPEC-52867
        APPEND ls_exclusio_sx TO <lt_exclusio_sx> .
      ENDIF.
    ENDLOOP.

    ">>>  SPEC-57810 Inici Modificació ETXGL
    IF im_num_sob = '1'.
      CLEAR: lt_zrm_dt_ofertes.
      SELECT *
        FROM zrm_dt_ofertes
        INTO TABLE lt_zrm_dt_ofertes
         WHERE objectid = im_objectid
           AND docclass = im_docclass
           AND z_exclos_s1 = abap_true
           AND z_exclos_clau = abap_true.

      LOOP AT lt_zrm_dt_ofertes INTO ls_zrm_dt_ofertes.
        IF ls_zrm_dt_ofertes IS NOT INITIAL.
          CLEAR ls_exclusio_sx.
          READ TABLE <lt_exclusio_sx> INTO ls_exclusio_sx
                                 WITH KEY proveidor = ls_zrm_dt_ofertes-proveidor
                                         z_num_ofer = ls_zrm_dt_ofertes-z_num_ofer.

          IF ls_exclusio_sx IS NOT INITIAL.
*          DELETE <lt_exclusio_sx> FROM ls_exclusio_sx.
            ">>>SPEC:61488, Inici modificació  - ECFA
            DELETE <lt_exclusio_sx> WHERE proveidor  EQ ls_exclusio_sx-proveidor
                                    AND   z_num_ofer EQ ls_exclusio_sx-z_num_ofer.
            "<<<SPEC:61488, Final modificació - ECFA
          ENDIF.
          ls_exclusio_sx-proveidor = ls_zrm_dt_ofertes-proveidor .
          ls_exclusio_sx-nom_proveidor = get_vendor_name( ls_zrm_dt_ofertes-proveidor ).
          ls_exclusio_sx-z_num_ofer = ls_zrm_dt_ofertes-z_num_ofer.
          ls_exclusio_sx-z_motiu_esmena = text-013.
          APPEND ls_exclusio_sx TO <lt_exclusio_sx> .

        ENDIF.
      ENDLOOP.
    ENDIF.
    "<<<  SPEC-57810 Final Modificació ETXGL


* Tractament Sobre 2 (DT)
    IF im_num_sob = '2'
     AND im_carta IS NOT INITIAL.
      CLEAR lt_zrm_dt_ofertes.
      SELECT *
       FROM zrm_dt_ofertes
        INTO TABLE lt_zrm_dt_ofertes
          WHERE docclass = im_docclass AND
                objectid = im_objectid AND
                ( z_tipus_exc_s2 = 'GE'
              OR  z_tipus_exc_s2 = 'CA'         "SPEC-52625
              OR  z_tipus_exc_s2 = 'S3'         "SPEC-65648 ETODR
              OR  z_tipus_exc_s2 = 'DT'  ).     "SPEC-57810

      LOOP AT lt_zrm_dt_ofertes INTO ls_zrm_dt_ofertes.
        ls_exclusio_sx-proveidor = ls_zrm_dt_ofertes-proveidor.
        ls_exclusio_sx-nom_proveidor = get_vendor_name( ls_zrm_dt_ofertes-proveidor ).
        ls_exclusio_sx-z_num_ofer = ls_zrm_dt_ofertes-z_num_ofer.

        ">>>  SPEC-57810 Inici Modificació ETXGL
***     >> INI MODIF ETODR SPEC-52625
*      IF ls_zrm_dt_ofertes-z_tipus_exc_s2 = 'CA'.
*        CONCATENATE text-010 text-011 INTO ls_exclusio_sx-z_motiu_esmena
*                                                     SEPARATED BY space.
*        APPEND ls_exclusio_sx TO <lt_exclusio_sx> .
*      ELSEIF ls_zrm_dt_ofertes-z_tipus_exc_s2 = 'GE'.
***     << FI MODIF ETODR SPEC-52625
*        CONCATENATE text-007 text-008 INTO ls_exclusio_sx-z_motiu_esmena
*                                                     SEPARATED BY space.
*        APPEND ls_exclusio_sx TO <lt_exclusio_sx>.
*      ENDIF.

        IF ls_zrm_dt_ofertes-z_exclos_carrecs IS NOT INITIAL.
          ls_exclusio_sx-z_motiu_esmena = text-012.
          APPEND ls_exclusio_sx TO <lt_exclusio_sx> .
*>>>SPEC:65648, Inici modificació  - ECACM
        ELSEIF ls_zrm_dt_ofertes-z_exclos_cont_s3_a_s2 = 'X'.
          ls_exclusio_sx-z_motiu_esmena = text-014.
          APPEND ls_exclusio_sx TO <lt_exclusio_sx> .
        ELSE.
*>>>SPEC:65648, Final modificació  - ECACM
          IF ls_zrm_dt_ofertes-z_tipus_exc_s2 = 'CA'.
            CONCATENATE text-010 text-011 INTO ls_exclusio_sx-z_motiu_esmena
                                                         SEPARATED BY space.
            APPEND ls_exclusio_sx TO <lt_exclusio_sx> .
          ELSEIF ls_zrm_dt_ofertes-z_tipus_exc_s2 = 'GE'.
            CONCATENATE text-007 text-008 INTO ls_exclusio_sx-z_motiu_esmena
                                                         SEPARATED BY space.
            APPEND ls_exclusio_sx TO <lt_exclusio_sx>.
          ELSEIF ls_zrm_dt_ofertes-z_tipus_exc_s2 = 'DT'.
            SELECT SINGLE z_com_excl_s1s2
              FROM zrm_dt_val_crit
               INTO ls_exclusio_sx-z_motiu_esmena
                  WHERE objectid = ls_zrm_dt_ofertes-objectid
                    AND docclass = ls_zrm_dt_ofertes-docclass
                    AND z_num_ofer = ls_zrm_dt_ofertes-z_num_ofer
                    AND z_exclos_s1s2 = abap_true.
            APPEND ls_exclusio_sx TO <lt_exclusio_sx>.
          ENDIF.
        ENDIF.
      ENDLOOP.
    ENDIF.
    "<<<  SPEC-57810 Final Modificació ETXGL


* Tractament Sobre 3 (PE)
    ">>>  SPEC-57810 Inici Modificació ETXGL
    IF im_num_sob = '3'.
      CLEAR lt_zrm_dt_ofertes.
      SELECT z_num_ofer proveidor z_codi_excl_s3
       FROM zrm_dt_ofertes
        INTO CORRESPONDING FIELDS OF TABLE lt_zrm_dt_ofertes
          WHERE docclass = im_docclass AND
                objectid = im_objectid AND
             z_exclos_s3 = 'X'.

      CLEAR ls_zrm_dt_ofertes.
      LOOP AT lt_zrm_dt_ofertes INTO ls_zrm_dt_ofertes.
        IF ls_zrm_dt_ofertes-proveidor IS NOT INITIAL.
          CLEAR ls_exclusio_sx.
          ls_exclusio_sx-proveidor = ls_zrm_dt_ofertes-proveidor.
          ls_exclusio_sx-nom_proveidor = get_vendor_name( ls_zrm_dt_ofertes-proveidor ).
          ls_exclusio_sx-z_num_ofer = ls_zrm_dt_ofertes-z_num_ofer.

          IF ls_zrm_dt_ofertes-z_codi_excl_s3 IS NOT INITIAL.
            SELECT SINGLE z_descripcio
             FROM zrm_dm_exlc_s3t
              INTO ls_zrm_dm_exlc_s3t-z_descripcio
                   WHERE spras = 'c'
                     AND z_codi_excl_s3 = ls_zrm_dt_ofertes-z_codi_excl_s3.

            IF ls_zrm_dm_exlc_s3t-z_descripcio IS NOT INITIAL.
              ls_exclusio_sx-z_motiu_esmena = ls_zrm_dm_exlc_s3t-z_descripcio.
              IF ls_exclusio_sx-z_motiu_esmena IS NOT INITIAL.
                CLEAR lv_majuscula.
                lv_majuscula = ls_exclusio_sx-z_motiu_esmena(1).
                TRANSLATE lv_majuscula TO UPPER CASE.
                CLEAR lv_text.
                MOVE ls_exclusio_sx-z_motiu_esmena TO lv_text.
                lv_text = lv_text+1.
                CONCATENATE lv_majuscula lv_text '.'
                            INTO ls_exclusio_sx-z_motiu_esmena.
              ENDIF.
            ENDIF.
          ENDIF.
          APPEND ls_exclusio_sx TO <lt_exclusio_sx>.
        ENDIF.
        CLEAR ls_zrm_dt_ofertes.
      ENDLOOP.
    ENDIF.
    "<<<  SPEC-57810 Final Modificació ETXGL

    SORT  <lt_exclusio_sx> BY nom_proveidor.
    ex_data = <my_cached>.

  ENDMETHOD.


  METHOD get_excl_post_ob_s2.

    TYPES: ty_s_data TYPE zerm_quadre_ent_ex_po_sobre2,
           ty_t_data TYPE STANDARD TABLE OF ty_s_data
                      WITH NON-UNIQUE DEFAULT KEY .
    DATA: lt_ofertes TYPE ty_t_oferta,
          ls_data    TYPE ty_s_data,
          lt_text    TYPE ism_tline_tab,
          lv_text    TYPE thead-tdname.

    FIELD-SYMBOLS: <lt_data>   TYPE ty_t_data,
                   <ls_oferta> TYPE ty_s_oferta.

    IF my_ent_ex_post_ob_sobre2 IS BOUND .
      ex_data = my_ent_ex_post_ob_sobre2 .
      RETURN .
    ENDIF .

    CREATE DATA my_ent_ex_post_ob_sobre2 TYPE ty_t_data .
    ex_data = my_ent_ex_post_ob_sobre2 .
    ASSIGN ex_data->* TO <lt_data> .

    CALL METHOD get_ofertes
      EXPORTING
        im_docclass = im_docclass
        im_objectid = im_objectid
      IMPORTING
        ex_ofertes  = lt_ofertes.

    LOOP AT lt_ofertes ASSIGNING FIELD-SYMBOL(<fs_ofer>) WHERE z_exclos_po_pt EQ abap_true.
      CLEAR ls_data .
      ls_data-proveidor          = <fs_ofer>-proveidor .
      ls_data-nom_proveidor      = get_vendor_name( ls_data-proveidor ) .
      ls_data-z_tipus_oferta     = <fs_ofer>-z_tipus_oferta .

      CLEAR: lv_text.
      CONCATENATE  <fs_ofer>-objectid <fs_ofer>-z_num_ofer 'S2_EXCL_PO_PT' INTO lv_text.

      CLEAR lt_text[].
      CALL FUNCTION 'READ_TEXT'
        EXPORTING
          client                  = sy-mandt
          id                      = zrm_cl_sapscript_texts=>co_id_descripcio
          language                = sy-langu
          name                    = lv_text
          object                  = zrm_cl_sapscript_texts=>co_object
        TABLES
          lines                   = lt_text
        EXCEPTIONS
          id                      = 1
          language                = 2
          name                    = 3
          not_found               = 4
          object                  = 5
          reference_check         = 6
          wrong_access_to_archive = 7
          OTHERS                  = 8.
      CLEAR ls_data-z_motiu_esmena.
      LOOP AT lt_text ASSIGNING FIELD-SYMBOL(<fs_t>).
        CONCATENATE ls_data-z_motiu_esmena <fs_t>-tdline INTO ls_data-z_motiu_esmena SEPARATED BY space.
      ENDLOOP.

*      SELECT SINGLE z_descripcio
*        INTO ls_data-z_motiu_esmena
*        FROM zrm_dm_com_ex_s2
*        WHERE z_codi_excl_s2 EQ <fs_ofer>-z_com_excl_po_pt.
*
*      SHIFT ls_data-z_motiu_esmena LEFT DELETING LEADING space .
*      IF NOT ls_data-z_motiu_esmena IS INITIAL .
*        TRANSLATE ls_data-z_motiu_esmena TO LOWER CASE . "#EC TRANSLANG
*      ENDIF .
*
*      CONDENSE ls_data-z_motiu_esmena.
      APPEND ls_data TO <lt_data> .
    ENDLOOP.

  ENDMETHOD.


  METHOD get_hora_pres_ofer_mes_1.
    FIELD-SYMBOLS: <fs_data>    TYPE zrm_dt_exp_cont-z_hora_pres_ofer.
    DATA: lv_string TYPE string.

    DATA: lv_tstamp     TYPE timestamp,
          lv_new_tstamp TYPE timestamp,
          lv_new_date   TYPE datum,
          lv_new_uzeit  TYPE uzeit,
          lv_timezone   TYPE ttzz-tzone.

    IF my_hora_pres_ofer_add1 IS BOUND .
      ro_data = my_hora_pres_ofer_add1 .
      RETURN .
    ENDIF .

    CREATE DATA my_hora_pres_ofer_add1 TYPE zrm_dt_exp_cont-z_hora_pres_ofer .
    ro_data = my_hora_pres_ofer_add1 .
    ASSIGN ro_data->* TO <fs_data> .

    SELECT SINGLE z_data_pres_ofer,z_hora_pres_ofer
      FROM zrm_dt_exp_cont
      INTO (@DATA(lv_data_pres_ofer),@DATA(lv_hora_pres_ofer))
      WHERE docclass = @iv_docclass
        AND objectid = @iv_objectid.
    IF sy-subrc = 0 AND lv_hora_pres_ofer IS NOT INITIAL.
      lv_timezone = sy-zonlo.

      CONVERT DATE lv_data_pres_ofer TIME lv_hora_pres_ofer
       INTO TIME STAMP lv_tstamp
       TIME ZONE lv_timezone.

      lv_new_tstamp = cl_abap_tstmp=>add( tstmp = lv_tstamp
                                          secs  = 1 ).
      CONVERT TIME STAMP lv_new_tstamp
       TIME ZONE lv_timezone
       INTO DATE lv_new_date
            TIME lv_new_uzeit.
    ENDIF.
    <fs_data> = lv_new_uzeit.
  ENDMETHOD.


  METHOD get_ict_ent_ex_post_ob.

    TYPES: ty_t_data TYPE TABLE OF zerm_ict_ent_post_ob.

    DATA: lt_ofertes TYPE ty_t_oferta,
          lv_exclos  TYPE bool,
          lt_data    TYPE ty_t_data,
          ls_data    TYPE zerm_ict_ent_post_ob.

    FIELD-SYMBOLS: <lt_data> TYPE ty_t_data .

    IF my_ict_ent_ex_post_ob IS BOUND.
      ex_data = my_ict_ent_ex_post_ob.
      RETURN.
    ENDIF.
    CREATE DATA my_ict_ent_ex_post_ob TYPE ty_t_data.
    ex_data = my_ict_ent_ex_post_ob.

    ASSIGN ex_data->* TO <lt_data> .

    CALL METHOD get_ofertes
      EXPORTING
        im_docclass = im_docclass
        im_objectid = im_objectid
      IMPORTING
        ex_ofertes  = lt_ofertes.

    CLEAR lt_data.

    LOOP AT lt_ofertes ASSIGNING FIELD-SYMBOL(<fs_ofer>)
      WHERE z_exclos_s3_postob EQ abap_true.
      ls_data-nom_proveidor = <fs_ofer>-nom_proveidor.
      APPEND ls_data TO <lt_data>.
    ENDLOOP.

*    <lt_data> = lt_data.
  ENDMETHOD.


  METHOD get_ict_ent_ex_sobre2.
    TYPES: ty_s_data TYPE zerm_ict_ent_ex_sobre2,
           ty_t_data TYPE STANDARD TABLE OF ty_s_data
                      WITH NON-UNIQUE DEFAULT KEY .
    DATA: lt_valcrit  TYPE ty_t_valcrit,
          lt_ofertes  TYPE ty_t_oferta,
          ls_data     TYPE ty_s_data,
          lv_proc_adj TYPE zrm_dt_exp_cont-z_proc_adj.

    FIELD-SYMBOLS: <ls_valcrit> TYPE ty_s_valcrit,
                   <lt_data>    TYPE ty_t_data,
                   <ls_oferta>  TYPE ty_s_oferta.

    IF my_ict_ent_ex_sobre2 IS BOUND .
      ex_data = my_ict_ent_ex_sobre2 .
      RETURN .
    ENDIF .

    CREATE DATA my_ict_ent_ex_sobre2 TYPE ty_t_data .
    ex_data = my_ict_ent_ex_sobre2 .
    ASSIGN ex_data->* TO <lt_data> .


* Es selecciona el tipus de procediment d'adjudicació
    SELECT SINGLE z_proc_adj
      INTO lv_proc_adj
      FROM zrm_dt_exp_cont
      WHERE docclass       EQ im_docclass AND
            objectid       EQ im_objectid.

    CALL METHOD get_valcrit
      EXPORTING
        im_docclass = im_docclass
        im_objectid = im_objectid
      IMPORTING
        ex_valcrit  = lt_valcrit.

    CALL METHOD get_ofertes
      EXPORTING
        im_docclass = im_docclass
        im_objectid = im_objectid
      IMPORTING
        ex_ofertes  = lt_ofertes.

    SORT lt_valcrit BY proveidor z_num_ofer.

* En cas que sigui un restringit, només es seleccionaran les ofertes que presenten proposta
    IF lv_proc_adj = 'CR'.
      DELETE lt_valcrit WHERE z_pres_proposta EQ space.
    ENDIF.

    DELETE lt_valcrit WHERE z_exclos_s2 EQ space .
    LOOP AT lt_valcrit ASSIGNING <ls_valcrit> .
      AT END OF z_num_ofer . "proveidor .
        CLEAR ls_data .
        ls_data-proveidor          = <ls_valcrit>-proveidor .
        ls_data-nom_proveidor      = get_vendor_name( ls_data-proveidor ) .
        ls_data-z_tipus_oferta     = <ls_valcrit>-z_tipus_oferta .

        READ TABLE lt_ofertes ASSIGNING <ls_oferta> WITH KEY z_num_ofer = <ls_valcrit>-z_num_ofer.
        ls_data-z_motiu_excl = <ls_oferta>-z_motiu_excl_s2c.
        SHIFT ls_data-z_motiu_excl LEFT DELETING LEADING space .
        IF NOT ls_data-z_motiu_excl IS INITIAL .
          TRANSLATE ls_data-z_motiu_excl TO LOWER CASE . "#EC TRANSLANG
        ENDIF .

        IF ls_data-z_tipus_oferta = gc_oferta_base.
          ls_data-z_motiu_excl = ls_data-nom_proveidor .
        ELSEIF ls_data-z_tipus_oferta = gc_oferta_variant.

          READ TABLE lt_ofertes ASSIGNING <ls_oferta> WITH KEY z_num_ofer = <ls_valcrit>-z_num_ofer.
          SHIFT <ls_oferta>-z_num_variant LEFT DELETING LEADING '0' .
          CONDENSE <ls_oferta>-z_num_variant.
          CONCATENATE ls_data-nom_proveidor ' (variant número '
                      <ls_oferta>-z_num_variant
                      INTO ls_data-z_motiu_excl RESPECTING BLANKS.
          CONDENSE ls_data-z_motiu_excl.
          CONCATENATE ls_data-z_motiu_excl ')' INTO ls_data-z_motiu_excl.
        ENDIF.
        CONDENSE ls_data-z_motiu_excl.
        CONCATENATE '-' ls_data-z_motiu_excl INTO ls_data-z_llista_motiu_excl SEPARATED BY space.
        APPEND ls_data TO <lt_data> .
      ENDAT .
    ENDLOOP .

  ENDMETHOD.


  METHOD get_ict_ent_ex_sobre3.
    TYPES: ty_s_data TYPE zerm_ict_ent_ex_sobre3,
           ty_t_data TYPE STANDARD TABLE OF ty_s_data
                      WITH NON-UNIQUE DEFAULT KEY .
    DATA: lt_valcrit TYPE ty_t_valcrit,
          lt_ofertes TYPE ty_t_oferta,
          ls_data    TYPE ty_s_data.

    FIELD-SYMBOLS: <ls_valcrit> TYPE ty_s_valcrit,
                   <lt_data>    TYPE ty_t_data,
                   <ls_oferta>  TYPE ty_s_oferta.

    IF my_ict_ent_ex_sobre3 IS BOUND .
      ex_data = my_ict_ent_ex_sobre3 .
      RETURN .
    ENDIF .

    CREATE DATA my_ict_ent_ex_sobre3 TYPE ty_t_data .
    ex_data = my_ict_ent_ex_sobre3 .
    ASSIGN ex_data->* TO <lt_data> .

    CALL METHOD get_valcrit
      EXPORTING
        im_docclass = im_docclass
        im_objectid = im_objectid
      IMPORTING
        ex_valcrit  = lt_valcrit.

    CALL METHOD get_ofertes
      EXPORTING
        im_docclass = im_docclass
        im_objectid = im_objectid
      IMPORTING
        ex_ofertes  = lt_ofertes.

    SORT lt_valcrit BY proveidor z_num_ofer.
    DELETE lt_valcrit WHERE z_exclos_s3 EQ space .
    LOOP AT lt_valcrit ASSIGNING <ls_valcrit> .
      AT END OF z_num_ofer . "proveidor .
        CLEAR ls_data .
        ls_data-proveidor          = <ls_valcrit>-proveidor .
        ls_data-nom_proveidor      = get_vendor_name( ls_data-proveidor ) .
        ls_data-z_tipus_oferta     = <ls_valcrit>-z_tipus_oferta .

        SELECT SINGLE z_descripcio INTO ls_data-z_motiu_excl
                 FROM zrm_dm_exlc_s3t
                WHERE      z_codi_excl_s3 EQ <ls_valcrit>-z_codi_excl_s3
                       AND spras          EQ 'c' .
        SHIFT ls_data-z_motiu_excl LEFT DELETING LEADING space .
        IF NOT ls_data-z_motiu_excl IS INITIAL .
          TRANSLATE ls_data-z_motiu_excl TO LOWER CASE . "#EC TRANSLANG
        ENDIF .

        IF ls_data-z_tipus_oferta = gc_oferta_base.
          CONCATENATE ls_data-nom_proveidor ', atès que ' ls_data-z_motiu_excl '.'
                 INTO ls_data-z_motiu_excl RESPECTING BLANKS.
        ELSEIF ls_data-z_tipus_oferta = gc_oferta_variant.

          READ TABLE lt_ofertes ASSIGNING <ls_oferta> WITH KEY z_num_ofer = <ls_valcrit>-z_num_ofer.
          SHIFT <ls_oferta>-z_num_variant LEFT DELETING LEADING '0' .
          CONDENSE <ls_oferta>-z_num_variant.
          CONCATENATE ls_data-nom_proveidor ', atès que ' ls_data-z_motiu_excl ' (variant número '
                      <ls_oferta>-z_num_variant
                      INTO ls_data-z_motiu_excl RESPECTING BLANKS.
          CONDENSE ls_data-z_motiu_excl.
          CONCATENATE ls_data-z_motiu_excl ').' INTO ls_data-z_motiu_excl.
        ENDIF.
        CONDENSE ls_data-z_motiu_excl.
        CONCATENATE '-' ls_data-z_motiu_excl INTO ls_data-z_llista_motiu_excl SEPARATED BY space.
        APPEND ls_data TO <lt_data> .
      ENDAT .
    ENDLOOP .

  ENDMETHOD.


  METHOD get_import_tipol_fix.
    FIELD-SYMBOLS: <ls_data> TYPE zrm_dt_tip_eco-pressupost .


    DATA: lt_tip_eco    TYPE TABLE OF zrm_dt_tip_eco,
          lv_import_fix TYPE zrm_dt_tip_eco-pressupost.

    CREATE DATA ex_data TYPE zrm_dt_tip_eco-pressupost .
    ASSIGN ex_data->* TO <ls_data> .

    SELECT *
      INTO TABLE lt_tip_eco
      FROM zrm_dt_tip_eco
      WHERE docclass = im_docclass
       AND  objectid = im_objectid
       AND ( tipus_ofer = 3 OR tipus_ofer = 4 ).

    CHECK lt_tip_eco IS NOT INITIAL.
    CLEAR: lv_import_fix.

    LOOP AT lt_tip_eco ASSIGNING FIELD-SYMBOL(<fs_tipologia_econ>).
      ADD <fs_tipologia_econ>-pressupost TO lv_import_fix.
    ENDLOOP.

    <ls_data> = lv_import_fix.

  ENDMETHOD.


  METHOD get_import_tipol_variable.

    FIELD-SYMBOLS: <ls_data> TYPE zrm_dt_tip_eco-pressupost .


    DATA: lt_tip_eco         TYPE TABLE OF zrm_dt_tip_eco,
          lv_import_variable TYPE zrm_dt_tip_eco-pressupost.

    CREATE DATA ex_data TYPE zrm_dt_tip_eco-pressupost .
    ASSIGN ex_data->* TO <ls_data> .

    SELECT *
      INTO TABLE lt_tip_eco
      FROM zrm_dt_tip_eco
      WHERE docclass = im_docclass
       AND  objectid = im_objectid
       AND ( tipus_ofer <> 3 AND tipus_ofer <> 4 ).

    CHECK lt_tip_eco IS NOT INITIAL.
    CLEAR: lv_import_variable.

    LOOP AT lt_tip_eco ASSIGNING FIELD-SYMBOL(<fs_tipologia_econ>).
      ADD <fs_tipologia_econ>-pressupost TO lv_import_variable.
    ENDLOOP.

    <ls_data> = lv_import_variable.

  ENDMETHOD.


  METHOD get_imp_tip_fix_oferta.
    TYPES: BEGIN OF ty_s_data,
             import_fix TYPE char20,
           END   OF ty_s_data.
    FIELD-SYMBOLS: <ls_data> TYPE ty_s_data .

    DATA: lt_tip_ofer   TYPE TABLE OF zrm_dt_ofer_tip,
          lv_import_fix TYPE zrm_dt_ofer_tip-import.

    CREATE DATA ex_data TYPE ty_s_data .
    ASSIGN ex_data->* TO <ls_data> .

    SELECT *
      INTO TABLE lt_tip_ofer
      FROM zrm_dt_ofer_tip
      WHERE docclass  = im_docclass
       AND  objectid  = im_objectid
       AND ( tipus_ofer = 3 OR tipus_ofer = 4 )
       AND num_ofer = im_num_ofer.

    CHECK lt_tip_ofer IS NOT INITIAL.
    CLEAR: lv_import_fix.

    LOOP AT lt_tip_ofer ASSIGNING FIELD-SYMBOL(<fs_tipologia_econ_ofer>).
      ADD <fs_tipologia_econ_ofer>-import TO lv_import_fix.
    ENDLOOP.

    <ls_data>-import_fix = lv_import_fix.
    SHIFT <ls_data>-import_fix LEFT DELETING LEADING space.
  ENDMETHOD.


  METHOD get_imp_tip_variable_oferta.
    TYPES: BEGIN OF ty_s_data,
             import_variable TYPE char20,
           END   OF ty_s_data.
    FIELD-SYMBOLS: <ls_data> TYPE ty_s_data .

    DATA: lt_tip_ofer        TYPE TABLE OF zrm_dt_ofer_tip,
          lv_import_variable TYPE zrm_dt_ofer_tip-import.

    CREATE DATA ex_data TYPE ty_s_data .
    ASSIGN ex_data->* TO <ls_data> .

    SELECT *
      INTO TABLE lt_tip_ofer
      FROM zrm_dt_ofer_tip
      WHERE docclass  = im_docclass
       AND  objectid  = im_objectid
       AND ( tipus_ofer <> 3 AND tipus_ofer <> 4 )
       AND num_ofer = im_num_ofer.

    CHECK lt_tip_ofer IS NOT INITIAL.
    CLEAR: lv_import_variable.

    LOOP AT lt_tip_ofer ASSIGNING FIELD-SYMBOL(<fs_tipologia_econ_ofer>).
      ADD <fs_tipologia_econ_ofer>-import TO lv_import_variable.
    ENDLOOP.

    <ls_data>-import_variable = lv_import_variable.
    SHIFT <ls_data>-import_variable LEFT DELETING LEADING space.
  ENDMETHOD.


  METHOD get_inclou_tem.
    TYPES: ty_s_data TYPE zerm_quadre_inclou_tem,
           ty_t_data TYPE STANDARD TABLE OF ty_s_data WITH NON-UNIQUE DEFAULT KEY.
    DATA: ls_data           TYPE ty_s_data,
          lt_ofertes        TYPE ty_t_oferta,
          l_textid          TYPE string,
          l_societat        TYPE zrm_dt_exp_cont-societat,
          l_just_tem        TYPE zrm_dt_exp_cont-z_data_just_tem,
          l_string_societat TYPE string,
          l_string_just_tem TYPE string.
    FIELD-SYMBOLS: <lt_data>   TYPE ty_t_data,
                   <ls_oferta> TYPE ty_s_oferta.

    IF my_inclou_tem IS BOUND .
      ex_data = my_inclou_tem .
      RETURN .
    ENDIF .

    CREATE DATA my_inclou_tem TYPE ty_t_data .
    ex_data = my_inclou_tem .

    ASSIGN my_inclou_tem->* TO <lt_data> .

    CALL METHOD get_ofertes
      EXPORTING
        im_docclass = im_docclass
        im_objectid = im_objectid
      IMPORTING
        ex_ofertes  = lt_ofertes.

    DELETE lt_ofertes WHERE z_temerari NE 'X'.
    CHECK NOT lt_ofertes IS INITIAL .


    SELECT SINGLE z_data_com_tem societat INTO (l_just_tem, l_societat)
             FROM zrm_dt_exp_cont
            WHERE     docclass EQ im_docclass
                  AND objectid EQ im_objectid .

    l_string_societat = get_company_name( l_societat ) .
    l_string_just_tem = zrm_cl_documents=>format_date( im_date_format = ``
                                                       im_date        = l_just_tem ) .

    SORT lt_ofertes BY z_boi DESCENDING.
    LOOP AT lt_ofertes ASSIGNING <ls_oferta> WHERE z_temerari EQ 'X'
                                               AND z_tipus_oferta EQ gc_oferta_base .
      TRY .
          CASE <ls_oferta>-z_codi_com_temer .
            WHEN '02' .
**          >> INI MODIF ETODR 14.04.2016 SPEC-38156
              " Si procediment adjudicació diferent CD o CP  i no presenta justificació
              IF ( my_exp_cont-z_proc_adj = 'CD' OR my_exp_cont-z_proc_adj = 'CP' ).
                l_textid = zrm_cl_documents=>get_docu_as_string( 'Q3_INCURSA_BAIXA_02_OBERT' ) .
              ELSE.
**          << FI MODIF ETODR 14.04.2016 SPEC-38156
                l_textid = zrm_cl_documents=>get_docu_as_string( 'Q3_INCURSA_BAIXA_02' ) .
              ENDIF.

            WHEN OTHERS .
**          >> INI MODIF ETODR 14.04.2016 SPEC-38156
              " Si procediment adjudicació diferent CD o CP  i presenta justificació
              IF ( my_exp_cont-z_proc_adj = 'CD' OR my_exp_cont-z_proc_adj = 'CP' ).
                l_textid = zrm_cl_documents=>get_docu_as_string( 'Q3_INCURSA_BAIXA_OBERT' ) .
              ELSE.
**          << FI MODIF ETODR 14.04.2016 SPEC-38156
                l_textid = zrm_cl_documents=>get_docu_as_string( 'Q3_INCURSA_BAIXA' ) .
              ENDIF.
          ENDCASE .
        CATCH  zcx_rm_documents .
          RAISE not_found .
      ENDTRY .

      ls_data-z_num_ofer = <ls_oferta>-z_num_ofer .
      ls_data-text       = l_textid .

      REPLACE ALL OCCURRENCES OF '&NOM_PROVEIDOR&' IN ls_data-text
              WITH <ls_oferta>-nom_proveidor .

      REPLACE ALL OCCURRENCES OF '&DATA_JUST_TEM&' IN ls_data-text
              WITH l_string_just_tem .

      REPLACE ALL OCCURRENCES OF '&NOM_SOCIETAT&' IN ls_data-text
              WITH l_string_societat.

      CONCATENATE ls_data-text cl_abap_char_utilities=>cr_lf INTO ls_data-text.
      APPEND ls_data TO <lt_data> .
    ENDLOOP .
  ENDMETHOD.


  METHOD get_inclou_tem_nsp.

    TYPES: ty_s_data TYPE zerm_quadre_inclou_tem,
           ty_t_data TYPE STANDARD TABLE OF ty_s_data WITH NON-UNIQUE DEFAULT KEY.
    DATA: ls_data           TYPE ty_s_data,
          lt_ofertes        TYPE ty_t_oferta,
          l_textid          TYPE string,
          l_societat        TYPE zrm_dt_exp_cont-societat,
          l_just_tem        TYPE zrm_dt_exp_cont-z_data_just_tem,
          l_string_societat TYPE string,
          l_string_just_tem TYPE string.
    FIELD-SYMBOLS: <lt_data>   TYPE ty_t_data,
                   <ls_oferta> TYPE ty_s_oferta.

    IF my_inclou_tem_nsp IS BOUND .
      ex_data = my_inclou_tem_nsp .
      RETURN .
    ENDIF .

    CREATE DATA my_inclou_tem_nsp TYPE ty_t_data .
    ex_data = my_inclou_tem_nsp .

    ASSIGN my_inclou_tem_nsp->* TO <lt_data> .

    CALL METHOD get_ofertes
      EXPORTING
        im_docclass = im_docclass
        im_objectid = im_objectid
      IMPORTING
        ex_ofertes  = lt_ofertes.

**  >>  INI MODIF SPEC 34180
*  DELETE lt_ofertes WHERE z_temerari NE 'X'.
    LOOP AT lt_ofertes ASSIGNING <ls_oferta>.
      "Es borren totes les ofertes que no siguin temeraries excepte si tenen codi_temeritat 3
      IF <ls_oferta>-z_temerari <> 'X'.
        IF <ls_oferta>-z_codi_com_temer <> '03'.
          DELETE lt_ofertes.
        ENDIF.
      ENDIF.
    ENDLOOP.
**  << FI MODIF SPEC 34180
    CHECK NOT lt_ofertes IS INITIAL .


    SELECT SINGLE z_data_com_tem societat INTO (l_just_tem, l_societat)
             FROM zrm_dt_exp_cont
            WHERE     docclass EQ im_docclass
                  AND objectid EQ im_objectid .

    l_string_societat = get_company_name( l_societat ) .
    l_string_just_tem = zrm_cl_documents=>format_date( im_date_format = ``
                                                       im_date        = l_just_tem ) .

    SORT lt_ofertes BY z_boi DESCENDING.
**  >>  INI MODIF SPEC 34180
*  LOOP AT lt_ofertes ASSIGNING <ls_oferta> WHERE z_temerari EQ 'X'
*                                             AND z_tipus_oferta EQ gc_oferta_base.
    LOOP AT lt_ofertes ASSIGNING <ls_oferta> WHERE z_tipus_oferta EQ gc_oferta_base.
**  << FI MODIF SPEC 34180
      TRY .
          CASE <ls_oferta>-z_codi_com_temer .
            WHEN '02' .
**  >> INI ETKAN 20/10/2015 P100031
              IF my_exp_cont-z_proc_adj EQ 'NP'.
                l_textid = zrm_cl_documents=>get_docu_as_string( 'Q3_INCURSA_BAIXA_02_NP' ) .
*            ELSEIF my_exp_cont-z_proc_adj EQ 'PS' OR my_exp_cont-z_ns_simplificat EQ 'X'. "11/02/2016 "SPEC-38265 (NS simplificat)
*              l_textid = zrm_cl_documents=>get_docu_as_string( 'Q3_INCURSA_BAIXA_PS' ). "11/02/2016
              ELSE.
                l_textid = zrm_cl_documents=>get_docu_as_string( 'Q3_INCURSA_BAIXA_02_NSP' ) .
              ENDIF.
**  >> FIN ETKAN 20/10/2015 P100031
**  >>  INI MODIF SPEC 34180
            WHEN '03' .
              l_textid = zrm_cl_documents=>get_docu_as_string( 'Q3_NO_CONSIDERACIO_03_NSP' ) .
**  << FIN MODIF SPEC 34180
            WHEN OTHERS .
**  >> INI ETKAN 20/10/2015 P100031
              IF my_exp_cont-z_proc_adj EQ 'NP'.
                l_textid = zrm_cl_documents=>get_docu_as_string( 'Q3_INCURSA_BAIXA_NP' ).
              ELSEIF my_exp_cont-z_proc_adj EQ 'PS' OR my_exp_cont-z_ns_simplificat EQ 'X'. "11/02/2016 "SPEC-38265 (NS simplificat)
                l_textid = zrm_cl_documents=>get_docu_as_string( 'Q3_INCURSA_BAIXA_PS' ). "11/02/2016
              ELSE.
                l_textid = zrm_cl_documents=>get_docu_as_string( 'Q3_INCURSA_BAIXA_NSP' ).
              ENDIF.
**  >> FIN ETKAN 20/10/2015 P100031
**  << FIN MODIF SPEC 34180
          ENDCASE .
        CATCH  zcx_rm_documents .
          RAISE not_found .
      ENDTRY .

      ls_data-z_num_ofer = <ls_oferta>-z_num_ofer .
      ls_data-text       = l_textid .

      REPLACE ALL OCCURRENCES OF '&NOM_PROVEIDOR&' IN ls_data-text
              WITH <ls_oferta>-nom_proveidor .

      REPLACE ALL OCCURRENCES OF '&DATA_JUST_TEM&' IN ls_data-text
              WITH l_string_just_tem .

      REPLACE ALL OCCURRENCES OF '&NOM_SOCIETAT&' IN ls_data-text
              WITH l_string_societat.

      CONCATENATE ls_data-text cl_abap_char_utilities=>cr_lf INTO ls_data-text.
      APPEND ls_data TO <lt_data> .
    ENDLOOP .

  ENDMETHOD.


  METHOD get_licitadors_empatats.

    DATA: lt_ofertes TYPE ty_t_oferta.
    FIELD-SYMBOLS: <fs_ofertes> TYPE ty_t_oferta,
                   <my_cached>  TYPE REF TO data.

    ASSIGN my_exclusio_s2 TO <my_cached>.

    CREATE DATA <my_cached> TYPE ty_t_oferta.
    ASSIGN <my_cached>->* TO <fs_ofertes>.


    CALL METHOD get_ofertes
      EXPORTING
        im_docclass = im_docclass
        im_objectid = im_objectid
      IMPORTING
        ex_ofertes  = my_ofertes.

    IF my_ofertes IS NOT INITIAL.
      READ TABLE my_ofertes INTO DATA(ls_ofertes) WITH KEY z_adj_prov = abap_true.
      IF sy-subrc EQ 0.
        LOOP AT my_ofertes INTO DATA(ls_empate) WHERE z_punt_total EQ ls_ofertes-z_punt_total.

          APPEND ls_empate TO lt_ofertes.
        ENDLOOP.
      ENDIF.
    ENDIF.

    DESCRIBE TABLE lt_ofertes LINES DATA(lv_lines).
    IF lv_lines LT 2.
      CLEAR lt_ofertes.
    ENDIF.
    <fs_ofertes> = lt_ofertes.

    SORT  <fs_ofertes> BY z_adj_prov.
    ex_data = <my_cached>.

  ENDMETHOD.


  METHOD get_met_press.
    TYPES: BEGIN OF t_peps,
             clau_pep TYPE z_clau_pep,
           END OF t_peps.

    FIELD-SYMBOLS: <l_data>    TYPE string.
    DATA: lt_peps TYPE TABLE OF t_peps,
          ls_pep  LIKE LINE OF lt_peps,
          l_pisco TYPE prps-zzpisco,
          l_prart TYPE prps-prart,
          l_text  TYPE doku_obj.


    IF my_met_press IS BOUND .
      ex_data = my_met_press .
      RETURN .
    ENDIF .

    CREATE DATA my_met_press TYPE string .
    ex_data = my_met_press .
    ASSIGN ex_data->* TO <l_data> .

    SELECT clau_pep FROM zrm_dt_treb_expc INTO TABLE lt_peps
      WHERE docclass = im_docclass AND
            objectid = im_objectid .

    LOOP AT lt_peps INTO ls_pep.
      SELECT SINGLE zzpisco FROM prps INTO l_pisco
          WHERE pspnr = ls_pep-clau_pep .

      IF sy-subrc = 0.
        IF l_pisco = 'O'.
          EXIT.
        ENDIF.

        IF l_pisco = 'P' OR l_pisco = 'C'.
          EXIT.
        ENDIF.
      ENDIF.

    ENDLOOP.

    IF ls_pep-clau_pep IS NOT INITIAL.

      CALL METHOD me->get_met_pressupostari
        EXPORTING
          pspnr = ls_pep-clau_pep
        IMPORTING
          prart = l_prart.

      CASE l_prart.
        WHEN 'CN'.
          l_text = 'L133_TEXT_CN'.
        WHEN 'OD'.
          l_text = 'L133_TEXT_DS'.
        WHEN 'IF'.
          l_text = 'L133_TEXT_IF'.
        WHEN 'IC'.
          l_text = 'L133_TEXT_IC'.
        WHEN 'PV'.
          l_text = 'L133_TEXT_PV'.
        WHEN OTHERS.
          RETURN.
      ENDCASE.

      TRY.
          <l_data> = zrm_cl_documents=>get_docu_as_string( l_text ) .

        CATCH  zcx_rm_documents .
          RAISE not_found .
      ENDTRY .

    ENDIF.

  ENDMETHOD.


  METHOD get_met_press2.

*Inici modif. PLANT257 ACCENT(eajla)  02.08.2010
    TYPES: BEGIN OF t_peps,
             clau_pep TYPE z_clau_pep,
           END OF t_peps.

    FIELD-SYMBOLS: <l_data>    TYPE string.
    DATA: lt_peps TYPE TABLE OF t_peps,
          ls_pep  LIKE LINE OF lt_peps,
          l_pisco TYPE prps-zzpisco,
          l_prart TYPE prps-prart,
          l_text  TYPE doku_obj.


    IF my_met_press IS BOUND .
      ex_data = my_met_press .
      RETURN .
    ENDIF .

    CREATE DATA my_met_press TYPE string .
    ex_data = my_met_press .
    ASSIGN ex_data->* TO <l_data> .

    SELECT clau_pep FROM zrm_dt_treb_expc INTO TABLE lt_peps
      WHERE docclass = im_docclass AND
            objectid = im_objectid .

    IF sy-subrc NE 0.
      l_text = 'L056_TEXT_4D'.
    ENDIF.

    LOOP AT lt_peps INTO ls_pep.
      SELECT SINGLE zzpisco FROM prps INTO l_pisco
          WHERE pspnr = ls_pep-clau_pep .

      IF sy-subrc = 0.
        IF l_pisco = 'O'.
          EXIT.
        ENDIF.

        IF l_pisco = 'P' OR l_pisco = 'C'.
          EXIT.
        ENDIF.
      ENDIF.

    ENDLOOP.

    IF ls_pep-clau_pep IS NOT INITIAL.

      CALL METHOD me->get_met_pressupostari
        EXPORTING
          pspnr = ls_pep-clau_pep
        IMPORTING
          prart = l_prart.

      CASE l_prart.
        WHEN 'CN' OR 'OD' OR 'PV'.
          l_text = 'L056_TEXT_4A'.
        WHEN 'IF'.
          l_text = 'L056_TEXT_4B'.
        WHEN 'IC'.
          l_text = 'L056_TEXT_4C'.
        WHEN OTHERS.
          RETURN.
      ENDCASE.

      TRY.
          <l_data> = zrm_cl_documents=>get_docu_as_string( l_text ) .

        CATCH  zcx_rm_documents .
          RAISE not_found .
      ENDTRY .

    ENDIF.

*FI modif. PLANT257 ACCENT(eajla)  02.08.2010

  ENDMETHOD.


  METHOD get_met_pressupostari.
    DATA: lv_pep1 TYPE ps_posnr,
          lv_pep2 TYPE ps_posnr,
          lv_pep3 TYPE ps_posnr,
          lv_pep4 TYPE ps_posnr,
          lv_cn   TYPE flag,
          lv_od   TYPE flag,
          lv_de   TYPE flag,
          lv_ifer TYPE flag,
          lv_icfe TYPE flag.

    DATA: wa_prps     TYPE prps,
          wa_aux_prps TYPE prps.

    CLEAR prart.

    CHECK NOT pspnr IS INITIAL.

* Nivell 4
    SELECT SINGLE up INTO lv_pep4
           FROM prhi
           WHERE posnr = pspnr.

*   Clientes ICFE pep nivel 4
    SELECT SINGLE * INTO wa_aux_prps
            FROM prps
           WHERE pspnr = lv_pep4.

    IF ( wa_aux_prps-zzclie01 = '0000500011' OR
         wa_aux_prps-zzclie02 = '0000500011' OR
         wa_aux_prps-zzclie03 = '0000500011' ).
      lv_icfe = 'X'.

    ELSEIF wa_aux_prps-zzclie01 IS INITIAL OR
           wa_aux_prps-zzclie02 IS INITIAL OR
           wa_aux_prps-zzclie03 IS INITIAL.
*      Clientes ICFE pep nivel 1
      SELECT SINGLE * INTO wa_aux_prps
           FROM prps
          WHERE psphi =  wa_aux_prps-psphi
            AND stufe = 1.
      IF ( wa_aux_prps-zzclie01 = '0000500011' OR
           wa_aux_prps-zzclie02 = '0000500011' OR
           wa_aux_prps-zzclie03 = '0000500011' ).
        lv_icfe = 'X'.
*      Clientes IFERCAT pep nivel 1
      ELSEIF wa_aux_prps-zzclie03 = '0000500008'.
        lv_ifer = 'X'.
      ENDIF.
*   Clientes IFERCAT pep nivel 4
    ELSEIF wa_aux_prps-zzclie03 = '0000500008'.
      lv_ifer = 'X'.
    ENDIF.

*   Datos pep nivell 4
    SELECT SINGLE *
         INTO wa_prps
         FROM prps
       WHERE pspnr = lv_pep4.

*   Tipus finançament
    IF lv_icfe IS INITIAL AND
       wa_prps-zzmetod = 'IC'.
      lv_icfe = 'X'.
    ENDIF.

*   Despesa
    IF wa_prps-zzmetod = 'DE'.
      lv_de = 'X'.
    ENDIF.

    prart = wa_prps-prart.

*   Concessió
    IF prart = 'CN'.
      lv_cn = 'X'.
    ELSEIF prart = 'OD'.
      lv_od = 'X'.
    ENDIF.

* CONCESSIONS
    IF NOT lv_cn IS INITIAL.
      prart = 'CN'.
    ENDIF.

* DRET SUPERFÍCIE
    IF lv_cn IS INITIAL AND
       NOT lv_od IS INITIAL.
      prart = 'OD'.
    ENDIF.

* ICFE
    IF lv_cn IS INITIAL AND
       lv_od IS INITIAL AND
       NOT lv_icfe IS INITIAL.
      prart = 'IC'.
    ENDIF.

* IFERCAT
    IF lv_cn   IS INITIAL AND
       lv_od   IS INITIAL AND
       lv_icfe IS INITIAL AND
       NOT lv_ifer IS INITIAL.
      prart = 'IF'.
    ENDIF.

* DESPESA
*  IF lv_cn   IS INITIAL AND
*     lv_od   IS INITIAL AND
*     lv_icfe IS INITIAL AND
*     lv_ifer IS INITIAL AND
*     NOT lv_de IS INITIAL.
*    prart = 'DE'.
*  ENDIF.
    IF lv_de IS NOT INITIAL.
      prart = 'DE'.
    ENDIF.

* PEF
    IF lv_cn   IS INITIAL AND
       lv_od   IS INITIAL AND
       lv_icfe IS INITIAL AND
       lv_ifer IS INITIAL AND
       lv_de   IS INITIAL.
      prart = 'PV'.
    ENDIF.

  ENDMETHOD.


  METHOD get_motiu_s2.
    DATA: lt_motiu_s2 TYPE ztt_string,
          wa_motiu_s2 TYPE zerm_motiu_esmena_s2.

    FIELD-SYMBOLS: <lt_motiu_esmena_s2> TYPE ty_t_motiu_esm_s2,
                   <my_cached>          TYPE REF TO data.

    ASSIGN my_motius_esmena_s2 TO <my_cached> .

    IF <my_cached> IS BOUND .
      ex_data = <my_cached> .
      RETURN .
    ENDIF .

    CREATE DATA <my_cached> TYPE ty_t_motiu_esm_s2 .
    ASSIGN <my_cached>->* TO <lt_motiu_esmena_s2> .

    SELECT SINGLE * INTO @DATA(ls_exp_cont)
             FROM zrm_dt_exp_cont
            WHERE     docclass EQ @im_docclass
                  AND objectid EQ @im_objectid .

    IF sy-subrc <> 0.
      RAISE not_found.
    ENDIF.

    SELECT *
      FROM zrm_dm_motesm_s2
      INTO TABLE @DATA(lt_motiu_aux)
     WHERE z_proc_adj = @ls_exp_cont-z_proc_adj.

    LOOP AT lt_motiu_aux ASSIGNING FIELD-SYMBOL(<fs_motiu>).
      CLEAR: wa_motiu_s2.
      CONCATENATE <fs_motiu>-z_txt_mot_esm_1 <fs_motiu>-z_txt_mot_esm_2 <fs_motiu>-z_txt_mot_esm_3 <fs_motiu>-z_txt_mot_esm_4
             INTO wa_motiu_s2-z_motiu_esmena SEPARATED BY space.
      APPEND wa_motiu_s2 TO <lt_motiu_esmena_s2>.
    ENDLOOP.
    ex_data = <my_cached>.

  ENDMETHOD.


  METHOD get_noesm_no_excl_sx.

    DATA: lt_valcrit   TYPE ty_t_valcrit,
          ls_esmena_sx TYPE LINE OF ty_t_esmena_sx,
          ls_lfa1      TYPE lfa1.

    FIELD-SYMBOLS: <ls_valcrit>   TYPE ty_s_valcrit,
                   <lt_esmena_sx> TYPE ty_t_esmena_sx,
                   <my_cached>    TYPE REF TO data.

    CASE im_num_sob .
      WHEN '1' .    ASSIGN my_noesm_noexcl_s1 TO <my_cached> .
      WHEN '3' .    ASSIGN my_noesm_noexcl_s3 TO <my_cached> .
      WHEN OTHERS . RETURN .
    ENDCASE .

    IF <my_cached> IS BOUND .
      ex_data = <my_cached> .
      RETURN .
    ENDIF .

    CALL METHOD get_valcrit
      EXPORTING
        im_docclass = im_docclass
        im_objectid = im_objectid
      IMPORTING
        ex_valcrit  = lt_valcrit.


    CREATE DATA <my_cached> TYPE ty_t_esmena_sx .
    ASSIGN <my_cached>->* TO <lt_esmena_sx> .

    CASE im_num_sob.
      WHEN '3'.
        DELETE lt_valcrit WHERE z_tipus_oferta EQ gc_oferta_variant .
        DELETE lt_valcrit WHERE z_num_sob > im_num_sob. "SPEC-53131 S'eliminen els sobres posteriors al 3 que és fins on hem de tractar

        LOOP AT lt_valcrit ASSIGNING <ls_valcrit> WHERE ( z_exclos_s1s2      EQ 'X' OR
                                                          z_exclos_s2        EQ 'X' OR
                                                          z_exclos_s3        EQ 'X' OR
                                                          z_excl_pos_esm     EQ 'X' OR
                                                          " INI SPEC-55767
                                                          z_exclos_clau      EQ 'X' OR
                                                          " FIN SPEC-55767
"                                                         ">> INI MODIF ETODR SPEC-53131 Al sobre 3 no hi ha flag "correcte" ni "esmenat", hi ha el Z_ESMENA_S3
                                                          z_esmena_s3        EQ 'X' OR
                                                          z_exclos_s3_postob EQ 'X' ).
*                                                          z_correcte      NE 'X' OR
*                                                          z_esmenat       EQ 'X'  ) .
**                                                        "<< FI MODIF ETODR SPEC-53131

          DELETE lt_valcrit WHERE z_num_ofer EQ <ls_valcrit>-z_num_ofer.
        ENDLOOP .

      WHEN '2'.
      WHEN OTHERS.

        IF im_num_sob EQ '1' .
          DELETE lt_valcrit WHERE z_tipus_oferta EQ gc_oferta_variant .
          DELETE lt_valcrit WHERE z_num_sob NE im_num_sob. "SPEC-53131 S'eliminen els sobres posteriors al 1 que és fins on hem de tractar
        ENDIF .

        LOOP AT lt_valcrit ASSIGNING <ls_valcrit> WHERE ( z_exclos_s1s2   EQ 'X' OR
                                                          z_excl_pos_esm  EQ 'X' OR
                                                          z_correcte      NE 'X' OR
                                                          z_esmenat       EQ 'X' ) .
          DELETE lt_valcrit WHERE z_num_ofer EQ <ls_valcrit>-z_num_ofer.
        ENDLOOP .

        SELECT SINGLE z_obert_simpl
          INTO @DATA(lv_simpl)
          FROM zrm_dt_exp_cont
         WHERE docclass      EQ @im_docclass AND
               objectid      EQ @im_objectid.

        IF lv_simpl IS NOT INITIAL.
          LOOP AT lt_valcrit ASSIGNING <ls_valcrit> WHERE ( z_exclos_s3   EQ 'X' OR
                                                            z_exclos_s2  EQ 'X' ).
            DELETE lt_valcrit WHERE z_num_ofer EQ <ls_valcrit>-z_num_ofer.
          ENDLOOP .
        ENDIF.

        SELECT *
          FROM zrm_dt_ofertes
          INTO TABLE @DATA(lt_ofertes)
         WHERE docclass      EQ @im_docclass AND
               objectid      EQ @im_objectid AND
               z_exclos_clau EQ @abap_true.

        LOOP AT lt_ofertes ASSIGNING FIELD-SYMBOL(<fs_of>).
          DELETE lt_valcrit WHERE z_num_ofer EQ <fs_of>-z_num_ofer.
        ENDLOOP.

    ENDCASE.

    IF lt_valcrit IS NOT INITIAL.
      LOOP AT lt_valcrit ASSIGNING <ls_valcrit>.
        CALL METHOD fill_esmena
          EXPORTING
            im_valcrit = <ls_valcrit>
          CHANGING
            cs_esmena  = ls_esmena_sx.
        APPEND ls_esmena_sx TO <lt_esmena_sx> .
      ENDLOOP.

      SORT <lt_esmena_sx> BY proveidor.
      DELETE ADJACENT DUPLICATES FROM <lt_esmena_sx> COMPARING proveidor.

      SORT <lt_esmena_sx> BY nom_proveidor .

    ENDIF.
    ex_data = <my_cached>.

  ENDMETHOD.


  METHOD get_nom_proveidor.

    TYPES: BEGIN OF ty_s_data,
             nom_proveidor TYPE char70,
           END   OF ty_s_data.
    FIELD-SYMBOLS: <ls_data> TYPE ty_s_data .

    DATA: lt_oferta_adj    TYPE TABLE OF zrm_dt_ofertes,
          lv_oferta_adj    TYPE zrm_dt_ofertes,
          lv_nom_proveidor TYPE char70.

    CREATE DATA ex_data TYPE ty_s_data .
    ASSIGN ex_data->* TO <ls_data> .

    SELECT *
      FROM zrm_dt_ofertes
      INTO TABLE lt_oferta_adj
      WHERE docclass  = im_docclass
       AND  objectid  = im_objectid
       AND z_renun_ofert = abap_on.

    CHECK lt_oferta_adj IS NOT INITIAL.
    READ TABLE lt_oferta_adj INTO lv_oferta_adj INDEX 1.

    SELECT SINGLE *
      INTO @DATA(lv_kna1)
      FROM kna1
      WHERE kunnr = @lv_oferta_adj-proveidor.


    CHECK lv_kna1 IS NOT INITIAL.
    CLEAR: lv_nom_proveidor.

    CONCATENATE lv_kna1-name1 lv_kna1-name2 'Presenta Renúncia' INTO lv_nom_proveidor SEPARATED BY space.

    <ls_data>-nom_proveidor = lv_nom_proveidor.
    SHIFT <ls_data>-nom_proveidor LEFT DELETING LEADING space.
  ENDMETHOD.


  METHOD get_no_exclos_no_esmena_s3_sde.

    DATA: ls_esmena_sx TYPE LINE OF ty_t_esmena_sx.
    DATA: lt_ofertes   TYPE TABLE OF zrm_dt_ofertes.
    DATA: ls_oferta    TYPE          zrm_dt_ofertes.

    FIELD-SYMBOLS: <lt_esmena_sx> TYPE ty_t_esmena_sx.

    IF my_no_exclos_no_esmena_s3_sde IS BOUND.
      ex_data = my_no_exclos_no_esmena_s3_sde.
      RETURN.
    ENDIF.

    CREATE DATA my_no_exclos_no_esmena_s3_sde TYPE ty_t_esmena_sx.
    ex_data = my_no_exclos_no_esmena_s3_sde.

    ASSIGN ex_data->* TO <lt_esmena_sx>.

    REFRESH lt_ofertes. CLEAR ls_oferta.

    SELECT * INTO TABLE lt_ofertes FROM zrm_dt_ofertes
      WHERE docclass  EQ im_docclass AND objectid EQ im_objectid.

    IF sy-subrc NE 0.
      RAISE not_found.
    ENDIF.

    DELETE lt_ofertes WHERE NOT ( z_esmena_s3           EQ  space AND
                                  z_exclos_s3           EQ  space AND
                                  z_excl_homog          EQ  space AND
                                  z_excl_punt_tec       EQ  space AND
                                  z_exclos_s1           EQ  space AND
                                  z_exc_relrol          EQ  space AND
                                  z_exclos_clau         EQ  space AND
                                  z_exclos_s2           EQ  space AND
                                  z_exclos_var_tec      EQ  space AND
                                  z_excl_solv_tec       EQ  space AND
                                  z_exclos_s3_postob    EQ  space AND
                                  z_exclos_req          EQ  space AND
                                  z_exclos_plec         EQ  space AND
                                  z_exclos_carrecs      EQ  space AND
                                  z_exclos_po_pt        EQ  space AND
                                  z_exclos_cont_s3_a_s2 EQ  space AND
                                  z_renun_ofert         EQ  space ). " Tambe s'exclouen els que renuncien

    REFRESH <lt_esmena_sx>.
    LOOP AT lt_ofertes INTO ls_oferta.

      CLEAR ls_esmena_sx.

      ls_esmena_sx-proveidor     = ls_oferta-proveidor.
      ls_esmena_sx-nom_proveidor = get_vendor_name( ls_esmena_sx-proveidor ) .

      APPEND ls_esmena_sx TO <lt_esmena_sx>.

    ENDLOOP.

  ENDMETHOD.


  METHOD get_no_inclou_tem.
    TYPES: ty_s_data TYPE zerm_quadre_no_inclou_tem,
           ty_t_data TYPE STANDARD TABLE OF ty_s_data WITH NON-UNIQUE DEFAULT KEY.
    DATA: ls_data           TYPE ty_s_data,
          lt_ofertes        TYPE ty_t_oferta,
          l_textid          TYPE string,
          l_societat        TYPE zrm_dt_exp_cont-societat,
          l_just_tem        TYPE zrm_dt_exp_cont-z_data_just_tem,
          l_string_societat TYPE string,
          l_string_just_tem TYPE string.
    FIELD-SYMBOLS: <lt_data>   TYPE ty_t_data,
                   <ls_oferta> TYPE ty_s_oferta.

    IF my_no_inclou_tem IS BOUND .
      ex_data = my_no_inclou_tem .
      RETURN .
    ENDIF .

    CREATE DATA my_no_inclou_tem TYPE ty_t_data .
    ex_data = my_no_inclou_tem .

    ASSIGN my_no_inclou_tem->* TO <lt_data> .

    CALL METHOD get_ofertes
      EXPORTING
        im_docclass = im_docclass
        im_objectid = im_objectid
      IMPORTING
        ex_ofertes  = lt_ofertes.

    DELETE lt_ofertes WHERE       z_temerari       EQ 'X'
                             OR ( z_presump_temer  NE 'X' AND z_import_homog EQ 0 )
                             OR ( z_pres_tem_homog NE 'X' AND z_import_homog NE 0 ) .
    CHECK NOT lt_ofertes IS INITIAL .

    TRY .
        l_textid = zrm_cl_documents=>get_docu_as_string( 'Q3_NO_INCURSA_BAIXA' ) .
      CATCH  zcx_rm_documents .
        RAISE not_found .
    ENDTRY .

    SELECT SINGLE z_data_com_tem societat INTO (l_just_tem, l_societat)
             FROM zrm_dt_exp_cont
            WHERE     docclass EQ im_docclass
                  AND objectid EQ im_objectid .

    l_string_societat = get_company_name( l_societat ) .
    l_string_just_tem = zrm_cl_documents=>format_date( im_date_format = ``
                                                       im_date        = l_just_tem ) .

    SORT lt_ofertes BY z_boi DESCENDING.

    LOOP AT lt_ofertes ASSIGNING <ls_oferta> WHERE z_tipus_oferta EQ gc_oferta_base .
      ls_data-z_num_ofer = <ls_oferta>-z_num_ofer .
      ls_data-text       = l_textid .

      REPLACE ALL OCCURRENCES OF '&NOM_PROVEIDOR&' IN ls_data-text
              WITH <ls_oferta>-nom_proveidor .

      REPLACE ALL OCCURRENCES OF '&DATA_JUST_TEM&' IN ls_data-text
              WITH l_string_just_tem .

      REPLACE ALL OCCURRENCES OF '&NOM_SOCIETAT&' IN ls_data-text
              WITH l_string_societat.

      CONCATENATE ls_data-text cl_abap_char_utilities=>cr_lf INTO ls_data-text.
      APPEND ls_data TO <lt_data> .
    ENDLOOP .
  ENDMETHOD.


  METHOD get_no_inclou_tem_nsp.

    TYPES: ty_s_data TYPE zerm_quadre_no_inclou_tem,
           ty_t_data TYPE STANDARD TABLE OF ty_s_data WITH NON-UNIQUE DEFAULT KEY.
    DATA: ls_data           TYPE ty_s_data,
          lt_ofertes        TYPE ty_t_oferta,
          l_textid          TYPE string,
          l_societat        TYPE zrm_dt_exp_cont-societat,
          l_just_tem        TYPE zrm_dt_exp_cont-z_data_just_tem,
          l_string_societat TYPE string,
          l_string_just_tem TYPE string.
    FIELD-SYMBOLS: <lt_data>   TYPE ty_t_data,
                   <ls_oferta> TYPE ty_s_oferta.

    IF my_no_inclou_tem_n IS BOUND .
      ex_data = my_no_inclou_tem_n .
      RETURN .
    ENDIF .

    CREATE DATA my_no_inclou_tem_n TYPE ty_t_data .
    ex_data = my_no_inclou_tem_n .

    ASSIGN my_no_inclou_tem_n->* TO <lt_data> .

    CALL METHOD get_ofertes
      EXPORTING
        im_docclass = im_docclass
        im_objectid = im_objectid
      IMPORTING
        ex_ofertes  = lt_ofertes.

    DELETE lt_ofertes WHERE       z_temerari       EQ 'X'
                             OR ( z_presump_temer  NE 'X' AND z_import_homog EQ 0 )
                             OR ( z_pres_tem_homog NE 'X' AND z_import_homog NE 0 )
**  >> INI MODIF SPEC 34180
                             OR z_codi_com_temer IS NOT INITIAL.
**  << FI MODIF SPEC 34180
    CHECK NOT lt_ofertes IS INITIAL .

    TRY .
        l_textid = zrm_cl_documents=>get_docu_as_string( 'Q3_NO_INCURSA_BAIXA_NSP' ) .
      CATCH  zcx_rm_documents .
        RAISE not_found .
    ENDTRY .

    SELECT SINGLE z_data_com_tem societat INTO (l_just_tem, l_societat)
             FROM zrm_dt_exp_cont
            WHERE     docclass EQ im_docclass
                  AND objectid EQ im_objectid .

    l_string_societat = get_company_name( l_societat ) .
    l_string_just_tem = zrm_cl_documents=>format_date( im_date_format = ``
                                                       im_date        = l_just_tem ) .

    SORT lt_ofertes BY z_boi DESCENDING.

    LOOP AT lt_ofertes ASSIGNING <ls_oferta> WHERE z_tipus_oferta EQ gc_oferta_base .
      ls_data-z_num_ofer = <ls_oferta>-z_num_ofer .
      ls_data-text       = l_textid .

      REPLACE ALL OCCURRENCES OF '&NOM_PROVEIDOR&' IN ls_data-text
              WITH <ls_oferta>-nom_proveidor .

      REPLACE ALL OCCURRENCES OF '&DATA_JUST_TEM&' IN ls_data-text
              WITH l_string_just_tem .

      REPLACE ALL OCCURRENCES OF '&NOM_SOCIETAT&' IN ls_data-text
              WITH l_string_societat.

      CONCATENATE ls_data-text cl_abap_char_utilities=>cr_lf INTO ls_data-text.
      APPEND ls_data TO <lt_data> .
    ENDLOOP .

  ENDMETHOD.


  METHOD get_ofertes.
    FIELD-SYMBOLS: <ls_oferta>  TYPE ty_s_oferta.
    DATA: l_num_variant TYPE z_num_ofer.

    IF my_ofertes IS NOT INITIAL .
      ex_ofertes = my_ofertes .
      RETURN .
    ENDIF .

    SELECT * INTO CORRESPONDING FIELDS OF TABLE my_ofertes
            FROM zrm_dt_ofertes
           WHERE     docclass       EQ im_docclass
                 AND objectid       EQ im_objectid.

    SORT my_ofertes BY proveidor z_tipus_oferta z_num_ofer .
**>> INI MODIF ETODR SPEC-53119
    DELETE my_ofertes WHERE z_renun_ofert = abap_on.
**<< FI MODIF ETODR SPEC-53119
    LOOP AT my_ofertes ASSIGNING <ls_oferta> .
      <ls_oferta>-vendor_data = me->complete_vendor_data( <ls_oferta>-proveidor ) .

*-- Asignem el número d'oferta variant --------------------------
      IF <ls_oferta>-z_tipus_oferta EQ gc_oferta_base.
        CLEAR <ls_oferta>-z_num_variant .
        l_num_variant = 1 .
      ELSEIF <ls_oferta>-z_tipus_oferta EQ gc_oferta_variant.
        <ls_oferta>-z_num_variant = l_num_variant .
        ADD 1 TO l_num_variant .
      ENDIF .
    ENDLOOP .

    CALL METHOD recalculate_group
      CHANGING
        ch_ofertes = my_ofertes.

    ex_ofertes = my_ofertes .
  ENDMETHOD.


  METHOD get_ofertes_2.
    FIELD-SYMBOLS: <ls_oferta>  TYPE ty_s_oferta.
    DATA: l_num_variant TYPE z_num_ofer.

    IF my_ofertes IS NOT INITIAL .
      ex_ofertes = my_ofertes .
      RETURN .
    ENDIF .

    SELECT * INTO CORRESPONDING FIELDS OF TABLE my_ofertes
            FROM zrm_dt_ofertes
           WHERE     docclass       EQ im_docclass
                 AND objectid       EQ im_objectid.

    SORT my_ofertes BY proveidor z_tipus_oferta z_num_ofer .

    LOOP AT my_ofertes ASSIGNING <ls_oferta> .
      <ls_oferta>-vendor_data = me->complete_vendor_data( <ls_oferta>-proveidor ) .

*-- Asignem el número d'oferta variant --------------------------
      IF <ls_oferta>-z_tipus_oferta EQ gc_oferta_base.
        CLEAR <ls_oferta>-z_num_variant .
        l_num_variant = 1 .
      ELSEIF <ls_oferta>-z_tipus_oferta EQ gc_oferta_variant.
        <ls_oferta>-z_num_variant = l_num_variant .
        ADD 1 TO l_num_variant .
      ENDIF .
    ENDLOOP .

    CALL METHOD recalculate_group
      CHANGING
        ch_ofertes = my_ofertes.

    ex_ofertes = my_ofertes .
  ENDMETHOD.


  METHOD get_prov_altern.
    TYPES: ty_s_data TYPE zerm_quadre_prov_altern,
           ty_t_data TYPE STANDARD TABLE OF ty_s_data
                      WITH NON-UNIQUE DEFAULT KEY .

    DATA: ls_data         TYPE ty_s_data,
          lt_ofertes      TYPE ty_t_oferta,
          lt_valcrit      TYPE ty_t_valcrit,
          l_string        TYPE string,
          l_tipus_cont    TYPE zrm_dt_exp_cont-z_tipus_cont,
          l_subtipus_cont TYPE zrm_dt_exp_cont-z_subtipus_cont,
          l_char80        TYPE char80,
          l_part_b        TYPE string,
          l_import        TYPE zrm_dt_ofertes-z_import_homog.

**  >> INI ETKAN 04/11/2015 P100031
    DATA: l_proc_adj   TYPE z_proc_adj,
          l_negociacio TYPE xfeld.
**  >> FIN ETKAN 04/11/2015 P100031


    FIELD-SYMBOLS: <lt_data>    TYPE ty_t_data,
                   <ls_oferta>  TYPE ty_s_oferta,
                   <ls_valcrit> TYPE ty_s_valcrit.

    IF my_prov_altern IS BOUND .
      ex_data = my_prov_altern .
      RETURN .
    ENDIF .

    CREATE DATA my_prov_altern TYPE ty_t_data .
    ex_data = my_prov_altern .
    ASSIGN ex_data->* TO <lt_data> .

* Si el procediment no és obres retornem una taula buida
    SELECT SINGLE z_proc_adj z_tipus_cont z_subtipus_cont z_negociacio "Modif. por: ETKAN 04/11/2015 P100031
             INTO (l_proc_adj, l_tipus_cont, l_subtipus_cont, l_negociacio) "Modif. por: ETKAN 04/11/2015 P100031
             FROM zrm_dt_exp_cont
            WHERE     docclass EQ im_docclass
                  AND objectid EQ im_objectid .
    CHECK l_tipus_cont EQ 'OB' .

    CALL METHOD get_ofertes
      EXPORTING
        im_docclass = im_docclass
        im_objectid = im_objectid
      IMPORTING
        ex_ofertes  = lt_ofertes.

*-- Ens carreguem les ofertes excloses per S3 -----------
    DELETE lt_ofertes WHERE    z_exclos_s3     NE space
                            OR z_excl_homog    NE space
                            OR z_excl_punt_tec NE space
                            OR z_temerari      NE space .
    CALL METHOD get_valcrit
      EXPORTING
        im_docclass = im_docclass
        im_objectid = im_objectid
      IMPORTING
        ex_valcrit  = lt_valcrit.

*-- Ens carreguem les ofertes excloses per S1/S2 --------
    LOOP AT lt_valcrit ASSIGNING <ls_valcrit> .
      CHECK    <ls_valcrit>-z_excl_pos_esm EQ 'X'
            OR <ls_valcrit>-z_exclos_s1s2  EQ 'X' .
      DELETE lt_ofertes WHERE z_num_ofer = <ls_valcrit>-z_num_ofer .
    ENDLOOP .

**  >> INI ETKAN 04/11/2015 P100031
    IF l_proc_adj EQ 'NF' AND
       l_negociacio IS NOT INITIAL.
      DELETE lt_ofertes WHERE z_sel_2volta IS INITIAL.
    ENDIF.
**  >> FIN ETKAN 04/11/2015 P100031

* Ens quedem només amb les dues millors ofertes no adjudicatàries
    DELETE lt_ofertes WHERE NOT z_adj_prov IS INITIAL
                             OR z_punt_total EQ 0
                             OR NOT z_excl_punt_tec IS INITIAL .
    SORT lt_ofertes BY z_punt_total DESCENDING .
    DELETE lt_ofertes FROM 3 .

    TRY .
        CASE l_subtipus_cont .
          WHEN 'PD' .    l_part_b = zrm_cl_documents=>get_docu_as_string( 'Q3_PROVEIDOR_ALTERN_PD' ) .
          WHEN 'PO' .    l_part_b = zrm_cl_documents=>get_docu_as_string( 'Q3_PROVEIDOR_ALTERN_PO' ) .
          WHEN OTHERS .  l_part_b = zrm_cl_documents=>get_docu_as_string( 'Q3_PROVEIDOR_ALTERN_ALTRES' ) .
        ENDCASE .
      CATCH  zcx_rm_documents .
        RAISE not_found .
    ENDTRY .

    LOOP AT lt_ofertes ASSIGNING <ls_oferta> .
      ls_data-part_a = text-003 .
      ls_data-part_b = l_part_b .

      CASE <ls_oferta>-z_tipus_oferta .
        WHEN gc_oferta_base .
          l_string = 'base'(005) .
        WHEN gc_oferta_variant .
          l_string = <ls_oferta>-z_num_variant .
          SHIFT l_string LEFT DELETING LEADING '0' .
          CONCATENATE 'variant número'(006) l_string
                 INTO l_string SEPARATED BY space .
      ENDCASE .

      REPLACE '&1' WITH l_string INTO ls_data-part_a .
      REPLACE '&1' WITH l_string INTO ls_data-part_b .

      REPLACE '&2' WITH <ls_oferta>-nom_proveidor INTO ls_data-part_a .
      REPLACE '&2' WITH <ls_oferta>-nom_proveidor INTO ls_data-part_b .

      WRITE <ls_oferta>-z_punt_total TO l_char80 LEFT-JUSTIFIED DECIMALS 2 .
      l_string = l_char80 .
      REPLACE '&3' WITH l_string INTO ls_data-part_a .

* --- Resta de camps de la Part B ---
* Import de l'oferta: &3 (literal) i &4 numèric
* Termini d'execució de l'oferta: &5
* Import de projecte: &6 (literal) i &7 numèric
* Import direcció: &8 (literal) i &9 numèric
* Import execució: &A (literal) i &B numèric
* Termini execució d'obra: &TO
* Termini execució de projecte: &TP
      IF <ls_oferta>-z_imp_homog_b IS INITIAL .
        l_import = <ls_oferta>-z_imp_oferta_b .
      ELSE .
        l_import = <ls_oferta>-z_imp_homog_b .
      ENDIF .

      CALL METHOD replace_amount
        EXPORTING
          im_amount        = l_import
          im_amount_holder = '&4'
          im_spell_holder  = '&3'
        CHANGING
          c_string         = ls_data-part_b.
      l_string = get_quadre3_durada( im_durada = <ls_oferta>-z_termini_exec
                                     im_unit   = <ls_oferta>-z_unit_term_exec ) .
      REPLACE '&5' WITH l_string INTO ls_data-part_b .

      CALL METHOD replace_amount
        EXPORTING
          im_amount        = <ls_oferta>-z_cost_proj_b
          im_amount_holder = '&7'
          im_spell_holder  = '&6'
        CHANGING
          c_string         = ls_data-part_b.

      CALL METHOD replace_amount
        EXPORTING
          im_amount        = <ls_oferta>-z_cost_dir_b
          im_amount_holder = '&9'
          im_spell_holder  = '&8'
        CHANGING
          c_string         = ls_data-part_b.

      CALL METHOD replace_amount
        EXPORTING
          im_amount        = <ls_oferta>-z_cost_obra_b
          im_amount_holder = '&B'
          im_spell_holder  = '&A'
        CHANGING
          c_string         = ls_data-part_b.

      l_string = get_quadre3_durada( im_durada = <ls_oferta>-z_termini_obra
                                     im_unit   = <ls_oferta>-z_unit_term_obra ) .
      REPLACE '&TO' WITH l_string INTO ls_data-part_b .

      l_string = get_quadre3_durada( im_durada = <ls_oferta>-z_termini_proj
                                     im_unit   = <ls_oferta>-z_unit_term_proj ) .
      REPLACE '&TP' WITH l_string INTO ls_data-part_b .

      CONCATENATE ls_data-part_b '.' INTO ls_data-part_b .

      APPEND ls_data TO <lt_data> .
    ENDLOOP .

  ENDMETHOD.


  METHOD get_quadre3.
    DEFINE _format_number .
      write &1 to l_char80 decimals 2 left-justified .  "#EC UOM_IN_MES
      &2 = l_char80 .
    END-OF-DEFINITION .

    TYPES: ty_t_quadre3 TYPE STANDARD TABLE OF zerm_quadre3
                        WITH NON-UNIQUE DEFAULT KEY .

    DATA: lt_ofertes     TYPE ty_t_oferta,
          ls_ofertes     TYPE ty_s_oferta,
          l_recalculate  TYPE xfeld,
          ls_quadre3     TYPE LINE OF ty_t_quadre3,
          lv_numerator   TYPE zrm_dt_exp_cont-z_pres_licit_b,
          lv_denominator TYPE zrm_dt_exp_cont-z_pres_licit_b,
          l_char80       TYPE char80,
          BEGIN OF ls_cost_projecte,
            base        TYPE zrm_dt_ofertes-z_imp_homog_b,
            total       TYPE zrm_dt_ofertes-z_import_homog,
            total_homog TYPE zrm_dt_ofertes-z_import_homog,
          END OF ls_cost_projecte,
          l_import_calcul       TYPE zrm_dt_ofertes-z_imp_homog_b,
          l_exclos              TYPE xfeld,
          l_exclos_bis          TYPE xfeld,
          ls_quadre3_cache      TYPE ty_s_quadre3_cache,
          l_last_konzs          TYPE lfa1-konzs,
          lt_valcrit            TYPE ty_t_valcrit,
          lt_group              TYPE TABLE OF konzs,
          lt_group_compleix     TYPE HASHED TABLE OF konzs WITH UNIQUE DEFAULT KEY,
          l_num_grup            TYPE string,
          l_prefix              TYPE string,
          l_prefix_homog        TYPE string,
          l_empresa             TYPE string,
          lv_cost_part_variable TYPE zrm_dt_ofer_tip-import, "SPEC-51404
          lv_cost_part_fixa     TYPE zrm_dt_ofer_tip-import, "SPEC-49881
          lv_num_plec           TYPE z_num_plec,
          lv_form_temeritat     TYPE z_form_temeritat,
          lv_obert_simpl        TYPE z_obert_simpl,
          lv_conv_ob_preu       TYPE zrm_dt_exp_cont-z_conv_ob_preu,
          l_dir                 TYPE z_per_dir,
          l_proj                TYPE z_per_proj,
          lv_value_sense_iva    TYPE zsap_de_value.           " SPEC-57843 ETXGL

    ">> SPEC-76178, Inici Modificació - ETODR
    DATA: ls_import_ofer_tipologies TYPE zst_tip_import,
          lv_presu_fix_siva         TYPE z_pres_of_eco,
          lv_presu_var_siva         TYPE z_pres_of_eco,
          lv_presu_fix_iva          TYPE z_pres_of_eco_iva,
          lv_presu_var_iva          TYPE z_pres_of_eco_iva.
    "<< SPEC-76178, Final Modificació - ETODR

    ">>>  SPEC-57843 Inici Modificació ETXGL
    CONSTANTS: co_programa   TYPE char30 VALUE 'CALCULATE_NOUS_PLECS_BLIM',
               co_nom_fitxer TYPE char16 VALUE 'CALC_SENSE_IVA'.
    "<<<  SPEC-57843 Final Modificació ETXGL

    FIELD-SYMBOLS: <lt_quadre3>     TYPE ty_t_quadre3,
                   <lt_quadre3_aux> TYPE ty_t_quadre3,
                   <lt_vincle>      TYPE ty_t_vincle,
                   <ls_oferta>      TYPE ty_s_oferta,
                   <ls_valcrit>     TYPE ty_s_valcrit,
                   <ls_quadre3>     TYPE zerm_quadre3.

    ls_quadre3_cache-sort_by      = im_sort_by .
    ls_quadre3_cache-tipus_oferta = im_tipus_oferta .
    READ TABLE my_quadre3_cache INTO ls_quadre3_cache FROM ls_quadre3_cache .

    IF sy-subrc EQ 0
     AND ls_quadre3_cache-quadre IS BOUND .
      ex_quadre  = ls_quadre3_cache-quadre .
      ex_vincles = ls_quadre3_cache-vincles .
      RETURN.
    ENDIF .

    CREATE DATA ls_quadre3_cache-quadre  TYPE ty_t_quadre3 .
    CREATE DATA ls_quadre3_cache-vincles TYPE ty_t_vincle .
    INSERT ls_quadre3_cache INTO TABLE my_quadre3_cache .

    ex_quadre = ls_quadre3_cache-quadre .
    ASSIGN ex_quadre->* TO <lt_quadre3> .

    ex_vincles = ls_quadre3_cache-vincles .
    ASSIGN ex_vincles->* TO <lt_vincle> .

    CALL METHOD get_valcrit
      EXPORTING
        im_docclass = im_docclass
        im_objectid = im_objectid
      IMPORTING
        ex_valcrit  = lt_valcrit.

    CALL METHOD get_ofertes
      EXPORTING
        im_docclass = im_docclass
        im_objectid = im_objectid
      IMPORTING
        ex_ofertes  = lt_ofertes.

**  >> INI ETKAN 08/09/2015 P100031
    IF my_exp_cont-z_proc_adj   EQ 'NP' OR
     ( my_exp_cont-z_proc_adj   EQ 'NF' AND
       my_exp_cont-z_negociacio IS NOT INITIAL ).

      IF  my_exp_cont-z_estat    EQ 'ZN1' AND lt_ofertes IS NOT INITIAL.
        DELETE lt_ofertes WHERE z_renun_ofert IS NOT INITIAL.
      ENDIF.

      IF  my_exp_cont-z_estat    EQ 'ZN2' AND lt_ofertes IS NOT INITIAL.
        DELETE lt_ofertes WHERE z_sel_2volta IS INITIAL.
      ENDIF.

    ENDIF.
**  >> FIN ETKAN P100031

**>>  INI MODIF SPEC-33452
    SELECT SINGLE z_num_plec z_obert_simpl z_conv_ob_preu
      FROM zrm_dt_exp_cont
      INTO ( lv_num_plec, lv_obert_simpl, lv_conv_ob_preu )
      WHERE docclass  = im_docclass
        AND objectid  = im_objectid.

    SELECT SINGLE z_form_temeritat
      FROM zrm_dm_plecs
      INTO lv_form_temeritat
      WHERE z_num_plec = lv_num_plec.
**<< FI MODIF SPEC-33452

***>>> INICI Modif SPEC-43519 ETXGL
*  IF lv_obert_simpl IS INITIAL.
*    DELETE lt_ofertes WHERE z_exclos_s3 EQ 'X'
*                 AND z_exclos_s3_postob NE 'X'.
*  ENDIF.
*>> SPEC-56450, Inici modificació - ETLJS
    ">>>SPEC:73073, Inici modificació  - ECIAC
*  IF lv_obert_simpl NE space OR my_exp_cont-z_proc_adj = 'CE'.
    IF my_exp_cont-z_proc_adj = 'CE'.
      "<<<SPEC:73073, Final modificació - ECIAC
      IF im_obertura IS INITIAL.
        DELETE lt_ofertes WHERE z_exclos_s2 EQ abap_true.
        ">>>SPEC:SPEC-59693, Inici modificació  - ECFA
        "Esborren els que estiguin "exclos PE z_exclos_s3" i no tinguin marcat el
        "el camp exclos post obertura(z_exclos_s3_postob).
        DELETE lt_ofertes WHERE z_exclos_s3 EQ abap_true
                            AND z_exclos_s3_postob NE abap_true.
        "<<<SPEC:SPEC-59693, Final modificació - ECFA
        DELETE lt_ofertes WHERE z_exclos_s1 EQ abap_true.
      ELSE.
        DELETE lt_ofertes WHERE z_exclos_s3 EQ abap_true.
      ENDIF.
      DELETE lt_ofertes WHERE z_exclos_clau EQ abap_true.
    ENDIF.

*  IF my_exp_cont-z_proc_adj = 'CE'.
*    DELETE lt_ofertes WHERE z_exclos_s3 EQ abap_true OR z_exclos_s3_postob EQ abap_true..
*  ENDIF.

*<< SPEC-56450, Final modificació - ETLJS
***<<< FI Modif SPEC-43519 ETXGL

**<< FI MODIF SPEC-33452
    IF sy-subrc EQ 0 .
      l_recalculate = 'X'.
    ENDIF .
* <== EDLSM 07/01/10
    IF my_exp_cont-z_proc_adj = 'CR'.
      DELETE lt_ofertes WHERE z_pres_proposta NE 'X'.
      IF sy-subrc EQ 0 .
        l_recalculate = 'X' .
      ENDIF .
    ENDIF.
* ==> EDLSM 07/01/10

    IF my_exp_cont-z_rd817_2009 IS NOT INITIAL. " Si és Reial Decret RD817_2009
      DELETE lt_ofertes WHERE z_exclos_s2 EQ 'X' .
      IF sy-subrc EQ 0 .
        l_recalculate = 'X' .
      ENDIF .
      DELETE lt_ofertes WHERE z_excl_punt_tec EQ 'X'.
      IF sy-subrc EQ 0 .
        l_recalculate = 'X' .
      ENDIF .
    ENDIF.

**  >> INI MODIF ETODR SPEC-49075
    IF my_exp_cont-z_llei92017 = abap_on AND my_exp_cont-z_obert_preu = abap_off.
      "Per la nova llei, i expedients de licitació oberts no preu, es calcula el valor de la puntuació econòmica per a mostar-lo al Quadre 3A a la columna PUNTS
      TRY.
          zrm_cl_valoracio_ofertes=>recalculate_val_econ_sim( EXPORTING im_objectid = my_exp_cont-objectid
                                                                        im_docclass = my_exp_cont-docclass
                                                              IMPORTING ex_punt_gen = DATA(lt_punt_gen) ).
        CATCH zcx_rm_valoracio .
      ENDTRY.
    ENDIF.
**  << FI MODIF ETODR SPEC-49075

* >> Inici Modif. SPEC-38577. Eliminar del quadre3 i del Quadre d'Obertura els exclosos sobre 2 i/o
*                             per puntuació tècnica.

    IF my_exp_cont-z_proc_adj = 'CD' OR my_exp_cont-z_proc_adj = 'CO' OR
       my_exp_cont-z_proc_adj = 'CP' OR my_exp_cont-z_proc_adj = 'CR' OR
       my_exp_cont-z_proc_adj = 'NF' OR my_exp_cont-z_proc_adj = 'NP'.
**   >> INI MODIF ETODR SPEC-39250
      IF NOT ( ( my_exp_cont-z_proc_adj = 'CD' OR my_exp_cont-z_proc_adj = 'CP' ) AND my_exp_cont-z_harmonitzat IS INITIAL )  "si no és obert d'una sola fase.
         OR my_exp_cont-z_obres_2m5m = 'X'.  " 2M5M es considera harmonitzat de 2 fases
**   << INI MODIF ETODR SPEC-39250
        DELETE lt_ofertes WHERE z_exclos_s2 EQ 'X' .
        IF sy-subrc EQ 0 .
          l_recalculate = 'X' .
        ENDIF .
        DELETE lt_ofertes WHERE z_excl_punt_tec EQ 'X'.
        IF sy-subrc EQ 0 .
          l_recalculate = 'X' .
        ENDIF .
        DELETE lt_valcrit WHERE z_exclos_s2 = 'X' OR z_exclos_var_tec = 'X'.
        IF sy-subrc EQ 0 .
          l_recalculate = 'X' .
        ENDIF .
      ENDIF.
    ENDIF.
* << Fi Modif. SPEC-38577

    LOOP AT lt_valcrit ASSIGNING <ls_valcrit> WHERE z_num_sob EQ '1'
                                               AND (    z_exclos_s1s2 EQ 'X'
                                                     OR z_excl_pos_esm EQ 'X' ).
      l_recalculate = 'X' .
*>> SPEC-56450, Inici modificació - ETLJS

      CHECK lv_obert_simpl IS INITIAL.

*<< SPEC-56450, Final modificació - ETLJS
      DELETE lt_ofertes WHERE z_num_ofer EQ <ls_valcrit>-z_num_ofer .
    ENDLOOP .


    DELETE lt_ofertes WHERE z_exclos_clau = abap_true.

    IF l_recalculate EQ 'X' .
      CALL METHOD recalculate_group
        CHANGING
          ch_ofertes = lt_ofertes.
    ENDIF .

    ">> SPEC-76178, Inici Modificació - ETODR
    CALL METHOD get_tipol_variable
      EXPORTING
        im_docclass = my_exp_cont-docclass
        im_objectid = my_exp_cont-objectid
      RECEIVING
        ex_data     = DATA(lr_has_tipol_econ).
    ASSIGN lr_has_tipol_econ->* TO FIELD-SYMBOL(<fs_has_tipol_econ>) .
    IF sy-subrc = 0.
      IF <fs_has_tipol_econ> = abap_on.
        DATA(lv_has_tipol_econ) = abap_off.
        "Això hauria de ser ABPA_ON però com que no està clar que s'estiguin utilitzant
        "els tags correctes de la BAIXA i COST ja que existeix
        "el BAIXA_PART_VARIABLE i COST_PART_VARIABLE, deixem que els altres funcionin com
        "estaven abans però ho deixem preparat per si algun dia s'ha d'adaptar
        CALL METHOD zcl_util_licitacio=>get_imports_exped_x_tipologia
          EXPORTING
            iv_clas_exp    = my_exp_cont-docclass
            iv_expedient   = my_exp_cont-objectid
          IMPORTING
            et_exped_tipol = DATA(lt_exped_tipol).
        CLEAR: lv_presu_fix_siva, lv_presu_var_siva.
        CLEAR: lv_presu_fix_iva, lv_presu_var_iva.
        LOOP AT lt_exped_tipol ASSIGNING FIELD-SYMBOL(<fs_tipol_econ>).
          IF <fs_tipol_econ>-tipus_ofer = 3 OR <fs_tipol_econ>-tipus_ofer = 4. "fix
            lv_presu_fix_siva = lv_presu_fix_siva + <fs_tipol_econ>-pressupost.
            lv_presu_fix_iva  = lv_presu_fix_iva + <fs_tipol_econ>-pressupost_iva.
          ELSE. "Variable
            lv_presu_var_siva = lv_presu_var_siva + <fs_tipol_econ>-pressupost.
            lv_presu_var_iva  = lv_presu_var_iva + <fs_tipol_econ>-pressupost_iva.
          ENDIF.
        ENDLOOP.
      ENDIF.
    ENDIF.
    "<< SPEC-76178, Final Modificació - ETODR

*-- El número d'agrupador d'empreses s'ha de mantenir coherent per al quadre base
*-- i el quadre variant. Aixó que calculem el Quadre sencer i després descartem el
*-- que no necessitem
    SORT lt_ofertes BY z_num_ofer .
    LOOP AT lt_ofertes ASSIGNING <ls_oferta> .
      CLEAR: ls_quadre3,
             l_exclos,
             l_exclos_bis .

      IF    <ls_oferta>-z_import_homog EQ 0
         OR my_exp_cont-z_req_homog    IS INITIAL .
        ls_cost_projecte-base        = <ls_oferta>-z_imp_oferta_b .
        ls_cost_projecte-total       = <ls_oferta>-z_import_oferta .
        ls_cost_projecte-total_homog = <ls_oferta>-z_import_oferta.
      ELSE .
        ls_cost_projecte-base        = <ls_oferta>-z_imp_homog_b .
        ls_cost_projecte-total       = <ls_oferta>-z_import_oferta .
        ls_cost_projecte-total_homog = <ls_oferta>-z_import_homog.
      ENDIF .
**>>  INI MODIF SPEC-33452
      IF lv_form_temeritat = 'TX1'. "Obres Control de Qualitat Obres  - Variable
        IF <ls_oferta>-z_presdesp_fin IS NOT INITIAL.
          ls_quadre3-presdesp = '(*)'.
        ENDIF.
        IF <ls_oferta>-z_presdesp_ini IS NOT INITIAL.
          IF ls_quadre3-presdesp IS NOT INITIAL.
            CONCATENATE ls_quadre3-presdesp '(***)' INTO ls_quadre3-presdesp.
          ELSE.
            ls_quadre3-presdesp = '(***)'.
          ENDIF.
        ENDIF.
      ENDIF.
**<<  FI MODIF SPEC-33452
      ls_quadre3-z_num_ofer     = <ls_oferta>-z_num_ofer .
      ls_quadre3-num_variant    = <ls_oferta>-z_num_variant .
      ls_quadre3-z_tipus_oferta = <ls_oferta>-z_tipus_oferta .
      ls_quadre3-proveidor      = <ls_oferta>-proveidor .
      ">> SPEC-79706, Inici Modificació - EVCHA
      IF ( my_exp_cont-z_tipus_cont = 'OB' AND my_exp_cont-z_proc_adj = 'NB' AND <ls_oferta>-z_presump_temer IS NOT INITIAL AND
           my_exp_cont-z_tip_bam = '14.1' AND my_exp_cont-z_aplica_bim IS INITIAL ) OR
         ( my_exp_cont-z_tipus_cont = 'OB' AND my_exp_cont-z_proc_adj = 'NB' AND my_exp_cont-z_tip_bam = '14.3' AND <ls_oferta>-z_presump_temer IS NOT INITIAL )
         OR "SPEC-83935 - EVMRG .
         ( my_exp_cont-z_proc_adj = 'NB' AND ( my_exp_cont-z_tip_bam = '14.1A' OR my_exp_cont-z_tip_bam = '14.3A' ) AND <ls_oferta>-z_presump_temer IS NOT INITIAL ). "SPEC-83935 - EVMRG .
        CONCATENATE <ls_oferta>-nom_proveidor '(*)' INTO ls_quadre3-empresa.
        CONCATENATE <ls_oferta>-nom_proveidor '(*)' INTO ls_quadre3-empresa_homog.
      ELSE.
        "<< SPEC-79706, Final Modificació - EVCHA
        ls_quadre3-empresa        = <ls_oferta>-nom_proveidor .
        ls_quadre3-empresa_homog  = <ls_oferta>-nom_proveidor .
      ENDIF.
** >> INI MODIF ETODR SPEC-51404
      CALL METHOD get_tipol_variable
        EXPORTING
          im_docclass = my_exp_cont-docclass
          im_objectid = my_exp_cont-objectid
        RECEIVING
          ex_data     = DATA(lr_is_tipol_variable).
      IF lr_is_tipol_variable IS BOUND.
        ASSIGN lr_is_tipol_variable->* TO FIELD-SYMBOL(<fs_is_tipol_variable>) .
        IF sy-subrc = 0.
          IF <fs_is_tipol_variable> IS ASSIGNED AND <fs_is_tipol_variable> = abap_on.
            CALL METHOD get_imp_tip_variable_oferta
              EXPORTING
                im_docclass = my_exp_cont-docclass
                im_objectid = my_exp_cont-objectid
                im_num_ofer = <ls_oferta>-z_num_ofer
              RECEIVING
                ex_data     = DATA(lr_cost_part_variable).
            IF lr_cost_part_variable IS BOUND.
              ASSIGN lr_cost_part_variable->* TO FIELD-SYMBOL(<fs_cost_part_variable>) .
              IF sy-subrc = 0.
*              ls_quadre3-cost_part_variable = <fs_cost_part_variable>.
                lv_cost_part_variable = <fs_cost_part_variable>.
                _format_number: lv_cost_part_variable ls_quadre3-cost_part_variable.
              ENDIF.
            ENDIF.
**        >> INI MODIF ETODR SPEC-49881
            CALL METHOD get_imp_tip_fix_oferta
              EXPORTING
                im_docclass = my_exp_cont-docclass
                im_objectid = my_exp_cont-objectid
                im_num_ofer = <ls_oferta>-z_num_ofer
              RECEIVING
                ex_data     = DATA(lr_cost_part_fixa).
            IF lr_cost_part_fixa IS BOUND.
              ASSIGN lr_cost_part_fixa->* TO FIELD-SYMBOL(<fs_cost_part_fixa>) .
              IF sy-subrc = 0.
                lv_cost_part_fixa = <fs_cost_part_fixa>.
                _format_number: lv_cost_part_fixa ls_quadre3-cost_part_fixa.
              ENDIF.
            ENDIF.
**        << FI MODIF ETODR SPEC-49881
*          ls_quadre3-baixa_part_variable = <ls_oferta>-z_boi.
            _format_number: <ls_oferta>-z_boi ls_quadre3-baixa_part_variable.
          ENDIF.
        ENDIF.
      ENDIF.
** << FI MODIF ETODR SPEC-51404

      ">>>  SPEC-58774 Inici Modificació ETXGL
***>>>  INICI MODIF SPEC-43591 ETXGL
*-- Empresa (Només en el cas que sigui exclós Post obertura)---
*    IF <ls_oferta>-z_exclos_s3_postob  EQ 'X'.
*      ls_quadre3-z_exclos_post_ob    =  '(1)'. "'Exclòs'(001) . SPEC-43519
*    ELSE.
*      CLEAR ls_quadre3-z_exclos_post_ob.
*    ENDIF.
***<<<  FI  MODIF SPEC-43591 ETXGL
      "<<<  SPEC-58774 Final Modificació ETXGL

*-- Termini d'execució ---------------------------------------
      ls_quadre3-termini_execucio = get_quadre3_durada( im_durada = <ls_oferta>-z_termini_exec
                                                        im_unit   = <ls_oferta>-z_unit_term_exec ) .

*-- Cost -----------------------------------------------------
      _format_number: <ls_oferta>-z_imp_oferta_b  ls_quadre3-cost,
                      <ls_oferta>-z_import_oferta ls_quadre3-cost_total.
      ls_quadre3-cost_int = <ls_oferta>-z_import_oferta .

*-- Homogeneïtzat --------------------------------------------
*    LOOP AT lt_valcrit ASSIGNING <ls_valcrit> WHERE z_num_ofer EQ <ls_oferta>-z_num_ofer
*                                                AND z_num_sob EQ '2'
*                                               AND (   z_exclos_s1s2 EQ 'X'
*                                                     OR z_excl_pos_esm EQ 'X' ) ."#EC NEEDED
*    ENDLOOP .
*    IF     sy-subrc                    NE 0
*       AND <ls_oferta>-z_exclos_s3     EQ space
**      AND <ls_oferta>-z_excl_punt_tec EQ space
*       AND <ls_oferta>-z_excl_homog    EQ space  .
      IF    ( <ls_oferta>-z_exclos_s2     EQ space
*** INI SPEC-54639
        OR ( <ls_oferta>-z_exclos_s2 EQ 'X' AND my_exp_cont-z_obert_simpl EQ 'D' ) )
*** FIN SPEC-54639
         AND <ls_oferta>-z_exclos_s3     EQ space
*      AND <ls_oferta>-z_excl_punt_tec EQ space
         AND <ls_oferta>-z_excl_homog    EQ space.
*       AND <ls_oferta>-z_temerari      EQ space .
        IF <ls_oferta>-z_import_homog IS NOT INITIAL .
          _format_number: <ls_oferta>-z_imp_homog_b   ls_quadre3-homogeneitzat,
                          <ls_oferta>-z_import_homog  ls_quadre3-homogeneitzat_total.
        ELSE .
          _format_number: <ls_oferta>-z_imp_oferta_b  ls_quadre3-homogeneitzat,
                          <ls_oferta>-z_import_oferta ls_quadre3-homogeneitzat_total .
        ENDIF .
      ELSE .
        ls_quadre3-homogeneitzat       =  'Exclòs'(001) .
        ls_quadre3-homogeneitzat_total =  'Exclòs'(001) .
        l_exclos = 'X' .
      ENDIF .

      IF     ( <ls_oferta>-z_exclos_s2 NE space
*** INI SPEC-54639
        AND my_exp_cont-z_obert_simpl NE 'D' )
*** FIN SPEC-54639
          OR <ls_oferta>-z_temerari   NE space .
        l_exclos_bis = 'X' .
      ENDIF.

*-- Percentatge de baixa -------------------------------------
      ">>>  SPEC-57843 Inici Modificació ETXGL
*    lv_numerator   = ls_cost_projecte-total.
*    lv_denominator = my_exp_cont-z_pressup_licit.

      lv_value_sense_iva = abap_off.

      SELECT SINGLE value
       FROM zsap_dt_param_hc
        INTO lv_value_sense_iva
            WHERE repid = co_programa
              AND field_info = co_nom_fitxer.

      lv_numerator = abap_off.
      lv_denominator = abap_off.

      ">> SPEC-76178, Inici Modificació - ETODR
      CLEAR: ls_import_ofer_tipologies.
      IF lv_has_tipol_econ = abap_on.
        CALL METHOD zcl_util_licitacio=>get_import_oferta_tipol_all
          EXPORTING
            iv_docclass = my_exp_cont-docclass
            iv_objectid = my_exp_cont-objectid
            iv_num_ofer = <ls_oferta>-z_num_ofer
          IMPORTING
            es_imports  = ls_import_ofer_tipologies.
      ENDIF.
      "<< SPEC-76178, Final Modificació - ETODR
*    READ TABLE lt_exped_tipol ASSIGNING FIELD-SYMBOL(<fs_tipol_econ>) WITH KEY
      IF lv_value_sense_iva IS NOT INITIAL.
        lv_numerator   = ls_cost_projecte-base.
        lv_denominator = my_exp_cont-z_pres_licit_b.
        ">> SPEC-76178, Inici Modificació - ETODR
        IF lv_has_tipol_econ = abap_on.
          lv_numerator   = ls_import_ofer_tipologies-import_var.  "ls_cost_projecte-base.
          lv_denominator = lv_presu_var_siva. "my_exp_cont-z_pres_licit_b.
        ENDIF.
        "<< SPEC-76178, Final Modificació - ETODR
      ELSEIF lv_value_sense_iva IS INITIAL.
        lv_numerator   = ls_cost_projecte-total.
        lv_denominator = my_exp_cont-z_pressup_licit.
        ">> SPEC-76178, Inici Modificació - ETODR
        IF lv_has_tipol_econ = abap_on.
          lv_numerator   = ls_import_ofer_tipologies-import_var_iva.  "ls_cost_projecte-total.
          lv_denominator = lv_presu_var_iva. "my_exp_cont-z_pressup_licit.
        ENDIF.
        "<< SPEC-76178, Final Modificació - ETODR
      ENDIF.
      "<<<  SPEC-57843 Final Modificació ETXGL

      IF l_exclos EQ 'X'
       AND im_sort_by NE 'BAIXA_INT'
       AND im_sort_by NE 'COST_INT'.
        CLEAR: ls_quadre3-baixa,
               ls_quadre3-baixa_int.
      ELSE.
        CALL METHOD get_quadre3_baixa
          EXPORTING
            im_numerator   = lv_numerator
            im_denominator = lv_denominator
          IMPORTING
            ex_baixa       = ls_quadre3-baixa
            ex_baixa_int   = ls_quadre3-baixa_int.

*INI PRL :: PSPEC-3976
        SELECT SINGLE percentatge INTO <ls_oferta>-z_boi
          FROM zrm_dt_ofer_tip
          WHERE docclass   = <ls_oferta>-docclass   AND
                objectid   = <ls_oferta>-objectid   AND
                num_ofer   = <ls_oferta>-z_num_ofer AND
                tipus_ofer = '2'.
*FIN PRL :: PSPEC-3976

        " >>>SPEC-91759 Inici modificació - EVXGL
        ls_quadre3-baixa_z_boi = ls_quadre3-baixa_z_boi_char = <ls_oferta>-z_boi.
        REPLACE ALL OCCURRENCES OF '.' IN ls_quadre3-baixa_z_boi_char WITH ','.
        " <<<SPEC-91759 Fi modificació - EVXGL
      ENDIF.


*-- Percentatge de baixa amb homog.----------------------------
      ">>>  SPEC-57843 Inici Modificació ETXGL
*    lv_numerator   = ls_cost_projecte-total_homog .
*    lv_denominator = my_exp_cont-z_pressup_licit .

      lv_numerator = abap_off.
      lv_denominator = abap_off.
      IF lv_value_sense_iva IS NOT INITIAL.
        lv_numerator   = ls_cost_projecte-base.
        lv_denominator = my_exp_cont-z_pres_licit_b.
        ">> SPEC-76178, Inici Modificació - ETODR
        IF lv_has_tipol_econ = abap_on.
          lv_numerator   = ls_import_ofer_tipologies-import_var.  "ls_cost_projecte-base.
          lv_denominator = lv_presu_var_siva. "my_exp_cont-z_pres_licit_b.
        ENDIF.
        "<< SPEC-76178, Final Modificació - ETODR
      ELSEIF lv_value_sense_iva IS INITIAL.
        lv_numerator   =  ls_cost_projecte-total_homog.
        lv_denominator = my_exp_cont-z_pressup_licit.
        ">> SPEC-76178, Inici Modificació - ETODR
        IF lv_has_tipol_econ = abap_on.
          lv_numerator   = ls_import_ofer_tipologies-import_var_iva.  "ls_cost_projecte-total_homog.
          lv_denominator = lv_presu_var_iva. "my_exp_cont-z_pressup_licit.
        ENDIF.
        "<< SPEC-76178, Final Modificació - ETODR
      ENDIF.
      "<<<  SPEC-57843 Final Modificació ETXGL

      IF l_exclos   EQ 'X'
       AND im_sort_by NE 'BAIXA_INT'
       AND im_sort_by NE 'COST_INT'.
        CLEAR: ls_quadre3-baixa_homog,
               ls_quadre3-baixa_homog_int.
      ELSE.
        CALL METHOD get_quadre3_baixa
          EXPORTING
            im_numerator   = lv_numerator
            im_denominator = lv_denominator
          IMPORTING
            ex_baixa       = ls_quadre3-baixa_homog
            ex_baixa_int   = ls_quadre3-baixa_homog_int.
      ENDIF.


*-- Compleix i Compleix Homog.-------------------------------
      IF     l_exclos     EQ 'X'
         AND l_exclos_bis EQ space .
        CLEAR ls_quadre3-compleix .
      ELSE .
        IF <ls_oferta>-z_compleix_cond IS INITIAL .
          ls_quadre3-compleix = 'No' .
        ELSE .
          ls_quadre3-compleix = 'Sí' .
        ENDIF .

        IF <ls_oferta>-z_compleix_homog IS INITIAL .
          ls_quadre3-compleix_homog = 'No' .
        ELSE .
          ls_quadre3-compleix_homog = 'Sí' .
        ENDIF .
      ENDIF .

      IF my_exp_cont-z_req_homog IS INITIAL .
        ls_quadre3-compleix_homog = ls_quadre3-compleix .
      ENDIF .

      DEFINE _format_prorr_per .
        l_import_calcul = &2 * &1 / 100.
        _format_number: l_import_calcul &3 .
      END-OF-DEFINITION .

      DEFINE _format_prorr .
        l_import_calcul = &1 * &2.
        _format_number: l_import_calcul &3 .
      END-OF-DEFINITION .
* >> Inici Modif. SPEC-38097
*    Es consulta a la taula ZRM_DT_LIC_PER si hi ha un repartiment especial per aquesta licitació.
      CLEAR: l_proj, l_dir.", l_proj_aux, l_dir_aux.
      SELECT z_pcost_projecte z_pcost_direccio INTO (l_proj, l_dir)
                                               FROM zrm_dt_lic_per
                                              WHERE z_codi_exp = my_exp_cont-z_codi_exp.
      ENDSELECT.
      IF sy-subrc = 0.
*      l_proj = l_proj_aux.
*      l_dir = l_dir_aux.
*      l_proj = l_proj / 100.
*      l_dir  = l_dir  / 100.
        _format_prorr_per:  l_dir  ls_cost_projecte-base   ls_quadre3-cost_direccio_30,
                            l_dir  ls_cost_projecte-total  ls_quadre3-cost_direccio_30_total,
                            l_proj ls_cost_projecte-base   ls_quadre3-cost_projecte_70,
                            l_proj ls_cost_projecte-total  ls_quadre3-cost_projecte_70_total,

                            l_dir  ls_cost_projecte-base   ls_quadre3-cost_direccio_35,
                            l_dir  ls_cost_projecte-total  ls_quadre3-cost_direccio_35_total,
                            l_proj ls_cost_projecte-base   ls_quadre3-cost_projecte_65,
                            l_proj ls_cost_projecte-total  ls_quadre3-cost_projecte_65_total,

                            l_dir  ls_cost_projecte-base   ls_quadre3-cost_direccio_34,
                            l_dir  ls_cost_projecte-total  ls_quadre3-cost_direccio_34_total,
                            l_proj ls_cost_projecte-base   ls_quadre3-cost_projecte_66,
                            l_proj ls_cost_projecte-total  ls_quadre3-cost_projecte_66_total.
      ELSE.
* << Fi Modif. SPEC-38097
***>> INI OVB SPEC-36818 Modificar els tant per cents PE/DO
        IF my_exp_cont-z_subtipus_cont EQ 'PI'
          AND my_imp_cap-z_import_pec_b < 1000000 "INI MODIF ETODR 22.03.2016 SPEC-38725 "AND my_exp_cont-z_pres_licit_b < 1000000
          AND my_exp_cont-z_data_creacio > '20150923'.

          _format_prorr:  '0.20' ls_cost_projecte-base   ls_quadre3-cost_direccio_30,
                          '0.20' ls_cost_projecte-total  ls_quadre3-cost_direccio_30_total,
                          '0.80' ls_cost_projecte-base   ls_quadre3-cost_projecte_70,
                          '0.80' ls_cost_projecte-total  ls_quadre3-cost_projecte_70_total,

                          '0.20' ls_cost_projecte-base   ls_quadre3-cost_direccio_35,
                          '0.20' ls_cost_projecte-total  ls_quadre3-cost_direccio_35_total,
                          '0.80' ls_cost_projecte-base   ls_quadre3-cost_projecte_65,
                          '0.80' ls_cost_projecte-total  ls_quadre3-cost_projecte_65_total,
* inici SPEC-34500
                          '0.20' ls_cost_projecte-base   ls_quadre3-cost_direccio_34,
                          '0.20' ls_cost_projecte-total  ls_quadre3-cost_direccio_34_total,
                          '0.80' ls_cost_projecte-base   ls_quadre3-cost_projecte_66,
                          '0.80' ls_cost_projecte-total  ls_quadre3-cost_projecte_66_total.
* fin   SPEC-34500
        ELSE.
***>> FIN OVB
*-- Costos ---------------------------------------------------
          _format_prorr:  '0.30' ls_cost_projecte-base   ls_quadre3-cost_direccio_30,
                          '0.30' ls_cost_projecte-total  ls_quadre3-cost_direccio_30_total,
                          '0.70' ls_cost_projecte-base   ls_quadre3-cost_projecte_70,
                          '0.70' ls_cost_projecte-total  ls_quadre3-cost_projecte_70_total,
                          '0.35' ls_cost_projecte-base   ls_quadre3-cost_direccio_35,
                          '0.35' ls_cost_projecte-total  ls_quadre3-cost_direccio_35_total,
                          '0.65' ls_cost_projecte-base   ls_quadre3-cost_projecte_65,
                          '0.65' ls_cost_projecte-total  ls_quadre3-cost_projecte_65_total,
* inici SPEC-34500
                           '0.34' ls_cost_projecte-base   ls_quadre3-cost_direccio_34,
                           '0.34' ls_cost_projecte-total  ls_quadre3-cost_direccio_34_total,
                           '0.66' ls_cost_projecte-base   ls_quadre3-cost_projecte_66,
                           '0.66' ls_cost_projecte-total  ls_quadre3-cost_projecte_66_total.
* fin   SPEC-34500

***>> INI OVB SPEC-36818 Modificar els tant per cents PE/DO
        ENDIF.
***>> FIN OVB
      ENDIF. "SPEC-38097

      _format_number: <ls_oferta>-z_cost_obra_b    ls_quadre3-z_cost_obra,
                      <ls_oferta>-z_cost_obra      ls_quadre3-z_cost_obra_total,
                      <ls_oferta>-z_cost_proj_b    ls_quadre3-z_cost_projecte,
                      <ls_oferta>-z_cost_projecte  ls_quadre3-z_cost_projecte_total,
                      <ls_oferta>-z_cost_dir_b     ls_quadre3-z_cost_direccio,
                      <ls_oferta>-z_cost_direccio  ls_quadre3-z_cost_direccio_total.


*-- Terminis de projecte i obra ------------------------------
      ls_quadre3-z_termini_projecte = get_quadre3_durada( im_durada = <ls_oferta>-z_termini_proj
                                                          im_unit   = <ls_oferta>-z_unit_term_proj ).

      ls_quadre3-z_termini_obra = get_quadre3_durada( im_durada = <ls_oferta>-z_termini_obra
                                                      im_unit   = <ls_oferta>-z_unit_term_obra ).


*-- Crèdit ---------------------------------------------------
      WRITE my_exp_cont-z_max_credit TO ls_quadre3-credit DECIMALS 0.
      CONCATENATE ls_quadre3-credit '%' INTO ls_quadre3-credit.

*-- Termini del crèdit ---------------------------------------
      ls_quadre3-termini_credit = get_quadre3_durada( im_durada = my_exp_cont-z_durad_max_cred
                                                      im_unit   = my_exp_cont-z_un_max_cred ).

*-- Interès MIBOR/EURIBOR-------------------------------------
      IF <ls_oferta>-z_tipus_interes EQ 0 .
        ls_quadre3-int_mibor   = 'MIBOR' .
        ls_quadre3-int_euribor = 'EURIBOR' .
      ELSE .
        WRITE <ls_oferta>-z_tipus_interes TO l_char80 DECIMALS 2 LEFT-JUSTIFIED.
        CONCATENATE `M + ` l_char80 INTO ls_quadre3-int_mibor .
        CONCATENATE `E + ` l_char80 INTO ls_quadre3-int_euribor .
      ENDIF .

*-- Interès de compensació financera --------------------------
      WRITE <ls_oferta>-z_int_comp_fin TO l_char80 DECIMALS 2 LEFT-JUSTIFIED.
      CONCATENATE `E + ` l_char80 INTO ls_quadre3-int_comp_fin .

*-- Import de la compensació financera ------------------------
      _format_number: <ls_oferta>-z_imp_com_fin_b ls_quadre3-imp_comp_fin,
                      <ls_oferta>-z_imp_com_fin   ls_quadre3-imp_comp_fin_total .

*-- Baixa amb compensació financera ---------------------------
      IF      l_exclos    EQ 'X'
         AND  im_sort_by  NE 'BAIXA_COMP_FIN_INT'
         AND l_exclos_bis EQ space .
        CLEAR: ls_quadre3-baixa_comp_fin,
               ls_quadre3-baixa_comp_fin_int .
      ELSE .
        lv_numerator   = <ls_oferta>-z_imp_com_fin     + ls_cost_projecte-total .
        lv_denominator = my_exp_cont-z_import_comp_fi  + my_exp_cont-z_pressup_licit.
        CALL METHOD get_quadre3_baixa
          EXPORTING
            im_numerator   = lv_numerator
            im_denominator = lv_denominator
          IMPORTING
            ex_baixa       = ls_quadre3-baixa_comp_fin
            ex_baixa_int   = ls_quadre3-baixa_comp_fin_int.
      ENDIF .
*-- Cost financer ----------------------------------------------
      _format_number: <ls_oferta>-z_estalvi_fin_b ls_quadre3-cost_financer,
                      <ls_oferta>-z_estalvi_fin   ls_quadre3-cost_financer_total .

*-- Homogeneïtzat amb cost financer ----------------------------
      IF l_exclos EQ 'X' .
        ls_quadre3-homogeneitzat_cost_fin       = 'Exclòs'(001) .
        ls_quadre3-homogeneitzat_cost_fin_total = 'Exclòs'(001) .
      ELSE .
        l_import_calcul = ls_cost_projecte-base + <ls_oferta>-z_estalvi_fin_b .
        _format_number: l_import_calcul ls_quadre3-homogeneitzat_cost_fin .
        l_import_calcul = ls_cost_projecte-total + <ls_oferta>-z_estalvi_fin .
        _format_number: l_import_calcul ls_quadre3-homogeneitzat_cost_fin_total .
      ENDIF .

*-- Baixa amb cost financer ------------------------------------
      IF     l_exclos   EQ 'X'
         AND im_sort_by NE  'BAIXA_OFERTA_COST_FIN_INT'
         AND l_exclos_bis EQ space .
        CLEAR: ls_quadre3-baixa_oferta_cost_fin,
               ls_quadre3-baixa_oferta_cost_fin_int.
      ELSE .
        lv_numerator   = ls_cost_projecte-total + <ls_oferta>-z_estalvi_fin .
        lv_denominator = my_exp_cont-z_pressup_licit .
        CALL METHOD get_quadre3_baixa
          EXPORTING
            im_numerator   = lv_numerator
            im_denominator = lv_denominator
          IMPORTING
            ex_baixa       = ls_quadre3-baixa_oferta_cost_fin
            ex_baixa_int   = ls_quadre3-baixa_oferta_cost_fin_int.
      ENDIF .

*-- Homogeneïtzat amb compensació financera i cost financer -----
      IF l_exclos EQ 'X' .
        ls_quadre3-homogeneitzat_comp_fin       =  '(1)'. "'Exclòs'(001) . SPEC-43519
        ls_quadre3-homogeneitzat_comp_fin_total =  '(1)'. "'Exclòs'(001) . SPEC-43519
      ELSE .
        l_import_calcul = ls_cost_projecte-base + <ls_oferta>-z_estalvi_fin_b
                        + <ls_oferta>-z_imp_com_fin_b .
        _format_number: l_import_calcul ls_quadre3-homogeneitzat_comp_fin .
        l_import_calcul = ls_cost_projecte-total + <ls_oferta>-z_estalvi_fin
                        + <ls_oferta>-z_imp_com_fin .
        _format_number: l_import_calcul ls_quadre3-homogeneitzat_comp_fin_total .
      ENDIF .

*-- Baixa amb compensació financera i cost financer -------------
      IF     l_exclos   EQ 'X'
         AND im_sort_by NE 'BAIXA_COMP_FINANCERA_COST_INT'
         AND l_exclos_bis EQ space .
        CLEAR: ls_quadre3-baixa_comp_financera_cost,
               ls_quadre3-baixa_comp_financera_cost_int .
      ELSE .
        lv_numerator   = <ls_oferta>-z_imp_com_fin    + <ls_oferta>-z_estalvi_fin + ls_cost_projecte-total .
        lv_denominator = my_exp_cont-z_import_comp_fi + my_exp_cont-z_pressup_licit .
        CALL METHOD get_quadre3_baixa
          EXPORTING
            im_numerator   = lv_numerator
            im_denominator = lv_denominator
          IMPORTING
            ex_baixa       = ls_quadre3-baixa_comp_financera_cost
            ex_baixa_int   = ls_quadre3-baixa_comp_financera_cost_int.
      ENDIF .
**  >> INI MODIF ETODR SPEC-49075
      IF my_exp_cont-z_llei92017 = abap_on AND my_exp_cont-z_obert_preu = abap_off.
        "Per la nova llei, i expedients de licitació oberts no preu, es calcula el valor de la puntuació econòmica per a mostar-lo al Quadre 3A a la columna PUNTS
        LOOP AT lt_punt_gen ASSIGNING FIELD-SYMBOL(<fs_punt_oferta>) WHERE z_num_gen = <ls_oferta>-z_num_ofer.
          ">> SPEC-70464, Inici Modificació - ETODR
*        ls_quadre3-z_punt_econ = <fs_punt_oferta>-z_punts.
          _format_number: <fs_punt_oferta>-z_punts ls_quadre3-z_punt_econ .
          "<< SPEC-70464, Final Modificació - ETODR
        ENDLOOP.
      ENDIF.
**  << FI MODIF ETODR SPEC-49075

**  >> INI MODIF ETODR SPEC-51404
      IF <ls_oferta>-z_exclos_s3_postob = abap_on
*** INI SPEC-54639
        OR ( my_exp_cont-z_obert_simpl EQ 'D' AND <ls_oferta>-z_exclos_s2 EQ 'X' AND im_obertura IS INITIAL ).
*** FI SPEC-54639
        "   >>>SPEC-55774, Inici modificació  - ETODR
        CONCATENATE ls_quadre3-empresa ' (1)' INTO ls_quadre3-empresa RESPECTING BLANKS.
*      CONCATENATE '(1) ' ls_quadre3-empresa INTO ls_quadre3-empresa RESPECTING BLANKS.
        "   <<<SPEC-55774, Final modificació - ETODR
        ">> SPEC-70464, Inici Modificació - ETODR
*      ls_quadre3-z_punt_econ       = '0.00'.
        _format_number: '0,00' ls_quadre3-z_punt_econ .
        "<< SPEC-70464, Final Modificació - ETODR
        ls_quadre3-baixa_homog       = ls_quadre3-baixa     = ls_quadre3-baixa_part_variable = 'Exclòs'.
**INI PRL :: SPEC-85099
*      ls_quadre3-BAIXA_Z_BOI = 'Exclòs'.
**FIN PRL :: SPEC-85099
        ls_quadre3-compleix_homog    = ls_quadre3-compleix  = space.
      ENDIF.
**  << FI MODIF ETODR SPEC-51404

*>> Inici Modificació ECJMS SPEC-64927 01/12/2021

      IF  <ls_oferta>-z_baixa_pbr EQ 0.
        CLEAR ls_quadre3-baixa_preu_banc_ref.
      ELSE.
        WRITE <ls_oferta>-z_baixa_pbr TO ls_quadre3-baixa_preu_banc_ref.
        CONDENSE ls_quadre3-baixa_preu_banc_ref NO-GAPS.
        CONCATENATE ls_quadre3-baixa_preu_banc_ref '%'
               INTO ls_quadre3-baixa_preu_banc_ref SEPARATED BY space.
      ENDIF.

*>> Fi Modificació ECJMS SPEC-64927 01/12/2021

      APPEND ls_quadre3 TO <lt_quadre3> .
    ENDLOOP .

    IF im_sort_by EQ 'COST_INT' .

      IF my_exp_cont-z_obert_simpl EQ 'D'.
        ASSIGN <lt_quadre3> TO <lt_quadre3_aux> .
        LOOP AT <lt_quadre3> ASSIGNING <ls_quadre3> WHERE baixa = 'Exclòs'.
          <ls_quadre3>-cost_int = 0.
        ENDLOOP.
      ENDIF.

      SORT <lt_quadre3> BY cost_int ASCENDING .
*
*    IF my_exp_cont-z_obert_simpl EQ 'D'.
**      ASSIGN <lt_quadre3> TO <lt_quadre3_aux> .
*      LOOP AT <lt_quadre3> ASSIGNING <ls_quadre3> WHERE baixa = 'Exclòs'.
*        READ TABLE  <lt_quadre3_aux> ASSIGNING <ls_quadre3> WITH KEY proveidor = <ls_quadre3>-proveidor.
*      ENDLOOP.
*    ENDIF.
    ELSE .
      SORT <lt_quadre3> BY (im_sort_by) DESCENDING .
    ENDIF .

*-- El número d'agrupador d'empreses s'ha de mantenir coherent per al quadre base
*-- i el quadre variant. Aixó que calculem el Quadre sencer i després descartem el
*-- que no necessitem
    LOOP AT <lt_quadre3> INTO ls_quadre3 .
      READ TABLE lt_ofertes ASSIGNING <ls_oferta> WITH TABLE KEY z_num_ofer = ls_quadre3-z_num_ofer .
      CHECK NOT <ls_oferta>-all_konzs IS INITIAL .
      LOOP AT <ls_oferta>-all_konzs INTO l_last_konzs .
        READ TABLE lt_group TRANSPORTING NO FIELDS WITH TABLE KEY table_line = l_last_konzs .
        CHECK sy-subrc NE 0 .
        INSERT l_last_konzs INTO TABLE lt_group .
      ENDLOOP .
    ENDLOOP .

    LOOP AT <lt_quadre3> INTO ls_quadre3 .
      CLEAR l_prefix .
      CLEAR l_prefix_homog.
      READ TABLE lt_ofertes ASSIGNING <ls_oferta> WITH TABLE KEY z_num_ofer = ls_quadre3-z_num_ofer .
      LOOP AT <ls_oferta>-all_konzs INTO l_last_konzs .
        READ TABLE lt_group TRANSPORTING NO FIELDS WITH TABLE KEY table_line = l_last_konzs .
        l_num_grup = sy-tabix .
        CONDENSE l_num_grup .
        CONCATENATE l_prefix ` (` l_num_grup `) ` INTO l_prefix .
        l_prefix_homog = l_prefix.

* El camp COMPLEIX i COMPLEIX_HOMOG només ha d'aparèixer informat pel primer component d'un grup d'empreses.
* Per a la resta ha de sortir en blanc. Quan l'empresa pertany a més d'un grup d'empreses el camp s'informa si és
* la primera vegada que apareix per a qualssevol del grups als que pertany
        IF ls_quadre3-z_tipus_oferta EQ im_tipus_oferta .
          READ TABLE lt_group_compleix TRANSPORTING NO FIELDS WITH TABLE KEY table_line = l_last_konzs .
          IF sy-subrc EQ 0 .
            CLEAR: ls_quadre3-compleix,
                   ls_quadre3-compleix_homog .
            MODIFY <lt_quadre3> FROM ls_quadre3 TRANSPORTING compleix compleix_homog.
          ELSE .
            INSERT l_last_konzs INTO TABLE lt_group_compleix .
          ENDIF .
*        READ TABLE lt_group_compleix_homog TRANSPORTING NO FIELDS WITH TABLE KEY table_line = l_last_konzs .
*        IF sy-subrc EQ 0 .
*          CLEAR ls_quadre3-compleix_homog .
*          MODIFY <lt_quadre3> FROM ls_quadre3 TRANSPORTING compleix_homog .
*        ELSE .
*          INSERT l_last_konzs INTO TABLE lt_group_compleix_homog .
*        ENDIF .
        ENDIF .
      ENDLOOP .
** >> INI MODIF SPEC-33452
      IF lv_form_temeritat <> 'TX1' AND im_obertura IS INITIAL.
        IF  lv_conv_ob_preu IS NOT INITIAL.
          IF  <ls_oferta>-z_presump_temer EQ 'X' .
*** JGG  SPEC-SPEC-70464  -->
            IF my_exp_cont-z_proc_adj <> 'CE'.
*** JGG  SPEC-SPEC-70464  <--
*INSERT EVME SPEC-92330 El quadre 2 de la licitació CT1079348 no consta cap i 07/05/2025
*OLD
*            IF lv_obert_simpl EQ 'S'. " SPEC-78453 ECAGM només sortirà asterisc de temeritat si es simplificats criteri preu
*              CONCATENATE `(*) ` l_prefix INTO l_prefix .
*            ENDIF.
*NEW
              CONCATENATE `(*) ` l_prefix INTO l_prefix .
*INSERT EVME SPEC-92330 El quadre 2 de la licitació CT1079348 no consta cap i 07/05/2025
*** JGG  SPEC-SPEC-70464  -->
            ENDIF.
*** JGG  SPEC-SPEC-70464  <--

          ENDIF .
*        ENDIF.
** >> INI MODIF ECGMG SPEC-55720
        ELSEIF lv_obert_simpl EQ 'S'.
          IF  <ls_oferta>-z_presump_temer EQ 'X' .
*** JGG  SPEC-SPEC-70464  -->
            IF my_exp_cont-z_proc_adj <> 'CE'.
*** JGG  SPEC-SPEC-70464  <--

              CONCATENATE `(*) ` l_prefix INTO l_prefix .
*** JGG  SPEC-SPEC-70464  -->
            ENDIF.
*** JGG  SPEC-SPEC-70464  <--

          ENDIF .
** >> FIM MODIF ECGMG SPEC-55720
        ELSEIF lv_obert_simpl IS INITIAL.

          IF  <ls_oferta>-z_presump_temer EQ 'X' .
*** JGG  SPEC-SPEC-70464  -->
            IF my_exp_cont-z_proc_adj <> 'CE'.
*** JGG  SPEC-SPEC-70464  <--
** INI SPEC-78453  ECAGM només es marca temeritat en quadre 3A si es simplificat criteri preu ( lv_obert_simpl EQ 'S' )
*            CONCATENATE `(*) ` l_prefix INTO l_prefix .
** END SPEC-78453
*** JGG  SPEC-SPEC-70464  -->
            ENDIF.
*** JGG  SPEC-SPEC-70464  <--

          ENDIF .

          IF ( <ls_oferta>-z_import_homog IS NOT INITIAL AND <ls_oferta>-z_pres_tem_homog EQ 'X').
*** JGG  SPEC-SPEC-70464  -->
            IF my_exp_cont-z_proc_adj <> 'CE'.
*** JGG  SPEC-SPEC-70464  <--
              IF lv_obert_simpl EQ 'S'. " SPEC-78453 ECAGM només sortirà asterisc de temeritat si es simplificats criteri preu
                CONCATENATE `(*) ` l_prefix_homog INTO l_prefix_homog .
              ENDIF.
*** JGG  SPEC-SPEC-70464  -->
            ENDIF.
*** JGG  SPEC-SPEC-70464  <--

          ENDIF.
        ENDIF.

      ENDIF.
**  << FI MODIF SPEC-33452
      l_empresa = ls_quadre3-empresa.

      CONCATENATE l_prefix l_empresa INTO ls_quadre3-empresa.
      CONDENSE ls_quadre3-empresa.
      MODIFY <lt_quadre3> FROM ls_quadre3 TRANSPORTING empresa .

      IF my_exp_cont-z_req_homog IS INITIAL .
        ls_quadre3-empresa_homog = ls_quadre3-empresa .
      ELSE .
        CONCATENATE l_prefix_homog l_empresa INTO ls_quadre3-empresa_homog.
        CONDENSE ls_quadre3-empresa_homog.
      ENDIF .
      MODIFY <lt_quadre3> FROM ls_quadre3 TRANSPORTING empresa_homog .
    ENDLOOP .

    DELETE <lt_quadre3> WHERE z_tipus_oferta NE im_tipus_oferta .

*--- Taula de Vincles -----------------------------------------------------------

* Hem de tenir en compte les ofertes (base o variant) de proveïdor pertanyents a grups
* d'empreses però només si un altre integrant del grup també presenta oferta
* Una empresa que sigui UTE s'ha d'avaluar una vegada per cada Grup d'empreses a la que
* pertany (potencialment: el grup de la UTE i el grup de cadascun dels seus components)
    CALL METHOD get_vincles
      EXPORTING
        im_ofertes   = lt_ofertes
        im_group     = lt_group
        im_req_homog = my_exp_cont-z_req_homog
      CHANGING
        ch_vincles   = <lt_vincle>.
  ENDMETHOD.


  METHOD get_quadre3_baixa.
    DATA: l_char80 TYPE char80 .
    IF im_denominator EQ 0 .
      ex_baixa_int = -1 .
    ELSE .
      ex_baixa_int = 100 * ( 1 - ( im_numerator / im_denominator ) ) .
    ENDIF .
    WRITE ex_baixa_int TO l_char80 LEFT-JUSTIFIED DECIMALS 2.
    ex_baixa = l_char80 .
  ENDMETHOD.


  METHOD get_quadre3_durada.
    DATA: l_literal TYPE string,
          l_char80  TYPE char80.

    IF im_durada NE 1 .
      CASE im_unit .
        WHEN zrm_cl_time_utils=>co_rms_dia .      l_literal = `dies` .
        WHEN zrm_cl_time_utils=>co_rms_setmana .  l_literal = `setmanes` .
        WHEN zrm_cl_time_utils=>co_rms_any  .     l_literal = `anys` .
        WHEN OTHERS .                             l_literal = `mesos` .
      ENDCASE .
    ELSE .
      CASE im_unit .
        WHEN zrm_cl_time_utils=>co_rms_dia .      l_literal = `dia` .
        WHEN zrm_cl_time_utils=>co_rms_setmana .  l_literal = `setmana` .
        WHEN zrm_cl_time_utils=>co_rms_any  .     l_literal = `any` .
        WHEN OTHERS .                             l_literal = `mes` .
      ENDCASE .
    ENDIF .


    IF frac( im_durada ) EQ 0 .
      WRITE im_durada TO l_char80 LEFT-JUSTIFIED DECIMALS 0 .
    ELSE .
      WRITE im_durada TO l_char80 LEFT-JUSTIFIED .
    ENDIF .

    CONCATENATE l_char80 l_literal
           INTO re_string
         SEPARATED BY space .

  ENDMETHOD.


  METHOD get_quadre5.
    CONSTANTS: lc_quadre_req TYPE c VALUE '4'.

    DATA: lt_ofertes    TYPE ty_t_oferta,
          lt_quadre5    TYPE ty_t_quadre5,
          lt_valoracion TYPE ty_t_quadre5,
          ls_quadre5    TYPE zerm_quadre5,
          lt_ofertas    TYPE ztt_oferta,
          lwa_oferta2   LIKE LINE OF lt_ofertas,
          lwa_oferta    LIKE LINE OF lt_ofertas.

    DATA:
      lv_index TYPE i,
      lv_casoa TYPE xfeld,
      lv_casob TYPE xfeld,
      lv_casoc TYPE xfeld,
      lv_casod TYPE xfeld,
      lv_casoe TYPE xfeld. "SPEC-52625

*>> Inici Modificació ECJMS SPEC-64927 01/12/2021
*    DATA: is_zrm_dm_docs TYPE  zrm_dm_docs.
*>> Fi Modificació ECJMS SPEC-64927 01/12/2021

    FIELD-SYMBOLS: <fs_quadre5> TYPE ty_t_quadre5,
                   <my_cached>  TYPE REF TO data,
                   <fs>         TYPE any.


    ASSIGN my_quadre5 TO <my_cached>.
    CREATE DATA <my_cached> TYPE ty_t_quadre5.
    ASSIGN <my_cached>->* TO <fs_quadre5>.

    CALL METHOD get_ofertes
      EXPORTING
        im_docclass = im_docclass
        im_objectid = im_objectid
      IMPORTING
        ex_ofertes  = DATA(lt_ofertes_aux).

    DELETE  lt_ofertes_aux WHERE z_sel_req IS INITIAL.

    SELECT ofe~docclass
           ofe~objectid
           ofe~proveidor
           ofe~z_num_ofer
           ofe~z_tipus_oferta
           doc~z_agrup_doc
           doc~z_motiu_esmena
           val~zprovcompute
           val~z_num_doc
           val~z_lliurat_req
           val~z_correcte_req
           val~z_esmenat_req
           val~z_exclos_s1s2
           val~z_excl_pos_esm
           ofe~z_exclos_s3   "EDASB 22/06/07
           ofe~z_temerari    "EDASB 22/06/07
           ofe~z_excl_homog  "EDASB 22/06/07
           ofe~z_import_homog    "EDASB 13/11/07
           ofe~z_presump_temer   "EDASB 13/11/07
           ofe~z_pres_tem_homog  "EDASB 13/11/07
           ofe~z_exclos_s2
           ofe~z_tipus_exc_s2
           ofe~z_exclos_req
           ofe~z_pres_proposta " EDLSM 07/01/10
           val~z_no_aplica_req "ETODR SPEC-49881
    INTO TABLE lt_ofertas
          FROM zrm_dt_ofertes        AS ofe
    INNER JOIN zrm_dt_val_crit AS val
            ON ofe~docclass    EQ val~docclass AND
               ofe~objectid    EQ val~objectid AND
               ofe~z_num_ofer  EQ val~z_num_ofer
    INNER JOIN zrm_dm_sobres   AS sob
            ON val~z_tipus_sob EQ sob~z_tipus_sob
    INNER JOIN zrm_dm_docs     AS doc
            ON val~z_num_doc   EQ doc~z_num_doc
    INNER JOIN zrm_dm_agr_docq AS agr
            ON doc~z_agrup_doc EQ agr~z_agrup_doc
         WHERE ofe~docclass    EQ im_docclass   AND
               ofe~objectid    EQ im_objectid   AND
               sob~z_num_sob   EQ lc_quadre_req AND
               agr~z_num_sob   EQ lc_quadre_req.

    SORT lt_ofertes_aux BY z_punt_total DESCENDING.
*    ENDIF.
    LOOP AT lt_ofertes_aux INTO DATA(ls_ofertes) WHERE z_exclos_s1        EQ abap_false AND
                                                       z_exclos_s2        EQ abap_false AND
                                                       z_exclos_s3        EQ abap_false AND
                                                       z_exclos_s3_postob EQ abap_false AND
                                                       z_renun_ofert      EQ abap_false AND
                                                       z_exclos_plec      EQ abap_false AND
                                                       z_exclos_req       EQ abap_false.
*      DESCRIBE TABLE lt_quadre5 LINES DATA(lv_lines).
*      IF lv_lines < lv_num_of_max_mostrar.
      CLEAR: ls_quadre5.
      ls_quadre5-proveidor      = ls_ofertes-proveidor.
      ls_quadre5-z_num_ofer     = ls_ofertes-z_num_ofer.
      ls_quadre5-z_tipus_oferta = ls_ofertes-z_tipus_oferta.
      ls_quadre5-nom_proveidor  = ls_ofertes-nom_proveidor.
      ls_quadre5-num_variant    = ls_ofertes-z_num_variant.

      LOOP AT lt_ofertas INTO lwa_oferta
        WHERE num_ofer  = ls_ofertes-z_num_ofer AND
              proveidor = ls_ofertes-proveidor.

        lwa_oferta2 = lwa_oferta.

*   Agrupador
        AT NEW agrupador.
*   Caso A: Primera oferta
          IF ( lwa_oferta2-lliurat  EQ 'X' AND
          lwa_oferta2-correcte EQ 'X' ) OR
          lwa_oferta2-esmenat  EQ 'X'.
            lv_casoa = 'X'.
          ENDIF.

*>> Inici Modificació ECJMS SPEC-64927 01/12/2021
*          SELECT SINGLE * INTO is_zrm_dm_docs FROM zrm_dm_docs
*          WHERE z_num_doc   EQ lwa_oferta2-num_doc   AND
*                z_agrup_doc EQ lwa_oferta2-agrupador AND
*                z_num_sob   EQ '4'.
*
*          IF sy-subrc EQ 0.
*            CASE lwa_oferta2-agrupador.
*              WHEN '16'. ls_quadre5-cap_sol_sdce  = 'Sí'.
*              WHEN '17'. ls_quadre5-mitjans_mater = 'Sí'.
*            ENDCASE.
*          ENDIF.
*>> Fi Modificació ECJMS SPEC-64927 01/12/2021

        ENDAT.
*   Caso A: Todos los registros cumplen que...
        IF lv_casoa EQ 'X' AND
        ( ( lwa_oferta2-lliurat  EQ 'X' AND
        lwa_oferta2-correcte EQ 'X' ) OR
        lwa_oferta2-esmenat  EQ 'X' ).
          lv_casoa = 'X'.
        ELSE.
          CLEAR lv_casoa.
        ENDIF.
*   Caso B: Algún registro cumple que...
        IF ( lwa_oferta-correcte IS INITIAL OR
        lwa_oferta-correcte EQ space ) AND
        ( lwa_oferta-esmenat IS INITIAL OR
        lwa_oferta-esmenat EQ space ) AND
        ( lwa_oferta-exclos_s1s2 IS INITIAL OR
        lwa_oferta-exclos_s1s2 EQ space ) AND
        ( lwa_oferta-excl_pos_esm IS INITIAL OR
        lwa_oferta-excl_pos_esm EQ space )
**     >> INI MODIF ETODR SPEC-52625
        AND ( lwa_oferta-z_no_aplica IS INITIAL OR lwa_oferta-z_no_aplica EQ space ).
**     << FI MODIF ETODR SPEC-52625
          IF lv_casob IS INITIAL.
            lv_casob = 'X'.
          ENDIF.

        ENDIF.
*   Caso C: Algún registro cumple que...
        IF ( lwa_oferta-exclos_s1s2  EQ 'X' OR
        lwa_oferta-excl_pos_esm EQ 'X' ) AND
        lv_casoc IS INITIAL.
          lv_casoc = 'X'.
        ENDIF.
*   Caso D: Si está excluida por sobre 2 todos los agrupadores estarán excluidos
        IF lwa_oferta-z_exclos_s2 EQ 'X' AND
        ( lwa_oferta-z_tipus_exc_s2 = 'GE' OR
        lwa_oferta-z_tipus_exc_s2 = 'OB' ).
          lv_casod = 'X'.
        ENDIF.
**    >> INI MODIF ETODR SPEC-52625
        "Cas E: Algun registre compleix que...
        IF lwa_oferta-z_no_aplica EQ 'X' AND lv_casoe IS INITIAL.
          lv_casoe = 'X'.
        ENDIF.
**    << FI MODIF ETODR SPEC-52625

*   Agrupador
        AT END OF agrupador.
          lv_index = lwa_oferta2-agrupador.
          ADD 5 TO lv_index.
          ASSIGN COMPONENT lv_index OF STRUCTURE ls_quadre5 TO <fs>.
          IF lv_casoa EQ 'X'.
            <fs> = 'Sí'.
          ENDIF.
          IF lv_casob EQ 'X'.
            <fs> = 'No'.
          ENDIF.
          IF lv_casoc EQ 'X'.
            <fs> = 'Exclòs'.
          ENDIF.
          IF lv_casod EQ 'X'.
            <fs> = 'Exclòs'.
          ENDIF.
**    >> INI MODIF ETODR SPEC-52625
          IF lv_casoe EQ 'X'.
            <fs> = 'NA'.
          ENDIF.
          CLEAR: lv_casoe.
**    << FI MODIF ETODR SPEC-52625
          CLEAR: lv_casoa, lv_casob, lv_casoc.
        ENDAT.

      ENDLOOP.
      APPEND ls_quadre5 TO lt_quadre5.
*      ENDIF.
    ENDLOOP.

    <fs_quadre5> = lt_quadre5.

    ex_data = <my_cached>.
  ENDMETHOD.


  METHOD get_quadrecp3.

    DATA: lt_quadrecp3          TYPE ty_t_quadrecp3,
          ls_quadrecp3          TYPE zerm_quadrecp3,
          lt_ofertes            TYPE TABLE OF zrm_dt_ofertes,
          lv_cost_part_variable TYPE zrm_dt_ofer_tip-import,
          lv_cost_part_fixa     TYPE zrm_dt_ofer_tip-import,
          l_char80              TYPE char80,
          ls_vendor             TYPE ty_s_proveidor.

    FIELD-SYMBOLS: <fs_quadrecp3> TYPE ty_t_quadrecp3,
                   <my_cached>    TYPE REF TO data.

    ASSIGN my_quadrecp3 TO <my_cached>.
    CREATE DATA <my_cached> TYPE ty_t_quadrecp3.
    ASSIGN <my_cached>->* TO <fs_quadrecp3>.

    SELECT *
      FROM zrm_dt_ofertes
    INTO TABLE lt_ofertes
      WHERE docclass = my_exp_cont-docclass
      AND objectid = my_exp_cont-objectid
      AND z_excl_homog = abap_false
      AND z_exclos_s3 = abap_false
      AND z_codi_excl_s3 = abap_false
      AND z_exclos_s1 = abap_false
      AND z_excl_punt_tec = abap_false
      AND z_exc_relrol = abap_false
      AND z_exclos_clau = abap_false
      AND z_exclos_s2 = abap_false
      AND z_exclos_var_tec = abap_false
      AND z_excl_solv_tec = abap_false
      AND z_exclos_s3_postob = abap_false
      AND z_exclos_req = abap_false
      AND z_exclos_plec = abap_false
      AND z_exclos_carrecs = abap_false
      AND z_exclos_po_pt = abap_false
      AND z_renun_ofert = abap_false
      AND z_temerari = abap_false
*      >>>SPEC:65648, Inici modificació  - ECACM
      AND z_exclos_cont_s3_a_s2 = abap_false.
*>>>SPEC:65648, Inici modificació  - ECACM

*<< INI MOD ECGMG SPEC-58276
    SORT lt_ofertes BY z_imp_oferta_b ASCENDING.
*<< FIN MOD ECGMG SPEC-58276

    LOOP AT lt_ofertes ASSIGNING FIELD-SYMBOL(<ls_oferta>).
      CLEAR: ls_quadrecp3,
             ls_vendor.

      ls_vendor = me->complete_vendor_data( <ls_oferta>-proveidor ).
      ls_quadrecp3-proveidor = ls_vendor-nom_proveidor.

      _format_number: <ls_oferta>-z_termini_exec ls_quadrecp3-termini_execucio,
                      <ls_oferta>-z_imp_oferta_b ls_quadrecp3-cost,
                      <ls_oferta>-z_boi ls_quadrecp3-baixa_homog.

      CALL METHOD get_tipol_variable
        EXPORTING
          im_docclass = my_exp_cont-docclass
          im_objectid = my_exp_cont-objectid
        RECEIVING
          ex_data     = DATA(lr_is_tipol_variable).
      IF lr_is_tipol_variable IS BOUND.
        ASSIGN lr_is_tipol_variable->* TO FIELD-SYMBOL(<fs_is_tipol_variable>) .
        IF sy-subrc = 0.
          IF <fs_is_tipol_variable> IS ASSIGNED AND <fs_is_tipol_variable> = abap_on.
            CALL METHOD get_imp_tip_variable_oferta
              EXPORTING
                im_docclass = my_exp_cont-docclass
                im_objectid = my_exp_cont-objectid
                im_num_ofer = <ls_oferta>-z_num_ofer
              RECEIVING
                ex_data     = DATA(lr_cost_part_variable).
            IF lr_cost_part_variable IS BOUND.
              ASSIGN lr_cost_part_variable->* TO FIELD-SYMBOL(<fs_cost_part_variable>) .
              IF sy-subrc = 0.
                lv_cost_part_variable = <fs_cost_part_variable>.
                _format_number: lv_cost_part_variable ls_quadrecp3-cost_part_variable.
              ENDIF.
            ENDIF.

            CALL METHOD get_imp_tip_fix_oferta
              EXPORTING
                im_docclass = my_exp_cont-docclass
                im_objectid = my_exp_cont-objectid
                im_num_ofer = <ls_oferta>-z_num_ofer
              RECEIVING
                ex_data     = DATA(lr_cost_part_fixa).
            IF lr_cost_part_fixa IS BOUND.
              ASSIGN lr_cost_part_fixa->* TO FIELD-SYMBOL(<fs_cost_part_fixa>) .
              IF sy-subrc = 0.
                lv_cost_part_fixa = <fs_cost_part_fixa>.
                _format_number: lv_cost_part_fixa ls_quadrecp3-cost_part_fixa.
              ENDIF.
            ENDIF.

          ENDIF.
        ENDIF.
      ENDIF.
      APPEND ls_quadrecp3 TO lt_quadrecp3.
    ENDLOOP.

    <fs_quadrecp3> = lt_quadrecp3.

    ex_data = <my_cached>.


  ENDMETHOD.


  METHOD get_quadre_2a_cp.
    DEFINE _format_number .
      write &1 to l_char80 decimals 2 left-justified .  "#EC UOM_IN_MES
      &2 = l_char80 .
    END-OF-DEFINITION .

    TYPES: ty_t_quadre3 TYPE STANDARD TABLE OF zerm_quadre3
                        WITH NON-UNIQUE DEFAULT KEY .
    DATA: lt_ofertes     TYPE ty_t_oferta,
          l_recalculate  TYPE xfeld,
          ls_quadre3     TYPE LINE OF ty_t_quadre3,
          lv_numerator   TYPE zrm_dt_exp_cont-z_pres_licit_b,
          lv_denominator TYPE zrm_dt_exp_cont-z_pres_licit_b,
          l_char80       TYPE char80,
          BEGIN OF ls_cost_projecte,
            base        TYPE zrm_dt_ofertes-z_imp_homog_b,
            total       TYPE zrm_dt_ofertes-z_import_homog,
            total_homog TYPE zrm_dt_ofertes-z_import_homog,
          END OF ls_cost_projecte,
          l_import_calcul       TYPE zrm_dt_ofertes-z_imp_homog_b,
          l_exclos              TYPE xfeld,
          l_exclos_bis          TYPE xfeld,
          ls_quadre3_cache      TYPE ty_s_quadre3_cache,
          l_last_konzs          TYPE lfa1-konzs,
          lt_valcrit            TYPE ty_t_valcrit,
          lt_group              TYPE TABLE OF konzs,
          lt_group_compleix     TYPE HASHED TABLE OF konzs WITH UNIQUE DEFAULT KEY,
          l_num_grup            TYPE string,
          l_prefix              TYPE string,
          l_prefix_homog        TYPE string,
          l_empresa             TYPE string,
          lv_cost_part_variable TYPE zrm_dt_ofer_tip-import, "SPEC-51404
          lv_cost_part_fixa     TYPE zrm_dt_ofer_tip-import, "SPEC-49881
          lv_value_sense_iva    TYPE zsap_de_value.           " SPEC-57843 ETXGL

    ">>>  SPEC-57843 Inici Modificació ETXGL
    CONSTANTS: co_programa   TYPE char30 VALUE 'CALCULATE_NOUS_PLECS_BLIM',
               co_nom_fitxer TYPE char16 VALUE 'CALC_SENSE_IVA'.
    "<<<  SPEC-57843 Final Modificació ETXGL

    FIELD-SYMBOLS: <lt_quadre3> TYPE ty_t_quadre3,
                   <lt_vincle>  TYPE ty_t_vincle,
                   <ls_oferta>  TYPE ty_s_oferta,
                   <ls_valcrit> TYPE ty_s_valcrit.

**>> INI MODIF SPEC-33452
    DATA: lv_num_plec       TYPE z_num_plec,
          lv_form_temeritat TYPE z_form_temeritat.
**<< FI MODIF SPEC-33452
* >> Inici Modif. SPEC-38097
** INI ETOVB SPEC-48224
    DATA: l_dir  TYPE z_per_dir,
          l_proj TYPE z_per_proj.
*        l_dir_aux  TYPE z_per_dir,
*        l_proj_aux TYPE z_per_proj.
*  DATA: l_dir  TYPE decf,
*        l_proj TYPE z_per_proj.
** FIN ETOVB   SPEC-48224
* << Fi Modif. SPEC-38097

    ls_quadre3_cache-sort_by      = im_sort_by .
    ls_quadre3_cache-tipus_oferta = im_tipus_oferta .
    READ TABLE my_quadre3_cache INTO ls_quadre3_cache FROM ls_quadre3_cache .

    IF     sy-subrc EQ 0
       AND ls_quadre3_cache-quadre IS BOUND .
      ex_quadre  = ls_quadre3_cache-quadre .
      ex_vincles = ls_quadre3_cache-vincles .
      RETURN .
    ENDIF .

    CREATE DATA ls_quadre3_cache-quadre  TYPE ty_t_quadre3 .
    CREATE DATA ls_quadre3_cache-vincles TYPE ty_t_vincle .
    INSERT ls_quadre3_cache INTO TABLE my_quadre3_cache .

    ex_quadre = ls_quadre3_cache-quadre .
    ASSIGN ex_quadre->* TO <lt_quadre3> .

    ex_vincles = ls_quadre3_cache-vincles .
    ASSIGN ex_vincles->* TO <lt_vincle> .

    CALL METHOD get_valcrit
      EXPORTING
        im_docclass = im_docclass
        im_objectid = im_objectid
      IMPORTING
        ex_valcrit  = lt_valcrit.

    CALL METHOD get_ofertes
      EXPORTING
        im_docclass = im_docclass
        im_objectid = im_objectid
      IMPORTING
        ex_ofertes  = lt_ofertes.

    DELETE lt_ofertes WHERE z_temerari EQ 'X'.

**  >> INI ETKAN 08/09/2015 P100031
    IF my_exp_cont-z_proc_adj   EQ 'NP' OR
     ( my_exp_cont-z_proc_adj   EQ 'NF' AND
       my_exp_cont-z_negociacio IS NOT INITIAL ).

      IF  my_exp_cont-z_estat    EQ 'ZN1' AND lt_ofertes IS NOT INITIAL.
        DELETE lt_ofertes WHERE z_renun_ofert IS NOT INITIAL.
      ENDIF.

      IF  my_exp_cont-z_estat    EQ 'ZN2' AND lt_ofertes IS NOT INITIAL.
        DELETE lt_ofertes WHERE z_sel_2volta IS INITIAL.
      ENDIF.

    ENDIF.
**  >> FIN ETKAN P100031

**>>  INI MODIF SPEC-33452
    SELECT SINGLE z_num_plec
      FROM zrm_dt_exp_cont
      INTO lv_num_plec
      WHERE docclass  = im_docclass
        AND objectid  = im_objectid.

    SELECT SINGLE z_form_temeritat
      FROM zrm_dm_plecs
      INTO lv_form_temeritat
      WHERE z_num_plec = lv_num_plec.
**<< FI MODIF SPEC-33452

***>>> INICI Modif SPEC-43519 ETXGL
    DELETE lt_ofertes WHERE z_exclos_s3 EQ 'X'
                 AND z_exclos_s3_postob NE 'X'.
***<<< FI Modif SPEC-43519 ETXGL

**<< FI MODIF SPEC-33452
    IF sy-subrc EQ 0 .
      l_recalculate = 'X' .
    ENDIF .
* <== EDLSM 07/01/10
    IF my_exp_cont-z_proc_adj = 'CR'.
      DELETE lt_ofertes WHERE z_pres_proposta NE 'X'.
      IF sy-subrc EQ 0 .
        l_recalculate = 'X' .
      ENDIF .
    ENDIF.
* ==> EDLSM 07/01/10

    IF my_exp_cont-z_rd817_2009 IS NOT INITIAL. " Si és Reial Decret RD817_2009
      DELETE lt_ofertes WHERE z_exclos_s2 EQ 'X' .
      IF sy-subrc EQ 0 .
        l_recalculate = 'X' .
      ENDIF .
      DELETE lt_ofertes WHERE z_excl_punt_tec EQ 'X'.
      IF sy-subrc EQ 0 .
        l_recalculate = 'X' .
      ENDIF .
    ENDIF.

**  >> INI MODIF ETODR SPEC-49075
    IF my_exp_cont-z_llei92017 = abap_on AND my_exp_cont-z_obert_preu = abap_off.
      "Per la nova llei, i expedients de licitació oberts no preu, es calcula el valor de la puntuació econòmica per a mostar-lo al Quadre 3A a la columna PUNTS
      TRY.
          zrm_cl_valoracio_ofertes=>recalculate_val_econ_sim( EXPORTING im_objectid = my_exp_cont-objectid
                                                                        im_docclass = my_exp_cont-docclass
                                                              IMPORTING ex_punt_gen = DATA(lt_punt_gen) ).
        CATCH zcx_rm_valoracio .
      ENDTRY.
    ENDIF.
**  << FI MODIF ETODR SPEC-49075

* >> Inici Modif. SPEC-38577. Eliminar del quadre3 i del Quadre d'Obertura els exclosos sobre 2 i/o
*                             per puntuació tècnica.
    IF my_exp_cont-z_proc_adj = 'CD' OR my_exp_cont-z_proc_adj = 'CO' OR
       my_exp_cont-z_proc_adj = 'CP' OR my_exp_cont-z_proc_adj = 'CR' OR
       my_exp_cont-z_proc_adj = 'NF' OR my_exp_cont-z_proc_adj = 'NP'.
**   >> INI MODIF ETODR SPEC-39250
      IF NOT ( ( my_exp_cont-z_proc_adj = 'CD' OR my_exp_cont-z_proc_adj = 'CP' ) AND my_exp_cont-z_harmonitzat IS INITIAL )  "si no és obert d'una sola fase.
         OR my_exp_cont-z_obres_2m5m = 'X'.  " 2M5M es considera harmonitzat de 2 fases
**   << INI MODIF ETODR SPEC-39250
        DELETE lt_ofertes WHERE z_exclos_s2 EQ 'X' .
        IF sy-subrc EQ 0 .
          l_recalculate = 'X' .
        ENDIF .
        DELETE lt_ofertes WHERE z_excl_punt_tec EQ 'X'.
        IF sy-subrc EQ 0 .
          l_recalculate = 'X' .
        ENDIF .
        DELETE lt_valcrit WHERE z_exclos_s2 = 'X' OR z_exclos_var_tec = 'X'.
        IF sy-subrc EQ 0 .
          l_recalculate = 'X' .
        ENDIF .
      ENDIF.
    ENDIF.
* << Fi Modif. SPEC-38577

    LOOP AT lt_valcrit ASSIGNING <ls_valcrit> WHERE z_num_sob EQ '1'
                                               AND (    z_exclos_s1s2 EQ 'X'
                                                     OR z_excl_pos_esm EQ 'X' ).
      l_recalculate = 'X' .
      DELETE lt_ofertes WHERE z_num_ofer EQ <ls_valcrit>-z_num_ofer .
    ENDLOOP .

    IF l_recalculate EQ 'X' .
      CALL METHOD recalculate_group
        CHANGING
          ch_ofertes = lt_ofertes.
    ENDIF .

*-- El número d'agrupador d'empreses s'ha de mantenir coherent per al quadre base
*-- i el quadre variant. Aixó que calculem el Quadre sencer i després descartem el
*-- que no necessitem
    SORT lt_ofertes BY z_num_ofer .
    LOOP AT lt_ofertes ASSIGNING <ls_oferta> .
      CLEAR: ls_quadre3,
             l_exclos,
             l_exclos_bis .

      IF    <ls_oferta>-z_import_homog EQ 0
         OR my_exp_cont-z_req_homog    IS INITIAL .
        ls_cost_projecte-base        = <ls_oferta>-z_imp_oferta_b .
        ls_cost_projecte-total       = <ls_oferta>-z_import_oferta .
        ls_cost_projecte-total_homog = <ls_oferta>-z_import_oferta.
      ELSE .
        ls_cost_projecte-base        = <ls_oferta>-z_imp_homog_b .
        ls_cost_projecte-total       = <ls_oferta>-z_import_oferta .
        ls_cost_projecte-total_homog = <ls_oferta>-z_import_homog.
      ENDIF .
**>> INI MODIF ETODR SPEC-53131 Per la plantilla del Quadre d'Obertura dels Oberts no simplificats Criteri Preu no s'ha de mostrar dades de temeritats
**>>  INI MODIF SPEC-33452
*    IF lv_form_temeritat = 'TX1'. "Obres Control de Qualitat Obres  - Variable
*      IF <ls_oferta>-z_presdesp_fin IS NOT INITIAL.
*        ls_quadre3-presdesp = '(*)'.
*      ENDIF.
*      IF <ls_oferta>-z_presdesp_ini IS NOT INITIAL.
*        IF ls_quadre3-presdesp IS NOT INITIAL.
*          CONCATENATE ls_quadre3-presdesp '(***)' INTO ls_quadre3-presdesp.
*        ELSE.
*          ls_quadre3-presdesp = '(***)'.
*        ENDIF.
*      ENDIF.
*    ENDIF.
**<<  FI MODIF SPEC-33452
**<< FI MODIF ETODR SPEC-53131
      ls_quadre3-z_num_ofer     = <ls_oferta>-z_num_ofer .
      ls_quadre3-num_variant    = <ls_oferta>-z_num_variant .
      ls_quadre3-z_tipus_oferta = <ls_oferta>-z_tipus_oferta .
      ls_quadre3-proveidor      = <ls_oferta>-proveidor .
      ls_quadre3-empresa        = <ls_oferta>-nom_proveidor .
      ls_quadre3-empresa_homog  = <ls_oferta>-nom_proveidor .

** >> INI MODIF ETODR SPEC-51404
      CALL METHOD get_tipol_variable
        EXPORTING
          im_docclass = my_exp_cont-docclass
          im_objectid = my_exp_cont-objectid
        RECEIVING
          ex_data     = DATA(lr_is_tipol_variable).
      IF lr_is_tipol_variable IS BOUND.
        ASSIGN lr_is_tipol_variable->* TO FIELD-SYMBOL(<fs_is_tipol_variable>) .
        IF sy-subrc = 0.
          IF <fs_is_tipol_variable> IS ASSIGNED AND <fs_is_tipol_variable> = abap_on.
            CALL METHOD get_imp_tip_variable_oferta
              EXPORTING
                im_docclass = my_exp_cont-docclass
                im_objectid = my_exp_cont-objectid
                im_num_ofer = <ls_oferta>-z_num_ofer
              RECEIVING
                ex_data     = DATA(lr_cost_part_variable).
            IF lr_cost_part_variable IS BOUND.
              ASSIGN lr_cost_part_variable->* TO FIELD-SYMBOL(<fs_cost_part_variable>) .
              IF sy-subrc = 0.
*              ls_quadre3-cost_part_variable = <fs_cost_part_variable>.
                lv_cost_part_variable = <fs_cost_part_variable>.
                _format_number: lv_cost_part_variable ls_quadre3-cost_part_variable.
              ENDIF.
            ENDIF.
**        >> INI MODIF ETODR SPEC-49881
            CALL METHOD get_imp_tip_fix_oferta
              EXPORTING
                im_docclass = my_exp_cont-docclass
                im_objectid = my_exp_cont-objectid
                im_num_ofer = <ls_oferta>-z_num_ofer
              RECEIVING
                ex_data     = DATA(lr_cost_part_fixa).
            IF lr_cost_part_fixa IS BOUND.
              ASSIGN lr_cost_part_fixa->* TO FIELD-SYMBOL(<fs_cost_part_fixa>) .
              IF sy-subrc = 0.
                lv_cost_part_fixa = <fs_cost_part_fixa>.
                _format_number: lv_cost_part_fixa ls_quadre3-cost_part_fixa.
              ENDIF.
            ENDIF.
**        << FI MODIF ETODR SPEC-49881
*          ls_quadre3-baixa_part_variable = <ls_oferta>-z_boi.
            _format_number: <ls_oferta>-z_boi ls_quadre3-baixa_part_variable.
          ENDIF.
        ENDIF.
      ENDIF.
** << FI MODIF ETODR SPEC-51404

***>>>  INICI MODIF SPEC-43591 ETXGL
*-- Empresa (Només en el cas que sigui exclós Post obertura)---
      IF <ls_oferta>-z_exclos_s3_postob  EQ 'X'.
        ls_quadre3-z_exclos_post_ob    =  '(1)'. "'Exclòs'(001) . SPEC-43519
      ELSE.
        CLEAR ls_quadre3-z_exclos_post_ob.
      ENDIF.
***<<<  FI  MODIF SPEC-43591 ETXGL

*-- Termini d'execució ---------------------------------------
      ls_quadre3-termini_execucio = get_quadre3_durada( im_durada = <ls_oferta>-z_termini_exec
                                                        im_unit   = <ls_oferta>-z_unit_term_exec ) .

*-- Cost -----------------------------------------------------
      _format_number: <ls_oferta>-z_imp_oferta_b  ls_quadre3-cost,
                      <ls_oferta>-z_import_oferta ls_quadre3-cost_total.
      ls_quadre3-cost_int = <ls_oferta>-z_import_oferta .

*-- Homogeneïtzat --------------------------------------------
*    LOOP AT lt_valcrit ASSIGNING <ls_valcrit> WHERE z_num_ofer EQ <ls_oferta>-z_num_ofer
*                                                AND z_num_sob EQ '2'
*                                               AND (   z_exclos_s1s2 EQ 'X'
*                                                     OR z_excl_pos_esm EQ 'X' ) ."#EC NEEDED
*    ENDLOOP .
*    IF     sy-subrc                    NE 0
*       AND <ls_oferta>-z_exclos_s3     EQ space
**      AND <ls_oferta>-z_excl_punt_tec EQ space
*       AND <ls_oferta>-z_excl_homog    EQ space  .
      IF     <ls_oferta>-z_exclos_s2     EQ space
         AND <ls_oferta>-z_exclos_s3     EQ space
*      AND <ls_oferta>-z_excl_punt_tec EQ space
         AND <ls_oferta>-z_excl_homog    EQ space.
*       AND <ls_oferta>-z_temerari      EQ space .
        IF <ls_oferta>-z_import_homog IS NOT INITIAL .
          _format_number: <ls_oferta>-z_imp_homog_b   ls_quadre3-homogeneitzat,
                          <ls_oferta>-z_import_homog  ls_quadre3-homogeneitzat_total.
        ELSE .
          _format_number: <ls_oferta>-z_imp_oferta_b  ls_quadre3-homogeneitzat,
                          <ls_oferta>-z_import_oferta ls_quadre3-homogeneitzat_total .
        ENDIF .
      ELSE .
        ls_quadre3-homogeneitzat       =  'Exclòs'(001) .
        ls_quadre3-homogeneitzat_total =  'Exclòs'(001) .
        l_exclos = 'X' .
      ENDIF .

      IF <ls_oferta>-z_exclos_s2 NE space
          OR <ls_oferta>-z_temerari   NE space .
        l_exclos_bis = 'X' .
      ENDIF.

*-- Percentatge de baixa -------------------------------------
      ">>>  SPEC-57843 Inici Modificació ETXGL
*    lv_numerator   = ls_cost_projecte-total .
*    lv_denominator = my_exp_cont-z_pressup_licit .

      lv_value_sense_iva = abap_off.
      SELECT SINGLE value
       FROM zsap_dt_param_hc
        INTO lv_value_sense_iva
            WHERE repid = co_programa
              AND field_info = co_nom_fitxer.

      lv_numerator = abap_off.
      lv_denominator = abap_off.

      IF lv_value_sense_iva IS NOT INITIAL.
        lv_numerator   = ls_cost_projecte-base .
        lv_denominator = my_exp_cont-z_pres_licit_b.
      ELSEIF lv_value_sense_iva IS INITIAL.
        lv_numerator   = ls_cost_projecte-total .
        lv_denominator = my_exp_cont-z_pressup_licit.
      ENDIF.
      "<<<  SPEC-57843 Final Modificació ETXGL

      IF l_exclos EQ 'X'
         AND im_sort_by NE 'BAIXA_INT'
         AND im_sort_by NE 'COST_INT'.
        CLEAR: ls_quadre3-baixa,
               ls_quadre3-baixa_int.
      ELSE.
        CALL METHOD get_quadre3_baixa
          EXPORTING
            im_numerator   = lv_numerator
            im_denominator = lv_denominator
          IMPORTING
            ex_baixa       = ls_quadre3-baixa
            ex_baixa_int   = ls_quadre3-baixa_int.
      ENDIF.

      lv_numerator = abap_off.
      lv_denominator = abap_off.

*-- Percentatge de baixa amb homog.----------------------------
      lv_numerator   = ls_cost_projecte-total_homog .
      lv_denominator = my_exp_cont-z_pressup_licit .
      IF      l_exclos   EQ 'X'
         AND  im_sort_by NE 'BAIXA_INT'
         AND  im_sort_by NE 'COST_INT' .
        CLEAR: ls_quadre3-baixa_homog,
               ls_quadre3-baixa_homog_int .
      ELSE .
        CALL METHOD get_quadre3_baixa
          EXPORTING
            im_numerator   = lv_numerator
            im_denominator = lv_denominator
          IMPORTING
            ex_baixa       = ls_quadre3-baixa_homog
            ex_baixa_int   = ls_quadre3-baixa_homog_int.
      ENDIF .

*-- Compleix i Compleix Homog.-------------------------------
      IF     l_exclos     EQ 'X'
         AND l_exclos_bis EQ space .
        CLEAR ls_quadre3-compleix .
      ELSE .
        IF <ls_oferta>-z_compleix_cond IS INITIAL .
          ls_quadre3-compleix = 'No' .
        ELSE .
          ls_quadre3-compleix = 'Sí' .
        ENDIF .

        IF <ls_oferta>-z_compleix_homog IS INITIAL .
          ls_quadre3-compleix_homog = 'No' .
        ELSE .
          ls_quadre3-compleix_homog = 'Sí' .
        ENDIF .
      ENDIF .

      IF my_exp_cont-z_req_homog IS INITIAL .
        ls_quadre3-compleix_homog = ls_quadre3-compleix .
      ENDIF .

      DEFINE _format_prorr_per .
        l_import_calcul = &2 * &1 / 100.
        _format_number: l_import_calcul &3 .
      END-OF-DEFINITION .

      DEFINE _format_prorr .
        l_import_calcul = &1 * &2.
        _format_number: l_import_calcul &3 .
      END-OF-DEFINITION .
* >> Inici Modif. SPEC-38097
*    Es consulta a la taula ZRM_DT_LIC_PER si hi ha un repartiment especial per aquesta licitació.
      CLEAR: l_proj, l_dir.", l_proj_aux, l_dir_aux.
      SELECT z_pcost_projecte z_pcost_direccio INTO (l_proj, l_dir)
                                               FROM zrm_dt_lic_per
                                              WHERE z_codi_exp = my_exp_cont-z_codi_exp.
      ENDSELECT.
      IF sy-subrc = 0.
*      l_proj = l_proj_aux.
*      l_dir = l_dir_aux.
*      l_proj = l_proj / 100.
*      l_dir  = l_dir  / 100.
        _format_prorr_per:  l_dir  ls_cost_projecte-base   ls_quadre3-cost_direccio_30,
                            l_dir  ls_cost_projecte-total  ls_quadre3-cost_direccio_30_total,
                            l_proj ls_cost_projecte-base   ls_quadre3-cost_projecte_70,
                            l_proj ls_cost_projecte-total  ls_quadre3-cost_projecte_70_total,

                            l_dir  ls_cost_projecte-base   ls_quadre3-cost_direccio_35,
                            l_dir  ls_cost_projecte-total  ls_quadre3-cost_direccio_35_total,
                            l_proj ls_cost_projecte-base   ls_quadre3-cost_projecte_65,
                            l_proj ls_cost_projecte-total  ls_quadre3-cost_projecte_65_total,

                            l_dir  ls_cost_projecte-base   ls_quadre3-cost_direccio_34,
                            l_dir  ls_cost_projecte-total  ls_quadre3-cost_direccio_34_total,
                            l_proj ls_cost_projecte-base   ls_quadre3-cost_projecte_66,
                            l_proj ls_cost_projecte-total  ls_quadre3-cost_projecte_66_total.
      ELSE.
* << Fi Modif. SPEC-38097
***>> INI OVB SPEC-36818 Modificar els tant per cents PE/DO
        IF my_exp_cont-z_subtipus_cont EQ 'PI'
          AND my_imp_cap-z_import_pec_b < 1000000 "INI MODIF ETODR 22.03.2016 SPEC-38725 "AND my_exp_cont-z_pres_licit_b < 1000000
          AND my_exp_cont-z_data_creacio > '20150923'.

          _format_prorr:  '0.20' ls_cost_projecte-base   ls_quadre3-cost_direccio_30,
                          '0.20' ls_cost_projecte-total  ls_quadre3-cost_direccio_30_total,
                          '0.80' ls_cost_projecte-base   ls_quadre3-cost_projecte_70,
                          '0.80' ls_cost_projecte-total  ls_quadre3-cost_projecte_70_total,

                          '0.20' ls_cost_projecte-base   ls_quadre3-cost_direccio_35,
                          '0.20' ls_cost_projecte-total  ls_quadre3-cost_direccio_35_total,
                          '0.80' ls_cost_projecte-base   ls_quadre3-cost_projecte_65,
                          '0.80' ls_cost_projecte-total  ls_quadre3-cost_projecte_65_total,
* inici SPEC-34500
                          '0.20' ls_cost_projecte-base   ls_quadre3-cost_direccio_34,
                          '0.20' ls_cost_projecte-total  ls_quadre3-cost_direccio_34_total,
                          '0.80' ls_cost_projecte-base   ls_quadre3-cost_projecte_66,
                          '0.80' ls_cost_projecte-total  ls_quadre3-cost_projecte_66_total.
* fin   SPEC-34500
        ELSE.
***>> FIN OVB
*-- Costos ---------------------------------------------------
          _format_prorr:  '0.30' ls_cost_projecte-base   ls_quadre3-cost_direccio_30,
                          '0.30' ls_cost_projecte-total  ls_quadre3-cost_direccio_30_total,
                          '0.70' ls_cost_projecte-base   ls_quadre3-cost_projecte_70,
                          '0.70' ls_cost_projecte-total  ls_quadre3-cost_projecte_70_total,
                          '0.35' ls_cost_projecte-base   ls_quadre3-cost_direccio_35,
                          '0.35' ls_cost_projecte-total  ls_quadre3-cost_direccio_35_total,
                          '0.65' ls_cost_projecte-base   ls_quadre3-cost_projecte_65,
                          '0.65' ls_cost_projecte-total  ls_quadre3-cost_projecte_65_total,
* inici SPEC-34500
                           '0.34' ls_cost_projecte-base   ls_quadre3-cost_direccio_34,
                           '0.34' ls_cost_projecte-total  ls_quadre3-cost_direccio_34_total,
                           '0.66' ls_cost_projecte-base   ls_quadre3-cost_projecte_66,
                           '0.66' ls_cost_projecte-total  ls_quadre3-cost_projecte_66_total.
* fin   SPEC-34500

***>> INI OVB SPEC-36818 Modificar els tant per cents PE/DO
        ENDIF.
***>> FIN OVB
      ENDIF. "SPEC-38097

      _format_number: <ls_oferta>-z_cost_obra_b    ls_quadre3-z_cost_obra,
                      <ls_oferta>-z_cost_obra      ls_quadre3-z_cost_obra_total,
                      <ls_oferta>-z_cost_proj_b    ls_quadre3-z_cost_projecte,
                      <ls_oferta>-z_cost_projecte  ls_quadre3-z_cost_projecte_total,
                      <ls_oferta>-z_cost_dir_b     ls_quadre3-z_cost_direccio,
                      <ls_oferta>-z_cost_direccio  ls_quadre3-z_cost_direccio_total.


*-- Terminis de projecte i obra ------------------------------
      ls_quadre3-z_termini_projecte = get_quadre3_durada( im_durada = <ls_oferta>-z_termini_proj
                                                          im_unit   = <ls_oferta>-z_unit_term_proj ).

      ls_quadre3-z_termini_obra = get_quadre3_durada( im_durada = <ls_oferta>-z_termini_obra
                                                      im_unit   = <ls_oferta>-z_unit_term_obra ).


*-- Crèdit ---------------------------------------------------
      WRITE my_exp_cont-z_max_credit TO ls_quadre3-credit DECIMALS 0.
      CONCATENATE ls_quadre3-credit '%' INTO ls_quadre3-credit.

*-- Termini del crèdit ---------------------------------------
      ls_quadre3-termini_credit = get_quadre3_durada( im_durada = my_exp_cont-z_durad_max_cred
                                                      im_unit   = my_exp_cont-z_un_max_cred ).

*-- Interès MIBOR/EURIBOR-------------------------------------
      IF <ls_oferta>-z_tipus_interes EQ 0 .
        ls_quadre3-int_mibor   = 'MIBOR' .
        ls_quadre3-int_euribor = 'EURIBOR' .
      ELSE .
        WRITE <ls_oferta>-z_tipus_interes TO l_char80 DECIMALS 2 LEFT-JUSTIFIED.
        CONCATENATE `M + ` l_char80 INTO ls_quadre3-int_mibor .
        CONCATENATE `E + ` l_char80 INTO ls_quadre3-int_euribor .
      ENDIF .

*-- Interès de compensació financera --------------------------
      WRITE <ls_oferta>-z_int_comp_fin TO l_char80 DECIMALS 2 LEFT-JUSTIFIED.
      CONCATENATE `E + ` l_char80 INTO ls_quadre3-int_comp_fin .

*-- Import de la compensació financera ------------------------
      _format_number: <ls_oferta>-z_imp_com_fin_b ls_quadre3-imp_comp_fin,
                      <ls_oferta>-z_imp_com_fin   ls_quadre3-imp_comp_fin_total .

*-- Baixa amb compensació financera ---------------------------
      IF      l_exclos    EQ 'X'
         AND  im_sort_by  NE 'BAIXA_COMP_FIN_INT'
         AND l_exclos_bis EQ space .
        CLEAR: ls_quadre3-baixa_comp_fin,
               ls_quadre3-baixa_comp_fin_int .
      ELSE .
        lv_numerator   = <ls_oferta>-z_imp_com_fin     + ls_cost_projecte-total .
        lv_denominator = my_exp_cont-z_import_comp_fi  + my_exp_cont-z_pressup_licit.
        CALL METHOD get_quadre3_baixa
          EXPORTING
            im_numerator   = lv_numerator
            im_denominator = lv_denominator
          IMPORTING
            ex_baixa       = ls_quadre3-baixa_comp_fin
            ex_baixa_int   = ls_quadre3-baixa_comp_fin_int.
      ENDIF .
*-- Cost financer ----------------------------------------------
      _format_number: <ls_oferta>-z_estalvi_fin_b ls_quadre3-cost_financer,
                      <ls_oferta>-z_estalvi_fin   ls_quadre3-cost_financer_total .

*-- Homogeneïtzat amb cost financer ----------------------------
      IF l_exclos EQ 'X' .
        ls_quadre3-homogeneitzat_cost_fin       = 'Exclòs'(001) .
        ls_quadre3-homogeneitzat_cost_fin_total = 'Exclòs'(001) .
      ELSE .
        l_import_calcul = ls_cost_projecte-base + <ls_oferta>-z_estalvi_fin_b .
        _format_number: l_import_calcul ls_quadre3-homogeneitzat_cost_fin .
        l_import_calcul = ls_cost_projecte-total + <ls_oferta>-z_estalvi_fin .
        _format_number: l_import_calcul ls_quadre3-homogeneitzat_cost_fin_total .
      ENDIF .

*-- Baixa amb cost financer ------------------------------------
      IF     l_exclos   EQ 'X'
         AND im_sort_by NE  'BAIXA_OFERTA_COST_FIN_INT'
         AND l_exclos_bis EQ space .
        CLEAR: ls_quadre3-baixa_oferta_cost_fin,
               ls_quadre3-baixa_oferta_cost_fin_int.
      ELSE .
        lv_numerator   = ls_cost_projecte-total + <ls_oferta>-z_estalvi_fin .
        lv_denominator = my_exp_cont-z_pressup_licit .
        CALL METHOD get_quadre3_baixa
          EXPORTING
            im_numerator   = lv_numerator
            im_denominator = lv_denominator
          IMPORTING
            ex_baixa       = ls_quadre3-baixa_oferta_cost_fin
            ex_baixa_int   = ls_quadre3-baixa_oferta_cost_fin_int.
      ENDIF .

*-- Homogeneïtzat amb compensació financera i cost financer -----
      IF l_exclos EQ 'X' .
        ls_quadre3-homogeneitzat_comp_fin       =  '(1)'. "'Exclòs'(001) . SPEC-43519
        ls_quadre3-homogeneitzat_comp_fin_total =  '(1)'. "'Exclòs'(001) . SPEC-43519
      ELSE .
        l_import_calcul = ls_cost_projecte-base + <ls_oferta>-z_estalvi_fin_b
                        + <ls_oferta>-z_imp_com_fin_b .
        _format_number: l_import_calcul ls_quadre3-homogeneitzat_comp_fin .
        l_import_calcul = ls_cost_projecte-total + <ls_oferta>-z_estalvi_fin
                        + <ls_oferta>-z_imp_com_fin .
        _format_number: l_import_calcul ls_quadre3-homogeneitzat_comp_fin_total .
      ENDIF .

*-- Baixa amb compensació financera i cost financer -------------
      IF     l_exclos   EQ 'X'
         AND im_sort_by NE 'BAIXA_COMP_FINANCERA_COST_INT'
         AND l_exclos_bis EQ space .
        CLEAR: ls_quadre3-baixa_comp_financera_cost,
               ls_quadre3-baixa_comp_financera_cost_int .
      ELSE .
        lv_numerator   = <ls_oferta>-z_imp_com_fin    + <ls_oferta>-z_estalvi_fin + ls_cost_projecte-total .
        lv_denominator = my_exp_cont-z_import_comp_fi + my_exp_cont-z_pressup_licit .
        CALL METHOD get_quadre3_baixa
          EXPORTING
            im_numerator   = lv_numerator
            im_denominator = lv_denominator
          IMPORTING
            ex_baixa       = ls_quadre3-baixa_comp_financera_cost
            ex_baixa_int   = ls_quadre3-baixa_comp_financera_cost_int.
      ENDIF .
**  >> INI MODIF ETODR SPEC-49075
      IF my_exp_cont-z_llei92017 = abap_on AND my_exp_cont-z_obert_preu = abap_off.
        "Per la nova llei, i expedients de licitació oberts no preu, es calcula el valor de la puntuació econòmica per a mostar-lo al Quadre 3A a la columna PUNTS
        LOOP AT lt_punt_gen ASSIGNING FIELD-SYMBOL(<fs_punt_oferta>) WHERE z_num_gen = <ls_oferta>-z_num_ofer.
          ls_quadre3-z_punt_econ = <fs_punt_oferta>-z_punts.
        ENDLOOP.
      ENDIF.
**  << FI MODIF ETODR SPEC-49075

**  >> INI MODIF ETODR SPEC-51404
      IF <ls_oferta>-z_exclos_s3_postob = abap_on.
        ls_quadre3-z_punt_econ       = '0.00'.
        ls_quadre3-baixa_homog       = ls_quadre3-baixa     = ls_quadre3-baixa_part_variable = 'Exclòs'.
        ls_quadre3-compleix_homog    = ls_quadre3-compleix  = space.
      ENDIF.
**  << FI MODIF ETODR SPEC-51404

      APPEND ls_quadre3 TO <lt_quadre3> .
    ENDLOOP .

    IF im_sort_by EQ 'COST_INT' .
      SORT <lt_quadre3> BY cost_int ASCENDING .
    ELSE .
      SORT <lt_quadre3> BY (im_sort_by) DESCENDING .
    ENDIF .

*-- El número d'agrupador d'empreses s'ha de mantenir coherent per al quadre base
*-- i el quadre variant. Aixó que calculem el Quadre sencer i després descartem el
*-- que no necessitem
    LOOP AT <lt_quadre3> INTO ls_quadre3 .
      READ TABLE lt_ofertes ASSIGNING <ls_oferta> WITH TABLE KEY z_num_ofer = ls_quadre3-z_num_ofer .
      CHECK NOT <ls_oferta>-all_konzs IS INITIAL .
      LOOP AT <ls_oferta>-all_konzs INTO l_last_konzs .
        READ TABLE lt_group TRANSPORTING NO FIELDS WITH TABLE KEY table_line = l_last_konzs .
        CHECK sy-subrc NE 0 .
        INSERT l_last_konzs INTO TABLE lt_group .
      ENDLOOP .
    ENDLOOP .

    LOOP AT <lt_quadre3> INTO ls_quadre3 .
      CLEAR l_prefix .
      CLEAR l_prefix_homog.
      READ TABLE lt_ofertes ASSIGNING <ls_oferta> WITH TABLE KEY z_num_ofer = ls_quadre3-z_num_ofer .
      LOOP AT <ls_oferta>-all_konzs INTO l_last_konzs .
        READ TABLE lt_group TRANSPORTING NO FIELDS WITH TABLE KEY table_line = l_last_konzs .
        l_num_grup = sy-tabix .
        CONDENSE l_num_grup .
        CONCATENATE l_prefix ` (` l_num_grup `) ` INTO l_prefix .
        l_prefix_homog = l_prefix.

* El camp COMPLEIX i COMPLEIX_HOMOG només ha d'aparèixer informat pel primer component d'un grup d'empreses.
* Per a la resta ha de sortir en blanc. Quan l'empresa pertany a més d'un grup d'empreses el camp s'informa si és
* la primera vegada que apareix per a qualssevol del grups als que pertany
        IF ls_quadre3-z_tipus_oferta EQ im_tipus_oferta .
          READ TABLE lt_group_compleix TRANSPORTING NO FIELDS WITH TABLE KEY table_line = l_last_konzs .
          IF sy-subrc EQ 0 .
            CLEAR: ls_quadre3-compleix,
                   ls_quadre3-compleix_homog .
            MODIFY <lt_quadre3> FROM ls_quadre3 TRANSPORTING compleix compleix_homog.
          ELSE .
            INSERT l_last_konzs INTO TABLE lt_group_compleix .
          ENDIF .
*        READ TABLE lt_group_compleix_homog TRANSPORTING NO FIELDS WITH TABLE KEY table_line = l_last_konzs .
*        IF sy-subrc EQ 0 .
*          CLEAR ls_quadre3-compleix_homog .
*          MODIFY <lt_quadre3> FROM ls_quadre3 TRANSPORTING compleix_homog .
*        ELSE .
*          INSERT l_last_konzs INTO TABLE lt_group_compleix_homog .
*        ENDIF .
        ENDIF .
      ENDLOOP .
**>> INI MODIF ETODR SPEC-53131 Per la plantilla del Quadre d'Obertura dels Oberts no simplificats Criteri Preu no s'ha de mostrar dades de temeritats
*** >> INI MODIF SPEC-33452
*    IF lv_form_temeritat <> 'TX1'.
*      IF  <ls_oferta>-z_presump_temer EQ 'X' .
*        CONCATENATE `(*) ` l_prefix INTO l_prefix .
*      ENDIF .
*
*      IF ( <ls_oferta>-z_import_homog IS NOT INITIAL AND <ls_oferta>-z_pres_tem_homog EQ 'X').
*        CONCATENATE `(*) ` l_prefix_homog INTO l_prefix_homog .
*      ENDIF.
*    ENDIF.
***  << FI MODIF SPEC-33452
**  << FI MODIF ETODR SPEC-53131
      l_empresa = ls_quadre3-empresa.

      CONCATENATE l_prefix l_empresa INTO ls_quadre3-empresa.
      CONDENSE ls_quadre3-empresa.
      MODIFY <lt_quadre3> FROM ls_quadre3 TRANSPORTING empresa .

      IF my_exp_cont-z_req_homog IS INITIAL .
        ls_quadre3-empresa_homog = ls_quadre3-empresa .
      ELSE .
        CONCATENATE l_prefix_homog l_empresa INTO ls_quadre3-empresa_homog.
        CONDENSE ls_quadre3-empresa_homog.
      ENDIF .
      MODIFY <lt_quadre3> FROM ls_quadre3 TRANSPORTING empresa_homog .
    ENDLOOP .

    DELETE <lt_quadre3> WHERE z_tipus_oferta NE im_tipus_oferta .

*--- Taula de Vincles -----------------------------------------------------------

* Hem de tenir en compte les ofertes (base o variant) de proveïdor pertanyents a grups
* d'empreses però només si un altre integrant del grup també presenta oferta
* Una empresa que sigui UTE s'ha d'avaluar una vegada per cada Grup d'empreses a la que
* pertany (potencialment: el grup de la UTE i el grup de cadascun dels seus components)
    CALL METHOD get_vincles
      EXPORTING
        im_ofertes   = lt_ofertes
        im_group     = lt_group
        im_req_homog = my_exp_cont-z_req_homog
      CHANGING
        ch_vincles   = <lt_vincle>.
  ENDMETHOD.


  METHOD get_quadre_2b_pt.

    DATA: lt_ofertes TYPE ty_t_oferta.
    FIELD-SYMBOLS: <fs_ofertes> TYPE ty_t_oferta,
                   <my_cached>  TYPE REF TO data.

    ASSIGN my_exclusio_s2 TO <my_cached>.

    CREATE DATA <my_cached> TYPE ty_t_oferta.
    ASSIGN <my_cached>->* TO <fs_ofertes>.

    CALL METHOD get_ofertes
      EXPORTING
        im_docclass = im_docclass
        im_objectid = im_objectid
      IMPORTING
        ex_ofertes  = my_ofertes.

    LOOP AT my_ofertes INTO DATA(ls_ofertes) WHERE z_exclos_s1     EQ abap_false AND
                                                   z_exclos_s2     EQ abap_false AND
                                                   z_excl_punt_tec EQ abap_false AND
                                                   z_renun_ofert   EQ abap_false.

      APPEND ls_ofertes TO lt_ofertes.

    ENDLOOP.

    SORT lt_ofertes BY z_punt_tec DESCENDING.

    <fs_ofertes> = lt_ofertes.

    ex_data = <my_cached>.

  ENDMETHOD.


  METHOD get_quadre_3_import.

    DATA: lt_ofertes TYPE ty_t_oferta.
    FIELD-SYMBOLS: <fs_ofertes> TYPE ty_t_oferta,
                   <my_cached>  TYPE REF TO data.

    ASSIGN my_exclusio_s2 TO <my_cached>.

    CREATE DATA <my_cached> TYPE ty_t_oferta.
    ASSIGN <my_cached>->* TO <fs_ofertes>.

    CALL METHOD get_ofertes
      EXPORTING
        im_docclass = im_docclass
        im_objectid = im_objectid
      IMPORTING
        ex_ofertes  = my_ofertes.

    LOOP AT my_ofertes INTO DATA(ls_ofertes) WHERE z_exclos_s1     EQ abap_false AND
                                                   z_exclos_s2     EQ abap_false AND
                                                   z_excl_punt_tec EQ abap_false AND
                                                   z_exclos_s3     EQ abap_false AND
                                                   z_temerari      EQ abap_false AND
                                                   z_renun_ofert   EQ abap_false.

      APPEND ls_ofertes TO lt_ofertes.

    ENDLOOP.

    SORT lt_ofertes BY z_imp_oferta_b DESCENDING.

    <fs_ofertes> = lt_ofertes.

    ex_data = <my_cached>.

  ENDMETHOD.


  METHOD get_quadre_4_punt_total.

    DATA: lt_ofertes TYPE ty_t_oferta.
    FIELD-SYMBOLS: <fs_ofertes> TYPE ty_t_oferta,
                   <my_cached>  TYPE REF TO data.

    ASSIGN my_exclusio_s2 TO <my_cached>.

    CREATE DATA <my_cached> TYPE ty_t_oferta.
    ASSIGN <my_cached>->* TO <fs_ofertes>.

    CALL METHOD get_ofertes
      EXPORTING
        im_docclass = im_docclass
        im_objectid = im_objectid
      IMPORTING
        ex_ofertes  = my_ofertes.

    LOOP AT my_ofertes INTO DATA(ls_ofertes) WHERE z_exclos_s1     EQ abap_false AND
                                                   z_exclos_s2     EQ abap_false AND
                                                   z_excl_punt_tec EQ abap_false AND
                                                   z_renun_ofert   EQ abap_false.

      APPEND ls_ofertes TO lt_ofertes.

    ENDLOOP.

    SORT lt_ofertes BY z_punt_total DESCENDING.

    <fs_ofertes> = lt_ofertes.

    ex_data = <my_cached>.

  ENDMETHOD.


  METHOD get_quadre_obertura_simpl.
    DEFINE _format_number .
      write &1 to l_char80 decimals 2 left-justified .  "#EC UOM_IN_MES
      &2 = l_char80 .
    END-OF-DEFINITION .

    TYPES: ty_t_quadre3 TYPE STANDARD TABLE OF zerm_quadre3
                        WITH NON-UNIQUE DEFAULT KEY .
    DATA: lt_ofertes     TYPE ty_t_oferta,
          ls_ofertes     TYPE ty_s_oferta,
          l_recalculate  TYPE xfeld,
          ls_quadre3     TYPE LINE OF ty_t_quadre3,
          lv_numerator   TYPE zrm_dt_exp_cont-z_pres_licit_b,
          lv_denominator TYPE zrm_dt_exp_cont-z_pres_licit_b,
          l_char80       TYPE char80,
          BEGIN OF ls_cost_projecte,
            base        TYPE zrm_dt_ofertes-z_imp_homog_b,
            total       TYPE zrm_dt_ofertes-z_import_homog,
            total_homog TYPE zrm_dt_ofertes-z_import_homog,
          END OF ls_cost_projecte,
          l_import_calcul       TYPE zrm_dt_ofertes-z_imp_homog_b,
          l_exclos              TYPE xfeld,
          l_exclos_bis          TYPE xfeld,
          ls_quadre3_cache      TYPE ty_s_quadre3_cache,
          l_last_konzs          TYPE lfa1-konzs,
          lt_valcrit            TYPE ty_t_valcrit,
          lt_group              TYPE TABLE OF konzs,
          lt_group_compleix     TYPE HASHED TABLE OF konzs WITH UNIQUE DEFAULT KEY,
          l_num_grup            TYPE string,
          l_prefix              TYPE string,
          l_prefix_homog        TYPE string,
          l_empresa             TYPE string,
          lv_cost_part_variable TYPE zrm_dt_ofer_tip-import,
          lv_cost_part_fixa     TYPE zrm_dt_ofer_tip-import,
          lv_value_sense_iva    TYPE zsap_de_value.           " SPEC-57843 ETXGL

    ">>>  SPEC-57843 Inici Modificació ETXGL
    CONSTANTS: co_programa   TYPE char30 VALUE 'CALCULATE_NOUS_PLECS_BLIM',
               co_nom_fitxer TYPE char16 VALUE 'CALC_SENSE_IVA'.
    "<<<  SPEC-57843 Final Modificació ETXGL

    FIELD-SYMBOLS: <lt_quadre3>     TYPE ty_t_quadre3,
                   <lt_quadre3_aux> TYPE ty_t_quadre3,
                   <lt_vincle>      TYPE ty_t_vincle,
                   <ls_oferta>      TYPE ty_s_oferta,
                   <ls_valcrit>     TYPE ty_s_valcrit,
                   <ls_quadre3>     TYPE zerm_quadre3.

    DATA: lv_num_plec       TYPE z_num_plec,
          lv_form_temeritat TYPE z_form_temeritat,
          lv_obert_simpl    TYPE z_obert_simpl.

    DATA: l_dir  TYPE z_per_dir,
          l_proj TYPE z_per_proj.

    ls_quadre3_cache-sort_by      = im_sort_by .
    ls_quadre3_cache-tipus_oferta = im_tipus_oferta .
    READ TABLE my_quadre3_cache INTO ls_quadre3_cache FROM ls_quadre3_cache .

    IF     sy-subrc EQ 0
       AND ls_quadre3_cache-quadre IS BOUND .
      ex_quadre  = ls_quadre3_cache-quadre .
      ex_vincles = ls_quadre3_cache-vincles .
      RETURN .
    ENDIF .

    CREATE DATA ls_quadre3_cache-quadre  TYPE ty_t_quadre3 .
    CREATE DATA ls_quadre3_cache-vincles TYPE ty_t_vincle .
    INSERT ls_quadre3_cache INTO TABLE my_quadre3_cache .

    ex_quadre = ls_quadre3_cache-quadre .
    ASSIGN ex_quadre->* TO <lt_quadre3> .

    ex_vincles = ls_quadre3_cache-vincles .
    ASSIGN ex_vincles->* TO <lt_vincle> .

    CALL METHOD get_valcrit
      EXPORTING
        im_docclass = im_docclass
        im_objectid = im_objectid
      IMPORTING
        ex_valcrit  = lt_valcrit.

    CALL METHOD get_ofertes
      EXPORTING
        im_docclass = im_docclass
        im_objectid = im_objectid
      IMPORTING
        ex_ofertes  = lt_ofertes.


    IF my_exp_cont-z_proc_adj   EQ 'NP' OR
     ( my_exp_cont-z_proc_adj   EQ 'NF' AND
       my_exp_cont-z_negociacio IS NOT INITIAL ).

      IF  my_exp_cont-z_estat    EQ 'ZN1' AND lt_ofertes IS NOT INITIAL.
        DELETE lt_ofertes WHERE z_renun_ofert IS NOT INITIAL.
      ENDIF.

      IF  my_exp_cont-z_estat    EQ 'ZN2' AND lt_ofertes IS NOT INITIAL.
        DELETE lt_ofertes WHERE z_sel_2volta IS INITIAL.
      ENDIF.

    ENDIF.

    SELECT SINGLE z_num_plec z_obert_simpl
      FROM zrm_dt_exp_cont
      INTO ( lv_num_plec, lv_obert_simpl )
      WHERE docclass  = im_docclass
        AND objectid  = im_objectid.

    SELECT SINGLE z_form_temeritat
      FROM zrm_dm_plecs
      INTO lv_form_temeritat
      WHERE z_num_plec = lv_num_plec.


    IF sy-subrc EQ 0 .
      l_recalculate = 'X' .
    ENDIF .

    IF my_exp_cont-z_proc_adj = 'CR'.
      DELETE lt_ofertes WHERE z_pres_proposta NE 'X'.
      IF sy-subrc EQ 0 .
        l_recalculate = 'X' .
      ENDIF .
    ENDIF.


    IF my_exp_cont-z_rd817_2009 IS NOT INITIAL. " Si és Reial Decret RD817_2009
      DELETE lt_ofertes WHERE z_exclos_s2 EQ 'X' .
      IF sy-subrc EQ 0 .
        l_recalculate = 'X' .
      ENDIF .
      DELETE lt_ofertes WHERE z_excl_punt_tec EQ 'X'.
      IF sy-subrc EQ 0 .
        l_recalculate = 'X' .
      ENDIF .
    ENDIF.


    IF my_exp_cont-z_llei92017 = abap_on AND my_exp_cont-z_obert_preu = abap_off.
      "Per la nova llei, i expedients de licitació oberts no preu, es calcula el valor de la puntuació econòmica per a mostar-lo al Quadre 3A a la columna PUNTS
      TRY.
          zrm_cl_valoracio_ofertes=>recalculate_val_econ_sim( EXPORTING im_objectid = my_exp_cont-objectid
                                                                        im_docclass = my_exp_cont-docclass
                                                              IMPORTING ex_punt_gen = DATA(lt_punt_gen) ).
        CATCH zcx_rm_valoracio .
      ENDTRY.
    ENDIF.


*Eliminar del quadre3 i del Quadre d'Obertura els exclosos sobre 2 i/o per puntuació tècnica.
    IF my_exp_cont-z_proc_adj = 'CD' OR my_exp_cont-z_proc_adj = 'CO' OR
       my_exp_cont-z_proc_adj = 'CP' OR my_exp_cont-z_proc_adj = 'CR' OR
       my_exp_cont-z_proc_adj = 'NF' OR my_exp_cont-z_proc_adj = 'NP'.

      IF NOT ( ( my_exp_cont-z_proc_adj = 'CD' OR my_exp_cont-z_proc_adj = 'CP' ) AND my_exp_cont-z_harmonitzat IS INITIAL )  "si no és obert d'una sola fase.
         OR my_exp_cont-z_obres_2m5m = 'X'.  " 2M5M es considera harmonitzat de 2 fases

        DELETE lt_ofertes WHERE z_exclos_s2 EQ 'X' .
        IF sy-subrc EQ 0 .
          l_recalculate = 'X' .
        ENDIF .
        DELETE lt_ofertes WHERE z_excl_punt_tec EQ 'X'.
        IF sy-subrc EQ 0 .
          l_recalculate = 'X' .
        ENDIF .
        DELETE lt_valcrit WHERE z_exclos_s2 = 'X' OR z_exclos_var_tec = 'X'.
        IF sy-subrc EQ 0 .
          l_recalculate = 'X' .
        ENDIF .
      ENDIF.
    ENDIF.


    LOOP AT lt_valcrit ASSIGNING <ls_valcrit> WHERE z_num_sob EQ '1'
                                               AND (    z_exclos_s1s2 EQ 'X'
                                                     OR z_excl_pos_esm EQ 'X' ).
      l_recalculate = 'X' .

      CHECK lv_obert_simpl IS INITIAL.

      DELETE lt_ofertes WHERE z_num_ofer EQ <ls_valcrit>-z_num_ofer .
    ENDLOOP .


    DELETE lt_ofertes WHERE z_exclos_clau = abap_true.

    IF l_recalculate EQ 'X' .
      CALL METHOD recalculate_group
        CHANGING
          ch_ofertes = lt_ofertes.
    ENDIF .

*-- El número d'agrupador d'empreses s'ha de mantenir coherent per al quadre base
*-- i el quadre variant. Aixó que calculem el Quadre sencer i després descartem el
*-- que no necessitem
    SORT lt_ofertes BY z_num_ofer .
    LOOP AT lt_ofertes ASSIGNING <ls_oferta> .
      CLEAR: ls_quadre3,
             l_exclos,
             l_exclos_bis .

      IF    <ls_oferta>-z_import_homog EQ 0
         OR my_exp_cont-z_req_homog    IS INITIAL .
        ls_cost_projecte-base        = <ls_oferta>-z_imp_oferta_b .
        ls_cost_projecte-total       = <ls_oferta>-z_import_oferta .
        ls_cost_projecte-total_homog = <ls_oferta>-z_import_oferta.
      ELSE .
        ls_cost_projecte-base        = <ls_oferta>-z_imp_homog_b .
        ls_cost_projecte-total       = <ls_oferta>-z_import_oferta .
        ls_cost_projecte-total_homog = <ls_oferta>-z_import_homog.
      ENDIF .
      IF lv_form_temeritat = 'TX1'. "Obres Control de Qualitat Obres  - Variable
        IF <ls_oferta>-z_presdesp_fin IS NOT INITIAL.
          ls_quadre3-presdesp = '(*)'.
        ENDIF.
        IF <ls_oferta>-z_presdesp_ini IS NOT INITIAL.
          IF ls_quadre3-presdesp IS NOT INITIAL.
            CONCATENATE ls_quadre3-presdesp '(***)' INTO ls_quadre3-presdesp.
          ELSE.
            ls_quadre3-presdesp = '(***)'.
          ENDIF.
        ENDIF.
      ENDIF.
      ls_quadre3-z_num_ofer     = <ls_oferta>-z_num_ofer .
      ls_quadre3-num_variant    = <ls_oferta>-z_num_variant .
      ls_quadre3-z_tipus_oferta = <ls_oferta>-z_tipus_oferta .
      ls_quadre3-proveidor      = <ls_oferta>-proveidor .
      ls_quadre3-empresa        = <ls_oferta>-nom_proveidor .
      ls_quadre3-empresa_homog  = <ls_oferta>-nom_proveidor .

      CALL METHOD get_tipol_variable
        EXPORTING
          im_docclass = my_exp_cont-docclass
          im_objectid = my_exp_cont-objectid
        RECEIVING
          ex_data     = DATA(lr_is_tipol_variable).
      IF lr_is_tipol_variable IS BOUND.
        ASSIGN lr_is_tipol_variable->* TO FIELD-SYMBOL(<fs_is_tipol_variable>) .
        IF sy-subrc = 0.
          IF <fs_is_tipol_variable> IS ASSIGNED AND <fs_is_tipol_variable> = abap_on.
            CALL METHOD get_imp_tip_variable_oferta
              EXPORTING
                im_docclass = my_exp_cont-docclass
                im_objectid = my_exp_cont-objectid
                im_num_ofer = <ls_oferta>-z_num_ofer
              RECEIVING
                ex_data     = DATA(lr_cost_part_variable).
            IF lr_cost_part_variable IS BOUND.
              ASSIGN lr_cost_part_variable->* TO FIELD-SYMBOL(<fs_cost_part_variable>) .
              IF sy-subrc = 0.
                lv_cost_part_variable = <fs_cost_part_variable>.
                _format_number: lv_cost_part_variable ls_quadre3-cost_part_variable.
              ENDIF.
            ENDIF.

            CALL METHOD get_imp_tip_fix_oferta
              EXPORTING
                im_docclass = my_exp_cont-docclass
                im_objectid = my_exp_cont-objectid
                im_num_ofer = <ls_oferta>-z_num_ofer
              RECEIVING
                ex_data     = DATA(lr_cost_part_fixa).
            IF lr_cost_part_fixa IS BOUND.
              ASSIGN lr_cost_part_fixa->* TO FIELD-SYMBOL(<fs_cost_part_fixa>) .
              IF sy-subrc = 0.
                lv_cost_part_fixa = <fs_cost_part_fixa>.
                _format_number: lv_cost_part_fixa ls_quadre3-cost_part_fixa.
              ENDIF.
            ENDIF.
            _format_number: <ls_oferta>-z_boi ls_quadre3-baixa_part_variable.
          ENDIF.
        ENDIF.
      ENDIF.
*-- Empresa (Només en el cas que sigui exclós Post obertura)---
      IF <ls_oferta>-z_exclos_s3_postob  EQ 'X'.
        ls_quadre3-z_exclos_post_ob    =  '(1)'.
      ELSE.
        CLEAR ls_quadre3-z_exclos_post_ob.
      ENDIF.

*-- Termini d'execució ---------------------------------------
      ls_quadre3-termini_execucio = get_quadre3_durada( im_durada = <ls_oferta>-z_termini_exec
                                                        im_unit   = <ls_oferta>-z_unit_term_exec ) .

*-- Cost -----------------------------------------------------
      _format_number: <ls_oferta>-z_imp_oferta_b  ls_quadre3-cost,
                      <ls_oferta>-z_import_oferta ls_quadre3-cost_total.
      ls_quadre3-cost_int = <ls_oferta>-z_import_oferta .

*-- Homogeneïtzat --------------------------------------------

      IF    ( <ls_oferta>-z_exclos_s2     EQ space
        OR ( <ls_oferta>-z_exclos_s2 EQ 'X' AND my_exp_cont-z_obert_simpl EQ 'D' ) )
         AND <ls_oferta>-z_exclos_s3     EQ space
         AND <ls_oferta>-z_excl_homog    EQ space.
        IF <ls_oferta>-z_import_homog IS NOT INITIAL .
          _format_number: <ls_oferta>-z_imp_homog_b   ls_quadre3-homogeneitzat,
                          <ls_oferta>-z_import_homog  ls_quadre3-homogeneitzat_total.
        ELSE .
          _format_number: <ls_oferta>-z_imp_oferta_b  ls_quadre3-homogeneitzat,
                          <ls_oferta>-z_import_oferta ls_quadre3-homogeneitzat_total .
        ENDIF .
      ELSE .
        ls_quadre3-homogeneitzat       =  'Exclòs'(001) .
        ls_quadre3-homogeneitzat_total =  'Exclòs'(001) .
        l_exclos = 'X' .
      ENDIF .

      IF     ( <ls_oferta>-z_exclos_s2 NE space
        AND my_exp_cont-z_obert_simpl NE 'D' )
          OR <ls_oferta>-z_temerari   NE space .
        l_exclos_bis = 'X' .
      ENDIF.

*-- Percentatge de baixa -------------------------------------
      ">>>  SPEC-57843 Inici Modificació ETXGL
*    lv_numerator   = ls_cost_projecte-total.
*    lv_denominator = my_exp_cont-z_pressup_licit.

      lv_value_sense_iva = abap_off.

      SELECT SINGLE value
       FROM zsap_dt_param_hc
        INTO lv_value_sense_iva
            WHERE repid = co_programa
              AND field_info = co_nom_fitxer.

      lv_numerator = abap_off.
      lv_denominator = abap_off.

      IF lv_value_sense_iva IS NOT INITIAL.
        lv_numerator   = ls_cost_projecte-base.
        lv_denominator = my_exp_cont-z_pres_licit_b.
      ELSEIF lv_value_sense_iva IS INITIAL.
        lv_numerator   = ls_cost_projecte-total.
        lv_denominator = my_exp_cont-z_pressup_licit.
      ENDIF.
      "<<<  SPEC-57843 Final Modificació ETXGL

      IF l_exclos EQ 'X'
        AND im_sort_by NE 'BAIXA_INT'
        AND im_sort_by NE 'COST_INT' .
        CLEAR: ls_quadre3-baixa,
               ls_quadre3-baixa_int.
      ELSE.
        CALL METHOD get_quadre3_baixa
          EXPORTING
            im_numerator   = lv_numerator
            im_denominator = lv_denominator
          IMPORTING
            ex_baixa       = ls_quadre3-baixa
            ex_baixa_int   = ls_quadre3-baixa_int.
      ENDIF.

      lv_numerator = abap_off.
      lv_denominator = abap_off.

*-- Percentatge de baixa amb homog.----------------------------
      lv_numerator = ls_cost_projecte-total_homog .
      lv_denominator = my_exp_cont-z_pressup_licit .
      IF      l_exclos   EQ 'X'
         AND  im_sort_by NE 'BAIXA_INT'
         AND  im_sort_by NE 'COST_INT' .
        CLEAR: ls_quadre3-baixa_homog,
               ls_quadre3-baixa_homog_int .
      ELSE .
        CALL METHOD get_quadre3_baixa
          EXPORTING
            im_numerator   = lv_numerator
            im_denominator = lv_denominator
          IMPORTING
            ex_baixa       = ls_quadre3-baixa_homog
            ex_baixa_int   = ls_quadre3-baixa_homog_int.
      ENDIF .

*-- Compleix i Compleix Homog.-------------------------------
      IF     l_exclos     EQ 'X'
         AND l_exclos_bis EQ space .
        CLEAR ls_quadre3-compleix .
      ELSE .
        IF <ls_oferta>-z_compleix_cond IS INITIAL .
          ls_quadre3-compleix = 'No' .
        ELSE .
          ls_quadre3-compleix = 'Sí' .
        ENDIF .

        IF <ls_oferta>-z_compleix_homog IS INITIAL .
          ls_quadre3-compleix_homog = 'No' .
        ELSE .
          ls_quadre3-compleix_homog = 'Sí' .
        ENDIF .
      ENDIF .

      IF my_exp_cont-z_req_homog IS INITIAL .
        ls_quadre3-compleix_homog = ls_quadre3-compleix .
      ENDIF .

      DEFINE _format_prorr_per .
        l_import_calcul = &2 * &1 / 100.
        _format_number: l_import_calcul &3 .
      END-OF-DEFINITION .

      DEFINE _format_prorr .
        l_import_calcul = &1 * &2.
        _format_number: l_import_calcul &3 .
      END-OF-DEFINITION .
*    Es consulta a la taula ZRM_DT_LIC_PER si hi ha un repartiment especial per aquesta licitació.
      CLEAR: l_proj, l_dir.
      SELECT z_pcost_projecte z_pcost_direccio INTO (l_proj, l_dir)
                                               FROM zrm_dt_lic_per
                                              WHERE z_codi_exp = my_exp_cont-z_codi_exp.
      ENDSELECT.
      IF sy-subrc = 0.
        _format_prorr_per:  l_dir  ls_cost_projecte-base   ls_quadre3-cost_direccio_30,
                            l_dir  ls_cost_projecte-total  ls_quadre3-cost_direccio_30_total,
                            l_proj ls_cost_projecte-base   ls_quadre3-cost_projecte_70,
                            l_proj ls_cost_projecte-total  ls_quadre3-cost_projecte_70_total,

                            l_dir  ls_cost_projecte-base   ls_quadre3-cost_direccio_35,
                            l_dir  ls_cost_projecte-total  ls_quadre3-cost_direccio_35_total,
                            l_proj ls_cost_projecte-base   ls_quadre3-cost_projecte_65,
                            l_proj ls_cost_projecte-total  ls_quadre3-cost_projecte_65_total,

                            l_dir  ls_cost_projecte-base   ls_quadre3-cost_direccio_34,
                            l_dir  ls_cost_projecte-total  ls_quadre3-cost_direccio_34_total,
                            l_proj ls_cost_projecte-base   ls_quadre3-cost_projecte_66,
                            l_proj ls_cost_projecte-total  ls_quadre3-cost_projecte_66_total.
      ELSE.
        IF my_exp_cont-z_subtipus_cont EQ 'PI'
          AND my_imp_cap-z_import_pec_b < 1000000
          AND my_exp_cont-z_data_creacio > '20150923'.

          _format_prorr:  '0.20' ls_cost_projecte-base   ls_quadre3-cost_direccio_30,
                          '0.20' ls_cost_projecte-total  ls_quadre3-cost_direccio_30_total,
                          '0.80' ls_cost_projecte-base   ls_quadre3-cost_projecte_70,
                          '0.80' ls_cost_projecte-total  ls_quadre3-cost_projecte_70_total,

                          '0.20' ls_cost_projecte-base   ls_quadre3-cost_direccio_35,
                          '0.20' ls_cost_projecte-total  ls_quadre3-cost_direccio_35_total,
                          '0.80' ls_cost_projecte-base   ls_quadre3-cost_projecte_65,
                          '0.80' ls_cost_projecte-total  ls_quadre3-cost_projecte_65_total,
                          '0.20' ls_cost_projecte-base   ls_quadre3-cost_direccio_34,
                          '0.20' ls_cost_projecte-total  ls_quadre3-cost_direccio_34_total,
                          '0.80' ls_cost_projecte-base   ls_quadre3-cost_projecte_66,
                          '0.80' ls_cost_projecte-total  ls_quadre3-cost_projecte_66_total.
        ELSE.
*-- Costos ---------------------------------------------------
          _format_prorr:  '0.30' ls_cost_projecte-base   ls_quadre3-cost_direccio_30,
                          '0.30' ls_cost_projecte-total  ls_quadre3-cost_direccio_30_total,
                          '0.70' ls_cost_projecte-base   ls_quadre3-cost_projecte_70,
                          '0.70' ls_cost_projecte-total  ls_quadre3-cost_projecte_70_total,
                          '0.35' ls_cost_projecte-base   ls_quadre3-cost_direccio_35,
                          '0.35' ls_cost_projecte-total  ls_quadre3-cost_direccio_35_total,
                          '0.65' ls_cost_projecte-base   ls_quadre3-cost_projecte_65,
                          '0.65' ls_cost_projecte-total  ls_quadre3-cost_projecte_65_total,
                           '0.34' ls_cost_projecte-base   ls_quadre3-cost_direccio_34,
                           '0.34' ls_cost_projecte-total  ls_quadre3-cost_direccio_34_total,
                           '0.66' ls_cost_projecte-base   ls_quadre3-cost_projecte_66,
                           '0.66' ls_cost_projecte-total  ls_quadre3-cost_projecte_66_total.
        ENDIF.
      ENDIF.

      _format_number: <ls_oferta>-z_cost_obra_b    ls_quadre3-z_cost_obra,
                      <ls_oferta>-z_cost_obra      ls_quadre3-z_cost_obra_total,
                      <ls_oferta>-z_cost_proj_b    ls_quadre3-z_cost_projecte,
                      <ls_oferta>-z_cost_projecte  ls_quadre3-z_cost_projecte_total,
                      <ls_oferta>-z_cost_dir_b     ls_quadre3-z_cost_direccio,
                      <ls_oferta>-z_cost_direccio  ls_quadre3-z_cost_direccio_total.


*-- Terminis de projecte i obra ------------------------------
      ls_quadre3-z_termini_projecte = get_quadre3_durada( im_durada = <ls_oferta>-z_termini_proj
                                                          im_unit   = <ls_oferta>-z_unit_term_proj ).

      ls_quadre3-z_termini_obra = get_quadre3_durada( im_durada = <ls_oferta>-z_termini_obra
                                                      im_unit   = <ls_oferta>-z_unit_term_obra ).


*-- Crèdit ---------------------------------------------------
      WRITE my_exp_cont-z_max_credit TO ls_quadre3-credit DECIMALS 0.
      CONCATENATE ls_quadre3-credit '%' INTO ls_quadre3-credit.

*-- Termini del crèdit ---------------------------------------
      ls_quadre3-termini_credit = get_quadre3_durada( im_durada = my_exp_cont-z_durad_max_cred
                                                      im_unit   = my_exp_cont-z_un_max_cred ).

*-- Interès MIBOR/EURIBOR-------------------------------------
      IF <ls_oferta>-z_tipus_interes EQ 0 .
        ls_quadre3-int_mibor   = 'MIBOR' .
        ls_quadre3-int_euribor = 'EURIBOR' .
      ELSE .
        WRITE <ls_oferta>-z_tipus_interes TO l_char80 DECIMALS 2 LEFT-JUSTIFIED.
        CONCATENATE `M + ` l_char80 INTO ls_quadre3-int_mibor .
        CONCATENATE `E + ` l_char80 INTO ls_quadre3-int_euribor .
      ENDIF .

*-- Interès de compensació financera --------------------------
      WRITE <ls_oferta>-z_int_comp_fin TO l_char80 DECIMALS 2 LEFT-JUSTIFIED.
      CONCATENATE `E + ` l_char80 INTO ls_quadre3-int_comp_fin .

*-- Import de la compensació financera ------------------------
      _format_number: <ls_oferta>-z_imp_com_fin_b ls_quadre3-imp_comp_fin,
                      <ls_oferta>-z_imp_com_fin   ls_quadre3-imp_comp_fin_total .

*-- Baixa amb compensació financera ---------------------------
      IF      l_exclos    EQ 'X'
         AND  im_sort_by  NE 'BAIXA_COMP_FIN_INT'
         AND l_exclos_bis EQ space .
        CLEAR: ls_quadre3-baixa_comp_fin,
               ls_quadre3-baixa_comp_fin_int .
      ELSE .
        lv_numerator   = <ls_oferta>-z_imp_com_fin     + ls_cost_projecte-total .
        lv_denominator = my_exp_cont-z_import_comp_fi  + my_exp_cont-z_pressup_licit.
        CALL METHOD get_quadre3_baixa
          EXPORTING
            im_numerator   = lv_numerator
            im_denominator = lv_denominator
          IMPORTING
            ex_baixa       = ls_quadre3-baixa_comp_fin
            ex_baixa_int   = ls_quadre3-baixa_comp_fin_int.
      ENDIF .
*-- Cost financer ----------------------------------------------
      _format_number: <ls_oferta>-z_estalvi_fin_b ls_quadre3-cost_financer,
                      <ls_oferta>-z_estalvi_fin   ls_quadre3-cost_financer_total .

*-- Homogeneïtzat amb cost financer ----------------------------
      IF l_exclos EQ 'X' .
        ls_quadre3-homogeneitzat_cost_fin       = 'Exclòs'(001) .
        ls_quadre3-homogeneitzat_cost_fin_total = 'Exclòs'(001) .
      ELSE .
        l_import_calcul = ls_cost_projecte-base + <ls_oferta>-z_estalvi_fin_b .
        _format_number: l_import_calcul ls_quadre3-homogeneitzat_cost_fin .
        l_import_calcul = ls_cost_projecte-total + <ls_oferta>-z_estalvi_fin .
        _format_number: l_import_calcul ls_quadre3-homogeneitzat_cost_fin_total .
      ENDIF .

*-- Baixa amb cost financer ------------------------------------
      IF     l_exclos   EQ 'X'
         AND im_sort_by NE  'BAIXA_OFERTA_COST_FIN_INT'
         AND l_exclos_bis EQ space .
        CLEAR: ls_quadre3-baixa_oferta_cost_fin,
               ls_quadre3-baixa_oferta_cost_fin_int.
      ELSE .
        lv_numerator   = ls_cost_projecte-total + <ls_oferta>-z_estalvi_fin .
        lv_denominator = my_exp_cont-z_pressup_licit .
        CALL METHOD get_quadre3_baixa
          EXPORTING
            im_numerator   = lv_numerator
            im_denominator = lv_denominator
          IMPORTING
            ex_baixa       = ls_quadre3-baixa_oferta_cost_fin
            ex_baixa_int   = ls_quadre3-baixa_oferta_cost_fin_int.
      ENDIF .

*-- Homogeneïtzat amb compensació financera i cost financer -----
      IF l_exclos EQ 'X' .
        ls_quadre3-homogeneitzat_comp_fin       =  '(1)'.
        ls_quadre3-homogeneitzat_comp_fin_total =  '(1)'.
      ELSE .
        l_import_calcul = ls_cost_projecte-base + <ls_oferta>-z_estalvi_fin_b
                        + <ls_oferta>-z_imp_com_fin_b .
        _format_number: l_import_calcul ls_quadre3-homogeneitzat_comp_fin .
        l_import_calcul = ls_cost_projecte-total + <ls_oferta>-z_estalvi_fin
                        + <ls_oferta>-z_imp_com_fin .
        _format_number: l_import_calcul ls_quadre3-homogeneitzat_comp_fin_total .
      ENDIF .

*-- Baixa amb compensació financera i cost financer -------------
      IF     l_exclos   EQ 'X'
         AND im_sort_by NE 'BAIXA_COMP_FINANCERA_COST_INT'
         AND l_exclos_bis EQ space .
        CLEAR: ls_quadre3-baixa_comp_financera_cost,
               ls_quadre3-baixa_comp_financera_cost_int .
      ELSE .
        lv_numerator   = <ls_oferta>-z_imp_com_fin    + <ls_oferta>-z_estalvi_fin + ls_cost_projecte-total .
        lv_denominator = my_exp_cont-z_import_comp_fi + my_exp_cont-z_pressup_licit .
        CALL METHOD get_quadre3_baixa
          EXPORTING
            im_numerator   = lv_numerator
            im_denominator = lv_denominator
          IMPORTING
            ex_baixa       = ls_quadre3-baixa_comp_financera_cost
            ex_baixa_int   = ls_quadre3-baixa_comp_financera_cost_int.
      ENDIF .
      IF my_exp_cont-z_llei92017 = abap_on AND my_exp_cont-z_obert_preu = abap_off.
        "Per la nova llei, i expedients de licitació oberts no preu, es calcula el valor de la puntuació econòmica per a mostar-lo al Quadre 3A a la columna PUNTS
        LOOP AT lt_punt_gen ASSIGNING FIELD-SYMBOL(<fs_punt_oferta>) WHERE z_num_gen = <ls_oferta>-z_num_ofer.
          ls_quadre3-z_punt_econ = <fs_punt_oferta>-z_punts.
        ENDLOOP.
      ENDIF.

      APPEND ls_quadre3 TO <lt_quadre3> .
    ENDLOOP .

    IF im_sort_by EQ 'COST_INT' .
      SORT <lt_quadre3> BY cost_int ASCENDING .
    ELSE .
      SORT <lt_quadre3> BY (im_sort_by) DESCENDING .
    ENDIF .

*-- El número d'agrupador d'empreses s'ha de mantenir coherent per al quadre base
*-- i el quadre variant. Aixó que calculem el Quadre sencer i després descartem el
*-- que no necessitem
    LOOP AT <lt_quadre3> INTO ls_quadre3 .
      READ TABLE lt_ofertes ASSIGNING <ls_oferta> WITH TABLE KEY z_num_ofer = ls_quadre3-z_num_ofer .
      CHECK NOT <ls_oferta>-all_konzs IS INITIAL .
      LOOP AT <ls_oferta>-all_konzs INTO l_last_konzs .
        READ TABLE lt_group TRANSPORTING NO FIELDS WITH TABLE KEY table_line = l_last_konzs .
        CHECK sy-subrc NE 0 .
        INSERT l_last_konzs INTO TABLE lt_group .
      ENDLOOP .
    ENDLOOP .

    LOOP AT <lt_quadre3> INTO ls_quadre3 .
      CLEAR l_prefix .
      CLEAR l_prefix_homog.
      READ TABLE lt_ofertes ASSIGNING <ls_oferta> WITH TABLE KEY z_num_ofer = ls_quadre3-z_num_ofer .
      LOOP AT <ls_oferta>-all_konzs INTO l_last_konzs .
        READ TABLE lt_group TRANSPORTING NO FIELDS WITH TABLE KEY table_line = l_last_konzs .
        l_num_grup = sy-tabix .
        CONDENSE l_num_grup .
        CONCATENATE l_prefix ` (` l_num_grup `) ` INTO l_prefix .
        l_prefix_homog = l_prefix.

* El camp COMPLEIX i COMPLEIX_HOMOG només ha d'aparèixer informat pel primer component d'un grup d'empreses.
* Per a la resta ha de sortir en blanc. Quan l'empresa pertany a més d'un grup d'empreses el camp s'informa si és
* la primera vegada que apareix per a qualssevol del grups als que pertany
        IF ls_quadre3-z_tipus_oferta EQ im_tipus_oferta .
          READ TABLE lt_group_compleix TRANSPORTING NO FIELDS WITH TABLE KEY table_line = l_last_konzs .
          IF sy-subrc EQ 0 .
            CLEAR: ls_quadre3-compleix,
                   ls_quadre3-compleix_homog .
            MODIFY <lt_quadre3> FROM ls_quadre3 TRANSPORTING compleix compleix_homog.
          ELSE .
            INSERT l_last_konzs INTO TABLE lt_group_compleix .
          ENDIF .
        ENDIF .
      ENDLOOP .
      IF lv_form_temeritat <> 'TX1'.
        IF  <ls_oferta>-z_presump_temer EQ 'X' .
          CONCATENATE `(*) ` l_prefix INTO l_prefix .
        ENDIF .

        IF ( <ls_oferta>-z_import_homog IS NOT INITIAL AND <ls_oferta>-z_pres_tem_homog EQ 'X').
          CONCATENATE `(*) ` l_prefix_homog INTO l_prefix_homog .
        ENDIF.
      ENDIF.
      l_empresa = ls_quadre3-empresa.

      CONCATENATE l_prefix l_empresa INTO ls_quadre3-empresa.
      CONDENSE ls_quadre3-empresa.
      MODIFY <lt_quadre3> FROM ls_quadre3 TRANSPORTING empresa .

      IF my_exp_cont-z_req_homog IS INITIAL .
        ls_quadre3-empresa_homog = ls_quadre3-empresa .
      ELSE .
        CONCATENATE l_prefix_homog l_empresa INTO ls_quadre3-empresa_homog.
        CONDENSE ls_quadre3-empresa_homog.
      ENDIF .
      MODIFY <lt_quadre3> FROM ls_quadre3 TRANSPORTING empresa_homog .
    ENDLOOP .

    DELETE <lt_quadre3> WHERE z_tipus_oferta NE im_tipus_oferta .

*--- Taula de Vincles -----------------------------------------------------------

* Hem de tenir en compte les ofertes (base o variant) de proveïdor pertanyents a grups
* d'empreses però només si un altre integrant del grup també presenta oferta
* Una empresa que sigui UTE s'ha d'avaluar una vegada per cada Grup d'empreses a la que
* pertany (potencialment: el grup de la UTE i el grup de cadascun dels seus components)
    CALL METHOD get_vincles
      EXPORTING
        im_ofertes   = lt_ofertes
        im_group     = lt_group
        im_req_homog = my_exp_cont-z_req_homog
      CHANGING
        ch_vincles   = <lt_vincle>.
  ENDMETHOD.


  METHOD get_sel2v.
    TYPES: ty_s_data TYPE zerm_quadre_sel2v,
           ty_t_data TYPE STANDARD TABLE OF ty_s_data
                      WITH NON-UNIQUE DEFAULT KEY .

    DATA: ls_data    TYPE ty_s_data,
          lt_ofertes TYPE ty_t_oferta.

    FIELD-SYMBOLS: <lt_data>   TYPE ty_t_data,
                   <ls_oferta> TYPE ty_s_oferta.

    IF my_sel2v IS BOUND .
      ex_data = my_sel2v .
      RETURN .
    ENDIF .

    CREATE DATA my_sel2v TYPE ty_t_data .
    ex_data = my_sel2v .
    ASSIGN ex_data->* TO <lt_data> .

    CALL METHOD get_ofertes
      EXPORTING
        im_docclass = im_docclass
        im_objectid = im_objectid
      IMPORTING
        ex_ofertes  = lt_ofertes.

    SORT lt_ofertes BY z_punts_ofert DESCENDING .
    LOOP AT lt_ofertes ASSIGNING <ls_oferta> WHERE z_sel_2volta EQ 'X'.
      READ TABLE <lt_data> TRANSPORTING NO FIELDS
            WITH KEY proveidor = <ls_oferta>-proveidor .
      CHECK sy-subrc NE 0 .
      ls_data-proveidor     = <ls_oferta>-proveidor .
      ls_data-nom_proveidor = <ls_oferta>-nom_proveidor .
      CONCATENATE '-' ls_data-nom_proveidor INTO ls_data-nom_proveidor_llistat SEPARATED BY space.
      APPEND ls_data TO <lt_data> .
    ENDLOOP .

  ENDMETHOD.


  METHOD get_siesm_no_excl_sx.

    DATA: lt_valcrit     TYPE ty_t_valcrit,
          lt_valcrit_aux TYPE ty_t_valcrit,
          wa_valcrit     TYPE ty_s_valcrit,
          ls_esmena_sx   TYPE LINE OF ty_t_esmena_sx,
          ls_lfa1        TYPE lfa1.

    FIELD-SYMBOLS: <ls_valcrit>   TYPE ty_s_valcrit,
                   <lt_esmena_sx> TYPE ty_t_esmena_sx,
                   <my_cached>    TYPE REF TO data.

    CASE im_num_sob .
      WHEN '1' .    ASSIGN my_siesm_noexcl_s1 TO <my_cached> .
      WHEN '3'.     ASSIGN my_siesm_noexcl_s3 TO <my_cached> .
      WHEN OTHERS . RETURN .
    ENDCASE .

    IF <my_cached> IS BOUND .
      ex_data = <my_cached> .
      RETURN .
    ENDIF .

    CASE im_num_sob.
      WHEN '3'.
        CALL METHOD get_valcrit
          EXPORTING
            im_docclass = im_docclass
            im_objectid = im_objectid
          IMPORTING
            ex_valcrit  = lt_valcrit.

**      >> INI MODIF ETODR SPEC-52966
        CREATE DATA <my_cached> TYPE ty_t_esmena_sx .
        ASSIGN <my_cached>->* TO <lt_esmena_sx> .
**      << FI MODIF ETODR SPEC-52966

        CLEAR: lt_valcrit_aux[].
        LOOP AT lt_valcrit ASSIGNING <ls_valcrit> WHERE ( z_esmenat EQ 'X' ) .
          IF <ls_valcrit>-z_exclos_s3 = abap_off.
            CLEAR: wa_valcrit.
            MOVE-CORRESPONDING <ls_valcrit> TO wa_valcrit.
            APPEND wa_valcrit TO lt_valcrit_aux.
          ENDIF.
        ENDLOOP .

        LOOP AT lt_valcrit_aux ASSIGNING <ls_valcrit>.
          CALL METHOD fill_esmena
            EXPORTING
              im_valcrit = <ls_valcrit>
            CHANGING
              cs_esmena  = ls_esmena_sx.
          APPEND ls_esmena_sx TO <lt_esmena_sx> .
        ENDLOOP.

        SORT <lt_esmena_sx> BY proveidor.
        DELETE ADJACENT DUPLICATES FROM <lt_esmena_sx> COMPARING proveidor.

        SORT <lt_esmena_sx> BY nom_proveidor .

        ex_data = <my_cached>.

      WHEN '2'.
      WHEN OTHERS.

        CALL METHOD get_valcrit
          EXPORTING
            im_docclass = im_docclass
            im_objectid = im_objectid
          IMPORTING
            ex_valcrit  = lt_valcrit.


        CREATE DATA <my_cached> TYPE ty_t_esmena_sx .
        ASSIGN <my_cached>->* TO <lt_esmena_sx> .

        IF im_num_sob EQ '1' .
          DELETE lt_valcrit WHERE z_tipus_oferta EQ gc_oferta_variant .
        ENDIF .

        CLEAR: lt_valcrit_aux[].
        LOOP AT lt_valcrit ASSIGNING <ls_valcrit> WHERE ( z_esmenat EQ 'X' ) .
          IF <ls_valcrit>-z_exclos_s1s2 = abap_off.
            CLEAR: wa_valcrit.
            MOVE-CORRESPONDING <ls_valcrit> TO wa_valcrit.
            APPEND wa_valcrit TO lt_valcrit_aux.
          ENDIF.
        ENDLOOP .

        LOOP AT lt_valcrit_aux ASSIGNING <ls_valcrit>.
          CALL METHOD fill_esmena
            EXPORTING
              im_valcrit = <ls_valcrit>
            CHANGING
              cs_esmena  = ls_esmena_sx.
          APPEND ls_esmena_sx TO <lt_esmena_sx> .
        ENDLOOP.

        SORT <lt_esmena_sx> BY proveidor.
        DELETE ADJACENT DUPLICATES FROM <lt_esmena_sx> COMPARING proveidor.

        SORT <lt_esmena_sx> BY nom_proveidor .

        ex_data = <my_cached>.

    ENDCASE.
  ENDMETHOD.


  METHOD get_si_exclos_no_esmenat_sde.

    DATA: ls_esmena_sx TYPE LINE OF ty_t_esmena_sx.
    DATA: lt_ofertes   TYPE TABLE OF zrm_dt_ofertes.
    DATA: ls_oferta    TYPE          zrm_dt_ofertes.

    FIELD-SYMBOLS: <lt_esmena_sx> TYPE ty_t_esmena_sx.

    IF my_si_exclos_no_esmenat_sde IS BOUND.
      ex_data = my_si_exclos_no_esmenat_sde.
      RETURN.
    ENDIF.

    CREATE DATA my_si_exclos_no_esmenat_sde TYPE ty_t_esmena_sx.
    ex_data = my_si_exclos_no_esmenat_sde.

    ASSIGN ex_data->* TO <lt_esmena_sx>.

    REFRESH lt_ofertes. CLEAR ls_oferta.

    SELECT * INTO TABLE lt_ofertes FROM zrm_dt_ofertes
      WHERE docclass  EQ im_docclass AND objectid EQ im_objectid.

    IF sy-subrc NE 0.
      RAISE not_found.
    ENDIF.

    DELETE lt_ofertes WHERE NOT ( z_exclos_s3           EQ  'X' OR
                                  z_excl_homog          EQ  'X' OR
                                  z_excl_punt_tec       EQ  'X' OR
                                  z_exclos_s1           EQ  'X' OR
                                  z_exc_relrol          EQ  'X' OR
                                  z_exclos_clau         EQ  'X' OR
                                  z_exclos_s2           EQ  'X' OR
                                  z_exclos_var_tec      EQ  'X' OR
                                  z_excl_solv_tec       EQ  'X' OR
                                  z_exclos_s3_postob    EQ  'X' OR
                                  z_exclos_req          EQ  'X' OR
                                  z_exclos_plec         EQ  'X' OR
                                  z_exclos_carrecs      EQ  'X' OR
                                  z_exclos_po_pt        EQ  'X' OR
                                  z_exclos_cont_s3_a_s2 EQ  'X' ).

    REFRESH <lt_esmena_sx>.
    LOOP AT lt_ofertes INTO ls_oferta.

      CLEAR ls_esmena_sx.

      ls_esmena_sx-proveidor     = ls_oferta-proveidor.
      ls_esmena_sx-nom_proveidor = get_vendor_name( ls_esmena_sx-proveidor ) .
      ls_esmena_sx-z_num_ofer    = ls_oferta-z_codi_excl_s3.

      SELECT SINGLE z_descripcio INTO ls_esmena_sx-z_motiu_esmena
        FROM zrm_dm_exlc_s3t WHERE spras          EQ sy-langu AND
                                   z_codi_excl_s3 EQ ls_oferta-z_codi_excl_s3.

      APPEND ls_esmena_sx TO <lt_esmena_sx>.

    ENDLOOP.

  ENDMETHOD.


  METHOD get_text_sapscript.
    DATA: lo_sapscript   TYPE REF TO zrm_cl_sapscript_texts,
          lv_string_text TYPE string.


    FIELD-SYMBOLS: <fs_data>  TYPE string.

    CREATE DATA my_text_sapscript TYPE string .
    ro_data = my_text_sapscript.
    ASSIGN ro_data->* TO <fs_data> .

    CREATE OBJECT lo_sapscript
      EXPORTING
        i_tdid       = iv_tdid
        i_tdspras    = sy-langu
        i_tdobject   = iv_tdobject
        i_tdname     = iv_tdname
      EXCEPTIONS
        invalid_call = 1
        OTHERS       = 2.
    CHECK sy-subrc = 0 AND lo_sapscript IS BOUND.

    lo_sapscript->get_text_as_string( IMPORTING ex_string = lv_string_text ).
    <fs_data> = lv_string_text.

  ENDMETHOD.


  METHOD get_text_tipol_variable.
    TYPES: BEGIN OF ty_s_data,
             text_tipologia TYPE char50,
           END   OF ty_s_data.
    FIELD-SYMBOLS: <ls_data> TYPE ty_s_data .

    CREATE DATA ex_data TYPE ty_s_data .
    ASSIGN ex_data->* TO <ls_data> .

    SELECT SINGLE z_subtipus_cont
      FROM zrm_dt_exp_cont
      INTO @DATA(lv_subtipus_contracte)
      WHERE docclass = @im_docclass
        AND objectid = @im_objectid.

    SELECT SINGLE value
      FROM zsap_dt_param_hc
      INTO @DATA(lv_text_tipologia)
      WHERE repid       = 'GET_TEXT_TIPOL_VARIABLE'
        AND field_info  = @lv_subtipus_contracte.

    <ls_data>-text_tipologia = lv_text_tipologia.

  ENDMETHOD.


  METHOD get_tipol_fix.
*-----------------------------------------------------------------------
* AUTOR: ECFA
* DATA CREACIÓ: 04.02.2021 19:58:02
* SPEC/TASCA: SPEC-62739
* TÍTOL: Comprova si és licitació amb tipologia econòmica fixa
* DESCRIPCIÓ: Comprova si és licitació amb tipologia econòmica fixa
*-----------------------------------------------------------------------

    TYPES: BEGIN OF ty_s_data,
             tipologia_economica TYPE xfeld,
           END   OF ty_s_data.

    FIELD-SYMBOLS: <ls_data> TYPE ty_s_data .

    CONSTANTS: lc_perc_baix_bossa TYPE z_tipus_ofer VALUE '3',
               lc_imp_bossa       TYPE z_tipus_ofer VALUE '4'.

    DATA: lt_tip_eco TYPE TABLE OF zrm_dt_tip_eco,
          lt_collect TYPE TABLE OF zrm_dt_tip_eco,
          ls_tip_eco TYPE          zrm_dt_tip_eco.

    CREATE DATA ex_data TYPE ty_s_data .

    "Assignem l'estructura a l'estructura amb la que treballarem
    ASSIGN ex_data->* TO <ls_data> .

    "verifiquem si existeix la licitació amb el tipus d'imports fixos que son el
    " 3(Percentatge de baixa bossa) o el 4(Import de bossa)
    SELECT *
      INTO TABLE lt_tip_eco
      FROM zrm_dt_tip_eco
      WHERE docclass = im_docclass
       AND  objectid = im_objectid
       AND ( tipus_ofer = lc_perc_baix_bossa
            OR tipus_ofer = lc_imp_bossa ).

    "si em obtingut les dades, marquem els camps de tipologia com a com a true
    CHECK lt_tip_eco IS NOT INITIAL.

    <ls_data>-tipologia_economica = abap_true.


  ENDMETHOD.


  METHOD get_tipol_variable.

    TYPES: BEGIN OF ty_s_data,
             tipologia_economica TYPE xfeld,
           END   OF ty_s_data.
    FIELD-SYMBOLS: <ls_data> TYPE ty_s_data .

    DATA: lt_tip_eco           TYPE TABLE OF zrm_dt_tip_eco,
          lt_collect           TYPE TABLE OF zrm_dt_tip_eco,
          ls_tip_eco           TYPE          zrm_dt_tip_eco,
          lv_te_tipologia_econ TYPE xfeld.

    CREATE DATA ex_data TYPE ty_s_data .
    ASSIGN ex_data->* TO <ls_data> .

    lv_te_tipologia_econ = abap_false.

    SELECT *
      INTO TABLE lt_tip_eco
      FROM zrm_dt_tip_eco
      WHERE docclass = im_docclass
       AND  objectid = im_objectid
       AND ( tipus_ofer = 3 OR tipus_ofer = 4 ).

    CHECK lt_tip_eco IS NOT INITIAL.

    lv_te_tipologia_econ          = abap_on.
    <ls_data>-tipologia_economica = lv_te_tipologia_econ.

  ENDMETHOD.


  METHOD get_tipus_exclus_s2.

    DATA: lt_valcrit        TYPE ty_t_valcrit,
          ls_exclusio_sx    TYPE LINE OF ty_t_exclusio_sx,
          lt_excl2_inf_econ TYPE TABLE OF zrm_dt_ofertes,
          wa_excl2_inf_econ TYPE zrm_dt_ofertes.

    FIELD-SYMBOLS: "<ls_valcrit>     TYPE ty_s_valcrit,
      <lt_exclusio_sx> TYPE ty_t_exclusio_sx,
      <my_cached>      TYPE REF TO data.

    ASSIGN my_exclusio_s2 TO <my_cached>.

    IF <my_cached> IS BOUND .
      ex_data = <my_cached> .
      RETURN .
    ENDIF .

    CREATE DATA <my_cached> TYPE ty_t_exclusio_sx .
    ASSIGN <my_cached>->* TO <lt_exclusio_sx> .


    SELECT *
      FROM zrm_dt_ofertes
      INTO TABLE lt_excl2_inf_econ
      WHERE docclass       EQ im_docclass AND
            objectid       EQ im_objectid AND
            ( z_tipus_exc_s2 = 'GE'
          OR  z_tipus_exc_s2 = 'CA' ). " SPEC-52625

    LOOP AT lt_excl2_inf_econ INTO wa_excl2_inf_econ.
      ls_exclusio_sx-proveidor     = wa_excl2_inf_econ-proveidor.
      ls_exclusio_sx-nom_proveidor = get_vendor_name( wa_excl2_inf_econ-proveidor ).
      ls_exclusio_sx-z_num_ofer    = wa_excl2_inf_econ-z_num_ofer.
**     >> INI MODIF ETODR SPEC-52625
      IF wa_excl2_inf_econ-z_tipus_exc_s2 = 'CA'.
        CONCATENATE text-010 text-011 INTO ls_exclusio_sx-z_motiu_esmena SEPARATED BY space.
        APPEND ls_exclusio_sx TO <lt_exclusio_sx> .
      ELSEIF wa_excl2_inf_econ-z_tipus_exc_s2 = 'GE'.
**     << FI MODIF ETODR SPEC-52625
        CONCATENATE text-007 text-008 INTO ls_exclusio_sx-z_motiu_esmena SEPARATED BY space.
        APPEND ls_exclusio_sx TO <lt_exclusio_sx> .
      ENDIF.
    ENDLOOP.



    SORT  <lt_exclusio_sx> BY nom_proveidor .
    ex_data = <my_cached>.

  ENDMETHOD.


  METHOD get_ute_data.
    FIELD-SYMBOLS: <ls_ute_data> LIKE LINE OF re_ute_data .

    SELECT * INTO CORRESPONDING FIELDS OF TABLE re_ute_data
          FROM zmm_dt_ute WHERE lifnr EQ im_lifnr .

    LOOP AT re_ute_data ASSIGNING <ls_ute_data> .
      <ls_ute_data>-vendor_data = complete_vendor_data( <ls_ute_data>-zprovcompute ) .
    ENDLOOP .

  ENDMETHOD.


  METHOD get_valcrit.
    IF my_valoracio_criteris IS INITIAL .
      SELECT DISTINCT a~z_num_ofer,     a~proveidor,      a~z_exclos_s3,
                  a~z_codi_excl_s3, a~z_tipus_oferta, a~z_exclos_s2,
                  a~z_exclos_var_tec,
                  b~z_num_doc,     b~zprovcompute,    b~z_lliurat,
                  b~z_correcte,    b~z_esmenat,       "b~z_data_esmena,
                  b~z_data_esmena, b~z_exclos_s1s2,   b~z_excl_pos_esm,
                  c~z_num_sob,     a~z_pres_proposta, b~z_sec_s1,  "EDLSM
                  b~z_tipus_sob,   a~objectid,
                  a~z_esmena_s3, a~z_exclos_s3_postob, "SPEC-53131
                  a~z_exclos_clau "SPEC-55767
           INTO CORRESPONDING FIELDS OF TABLE @my_valoracio_criteris
                         FROM zrm_dt_ofertes  AS a
                         JOIN zrm_dt_val_crit AS b
                           ON a~docclass      EQ b~docclass
                          AND a~objectid      EQ b~objectid
                          AND a~z_num_ofer    EQ b~z_num_ofer
                         JOIN zrm_dm_sobres   AS c ON b~z_tipus_sob    EQ c~z_tipus_sob
          WHERE     a~docclass  EQ @im_docclass
                AND a~objectid  EQ @im_objectid
                AND b~z_no_aplica EQ ''.

      SELECT *
        FROM zrm_dm_docs
        INTO TABLE @DATA(lt_docs)
         FOR ALL ENTRIES IN @my_valoracio_criteris
       WHERE z_num_doc  EQ @my_valoracio_criteris-z_num_doc AND
             z_opcional EQ @abap_true.

      LOOP AT lt_docs ASSIGNING FIELD-SYMBOL(<fs_doc>).
        DELETE my_valoracio_criteris WHERE z_num_doc EQ <fs_doc>-z_num_doc.
      ENDLOOP.
      CHECK my_valoracio_criteris IS NOT INITIAL.
      SELECT objectid, z_llei92017
        FROM zrm_dt_exp_cont
        INTO TABLE @DATA(lt_exps)
        FOR ALL ENTRIES IN @my_valoracio_criteris
        WHERE objectid = @my_valoracio_criteris-objectid.

      LOOP AT my_valoracio_criteris ASSIGNING FIELD-SYMBOL(<fs_val>).
        READ TABLE lt_exps ASSIGNING FIELD-SYMBOL(<fs_exp>) WITH KEY objectid = <fs_val>-objectid.
        CHECK sy-subrc EQ 0.
        <fs_val>-z_llei92017 = <fs_exp>-z_llei92017.
      ENDLOOP.

      SORT my_valoracio_criteris BY z_num_ofer .
    ENDIF .
    ex_valcrit = my_valoracio_criteris .
  ENDMETHOD.


  METHOD get_vendor_name.
    DATA: l_name1 TYPE lfa1-name1,
          l_name2 TYPE lfa1-name2,
          l_name3 TYPE lfa1-name3,
          l_name4 TYPE lfa1-name4.

    SELECT SINGLE name1 name2 name3 name4
             INTO (l_name1, l_name2, l_name3, l_name4)
             FROM lfa1
            WHERE lifnr EQ im_vendor .

    CONCATENATE l_name1 l_name2 l_name3 l_name4
           INTO re_name SEPARATED BY space .
    CONDENSE re_name .
  ENDMETHOD.


  METHOD get_vincles.
    FIELD-SYMBOLS: <ls_oferta> TYPE ty_s_oferta .
    DATA: l_konzs    TYPE konzs,
          l_tabix    TYPE sy-tabix,
          lt_ofertes TYPE ty_t_oferta.

    lt_ofertes = im_ofertes .
    DELETE lt_ofertes WHERE z_tipus_oferta NE gc_oferta_base .
    LOOP AT lt_ofertes ASSIGNING <ls_oferta> .
      IF <ls_oferta>-z_import_homog IS INITIAL .
        <ls_oferta>-z_import_homog = <ls_oferta>-z_import_oferta .
      ENDIF .
    ENDLOOP .

    LOOP AT im_group INTO l_konzs .
      l_tabix = sy-tabix .
      DELETE lt_ofertes WHERE all_konzs IS INITIAL .
      IF lt_ofertes IS INITIAL .
        EXIT .
      ENDIF .

      LOOP AT lt_ofertes ASSIGNING <ls_oferta> .
        CLEAR <ls_oferta>-real_konzs .
        DELETE <ls_oferta>-all_konzs WHERE table_line EQ l_konzs .
        IF sy-subrc EQ 0 .
          <ls_oferta>-real_konzs = l_konzs .
        ENDIF .
      ENDLOOP .

      CALL METHOD get_vincles_loop
        EXPORTING
          im_ofertes   = lt_ofertes
          im_konzs     = l_konzs
          im_req_homog = im_req_homog
          im_number    = l_tabix
        CHANGING
          ch_vincles   = ch_vincles.

    ENDLOOP.
    SORT ch_vincles .
    DELETE ADJACENT DUPLICATES FROM ch_vincles .
  ENDMETHOD.


  METHOD get_vincles_loop.
    DATA: lt_ofertes TYPE ty_t_oferta,
          ls_vincle  TYPE ty_s_vincle,
          l_num_grup TYPE string.
    FIELD-SYMBOLS: <ls_oferta> TYPE ty_s_oferta .

    lt_ofertes = im_ofertes .
    DELETE lt_ofertes WHERE NOT real_konzs EQ im_konzs .

    IF im_req_homog EQ 'X' .
      SORT lt_ofertes BY real_konzs ASCENDING z_import_homog ASCENDING .
    ELSE .
      SORT lt_ofertes BY real_konzs ASCENDING z_import_oferta ASCENDING .
    ENDIF .

* Ignorem l'oferta d'import més baix de cadascun dels grups d'empreses. Si hi més d'una oferta
* amb l'import més baix no sabem quina es descartarà... aleatori total
    DELETE lt_ofertes INDEX 1 .
    CHECK NOT lt_ofertes IS INITIAL .

    LOOP AT lt_ofertes ASSIGNING <ls_oferta> .
      l_num_grup = im_number.
      CONDENSE l_num_grup .
      CONCATENATE `(` l_num_grup
      ') Per al càlcul de les ofertes desproporcionades o anormals no s''ha tingut en compte l''oferta de"'(02a)
             <ls_oferta>-nom_proveidor '", a l''estar vinculada amb un altre licitador'(02b)
             INTO ls_vincle-text .
      APPEND ls_vincle TO ch_vincles .
    ENDLOOP .
  ENDMETHOD.


  METHOD get_zerm_quadre_lots.
    DEFINE _format_number .
      write &1 to lv_char80 decimals 2 left-justified . "#EC UOM_IN_MES
      &2 = lv_char80 .
    END-OF-DEFINITION .
    DATA: lt_quadre_lots        TYPE ty_t_quadre_lots,
          ls_quadre_lots        TYPE zerm_quadre_lots,
          lt_ofertes            TYPE TABLE OF zrm_dt_ofertes,
          lv_cost_part_variable TYPE zrm_dt_ofer_tip-import,
          lv_cost_part_fixa     TYPE zrm_dt_ofer_tip-import,
          lv_char80             TYPE char80,
          ls_vendor             TYPE ty_s_proveidor.

    FIELD-SYMBOLS: <fs_quadre_lots> TYPE ty_t_quadre_lots,
                   <my_cached>      TYPE REF TO data.

    ASSIGN my_quadre_lots TO <my_cached>.
    CREATE DATA <my_cached> TYPE ty_t_quadre_lots.
    ASSIGN <my_cached>->* TO <fs_quadre_lots>.

    <fs_quadre_lots> = lt_quadre_lots.

    ro_data = <my_cached>.

    "Verifiquem que sigui un expedient AMB LOTS
    SELECT COUNT(*)
      FROM zrm_dt_exp_cont
      WHERE objectid  = @iv_objectid
        AND z_exp_hdr = @abap_true.
    CHECK sy-subrc = 0.
*    IF sy-subrc = 0.

    SELECT a~objectid, b~z_codi_exp, a~zz_num_lot, a~z_descrip_lot, b~z_valor_est_cont, b~z_val_est_cont_b
      FROM zvrm_qdc_clo_lic AS a
      INNER JOIN zrm_dt_exp_cont AS b
      ON a~objectid = b~objectid
      INTO TABLE @DATA(lt_qdc_lot)
      WHERE a~objectid   = @iv_objectid
        AND b~z_estat     <> 'ZCA'.
    IF sy-subrc = 0.

      SELECT z_codi_exp, z_exp_hdr_code, z_exp_lot_num, z_valor_est_cont, z_val_est_cont_b, z_imin
        FROM zrm_dt_exp_cont
        INTO TABLE @DATA(lt_exp_cont)
        FOR ALL ENTRIES IN @lt_qdc_lot
        WHERE z_exp_hdr_code = @lt_qdc_lot-z_codi_exp
          AND z_estat       <> 'ZCA'.
      IF sy-subrc = 0.

        SELECT z_licitacio, z_codi_qdc
          FROM zrm_dt_qdc_cap
          INTO TABLE @DATA(lt_qdc_cap)
          FOR ALL ENTRIES IN @lt_exp_cont
          WHERE z_licitacio = @lt_exp_cont-z_exp_hdr_code.
        IF sy-subrc = 0.
          SELECT z_codi_qdc, zz_num_lot, z_obres_sim
            FROM zrm_dt_qdc_clot
            INTO TABLE @DATA(lt_qdc_clot)
            FOR ALL ENTRIES IN @lt_qdc_cap
            WHERE z_codi_qdc = @lt_qdc_cap-z_codi_qdc.
        ENDIF.

        LOOP AT lt_qdc_lot ASSIGNING FIELD-SYMBOL(<fs_qdc_lot_aux>).
          CLEAR: ls_quadre_lots.
          READ TABLE lt_exp_cont ASSIGNING FIELD-SYMBOL(<fs_exp_cont>) WITH KEY z_exp_hdr_code = <fs_qdc_lot_aux>-z_codi_exp
                                                                                z_exp_lot_num  = <fs_qdc_lot_aux>-zz_num_lot.
          CHECK sy-subrc = 0.

          ls_quadre_lots-zz_num_lot         = <fs_qdc_lot_aux>-zz_num_lot.
          SHIFT ls_quadre_lots-zz_num_lot LEFT DELETING LEADING '0'.
          <fs_qdc_lot_aux>-z_valor_est_cont = <fs_exp_cont>-z_valor_est_cont.
          <fs_qdc_lot_aux>-z_val_est_cont_b = <fs_exp_cont>-z_val_est_cont_b.
          ls_quadre_lots-z_descrip_lot      = <fs_qdc_lot_aux>-z_descrip_lot.
          _format_number: <fs_qdc_lot_aux>-z_valor_est_cont ls_quadre_lots-z_valor_est_cont,
                          <fs_qdc_lot_aux>-z_val_est_cont_b ls_quadre_lots-z_val_est_cont_b,
                          <fs_exp_cont>-z_imin              ls_quadre_lots-z_imin.
          READ TABLE lt_qdc_cap ASSIGNING FIELD-SYMBOL(<fs_qdc_cap>) WITH KEY z_licitacio = <fs_exp_cont>-z_exp_hdr_code.
          CHECK sy-subrc = 0.
          ls_quadre_lots-z_codi_qdc = <fs_qdc_cap>-z_codi_qdc.
          READ TABLE lt_qdc_clot ASSIGNING FIELD-SYMBOL(<fs_qdc_clot>) WITH KEY z_codi_qdc = <fs_qdc_cap>-z_codi_qdc.
          IF sy-subrc = 0.
            ls_quadre_lots-z_obres_sim = <fs_qdc_clot>-z_obres_sim.
            ls_quadre_lots-z_tipologia = ls_quadre_lots-z_obres_sim.
          ENDIF.
          APPEND ls_quadre_lots TO lt_quadre_lots.
        ENDLOOP.
      ENDIF.
    ENDIF.
*    ENDIF.
    <fs_quadre_lots> = lt_quadre_lots.

    ro_data = <my_cached>.

  ENDMETHOD.


  METHOD get_z_certificat_ok.
*  DATA: ls_exp_cont TYPE zrm_dt_exp_cont.
*
*  SELECT SINGLE * FROM zrm_dt_exp_cont INTO ls_exp_cont
*    WHERE docclass = im_docclass AND
*          objectid = im_objectid .
*
*  IF sy-subrc <> 0.
*    RAISE not_found.
*  ENDIF.
*
*  CASE im_tipus_doc.
*    WHEN '01'.
*      ex_return = ls_exp_cont-z_admet_ofer_var.
*    WHEN '04'.
*      ex_return = ls_exp_cont-z_admet_ofer_cor.
*    WHEN '03'.
*      ex_return = ls_exp_cont-z_rma.
*    WHEN OTHERS.
*      RAISE not_found.
*  ENDCASE.

    ex_return = 'X'.

  ENDMETHOD.


  METHOD get_z_dades_recurrent.
    FIELD-SYMBOLS: <l_data> TYPE zrm_dt_ofertes.

    IF my_dades_recurrent IS BOUND.
      ex_data = my_dades_recurrent.
      RETURN.
    ENDIF.

    CREATE DATA my_dades_recurrent TYPE zrm_dt_ofertes .
    ex_data = my_dades_recurrent .
    ASSIGN ex_data->* TO <l_data> .

    SELECT SINGLE * FROM zrm_dt_ofertes INTO <l_data>
      WHERE docclass = im_docclass AND
            objectid = im_objectid AND
            z_doc_recurs = 'X'.

  ENDMETHOD.


  METHOD get_z_import_fix_adj.
    TYPES: BEGIN OF ty_s_data,
             import_fix TYPE char20,
           END   OF ty_s_data.
    FIELD-SYMBOLS: <ls_data> TYPE ty_s_data .

    DATA: lt_tip_ofer   TYPE TABLE OF zrm_dt_ofer_tip,
          lt_oferta_adj TYPE TABLE OF zrm_dt_ofertes,
          lv_import_fix TYPE zrm_dt_ofer_tip-import.

    CREATE DATA ex_data TYPE ty_s_data .
    ASSIGN ex_data->* TO <ls_data> .

    SELECT *
      FROM zrm_dt_ofertes
      INTO TABLE lt_oferta_adj
      WHERE docclass  = im_docclass
       AND  objectid  = im_objectid
       AND z_adj_prov = abap_on.

    CHECK lt_oferta_adj IS NOT INITIAL.

    SELECT *
      INTO TABLE lt_tip_ofer
      FROM zrm_dt_ofer_tip
      FOR ALL ENTRIES IN lt_oferta_adj
      WHERE docclass  = im_docclass
       AND  objectid  = im_objectid
       AND ( tipus_ofer = 3 OR tipus_ofer = 4 )
       AND num_ofer = lt_oferta_adj-z_num_ofer.


    CHECK lt_tip_ofer IS NOT INITIAL.
    CLEAR: lv_import_fix.

    LOOP AT lt_tip_ofer ASSIGNING FIELD-SYMBOL(<fs_tipologia_econ_ofer>).
      ADD <fs_tipologia_econ_ofer>-import TO lv_import_fix.
    ENDLOOP.

    <ls_data>-import_fix = lv_import_fix.
    SHIFT <ls_data>-import_fix LEFT DELETING LEADING space.
  ENDMETHOD.


  METHOD get_z_import_var_adj.
    TYPES: BEGIN OF ty_s_data,
             import_variable TYPE char20,
           END   OF ty_s_data.
    FIELD-SYMBOLS: <ls_data> TYPE ty_s_data .

    DATA: lt_tip_ofer        TYPE TABLE OF zrm_dt_ofer_tip,
          lt_oferta_adj      TYPE TABLE OF zrm_dt_ofertes,
          lv_import_variable TYPE zrm_dt_ofer_tip-import.

    CREATE DATA ex_data TYPE ty_s_data .
    ASSIGN ex_data->* TO <ls_data> .

    SELECT *
      FROM zrm_dt_ofertes
      INTO TABLE lt_oferta_adj
      WHERE docclass  = im_docclass
       AND  objectid  = im_objectid
       AND z_adj_prov = abap_on.

    CHECK lt_oferta_adj IS NOT INITIAL.

    SELECT *
      INTO TABLE lt_tip_ofer
      FROM zrm_dt_ofer_tip
      FOR ALL ENTRIES IN lt_oferta_adj
      WHERE docclass  = im_docclass
       AND  objectid  = im_objectid
       AND ( tipus_ofer <> 3 AND tipus_ofer <> 4 )
       AND num_ofer = lt_oferta_adj-z_num_ofer.

    CHECK lt_tip_ofer IS NOT INITIAL.
    CLEAR: lv_import_variable.

    LOOP AT lt_tip_ofer ASSIGNING FIELD-SYMBOL(<fs_tipologia_econ_ofer>).
      ADD <fs_tipologia_econ_ofer>-import TO lv_import_variable.
    ENDLOOP.

    <ls_data>-import_variable = lv_import_variable.
    SHIFT <ls_data>-import_variable LEFT DELETING LEADING space.
  ENDMETHOD.


  METHOD recalculate_group.
    DATA: l_lifnr    TYPE lifnr,
          lt_konzs   TYPE ty_t_group_key,
          ls_konzs   TYPE ty_s_group_key,
          lt_compute TYPE ty_t_compute.
    FIELD-SYMBOLS: <ls_oferta>  TYPE ty_s_oferta,
                   <ls_compute> TYPE ty_s_compute.

    DEFINE __add_vendor_to_group_key .
      call method add_vendor_to_group_key
        exporting
          im_lifnr     = &1
          im_konzs     = &2
        changing
          ch_group_key = lt_konzs.
    END-OF-DEFINITION .

* Mirem a quins grups pertany el proveïdor de cada oferta (ja sigui de forma directa, o
* indirecta degut als components de la UTE). Si per a cap d'aquests grups trobem un altre
* proveïdor que hagi presentat una oferta llavors ens ho guardem
    LOOP AT ch_ofertes ASSIGNING <ls_oferta> .
      REFRESH: <ls_oferta>-all_konzs,
               <ls_oferta>-related_offers.
      IF NOT <ls_oferta>-real_konzs IS INITIAL .
        __add_vendor_to_group_key: <ls_oferta>-proveidor <ls_oferta>-real_konzs.
        INSERT <ls_oferta>-real_konzs INTO TABLE <ls_oferta>-all_konzs .
      ENDIF .

*-- Si és una UTE n'obtenim els components ----------------------
      IF <ls_oferta>-zute IS NOT INITIAL .
        lt_compute = get_ute_data( <ls_oferta>-proveidor ) .
        LOOP AT lt_compute ASSIGNING <ls_compute> WHERE NOT real_konzs IS INITIAL .
*-- Una U.T.E pertany indirectaments al(s) grup(s) de empreses del seus components
          __add_vendor_to_group_key: <ls_oferta>-proveidor     <ls_compute>-real_konzs .
          INSERT <ls_compute>-real_konzs INTO TABLE <ls_oferta>-all_konzs .
        ENDLOOP .
      ENDIF .
    ENDLOOP .


    LOOP AT ch_ofertes ASSIGNING <ls_oferta> WHERE NOT all_konzs IS INITIAL .
      LOOP AT <ls_oferta>-all_konzs INTO ls_konzs-konzs.
        READ TABLE lt_konzs INTO ls_konzs WITH TABLE KEY konzs = ls_konzs-konzs .
        DESCRIBE TABLE ls_konzs-t_lifnr .
* Si només trobem un proveïdor per a aquest grup hem d'ignorar-lo
        IF sy-tfill EQ 1 .
          REFRESH ls_konzs-t_lifnr .
          DELETE <ls_oferta>-all_konzs WHERE table_line EQ ls_konzs-konzs.
        ENDIF .
        LOOP AT ls_konzs-t_lifnr INTO l_lifnr .
          INSERT l_lifnr INTO TABLE <ls_oferta>-related_offers .
        ENDLOOP .
      ENDLOOP .
      DELETE <ls_oferta>-related_offers WHERE table_line EQ <ls_oferta>-proveidor .
      IF <ls_oferta>-related_offers IS INITIAL .
        CLEAR: <ls_oferta>-real_konzs,
               <ls_oferta>-all_konzs.
      ENDIF .
    ENDLOOP .

  ENDMETHOD.


  METHOD replace_amount.
    DATA: l_char80(80) TYPE c,
          l_string     TYPE string.

    WRITE im_amount  TO l_char80 LEFT-JUSTIFIED DECIMALS 2 . "#EC UOM_IN_MES

    l_string = l_char80 .
    REPLACE im_amount_holder WITH l_string INTO c_string .
    TRY .
        l_string = zrm_cl_documents=>operator_spell_int( im_number = im_amount
                                                         im_currency = 'EUR' ) .
      CATCH zcx_rm_documents .
        l_string = space .
    ENDTRY .
    REPLACE im_spell_holder WITH l_string INTO c_string  .
  ENDMETHOD.


  METHOD zrm_if_badi_dades_expedient~get.
    DATA: l_sort_field     TYPE fieldname,
          l_tipus_oferta   TYPE zrm_dt_ofertes-z_tipus_oferta,
          l_tipus_document TYPE z_tip_doc,
          lv_obertura      TYPE xfeld.

* >> Inici Modif. SPEC-38097
** INI ETOVB RMS SPEC-48224
*  DATA: l_proj TYPE z_per_proj,
*        l_dir  TYPE z_per_dir.
    DATA: l_proj     TYPE decfloat34,
          l_dir      TYPE decfloat34,
          l_proj_aux TYPE z_per_proj,
          l_dir_aux  TYPE z_per_dir.
** FIN ETOVB RMS SPEC-48224
* << Fi Modif. SPEC-38097

    FIELD-SYMBOLS: <fs> TYPE any.

* La manera que té el motor de plantilles de cridar les badis garanteix que és generapr
* una instància nova per a cada expedient
    IF my_exp_cont IS INITIAL .
      SELECT SINGLE * INTO my_exp_cont
               FROM zrm_dt_exp_cont
              WHERE     docclass EQ im_docid-class
                    AND objectid EQ im_docid-objid .
      IF sy-subrc NE 0 .
        RAISE not_found .
      ENDIF .
    ENDIF .
**>> INI MODIF ETODR 22.03.2016 SPEC-38725
    IF my_exp_cont IS NOT INITIAL AND my_imp_cap IS INITIAL.
      SELECT SINGLE *
        FROM zmm_dt_imp_cap
        INTO my_imp_cap
        WHERE z_doc_impuls  = my_exp_cont-z_doc_impuls
          AND z_obj_impuls  = my_exp_cont-z_obj_impuls.
    ENDIF.
**<< FI MODIF ETODR 22.03.2016 SPEC-38725
*******************************************
* >> Inici Modif. SPEC-38097
    CLEAR: l_proj, l_dir, l_proj_aux, l_dir_aux.
    SELECT z_pcost_projecte z_pcost_direccio INTO (l_proj_aux, l_dir_aux)
                                             FROM zrm_dt_lic_per
                                            WHERE z_codi_exp = my_exp_cont-z_codi_exp.
    ENDSELECT.
    IF sy-subrc = 0.
      l_proj = l_proj_aux.
      l_dir = l_dir_aux.
      l_proj = l_proj / 100.
      l_dir  = l_dir  / 100.
    ENDIF.
* << Fi Modif. SPEC-38097
*******************************************

    CASE im_element .

      WHEN 'ZDATA_TERMINI_48H' .
        CREATE DATA ex_data TYPE ('DATUM').
        ASSIGN ex_data->* TO <fs>.
        CALL METHOD get_data_term48h
          EXPORTING
            im_docclass = im_docid-class
            im_objectid = im_docid-objid
          RECEIVING
            ex_data     = <fs>
          EXCEPTIONS
            OTHERS      = 1.

      WHEN 'AREA_COL' .
        CALL METHOD get_areal_col
          EXPORTING
            im_docclass = im_docid-class
            im_objectid = im_docid-objid
          RECEIVING
            re_data     = ex_data
          EXCEPTIONS
            OTHERS      = 1.

      WHEN 'ZERM_DADES_DIREC_DIV' .
        CALL METHOD get_dades_director_divisio
          EXPORTING
            im_docclass = im_docid-class
            im_objectid = im_docid-objid
          RECEIVING
            re_data     = ex_data
          EXCEPTIONS
            OTHERS      = 1.

      WHEN 'ZERM_DADES_DIREC_GENERAL' .
        CALL METHOD get_dades_director_general
          EXPORTING
            im_docclass = im_docid-class
            im_objectid = im_docid-objid
          RECEIVING
            re_data     = ex_data
          EXCEPTIONS
            OTHERS      = 1.

      WHEN 'ZERM_DADES_GERENT' .
        CALL METHOD get_dades_gerent
          EXPORTING
            im_docclass = im_docid-class
            im_objectid = im_docid-objid
          RECEIVING
            re_data     = ex_data
          EXCEPTIONS
            OTHERS      = 1.

      WHEN 'IMPORT_ADJ_30_B' .
* >> Inici Modif. SPEC-38097
        IF l_proj IS NOT INITIAL OR l_dir IS NOT INITIAL.
          my_extra-import_adj_30_b = my_exp_cont-z_import_adj_b * l_dir.
          GET REFERENCE OF my_extra-import_adj_30_b INTO ex_data .
        ELSE.
* << Fi Modif. SPEC-38097
***>> INI OVB SPEC-36818 Modificar els tant per cents PE/DO
          IF my_exp_cont-z_subtipus_cont EQ 'PI'
            AND my_imp_cap-z_import_pec_b <  1000000 "INI MODIF ETODR 22.03.2016 SPEC-38725 "AND my_exp_cont-z_pres_licit_b < 1000000
            AND my_exp_cont-z_data_creacio > '20150923'.
            my_extra-import_adj_30_b = my_exp_cont-z_import_adj_b * 20 / 100 .
            GET REFERENCE OF my_extra-import_adj_30_b INTO ex_data .
          ELSE.
***>> FIN OVB
            my_extra-import_adj_30_b = my_exp_cont-z_import_adj_b * 30 / 100 .
            GET REFERENCE OF my_extra-import_adj_30_b INTO ex_data .
***>> INI OVB SPEC-36818 Modificar els tant per cents PE/DO
          ENDIF.
***>> FIN OVB
        ENDIF.           "SPEC-38097

      WHEN 'IMPORT_ADJ_70_B' .
* >> Inici Modif. SPEC-38097
        IF l_proj IS NOT INITIAL OR l_dir IS NOT INITIAL.
          IF my_exp_cont-z_subtipus_cont EQ 'PI'
            AND my_imp_cap-z_import_pec_b <  1000000 "INI MODIF ETODR 22.03.2016 SPEC-38725 "AND my_exp_cont-z_pres_licit_b < 1000000
            AND my_exp_cont-z_data_creacio > '20150923'.
            my_extra-import_adj_30_b = my_exp_cont-z_import_adj_b * l_proj.
            GET REFERENCE OF my_extra-import_adj_30_b INTO ex_data .
          ELSE.
            my_extra-import_adj_70_b = my_exp_cont-z_import_adj_b * l_proj.
            GET REFERENCE OF my_extra-import_adj_70_b INTO ex_data .
          ENDIF.
        ELSE.
* << Fi Modif. SPEC-38097
***>> INI OVB SPEC-36818 Modificar els tant per cents PE/DO
          IF my_exp_cont-z_subtipus_cont EQ 'PI'
            AND my_imp_cap-z_import_pec_b <  1000000 "INI MODIF ETODR 22.03.2016 SPEC-38725 "AND my_exp_cont-z_pres_licit_b < 1000000
            AND my_exp_cont-z_data_creacio > '20150923'.
            my_extra-import_adj_30_b = my_exp_cont-z_import_adj_b * 80 / 100 .
            GET REFERENCE OF my_extra-import_adj_30_b INTO ex_data .
          ELSE.
***>> FIN OVB
            my_extra-import_adj_70_b = my_exp_cont-z_import_adj_b * 70 / 100 .
            GET REFERENCE OF my_extra-import_adj_70_b INTO ex_data .
***>> INI OVB SPEC-36818 Modificar els tant per cents PE/DO
          ENDIF.
***>> FIN OVB
        ENDIF.   "SPEC-38097
        "" { Inici SPEC31754 (ECJAP) - Plantilles NH+NSP
      WHEN 'IMPORT_ADJ_34_B'.
* >> Inici Modif. SPEC-38097
        IF l_proj IS NOT INITIAL OR l_dir IS NOT INITIAL.
          my_extra-import_adj_30_b = my_exp_cont-z_import_adj_b * l_dir.
          GET REFERENCE OF my_extra-import_adj_30_b INTO ex_data .
        ELSE.
* << Fi Modif. SPEC-38097
***>> INI OVB SPEC-36818 Modificar els tant per cents PE/DO
          IF my_exp_cont-z_subtipus_cont EQ 'PI'
            AND my_imp_cap-z_import_pec_b <  1000000 "INI MODIF ETODR 22.03.2016 SPEC-38725 "AND my_exp_cont-z_pres_licit_b < 1000000
            AND my_exp_cont-z_data_creacio > '20150923'.
            my_extra-import_adj_30_b = my_exp_cont-z_import_adj_b * 20 / 100 .
            GET REFERENCE OF my_extra-import_adj_30_b INTO ex_data .
          ELSE.
***>> FIN OVB
            my_extra-import_adj_30_b = my_exp_cont-z_import_adj_b * 34 / 100 .
            GET REFERENCE OF my_extra-import_adj_30_b INTO ex_data .
            "" } Final SPEC31754
***>> INI OVB SPEC-36818 Modificar els tant per cents PE/DO
          ENDIF.
***>> FIN OVB
        ENDIF.     "SPEC-38097
        "" { Inici SPEC31754 (ECJAP) - Plantilles NH+NSP
      WHEN 'IMPORT_ADJ_66_B'.
* >> Inici Modif. SPEC-38097
        IF l_proj IS NOT INITIAL OR l_dir IS NOT INITIAL.
          my_extra-import_adj_30_b = my_exp_cont-z_import_adj_b * l_proj.
          GET REFERENCE OF my_extra-import_adj_30_b INTO ex_data .
        ELSE.
* << Fi Modif. SPEC-38097
***>> INI OVB SPEC-36818 Modificar els tant per cents PE/DO
          IF my_exp_cont-z_subtipus_cont EQ 'PI'
            AND my_imp_cap-z_import_pec_b <  1000000 "INI MODIF ETODR 22.03.2016 SPEC-38725 "AND my_exp_cont-z_pres_licit_b < 1000000
            AND my_exp_cont-z_data_creacio > '20150923'.
            my_extra-import_adj_30_b = my_exp_cont-z_import_adj_b * 80 / 100 .
            GET REFERENCE OF my_extra-import_adj_30_b INTO ex_data .
          ELSE.
***>> FIN OVB
            my_extra-import_adj_70_b = my_exp_cont-z_import_adj_b * 66 / 100 .
            GET REFERENCE OF my_extra-import_adj_70_b INTO ex_data .
            "" } Final SPEC31754
          ENDIF.
***>> INI OVB SPEC-36818 Modificar els tant per cents PE/DO
        ENDIF.
***>> FIN OVB
      WHEN 'Z_PRES_LIC_AMB_COMP_FINAN' .
        my_extra-z_pres_lic_amb_comp_finan =  my_exp_cont-z_pres_licit_b
                                            + my_exp_cont-z_imp_comp_fi_b .
        GET REFERENCE OF my_extra-z_pres_lic_amb_comp_finan INTO ex_data .

      WHEN 'Z_PRES_LIC_AMB_COMP_FINAN_IVA' .
        my_extra-z_pres_lic_amb_comp_finan_iva =  my_exp_cont-z_pressup_licit
                                                + my_exp_cont-z_import_comp_fi .
        GET REFERENCE OF my_extra-z_pres_lic_amb_comp_finan_iva INTO ex_data .

      WHEN 'Z_LIM_SUP' .
        my_extra-z_lim_sup = my_exp_cont-z_bm + my_exp_cont-z_desviacio .
        GET REFERENCE OF my_extra-z_lim_sup INTO ex_data .

      WHEN 'Z_LIM_INF' .
        my_extra-z_lim_inf = my_exp_cont-z_bm - my_exp_cont-z_desviacio .
        GET REFERENCE OF my_extra-z_lim_inf INTO ex_data .

      WHEN 'Z_LIM_SUP_HOMOG' .
        my_extra-z_lim_sup_homog = my_exp_cont-z_bm_homog + my_exp_cont-z_desv_homog .
        GET REFERENCE OF my_extra-z_lim_sup_homog INTO ex_data .

      WHEN 'Z_LIM_INF_HOMOG' .
        my_extra-z_lim_inf_homog = my_exp_cont-z_bm_homog - my_exp_cont-z_desv_homog .
        GET REFERENCE OF my_extra-z_lim_inf_homog INTO ex_data .

      WHEN 'Z_ES_QUADRE_3_ESBORRANY' .
        IF     my_exp_cont-z_estat EQ 'ZF1'
            OR my_exp_cont-z_estat EQ 'ZF2'
            OR my_exp_cont-z_estat EQ 'ZLI'
            OR my_exp_cont-z_estat EQ 'ZV1'
            OR my_exp_cont-z_estat EQ 'ZV2' .
          my_extra-z_es_quadre_3_esborrany = 'X' .
        ELSE .
          my_extra-z_es_quadre_3_esborrany = space .
        ENDIF .
        GET REFERENCE OF my_extra-z_es_quadre_3_esborrany INTO ex_data .

      WHEN 'ZERM_QUADRE_ESMENA_S1' .
        CALL METHOD get_esmena_sx
          EXPORTING
            im_docclass = im_docid-class
            im_objectid = im_docid-objid
            im_num_sob  = '1'
          RECEIVING
            ex_data     = ex_data
          EXCEPTIONS
            not_found   = 1.

      WHEN 'ZERM_QUADRE_ESMEX_S1' .
        CALL METHOD get_esmex_sx
          EXPORTING
            im_docclass = im_docid-class
            im_objectid = im_docid-objid
            im_num_sob  = '1'
          RECEIVING
            ex_data     = ex_data
          EXCEPTIONS
            not_found   = 1.

      WHEN 'ZERM_QUADRE_SEL2V' .
        CALL METHOD get_sel2v
          EXPORTING
            im_docclass = im_docid-class
            im_objectid = im_docid-objid
          RECEIVING
            ex_data     = ex_data
          EXCEPTIONS
            not_found   = 1.
      WHEN 'ZERM_QUADRE_PROV_ALTERN' .
        CALL METHOD get_prov_altern
          EXPORTING
            im_docclass = im_docid-class
            im_objectid = im_docid-objid
          RECEIVING
            ex_data     = ex_data
          EXCEPTIONS
            not_found   = 1.
**  >> INI MODIF ETODR SPEC-48090
      WHEN 'ZERM_MOTIU_ESMENA_S2'.
        CALL METHOD get_motiu_s2
          EXPORTING
            im_docclass = my_exp_cont-docclass
            im_objectid = my_exp_cont-objectid
          RECEIVING
            ex_data     = ex_data
          EXCEPTIONS
            not_found   = 1.
**  << FI MODIF ETODR SPEC-48090
      WHEN 'ZERM_QUADRE_ESMENA_S2' .
        CALL METHOD get_esmena_sx
          EXPORTING
            im_docclass = im_docid-class
            im_objectid = im_docid-objid
            im_num_sob  = '2'
          RECEIVING
            ex_data     = ex_data
          EXCEPTIONS
            not_found   = 1.

**  >> INI MODIF ETODR SPEC-49881
      WHEN 'Z_IMPORT_TIPOL_FIX'.
        CALL METHOD me->get_import_tipol_fix
          EXPORTING
            im_docclass = im_docid-class
            im_objectid = im_docid-objid
          RECEIVING
            ex_data     = ex_data.

      WHEN 'ZERM_QUADRE_NO_EXCLOS_NO_ESMENAT_S1' .
        CALL METHOD get_noesm_no_excl_sx
          EXPORTING
            im_docclass = im_docid-class
            im_objectid = im_docid-objid
            im_num_sob  = '1'
          RECEIVING
            ex_data     = ex_data
          EXCEPTIONS
            not_found   = 1.

      WHEN 'ZERM_QUADRE_NO_EXCLOS_SI_ESMENAT_S1' .
        CALL METHOD get_siesm_no_excl_sx
          EXPORTING
            im_docclass = im_docid-class
            im_objectid = im_docid-objid
            im_num_sob  = '1'
          RECEIVING
            ex_data     = ex_data
          EXCEPTIONS
            not_found   = 1.
**  << FI MODIF ETODR SPEC-49881

*>> Inici Modificació ECJMS SPEC-64927 30/11/2021

      WHEN 'ZERM_DADES_SDE'.
        CALL METHOD get_dades_sistema_dinamic
          EXPORTING
            im_docclass = im_docid-class
            im_objectid = im_docid-objid
          RECEIVING
            re_data     = ex_data.

      WHEN 'ZERM_QUADRE_NO_EXCLOS_SI_ESMENAT_SDE'.
*    WHEN 'Z_Q_NO_EXCLOS_SI_ESMENAT_SDE'.
        CALL METHOD get_esmenat_s3_sde
          EXPORTING
            im_docclass = im_docid-class
            im_objectid = im_docid-objid
          RECEIVING
            ex_data     = ex_data
          EXCEPTIONS
            not_found   = 1.

      WHEN 'ZERM_SI_EXCLOS_NO_ESMENAT_SDE'.
        CALL METHOD get_si_exclos_no_esmenat_sde
          EXPORTING
            im_docclass = im_docid-class
            im_objectid = im_docid-objid
          RECEIVING
            ex_data     = ex_data
          EXCEPTIONS
            not_found   = 1.

      WHEN 'ZERM_QUADRE_NO_EXCLOS_NO_ESMENAT_SDE'.
        CALL METHOD get_no_exclos_no_esmena_s3_sde
          EXPORTING
            im_docclass = im_docid-class
            im_objectid = im_docid-objid
          RECEIVING
            ex_data     = ex_data
          EXCEPTIONS
            not_found   = 1.

*>> Fi Modificació ECJMS SPEC-64927 30/11/2021

**  >> INI MODIF ETODR SPEC-52625
      WHEN 'ZERM_QUADRE_EXCLUSIO_POSTOB_S2'.
        CALL METHOD get_excl_post_ob_s2
          EXPORTING
            im_docclass = im_docid-class
            im_objectid = im_docid-objid
          RECEIVING
            ex_data     = ex_data
          EXCEPTIONS
            not_found   = 1.
      WHEN 'NUM_LICIT_ADM_S2'.
        CALL METHOD get_admesos_final_s2
          EXPORTING
            im_docclass = im_docid-class
            im_objectid = im_docid-objid
          RECEIVING
            ex_data     = ex_data
          EXCEPTIONS
            not_found   = 1.

      WHEN 'ZERM_QUADRE_NO_EXCLOS_SI_ESMENAT_S3' .
        CALL METHOD get_siesm_no_excl_sx
          EXPORTING
            im_docclass = im_docid-class
            im_objectid = im_docid-objid
            im_num_sob  = '3'
          RECEIVING
            ex_data     = ex_data
          EXCEPTIONS
            not_found   = 1.
**  << FI MODIF ETODR SPEC-52625

      WHEN 'ZERM_QUADRE_EXCLUSIO_S10'.

      WHEN 'ZERM_QUADRE_EXCLUSIO_S1' .
        CALL METHOD get_exclusio_sx
          EXPORTING
            im_docclass = im_docid-class
            im_objectid = im_docid-objid
            im_num_sob  = '1'
            im_carta    = space
          RECEIVING
            ex_data     = ex_data
          EXCEPTIONS
            not_found   = 1.

      WHEN 'ZERM_QUADRE_EXCLUSIO_S2'.
        CALL METHOD get_exclusio_sx
          EXPORTING
            im_docclass = im_docid-class
            im_objectid = im_docid-objid
            im_num_sob  = '2'
            im_carta    = space
          RECEIVING
            ex_data     = ex_data
          EXCEPTIONS
            not_found   = 1.

        ">>>  SPEC-57810 Inici Modificació ETXGL
      WHEN 'ZERM_QUADRE_EXCLUSIO_S3'.
        CALL METHOD get_exclusio_sx
          EXPORTING
            im_docclass = im_docid-class
            im_objectid = im_docid-objid
            im_num_sob  = '3'
            im_carta    = space
          RECEIVING
            ex_data     = ex_data
          EXCEPTIONS
            not_found   = 1.
        "<<<  SPEC-57810 Final Modificació ETXGL

*   <== EDLSM 15/01/10
      WHEN 'ZERM_QUADRE_CARTA_EXCLUSIO_S2'.
        CALL METHOD get_exclusio_sx
          EXPORTING
            im_docclass = im_docid-class
            im_objectid = im_docid-objid
            im_num_sob  = '2'
            im_carta    = 'X'
          RECEIVING
            ex_data     = ex_data
          EXCEPTIONS
            not_found   = 1.
*   ==> EDLSM

      WHEN 'ZERM_QUADRE_EXCLUSIOPOSTES_S1' .
        CALL METHOD get_exclusiopostes_sx
          EXPORTING
            im_docclass = im_docid-class
            im_objectid = im_docid-objid
            im_num_sob  = '1'
          RECEIVING
            ex_data     = ex_data
          EXCEPTIONS
            not_found   = 1.

      WHEN 'ZERM_QUADRE_EXCLUSIOPOSTES_S2' .
        CALL METHOD get_exclusiopostes_sx
          EXPORTING
            im_docclass = im_docid-class
            im_objectid = im_docid-objid
            im_num_sob  = '2'
          RECEIVING
            ex_data     = ex_data
          EXCEPTIONS
            not_found   = 1.

*>> Ini  SPEC-SPEC-58412  - ETMAE

*   Exclusió de Sobre 3
      WHEN 'ZERM_QUADRE_EXCLUSIOPOSTES_S3' .
        CALL METHOD get_exclusiopostes_sx
          EXPORTING
            im_docclass = im_docid-class
            im_objectid = im_docid-objid
            im_num_sob  = '3'
          RECEIVING
            ex_data     = ex_data
          EXCEPTIONS
            not_found   = 1.

*<< Fi  SPEC-SPEC-58412  - ETMAE

      WHEN 'ZERM_QUADRE_ENT_EX_SOBRE1' .
        CALL METHOD get_ent_ex_sobrex
          EXPORTING
            im_docclass = im_docid-class
            im_objectid = im_docid-objid
            im_num_sob  = '1'
          RECEIVING
            ex_data     = ex_data
          EXCEPTIONS
            not_found   = 1.


***>>> INICI Insert SPEC-46538 ETXGL
      WHEN 'ZERM_ADMES_SOBRE1'.
        CALL METHOD get_admes_sobre1
          EXPORTING
            im_docclass = im_docid-class
            im_objectid = im_docid-objid
            im_num_sob  = '1'
          RECEIVING
            ex_data     = ex_data
          EXCEPTIONS
            not_found   = 1.

*    WHEN 'ZERM_EXCLOS_SOBRE1'.
*      CALL METHOD get_exclos_sobre1
*        EXPORTING
*          im_docclass = im_docid-class
*          im_objectid = im_docid-objid
*          im_num_sob  = '1'
*        RECEIVING
*          ex_data     = ex_data
*        EXCEPTIONS
*          not_found   = 1.

***<<< FI Insert SPEC-46538 ETXGL
      WHEN 'ZERM_QUADRE_ENT_EX_SOBRE2' .
        CALL METHOD get_ent_ex_sobrex
          EXPORTING
            im_docclass = im_docid-class
            im_objectid = im_docid-objid
            im_num_sob  = '2'
          RECEIVING
            ex_data     = ex_data
          EXCEPTIONS
            not_found   = 1.

      WHEN 'ZERM_QUADRE_ENT_EX_S123' .
        CALL METHOD get_ent_ex_sobre123
          EXPORTING
            im_docclass = im_docid-class
            im_objectid = im_docid-objid
          RECEIVING
            ex_data     = ex_data
          EXCEPTIONS
            not_found   = 1.

      WHEN 'ZERM_QUADRE_ENT_NOEX_S123' .
        CALL METHOD get_ent_noex_sobre123
          EXPORTING
            im_docclass = im_docid-class
            im_objectid = im_docid-objid
          RECEIVING
            ex_data     = ex_data
          EXCEPTIONS
            not_found   = 1.

*   << EDLSM 17/11/09

      WHEN 'ZERM_QUADRE_ENT_OBER_PLIQ_S1_S2' .
        CALL METHOD get_ent_ober_pliq_s1_s2
          EXPORTING
            im_docclass = im_docid-class
            im_objectid = im_docid-objid
          RECEIVING
            ex_data     = ex_data
          EXCEPTIONS
            not_found   = 1.

      WHEN 'ZERM_QUADRE_ENT_EX_S12' .
        CALL METHOD get_ent_ex_sobre12
          EXPORTING
            im_docclass = im_docid-class
            im_objectid = im_docid-objid
          RECEIVING
            ex_data     = ex_data
          EXCEPTIONS
            not_found   = 1.

      WHEN 'ZERM_QUADRE_ENT_NOEX_S12' .
        CALL METHOD get_ent_noex_sobre12
          EXPORTING
            im_docclass = im_docid-class
            im_objectid = im_docid-objid
          RECEIVING
            ex_data     = ex_data
          EXCEPTIONS
            not_found   = 1.

      WHEN 'ZERM_QUADRE_ENT_EX_S3' .
        CALL METHOD get_ent_ex_var_sobre3
          EXPORTING
            im_docclass = im_docid-class
            im_objectid = im_docid-objid
          RECEIVING
            ex_data     = ex_data
          EXCEPTIONS
            not_found   = 1.

      WHEN 'ZERM_QUADRE_ENT_NOEX_S3' .
        CALL METHOD get_ent_noex_var_sobre3
          EXPORTING
            im_docclass = im_docid-class
            im_objectid = im_docid-objid
          RECEIVING
            ex_data     = ex_data
          EXCEPTIONS
            not_found   = 1.

      WHEN 'ZERM_QUADRE_ENT_NOEX_SOBRE123_PT' .
        CALL METHOD get_ent_noex_sobre123_pt
          EXPORTING
            im_docclass = im_docid-class
            im_objectid = im_docid-objid
          RECEIVING
            ex_data     = ex_data
          EXCEPTIONS
            not_found   = 1.

      WHEN 'ZERM_QUADRE_ENT_NOEX_SOBRE123_TEM' .
        CALL METHOD get_ent_noex_sobre123_tem
          EXPORTING
            im_docclass = im_docid-class
            im_objectid = im_docid-objid
            iv_temerari = abap_false "SPEC:57443 ECFA
          RECEIVING
            ex_data     = ex_data
          EXCEPTIONS
            not_found   = 1.

        ">>>SPEC:57443, Inici modificació  - ECFA
      WHEN 'GET_ENT_NOEX_SOBRE123_NOTEM' .
        CALL METHOD get_ent_noex_sobre123_notem
          EXPORTING
            im_docclass = im_docid-class
            im_objectid = im_docid-objid
            iv_temerari = abap_true "SPEC:57443 ECFA
          RECEIVING
            ex_data     = ex_data
          EXCEPTIONS
            not_found   = 1.

        "<<<SPEC:57443, Final modificació - ECFA

      WHEN 'ZERM_QUADRE_ENT_EX_S3_BV' .
        CALL METHOD get_ent_ex_s3
          EXPORTING
            im_docclass = im_docid-class
            im_objectid = im_docid-objid
          RECEIVING
            ex_data     = ex_data
          EXCEPTIONS
            not_found   = 1.

*   >> EDLSM

      WHEN 'ZERM_QUADRE_COM_EX_SOBRE1' .
        CALL METHOD get_com_ex_sobre1
          EXPORTING
            im_docclass = im_docid-class
            im_objectid = im_docid-objid
          RECEIVING
            ex_data     = ex_data
          EXCEPTIONS
            not_found   = 1.

      WHEN 'ZERM_QUADRE_ENT_EX_SOBRE3' .
        CALL METHOD get_ent_ex_sobre3
          EXPORTING
            im_docclass = im_docid-class
            im_objectid = im_docid-objid
          RECEIVING
            ex_data     = ex_data
          EXCEPTIONS
            not_found   = 1.

** >> INI MODIF ETODR SPEC-49881
      WHEN 'ZERM_QUADRE_ESMENA_S3' .
        CALL METHOD get_ent_es_sobre3
          EXPORTING
            im_docclass = im_docid-class
            im_objectid = im_docid-objid
          RECEIVING
            ex_data     = ex_data
          EXCEPTIONS
            not_found   = 1.

      WHEN 'ZERM_QUADRE_EXCLOS_S3' .
        CALL METHOD get_ent_ex_sobre3_new
          EXPORTING
            im_docclass = im_docid-class
            im_objectid = im_docid-objid
          RECEIVING
            ex_data     = ex_data
          EXCEPTIONS
            not_found   = 1.

      WHEN 'Z_EXCLOS_POST_OB_S3' .
        CALL METHOD get_exclos_post_ob_s3
          EXPORTING
            im_docclass = im_docid-class
            im_objectid = im_docid-objid
          RECEIVING
            ex_data     = ex_data
          EXCEPTIONS
            not_found   = 1.

      WHEN 'ZERM_QUADRE_NO_EXCLOS_NO_ESMENAT_S3' .
        CALL METHOD get_noesm_no_excl_sx
          EXPORTING
            im_docclass = im_docid-class
            im_objectid = im_docid-objid
            im_num_sob  = '3'
          RECEIVING
            ex_data     = ex_data
          EXCEPTIONS
            not_found   = 1.
** << FI MODIF ETODR SPEC-49881

      WHEN 'ZERM_ICT_ENT_EX_SOBRE3' .
        CALL METHOD get_ict_ent_ex_sobre3
          EXPORTING
            im_docclass = im_docid-class
            im_objectid = im_docid-objid
          RECEIVING
            ex_data     = ex_data
          EXCEPTIONS
            not_found   = 1.

* INI ETLJS SPEC-46538
      WHEN 'ZERM_ICT_ENT_EX_POST_OB' .
        CALL METHOD get_ict_ent_ex_post_ob
          EXPORTING
            im_docclass = im_docid-class
            im_objectid = im_docid-objid
          RECEIVING
            ex_data     = ex_data
          EXCEPTIONS
            not_found   = 1.
* FIN ETLJS SPEC-46538

      WHEN 'ZERM_ICT_ENT_EX_SOBRE2' .
        CALL METHOD get_ict_ent_ex_sobre2
          EXPORTING
            im_docclass = im_docid-class
            im_objectid = im_docid-objid
          RECEIVING
            ex_data     = ex_data
          EXCEPTIONS
            not_found   = 1.

      WHEN 'ZERM_QUADRE_ENT_EX_HOMOG' .
        CALL METHOD get_ent_ex_homog
          EXPORTING
            im_docclass = im_docid-class
            im_objectid = im_docid-objid
          RECEIVING
            ex_data     = ex_data
          EXCEPTIONS
            not_found   = 1.

      WHEN 'ZERM_QUADRE_ENT_OBER_PLIQ' .
        CALL METHOD get_ent_ober_pliq
          EXPORTING
            im_docclass = im_docid-class
            im_objectid = im_docid-objid
          RECEIVING
            ex_data     = ex_data
          EXCEPTIONS
            not_found   = 1.

      WHEN 'ZERM_QUADRE_ENT_EX_VARTEC' .
        CALL METHOD get_ent_ex_vartec
          EXPORTING
            im_docclass = im_docid-class
            im_objectid = im_docid-objid
          RECEIVING
            ex_data     = ex_data
          EXCEPTIONS
            not_found   = 1.

      WHEN 'ZERM_QUADRE_INCLOU_TEM' .
        CALL METHOD get_inclou_tem
          EXPORTING
            im_docclass = im_docid-class
            im_objectid = im_docid-objid
          RECEIVING
            ex_data     = ex_data
          EXCEPTIONS
            not_found   = 1.
      WHEN 'ZERM_QUADRE_NO_INCLOU_TEM' .
        CALL METHOD get_no_inclou_tem
          EXPORTING
            im_docclass = im_docid-class
            im_objectid = im_docid-objid
          RECEIVING
            ex_data     = ex_data
          EXCEPTIONS
            not_found   = 1.

      WHEN 'Z_MET_PRESS' .
        CALL METHOD get_met_press
          EXPORTING
            im_docclass = im_docid-class
            im_objectid = im_docid-objid
          RECEIVING
            ex_data     = ex_data
          EXCEPTIONS
            not_found   = 1.

*Inici modif. PLANT257 ACCENT(eajla)  02.08.2010

      WHEN 'Z_MET_PRESS2' .
        CALL METHOD get_met_press2
          EXPORTING
            im_docclass = im_docid-class
            im_objectid = im_docid-objid
          RECEIVING
            ex_data     = ex_data
          EXCEPTIONS
            not_found   = 1.

*Fi modif. PLANT257 ACCENT(eajla)  02.08.2010

      WHEN 'Z_DADES_RECURRENT'.
        CALL METHOD get_z_dades_recurrent
          EXPORTING
            im_docclass = im_docid-class
            im_objectid = im_docid-objid
          RECEIVING
            ex_data     = ex_data
          EXCEPTIONS
            not_found   = 1.

*<< edanh 20/03/12 spec 26700
      WHEN 'ZERM_NSP_NO_INCLOU_TEM' .
        CALL METHOD get_no_inclou_tem_nsp
          EXPORTING
            im_docclass = im_docid-class
            im_objectid = im_docid-objid
          RECEIVING
            ex_data     = ex_data
          EXCEPTIONS
            not_found   = 1.

      WHEN 'ZERM_NSP_INCLOU_TEM' .
        CALL METHOD get_inclou_tem_nsp
          EXPORTING
            im_docclass = im_docid-class
            im_objectid = im_docid-objid
          RECEIVING
            ex_data     = ex_data
          EXCEPTIONS
            not_found   = 1.

*<< FI edanh 20/03/12 spec 26700

        "Inicio SPEC-43531 ETKAN 26/06/2017
      WHEN 'ZERM_QUADRE_TIPUS_EXCLUSIO_S2'.

        CALL METHOD me->get_tipus_exclus_s2
          EXPORTING
            im_docclass = im_docid-class
            im_objectid = im_docid-objid
          RECEIVING
            ex_data     = ex_data
          EXCEPTIONS
            not_found   = 1.

      WHEN 'ZCRITER_PUNT'.
        "Se obtiene los criterios de puntuación. Tabla zrm_dm_crit_punt
        CALL METHOD me->get_criteris_punt
          EXPORTING
            im_docclass = im_docid-class
            im_objectid = im_docid-objid
          RECEIVING
            ex_data     = ex_data.

      WHEN 'Z_EMPATE'.
        "Si hay empate en la puntuación total de los licitadores, se marcará el flag.
        CALL METHOD get_ofertes
          EXPORTING
            im_docclass = im_docid-class
            im_objectid = im_docid-objid
          IMPORTING
            ex_ofertes  = my_ofertes.
        READ TABLE my_ofertes INTO DATA(ls_ofertes) WITH KEY z_adj_prov = abap_true.
        IF sy-subrc EQ 0.
          my_extra2-z_empate = 1.
          LOOP AT my_ofertes TRANSPORTING NO FIELDS WHERE proveidor    NE ls_ofertes-proveidor AND
                                                          z_punt_total EQ ls_ofertes-z_punt_total.

            my_extra2-z_empate = my_extra2-z_empate + 1.

          ENDLOOP.
        ENDIF.
        GET REFERENCE OF my_extra2-z_empate INTO ex_data.

      WHEN 'Z_LICITADORS_EMPATATATS'.

        CALL METHOD me->get_licitadors_empatats
          EXPORTING
            im_docclass = im_docid-class
            im_objectid = im_docid-objid
          RECEIVING
            ex_data     = ex_data.

      WHEN 'Z_2_DIES_ABANS_CON'.
        "Calcula la fecha del martes antes del consejo previsto.
        IF my_exp_cont-z_data_prev_con IS NOT INITIAL.

          CALL FUNCTION 'TV_GO_BACK_N_DAYS'
            EXPORTING
              start_date = my_exp_cont-z_data_prev_con
              n_days     = 2
              kalender   = 'E2'
            IMPORTING
              hist_date  = my_extra2-z_2_dies_abans_con.

        ENDIF.

        GET REFERENCE OF my_extra2-z_2_dies_abans_con INTO ex_data.

      WHEN 'QUADRE_2B_PUNT_TEC'.
        "Se listan los licitadores admitidos en el S2 con las puntuaciones técnicas ordenadas decrecientemente

        CALL METHOD me->get_quadre_2b_pt
          EXPORTING
            im_docclass = im_docid-class
            im_objectid = im_docid-objid
          RECEIVING
            ex_data     = ex_data.

      WHEN 'QUADRE_3_IMPORT'.
        "Se listan los licitadores admitidos en el S3 con los importes ordenados decrecientemente

        CALL METHOD me->get_quadre_3_import
          EXPORTING
            im_docclass = im_docid-class
            im_objectid = im_docid-objid
          RECEIVING
            ex_data     = ex_data.

      WHEN 'QUADRE_4_PUNT_TOTAL'.
        "Se listan los licitadores admitidos en el S3 con la punt. total ordenadas decrecientemente

        CALL METHOD me->get_quadre_4_punt_total
          EXPORTING
            im_docclass = im_docid-class
            im_objectid = im_docid-objid
          RECEIVING
            ex_data     = ex_data.

        "Fin SPEC-43531 ETKAN 26/06/2017

      WHEN 'Z_EXCLOS_POST_OB'.
        CALL METHOD me->get_exclos_post_ob
          EXPORTING
            im_docclass = im_docid-class
            im_objectid = im_docid-objid
          RECEIVING
            ex_data     = ex_data.

        ">>>SPEC:62739, Inici modificació  - ECFA
      WHEN 'Z_TIPOL_FIX'.
        CALL METHOD me->get_tipol_fix
          EXPORTING
            im_docclass = im_docid-class
            im_objectid = im_docid-objid
          RECEIVING
            ex_data     = ex_data.
        "<<<SPEC:62739, Final modificació - ECFA

** >> INI MODIF ETODR SPEC-51404
      WHEN 'Z_TIPOL_VARIABLE'.
        CALL METHOD me->get_tipol_variable
          EXPORTING
            im_docclass = im_docid-class
            im_objectid = im_docid-objid
          RECEIVING
            ex_data     = ex_data.
      WHEN 'Z_TEXT_TIPOL_VARIABLE'.
        CALL METHOD me->get_text_tipol_variable
          EXPORTING
            im_docclass = im_docid-class
            im_objectid = im_docid-objid
          RECEIVING
            ex_data     = ex_data.
      WHEN 'Z_IMPORT_TIPOL_VARIABLE'.
        CALL METHOD me->get_import_tipol_variable
          EXPORTING
            im_docclass = im_docid-class
            im_objectid = im_docid-objid
          RECEIVING
            ex_data     = ex_data.
** << FI MODIF ETODR SPEC-51404

***>>> Inici Insert SPEC-46406 ETXGL
      WHEN 'ZERM_QUADRE_INF_TEMERARI'.
        CALL METHOD get_ent_inf_temerari
          EXPORTING
            im_docclass = im_docid-class
            im_objectid = im_docid-objid
          RECEIVING
            ex_data     = ex_data
          EXCEPTIONS
            not_found   = 1.
***<<< Fi Insert SPEC-46406 ETXGL
**>> INI MODIF ETODR SPEC-49881
      WHEN 'QUADRE5'.
        CALL METHOD get_quadre5
          EXPORTING
            im_docclass = im_docid-class
            im_objectid = im_docid-objid
          RECEIVING
            ex_data     = ex_data.
**<< FI MODIF ETODR SPEC-49881

**<< ECGMG INI MODIF SPEC-55720
      WHEN 'ZERM_QUADRECP3'.
        CALL METHOD get_quadrecp3
          EXPORTING
            im_docclass = im_docid-class
            im_objectid = im_docid-objid
          RECEIVING
            ex_data     = ex_data.
**>> ECGMG FIN MODIF SPEC-55720
**>> INI MODI ETODR SPEC-55774
      WHEN 'Z_IMPORT_VAR_ADJ'.
        CALL METHOD get_z_import_var_adj
          EXPORTING
            im_docclass = im_docid-class
            im_objectid = im_docid-objid
          RECEIVING
            ex_data     = ex_data.
      WHEN 'Z_IMPORT_FIX_ADJ'.
        CALL METHOD get_z_import_fix_adj
          EXPORTING
            im_docclass = im_docid-class
            im_objectid = im_docid-objid
          RECEIVING
            ex_data     = ex_data.
**<< FI MODI ETODR SPEC-55774
*INI PRL :: SPEC-85099
      WHEN 'Z_NOM_PROVEIDOR'.
        CALL METHOD get_nom_proveidor
          EXPORTING
            im_docclass = im_docid-class
            im_objectid = im_docid-objid
          RECEIVING
            ex_data     = ex_data.
*FIN PRL :: SPEC-85099
        ">> SPEC-1482, Inici Modificació - EVODR
      WHEN 'ZERM_QDC_CLO_LIC'.
        "delete metode i variables globals
        CALL METHOD zrm_cl_qdc_util=>get_zerm_qdc_clo_lic
          EXPORTING
            iv_docclass = im_docid-class
            iv_objectid = im_docid-objid
          RECEIVING
            ro_data     = ex_data.

      WHEN 'ZERM_QDC_DOCS'.
        "delete metode i variables globals
        CALL METHOD zrm_cl_qdc_util=>get_zerm_qdc_docs
          EXPORTING
            iv_docclass = im_docid-class
            iv_objectid = im_docid-objid
          RECEIVING
            ro_data     = ex_data.

      WHEN 'ZERM_QUADRE_MATCO2'.
        "delete metode i variables globals
        CALL METHOD zrm_cl_qdc_util=>get_zerm_quadre_matco2
          EXPORTING
            iv_docclass = im_docid-class
            iv_objectid = im_docid-objid
          RECEIVING
            ro_data     = ex_data.

      WHEN 'ZERM_QDC_RAPLI'.
        "delete metode i variables globals
        CALL METHOD zrm_cl_qdc_util=>get_zerm_qdc_rapli
          EXPORTING
            iv_docclass = im_docid-class
            iv_objectid = im_docid-objid
          RECEIVING
            ro_data     = ex_data.

      WHEN 'ZERM_QUADRE_LOTS'.
        "delete metode i variables globals
        CALL METHOD zrm_cl_qdc_util=>get_zerm_quadre_lots
          EXPORTING
            iv_docclass = im_docid-class
            iv_objectid = im_docid-objid
          RECEIVING
            ro_data     = ex_data.

      WHEN 'Z_HORA_PRES_OFER_MES_1'.
        "delete metode i variables globals
        CALL METHOD zrm_cl_qdc_util=>get_hora_pres_ofer_mes_1
          EXPORTING
            iv_docclass = im_docid-class
            iv_objectid = im_docid-objid
          RECEIVING
            ro_data     = ex_data.

      WHEN 'ZTEXT_COND_IMPORT_LOTS'.
        "delete metode i variables globals
        CALL METHOD zrm_cl_qdc_util=>get_textid_import_lots
          EXPORTING
            iv_docclass = im_docid-class
            iv_objectid = im_docid-objid
          RECEIVING
            ro_data     = ex_data.
        "<< SPEC-1482, Final Modificació - EVODR
    ENDCASE .

    ">> SPEC-1482, Inici Modificació - EVODR
    IF im_element CS 'TEXT_SAPSCRIPT_ZQDC_'.
      SPLIT im_element AT zrm_cl_qdc_util=>gc_tag_sapscript_qdc INTO TABLE DATA(lt_tdid).
      IF sy-subrc = 0.
        READ TABLE lt_tdid INTO DATA(lv_tdid) INDEX 2.
        IF sy-subrc = 0 AND lv_tdid IS NOT INITIAL.
          SELECT SINGLE z_codi_qdc
            FROM zvrm_qdc_cap_lic
            INTO @DATA(lv_tdname)
            WHERE docclass = @im_docid-class
              AND objectid = @im_docid-objid.
          IF sy-subrc = 0 AND lv_tdname IS NOT INITIAL.
            CALL METHOD zrm_cl_qdc_util=>get_text_sapscript
              EXPORTING
                iv_docclass = im_docid-class
                iv_objectid = im_docid-objid
                iv_tdid     = CONV #( lv_tdid )
                iv_tdobject = zrm_cl_sapscript_texts=>co_tdobject_zqdc
                iv_tdname   = CONV #( lv_tdname )
              RECEIVING
                ro_data     = ex_data.
*            CALL METHOD get_text_sapscript
*              EXPORTING
*                iv_docclass = im_docid-class
*                iv_objectid = im_docid-objid
*                iv_tdid     = CONV #( lv_tdid )
*                iv_tdobject = zrm_cl_sapscript_texts=>co_tdobject_zqdc
*                iv_tdname   = CONV #( lv_tdname )
*              RECEIVING
*                ro_data     = ex_data.
          ENDIF.
        ENDIF.
      ENDIF.
    ENDIF.
    "<< SPEC-1482, Final Modificació - EVODR

    IF im_element CP 'Z_ENTITATS_VINCULADES_+' .
* El contingut d'aquest llistat depèn de per quin camp s'ordeni el Quadre3. En teoria
* les plantilles no demanaran aquest llistat sense haver demanat abans el Quadre3 però
* el funcionament del motor de plantilles no garanteix que les variables es calculin
* en el mateix ordre seqüencial en què apareixen a la plantilla
      CASE im_element+22(1) .
        WHEN 'A' .    l_sort_field = 'COST_INT' .
        WHEN 'B' .    l_sort_field = 'BAIXA_COMP_FIN_INT' .
        WHEN 'C' .    l_sort_field = 'BAIXA_OFERTA_COST_FIN_INT' .
        WHEN 'D' .    l_sort_field = 'BAIXA_COMP_FINANCERA_COST_INT' .
        WHEN OTHERS . RAISE not_found .
      ENDCASE .

      CALL METHOD get_quadre3
        EXPORTING
          im_docclass     = im_docid-class
          im_objectid     = im_docid-objid
          im_sort_by      = l_sort_field
          im_tipus_oferta = 'B'
        IMPORTING
          ex_vincles      = ex_data
        EXCEPTIONS
          not_found       = 1.
    ENDIF .


*-- Tenim 8 variants diferents del quadre 3 que només es diferencien en el
*-- % de baixa pel qual s'ha d'ordenar i en el tipus d'oferta (base / variant)
*-- a tenir en compte
    IF im_element CP 'ZERM_QUADRE3_++' OR
       im_element CP 'ZERM_QUADREO_++'.

      l_tipus_oferta = im_element+14(1) .

      CASE im_element+13(1) .
        WHEN 'A' .
          l_sort_field = 'COST_INT' .
        WHEN 'B' .
          l_sort_field = 'BAIXA_COMP_FIN_INT' .
        WHEN 'C' .    l_sort_field = 'BAIXA_OFERTA_COST_FIN_INT' .
        WHEN 'D' .    l_sort_field = 'BAIXA_COMP_FINANCERA_COST_INT' .
        WHEN OTHERS . RAISE not_found .
      ENDCASE .

      CASE l_tipus_oferta .
        WHEN gc_oferta_base OR gc_oferta_variant .
        WHEN OTHERS . RAISE not_found .
      ENDCASE .

      IF im_element CP 'ZERM_QUADREO_++'.
        lv_obertura = abap_true.
      ELSE.
        CLEAR lv_obertura.
      ENDIF.

      CALL METHOD get_quadre3
        EXPORTING
          im_docclass     = im_docid-class
          im_objectid     = im_docid-objid
          im_sort_by      = l_sort_field
          im_tipus_oferta = l_tipus_oferta
          im_obertura     = lv_obertura
        IMPORTING
          ex_quadre       = ex_data
        EXCEPTIONS
          not_found       = 1.
    ENDIF .
    ">>>SPEC-56450, Inici modificació  - ETODR
    IF im_element CP 'ZERM_QUADREOBS_++' ..
      l_tipus_oferta = im_element+16(1) .

      CASE im_element+15(1) .
        WHEN 'A' .
          l_sort_field = 'COST_INT' .
        WHEN 'B' .
          l_sort_field = 'BAIXA_COMP_FIN_INT' .
        WHEN 'C' .    l_sort_field = 'BAIXA_OFERTA_COST_FIN_INT' .
        WHEN 'D' .    l_sort_field = 'BAIXA_COMP_FINANCERA_COST_INT' .
        WHEN OTHERS . RAISE not_found .
      ENDCASE .
      CASE l_tipus_oferta .
        WHEN gc_oferta_base OR gc_oferta_variant .
        WHEN OTHERS . RAISE not_found .
      ENDCASE .

      CALL METHOD get_quadre_obertura_simpl
        EXPORTING
          im_docclass     = im_docid-class
          im_objectid     = im_docid-objid
          im_sort_by      = l_sort_field
          im_tipus_oferta = l_tipus_oferta
        IMPORTING
          ex_quadre       = ex_data
        EXCEPTIONS
          not_found       = 1.
    ENDIF.
    "<<<SPEC-56450, Final modificació - ETODR
*** INI SPEC-53131
    IF im_element CP 'ZERM_QUADRE_2A_CP_++' .
      CASE im_element+18(1) .
        WHEN 'A' .    l_sort_field = 'COST_INT' .
        WHEN 'B' .    l_sort_field = 'BAIXA_COMP_FIN_INT' .
        WHEN 'C' .    l_sort_field = 'BAIXA_OFERTA_COST_FIN_INT' .
        WHEN 'D' .    l_sort_field = 'BAIXA_COMP_FINANCERA_COST_INT' .
        WHEN OTHERS . RAISE not_found .
      ENDCASE .

      l_tipus_oferta = im_element+19(1) .
      CASE l_tipus_oferta .
        WHEN gc_oferta_base OR gc_oferta_variant .
        WHEN OTHERS . RAISE not_found .
      ENDCASE .

      CALL METHOD get_quadre_2a_cp
        EXPORTING
          im_docclass     = im_docid-class
          im_objectid     = im_docid-objid
          im_sort_by      = l_sort_field
          im_tipus_oferta = l_tipus_oferta
        IMPORTING
          ex_quadre       = ex_data
        EXCEPTIONS
          not_found       = 1.
    ENDIF .
*** FIN SPEC-53131
    IF im_element CP 'Z_CERTIFICAT_OK_++'.
      l_tipus_document = im_element+16(2).

      CREATE DATA ex_data TYPE ('FLAG').
      ASSIGN ex_data->* TO <fs>.
      CALL METHOD me->get_z_certificat_ok
        EXPORTING
          im_docclass  = im_docid-class
          im_objectid  = im_docid-objid
          im_tipus_doc = l_tipus_document
        IMPORTING
          ex_return    = <fs>
        EXCEPTIONS
          not_found    = 1
          OTHERS       = 2.
    ENDIF.

*INI PRL :: SPEC-85099
    IF im_element CP 'ZERM_DT_OFERTES'.

      CALL METHOD get_dt_ofertes
        EXPORTING
          im_docclass = im_docid-class
          im_objectid = im_docid-objid
*         im_sort_by  = l_sort_field
*         im_tipus_oferta = l_tipus_oferta
*         im_obertura = lv_obertura
        IMPORTING
          ex_quadre   = ex_data
        EXCEPTIONS
          not_found   = 1.
    ENDIF .
*FIN PRL:: SPEC-85099

    IF NOT ex_data IS BOUND .
      RAISE not_found .
    ENDIF .
  ENDMETHOD.
ENDCLASS.