class ZRM_CL_VALORACIO_OFERTES_FE definition
  public
  final
  create public .

*"* public components of class ZRM_CL_VALORACIO_OFERTES_FE
*"* do not include other source files here!!!
public section.
  type-pools ICON .

  types:
    BEGIN OF ty_s_crit_rel,
             z_mod_crit_punt TYPE z_mod_crit_punt,
             z_parent        TYPE z_codi_crit_punt,
             z_child         TYPE z_codi_crit_punt,
           END OF ty_s_crit_rel .
  types:
    ty_t_crit_rel TYPE STANDARD TABLE OF ty_s_crit_rel .

  constants CO_COEFICIENT_IREF type Z_COEFICIENT_IREF value '01' ##NO_TEXT.
  constants CO_MODE_1_ROUND type CHAR1 value 'A' ##NO_TEXT.
  constants CO_MODE_ADJ_2ND type CHAR1 value 'D' ##NO_TEXT.
  constants CO_MODE_ADJ_FN type CHAR1 value 'G' ##NO_TEXT.
  constants CO_MODE_PUNCT_1ST type CHAR1 value 'B' ##NO_TEXT.
  constants CO_MODE_PUNCT_2ND type CHAR1 value 'C' ##NO_TEXT.
  constants CO_SUBMODE_RD817_2009 type CHAR1 value '1' ##NO_TEXT.
  constants CO_MODE_PUNCT_TEC type CHAR1 value 'E' ##NO_TEXT.
  constants CO_MODE_NEG_F2 type CHAR1 value 'G' ##NO_TEXT.
  constants CO_MODE_PUNT_SOL_PART type CHAR1 value 'F' ##NO_TEXT.
  data GS_EXP_CONT type ZRM_DT_EXP_CONT .
  data GT_CRIT_PUNT type ZRM_CL_VALORACIO_OFERTES=>TY_T_CRIT_PUNT .
  data GS_CRIT_PUNT type ZRM_CL_VALORACIO_OFERTES=>TY_S_CRIT_PUNT .
  constants CO_FC_CREATE_Q2B_92017 type SY-UCOMM value 'Q2B_92017' ##NO_TEXT.
  constants CO_FC_CREATE_Q3B_92017 type SY-UCOMM value 'Q3B_92017' ##NO_TEXT.
  constants CO_FC_CREATE_Q4A_92017 type SY-UCOMM value 'Q4A_92017' ##NO_TEXT.
  constants CO_FC_CREATE_Q4B_92017 type SY-UCOMM value 'Q4B_92017' ##NO_TEXT.

  methods CLOSE .
  methods CONSTRUCTOR
    importing
      !ACTION like CO_MODE_1_ROUND
      !DOCCLASS type BAPIDCLASS
      !OBJECTID type BAPIGUID
      !IS_DYNAMIC type Z_CRI_DIN default ''
    raising
      ZCX_RM_VALORACIO .
  methods REQUEST_CLOSE
    returning
      value(RE_CAN_CLOSE) type XFELD .
  methods SAVE .
  methods START
    importing
      !IM_CONTAINER type ref to CL_GUI_CUSTOM_CONTAINER
    raising
      ZCX_RM_VALORACIO .
  methods SELECCIO_APARTATS_DYN
    raising
      ZCX_RM_VALORACIO .
  methods GET_PUNT_INCR_OBJ
    importing
      !IS_PUNTS_OFFER type ANY
      !IT_INCR type ZRM_TT_DT_PUNT_EQUI
    changing
      !IS_COLUMN type ZRM_CL_VALORACIO_OFERTES=>TY_S_COLUMN .
  methods Z_EDITABLE_PUNTUACIO .
protected section.
*"* protected components of class ZRM_CL_VALORACIO_OFERTES_FE
*"* do not include other source files here!!!


  types:
    BEGIN OF ty_s_column,
      fieldname(30),
      colpos        TYPE i,
      key(20),
      header(30),
      total         TYPE z_punt_max,
      editable      TYPE xfeld,
      sort_crit1    TYPE char20,
      punt_total    TYPE zrm_dt_punt_ofer-z_punts,
      subheader(40),
      full_name     TYPE string,
      adjudicat     TYPE xfeld,
      mill_class    TYPE zrm_dt_ofertes-z_mill_class . " SPEC-54695
  TYPES: equip_max TYPE ztt_equip_max. "SPEC-49806
*             subapart    TYPE xfeld,
*             actual_pos  TYPE i, "Posició actual a l'ALV
  TYPES: END OF ty_s_column .
  types:
    ty_t_column TYPE STANDARD TABLE OF ty_s_column WITH NON-UNIQUE KEY key .
  types:
    BEGIN OF ty_s_row,
      z_mod_crit_punt            TYPE zrm_dm_crit_punt-z_mod_crit_punt,
      z_codi_crit_punt           TYPE zrm_dm_crit_punt-z_codi_crit_punt,
      z_descripcio               TYPE zrm_dm_crit_punt-z_descripcio,
      z_punt_min                 TYPE zrm_dm_crit_punt-z_punt_min,
      z_punt_max                 TYPE zrm_dm_crit_punt-z_punt_max,
      z_rang                     TYPE char80, "TYPE char25, "SPEC-52568
      style                      TYPE lvc_t_styl,
      cell_color                 TYPE lvc_t_scol,
      row_color                  TYPE char4,
      z_comptador_equip          TYPE zrm_dt_punt_equi-z_comptador_equip, "ETODR SPEC-49500
      z_excloure_lici            TYPE zrm_dm_crit_punt-z_excloure_lici, "ETODR SPEC-49500
      z_base                     TYPE xfeld, "ETODR SPEC-49500
      z_equip_max                TYPE xfeld, "etlsj spec-49806
      z_incr                     TYPE xfeld, " ETLJS SPEC-55535 30.10.2019 12:08:22
      z_equip_pdm                TYPE xfeld, "etodr SPEC-50770
      z_equip_coautor            TYPE xfeld, "etodr SPEC-51135
      z_mult_equip_incr          TYPE zrm_dm_crit_punt-z_mult_equip_incr, "ECDRB SPEC-64893
      z_coefi_iref               TYPE xfeld, "ETODR SPEC-67070
      z_co2                      TYPE zrm_dm_crit_punt-z_co2, "ETODR SPEC-71214
      z_codi_crit_punt_equip_sep TYPE zrm_dm_crit_punt-z_codi_crit_punt, "ETODR SPEC-66771
      z_equip_sep                TYPE zrm_dm_crit_punt-z_equip_sep, "ETODR SPEC-66771
    END   OF ty_s_row .
  types:
    ty_t_row TYPE SORTED TABLE OF ty_s_row WITH NON-UNIQUE KEY z_codi_crit_punt .

  data MY_BACKEND type ref to ZRM_CL_VALORACIO_OFERTES .
  data MY_COLUMNS type TY_T_COLUMN .
  data MY_DD_DOCUMENT type ref to CL_DD_DOCUMENT .
  data MY_DOI_CONTAINER type ref to CL_GUI_CUSTOM_CONTAINER .
  data MY_DOI_CONTROL type ref to I_OI_CONTAINER_CONTROL .
  data MY_FIELDCAT type LVC_T_FCAT .
  data MY_GRID type ref to CL_GUI_ALV_GRID .
  data MY_LINE_REF type ref to DATA .
  data MY_MODE like CO_MODE_1_ROUND .
  data MY_SUBMODE like MY_MODE .
  data MY_NAVIGATION_BOX type ref to CL_GUI_DIALOGBOX_CONTAINER .
  data MY_NAVIGATION_ENABLED type XFELD .
  data MY_NAVIGATION_GRID type ref to CL_SALV_TABLE .
  data MY_READ_ONLY type XFELD .
  data MY_SPLITTER type ref to CL_GUI_SPLITTER_CONTAINER .
  data MY_TABLE_REF type ref to DATA .
  data MY_OFERTESX type ref to ZRM_CL_VALORACIO_OFERTES .

  methods BUILD_HEADER
    raising
      ZCX_RM_VALORACIO .
  methods CHECK_2_ROUND_SEQUENCE
    raising
      ZCX_RM_VALORACIO .
  methods CHECK_PUNT_TEC_SEQ
    raising
      ZCX_RM_VALORACIO .
  methods CHECK_SOL_PART_SEQ
    raising
      ZCX_RM_VALORACIO .
  class-methods CHECK_CONSISTENCY
    importing
      !IM_CONSISTENCY type ZRM_CL_VALORACIO_OFERTES=>TY_S_CONSISTENCY
    returning
      value(RE_READ_ONLY) type XFELD
    raising
      ZCX_RM_VALORACIO .
  methods CONFIRM .
  class-methods CONFIRM_DATA_LOSS
    returning
      value(RE_ANSWER) type CHAR1 .
  class-methods CONFIRM_NOT_AWARDED
    returning
      value(RE_ANSWER) type CHAR1 .
  methods GET_DATA
    importing
      !IM_FROM_DB type XFELD
    exporting
      !EX_CRIT_PUNT type ZRM_CL_VALORACIO_OFERTES=>TY_T_CRIT_PUNT
      !EX_PUNT_GEN type ZRM_CL_VALORACIO_OFERTES=>TY_T_PUNT_GEN
    raising
      ZCX_RM_VALORACIO .
  methods POPULATE_MATRIX
    exporting
      !EX_LINE_REF type ref to DATA
      !EX_TABLE_REF type ref to DATA
    raising
      ZCX_RM_VALORACIO .
  methods RECALCULATE
    importing
      !DADES_OFER_DYN type ZRM_TT_DT_PUNT_OFER optional
    raising
      ZCX_RM_VALORACIO .
  methods SET_BEST_CLASSIFIED .
  methods SET_AWARDEE .
  methods UNCONFIRM .
  methods RECALCULATE_NO_REFRESH
    importing
      !DADES_OFER_DYN type ZRM_TT_DT_PUNT_OFER optional .
private section.
*"* private components of class ZRM_CL_VALORACIO_OFERTES_FE
*"* do not include other source files here!!!

  constants CO_FC_COLUMN_LEFT type SY-UCOMM value 'C-' ##NO_TEXT.
  constants CO_FC_COLUMN_RIGHT type SY-UCOMM value 'C+' ##NO_TEXT.
  constants CO_FC_CONFIRM type SY-UCOMM value 'CNF' ##NO_TEXT.
  constants CO_FC_CREATE_DOC type SY-UCOMM value 'DD_DOC' ##NO_TEXT.
  constants CO_FC_CREATE_Q4A_DRAFT type SY-UCOMM value 'Q4A_DRAFT' ##NO_TEXT.
  constants CO_FC_CREATE_Q4B_DRAFT type SY-UCOMM value 'Q4B_DRAFT' ##NO_TEXT.
  constants CO_FC_CREATE_Q4_DRAFT type SY-UCOMM value 'Q4_DRAFT' ##NO_TEXT.
  constants CO_FC_CREATE_Q4_INT type SY-UCOMM value 'Q4_INTERNAL' ##NO_TEXT.
  constants CO_FC_CREATE_Q4LEM_DRAFT type SY-UCOMM value 'Q4LEM_DRAFT' ##NO_TEXT.
  constants CO_FC_CREATE_Q2B_DRAFT type SY-UCOMM value 'Q2B_DRAFT' ##NO_TEXT.
  constants CO_FC_CREATE_Q1B_DRAFT type SY-UCOMM value 'Q1B_DRAFT' ##NO_TEXT.
  constants CO_FC_GOTO_PAGE type SY-UCOMM value 'GTP' ##NO_TEXT.
  constants CO_FC_PAGE_FIRST type SY-UCOMM value 'P--' ##NO_TEXT.
  constants CO_FC_PAGE_LAST type SY-UCOMM value 'P++' ##NO_TEXT.
  constants CO_FC_PAGE_LEFT type SY-UCOMM value 'P-' ##NO_TEXT.
  constants CO_FC_PAGE_RIGHT type SY-UCOMM value 'P+' ##NO_TEXT.
  constants CO_FC_SAVE type SY-UCOMM value 'SAV' ##NO_TEXT.
  constants CO_FC_SET_AWARDEE type SY-UCOMM value 'ADJ' ##NO_TEXT.
  constants CO_FC_SET_BEST_CLASSIFIED type SY-UCOMM value 'MILLOR' ##NO_TEXT.
  constants CO_FC_SORT_DOWN_NAME type SY-UCOMM value 'SDN' ##NO_TEXT.
  constants CO_FC_SORT_DOWN_PUNT type SY-UCOMM value 'SDP' ##NO_TEXT.
  constants CO_FC_SORT_UP_NAME type SY-UCOMM value 'SUN' ##NO_TEXT.
  constants CO_FC_SORT_UP_PUNT type SY-UCOMM value 'SUP' ##NO_TEXT.
  constants CO_FC_TOGGLE_NAV type SY-UCOMM value 'TNV' ##NO_TEXT.
  constants CO_FC_UNLOCK type SY-UCOMM value 'UNL' ##NO_TEXT.
  constants CO_FC_MOTIVACIO type SY-UCOMM value '&MOTIVACIO' ##NO_TEXT.
  constants CO_FIXED_COLS_LEFT type I value 3 ##NO_TEXT.
  constants CO_MAX_COLS_SHOWN type I value 95 ##NO_TEXT.
  data:
    BEGIN OF my_backend_activities,
          save_punct      LIKE my_backend->co_act_punct_1st,
          confirm_punct   LIKE my_backend->co_act_punct_1st,
          set_awarded     LIKE my_backend->co_act_punct_1st,
          set_millor_cla  LIKE my_backend->co_act_punct_1st, " SPEC-54695
          unconfirm       LIKE my_backend->co_act_punct_1st,
        END   OF my_backend_activities .
  data MY_NAVIGATION_INFO type TY_T_NAV_INFO .
  data MY_PAGE_FIRST_INDEX type I .
  data MY_PAGE_LAST_INDEX type I .
  constants CO_PUNTUAR type SY-UCOMM value 'Q4_PUNTUAR' ##NO_TEXT.
  constants CO_BAREM type SY-UCOMM value 'Q4_BAREM' ##NO_TEXT.
  data GV_DOCCLASS type BAPIDCLASS .
  data GV_OBJECTID type BAPIGUID .
  data GT_CRIT_REL type TY_T_CRIT_REL .
  constants CO_FC_CREATE_INF_PT_DEF type SY-UCOMM value 'INF_PT_DEF' ##NO_TEXT.
  data GV_SUBTIPUS type Z_SUBTIPUS_CONT .
  data GV_POOLS type INT4 .
  data GV_MAXPOOLS type ZSAP_DE_VALUE .

  methods HOTSPOT_CLICK_CO2
    importing
      !IS_ROW_NO type LVC_S_ROID
      !I_COLUMN_ID type LVC_S_COL
      !I_ROW_ID type LVC_S_ROW .
  methods HOTSPOT_CLICK_COEFI_IREF
    importing
      !IS_ROW_NO type LVC_S_ROID
      !I_COLUMN_ID type LVC_S_COL
      !I_ROW_ID type LVC_S_ROW .
  methods HOTSPOT_CLICK_INCR
    importing
      !IS_ROW_NO type LVC_S_ROID
      !I_COLUMN_ID type LVC_S_COL
      !I_ROW_ID type LVC_S_ROW .
  methods HOTSPOT_CLICK_EQUIP_COAUTOR
    importing
      !IS_ROW_NO type LVC_S_ROID
      !I_COLUMN_ID type LVC_S_COL
      !I_ROW_ID type LVC_S_ROW .
  methods HOTSPOT_CLICK_PDM_EQUIP
    importing
      !IS_ROW_NO type LVC_S_ROID
      !I_COLUMN_ID type LVC_S_COL
      !I_ROW_ID type LVC_S_ROW .
  methods HOTSPOT_CLICK_EQUIP
    importing
      !I_ROW_ID type LVC_S_ROW
      !I_COLUMN_ID type LVC_S_COL
      !IS_ROW_NO type LVC_S_ROID .
  methods HOTSPOT_CLICK_EXLOURE
    importing
      !I_ROW_ID type LVC_S_ROW
      !I_COLUMN_ID type LVC_S_COL
      !IS_ROW_NO type LVC_S_ROID .
  methods HOTSPOT_CLICK_PUNTUAR
    importing
      !I_ROW_ID type LVC_S_ROW
      !I_COLUMN_ID type LVC_S_COL
      !IS_ROW_NO type LVC_S_ROID
    raising
      ZCX_RM_VALORACIO .
  methods HOTSPOT_CLICK_MULT_EQUIP_INCR
    importing
      !IS_ROW_NO type LVC_S_ROID
      !I_COLUMN_ID type LVC_S_COL
      !I_ROW_ID type LVC_S_ROW .
  methods SHOW_POPUP_WARNINGS .
  methods EDIT_MOTIVACIO
    importing
      !I_CRITERI type Z_CODI_CRIT_PUNT optional
      !I_SUBAPART type Z_CODI_SUBAPAR_PUNT optional
      !I_DOCCLASS type BAPIDCLASS
      !I_OBJECTID type BAPIGUID .
  methods ANNEXAR_DOC_A_EXP
    importing
      value(I_EXP_DOCCLASS) type ZRM_DT_EXP_CONT-DOCCLASS
      value(I_EXP_OBJECTID) type ZRM_DT_EXP_CONT-OBJECTID
      !IS_GMD_TEMPLATE type ZRM_GMD_TASK_TEMPLATE
      !I_DOCUMENT_TYPE type SY-UCOMM
      !I_TASK_DOCUMENT type Z_TASCA_GMD
      !IT_OFERTA type ZRM_TT_DT_OFERTES optional
      !IT_LEMA type ZRM_TT_DT_LEMES optional
    exporting
      !LOCAL type BOOLEAN
    exceptions
      NOT_FOUND
      NOT_PARAMETRIZED
      NODE_NOT_EXISTS .
  methods CREATE_DOCUMENT
    importing
      !IM_DOCUMENT_TYPE type SY-UCOMM .
  methods ON_CLOSE_DOCUMENT
    for event ON_CLOSE_DOCUMENT of I_OI_DOCUMENT_PROXY
    importing
      !DOCUMENT_PROXY
      !HAS_CHANGED .
  methods AFTER_USER_COMMAND
    for event AFTER_USER_COMMAND of CL_GUI_ALV_GRID
    importing
      !E_UCOMM
      !E_SAVED
      !E_NOT_PROCESSED .
  methods BEFORE_USER_COMMAND
    for event BEFORE_USER_COMMAND of CL_GUI_ALV_GRID
    importing
      !E_UCOMM .
  class-methods BUILD_MATRIX
    exporting
      !EX_TABLE_REF type ref to DATA
      !EX_LINE_REF type ref to DATA
    changing
      !CH_COLUMNS type TY_T_COLUMN .
  methods CHECK_TEMERITATS
    raising
      ZCX_RM_VALORACIO .
  class-methods CREATE_CATALOG
    importing
      !IM_COLUMNS type TY_T_COLUMN
      !IM_READ_ONLY type XFELD
    returning
      value(EX_FCAT) type LVC_T_FCAT .
  methods CREATE_GUI_CONTROLS
    importing
      !IM_CONTAINER type ref to CL_GUI_CUSTOM_CONTAINER .
  methods CREATE_DOI_CONTROLS
    raising
      ZCX_RM_VALORACIO .
  methods FILL_AWARDEE_LINE
    changing
      !CH_ROW type TY_S_ROW
      !CH_PUNT type ANY .
  methods FILL_BEST_CLASSIFIED_LINE
    changing
      !CH_ROW type TY_S_ROW
      !CH_PUNT type ANY .
  class-methods LEMES_TO_COLUMNS
    importing
      !IM_LEMES type ZRM_CL_VALORACIO_OFERTES=>TY_T_LEMA
      !IM_OFFERS type ZRM_CL_VALORACIO_OFERTES=>TY_T_OFERTAX optional
    changing
      value(CH_COLUMNS) type TY_T_COLUMN .
  class-methods OFFERS_TO_COLUMNS
    importing
      !IM_CRIT_PUNT type ZRM_CL_VALORACIO_OFERTES=>TY_T_CRIT_PUNT optional
      !IM_OFFERS type ZRM_CL_VALORACIO_OFERTES=>TY_T_OFERTAX
      !IM_MAX_EQUIP type ZTT_EQUIP_MAX optional
      !MY_MODE like CO_MODE_1_ROUND optional
    changing
      value(CH_COLUMNS) type TY_T_COLUMN .
  methods ON_BUTTON_CLICK
    for event BUTTON_CLICK of CL_GUI_ALV_GRID
    importing
      !ES_COL_ID
      !ES_ROW_NO .
  methods ON_CLOSE_NAVIGATION
    for event CLOSE of CL_GUI_DIALOGBOX_CONTAINER .
  methods ON_DATA_CHANGED
    for event DATA_CHANGED of CL_GUI_ALV_GRID
    importing
      !ER_DATA_CHANGED .
  methods ON_DATA_CHANGED_FINISHED
    for event DATA_CHANGED_FINISHED of CL_GUI_ALV_GRID
    importing
      !E_MODIFIED .
  methods ON_DELAYED_CALLBACK
    for event DELAYED_CALLBACK of CL_GUI_ALV_GRID .
  methods ON_MENU_BUTTON
    for event MENU_BUTTON of CL_GUI_ALV_GRID
    importing
      !E_OBJECT
      !E_UCOMM .
  methods ON_TOOLBAR
    for event TOOLBAR of CL_GUI_ALV_GRID
    importing
      !E_OBJECT
      !E_INTERACTIVE .
  methods ON_USER_COMMAND
    for event USER_COMMAND of CL_GUI_ALV_GRID
    importing
      !E_UCOMM .
  methods PREPARE_DATA
    importing
      !IM_CRIT_PUNT type ZRM_CL_VALORACIO_OFERTES=>TY_T_CRIT_PUNT optional
    raising
      ZCX_RM_VALORACIO .
  methods REFRESH_TABLE_DISPLAY .
  methods SHIFT_SHOWN_COLUMNS
    importing
      !IM_DIRECTION like CO_FC_PAGE_LEFT optional
      !IM_PAGE type I optional
    preferred parameter IM_DIRECTION .
  methods SHOW_NAVIGATION_BOX .
  methods SORT_SHOWN_COLUMNS
    importing
      !IM_SORT_ORDER like CO_FC_SORT_UP_NAME .
  methods TOGGLE_NAVIGATION_BOX .
  methods ON_HOTSPOT_CLICK
    for event HOTSPOT_CLICK of CL_GUI_ALV_GRID
    importing
      !E_ROW_ID
      !E_COLUMN_ID
      !ES_ROW_NO .
  methods ON_CONTEXT_MENU
    for event CONTEXT_MENU_REQUEST of CL_GUI_ALV_GRID
    importing
      !E_OBJECT
      !SENDER .
  class-methods COMPROVACIO_ARQUITECTES
    importing
      !IV_DOCCLASS type BAPIDCLASS
      !IV_OBJECTID type BAPIGUID
      !IM_NUM_OFER type CHAR20
    exporting
      !OV_RESULTAT type XFELD .
ENDCLASS.



CLASS ZRM_CL_VALORACIO_OFERTES_FE IMPLEMENTATION.


METHOD after_user_command.
* L'ALV només mostra fins a 99 columnes per limitacions tècniques. El nostre
* catalog ja té això en compte i no intenta mostrar-ne més. Quan s'exporta
* l'ALV només es tenen en compte les columnes que es visualitzen peró nossaltre
* volem exportar-les totes
  CASE e_ucomm .
    WHEN    cl_gui_alv_grid=>mc_fc_pc_file
         OR cl_gui_alv_grid=>mc_fc_to_office
         OR cl_gui_alv_grid=>mc_fc_to_rep_tree
         OR cl_gui_alv_grid=>mc_fc_send
         OR cl_gui_alv_grid=>mc_fc_html
         OR cl_gui_alv_grid=>mc_fc_call_xxl
         OR cl_gui_alv_grid=>mc_fc_call_xint
         OR cl_gui_alv_grid=>mc_fc_call_xml_export.
      DESCRIBE TABLE my_columns .
      CHECK sy-tfill GT co_max_cols_shown .
      CALL METHOD my_grid->set_frontend_fieldcatalog
        EXPORTING
          it_fieldcatalog = my_fieldcat.
      me->refresh_table_display( ) .

    WHEN OTHERS .
      RETURN .
  ENDCASE .
ENDMETHOD.


  METHOD annexar_doc_a_exp.
    DATA: lr_container     TYPE REF TO zrm_cl_container,
          lr_expedient     TYPE REF TO zrm_cl_expedients,
          lr_util          TYPE REF TO zrm_cl_util,
          lr_data          TYPE REF TO data,
          lv_record_sps_id TYPE srmspsid,
          l_answer         TYPE c.
    local = abap_false. "SPEC-46407 per defecte local és fals

    CREATE OBJECT lr_util.
    CONCATENATE i_exp_docclass  i_exp_objectid INTO DATA(lv_rec_id) RESPECTING BLANKS.
    CALL METHOD lr_util->obtindre_atributs_exp
      EXPORTING
        im_record_docid = lv_rec_id
      IMPORTING
        ex_properties   = DATA(lt_props).
    IF lt_props IS NOT INITIAL.
      READ TABLE lt_props ASSIGNING FIELD-SYMBOL(<fs_prop>) WITH KEY name = 'SRM_MODEL'.
      MOVE <fs_prop>-value TO lv_record_sps_id.

      SELECT SINGLE anchor
        FROM zrm_quaesb_pt
        INTO (@data(lv_anchor))
        WHERE srmspsid  = @lv_record_sps_id
          AND activitat = @i_document_type.

      IF sy-subrc = 0 AND lv_anchor IS NOT INITIAL.
        "Es comprovar pimer que l'anchor existeixi al model de l'expedient
        "...
        lr_util->obtindre_element_per_anchor( EXPORTING im_record_docid = lv_rec_id
                                                        im_anchor       = CONV #( lv_anchor )
                                              IMPORTING ex_element      = DATA(lr_element) ).
        IF lr_element IS NOT INITIAL. "si no es troba referència a l'elment per l'Anchor especificat és que aquest model no té cap node amb aquest nom
          CLEAR: l_answer.
          "Es pregunta si es vol annexar directament o guardar en local
          CALL FUNCTION 'POPUP_TO_CONFIRM'
            EXPORTING
              text_question         = text-p01 "'Seleccioni on vol guardar el document'
              text_button_1         = text-p02 "'A l''expedient'
              text_button_2         = text-p03 "'En local'
              display_cancel_button = abap_off
              iv_quickinfo_button_1 = text-p04 "'Es guardarà directament a l''expedient'
              iv_quickinfo_button_2 = text-p05 "'Es guardarà en el directori local'
            IMPORTING
              answer                = l_answer.

          IF l_answer = 1.
            DATA(ls_gmd_template) = is_gmd_template.
            IF i_task_document <> is_gmd_template-z_tasca.
              "Si la tasca de creació del document no és la mateixa que té la plantilla és que es tracta d'un esborrany
              ls_gmd_template-z_tasca = i_task_document.
            ENDIF.
            "Es recupera la instància de l'expedient i es carrega el contenidor amb els dades que cal mostrar
            lr_expedient ?= zrm_cl_expedients=>zif_rm_expedient~get_instance_by_key( im_docclass = i_exp_docclass
                                                                                     im_objectid = i_exp_objectid ) .
            CREATE OBJECT lr_container
              EXPORTING
                im_expedient = lr_expedient.
            GET REFERENCE OF it_oferta INTO lr_data .
            lr_container->replace_element( im_element   = 'OFERTES_ESP'
                                           im_reference = lr_data ) .
            GET REFERENCE OF it_lema INTO lr_data .
            lr_container->replace_element( im_element   = 'LEMES_ESP'
                                           im_reference = lr_data ) .

            CALL FUNCTION 'Z_CREATE_TASK_DOCUMENT'
              EXPORTING
                im_docclass_exp      = i_exp_docclass
                im_objectid_exp      = i_exp_objectid
                im_template          = ls_gmd_template
                im_anchor            = lv_anchor
                im_valoracio_ofertes = my_backend
                im_expedient         = lr_expedient
                im_container         = lr_container
                im_annexar           = abap_true
              EXCEPTIONS
                not_found            = 1
                expedient_bloquejat  = 2
                missing_parameters   = 3
                not_annexed          = 4.

            IF sy-subrc <> 0.
              RAISE not_found.
            ENDIF.
          ELSE.
***INI MOD ETJHG - SPEC-46407
            "Si le dan a local haremos que la variable local sea 'X'
            local = abap_true.
***FIN MOD ETJHG - SPEC-46407
            RAISE not_parametrized.
          ENDIF.
        ELSE.
          RAISE node_not_exists.
        ENDIF.
      ELSE.
        local = abap_true.         "SPEC-48559 ETJMD 14.06.2018
        RAISE not_parametrized.
      ENDIF.
    ELSE.
      RAISE not_found.
    ENDIF.
    FREE: lr_util.
  ENDMETHOD.


METHOD before_user_command.
  DATA: lt_fcat LIKE my_fieldcat,
        ls_fcat LIKE LINE OF lt_fcat .

* L'ALV només mostra fins a 99 columnes per limitacions tècniques. El nostre
* catalog ja té això en compte i no intenta mostrar-ne més. Quan s'exporta
* l'ALV només es tenen en compte les columnes que es visualitzen peró nossaltre
* volem exportar-les totes
  CASE e_ucomm .
    WHEN    cl_gui_alv_grid=>mc_fc_pc_file
         OR cl_gui_alv_grid=>mc_fc_to_office
         OR cl_gui_alv_grid=>mc_fc_to_rep_tree
         OR cl_gui_alv_grid=>mc_fc_send
         OR cl_gui_alv_grid=>mc_fc_html
         OR cl_gui_alv_grid=>mc_fc_call_xxl
         OR cl_gui_alv_grid=>mc_fc_call_xint
         OR cl_gui_alv_grid=>mc_fc_call_xml_export.
      DESCRIBE TABLE my_columns .
      CHECK sy-tfill GT co_max_cols_shown .
      ls_fcat-no_out = space .
      lt_fcat = my_fieldcat .
      MODIFY lt_fcat FROM ls_fcat TRANSPORTING no_out WHERE no_out = 'X'  .

      CALL METHOD my_grid->set_frontend_fieldcatalog
        EXPORTING
          it_fieldcatalog = lt_fcat.
      me->refresh_table_display( ) . "sense això l'HTML no es genera amb totes les columnes

    WHEN OTHERS .
      RETURN .
  ENDCASE .

ENDMETHOD.


METHOD build_header .
  DATA: ls_exp_cont   TYPE zrm_dt_exp_cont,
        l_container   TYPE REF TO cl_gui_container,
        ls_plec       TYPE zrm_dm_plecs,
        lob_text_head TYPE REF TO zrm_cl_text_identifier,
        lob_text_plec TYPE REF TO zrm_cl_text_identifier,
        ls_text_head  TYPE zerm_dt_exp_cont_text,
        ls_text_plec  TYPE zerm_dm_plecs_text,
        l_text        TYPE sdydo_text_element,
        l_row_count   TYPE i,
        l_table       TYPE REF TO cl_dd_table_element,
        ls_style      LIKE LINE OF l_table->col_style_tab,
        l_table_area  TYPE REF TO cl_dd_table_area.

  ls_exp_cont = my_backend->get_header( ) .
  ls_plec     = my_backend->get_plec( ) .

  CREATE OBJECT lob_text_head
    EXPORTING
      i_tabname = 'ZRM_DT_EXP_CONT'.

  CREATE OBJECT lob_text_plec
    EXPORTING
      i_tabname = 'ZRM_DM_PLECS'.

  CALL METHOD lob_text_plec->obtenir_descripcions
    EXPORTING
      is_dades        = ls_plec
    IMPORTING
      es_descripcions = ls_text_plec.

  CALL METHOD lob_text_head->obtenir_descripcions
    EXPORTING
      is_dades        = ls_exp_cont
    IMPORTING
      es_descripcions = ls_text_head.

  my_dd_document->initialize_document( ) .

  CALL METHOD my_dd_document->add_table
    EXPORTING
      no_of_columns = 3
      border        = '0'
    IMPORTING
      table         = l_table
      tablearea     = l_table_area.

  l_table->set_column_style( EXPORTING col_no = 1 sap_valign = 'TOP' sap_emphasis = cl_dd_area=>strong ) .
  l_table->set_column_style( EXPORTING col_no = 3 sap_valign = 'TOP' sap_emphasis = cl_dd_area=>emphasis ) .
  LOOP AT l_table->col_style_tab INTO ls_style .
    CONCATENATE ls_style-style 'padding-right:4mm;' INTO ls_style-style .
    MODIFY l_table->col_style_tab FROM ls_style .
  ENDLOOP .

  DEFINE _row .
    add 1 to l_row_count .
    write &1 to l_text . l_table_area->add_text( text = l_text  ) .
    write &2 to l_text . l_table_area->add_text( text = l_text ) .
    write &3 to l_text . l_table_area->add_text( text = l_text ) .
    l_table_area->new_row( ) .
  END-OF-DEFINITION .

  DATA: ls_n_formules  TYPE xfeld,
        formules_ve_n  TYPE zrm_cl_valoracio_ofertes=>ty_s_formula_ve_n,
        info_formula   TYPE zrm_cl_valoracio_ofertes=>ty_t_formula_n_param,
        info_formula_s TYPE zrm_cl_valoracio_ofertes=>ty_s_formula_n_param.

  CALL METHOD my_backend->get_n_formules_ve
    EXPORTING
      im_plec      = ls_plec
    IMPORTING
      e_n_formules = ls_n_formules.

  IF ls_n_formules = abap_false.



    _row: 'Societat'(h01)         ls_exp_cont-societat   ls_text_head-societat,
          'Codi expedient'(h02)   ls_exp_cont-z_codi_exp ls_exp_cont-z_descrip_abr ,
          'Número plec'(h03)      ls_exp_cont-z_num_plec ls_text_head-z_num_plec,
          'Fórmula valoració econòmica'(h04) ls_plec-z_form_val_econ   ls_text_plec-z_form_val_econ,
          'Model criteris puntuació'(h05)    ls_plec-z_mod_crit_punt ls_text_plec-z_mod_crit_punt .

    IF    my_mode EQ co_mode_adj_2nd
       OR my_mode EQ co_mode_punct_2nd .
      _row: 'Model criteris proposta gràfica'(h06)    ls_plec-z_mod_crit_prop ls_text_plec-z_mod_crit_prop .
    ENDIF .


  ELSE.
    " Afegir una línia de fórmula valoració econòmica per cada fórmula

    CALL METHOD my_backend->get_formules_ve_n
      IMPORTING
        ex_formula_ve_n = formules_ve_n.

    info_formula = formules_ve_n-info_formula.

    _row: 'Societat'(h01)         ls_exp_cont-societat   ls_text_head-societat,
      'Codi expedient'(h02)   ls_exp_cont-z_codi_exp ls_exp_cont-z_descrip_abr ,
      'Número plec'(h03)      ls_exp_cont-z_num_plec ls_text_head-z_num_plec.
    LOOP AT info_formula INTO info_formula_s.
      _row: 'Fórmula valoració econòmica'(h04) info_formula_s-z_codi_crit_punt info_formula_s-z_txt_formula.
    ENDLOOP.
    _row:'Model criteris puntuació'(h05)    ls_plec-z_mod_crit_punt ls_text_plec-z_mod_crit_punt .

    IF    my_mode EQ co_mode_adj_2nd
       OR my_mode EQ co_mode_punct_2nd .
      _row: 'Model criteris proposta gràfica'(h06)    ls_plec-z_mod_crit_prop ls_text_plec-z_mod_crit_prop .
    ENDIF .

  ENDIF.

  my_dd_document->merge_document( ) .

  my_splitter->set_row_mode( my_splitter->mode_absolute ) .

  l_row_count = l_row_count * 20 .


*>> Ini  SPEC-54695  - ETMAE
  IF MY_MODE = zrm_cl_valoracio_ofertes=>CO_MODE_MILLOR_CLASSIF.
    l_row_count = l_row_count + 10 . " incrementar el alto de la cabecera
  ENDIF.
*<< Fi  SPEC-54695  - ETMAE


  my_splitter->set_row_height( id = 1 height = l_row_count ) .

  l_container = my_splitter->get_container( row = 1 column = 1 ) .


  CALL METHOD my_dd_document->display_document
    EXPORTING
      parent = l_container.



ENDMETHOD.


METHOD build_matrix.
  DATA: lr_struc     TYPE REF TO cl_abap_structdescr,
        lr_table     TYPE REF TO cl_abap_tabledescr,
        lr_data      TYPE REF TO cl_abap_datadescr,
        ls_row       TYPE ty_s_row,
*        l_punts      TYPE zrm_dt_punt_ofer-z_punts,
        l_punts(40),
        ls_column    TYPE ty_s_column,
        lt_component TYPE cl_abap_structdescr=>component_table,
        ls_component TYPE LINE OF cl_abap_structdescr=>component_table.

* Creem estructura amb tantes columnes de tipus Z_PUNTS com s'ens indica
  CLEAR ls_component .
  lr_data     ?= cl_abap_datadescr=>describe_by_data( l_punts ) .
  LOOP AT ch_columns INTO ls_column .
    ls_column-colpos = sy-tabix .
    ls_component-name = ls_column-fieldname .
    ls_component-type = lr_data .
    APPEND ls_component TO lt_component .
    MODIFY ch_columns FROM ls_column TRANSPORTING colpos .
  ENDLOOP .

  CHECK lt_component[] IS NOT INITIAL.
  CLEAR ls_component .
  ls_component-name       = '_PUNTS_' .
  ls_component-type       = cl_abap_structdescr=>create( lt_component ) .
  ls_component-as_include = 'X' .
  REFRESH lt_component .
  APPEND ls_component TO lt_component .

  CLEAR ls_component .
  ls_component-name        = '_CONTROL_' .
  ls_component-type       ?= cl_abap_structdescr=>describe_by_data( ls_row ) .
  ls_component-as_include  = 'X' .
  ls_component-suffix      = '' .
  INSERT ls_component INTO lt_component INDEX 1 .

  lr_struc = cl_abap_structdescr=>create( lt_component ) .
  lr_table = cl_abap_tabledescr=>create( p_line_type = lr_struc
                                         p_table_kind = cl_abap_tabledescr=>tablekind_std ) .

  CREATE DATA ex_line_ref TYPE HANDLE lr_struc .
  CREATE DATA ex_table_ref TYPE HANDLE lr_table .

ENDMETHOD.


METHOD check_2_round_sequence.
  DATA: l_1st_phase     TYPE zrm_cl_valoracio_ofertes=>ty_s_phase,
        l_2nd_phase     TYPE zrm_cl_valoracio_ofertes=>ty_s_phase,
        l_adj_phase     TYPE zrm_cl_valoracio_ofertes=>ty_s_phase,
        l_count_lema    TYPE i,
        l_count_2round  TYPE i.

  CALL METHOD my_backend->get_2_round_phase
    IMPORTING
      ex_punctuate_offer  = l_1st_phase
      ex_punctuate_lema   = l_2nd_phase
      ex_set_awardee      = l_adj_phase
      ex_lemes_count      = l_count_lema
      ex_2nd_round_offers = l_count_2round.

  CASE my_mode .
    WHEN co_mode_punct_1st
      OR co_mode_punct_tec.
      IF l_2nd_phase-done     IS NOT INITIAL .
        MESSAGE i064 WITH text-t02 .
      ELSEIF l_adj_phase-done IS NOT INITIAL .
        MESSAGE i064 WITH text-t03 .
      ENDIF .

    WHEN co_mode_punct_2nd .
      IF l_adj_phase-done IS NOT INITIAL .
        MESSAGE i064 WITH text-t03 .
      ELSEIF l_1st_phase-done IS INITIAL .
        RAISE EXCEPTION TYPE zcx_rm_valoracio
          EXPORTING textid = zcx_rm_valoracio=>not_confirmed_1st_yet .
      ELSEIF l_count_2round IS INITIAL .
        RAISE EXCEPTION TYPE zcx_rm_valoracio
          EXPORTING
             textid = zcx_rm_valoracio=>no_offers_for_2nd_round .
      ELSEIF l_count_lema IS INITIAL .
        RAISE EXCEPTION TYPE zcx_rm_valoracio
          EXPORTING
             textid = zcx_rm_valoracio=>no_lemes.
      ENDIF .
      IF l_count_lema NE l_count_2round .
        MESSAGE i068 DISPLAY LIKE 'W'.
      ENDIF .


    WHEN co_mode_adj_2nd .
      IF     l_1st_phase-done IS INITIAL .
        RAISE EXCEPTION TYPE zcx_rm_valoracio
          EXPORTING textid = zcx_rm_valoracio=>not_confirmed_1st_yet .
      ELSEIF l_2nd_phase-done IS INITIAL .
        RAISE EXCEPTION TYPE zcx_rm_valoracio
          EXPORTING textid = zcx_rm_valoracio=>not_confirmed_2nd_yet .
      ENDIF .

  ENDCASE .

ENDMETHOD.


METHOD check_consistency.
  DATA: l_answer TYPE c .

  CLEAR re_read_only .
  IF    im_consistency-model_has_changed IS NOT INITIAL
     OR im_consistency-new_criteria      IS NOT INITIAL
     OR im_consistency-deleted_criteria  IS NOT INITIAL .
    CALL FUNCTION 'POPUP_TO_CONFIRM'
      EXPORTING
        titlebar              = text-003
        diagnose_object       = 'ZRM_VALORACIO_01'
        text_question         = 'Què desitja fer?'(q01)
        text_button_1         = 'Visualitzar'(004)
        icon_button_1         = 'ICON_DISPLAY'
        text_button_2         = 'Puntuar'(005)
        icon_button_2         = 'ICON_CALCULATION'
        default_button        = '1'
        display_cancel_button = 'X'
        popup_type            = 'ICON_MESSAGE_CRITICAL'
      IMPORTING
        answer                = l_answer.
    CASE l_answer .
      WHEN '1' . re_read_only = 'X' .
      WHEN '2' . re_read_only = space .
      WHEN 'A' .
        RAISE EXCEPTION TYPE zcx_rm_valoracio
          EXPORTING
            textid = zcx_rm_valoracio=>cancelled_by_user.
    ENDCASE .
    ">>>SPEC-55535, Inici modificació  - ETODR
  ELSEIF im_consistency-imin_has_changed IS NOT INITIAL.
    MESSAGE 'Atenció s''ha modificat el valor de IMIN i, per tant, cal verificar de nou les puntuacions' TYPE 'I'.
    "<<<SPEC-55535, Final modificació - ETODR
  ELSE .
    RETURN .
  ENDIF .
ENDMETHOD.


METHOD check_punt_tec_seq.

    IF my_backend->check_punt_tec_seq( ) IS INITIAL.
      MESSAGE i064 WITH text-t03 .
    ENDIF.

ENDMETHOD.


method CHECK_SOL_PART_SEQ.
   IF my_backend->check_sol_part( ) IS INITIAL.
    MESSAGE i064 WITH text-t04 .
  ENDIF.
endmethod.


METHOD check_temeritats.
  DATA: lt_ofertax  TYPE zrm_cl_valoracio_ofertes=>ty_t_ofertax,
        ls_exp_cont TYPE zrm_dt_exp_cont,
        l_answer    TYPE c,
        l_question  TYPE char100.
  FIELD-SYMBOLS: <ls_ofertax> LIKE LINE OF lt_ofertax .

  ls_exp_cont = my_backend->get_header( ) .
  lt_ofertax = my_backend->get_offers( ) .

  LOOP AT lt_ofertax ASSIGNING <ls_ofertax> WHERE z_temerari IS INITIAL .
    IF ls_exp_cont-z_req_homog IS INITIAL .
      IF <ls_ofertax>-z_presump_temer IS NOT INITIAL AND <ls_ofertax>-z_codi_com_temer NE '03'.  " SPEC-48559 ETJMD 13.06.2018
        l_question = text-q10 .
        EXIT .
      ENDIF .
    ELSE .
      IF <ls_ofertax>-z_pres_tem_homog IS NOT INITIAL .
        l_question = text-q11 .
        EXIT .
      ENDIF .
    ENDIF .
  ENDLOOP .

  CHECK l_question IS NOT INITIAL .
  CALL FUNCTION 'POPUP_TO_CONFIRM'
    EXPORTING
      titlebar              = text-000
      text_question         = l_question
      default_button        = '1'
      display_cancel_button = ' '
    IMPORTING
      answer                = l_answer.
  IF l_answer NE '1' .
    RAISE EXCEPTION TYPE zcx_rm_valoracio
      EXPORTING
        textid = zcx_rm_valoracio=>cancelled_by_user.
  ENDIF .



ENDMETHOD.


METHOD close.
  my_backend->close( ) .
  IF my_navigation_box IS BOUND .
    my_navigation_box->free( ) .
  ENDIF .
  CLEAR: my_grid,
         my_line_ref,
         my_table_ref,
         my_splitter,
         my_dd_document .
ENDMETHOD.


  METHOD comprovacio_arquitectes.
    "SPEC-65852
    CONSTANTS: lc_repid       TYPE repid VALUE 'EMPRESA_ARQUITECTE_CHECK',
               lc_field_info1 TYPE zsap_de_field VALUE 'Z_SUBTIPUS_CONT',
               lc_field_info2 TYPE zsap_de_field VALUE 'Z_CARREC'.
    DATA: lv_z_subtipus_cont  TYPE zrm_dt_exp_cont-z_subtipus_cont,
          lv_value            TYPE zsap_dt_param_hc-value,
          lt_zsap_dt_param_hc TYPE TABLE OF zsap_dt_param_hc,
          ls_zsap_dt_param_hc TYPE zsap_dt_param_hc,
          lt_zrm_dt_carrecs   TYPE TABLE OF zrm_dt_carrecs,
          ls_zrm_dt_carrecs   TYPE zrm_dt_carrecs.

    "1. Consulta taula zrm_dt_exp_cont, camp z_subtipus_cont
    SELECT SINGLE z_subtipus_cont
       FROM zrm_dt_exp_cont
       INTO lv_z_subtipus_cont
       WHERE docclass     = iv_docclass
         AND objectid     = iv_objectid.

    SELECT * FROM zrm_dt_carrecs INTO TABLE lt_zrm_dt_carrecs
      WHERE docclass = iv_docclass
       AND objectid = iv_objectid
       AND z_num_ofer = im_num_ofer. "ETODR

    "2. Consulta taula ZSAP_DT_PARAM_HC amb el REPID = 'EMPRESA_ARQUITECTE_CHECK'
    " i el FIELD_INFO = Z_SUBTIPUS_CONT obtingut al punt 1.
    SELECT SINGLE value
     FROM zsap_dt_param_hc
     INTO lv_value
     WHERE repid     EQ lc_repid
      AND field_info EQ lc_field_info1
      AND value EQ lv_z_subtipus_cont.

    " Si es troba el registre,  farem la validació següent.
    IF sy-subrc = 0.
      "3. Consulta taula ZSAP_DT_PARAM_HC on recuperarem tots els càrrecs
      "que compleixin REPID = EMPRESA_ARQUITECTE_CHECK  i FIELD_INFO = Z_CARREC.
      SELECT * FROM zsap_dt_param_hc INTO TABLE lt_zsap_dt_param_hc
        WHERE repid     EQ lc_repid
         AND field_info EQ lc_field_info2.
      "Per cada registre trobat, consulta taula ZRM_DT_CARRECS accedint per
      "GV_DOCCLASS i GV_OBJECTID.
      "Si no en trobem cap, retornar false
      ov_resultat = abap_false.

      LOOP AT lt_zsap_dt_param_hc INTO ls_zsap_dt_param_hc.
        "Si trobem almenys 1 càrrec que esta a taula ZSAP_DT_PARAM_HC, retornar true
        READ TABLE lt_zrm_dt_carrecs INTO ls_zrm_dt_carrecs
        WITH KEY z_carrec = ls_zsap_dt_param_hc-value.
        IF sy-subrc = 0.
          ov_resultat = abap_true.
          EXIT.
        ENDIF.
      ENDLOOP.

    ELSE.
      ov_resultat = abap_true.
    ENDIF.

  ENDMETHOD.


METHOD confirm.
  DATA: l_answer       TYPE c,
        lcx            TYPE REF TO zcx_rm_valoracio,
        l_all_excluded TYPE xfeld,
        l_question     TYPE text100,
        l_changed      TYPE xfeld,
        lv_titlebar    TYPE text100 . " SPEC-54695

  lv_titlebar = text-006. " SPEC-54695  'Adjudicació provisional' (Titulo por defecto)

  CASE my_mode .
    WHEN co_mode_1_round OR co_mode_punct_1st.
      IF my_submode <> co_submode_rd817_2009.
        my_backend->get_technical_exclusion( IMPORTING ex_all_excluded = l_all_excluded ) .
        IF l_all_excluded IS INITIAL .
          l_question = 'Realment desitja confirmar la puntuació d''ofertes?'(q02) .
        ELSE .
          l_question = 'Totes les ofertes passaran a estar excloses per puntuació tècnica. Realment desitja confirmar?'(q12) .
        ENDIF .
      ELSE.
        l_question = 'Realment desitja confirmar la puntuació d''ofertes?'(q02) .
      ENDIF.
    WHEN co_mode_punct_2nd.
      l_question = 'Realment desitja confirmar la puntuació de lemes?'(q06) .
    WHEN co_mode_punct_tec .
      my_backend->get_technical_exclusion( IMPORTING ex_all_excluded = l_all_excluded ) .
      IF l_all_excluded IS INITIAL .
        l_question = 'Realment desitja confirmar la puntuació d''ofertes?'(q02) .
      ELSE .
        l_question = 'Totes les ofertes passaran a estar excloses per puntuació tècnica. Realment desitja confirmar?'(q12) .
      ENDIF .
    WHEN co_mode_punt_sol_part.
*     <== EDLSM 15/06/2010
      my_backend->get_solv_tec_exclusion( EXPORTING im_columns = my_columns IMPORTING ex_all_excluded = l_all_excluded ) .
      IF l_all_excluded IS INITIAL .
        l_question = 'Realment desitja confirmar la puntuació de les sol·licituds de participants?'(q13).
      ELSE .
        l_question = 'Totes les ofertes passaran a estar excloses per solvència tècnica. Realment desitja confirmar?'(q15) .
      ENDIF .
*     ==> EDLSM
**  >> INI MODIF ETODR SPEC-49075
    WHEN  zrm_cl_valoracio_ofertes=>co_mode_punt_quadre2b.
      my_backend->get_technical_exclusion( IMPORTING ex_all_excluded = l_all_excluded ) .
      IF l_all_excluded IS INITIAL .
        l_question = 'Realment desitja confirmar la puntuació d''ofertes?'(q02) .
      ELSE .
        l_question = 'Totes les ofertes passaran a estar excloses per puntuació tècnica. Realment desitja confirmar?'(q12) .
      ENDIF .
    WHEN  zrm_cl_valoracio_ofertes=>co_mode_punt_quadre3b.
      l_question = 'Realment desitja confirmar la puntuació d''ofertes?'(q02) .
      " >>>PSPEC-1451 Inici modificació - EVXGL
    WHEN  zrm_cl_valoracio_ofertes=>co_mode_val_cap_obra.
      l_question = 'Realment desitja confirmar la puntuació?'(q19) .
      lv_titlebar = text-t12.
      " <<<PSPEC-1451 Fi modificació - EVXGL
    WHEN  zrm_cl_valoracio_ofertes=>co_mode_punt_quadre4b.
      my_backend->get_technical_exclusion( IMPORTING ex_all_excluded = l_all_excluded ) .
      IF l_all_excluded IS INITIAL .
        l_question = 'Realment desitja confirmar la puntuació d''ofertes?'(q02) .
      ELSE .
        l_question = 'Totes les ofertes passaran a estar excloses per puntuació tècnica. Realment desitja confirmar?'(q12) .
      ENDIF .
**  << FI MODIF ETODR SPEC-49075

*>> Ini  SPEC-54695  - ETMAE
    WHEN  zrm_cl_valoracio_ofertes=>co_mode_millor_classif.
      my_backend->get_technical_exclusion( IMPORTING ex_all_excluded = l_all_excluded ) .
      IF l_all_excluded IS INITIAL .
        l_question = 'Realment desitja confirmar la puntuació d''ofertes?'(q02) .
      ELSE .
        l_question = 'Totes les ofertes passaran a estar excloses per puntuació tècnica. Realment desitja confirmar?'(q12) .
      ENDIF .
      lv_titlebar = text-t08. " Oferta millor classificada
*<< Fi  SPEC-54695  - ETMAE

    WHEN OTHERS .
      MESSAGE 'Acció no rellevant!'(e00) TYPE 'I' DISPLAY LIKE 'E' .
      RETURN .
  ENDCASE .

  CALL FUNCTION 'POPUP_TO_CONFIRM'
    EXPORTING
      titlebar              = lv_titlebar  " spec-54695  text-006
      text_question         = l_question
      icon_button_1         = 'ICON_SYSTEM_OKAY'
      default_button        = '1'
      display_cancel_button = ' '
    IMPORTING
      answer                = l_answer.

** INI SPEC-80664 ECAGM 23.11.2023
  IF l_answer EQ '2' .
    refresh_table_display( ) .
  ENDIF.
** END SPEC-80664 ECAGM 23.11.2023
  CHECK l_answer EQ '1' .

  TRY.
      CASE my_mode .
        WHEN co_mode_punct_tec.
          my_backend->confirm_punt_tec_offers( IMPORTING ex_punctuation_changed = l_changed ) .
        WHEN co_mode_1_round OR co_mode_punct_1st .
          my_backend->confirm_punt_offers( IMPORTING ex_punctuation_changed = l_changed ) .
        WHEN co_mode_punct_2nd.
          my_backend->confirm_punt_lemes(  ) .
        WHEN co_mode_punt_sol_part.
          my_backend->confirm_punt_sol_part( IMPORTING ex_punctuation_changed = l_changed ) .
**  >> INI MODIF ETODR SPEC-49075
        WHEN zrm_cl_valoracio_ofertes=>co_mode_punt_quadre2b.
          my_backend->confirm_punt_q2b( IMPORTING ex_punctuation_changed = l_changed ).
        WHEN  zrm_cl_valoracio_ofertes=>co_mode_punt_quadre3b.
          my_backend->confirm_punt_q3b( IMPORTING ex_punctuation_changed = l_changed ).
          " >>>PSPEC-1451 Inici modificació - EVXGL
        WHEN  zrm_cl_valoracio_ofertes=>co_mode_val_cap_obra.
          my_backend->confirm_punt_verif_cap_obra( IMPORTING ex_punctuation_changed = l_changed ).
          " <<<PSPEC-1451 Fi modificació - EVXGL
        WHEN  zrm_cl_valoracio_ofertes=>co_mode_punt_quadre4b.
          my_backend->confirm_punt_q4b( IMPORTING ex_punctuation_changed = l_changed ).
**  << FI MODIF ETODR SPEC-49075

*>> Ini  SPEC-54695  - ETMAE
        WHEN  zrm_cl_valoracio_ofertes=>co_mode_millor_classif.
          my_backend->confirm_millor_clas( IMPORTING ex_punctuation_changed = l_changed ).
*<< Fi  SPEC-54695  - ETMAE
      ENDCASE .
      my_backend->set_save_log_pt( abap_on ). " INI MODIF ETODR SPEC-40749
      me->save( ) .
      prepare_data( ) .

    CATCH zcx_rm_valoracio INTO lcx .
      MESSAGE lcx TYPE 'I' DISPLAY LIKE 'E' .
      RETURN .
  ENDTRY .

  refresh_table_display( ) .
  IF l_changed IS NOT INITIAL .
    MESSAGE i044(zrm_valoracio) .
  ENDIF .

ENDMETHOD.


METHOD confirm_data_loss.

  CALL FUNCTION 'POPUP_TO_CONFIRM'
    EXPORTING
      titlebar       = text-000
      text_question  = text-002
      default_button = '1'
      popup_type     = 'ICON_MESSAGE_WARNING'
    IMPORTING
      answer         = re_answer.

ENDMETHOD.


METHOD confirm_not_awarded.

  CALL FUNCTION 'POPUP_TO_CONFIRM'
    EXPORTING
      titlebar              = text-006
      text_question         = text-007
      display_cancel_button = space
      default_button        = '2'
      popup_type            = 'ICON_MESSAGE_WARNING'
    IMPORTING
      answer                = re_answer.

ENDMETHOD.


METHOD constructor.

  CONSTANTS: lc_repid      TYPE repid VALUE 'ZRM_CL_VALORACIO_OFERTES_FE',
             lc_field_info TYPE zsap_de_field VALUE 'MAXLOOPS'.


  DATA: ls_exp_cont TYPE zrm_dt_exp_cont.

  CREATE OBJECT my_backend
    EXPORTING
      im_docclass = docclass
      im_objectid = objectid
      im_action   = action
      is_dynamic  = is_dynamic.

  gv_docclass = docclass.
  gv_objectid = objectid.

  SELECT SINGLE * FROM zrm_dt_exp_cont INTO ls_exp_cont
    WHERE docclass = docclass AND
          objectid = objectid .

  gv_subtipus = ls_exp_cont-z_subtipus_cont.

** >> INI SPEC-45341 ETETM - Usamos atributo global para poder acceder a los datos de cabecera del
**    expediente desde otros métodos.
  gs_exp_cont    = ls_exp_cont.
** << FI SPEC-45341

  IF ls_exp_cont-z_rd817_2009 IS NOT INITIAL.
    my_submode = co_submode_rd817_2009.
  ENDIF.

  ">>>SPEC:56622, Inici modificació  - ECFA
  "Extraiem el nombre màxim de vegades que podem fer click a valoració d'ofertes
  SELECT SINGLE value
   FROM zsap_dt_param_hc
   INTO gv_maxpools
   WHERE repid      EQ lc_repid
     AND field_info EQ lc_field_info.
  "<<<SPEC:56622, Final modificació - ECFA

  my_mode   = action .
  CASE my_mode .
    WHEN co_mode_1_round . "Licitacions una única fase
      IF my_submode <> co_submode_rd817_2009.

        my_backend_activities-save_punct    = my_backend->co_act_punct_1st .
        my_backend_activities-confirm_punct = my_backend->co_act_confirm_1st .
        my_backend_activities-set_awarded   = my_backend->co_act_awardee .
        my_backend_activities-unconfirm     = my_backend->co_act_unconfirm_1st .

      ELSE.
        my_backend_activities-confirm_punct = my_backend->co_act_confirm_1st .
        my_backend_activities-set_awarded   = my_backend->co_act_awardee .
        my_backend_activities-unconfirm     = my_backend->co_act_unconfirm_1st .
      ENDIF.

    WHEN co_mode_punct_1st . "Doble volta: puntuació d'ofertes
      IF my_submode <> co_submode_rd817_2009.
        my_backend_activities-save_punct    = my_backend->co_act_punct_1st .
        my_backend_activities-confirm_punct = my_backend->co_act_confirm_1st .
        my_backend_activities-unconfirm     = my_backend->co_act_unconfirm_1st .

      ELSE.
        my_backend_activities-confirm_punct = my_backend->co_act_confirm_1st .
        my_backend_activities-unconfirm     = my_backend->co_act_unconfirm_1st .
      ENDIF.

    WHEN co_mode_punct_2nd . "Doble volta: puntuació de lemes
      my_backend_activities-save_punct    = my_backend->co_act_punct_2nd .
      my_backend_activities-confirm_punct = my_backend->co_act_confirm_2nd .
      my_backend_activities-unconfirm     = my_backend->co_act_unconfirm_2nd .

    WHEN co_mode_adj_2nd .   "Doble volta: adjudicació
      my_backend_activities-set_awarded   = my_backend->co_act_awardee .
      my_backend_activities-unconfirm     = my_backend->co_act_unconfirm_adj .

    WHEN co_mode_punct_tec .  " Puntuació tècnica Reial Decret
      my_backend_activities-save_punct    = my_backend->co_act_punct_1st .
      my_backend_activities-confirm_punct = my_backend->co_act_confirm_1st .
      my_backend_activities-unconfirm     = my_backend->co_act_unconfirm_1st .

    WHEN co_mode_punt_sol_part .
* EDCPC Criteris per la sol·lictud de participants
      my_backend_activities-save_punct    = my_backend->co_act_punct_sp .
      my_backend_activities-confirm_punct = my_backend->co_act_confirm_sp .
      my_backend_activities-unconfirm     = my_backend->co_act_unconfirm_sp .
    WHEN co_mode_neg_f2. "P100031 - ETRCM
      my_backend_activities-set_awarded   = my_backend->co_act_awardee .
      my_backend_activities-unconfirm     = my_backend->co_act_unconfirm_adj .

**  >> INI MODIF ETODR SPEC-49075
    WHEN zrm_cl_valoracio_ofertes=>co_mode_punt_quadre2b. "Puntuació Criteris Tècnics Judici de Valor
      my_backend_activities-save_punct    = my_backend->co_act_punct_1st .
      my_backend_activities-confirm_punct = my_backend->co_act_confirm_1st .
      my_backend_activities-unconfirm     = my_backend->co_act_unconfirm_1st .

    WHEN zrm_cl_valoracio_ofertes=>co_mode_punt_quadre3b. "Puntuació Criteris Tècnics Objectius
      my_backend_activities-save_punct    = my_backend->co_act_punct_1st .
      my_backend_activities-confirm_punct = my_backend->co_act_confirm_q3b .
      my_backend_activities-unconfirm     = my_backend->co_act_unconfirm_q3b .

      " >>>PSPEC-1451 Inici modificació - EVXGL
    WHEN zrm_cl_valoracio_ofertes=>co_mode_val_cap_obra. "Validació Cap d'Obra
      my_backend_activities-save_punct    = my_backend->co_act_punct_1st .
      my_backend_activities-confirm_punct = my_backend->co_act_confirm_cap_obra .
      my_backend_activities-unconfirm     = my_backend->co_act_unconfirm_cap_obra.
      " <<<PSPEC-1451 Fi modificació - EVXGL

    WHEN zrm_cl_valoracio_ofertes=>co_mode_punt_quadre4b. "Puntuació Proposta Adjudicació
      my_backend_activities-confirm_punct = my_backend->co_act_confirm_1st .
      my_backend_activities-set_awarded   = my_backend->co_act_awardee .
      my_backend_activities-unconfirm     = my_backend->co_act_unconfirm_1st .
**  << FI MODIF ETODR SPEC-49075

*>> Ini  SPEC-54695  - ETMAE
    WHEN zrm_cl_valoracio_ofertes=>co_mode_millor_classif. " Of. millor classif. (Solvència)
      my_backend_activities-confirm_punct   = my_backend->co_act_confirm_1st .
      my_backend_activities-set_millor_cla  = my_backend->co_act_best_classified .
      my_backend_activities-unconfirm       = my_backend->co_act_unconfirm_1st .
*<< Fi  SPEC-54695  - ETMAE

**  >> INI MODIF ETODR SPEC-61754
    WHEN zrm_cl_valoracio_ofertes=>co_mode_punt_formulari.
**  << FI MODIF ETODR SPEC-61754

    WHEN OTHERS.
      RAISE EXCEPTION TYPE zcx_rm_valoracio.

  ENDCASE .

ENDMETHOD.


METHOD create_catalog.
  DATA: ls_column LIKE LINE OF im_columns,
        ls_fcat   TYPE lvc_s_fcat.

  CLEAR ls_fcat .
  ls_fcat-fieldname = 'Z_CODI_CRIT_PUNT' .
  ls_fcat-ref_table = 'ZRM_DM_CRIT_PUNT'.
  ls_fcat-key       = 'X' .
  ls_fcat-col_pos   = 1.
  ls_fcat-just      = 'R' .
  ls_fcat-outputlen = '9' .
  APPEND ls_fcat TO ex_fcat .

  CLEAR ls_fcat .
  ls_fcat-fieldname = 'Z_DESCRIPCIO' .
  ls_fcat-ref_table = 'ZRM_DM_CRIT_PUNT'.
  ls_fcat-col_pos   = 2.
  ls_fcat-key       = 'X' .
  ls_fcat-outputlen = '30' .
  APPEND ls_fcat TO ex_fcat .

  CLEAR ls_fcat .
  ls_fcat-fieldname = 'Z_RANG' .
  ls_fcat-seltext   = 'Rang de puntuació'(cs0) .
  ls_fcat-reptext   = 'Rang puntuació'(cs1) .
  ls_fcat-scrtext_l = 'Rang puntuació'(cs1) .
  ls_fcat-scrtext_m = 'Rang puntuació'(cs1) .
  ls_fcat-scrtext_s = 'Rang'(cs2) .
  ls_fcat-key       = 'X' .
  ls_fcat-col_pos   = 3.
  ls_fcat-outputlen = '18' .
  APPEND ls_fcat TO ex_fcat .

  LOOP AT im_columns INTO ls_column .
    CLEAR ls_fcat .
    ls_fcat-col_pos    = co_fixed_cols_left + sy-tabix .
    ls_fcat-no_sum     = 'X' .
    ls_fcat-outputlen  = '9' .
    ls_fcat-fieldname = ls_column-fieldname .
*    IF sy-tabix EQ 2.
*    ls_fcat-hotspot   = abap_true.
*    ls_fcat-ref_field = 'Z_PUNTS'.
*    ENDIF.
    ls_fcat-intlen  = '40' .
    ls_fcat-inttype = 'C' .
    ls_fcat-just    = 'R' .
    ls_fcat-lowercase = 'X' .
*    ls_fcat-ref_field = 'Z_PUNTS' .
*    ls_fcat-ref_table = 'ZRM_DT_PUNT_OFER' .

    " Botó Aportacions i mesures
    IF sy-tabix = 2.
      ls_fcat-hotspot = abap_true.
      ls_fcat-pushbutton = abap_true.
      ls_fcat-text = 'Aportacions i mesures'.
    ENDIF.
    ls_fcat-seltext   = ls_column-header .
    ls_fcat-reptext   = ls_column-header .
    ls_fcat-scrtext_l = ls_column-header .
    ls_fcat-scrtext_m = ls_column-header .
    ls_fcat-scrtext_s = ls_column-header .
    IF im_read_only IS INITIAL .
      ls_fcat-edit      = ls_column-editable.
    ENDIF .
    IF ls_column-editable IS INITIAL .
      ls_fcat-emphasize = 'C201'.
    ENDIF .

    APPEND ls_fcat TO ex_fcat .
  ENDLOOP.
** >> INI MODIF ETODR SPEC-49500
  CLEAR ls_fcat .
  DESCRIBE TABLE im_columns LINES DATA(l_num_cols).
  ls_fcat-fieldname = 'Z_COMPTADOR_EQUIP' .
  ls_fcat-ref_table = 'ZRM_DT_PUNT_EQUI'.
  ls_fcat-key       = '' .
  DATA(lv_col_pos)  = l_num_cols + 1.
  ls_fcat-col_pos   = lv_col_pos.
  ls_fcat-just      = 'R' .
  ls_fcat-outputlen = '9' .
  ls_fcat-no_out    = abap_on .
  APPEND ls_fcat TO ex_fcat .
  CLEAR ls_fcat .
  ls_fcat-fieldname = 'Z_EXCLOURE_LICI' .
  ls_fcat-ref_table = 'ZRM_DM_CRIT_PUNT'.
  ls_fcat-key       = '' .
  ls_fcat-col_pos   = lv_col_pos + 1.
  ls_fcat-just      = 'R' .
  ls_fcat-outputlen = '1' .
  ls_fcat-no_out    = abap_on.
  APPEND ls_fcat TO ex_fcat .
  CLEAR ls_fcat .
** << FI MODIF ETODR SPEC-49500


ENDMETHOD.


METHOD create_document.
  DATA: ls_template     TYPE zrm_cl_gmd=>ty_s_document,
        l_dummy         TYPE c,
        lr_data         TYPE REF TO data,
        lt_oferta       TYPE zrm_tt_dt_ofertes,
        lt_lema         TYPE zrm_tt_dt_lemes,
        l_task_template TYPE z_tasca_gmd,
        l_task_document TYPE z_tasca_gmd,
        lr_document     TYPE REF TO zrm_cl_documents,
        lr_container    TYPE REF TO zrm_cl_container,
        lr_expedient    TYPE REF TO zrm_cl_expedients,
        lt_gmd_template TYPE zrm_gmd_task_template_tab,
        ls_gmd_template LIKE LINE OF lt_gmd_template,
        ls_exp_cont     TYPE zrm_dt_exp_cont,
        lcx_root        TYPE REF TO cx_root,
        l_doc_proxy     TYPE REF TO i_oi_document_proxy,
        l_doc_size      TYPE i,
        l_doc_table     TYPE TABLE OF bapiconten,
        l_gmd_task      TYPE REF TO zrm_cl_gmd_task.

***INI MOD ETJHG - SPEC-46407
  DATA: lv_local TYPE boolean VALUE abap_off.
***FIN MOD ETJHG - SPEC-46407

  IF  ( my_mode NE 'A' OR ( my_mode EQ 'A' AND my_submode NE co_submode_rd817_2009 ) ).
    IF my_backend->has_changed( ) IS NOT INITIAL .
      MESSAGE 'Cal desar els canvis abans de generar el document' TYPE 'I' .
      RETURN .
    ENDIF .
  ENDIF.

  CASE im_document_type .
    WHEN co_fc_create_q4_draft .
      l_task_template = zrm_cl_documents_excel=>co_quadre4 .
      l_task_document = zrm_cl_documents_excel=>co_quadre4_esborrany .

    WHEN co_fc_create_q4a_draft .
      l_task_template = zrm_cl_documents_excel=>co_quadre4a .
      l_task_document = zrm_cl_documents_excel=>co_quadre4a_esborrany .

    WHEN co_fc_create_q4b_draft .
      l_task_template = zrm_cl_documents_excel=>co_quadre4b .
      l_task_document = zrm_cl_documents_excel=>co_quadre4b_esborrany .

    WHEN co_fc_create_q4lem_draft .
      l_task_template = zrm_cl_documents_excel=>co_quadre4_lemes .
      l_task_document = zrm_cl_documents_excel=>co_quadre4_lemes_esborrany .

    WHEN co_fc_create_q4_int .
      l_task_template = zrm_cl_documents_excel=>co_quadre4 .
      l_task_document = zrm_cl_documents_excel=>co_quadre4_intern .
    WHEN co_fc_create_q2b_draft .
      l_task_template = zrm_cl_documents_excel=>co_quadre2b .
      l_task_document = zrm_cl_documents_excel=>co_quadre2b_esborrany .
*      l_task_template = zrm_cl_documents_excel=>co_quadre2b_esb_b ."ETOVB SPEC-38576 WF
    WHEN co_fc_create_q1b_draft .
      l_task_template = zrm_cl_documents_excel=>co_quadre1b .
      l_task_document = zrm_cl_documents_excel=>co_quadre1b_esborrany .
    WHEN co_puntuar.
*      CALL SCREEN '0200'.
**  >> INI MODIF ETODR SPEC-48364
    WHEN co_fc_create_inf_pt_def.
      "Posem plantilla per tal que es cridi a la classe Excel, on en el seu moment es va posar el codi de generar el PDF....no hase falta desir nada mas
      l_task_template = zrm_cl_documents_excel=>co_quadre2b .
      l_task_document = zrm_cl_documents_excel=>co_inf_pt_def .
**  >> INI MODIF ETODR SPEC-48364
**  >> INI MODIF ETODR SPEC-49075
    WHEN co_fc_create_q2b_92017.        " SPEC-49077 22.05.2018 ETJMD
      l_task_template = zrm_cl_documents_excel=>co_quadre2b_92017.
      l_task_document = zrm_cl_documents_excel=>co_quadre2b_esborrany_92017.
    WHEN co_fc_create_q3b_92017.
      l_task_template = zrm_cl_documents_excel=>co_quadre3b .
      l_task_document = zrm_cl_documents_excel=>co_quadre3b .
    WHEN co_fc_create_q4a_92017.
      l_task_template = zrm_cl_documents_excel=>co_quadre4a_92017.
      l_task_document = zrm_cl_documents_excel=>co_quadre4a_92017.
    WHEN co_fc_create_q4b_92017.
      l_task_template = zrm_cl_documents_excel=>co_quadre4b_92017.
      l_task_document = zrm_cl_documents_excel=>co_quadre4b_92017.
**  << FI MODIF ETODR SPEC-49075
    WHEN OTHERS.  RETURN .
  ENDCASE .


* Obtenim DOCCLASS i OBJECTID de la plantilla -----------------------------------------
  TRY .

      IF im_document_type = co_fc_create_q2b_draft OR im_document_type  = co_fc_create_q2b_92017.   " SPEC-49077 22.05.2018 ETJMD
        CALL METHOD my_backend->confirm_punt_tec_offers
          EXPORTING
            im_test    = 'X'
          IMPORTING
            ex_ofertes = lt_oferta.
      ELSEIF im_document_type = co_fc_create_q1b_draft.
        CALL METHOD my_backend->confirm_punt_sol_part
          EXPORTING
            im_test    = 'X'
          IMPORTING
            ex_ofertes = lt_oferta.
      ELSE.
        CALL METHOD my_backend->confirm_punt_offers
          EXPORTING
            im_test    = 'X'
          IMPORTING
            ex_ofertes = lt_oferta.

        CALL METHOD my_backend->confirm_punt_lemes
          EXPORTING
            im_test  = 'X'
          IMPORTING
            ex_lemes = lt_lema.
      ENDIF.

      ls_exp_cont = my_backend->get_header( ) .
      CREATE OBJECT l_gmd_task
        EXPORTING
          im_header_data = ls_exp_cont
          im_docclass    = ls_exp_cont-docclass
          im_objectid    = ls_exp_cont-objectid.

*** JGG SPEC-64927 -->
* Una vegada tenim la taula de licitació mirem si es de Sistema dinàmic i venim de la valoració (Q2B)
* canvien el tipus de l'anchor.
      IF im_document_type = co_fc_create_q3b_92017 AND ls_exp_cont-z_proc_adj = 'CE'.
        l_task_template = 'EC005'.
        l_task_document = 'EC005'.
      ENDIF.
*** JGG SPEC-64927 <--

* Volem la llista de plantilles de Q4 encara que no hi hagi adjudicatari
* i per això diem IM_CHECK_BEFORE_EXECUTE = space
      CALL METHOD l_gmd_task->get_task_templates
        EXPORTING
          im_task                 = l_task_template
          im_joint                = space
          im_check_before_execute = space
        RECEIVING
          re_template_list        = lt_gmd_template.

      IF lt_gmd_template IS INITIAL .
        MESSAGE i161(zrm_errors) .
        RETURN .
      ENDIF .

      READ TABLE lt_gmd_template INDEX 1 INTO ls_gmd_template .

*-- Obtenim la URL de la plantilla i el tipus de document associat ------------------
      ls_template-docclass = ls_gmd_template-docclass .
      ls_template-objectid = ls_gmd_template-objectid .

      CALL METHOD zrm_cl_gmd=>get_content_connection_documen
        EXPORTING
          im_objectid = ls_template-objectid
          im_docclass = ls_template-docclass
        RECEIVING
          re_document = ls_template-if_document.

      CALL METHOD zrm_cl_gmd=>get_url_and_mime
        CHANGING
          cs_document = ls_template.
      IF l_task_document <> zrm_cl_documents_excel=>co_inf_pt_def. "ETODR SPEC-48364
**>> INI MODIF ETODR SPEC-40749
        annexar_doc_a_exp( EXPORTING  i_exp_docclass   = ls_exp_cont-docclass
                                      i_exp_objectid   = ls_exp_cont-objectid
                                      is_gmd_template  = ls_gmd_template
                                      i_document_type  = im_document_type
                                      i_task_document  = l_task_document
                                      it_oferta        = lt_oferta
                                      it_lema          = lt_lema
***INI MOD ETJHG - SPEC-46407
  "En la variable lv_loal sabemos si a la hora de generar el cuadro es Local(X) o Expediente( )
                           IMPORTING
                                      local            = lv_local
***FIN MOD ETJHG - SPEC-46407
                           EXCEPTIONS not_found        = 1
                                      node_not_exists  = 2
                                      not_parametrized = 3 ).
        CASE sy-subrc.
          WHEN 0.
            "----------------------------------------------------------------
            "ECJSA - SPEC-51464 Afegir automàticament Societat/Exp relacionat
            "----------------------------------------------------------------
            "Si hi ha documents relacionats
            "...mirem si l'atribut dels documents està vuit.
            ".....si està vuit, li posem la societat de l'expedient.
            "...mirem si en els atributs hi ha l'expedient relacionat
            zcl_utils_docs=>completar_dades_doc_rel(
              EXPORTING
                iv_doclass  = ls_exp_cont-docclass
                iv_objectid = ls_exp_cont-objectid
            ).
            "----------------------------------------------------------------
            LEAVE TO SCREEN 0.
            RETURN.
          WHEN 1. "not_found
            MESSAGE text-e01 TYPE 'I'."'Error al annexar el document, torni-ho a provar'
            RETURN.
          WHEN 2. "node_not_exists
            MESSAGE text-e02 TYPE 'I'. "S''ha de sincronitzar l''expedient anbans d''annexar el quadre esborrany
            RETURN.
          WHEN OTHERS.
        ENDCASE.
**<< FI MODIF ETODR SPEC-40749
      ENDIF.
      create_doi_controls( ) .
      my_doi_container->set_visible( '' ) .
      CALL METHOD my_doi_control->get_document_proxy
        EXPORTING
          document_type  = ls_template-appl_type
        IMPORTING
          document_proxy = l_doc_proxy.
      zcx_rm_valoracio=>raise_from_doi_message( ) .

      lr_expedient ?= zrm_cl_expedients=>zif_rm_expedient~get_instance_by_key(
           im_docclass = ls_exp_cont-docclass
           im_objectid = ls_exp_cont-objectid ) .

      CREATE OBJECT lr_container
        EXPORTING
          im_expedient = lr_expedient.

      GET REFERENCE OF lt_oferta INTO lr_data .
      lr_container->replace_element( im_element   = 'OFERTES_ESP'
                                     im_reference = lr_data ) .

      GET REFERENCE OF lt_lema INTO lr_data .
      lr_container->replace_element( im_element   = 'LEMES_ESP'
                                     im_reference = lr_data ) .

      IF l_task_document <> zrm_cl_documents_excel=>co_inf_pt_def. "ETODR SPEC-48364 "com que estem generant un PDF no volem obrir cap instància de document
        CALL METHOD l_doc_proxy->open_document
          EXPORTING
            document_title = l_task_document
            document_url   = ls_template-url
*           open_inplace   = abap_off.  " ECJGG per fer proves posar ' ' sino sempre 'X'
            open_inplace   = 'X'.       " ECJGG per fer proves posar ' ' sino sempre 'X'
        zcx_rm_valoracio=>raise_from_doi_message( ) .
      ENDIF.

      CALL METHOD zrm_cl_documents=>get_instance
        EXPORTING
          im_control     = my_doi_control
          im_proxy       = l_doc_proxy
          im_template_id = space
          im_task        = l_task_document
        RECEIVING
          re_ref         = lr_document.

      ""En el caso que la variable lv_local sea ' ' se procesara Informe de Puntuacions Tècniques
      CALL METHOD lr_document->set_dynamic_data
        EXPORTING
          im_container         = lr_container
          im_valoracio_ofertes = my_backend
***INI MOD ETJHG - SPEC-46407
          local                = lv_local.
***FIN MOD ETJHG - SPEC-46407
      IF l_task_document <> zrm_cl_documents_excel=>co_inf_pt_def. "ETODR SPEC-48364
        CALL METHOD l_doc_proxy->save_document_to_table
          CHANGING
            document_size  = l_doc_size
            document_table = l_doc_table.
        zcx_rm_valoracio=>raise_from_doi_message( ) .

        CALL METHOD l_doc_proxy->close_document( ) .
        zcx_rm_valoracio=>raise_from_doi_message( ) .
        CALL METHOD l_doc_proxy->release_document( ).
        zcx_rm_valoracio=>raise_from_doi_message( ) .

        CALL METHOD l_doc_proxy->open_document_from_table
          EXPORTING
            document_size  = l_doc_size
            document_table = l_doc_table
            open_inplace   = ''.
        zcx_rm_valoracio=>raise_from_doi_message( ) .

        my_doi_container->set_visible( 'X' ) .
      ELSE.
        LEAVE TO SCREEN 0.
        RETURN.
      ENDIF.
    CATCH cx_srm
          zcx_rm_documents
          zcx_rm_expedient
          zcx_rm_valoracio INTO lcx_root.
      DATA: l_string TYPE string .
      l_string = lcx_root->get_text( ) .
      MESSAGE l_string TYPE 'I' .
      RETURN .
  ENDTRY .

ENDMETHOD.


METHOD create_doi_controls.
  DATA: lif_error TYPE REF TO i_oi_error .

  CHECK my_doi_control IS NOT BOUND .
  CREATE OBJECT my_doi_container
    EXPORTING
      container_name          = 'DOI_CONTAINER'
      lifetime                = cl_gui_custom_container=>lifetime_imode
      no_autodef_progid_dynnr = 'X' .

  CALL METHOD c_oi_container_control_creator=>get_container_control
    IMPORTING
      control = my_doi_control
      error   = lif_error.
  zcx_rm_valoracio=>raise_from_doi_message( lif_error ) .


  CALL METHOD my_doi_control->init_control
    EXPORTING
      r3_application_name      = text-t00
      inplace_enabled          = 'X'
      inplace_show_toolbars    = 'X'
      inplace_scroll_documents = 'X'
      inplace_resize_documents = 'X'
      register_on_close_event  = 'X'
      autoalign                = 'X'
      shell_style              = cl_gui_control=>ws_visible
      parent                   = my_doi_container
    IMPORTING
      error                    = lif_error.
  zcx_rm_valoracio=>raise_from_doi_message( lif_error ) .

  SET HANDLER on_close_document FOR ALL INSTANCES .

ENDMETHOD.


METHOD create_gui_controls.
  DATA: l_container TYPE REF TO cl_gui_container,
        l_total     TYPE i,
        ls_layo     TYPE lvc_s_layo,
        lv_ancla    TYPE srmxmlv.          " Insert EVXGL PSPEC-1451
  FIELD-SYMBOLS: <lt_data> TYPE STANDARD TABLE,
                 <ls_data> TYPE lvc_s_styl.

  ">>>SPEC:SPEC-66771, Inici modificació - ECJMS
  DATA: ls_cat TYPE lvc_s_fcat.
  DATA: lt_punt_gen  TYPE zrm_cl_valoracio_ofertes=>ty_t_punt_gen.
  DATA: lt_crit_punt TYPE zrm_cl_valoracio_ofertes=>ty_t_crit_punt.
  DATA: ls_crit_punt TYPE zrm_cl_valoracio_ofertes=>ty_s_crit_punt.
  "<<<SPEC:SPEC-66771, Final modificació - ECJMS

  CREATE OBJECT my_splitter
    EXPORTING
      parent  = im_container
      rows    = 2
      columns = 1.

  l_container = my_splitter->get_container( row = 2 column = 1 ) .
  CREATE OBJECT my_grid
    EXPORTING
      i_parent = l_container.

  CREATE OBJECT my_dd_document
    EXPORTING
      style = 'ALV_GRID'.

  build_header( ) .

  ASSIGN my_table_ref->* TO <lt_data> .


  " >>>SPSPEC-1451 Inici modificació - EVXGL
  GET PARAMETER ID 'ZRM_ANCHOR' FIELD lv_ancla.
  IF lv_ancla  = 'VAL_CAP_OB'.        " Verificació Cap d'Obra
    my_mode = 'R'.
  ENDIF.
  " <<<SPEC-1451 Fi modificació - EVXGL

  ls_layo-smalltitle  = 'X' .
  CASE my_mode .
    WHEN co_mode_1_round .     ls_layo-grid_title  = 'Puntuació de les ofertes'(t01) .
    WHEN co_mode_adj_2nd
      OR co_mode_neg_f2.     "P100031 ADD ETRCM
                               ls_layo-grid_title  = 'Adjudicació provisional'(t03) .
    WHEN co_mode_punct_1st .   ls_layo-grid_title  = 'Puntuació de les ofertes'(t01) .
    WHEN co_mode_punct_2nd .   ls_layo-grid_title  = 'Puntuació de les propostes gràfiques'(t02) .
    WHEN co_mode_punct_tec .   ls_layo-grid_title  = 'Valoració de puntuació tècnica'(t04).
    WHEN co_mode_punt_sol_part.ls_layo-grid_title  = 'Puntuació sol·licitud de participació'(t05).
**  >> INI MODIF ETODR SPEC-49075
    WHEN zrm_cl_valoracio_ofertes=>co_mode_punt_quadre2b. ls_layo-grid_title  = 'Valoració criteris tècnics subjectes a judici de valor'(t07).
    WHEN zrm_cl_valoracio_ofertes=>co_mode_punt_quadre3b. ls_layo-grid_title  = 'Valoració criteris tècnics objectius'(t06) .
    WHEN zrm_cl_valoracio_ofertes=>co_mode_val_cap_obra.  ls_layo-grid_title  = 'Verificació Cap d''Obra'(t12) .     " Insert EVXGL PSPEC-1451
    WHEN zrm_cl_valoracio_ofertes=>co_mode_punt_quadre4b. ls_layo-grid_title  = 'Puntuació de les ofertes'(t01) .
**  << FI MODIF ETODR SPEC-49075
*>> Ini  SPEC-54695  - ETMAE
    WHEN zrm_cl_valoracio_ofertes=>co_mode_millor_classif. ls_layo-grid_title  = 'Puntuació de les ofertes'(t01) .
*<< Fi  SPEC-54695  - ETMAE
    WHEN OTHERS .              ls_layo-grid_title  = space .
  ENDCASE .

  ls_layo-stylefname  = 'STYLE' .
  ls_layo-no_rowmark  = 'X' .
* ls_layo-no_toolbar  = 'X' .
  ls_layo-no_totline  = ' ' .
  ls_layo-detailinit  = 'X' .
  ls_layo-totals_bef  = ' ' .
  ls_layo-no_rowmove  = 'X' .
  ls_layo-no_rowins   = 'X' .
  ls_layo-info_fname  = 'ROW_COLOR' .
  ls_layo-ctab_fname  = 'CELL_COLOR' .

  ">>>SPEC:SPEC-66771, Inici modificació - ECJMS
  "Al final es fa al mètode populate_matrix (per al SPEC-69341)
*  CALL METHOD get_data
*    EXPORTING
*      im_from_db   = my_read_only
*    IMPORTING
*      ex_punt_gen  = lt_punt_gen
*      ex_crit_punt = lt_crit_punt.

*  LOOP AT lt_crit_punt INTO ls_crit_punt WHERE z_form_brctjv = abap_true.
*    CLEAR ls_cat-edit.
*    MODIFY my_fieldcat FROM ls_cat TRANSPORTING edit WHERE edit EQ abap_true.
*    EXIT.
*  ENDLOOP.


  "<<<SPEC:SPEC-66771, Final modificació - ECJMS

  CALL METHOD my_grid->set_table_for_first_display
    EXPORTING
      is_layout       = ls_layo
    CHANGING
      it_outtab       = <lt_data>
      it_fieldcatalog = my_fieldcat.

**>> INI MODIF ETODR SPEC-40749
*  my_grid->register_edit_event( cl_gui_alv_grid=>mc_evt_enter ) .
  my_grid->register_edit_event( cl_gui_alv_grid=>mc_evt_modified ) .
**<< FI MODIF ETODR SPEC-40749

*>> Atenció: hi un problema amb el delayed event: depenent de la velocitat amb la qual
* s'introdueixen les dades quan s'entra a una nova cel·la podria passar que s'esborressin
* les dades (entrar a cel·la, començar a escriure de seguida, esperar-se un estona i seguir
* escrivint). Aixó doncs no tenim més remei que inhabilidar l'event quan es poden editat
* les puntuacions.
*  READ TABLE my_fieldcat TRANSPORTING NO FIELDS WITH KEY edit = 'X'.
*  IF sy-subrc NE  0 .
*    my_grid->register_delayed_event( cl_gui_alv_grid=>mc_evt_delayed_move_curr_cell ) .
*  ENDIF .
*  my_grid->register_delayed_event( cl_gui_alv_grid=>mc_evt_delayed_move_curr_cell ) .

  SET HANDLER: me->on_data_changed          FOR my_grid,
               me->on_data_changed_finished FOR my_grid,
*               me->on_delayed_callback      FOR my_grid,
               me->on_toolbar               FOR my_grid,
               me->on_menu_button           FOR my_grid,
               me->on_user_command          FOR my_grid,
               me->before_user_command      FOR my_grid,
               me->after_user_command       FOR my_grid,
               me->on_button_click          FOR my_grid,
               me->on_hotspot_click         FOR my_grid,
               me->on_context_menu          FOR my_grid.
  my_grid->set_toolbar_interactive( ) .

  DESCRIBE TABLE my_columns LINES l_total .

  IF l_total GT co_max_cols_shown .
    MESSAGE i043 WITH l_total co_max_cols_shown.
  ENDIF .
ENDMETHOD.


  METHOD edit_motivacio.
    "GT_DADES_PUNT
    DATA: lt_dades_punt_aux   TYPE zrm_cl_valoracio_ofertes=>ty_t_puntuacio_subapartats,
          lt_dades_punt_aux_2 TYPE zrm_cl_valoracio_ofertes=>ty_t_puntuacio_subapartats, "SPEC-47727
          lr_sapscript        TYPE REF TO zrm_cl_sapscript_texts,
          ls_ref              TYPE tabfield,
          l_sec               TYPE z_sec,
          l_dummy_rec         TYPE z_compta_rec,
          wa_puntuacio        TYPE zrm_cl_valoracio_ofertes=>ty_s_puntuacio_subapartats,
          lv_codi_text        TYPE thead-tdname,
          l_num_ofer          TYPE z_num_ofer,
          l_create_entry      TYPE xfeld,
          l_criteri           TYPE z_codi_crit_punt,
          l_subapart          TYPE z_codi_subapar_punt,
          l_create_motivacio  TYPE xfeld,
          ls_exp_cont         TYPE zrm_dt_exp_cont.

    FIELD-SYMBOLS: <lt_grid>      TYPE STANDARD TABLE.

    SELECT SINGLE * FROM zrm_dt_exp_cont INTO ls_exp_cont
      WHERE docclass = gs_exp_cont-docclass AND
            objectid = gs_exp_cont-objectid .

    my_grid->get_current_cell( IMPORTING e_row     = DATA(lv_sel_row)
                                         es_col_id = DATA(lv_col_id) ).

    my_grid->get_selected_rows( IMPORTING et_row_no = DATA(lt_row) ).
    my_grid->get_selected_columns( IMPORTING et_index_columns = DATA(lt_column) ).

    ls_ref-tabname   = 'ZRM_DT_PUNT_OFER' .
    ls_ref-fieldname = 'Z_PUNTS' .
    ASSIGN my_table_ref->* TO <lt_grid>.
    READ TABLE <lt_grid> ASSIGNING FIELD-SYMBOL(<ls_grid>) INDEX lv_sel_row.
    IF sy-subrc = 0.

      ASSIGN COMPONENT lv_col_id OF STRUCTURE <ls_grid> TO FIELD-SYMBOL(<lv_punt>). "Recollir empresa
      CHECK sy-subrc = 0.
      ASSIGN COMPONENT 'Z_DESCRIPCIO' OF STRUCTURE <ls_grid> TO FIELD-SYMBOL(<lv_descripcio>). "SPEC-47173 ETLJS
      LOOP AT my_columns ASSIGNING FIELD-SYMBOL(<fs_column_sel>) WHERE fieldname = lv_col_id.
        l_num_ofer = <fs_column_sel>-key.
        EXIT.
      ENDLOOP.
      CHECK l_num_ofer IS NOT INITIAL.

      my_backend->get_punt_subapart( IMPORTING et_dades_subapart = DATA(lt_dades_punt) ).

      IF i_criteri IS NOT INITIAL.
        l_criteri = i_criteri.
      ELSE.
        ASSIGN COMPONENT 'Z_CODI_CRIT_PUNT' OF STRUCTURE <ls_grid> TO FIELD-SYMBOL(<fs_criteri>).
        l_criteri = <fs_criteri>.
      ENDIF.
      IF i_subapart IS NOT INITIAL.
        l_subapart = i_subapart.
      ENDIF.

      READ TABLE gt_crit_punt ASSIGNING FIELD-SYMBOL(<fs_crit_punt>) WITH KEY z_codi_crit_punt     = l_criteri
                                                                     z_codi_subapar_punt  = l_subapart
                                                                     z_descripcio          = <lv_descripcio>. "SPEC-47173 ETLJS
      IF sy-subrc EQ 0.
        DATA(lv_num_equip) = <fs_crit_punt>-z_num_equip.
      ENDIF.

      READ TABLE lt_dades_punt ASSIGNING FIELD-SYMBOL(<fs>) WITH KEY z_codi_crit_punt     = l_criteri
                                                                     z_codi_subapar_punt  = l_subapart
                                                                     z_num_ofer           = l_num_ofer
                                                                     z_num_equip          = lv_num_equip.
      IF sy-subrc = 0.
        IF <fs>-z_motivacio IS BOUND.
          IF ls_exp_cont-z_pt_conf_dades EQ ''. "ECDRB SPEC-69341
            <fs>-z_motivacio->edit_text( EXPORTING i_editable = abap_on ).
            "INI ECDRB SPEC-69341
          ELSE.
            <fs>-z_motivacio->edit_text( EXPORTING i_editable = abap_off ).
          ENDIF.
          "FI ECDRB SPEC-69341
*    >> INI MODIF ETODR SPEC-47129
          CLEAR: lt_dades_punt_aux[].
          APPEND <fs> TO lt_dades_punt_aux.
          IF lt_dades_punt_aux IS NOT INITIAL.
            my_backend->set_punt_subapart( EXPORTING it_dades_subapart = lt_dades_punt_aux ).
          ENDIF.
*    << FI MODIF ETODR SPEC-47129
          EXIT.
        ELSE.
          l_create_motivacio = abap_on.
        ENDIF.
      ELSE.
        l_create_motivacio = abap_on.
      ENDIF.

      IF l_create_motivacio IS NOT INITIAL.
        CONCATENATE 'Z' i_objectid l_num_ofer i_criteri
                    i_subapart l_sec l_dummy_rec INTO lv_codi_text.

        CREATE OBJECT lr_sapscript
          EXPORTING
            i_docclass = i_docclass
            i_objectid = i_objectid
            i_tdid     = 'ZCOM'
            i_tdspras  = sy-langu
            i_tdname   = lv_codi_text
            i_tdobject = 'Z_PUNT_DYN'
          EXCEPTIONS
            OTHERS     = 1.

        CHECK sy-subrc = 0.

        IF <fs> IS ASSIGNED.
          <fs>-z_motivacio = lr_sapscript.
          IF <fs>-z_motivacio IS BOUND.
            <fs>-z_motivacio->edit_text( EXPORTING i_editable = abap_on ).
          ENDIF.
        ELSE.
          wa_puntuacio-z_codi_crit_punt           = l_criteri.
          wa_puntuacio-z_codi_subapar_punt        = l_subapart.
          wa_puntuacio-z_num_equip                = lv_num_equip. " ETLJS SPEC-47173.
          wa_puntuacio-docclass                   = i_docclass.
          wa_puntuacio-objectid                   = i_objectid.
          wa_puntuacio-z_num_ofer                 = l_num_ofer.
          wa_puntuacio-z_motivacio                = lr_sapscript.
          IF wa_puntuacio-z_motivacio IS BOUND.
            wa_puntuacio-z_motivacio->edit_text( EXPORTING i_editable = abap_on
                                                 IMPORTING e_modified = DATA(l_has_text) ).
            IF l_has_text IS NOT INITIAL. "només es guarda si s'ha introduit o modificat el text ja existent
              APPEND wa_puntuacio TO lt_dades_punt.
            ENDIF.
          ENDIF.
        ENDIF.
      ENDIF.
      IF lt_dades_punt IS NOT INITIAL.
**    >> INI MODIF ETODR SPEC-47727
        CLEAR: lt_dades_punt_aux_2[].
        APPEND <fs> TO lt_dades_punt_aux_2.
*        my_backend->set_punt_subapart( EXPORTING it_dades_subapart = lt_dades_punt ).
        my_backend->set_punt_subapart( EXPORTING it_dades_subapart = lt_dades_punt_aux_2 ).
**    << FI MODIF ETODR SPEC-47727
      ENDIF.
    ENDIF.
  ENDMETHOD.


METHOD fill_awardee_line.
  FIELD-SYMBOLS: <ls_column> TYPE ty_s_column,
                 <l_punt>    TYPE any .
  DATA: ls_style     TYPE lvc_s_styl,
        l_pushbutton TYPE xfeld .

  CLEAR: ch_row,
         ch_punt .

* Si no es pot adjudicar, tota la línia serà només de visualització. Si es pot adjudicar,
* les columnes seleccionables han d'aparèixer com a pushbutton
  IF     my_backend->check_activity( my_backend->co_act_awardee ) IS NOT INITIAL
     AND (    my_backend->is_2_round( ) IS INITIAL
           OR my_mode EQ co_mode_adj_2nd OR  my_mode EQ co_mode_neg_f2 ). "P100031 ADD ETRCM
    l_pushbutton = 'X' .
  ENDIF .
  IF my_backend->is_awardee( ) EQ abap_true AND my_mode EQ co_mode_neg_f2.
    CLEAR l_pushbutton.
  ENDIF.


  IF l_pushbutton IS INITIAL .
    CLEAR ls_style .
    ls_style-style     = cl_gui_alv_grid=>mc_style_disabled .
    INSERT ls_style INTO TABLE ch_row-style.
  ENDIF .

  ch_row-z_descripcio = 'Adjudicació'(r00).
  ch_row-row_color    = 'C711' .
  LOOP AT my_columns ASSIGNING <ls_column> .
    ASSIGN COMPONENT <ls_column>-colpos OF STRUCTURE ch_punt TO <l_punt> .
    CLEAR <l_punt> .
    IF <ls_column>-editable IS INITIAL .
      ls_style-fieldname  = <ls_column>-fieldname .
      ls_style-style      = cl_gui_alv_grid=>mc_style_disabled .
      INSERT ls_style INTO TABLE ch_row-style.
    ELSE .
      IF l_pushbutton IS NOT INITIAL .
        IF <ls_column>-adjudicat IS INITIAL .
          <l_punt> = icon_wd_radio_button_empty .
        ELSE .
          <l_punt> = icon_radiobutton .
        ENDIF .
        ls_style-fieldname = <ls_column>-fieldname  .
        ls_style-style     = cl_gui_alv_grid=>mc_style_button .
        INSERT ls_style INTO TABLE ch_row-style.
      ELSE .
        IF <ls_column>-adjudicat IS NOT INITIAL .
          <l_punt> = icon_status_ok .
        ENDIF .
      ENDIF .
    ENDIF .
  ENDLOOP .
ENDMETHOD.


METHOD fill_best_classified_line.

*>> Ini  SPEC-54695  - ETMAE - copia de  fill_awardee_line

  FIELD-SYMBOLS: <ls_column> TYPE ty_s_column,
                 <l_punt>    TYPE any.
  DATA: ls_style      TYPE lvc_s_styl,
        lv_pushbutton TYPE xfeld.

  CLEAR: ch_row,    ch_punt .

**lv_pushbutton = abap_true.  25/210/2019

  "Mostrar el radiobutton únicament si està permesa la millor classificada
  IF my_backend->check_activity( my_backend->co_act_best_classified ) IS NOT INITIAL.
    lv_pushbutton = 'X' .
  ENDIF.
* Si ya se seleccionó Millor Classificat bloquear checkbox.
  IF my_backend->is_best_classified( ) = abap_true .
    lv_pushbutton = abap_false.
  ENDIF.


  IF lv_pushbutton IS INITIAL .
    CLEAR ls_style .
    ls_style-style   = cl_gui_alv_grid=>mc_style_disabled .
    INSERT ls_style INTO TABLE ch_row-style.
  ENDIF .

  ch_row-z_descripcio = 'Oferta per demanar la solvència'(R02).
  ch_row-row_color    = 'C711' .  " Naranja

  LOOP AT my_columns ASSIGNING <ls_column> .
    ASSIGN COMPONENT <ls_column>-colpos OF STRUCTURE ch_punt TO <l_punt> .
    CLEAR <l_punt> .
    IF <ls_column>-editable IS INITIAL .
      ls_style-fieldname  = <ls_column>-fieldname .
      ls_style-style      = cl_gui_alv_grid=>mc_style_disabled .
      INSERT ls_style INTO TABLE ch_row-style.
    ELSE .
      IF lv_pushbutton IS NOT INITIAL .
        IF <ls_column>-mill_class IS INITIAL .
          <l_punt> = icon_wd_radio_button_empty .
        ELSE .
          <l_punt> = icon_radiobutton .
        ENDIF .
        ls_style-fieldname = <ls_column>-fieldname  .
        ls_style-style     = cl_gui_alv_grid=>mc_style_button .
        INSERT ls_style INTO TABLE ch_row-style.
      ELSE .
        IF <ls_column>-mill_class IS NOT INITIAL . " * * * * *
          <l_punt> = icon_status_ok .
        ENDIF .
      ENDIF .
    ENDIF .
  ENDLOOP .

*<< Fi  SPEC-54695  - ETMAE

ENDMETHOD.
*
*------------------------------------------------------------------------------
*


METHOD get_data.

  CASE my_mode .
    WHEN  co_mode_1_round OR co_mode_punct_1st OR co_mode_punct_tec
      OR co_mode_neg_f2. "P100031 - ADD ETRCM
      ex_crit_punt = my_backend->get_crit_punt_offers( my_read_only ) .
      ex_punt_gen  = my_backend->get_punt_offers( my_read_only ) .
    WHEN  co_mode_punct_2nd OR co_mode_adj_2nd.
      ex_crit_punt = my_backend->get_crit_punt_lemes( my_read_only ) .
      ex_punt_gen  = my_backend->get_punt_lemes( my_read_only ) .
    WHEN co_mode_punt_sol_part.
      ex_crit_punt = my_backend->get_crit_punt_sol_part( my_read_only ) .
      ex_punt_gen  = my_backend->get_punt_sol_part( my_read_only ) .
**  >> INI MODIF ETODR SPEC-49075
    WHEN zrm_cl_valoracio_ofertes=>co_mode_punt_quadre2b.
      ex_crit_punt = my_backend->get_crit_punt_offers( my_read_only ) .
      ex_punt_gen  = my_backend->get_punt_offers( my_read_only ) .
    WHEN zrm_cl_valoracio_ofertes=>co_mode_punt_quadre3b.
      ex_crit_punt = my_backend->get_crit_punt_offers( my_read_only ) .
      ex_punt_gen  = my_backend->get_punt_offers( my_read_only ) .
      " >>>PSPEC-1451 Inici modificació - EVXGL
    WHEN zrm_cl_valoracio_ofertes=>co_mode_val_cap_obra.
      ex_crit_punt = my_backend->get_crit_punt_offers( my_read_only ) .
      ex_punt_gen  = my_backend->get_punt_offers_val_cap_obra( my_read_only ) .
      " <<<PSPEC-1451 Fi modificació - EVXGL
    WHEN zrm_cl_valoracio_ofertes=>co_mode_punt_quadre4b.
      ex_crit_punt = my_backend->get_crit_punt_offers( my_read_only ) .
      ex_punt_gen  = my_backend->get_punt_offers( my_read_only ) .
**  << FI MODIF ETODR SPEC-49075

*>> Ini  SPEC-54695  - ETMAE
    WHEN zrm_cl_valoracio_ofertes=>co_mode_millor_classif.
      ex_crit_punt = my_backend->get_crit_punt_offers( my_read_only ) .
      ex_punt_gen  = my_backend->get_punt_offers( my_read_only ) .
*<< Fi  SPEC-54695  - ETMAE

  ENDCASE .
*** >> INI MODIF ETODR SPEC-45341 Traspassem les dades de APLICA/NO_APLICA al criteri de puntuació, per tal de mostrar-los o no i fer el recalcul corresponent
  IF my_backend->get_my_crit_dyn( ) IS NOT INITIAL.
    my_backend->get_dades_ofer_dyn( IMPORTING ex_crit_punt      = ex_crit_punt ).
*                                              ex_punt_ofer_dyn  = ex_punt_gen ).
  ENDIF.
*** << FI MODIF ETODR SPEC-45341

ENDMETHOD.
*
*------------------------------------------------------------------------------
*


  METHOD get_punt_incr_obj.

    DATA: ls_incr  TYPE zrm_dt_punt_equi.
    DATA: ls_inc2  TYPE zrm_dt_punt_equi.
    DATA: iv_punts TYPE z_punts.
    DATA: iv_div   TYPE sytabix.
    DATA: iv_valor TYPE char40.

    MOVE-CORRESPONDING is_punts_offer TO ls_incr.

    ASSIGN COMPONENT is_column-fieldname OF STRUCTURE is_punts_offer
         TO FIELD-SYMBOL(<fs_punts>).

    CLEAR: iv_div, iv_punts.
    LOOP AT it_incr INTO ls_inc2
        WHERE z_codi_crit_punt = ls_incr-z_codi_crit_punt.

      iv_punts = iv_punts + ls_inc2-z_punts.
      iv_div   = iv_div + 1.

    ENDLOOP.

    CHECK sy-subrc EQ 0.

    <fs_punts> = iv_punts / iv_div.

    CONDENSE <fs_punts> NO-GAPS.

  ENDMETHOD.


  METHOD hotspot_click_co2.

    FIELD-SYMBOLS: <lt_grid> TYPE STANDARD TABLE.
    DATA: lt_punts_offer TYPE zrm_cl_valoracio_ofertes=>ty_t_punt_gen,
          ls_ref         TYPE tabfield,
          lv_num_oferta  TYPE z_num_ofer,
          lv_read_only   TYPE xfeld,
          lv_crit_punt   TYPE z_codi_crit_punt,
          lv_mod_punt    TYPE z_mod_crit_punt.

    ls_ref-tabname   = 'ZRM_DT_PUNT_OFER' .
    ls_ref-fieldname = 'Z_PUNTS' .

    ASSIGN my_table_ref->* TO <lt_grid>.

    READ TABLE <lt_grid> ASSIGNING FIELD-SYMBOL(<ls_grid>) INDEX i_row_id.
    CHECK sy-subrc = 0.

    ASSIGN COMPONENT 'Z_CODI_CRIT_PUNT' OF STRUCTURE <ls_grid> TO FIELD-SYMBOL(<lv_crit_punt>).
    CHECK sy-subrc  = 0.
    lv_crit_punt    = <lv_crit_punt>.

    ASSIGN COMPONENT 'Z_MOD_CRIT_PUNT'  OF STRUCTURE <ls_grid> TO FIELD-SYMBOL(<lv_mod_punt>).
    CHECK sy-subrc  = 0.
    lv_mod_punt     = <lv_mod_punt>.

****"1-Dades oferta
    ASSIGN COMPONENT i_column_id OF STRUCTURE <ls_grid>  TO FIELD-SYMBOL(<lv_punt>).
    CHECK sy-subrc = 0.

    LOOP AT my_columns ASSIGNING FIELD-SYMBOL(<fs_column_sel>) WHERE fieldname = i_column_id.
      lv_num_oferta = <fs_column_sel>-key.
      EXIT.
    ENDLOOP.
    CHECK lv_num_oferta IS NOT INITIAL.

****"2-Dades de les emissions ja guardades
    my_backend->get_dades_ofer_dyn( IMPORTING ex_punt_ofer_dyn = DATA(lt_punt_ofer_all)
                                              et_co2           = DATA(lt_punt_co2) ).

    "ens quedem únicament amb les dades de puntuació de la oferta en qüestió
    DELETE lt_punt_co2      WHERE z_num_ofer <> lv_num_oferta.
    DELETE lt_punt_ofer_all WHERE z_num_ofer <> lv_num_oferta.

    lt_punts_offer = my_backend->get_punt_offers( ).
    DELETE lt_punts_offer WHERE z_num_gen <> lv_num_oferta.
    LOOP AT lt_punts_offer ASSIGNING FIELD-SYMBOL(<fs>).
      READ TABLE lt_punt_co2 TRANSPORTING NO FIELDS
        WITH KEY z_codi_crit_punt = <fs>-z_codi_crit_punt.
      IF sy-subrc <> 0.
        DELETE lt_punts_offer.
      ENDIF.
    ENDLOOP.
    IF lv_mod_punt IS INITIAL.
      READ TABLE lt_punt_ofer_all INTO DATA(ls_punt_ofer) INDEX 1.
      lv_mod_punt = ls_punt_ofer-z_mod_crit_punt.
    ENDIF.

    IF my_read_only IS NOT INITIAL OR  my_backend->check_activity( my_backend_activities-save_punct ) IS INITIAL.
      lv_read_only = abap_on.
    ENDIF.

    CALL FUNCTION 'ZRM_PUNTUA_CO2'
      EXPORTING
        iv_mod_crit    = lv_mod_punt
        iv_docclass    = gv_docclass
        iv_objectid    = gv_objectid
        iv_num_ofer    = lv_num_oferta
        io_backend     = my_backend
        iv_column      = <fs_column_sel>
        io_grid        = <ls_grid>
        iv_readonly    = lv_read_only
      IMPORTING
        et_punt_co2    = lt_punt_co2
        et_punts_offer = lt_punts_offer
      EXCEPTIONS
        not_changed    = 1
        other          = 2.

    CHECK sy-subrc = 0.
    "Actualitza la graella de puntuacions en base al Z_PUNTS obtingut del CO2
    my_backend->update_punt_co2( it_punts_offer = lt_punts_offer
                                 it_punt_co2    = lt_punt_co2 ).

  ENDMETHOD.


  METHOD hotspot_click_coefi_iref.

    FIELD-SYMBOLS: <lt_grid> TYPE STANDARD TABLE.

    DATA: lt_incr                       TYPE ztt_punt_incr,
          lt_graella_criteris           TYPE zrm_cl_valoracio_ofertes=>ty_t_crit_punt,
          lt_puntuacio_apartat          TYPE zrm_cl_valoracio_ofertes=>ty_t_puntuacio_subapartats,
          lt_puntuacio_apartat_multiple TYPE zrm_cl_valoracio_ofertes=>ty_t_puntuacio_subapartats,
          wa_crit_punt                  TYPE zrm_cl_valoracio_ofertes=>ty_s_crit_punt,
          lt_punt_ofer_all_2_aux        TYPE zrm_cl_valoracio_ofertes=>ty_t_punt_ofer_dyn_equi,
          lt_puntuacio_apartat_aux      TYPE zrm_cl_valoracio_ofertes=>ty_t_puntuacio_subapartats,
          lt_punt_ofer_all_2            TYPE zrm_tt_dt_punt_ofer,
          wa_ofer_all                   TYPE zrm_cl_valoracio_ofertes=>ty_s_punt_ofer_dyn_equi,
          wa_motiv_mult                 TYPE zrm_cl_valoracio_ofertes=>ty_s_puntuacio_subapartats,
          lv_num_oferta                 TYPE z_num_ofer,
          ls_ref                        TYPE tabfield,
          l_read_only                   TYPE xfeld,
          lv_punt_aux                   TYPE string,
          lv_punt                       TYPE z_punt_max,
          lv_operacion                  TYPE z_punt,
          lv_pes                        TYPE i,
          lv_crit_punt                  TYPE z_codi_crit_punt,
          lv_mod_punt                   TYPE z_mod_crit_punt,
          lt_columns                    TYPE ty_t_column,
          lt_punts_offer                TYPE zrm_cl_valoracio_ofertes=>ty_t_punt_gen.

    ">>>SPEC:67070, Inici modificació - ECJMS
    DATA: ls_zrm_dm_crit_punt TYPE zrm_dm_crit_punt.
    DATA: lv_flag             TYPE xfeld.
    DATA: lv_fla1             TYPE xfeld.
    DATA: lv_coeficient_iref  TYPE z_coeficient_iref.
    DATA: lt_incr_obj         TYPE zrm_tt_dt_punt_equi.
    DATA: lt_punts_offer1     TYPE zrm_cl_valoracio_ofertes=>ty_t_punt_gen.
    "<<<SPEC:67070, Final modificació - ECJMS

    ls_ref-tabname   = 'ZRM_DT_PUNT_OFER' .
    ls_ref-fieldname = 'Z_PUNTS' .

    ASSIGN my_table_ref->* TO <lt_grid>.

    READ TABLE <lt_grid> ASSIGNING FIELD-SYMBOL(<ls_grid>) INDEX i_row_id.
    CHECK sy-subrc = 0.

    ASSIGN COMPONENT 'Z_CODI_CRIT_PUNT' OF STRUCTURE <ls_grid>
     TO FIELD-SYMBOL(<lv_crit_punt>).
    CHECK sy-subrc  = 0.
    lv_crit_punt    = <lv_crit_punt>.
    ASSIGN COMPONENT 'Z_MOD_CRIT_PUNT'  OF STRUCTURE <ls_grid>
     TO FIELD-SYMBOL(<lv_mod_punt>). "
    CHECK sy-subrc  = 0.

    lv_mod_punt     = <lv_mod_punt>.

****"Per tal de montar la finestra amb les dades de l'equip a puntuar per a la
*    oferta clicada, es recuperarà:

****"1-Dades oferta
    ASSIGN COMPONENT i_column_id OF STRUCTURE <ls_grid>
     TO FIELD-SYMBOL(<lv_punt>).     "Recollir empresa

    CHECK sy-subrc = 0.
    LOOP AT my_columns ASSIGNING FIELD-SYMBOL(<fs_column_sel>) WHERE fieldname = i_column_id.
      lv_num_oferta = <fs_column_sel>-key.
      EXIT.
    ENDLOOP.
    CHECK lv_num_oferta IS NOT INITIAL.

    my_backend->get_dades_ofer_dyn(
          IMPORTING ex_punt_ofer_dyn      = DATA(lt_punt_ofer_all)
                    ex_punt_ofer_dyn_equi = DATA(lt_graella_equip) ).

    "ens quedem únicament amb les dades de l'equip i de puntuació de la oferta en qüestió

    DELETE lt_graella_equip WHERE z_num_ofer <> lv_num_oferta.
    DELETE lt_punt_ofer_all WHERE z_num_ofer <> lv_num_oferta.

    DATA(lt_equip_disticnt) = lt_graella_equip[].
    SORT lt_equip_disticnt BY z_codi_crit_punt.
    DELETE ADJACENT DUPLICATES FROM lt_equip_disticnt COMPARING z_codi_crit_punt.

    CHECK lt_equip_disticnt[] IS NOT INITIAL.
    SELECT *
      FROM zrm_dm_crit_punt
      INTO TABLE @DATA(lt_dm_crit_punt)
      FOR ALL ENTRIES IN @lt_equip_disticnt
      WHERE z_mod_crit_punt   = @lt_equip_disticnt-z_mod_crit_punt
        AND z_codi_crit_punt  = @lt_equip_disticnt-z_codi_crit_punt.

    TRY.
        DATA(lt_crit_aux_punt) = my_backend->get_crit_punt_offers_equi( ).
      CATCH cx_root.
        RETURN.
    ENDTRY.
    LOOP AT lt_equip_disticnt ASSIGNING FIELD-SYMBOL(<fs_crit_equip>).
      LOOP AT lt_crit_aux_punt INTO wa_crit_punt WHERE z_codi_crit_punt EQ <fs_crit_equip>-z_codi_crit_punt.
        READ TABLE lt_dm_crit_punt INTO DATA(ls_dm_crit_punt) WITH KEY z_codi_crit_punt = <fs_crit_equip>-z_codi_crit_punt.
        wa_crit_punt-z_descripcio = ls_dm_crit_punt-z_descripcio.
        APPEND wa_crit_punt TO lt_graella_criteris.
      ENDLOOP.
    ENDLOOP.

*    IF lt_graella_incr IS INITIAL.
*      DATA: ls_incr TYPE zrm_dt_punt_incr.
*      LOOP AT lt_incr_aux INTO ls_incr
*        WHERE z_num_ofer IS INITIAL.
*        ls_incr-z_num_ofer = lv_num_oferta.
*        APPEND ls_incr TO lt_graella_incr.
*      ENDLOOP.
*    ENDIF.

    lt_punts_offer = my_backend->get_punt_offers( ).
    DELETE lt_punts_offer WHERE z_num_gen <> lv_num_oferta.
    LOOP AT lt_punts_offer ASSIGNING FIELD-SYMBOL(<fs>).
      READ TABLE lt_graella_equip TRANSPORTING NO FIELDS
        WITH KEY z_codi_crit_punt = <fs>-z_codi_crit_punt.
      IF sy-subrc <> 0.
        DELETE lt_punts_offer.
      ENDIF.
    ENDLOOP.

    IF my_read_only IS NOT INITIAL OR  my_backend->check_activity( my_backend_activities-save_punct ) IS INITIAL.
      l_read_only = abap_on.
    ENDIF.

    ">>>SPEC:67070, Inici modificació - ECJMS

    lt_punts_offer1 = my_backend->get_punt_offers( ).
    DELETE lt_punts_offer1 WHERE z_num_gen <> lv_num_oferta.

    lv_flag = abap_false.
    LOOP AT lt_punts_offer1 ASSIGNING  FIELD-SYMBOL(<fs1>).
      IF lv_mod_punt IS INITIAL.
        lv_mod_punt = <fs1>-z_mod_crit_punt.
      ENDIF.
      SELECT SINGLE z_coeficient_iref INTO lv_coeficient_iref
        FROM zrm_dm_crit_punt
        WHERE z_mod_crit_punt   EQ <fs1>-z_mod_crit_punt  AND
              z_codi_crit_punt  EQ <fs1>-z_codi_crit_punt AND
              z_coeficient_iref <> space.

      CHECK sy-subrc EQ 0.

      lv_flag     = abap_true.
*      l_read_only = abap_off.

      EXIT.

    ENDLOOP.

    IF lv_flag = abap_false.
      MESSAGE 'No s''ha introduit el IMIN per a la licitació' TYPE 'I'.
      EXIT.
    ENDIF.

    CALL FUNCTION 'ZRM_PUNTUA_INCR_OBJ'
      EXPORTING
        im_mod_crit         = lv_mod_punt
        im_docclass         = gv_docclass
        im_objectid         = gv_objectid
        im_num_ofer         = lv_num_oferta
        it_graella_criteris = lt_graella_criteris
        it_graella_equip    = lt_graella_equip
        im_backend          = my_backend
        im_column           = <fs_column_sel>
        im_grid             = <ls_grid>
        i_readonly          = l_read_only
      IMPORTING
        et_incr             = lt_incr_obj
        et_punts_offer      = lt_punts_offer
      EXCEPTIONS
        not_changed         = 1
        other               = 2.

*************    my_backend->set_punt_incr_obj( EXPORTING iv_oferta      = lv_num_oferta
*************                                   CHANGING  iv_column      = <fs_column_sel>
*************                                             it_punts_offer = <lt_grid>
*************                                             it_incr        = lt_incr_obj ).
    my_backend->set_new_equip( lt_incr_obj ).
    my_backend->set_punts_gen_equi( lt_punts_offer ).


    my_grid->check_changed_data( IMPORTING e_valid   = DATA(l_valid) ).

    TRY.
        me->recalculate( ).
      CATCH zcx_rm_valoracio .
        RETURN.
    ENDTRY.


  ENDMETHOD.


  METHOD hotspot_click_equip.
    FIELD-SYMBOLS: <lt_grid> TYPE STANDARD TABLE.

    DATA: lt_equip                      TYPE zrm_tt_dt_punt_equi,
          lt_graella_criteris           TYPE zrm_cl_valoracio_ofertes=>ty_t_crit_punt,
          lt_puntuacio_apartat          TYPE zrm_cl_valoracio_ofertes=>ty_t_puntuacio_subapartats,
          lt_puntuacio_apartat_multiple TYPE zrm_cl_valoracio_ofertes=>ty_t_puntuacio_subapartats,
          wa_crit_punt                  TYPE zrm_cl_valoracio_ofertes=>ty_s_crit_punt,
          lt_punt_ofer_all_2_aux        TYPE zrm_cl_valoracio_ofertes=>ty_t_punt_ofer_dyn_equi,
          lt_puntuacio_apartat_aux      TYPE zrm_cl_valoracio_ofertes=>ty_t_puntuacio_subapartats,
          lt_punt_ofer_all_equi         TYPE zrm_cl_valoracio_ofertes=>ty_t_punt_ofer_dyn_equi,
          lt_punt_ofer_all_2            TYPE zrm_tt_dt_punt_ofer,
          wa_ofer_all                   TYPE zrm_cl_valoracio_ofertes=>ty_s_punt_ofer_dyn_equi,
          wa_motiv_mult                 TYPE zrm_cl_valoracio_ofertes=>ty_s_puntuacio_subapartats,
          lv_num_oferta                 TYPE z_num_ofer,
          ls_ref                        TYPE tabfield,
          lv_codi_comptador_equip       TYPE zrm_dt_punt_equi-z_comptador_equip,
          l_read_only                   TYPE xfeld,
          lv_punt_aux                   TYPE string,
          lv_punt                       TYPE z_punt_max,
          lv_operacion                  TYPE z_punt,
          lv_pes                        TYPE i,
          lv_crit_punt                  TYPE z_codi_crit_punt,
          lv_mod_punt                   TYPE z_mod_crit_punt,
          lt_columns                    TYPE ty_t_column.

*    BREAK-POINT.

    ls_ref-tabname   = 'ZRM_DT_PUNT_OFER' .
    ls_ref-fieldname = 'Z_PUNTS' .
    ASSIGN my_table_ref->* TO <lt_grid>.

    READ TABLE <lt_grid> ASSIGNING FIELD-SYMBOL(<ls_grid>) INDEX i_row_id.
    CHECK sy-subrc = 0.

    ASSIGN COMPONENT 'Z_CODI_CRIT_PUNT' OF STRUCTURE <ls_grid> TO FIELD-SYMBOL(<lv_crit_punt>).
    CHECK sy-subrc  = 0.
    lv_crit_punt    = <lv_crit_punt>.
    ASSIGN COMPONENT 'Z_MOD_CRIT_PUNT'  OF STRUCTURE <ls_grid> TO FIELD-SYMBOL(<lv_mod_punt>). "
    CHECK sy-subrc  = 0.
    lv_mod_punt     = <lv_mod_punt>.

****"Per tal de montar la finestra amb les dades de l'equip a puntuar per a la oferta clicada, es recuperarà:
****"1-Dades oferta
    ASSIGN COMPONENT i_column_id OF STRUCTURE <ls_grid> TO FIELD-SYMBOL(<lv_punt>).     "Recollir empresa
    CHECK sy-subrc = 0.

    LOOP AT my_columns ASSIGNING FIELD-SYMBOL(<fs_column_sel>) WHERE fieldname = i_column_id.
      lv_num_oferta = <fs_column_sel>-key.
      EXIT.
    ENDLOOP.
    CHECK lv_num_oferta IS NOT INITIAL.
****"2-Membres de l'equip actuals (equip bàsic + addicionals)
    my_backend->get_dades_ofer_dyn( IMPORTING ex_punt_ofer_dyn      = DATA(lt_punt_ofer_all)
                                              ex_punt_ofer_dyn_equi = DATA(lt_graella_equip) ).
    "ens quedem únicament amb les dades de l'equip i de puntuació de la oferta en qüestió
    DELETE lt_graella_equip WHERE z_num_ofer <> lv_num_oferta.
    DELETE lt_punt_ofer_all WHERE z_num_ofer <> lv_num_oferta.

    DATA(lt_equip_disticnt) = lt_graella_equip[].
    SORT lt_equip_disticnt BY z_codi_crit_punt.
    DELETE ADJACENT DUPLICATES FROM lt_equip_disticnt COMPARING z_codi_crit_punt.

    CHECK lt_equip_disticnt[] IS NOT INITIAL.
    SELECT *
      FROM zrm_dm_crit_punt
      INTO TABLE @DATA(lt_dm_crit_punt)
      FOR ALL ENTRIES IN @lt_equip_disticnt
      WHERE z_mod_crit_punt   = @lt_equip_disticnt-z_mod_crit_punt
        AND z_codi_crit_punt  = @lt_equip_disticnt-z_codi_crit_punt.

    TRY.
        DATA(lt_crit_aux_punt) = my_backend->get_crit_punt_offers_equi( ).
      CATCH cx_root.
        RETURN.
    ENDTRY.

    LOOP AT lt_equip_disticnt ASSIGNING FIELD-SYMBOL(<fs_crit_equip>).
      LOOP AT lt_crit_aux_punt INTO wa_crit_punt WHERE z_codi_crit_punt EQ <fs_crit_equip>-z_codi_crit_punt.
        READ TABLE lt_dm_crit_punt INTO DATA(ls_dm_crit_punt) WITH KEY z_codi_crit_punt = <fs_crit_equip>-z_codi_crit_punt.
        wa_crit_punt-z_descripcio = ls_dm_crit_punt-z_descripcio.
        APPEND wa_crit_punt TO lt_graella_criteris.
      ENDLOOP.
    ENDLOOP.


    LOOP AT lt_equip_disticnt ASSIGNING FIELD-SYMBOL(<fs_crit_punt>).
      LOOP AT lt_punt_ofer_all ASSIGNING FIELD-SYMBOL(<fs_ofer_all>) WHERE z_codi_crit_punt = <fs_crit_punt>-z_codi_crit_punt
                                                                       AND z_no_aplica      = abap_off
                                                                       AND z_num_ofer       = lv_num_oferta.
        CLEAR: wa_ofer_all.
        MOVE-CORRESPONDING <fs_ofer_all> TO wa_ofer_all.
        APPEND wa_ofer_all TO lt_punt_ofer_all_2_aux.
        APPEND <fs_ofer_all> TO lt_punt_ofer_all_2.
      ENDLOOP.
    ENDLOOP.
    lt_punt_ofer_all[]      = lt_punt_ofer_all_2[].
    lt_punt_ofer_all_equi[] = lt_punt_ofer_all_2_aux[].

****"3-Puntuació criteris que formen l'equip
    my_backend->get_motivacio_multi( IMPORTING et_motiv_mult = DATA(lt_motiv_mult) ).
    CLEAR: lt_puntuacio_apartat_multiple[].
    LOOP AT lt_motiv_mult ASSIGNING FIELD-SYMBOL(<fs_motiv_mult>).
      MOVE-CORRESPONDING <fs_motiv_mult> TO wa_motiv_mult.
      APPEND wa_motiv_mult TO lt_puntuacio_apartat_multiple.
    ENDLOOP.

    ">>>SPEC-56253, Inici modificació  - ETODR
    IF my_read_only IS NOT INITIAL OR  my_backend->check_activity( my_backend_activities-save_punct ) IS INITIAL.
      l_read_only = abap_on.
    ENDIF.
    "<<<SPEC-56253, Final modificació - ETODR

    ">>>SPEC:56622, Inici modificació  - ECFA
    "Cada vegada que passem per aqui, incrementem el comptador +1
    add 1 to gv_pools.
    "si hem passat per aqui més que el nombre de vegades que hi ha a la variable
    "gv_maxpools llavors sortim.
    IF gv_pools >= gv_maxpools.
      "mostem un missatge a l'usuari.
       MESSAGE 'messatge'(008) TYPE 'I'.
      RETURN.
    ENDIF.
    "<<<SPEC:56622, Final modificació - ECFA

    DATA: lt_max_punts_carrec TYPE ztt_equip_max,
          lt_punts_offer      TYPE zrm_cl_valoracio_ofertes=>ty_t_punt_gen.
    CALL FUNCTION 'ZRM_PUNTUA_EQUIP_MAX'
      EXPORTING
        im_mod_crit           = lv_mod_punt
        im_docclass           = gv_docclass
        im_objectid           = gv_objectid
        im_num_ofer           = lv_num_oferta
        it_graella_criteris   = lt_graella_criteris
        it_graella_equip      = lt_graella_equip
        it_punt_ofer_equi     = lt_punt_ofer_all_equi
        im_backend            = my_backend
        im_column             = <fs_column_sel>
        im_grid               = <ls_grid>
        i_readonly            = l_read_only
      IMPORTING
        et_max_punts_carrec   = lt_max_punts_carrec
        et_punts_offer        = lt_punts_offer
        et_equip_act          = lt_equip
      CHANGING
        ct_puntuacio_multiple = lt_puntuacio_apartat_multiple
      EXCEPTIONS
        not_changed           = 1
        other                 = 2.
    CHECK sy-subrc = 0.
*    BREAK-POINT.
*
    my_backend->set_max_punts_equi( lt_max_punts_carrec ).
    my_backend->set_punts_gen_equi( lt_punts_offer ).
    my_backend->set_new_equip( lt_equip ).

    IF lt_puntuacio_apartat_multiple IS NOT INITIAL.
      my_backend->set_motivacio_mult( it_dades_subapart = lt_puntuacio_apartat_multiple ).
    ENDIF.

    "Per cada criteri puntuar actualitzar LT_GRID..
    DESCRIBE TABLE <lt_grid> LINES DATA(l_num).
    DO l_num TIMES.
      DATA(l_index) = sy-index.
      READ TABLE <lt_grid> ASSIGNING <ls_grid> INDEX l_index.
      IF sy-subrc = 0.
        ASSIGN COMPONENT 'Z_CODI_CRIT_PUNT' OF STRUCTURE <ls_grid> TO <lv_crit_punt>.
        CHECK sy-subrc = 0.
        ASSIGN COMPONENT 'Z_MOD_CRIT_PUNT'  OF STRUCTURE <ls_grid> TO <lv_mod_punt>.
        CHECK sy-subrc = 0.
        ASSIGN COMPONENT 'Z_DESCRIPCIO' OF STRUCTURE <ls_grid> TO FIELD-SYMBOL(<lv_descripcio>).
        CHECK sy-subrc = 0.
        ASSIGN COMPONENT i_column_id    OF STRUCTURE <ls_grid> TO <lv_punt>.
        CHECK sy-subrc = 0.
        ASSIGN COMPONENT 'Z_PUNT_MAX' OF STRUCTURE <ls_grid> TO FIELD-SYMBOL(<lv_punt_max_2>).
        CHECK sy-subrc = 0.
        "Es recupera el comptador d'equip que hi ha a cada línia per tal de comprovar si és el millor puntuat
        ASSIGN COMPONENT 'Z_COMPTADOR_EQUIP' OF STRUCTURE <ls_grid> TO FIELD-SYMBOL(<lv_comptador_equip2>).
        CHECK sy-subrc = 0 AND <lv_comptador_equip2> IS NOT INITIAL.
        READ TABLE lt_max_punts_carrec TRANSPORTING NO FIELDS WITH KEY z_comptador_equip = <lv_comptador_equip2>.
        IF sy-subrc <> 0. "Si l'equip que tenim ara definit com a màxim ja no ho és, cal actualitzar-lo, busquem l'altre equip amb el mateix tipus de càrrec
          READ TABLE lt_graella_equip ASSIGNING FIELD-SYMBOL(<fs_equip_carrec>) WITH KEY z_comptador_equip = <lv_comptador_equip2>.
          IF sy-subrc = 0.
            READ TABLE lt_max_punts_carrec ASSIGNING FIELD-SYMBOL(<fs_max_carrec>) WITH KEY z_carrec_equip = <fs_equip_carrec>-z_carrec_equip.
            IF sy-subrc = 0.
*              <lv_comptador_equip2> = <fs_max_carrec>-z_comptador_equip.
              DATA(lv_comptador_equip) = <fs_max_carrec>-z_comptador_equip.
              lv_pes                   = <fs_max_carrec>-z_pes.
            ENDIF.
          ENDIF.
        ENDIF.
***       "A més a més es modifica la puntuació de cada criteri i la del total de l'equip (només dels millor puntuats)
        DATA(lt_puntuacio_aux)          = lt_puntuacio_apartat_multiple.
        DATA(lt_puntuacio_apartat_aux2) = lt_puntuacio_apartat_multiple.
        LOOP AT lt_puntuacio_aux ASSIGNING FIELD-SYMBOL(<fs_aux_punt_2>) WHERE z_codi_crit_punt = <lv_crit_punt>.
          CLEAR: lt_puntuacio_apartat_aux2[].
          CLEAR: lv_punt, lv_punt_aux.
          LOOP AT lt_puntuacio_apartat_multiple ASSIGNING FIELD-SYMBOL(<fs_punt_sel_2>) WHERE z_codi_crit_punt = <fs_aux_punt_2>-z_codi_crit_punt
                                                                                          AND z_num_equip      = lv_comptador_equip.
            IF lv_pes IS INITIAL.
              lv_pes = 100.
            ENDIF.
            lv_operacion  = CONV #( <fs_punt_sel_2>-z_punts ).
            IF <lv_comptador_equip2> IS NOT INITIAL.
              lv_punt = lv_operacion.
            ELSE.
              lv_punt       = lv_punt + ( lv_operacion * ( lv_pes / 100 ) ).
            ENDIF.
            <fs_punt_sel_2>-z_punts_no_pond = lv_punt.
            APPEND <fs_punt_sel_2> TO lt_puntuacio_apartat_aux2.
          ENDLOOP.
          lv_punt_aux  = lv_punt.
          REPLACE ALL OCCURRENCES OF '.' IN lv_punt_aux WITH ','.
          <lv_punt> = lv_punt_aux.

          SELECT SINGLE z_mult_rec
            FROM zrm_dm_crit_punt
            INTO @DATA(lv_mult_rec2)
              WHERE z_mod_crit_punt  EQ @lv_mod_punt
                AND z_codi_crit_punt EQ @<fs_aux_punt_2>-z_codi_crit_punt.
**        >> INI MODIF ETODR SPEC-49500
          SELECT COUNT(*)
            FROM zrm_dt_punt_equi
              WHERE z_mod_crit_punt  EQ @lv_mod_punt
                AND z_codi_crit_punt EQ @<fs_aux_punt_2>-z_codi_crit_punt.
          IF sy-subrc = 0.
            DATA(lv_mult_equip2) = abap_on.
          ENDIF.
          "Actualitzar taula amb valors seleccionats per a poder desar-la al SAVE / CONFIRMAR DADES
          my_backend->set_punt_subapart( it_dades_subapart = lt_puntuacio_apartat_aux2
                                         lv_punt           = lv_punt
                                         lv_mult_rec       = lv_mult_rec2
                                         is_mult_equip     = lv_mult_equip2 ).
        ENDLOOP.
      ENDIF.
    ENDDO.

    my_grid->check_changed_data( IMPORTING e_valid   = DATA(l_valid) ).

    TRY.
        me->recalculate( ).
      CATCH zcx_rm_valoracio .
        RETURN.
    ENDTRY.
  ENDMETHOD.


  METHOD hotspot_click_equip_coautor.
    FIELD-SYMBOLS: <lt_grid>      TYPE STANDARD TABLE.

    DATA: lt_equip                      TYPE zrm_tt_dt_punt_equi,
          lt_graella_criteris           TYPE zrm_cl_valoracio_ofertes=>ty_t_crit_punt,
          lt_puntuacio_apartat          TYPE zrm_cl_valoracio_ofertes=>ty_t_puntuacio_subapartats,
          lt_puntuacio_apartat_multiple TYPE zrm_cl_valoracio_ofertes=>ty_t_puntuacio_subapartats,
          wa_crit_punt                  TYPE zrm_cl_valoracio_ofertes=>ty_s_crit_punt,
          lt_punt_ofer_all_2_aux        TYPE zrm_cl_valoracio_ofertes=>ty_t_punt_ofer_dyn_equi,
          lt_puntuacio_apartat_aux      TYPE zrm_cl_valoracio_ofertes=>ty_t_puntuacio_subapartats,
          lt_punt_ofer_all_equi         TYPE zrm_cl_valoracio_ofertes=>ty_t_punt_ofer_dyn_equi,
          lt_punt_ofer_all_2            TYPE zrm_tt_dt_punt_ofer,
          wa_ofer_all                   TYPE zrm_cl_valoracio_ofertes=>ty_s_punt_ofer_dyn_equi,
          wa_motiv_mult                 TYPE zrm_cl_valoracio_ofertes=>ty_s_puntuacio_subapartats,
          lv_num_oferta                 TYPE z_num_ofer,
          ls_ref                        TYPE tabfield,
          lv_codi_comptador_equip       TYPE zrm_dt_punt_equi-z_comptador_equip,
          l_read_only                   TYPE xfeld,
          lv_punt_aux                   TYPE string,
          lv_punt                       TYPE z_punt_max,
          lv_operacion                  TYPE z_punt,
          lv_pes                        TYPE i,
          lv_crit_punt                  TYPE z_codi_crit_punt,
          lv_mod_punt                   TYPE z_mod_crit_punt,
          lt_columns                    TYPE ty_t_column.

*    BREAK-POINT.

    ls_ref-tabname   = 'ZRM_DT_PUNT_OFER' .
    ls_ref-fieldname = 'Z_PUNTS' .
    ASSIGN my_table_ref->* TO <lt_grid>.

    READ TABLE <lt_grid> ASSIGNING FIELD-SYMBOL(<ls_grid>) INDEX i_row_id.
    CHECK sy-subrc = 0.

    ASSIGN COMPONENT 'Z_CODI_CRIT_PUNT' OF STRUCTURE <ls_grid> TO FIELD-SYMBOL(<lv_crit_punt>).
    CHECK sy-subrc  = 0.
    lv_crit_punt    = <lv_crit_punt>.
    ASSIGN COMPONENT 'Z_MOD_CRIT_PUNT'  OF STRUCTURE <ls_grid> TO FIELD-SYMBOL(<lv_mod_punt>). "
    CHECK sy-subrc  = 0.
    lv_mod_punt     = <lv_mod_punt>.



****"Per tal de montar la finestra amb les dades de l'equip a puntuar per a la oferta clicada, es recuperarà:
****"1-Dades oferta
    ASSIGN COMPONENT i_column_id OF STRUCTURE <ls_grid> TO FIELD-SYMBOL(<lv_punt>).     "Recollir empresa
    CHECK sy-subrc = 0.

    LOOP AT my_columns ASSIGNING FIELD-SYMBOL(<fs_column_sel>) WHERE fieldname = i_column_id.
      lv_num_oferta = <fs_column_sel>-key.
      EXIT.
    ENDLOOP.
    CHECK lv_num_oferta IS NOT INITIAL.
****"2-Membres de l'equip actuals (equip bàsic + addicionals)
    my_backend->get_dades_ofer_dyn( IMPORTING ex_punt_ofer_dyn      = DATA(lt_punt_ofer_all)
                                              ex_punt_ofer_dyn_equi = DATA(lt_graella_equip) ).
    "ens quedem únicament amb les dades de l'equip i de puntuació de la oferta en qüestió
    DELETE lt_graella_equip WHERE z_num_ofer <> lv_num_oferta.
    DELETE lt_punt_ofer_all WHERE z_num_ofer <> lv_num_oferta.

    ">> SPEC-66771, Inici Modificació - ETODR
    IF lv_mod_punt IS INITIAL.
      READ TABLE lt_punt_ofer_all INTO DATA(ls_punt_ofer) INDEX 1.
      lv_mod_punt = ls_punt_ofer-z_mod_crit_punt.
    ENDIF.
    "Si estem puntuant un equip "Separat" hem d'eliminar els criteris d'altres equips
    ASSIGN COMPONENT 'Z_EQUIP_SEP'  OF STRUCTURE <ls_grid> TO FIELD-SYMBOL(<fs_equip_sep>).
    IF sy-subrc = 0 AND <fs_equip_sep> = abap_on." AND lv_crit_punt IS NOT INITIAL.
      DATA(lv_equip_sep_pdm) = abap_on.
      ASSIGN COMPONENT 'Z_CODI_CRIT_PUNT_EQUIP_SEP' OF STRUCTURE <ls_grid> TO <lv_crit_punt>.
      CHECK sy-subrc  = 0.
      lv_crit_punt = <lv_crit_punt>.

      my_backend->get_crit_dyn_rel( IMPORTING ex_crit_dyn_rel = DATA(lt_crit_relations) ).

      "De tots els equips que hi ha, ens quedem amb aquell del criteri que han clicat
      DELETE lt_crit_relations WHERE z_parent <> lv_crit_punt.
      LOOP AT lt_graella_equip ASSIGNING FIELD-SYMBOL(<fs_graella_equip>).
        READ TABLE lt_crit_relations TRANSPORTING NO FIELDS WITH KEY z_parent = <fs_graella_equip>-z_codi_crit_punt.
        IF sy-subrc = 0.
          CONTINUE.
        ENDIF.
        READ TABLE lt_crit_relations TRANSPORTING NO FIELDS WITH KEY z_child = <fs_graella_equip>-z_codi_crit_punt.
        IF sy-subrc = 0.
          CONTINUE.
        ENDIF.
        DELETE lt_graella_equip.
      ENDLOOP.

      LOOP AT lt_punt_ofer_all ASSIGNING FIELD-SYMBOL(<fs_punt_offer_all>).
        READ TABLE lt_crit_relations TRANSPORTING NO FIELDS WITH KEY z_parent = <fs_punt_offer_all>-z_codi_crit_punt.
        IF sy-subrc = 0.
          CONTINUE.
        ENDIF.
        READ TABLE lt_crit_relations TRANSPORTING NO FIELDS WITH KEY z_child = <fs_punt_offer_all>-z_codi_crit_punt.
        IF sy-subrc = 0.
          CONTINUE.
        ENDIF.
        DELETE lt_punt_ofer_all.
      ENDLOOP.
    ENDIF.
    "<< SPEC-66771, Final Modificació - ETODR

*>> SPEC-53130, Inici modificació - ETLJS
    IF lt_graella_equip IS NOT INITIAL.
      SELECT z_codi_crit_punt, z_ponderacio
      INTO TABLE @DATA(lt_equip_sep)
            FROM zrm_dm_crit_punt
            FOR ALL ENTRIES IN @lt_graella_equip
            WHERE z_mod_crit_punt = @lt_graella_equip-z_mod_crit_punt
            AND z_codi_crit_punt = @lt_graella_equip-z_codi_crit_punt
            AND z_equip_sep = @abap_true.
    ENDIF.

*<< SPEC-53130, Final modificació - ETLJS
    DATA(lt_equip_disticnt) = lt_graella_equip[].
    SORT lt_equip_disticnt BY z_codi_crit_punt.
    DELETE ADJACENT DUPLICATES FROM lt_equip_disticnt COMPARING z_codi_crit_punt.


    CHECK lt_equip_disticnt[] IS NOT INITIAL.
    SELECT *
      FROM zrm_dm_crit_punt
      INTO TABLE @DATA(lt_dm_crit_punt)
      FOR ALL ENTRIES IN @lt_equip_disticnt
      WHERE z_mod_crit_punt   = @lt_equip_disticnt-z_mod_crit_punt
        AND z_codi_crit_punt  = @lt_equip_disticnt-z_codi_crit_punt.

    TRY.
        DATA(lt_crit_aux_punt) = my_backend->get_crit_punt_offers_equi( ).
      CATCH cx_root.
        RETURN.
    ENDTRY.

    LOOP AT lt_equip_disticnt ASSIGNING FIELD-SYMBOL(<fs_crit_equip>).
      LOOP AT lt_crit_aux_punt INTO wa_crit_punt WHERE z_codi_crit_punt EQ <fs_crit_equip>-z_codi_crit_punt.
        READ TABLE lt_dm_crit_punt INTO DATA(ls_dm_crit_punt) WITH KEY z_codi_crit_punt = <fs_crit_equip>-z_codi_crit_punt.
        wa_crit_punt-z_descripcio = ls_dm_crit_punt-z_descripcio.
        APPEND wa_crit_punt TO lt_graella_criteris.
      ENDLOOP.
    ENDLOOP.


    LOOP AT lt_equip_disticnt ASSIGNING FIELD-SYMBOL(<fs_crit_punt>).
      LOOP AT lt_punt_ofer_all ASSIGNING FIELD-SYMBOL(<fs_ofer_all>) WHERE z_codi_crit_punt = <fs_crit_punt>-z_codi_crit_punt
                                                                       AND z_no_aplica      = abap_off
                                                                       AND z_num_ofer       = lv_num_oferta.
        CLEAR: wa_ofer_all.
        MOVE-CORRESPONDING <fs_ofer_all> TO wa_ofer_all.
        APPEND wa_ofer_all TO lt_punt_ofer_all_2_aux.
        APPEND <fs_ofer_all> TO lt_punt_ofer_all_2.
      ENDLOOP.
    ENDLOOP.
    lt_punt_ofer_all[]      = lt_punt_ofer_all_2[].
    lt_punt_ofer_all_equi[] = lt_punt_ofer_all_2_aux[].

****"3-Puntuació criteris que formen l'equip
    my_backend->get_motivacio_multi( IMPORTING et_motiv_mult = DATA(lt_motiv_mult) ).
    CLEAR: lt_puntuacio_apartat_multiple[].
    LOOP AT lt_motiv_mult ASSIGNING FIELD-SYMBOL(<fs_motiv_mult>).
      MOVE-CORRESPONDING <fs_motiv_mult> TO wa_motiv_mult.
      APPEND wa_motiv_mult TO lt_puntuacio_apartat_multiple.
    ENDLOOP.

    ">>>SPEC-56253, Inici modificació  - ETODR
    IF my_read_only IS NOT INITIAL OR  my_backend->check_activity( my_backend_activities-save_punct ) IS INITIAL.
      l_read_only = abap_on.
    ENDIF.
    "<<<SPEC-56253, Final modificació - ETODR
    DATA: lt_max_punts_carrec TYPE ztt_equip_max,
          lt_punts_offer      TYPE zrm_cl_valoracio_ofertes=>ty_t_punt_gen.

    ">>>SPEC:56622, Inici modificació  - ECFA
    "Cada vegada que passerm per aqui, incrementem el comptador +1
    ADD 1 TO gv_pools.
    "si hem passat per aqui més que el nombre de vegades que hi ha a la variable
    "gv_maxpools llavors sortim.
    IF gv_pools >= gv_maxpools.
      "mostem un missatge a l'usuari.
      MESSAGE text-008 TYPE 'I'.
      RETURN.
    ENDIF.
    "<<<SPEC:56622, Final modificació - ECFA

    ">> SPEC-66771, Inici Modificació - ETODR
    IF lv_equip_sep_pdm = abap_off.
      "<< SPEC-66771, Final Modificació - ETODR
      IF <lv_punt> IS ASSIGNED.

        LOOP AT lt_graella_criteris
          ASSIGNING FIELD-SYMBOL(<fs_gr_cri>)
          WHERE z_descripcio NE <lv_punt> AND
                z_equip_sep  EQ abap_true.

          DELETE lt_graella_equip
           WHERE z_codi_crit_punt = <fs_gr_cri>-z_codi_crit_punt.

        ENDLOOP.
        DELETE lt_graella_criteris WHERE z_descripcio NE <lv_punt> AND
                                         z_equip_sep  EQ abap_true.


      ENDIF.

      IF lt_equip_sep IS NOT INITIAL.
        DATA(lt_equip_aux) = lt_graella_equip.
        CLEAR lt_graella_equip.
        LOOP AT lt_equip_aux ASSIGNING FIELD-SYMBOL(<fs_eq_s>).
          READ TABLE lt_equip_sep TRANSPORTING NO FIELDS
            WITH KEY z_codi_crit_punt = <fs_eq_s>-z_codi_crit_punt.
          IF sy-subrc EQ 0.
            APPEND <fs_eq_s> TO lt_graella_equip.
          ENDIF.

        ENDLOOP.

      ENDIF.
    ENDIF.

    CALL FUNCTION 'ZRM_PUNTUA_EQUIP_COAUTORS'
      EXPORTING
        im_mod_crit           = lv_mod_punt
        im_docclass           = gv_docclass
        im_objectid           = gv_objectid
        im_num_ofer           = lv_num_oferta
        it_graella_criteris   = lt_graella_criteris
        it_graella_equip      = lt_graella_equip
        it_punt_ofer_equi     = lt_punt_ofer_all_equi
        im_backend            = my_backend
        im_column             = <fs_column_sel>
        im_grid               = <ls_grid>
        i_readonly            = l_read_only
      IMPORTING
*       et_max_punts_carrec   = lt_max_punts_carrec
        et_equip_act          = lt_equip
        et_punts_offer        = lt_punts_offer
      CHANGING
        ct_puntuacio_multiple = lt_puntuacio_apartat_multiple
      EXCEPTIONS
        not_changed           = 1
        other                 = 2.
    CHECK sy-subrc = 0.

    my_backend->set_new_equip( lt_equip ).
    my_backend->set_punts_gen_equi( lt_punts_offer ).

    IF lt_puntuacio_apartat_multiple IS NOT INITIAL.
      my_backend->set_motivacio_mult( it_dades_subapart = lt_puntuacio_apartat_multiple ).
    ENDIF.

    IF lt_equip_sep IS INITIAL.
      "Per cada criteri puntuar actualitzar LT_GRID..
      DESCRIBE TABLE <lt_grid> LINES DATA(l_num).
      DO l_num TIMES.
        DATA(l_index) = sy-index.
        READ TABLE <lt_grid> ASSIGNING <ls_grid> INDEX l_index.
        IF sy-subrc = 0.
          ASSIGN COMPONENT 'Z_CODI_CRIT_PUNT' OF STRUCTURE <ls_grid> TO <lv_crit_punt>.
          CHECK sy-subrc = 0.
          ASSIGN COMPONENT 'Z_MOD_CRIT_PUNT'  OF STRUCTURE <ls_grid> TO <lv_mod_punt>.
          CHECK sy-subrc = 0.
          ASSIGN COMPONENT 'Z_DESCRIPCIO' OF STRUCTURE <ls_grid> TO FIELD-SYMBOL(<lv_descripcio>).
          CHECK sy-subrc = 0.
          ASSIGN COMPONENT i_column_id    OF STRUCTURE <ls_grid> TO <lv_punt>.
          CHECK sy-subrc = 0.
          ASSIGN COMPONENT 'Z_COMPTADOR_EQUIP' OF STRUCTURE <ls_grid> TO FIELD-SYMBOL(<lv_comptador_equip>).     "Comptador d'equip
          CHECK sy-subrc = 0.
**        >> INI MODIF ETODR SPEC-61754
          "Tot això d'aquí baix fa pinta que no serveix per a res...
          CHECK <lv_comptador_equip> IS NOT INITIAL.
**        << FI MODIF ETODR SPEC-61754
          DATA(lt_puntuacio_aux)          = lt_puntuacio_apartat_multiple.
          DATA(lt_puntuacio_apartat_aux2) = lt_puntuacio_apartat_multiple.
          LOOP AT lt_puntuacio_aux ASSIGNING FIELD-SYMBOL(<fs_aux_punt_2>) WHERE z_codi_crit_punt = <lv_crit_punt>.
            CLEAR: lt_puntuacio_apartat_aux2[].
            CLEAR: lv_punt, lv_punt_aux.
            LOOP AT lt_puntuacio_apartat_multiple ASSIGNING FIELD-SYMBOL(<fs_punt_sel_2>)
              WHERE z_codi_crit_punt CS <fs_aux_punt_2>-z_codi_crit_punt
                AND z_num_equip      = <lv_comptador_equip>.
              IF lv_pes IS INITIAL.
                lv_pes = 100.
              ENDIF.
              lv_operacion  = CONV #( <fs_punt_sel_2>-z_punts ).
              IF <lv_comptador_equip> IS NOT INITIAL.
                lv_punt = lv_operacion.
              ELSE.
                lv_punt       = lv_punt + ( lv_operacion * ( lv_pes / 100 ) ).
              ENDIF.
              <fs_punt_sel_2>-z_punts_no_pond = lv_punt.
              APPEND <fs_punt_sel_2> TO lt_puntuacio_apartat_aux2.
            ENDLOOP.

            lv_punt_aux  = lv_punt.
            REPLACE ALL OCCURRENCES OF '.' IN lv_punt_aux WITH ','.
            <lv_punt> = lv_punt_aux.

            SELECT SINGLE z_mult_rec
              FROM zrm_dm_crit_punt
              INTO @DATA(lv_mult_rec2)
                WHERE z_mod_crit_punt  EQ @lv_mod_punt
                  AND z_codi_crit_punt EQ @<fs_aux_punt_2>-z_codi_crit_punt.

            SELECT COUNT(*)
              FROM zrm_dt_punt_equi
                WHERE z_mod_crit_punt  EQ @lv_mod_punt
                  AND z_codi_crit_punt EQ @<fs_aux_punt_2>-z_codi_crit_punt.
            IF sy-subrc = 0.
              DATA(lv_mult_equip2) = abap_on.
            ENDIF.
            "Actualitzar taula amb valors seleccionats per a poder desar-la al SAVE / CONFIRMAR DADES
            my_backend->set_punt_subapart( it_dades_subapart = lt_puntuacio_apartat_aux2
                                           lv_punt           = lv_punt
                                           lv_mult_rec       = lv_mult_rec2
                                           is_mult_equip     = lv_mult_equip2 ).
          ENDLOOP.

        ENDIF.
      ENDDO.

*>> SPEC-53130, Inici modificació - ETLJS
    ELSE.
      lt_puntuacio_apartat_aux2 = lt_puntuacio_apartat_multiple.

      LOOP AT lt_graella_equip ASSIGNING FIELD-SYMBOL(<fs_g_e>).
        DELETE lt_equip WHERE z_codi_crit_punt NE <fs_g_e>-z_codi_crit_punt.
        EXIT.
      ENDLOOP.

      my_backend->set_punt_subapart(
          it_dades_subapart = lt_puntuacio_apartat_aux2
          it_equip_sep      = lt_equip
          lv_punt           = lv_punt
          lv_mult_rec       = lv_mult_rec2
          is_mult_equip     = lv_mult_equip2
          iv_num_oferta     = lv_num_oferta ).
    ENDIF.
*<< SPEC-53130, Final modificació - ETLJS


    my_grid->check_changed_data( IMPORTING e_valid   = DATA(l_valid) ).

    TRY.
        me->recalculate( ).
      CATCH zcx_rm_valoracio .
        RETURN.
    ENDTRY.


  ENDMETHOD.


  METHOD hotspot_click_exloure.
    FIELD-SYMBOLS: <lt_grid>      TYPE STANDARD TABLE.

    DATA: lv_num_oferta TYPE z_num_ofer,
          ls_ref        TYPE tabfield,
          lcx_valoracio TYPE REF TO zcx_rm_valoracio,
          l_read_only   TYPE xfeld.

***>>> INICI Insert SPEC-49806 ETXGL
    TYPES: BEGIN OF ls_zrm_dt_punt_equi,
             z_exclos          TYPE zrm_dt_punt_equi-z_exclos,
             z_carrec_equip    TYPE zrm_dt_punt_equi-z_carrec_equip,
             z_codi_crit_punt  TYPE zrm_dt_punt_equi-z_codi_crit_punt,
             z_descripcio      TYPE z_descrip120,
             z_comptador_equip TYPE zrm_dt_punt_equi-z_comptador_equip,
             z_mod_crit_punt   TYPE zrm_dt_punt_equi-z_mod_crit_punt,
           END OF ls_zrm_dt_punt_equi.

    DATA: lt_zrm_dt_punt_equi TYPE ztt_punt_equ,
          wa_zrm_dt_punt_equi TYPE zty_punt_equ.

*    DATA: lt_zrm_dt_punt_equi TYPE TABLE OF ls_zrm_dt_punt_equi,
*          wa_zrm_dt_punt_equi TYPE ls_zrm_dt_punt_equi.
    DATA: zrm_dt_punt_equi TYPE ls_zrm_dt_punt_equi.
    DATA: lv_decripcio TYPE zrm_dt_punt_equi-z_descripcio.
    DATA: lv_modif_equip(1) TYPE c.
    DATA: wa_fieldcat TYPE slis_fieldcat_alv,
          lt_fcat     TYPE  slis_t_fieldcat_alv,
          wa_selected TYPE slis_selfield.
    DATA: lt_excl TYPE slis_t_extab,
          ls_excl TYPE slis_extab.

    DATA: lv_exit TYPE c.
***<<< FI Insert SPEC-49806 ETXGL

    ls_ref-tabname   = 'ZRM_DT_PUNT_OFER' .
    ls_ref-fieldname = 'Z_PUNTS' .
    ASSIGN my_table_ref->* TO <lt_grid>.

    READ TABLE <lt_grid> ASSIGNING FIELD-SYMBOL(<ls_grid>) INDEX i_row_id.
    CHECK sy-subrc = 0.

    .
    "Recollim empresa
*    LOOP AT my_columns ASSIGNING FIELD-SYMBOL(<fs_column_sel>) WHERE fieldname = i_column_id.
*      lv_num_oferta = <fs_column_sel>-key.
*      EXIT.
*    ENDLOOP.
*    CHECK lv_num_oferta IS NOT INITIAL.

***>>> INICI Insert SPEC-49806 ETXGL
    "Creem el Fieldcat de la ALV
    CLEAR wa_fieldcat.
    wa_fieldcat-fieldname = 'Z_EXCLOS'.
    wa_fieldcat-tabname   = 'LT_ZRM_DT_PUNT_EQUI'.
    wa_fieldcat-col_pos   = 1.
    wa_fieldcat-just      = 'C'.
    wa_fieldcat-input     = 'X'.
    wa_fieldcat-edit      = 'X'.
    wa_fieldcat-checkbox  = 'X'.
    wa_fieldcat-outputlen = 10.
    wa_fieldcat-seltext_l = 'Exclòs'.
    wa_fieldcat-seltext_m = 'Exclòs'.
    wa_fieldcat-seltext_s = 'Exclòs'.

    APPEND wa_fieldcat TO lt_fcat.
    CLEAR wa_fieldcat.
    wa_fieldcat-fieldname = 'Z_CARREC_EQUIP'.
    wa_fieldcat-tabname   = 'LT_ZRM_DT_PUNT_EQUI'.
    wa_fieldcat-col_pos   = 2.
    wa_fieldcat-just      = 'C'.
    wa_fieldcat-outputlen = 20.
    wa_fieldcat-edit_mask = '==CARRE'.
    wa_fieldcat-seltext_l = 'Càrrec Equip'.
    wa_fieldcat-seltext_m = 'Càrrec Equip'.
    wa_fieldcat-seltext_s = 'Càrrec Equip'.
    APPEND wa_fieldcat TO lt_fcat.

*    CLEAR wa_fieldcat.
*    wa_fieldcat-fieldname = 'Z_CODI_CRIT_PUNT'.
*    wa_fieldcat-tabname   = 'LT_ZRM_DT_PUNT_EQUI'.
*    wa_fieldcat-col_pos   = 3.
*    wa_fieldcat-just      = 'L'.
*    wa_fieldcat-outputlen = 14.
*    wa_fieldcat-seltext_l = 'Criteri Puntuació'.
*    wa_fieldcat-seltext_m = 'Criteri Puntuació'.
*    wa_fieldcat-seltext_s = 'Criteri Puntuació'.
*    APPEND wa_fieldcat TO lt_fcat.

    CLEAR wa_fieldcat.
    wa_fieldcat-fieldname = 'Z_DESCRIPCIO'.
    wa_fieldcat-tabname   = 'LT_ZRM_DT_PUNT_EQUI'.
    wa_fieldcat-col_pos   = 4.
    wa_fieldcat-just     = 'L'.
    wa_fieldcat-outputlen = 85.
    wa_fieldcat-seltext_l = 'Descripció'.
    wa_fieldcat-seltext_m = 'Descripció'.
    wa_fieldcat-seltext_s = 'Descripció'.
    APPEND wa_fieldcat TO lt_fcat.

    "Creem Exclusions del Toolbar
    ls_excl-fcode = '&ALL'. APPEND ls_excl TO lt_excl.
    ls_excl-fcode = '&SAL'. APPEND ls_excl TO lt_excl.
    ls_excl-fcode = '&ETA'. APPEND ls_excl TO lt_excl.
    ls_excl-fcode = '%SC'.  APPEND ls_excl TO lt_excl.
    ls_excl-fcode = '%SC+'. APPEND ls_excl TO lt_excl.
    ls_excl-fcode = '&OUP'. APPEND ls_excl TO lt_excl.
    ls_excl-fcode = '&ODN'. APPEND ls_excl TO lt_excl.
    ls_excl-fcode = '&ILT'. APPEND ls_excl TO lt_excl.
    ls_excl-fcode = '&OL0'. APPEND ls_excl TO lt_excl.
    ls_excl-fcode = '&CRB'. APPEND ls_excl TO lt_excl.
    ls_excl-fcode = '&CRL'. APPEND ls_excl TO lt_excl.
    ls_excl-fcode = '&CRR'. APPEND ls_excl TO lt_excl.
    ls_excl-fcode = '&CRE'. APPEND ls_excl TO lt_excl.



*    READ TABLE gt_ofertes_modif INTO gs_ofertes_modif WITH KEY z_num_ofer = gs_ofertes-z_num_ofer.
    LOOP AT my_columns ASSIGNING FIELD-SYMBOL(<fs_column>) WHERE fieldname = i_column_id.
      lv_num_oferta = <fs_column>-key.
      CHECK lv_num_oferta IS NOT INITIAL.

      REFRESH lt_zrm_dt_punt_equi.
      CLEAR lt_zrm_dt_punt_equi.

      my_backend->get_equip( EXPORTING  iv_num_ofer     = lv_num_oferta
                                        iv_per_excloure = abap_on
                             IMPORTING  et_equip        = lt_zrm_dt_punt_equi ).

*      SELECT z_exclos z_carrec_equip z_codi_crit_punt z_descripcio z_comptador_equip z_mod_crit_punt
*       FROM zrm_dt_punt_equi
*        INTO CORRESPONDING FIELDS OF TABLE lt_zrm_dt_punt_equi
*          WHERE docclass = gv_docclass
*            AND objectid = gv_objectid
*            AND z_num_ofer = lv_num_oferta.

    ENDLOOP.

    IF lt_zrm_dt_punt_equi IS NOT INITIAL.

*      CLEAR wa_zrm_dt_punt_equi.
*
*      LOOP AT lt_zrm_dt_punt_equi INTO wa_zrm_dt_punt_equi.
*        CLEAR lv_decripcio.
*        SELECT SINGLE z_descripcio
*         FROM zrm_dm_crit_punt
*           INTO lv_decripcio
*            WHERE z_mod_crit_punt = wa_zrm_dt_punt_equi-z_mod_crit_punt
*             AND z_codi_crit_punt = wa_zrm_dt_punt_equi-z_codi_crit_punt.
*
*        IF wa_zrm_dt_punt_equi-z_descripcio EQ 'DO1'.
*          CONCATENATE 'Director Obra DO1' lv_decripcio INTO wa_zrm_dt_punt_equi-z_descripcio SEPARATED BY space.
*          MODIFY lt_zrm_dt_punt_equi FROM wa_zrm_dt_punt_equi.
*        ELSEIF wa_zrm_dt_punt_equi-z_descripcio EQ 'T1'.
*          CONCATENATE 'Tècnic t1' lv_decripcio INTO wa_zrm_dt_punt_equi-z_descripcio SEPARATED BY space.
*          MODIFY lt_zrm_dt_punt_equi FROM wa_zrm_dt_punt_equi.
*        ELSE.
*        ENDIF.
*      ENDLOOP.

      CALL FUNCTION 'REUSE_ALV_POPUP_TO_SELECT'
        EXPORTING
          i_title               = 'Valoració de Criteris Tècnics'
          i_tabname             = 'LT_ZRM_DT_PUNT_EQUI'
          it_fieldcat           = lt_fcat
          it_excluding          = lt_excl
          i_selection           = 'X'
          I_ALLOW_NO_SELECTION  = 'X'
          i_checkbox_fieldname  = 'Z_EXCLOS'
          i_zebra               = 'X'
          i_screen_start_column = 5
          i_screen_start_line   = 8
          i_screen_end_column   = 140
          i_screen_end_line     = 15
        IMPORTING
          es_selfield           = wa_selected
        TABLES
          t_outtab              = lt_zrm_dt_punt_equi
        EXCEPTIONS
          program_error         = 1
          OTHERS                = 2.

      IF sy-subrc <> 0.
*        MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
*        WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
      ELSE.

        IF sy-xcode = '&NT1'. " Acceptar

          CLEAR wa_zrm_dt_punt_equi.
          CLEAR lv_modif_equip.

          READ TABLE lt_zrm_dt_punt_equi TRANSPORTING NO FIELDS WITH KEY z_exclos = 'X'.

          IF sy-subrc EQ 0.
            lv_modif_equip = 'X'.
          ELSE.
            CLEAR lv_modif_equip.
          ENDIF.

          my_backend->set_te_exclusio_plec_equip( i_num_ofer    = lv_num_oferta
                                                  i_modif_equip = lv_modif_equip
                                                  it_equip      = lt_zrm_dt_punt_equi ).


        ELSE.
          CLEAR lt_zrm_dt_punt_equi.

        ENDIF.

      ENDIF.

    ELSE.
    ENDIF.
***<<< FI Insert SPEC-49806 ETXGL



*    my_backend->set_te_exclusio_clausula_plec( i_num_ofer = lv_num_oferta ).      " Modif. SPEC-49806 ETXGL


  ENDMETHOD.


  METHOD hotspot_click_incr.

    FIELD-SYMBOLS: <lt_grid> TYPE STANDARD TABLE.

    DATA: lt_incr                       TYPE ztt_punt_incr,
          lt_graella_criteris           TYPE zrm_cl_valoracio_ofertes=>ty_t_crit_punt,
          lt_puntuacio_apartat          TYPE zrm_cl_valoracio_ofertes=>ty_t_puntuacio_subapartats,
          lt_puntuacio_apartat_multiple TYPE zrm_cl_valoracio_ofertes=>ty_t_puntuacio_subapartats,
          wa_crit_punt                  TYPE zrm_cl_valoracio_ofertes=>ty_s_crit_punt,
          lt_punt_ofer_all_2_aux        TYPE zrm_cl_valoracio_ofertes=>ty_t_punt_ofer_dyn_equi,
          lt_puntuacio_apartat_aux      TYPE zrm_cl_valoracio_ofertes=>ty_t_puntuacio_subapartats,
          lt_punt_ofer_all_2            TYPE zrm_tt_dt_punt_ofer,
          wa_ofer_all                   TYPE zrm_cl_valoracio_ofertes=>ty_s_punt_ofer_dyn_equi,
          wa_motiv_mult                 TYPE zrm_cl_valoracio_ofertes=>ty_s_puntuacio_subapartats,
          lv_num_oferta                 TYPE z_num_ofer,
          ls_ref                        TYPE tabfield,
          l_read_only                   TYPE xfeld,
          lv_punt_aux                   TYPE string,
          lv_punt                       TYPE z_punt_max,
          lv_operacion                  TYPE z_punt,
          lv_pes                        TYPE i,
          lv_crit_punt                  TYPE z_codi_crit_punt,
          lv_mod_punt                   TYPE z_mod_crit_punt,
          lt_columns                    TYPE ty_t_column,
          lt_punts_offer                TYPE zrm_cl_valoracio_ofertes=>ty_t_punt_gen.

    ls_ref-tabname   = 'ZRM_DT_PUNT_OFER' .
    ls_ref-fieldname = 'Z_PUNTS' .

    ASSIGN my_table_ref->* TO <lt_grid>.

    READ TABLE <lt_grid> ASSIGNING FIELD-SYMBOL(<ls_grid>) INDEX i_row_id.
    CHECK sy-subrc = 0.

    ASSIGN COMPONENT 'Z_CODI_CRIT_PUNT' OF STRUCTURE <ls_grid>
     TO FIELD-SYMBOL(<lv_crit_punt>).
    CHECK sy-subrc  = 0.
    lv_crit_punt    = <lv_crit_punt>.
    ASSIGN COMPONENT 'Z_MOD_CRIT_PUNT'  OF STRUCTURE <ls_grid>
     TO FIELD-SYMBOL(<lv_mod_punt>). "
    CHECK sy-subrc  = 0.

    lv_mod_punt     = <lv_mod_punt>.

****"Per tal de montar la finestra amb les dades de l'equip a puntuar per a la
*    oferta clicada, es recuperarà:

****"1-Dades oferta
    ASSIGN COMPONENT i_column_id OF STRUCTURE <ls_grid>
     TO FIELD-SYMBOL(<lv_punt>).     "Recollir empresa

    CHECK sy-subrc = 0.
    LOOP AT my_columns ASSIGNING FIELD-SYMBOL(<fs_column_sel>) WHERE fieldname = i_column_id.
      lv_num_oferta = <fs_column_sel>-key.
      EXIT.
    ENDLOOP.
    CHECK lv_num_oferta IS NOT INITIAL.

****"2-Idoneïtat del cap
    my_backend->check_dades_incr( EXPORTING  iv_num_ofer = lv_num_oferta
                                  EXCEPTIONS not_imin    = 1
                                             OTHERS      = 2 ).
    IF sy-subrc <> 0.
      MESSAGE 'No s''ha introduit el IMIN per a la licitació' TYPE 'I'.
      EXIT.
    ENDIF.
    my_backend->get_dades_ofer_dyn(
          IMPORTING ex_punt_ofer_dyn      = DATA(lt_punt_ofer_all)
                    ex_punt_ofer_dyn_incr = DATA(lt_graella_incr)
                    es_incr               = DATA(lt_incr_aux) ).

    "ens quedem únicament amb les dades de l'equip i de puntuació de la oferta en qüestió

    DELETE lt_graella_incr WHERE z_num_ofer <> lv_num_oferta.
    DELETE lt_punt_ofer_all WHERE z_num_ofer <> lv_num_oferta.

    IF lt_graella_incr IS INITIAL.
      DATA: ls_incr TYPE zrm_dt_punt_incr.
      LOOP AT lt_incr_aux INTO ls_incr
        WHERE z_num_ofer IS INITIAL.
        ls_incr-z_num_ofer = lv_num_oferta.
        APPEND ls_incr TO lt_graella_incr.
      ENDLOOP.
    ENDIF.

    lt_punts_offer = my_backend->get_punt_offers( ).
    DELETE lt_punts_offer WHERE z_num_gen <> lv_num_oferta.
    LOOP AT lt_punts_offer ASSIGNING FIELD-SYMBOL(<fs>).
      READ TABLE lt_graella_incr TRANSPORTING NO FIELDS
        WITH KEY z_codi_crit_punt = <fs>-z_codi_crit_punt.
      IF sy-subrc <> 0.
        DELETE lt_punts_offer.
      ENDIF.
    ENDLOOP.

    IF my_read_only IS NOT INITIAL OR  my_backend->check_activity( my_backend_activities-save_punct ) IS INITIAL.
      l_read_only = abap_on.
    ENDIF.

    CALL FUNCTION 'ZRM_PUNTUA_INCR'
      EXPORTING
        im_mod_crit         = lv_mod_punt
        im_docclass         = gv_docclass
        im_objectid         = gv_objectid
        im_num_ofer         = lv_num_oferta
        it_graella_criteris = lt_graella_criteris
        it_graella_incr     = lt_graella_incr
        im_backend          = my_backend
        im_column           = <fs_column_sel>
        im_grid             = <ls_grid>
        i_readonly          = l_read_only
      IMPORTING
        et_incr             = lt_incr
        et_punts_offer      = lt_punts_offer
      EXCEPTIONS
        not_changed         = 1
        other               = 2.


    my_backend->set_punt_incr( it_punts_offer = lt_punts_offer
                                it_incr        = lt_incr ).


  ENDMETHOD.


  METHOD hotspot_click_mult_equip_incr.

    FIELD-SYMBOLS: <lt_grid> TYPE STANDARD TABLE.

    DATA: lt_equip                      TYPE zrm_tt_dt_punt_equi,
          lt_graella_criteris           TYPE zrm_cl_valoracio_ofertes=>ty_t_crit_punt,
          lt_puntuacio_apartat          TYPE zrm_cl_valoracio_ofertes=>ty_t_puntuacio_subapartats,
          lt_puntuacio_apartat_multiple TYPE zrm_cl_valoracio_ofertes=>ty_t_puntuacio_subapartats,
          wa_crit_punt                  TYPE zrm_cl_valoracio_ofertes=>ty_s_crit_punt,
          lt_punt_ofer_all_2_aux        TYPE zrm_cl_valoracio_ofertes=>ty_t_punt_ofer_dyn_equi,
          lt_puntuacio_apartat_aux      TYPE zrm_cl_valoracio_ofertes=>ty_t_puntuacio_subapartats,
          lt_punt_ofer_all_equi         TYPE zrm_cl_valoracio_ofertes=>ty_t_punt_ofer_dyn_equi,
          lt_punt_ofer_all_2            TYPE zrm_tt_dt_punt_ofer,
          wa_ofer_all                   TYPE zrm_cl_valoracio_ofertes=>ty_s_punt_ofer_dyn_equi,
          wa_motiv_mult                 TYPE zrm_cl_valoracio_ofertes=>ty_s_puntuacio_subapartats,
          lv_num_oferta                 TYPE z_num_ofer,
          ls_ref                        TYPE tabfield,
          lv_codi_comptador_equip       TYPE zrm_dt_punt_equi-z_comptador_equip,
          l_read_only                   TYPE xfeld,
          lv_punt_aux                   TYPE string,
          lv_punt                       TYPE z_punt_max,
          lv_operacion                  TYPE z_punt,
          lv_pes                        TYPE i,
          lv_crit_punt                  TYPE z_codi_crit_punt,
          lv_mod_punt                   TYPE z_mod_crit_punt,
          lt_columns                    TYPE ty_t_column.

*    BREAK-POINT.

    ls_ref-tabname   = 'ZRM_DT_PUNT_OFER' .
    ls_ref-fieldname = 'Z_PUNTS' .
    ASSIGN my_table_ref->* TO <lt_grid>.

    READ TABLE <lt_grid> ASSIGNING FIELD-SYMBOL(<ls_grid>) INDEX i_row_id.
    CHECK sy-subrc = 0.

    ASSIGN COMPONENT 'Z_CODI_CRIT_PUNT' OF STRUCTURE <ls_grid> TO FIELD-SYMBOL(<lv_crit_punt>).
    CHECK sy-subrc  = 0.
    lv_crit_punt    = <lv_crit_punt>.
    ASSIGN COMPONENT 'Z_MOD_CRIT_PUNT'  OF STRUCTURE <ls_grid> TO FIELD-SYMBOL(<lv_mod_punt>). "
    CHECK sy-subrc  = 0.
    lv_mod_punt     = <lv_mod_punt>.



****"Per tal de montar la finestra amb les dades de l'equip a puntuar per a la oferta clicada, es recuperarà:
****"1-Dades oferta
    ASSIGN COMPONENT i_column_id OF STRUCTURE <ls_grid> TO FIELD-SYMBOL(<lv_punt>).     "Recollir empresa
    CHECK sy-subrc = 0.

    LOOP AT my_columns ASSIGNING FIELD-SYMBOL(<fs_column_sel>) WHERE fieldname = i_column_id.
      lv_num_oferta = <fs_column_sel>-key.
      EXIT.
    ENDLOOP.
    CHECK lv_num_oferta IS NOT INITIAL.
****"2-Membres de l'equip actuals (equip bàsic + addicionals)
    my_backend->get_dades_ofer_dyn( IMPORTING ex_punt_ofer_dyn      = DATA(lt_punt_ofer_all)
                                              ex_punt_ofer_dyn_equi = DATA(lt_graella_equip) ).
    "ens quedem únicament amb les dades de l'equip i de puntuació de la oferta en qüestió
    DELETE lt_graella_equip WHERE z_num_ofer <> lv_num_oferta.
    DELETE lt_punt_ofer_all WHERE z_num_ofer <> lv_num_oferta.
*>> SPEC-53130, Inici modificació - ETLJS
    IF lt_graella_equip IS NOT INITIAL.
      SELECT z_codi_crit_punt, z_ponderacio
      INTO TABLE @DATA(lt_equip_sep)
            FROM zrm_dm_crit_punt
            FOR ALL ENTRIES IN @lt_graella_equip
            WHERE z_mod_crit_punt = @lt_graella_equip-z_mod_crit_punt
            AND z_codi_crit_punt = @lt_graella_equip-z_codi_crit_punt
            AND z_equip_sep = @abap_true.
    ENDIF.
*<< SPEC-53130, Final modificació - ETLJS
    DATA(lt_equip_disticnt) = lt_graella_equip[].
    SORT lt_equip_disticnt BY z_codi_crit_punt.
    DELETE ADJACENT DUPLICATES FROM lt_equip_disticnt COMPARING z_codi_crit_punt.

    CHECK lt_equip_disticnt[] IS NOT INITIAL.
    SELECT *
      FROM zrm_dm_crit_punt
      INTO TABLE @DATA(lt_dm_crit_punt)
      FOR ALL ENTRIES IN @lt_equip_disticnt
      WHERE z_mod_crit_punt   = @lt_equip_disticnt-z_mod_crit_punt
        AND z_codi_crit_punt  = @lt_equip_disticnt-z_codi_crit_punt.

    TRY.
        DATA(lt_crit_aux_punt) = my_backend->get_crit_punt_offers_equi( ).
      CATCH cx_root.
        RETURN.
    ENDTRY.

    LOOP AT lt_equip_disticnt ASSIGNING FIELD-SYMBOL(<fs_crit_equip>).
      LOOP AT lt_crit_aux_punt INTO wa_crit_punt WHERE z_codi_crit_punt EQ <fs_crit_equip>-z_codi_crit_punt.
        READ TABLE lt_dm_crit_punt INTO DATA(ls_dm_crit_punt) WITH KEY z_codi_crit_punt = <fs_crit_equip>-z_codi_crit_punt.
        wa_crit_punt-z_descripcio = ls_dm_crit_punt-z_descripcio.
        APPEND wa_crit_punt TO lt_graella_criteris.
      ENDLOOP.
    ENDLOOP.


    LOOP AT lt_equip_disticnt ASSIGNING FIELD-SYMBOL(<fs_crit_punt>).
      LOOP AT lt_punt_ofer_all ASSIGNING FIELD-SYMBOL(<fs_ofer_all>) WHERE z_codi_crit_punt = <fs_crit_punt>-z_codi_crit_punt
                                                                       AND z_no_aplica      = abap_off
                                                                       AND z_num_ofer       = lv_num_oferta.
        CLEAR: wa_ofer_all.
        MOVE-CORRESPONDING <fs_ofer_all> TO wa_ofer_all.
        APPEND wa_ofer_all TO lt_punt_ofer_all_2_aux.
        APPEND <fs_ofer_all> TO lt_punt_ofer_all_2.
      ENDLOOP.
    ENDLOOP.
    lt_punt_ofer_all[]      = lt_punt_ofer_all_2[].
    lt_punt_ofer_all_equi[] = lt_punt_ofer_all_2_aux[].

****"3-Puntuació criteris que formen l'equip
    my_backend->get_motivacio_multi( IMPORTING et_motiv_mult = DATA(lt_motiv_mult) ).
    CLEAR: lt_puntuacio_apartat_multiple[].
    LOOP AT lt_motiv_mult ASSIGNING FIELD-SYMBOL(<fs_motiv_mult>).
      MOVE-CORRESPONDING <fs_motiv_mult> TO wa_motiv_mult.
      APPEND wa_motiv_mult TO lt_puntuacio_apartat_multiple.
    ENDLOOP.

    ">>>SPEC-56253, Inici modificació  - ETODR
    IF my_read_only IS NOT INITIAL OR  my_backend->check_activity( my_backend_activities-save_punct ) IS INITIAL.
      l_read_only = abap_on.
    ENDIF.
    "<<<SPEC-56253, Final modificació - ETODR
    DATA: lt_max_punts_carrec TYPE ztt_equip_max,
          lt_punts_offer      TYPE zrm_cl_valoracio_ofertes=>ty_t_punt_gen.

    ">>>SPEC:56622, Inici modificació  - ECFA
    "Cada vegada que passerm per aqui, incrementem el comptador +1
    ADD 1 TO gv_pools.
    "si hem passat per aqui més que el nombre de vegades que hi ha a la variable
    "gv_maxpools llavors sortim.
    IF gv_pools >= gv_maxpools.
      "mostem un missatge a l'usuari.
      MESSAGE text-008 TYPE 'I'.
      RETURN.
    ENDIF.
    "<<<SPEC:56622, Final modificació - ECFA

    IF <lv_punt> IS ASSIGNED.

      LOOP AT lt_graella_criteris
        ASSIGNING FIELD-SYMBOL(<fs_gr_cri>)
        WHERE z_descripcio NE <lv_punt> AND
              z_equip_sep  EQ abap_true.

        DELETE lt_graella_equip
         WHERE z_codi_crit_punt = <fs_gr_cri>-z_codi_crit_punt.

      ENDLOOP.
      DELETE lt_graella_criteris WHERE z_descripcio NE <lv_punt> AND
                                       z_equip_sep  EQ abap_true.


    ENDIF.

    IF lt_equip_sep IS NOT INITIAL.
      DATA(lt_equip_aux) = lt_graella_equip.
      CLEAR lt_graella_equip.
      LOOP AT lt_equip_aux ASSIGNING FIELD-SYMBOL(<fs_eq_s>).
        READ TABLE lt_equip_sep TRANSPORTING NO FIELDS
          WITH KEY z_codi_crit_punt = <fs_eq_s>-z_codi_crit_punt.
        IF sy-subrc EQ 0.
          APPEND <fs_eq_s> TO lt_graella_equip.
        ENDIF.

      ENDLOOP.

    ENDIF.

    CALL FUNCTION 'ZRM_PUNTUA_MULT_EQUIP_INCR'
      EXPORTING
        im_mod_crit           = lv_mod_punt
        im_docclass           = gv_docclass
        im_objectid           = gv_objectid
        im_num_ofer           = lv_num_oferta
        it_graella_criteris   = lt_graella_criteris
        it_graella_equip      = lt_graella_equip
        it_punt_ofer_equi     = lt_punt_ofer_all_equi
        im_backend            = my_backend
        im_column             = <fs_column_sel>
        im_grid               = <ls_grid>
        i_readonly            = l_read_only
      IMPORTING
*       et_max_punts_carrec   = lt_max_punts_carrec
        et_equip_act          = lt_equip
        et_punts_offer        = lt_punts_offer
      CHANGING
        ct_puntuacio_multiple = lt_puntuacio_apartat_multiple
      EXCEPTIONS
        not_changed           = 1
        other                 = 2.
    CHECK sy-subrc = 0.

    my_backend->set_new_equip( lt_equip ).
    my_backend->set_punts_gen_equi( lt_punts_offer ).

    IF lt_puntuacio_apartat_multiple IS NOT INITIAL.
      my_backend->set_motivacio_mult( it_dades_subapart = lt_puntuacio_apartat_multiple ).
    ENDIF.

    IF lt_equip_sep IS INITIAL.
      "Per cada criteri puntuar actualitzar LT_GRID..
      DESCRIBE TABLE <lt_grid> LINES DATA(l_num).
      DO l_num TIMES.
        DATA(l_index) = sy-index.
        READ TABLE <lt_grid> ASSIGNING <ls_grid> INDEX l_index.
        IF sy-subrc = 0.
          ASSIGN COMPONENT 'Z_CODI_CRIT_PUNT' OF STRUCTURE <ls_grid> TO <lv_crit_punt>.
          CHECK sy-subrc = 0.
          ASSIGN COMPONENT 'Z_MOD_CRIT_PUNT'  OF STRUCTURE <ls_grid> TO <lv_mod_punt>.
          CHECK sy-subrc = 0.
          ASSIGN COMPONENT 'Z_DESCRIPCIO' OF STRUCTURE <ls_grid> TO FIELD-SYMBOL(<lv_descripcio>).
          CHECK sy-subrc = 0.
          ASSIGN COMPONENT i_column_id    OF STRUCTURE <ls_grid> TO <lv_punt>.
          CHECK sy-subrc = 0.
          ASSIGN COMPONENT 'Z_COMPTADOR_EQUIP' OF STRUCTURE <ls_grid> TO FIELD-SYMBOL(<lv_comptador_equip>).     "Comptador d'equip
          CHECK sy-subrc = 0.
**        >> INI MODIF ETODR SPEC-61754
          "Tot això d'aquí baix fa pinta que no serveix per a res...
          CHECK <lv_comptador_equip> IS NOT INITIAL.
**        << FI MODIF ETODR SPEC-61754
          DATA(lt_puntuacio_aux)          = lt_puntuacio_apartat_multiple.
          DATA(lt_puntuacio_apartat_aux2) = lt_puntuacio_apartat_multiple.
          LOOP AT lt_puntuacio_aux ASSIGNING FIELD-SYMBOL(<fs_aux_punt_2>) WHERE z_codi_crit_punt = <lv_crit_punt>.
            CLEAR: lt_puntuacio_apartat_aux2[].
            CLEAR: lv_punt, lv_punt_aux.
            LOOP AT lt_puntuacio_apartat_multiple ASSIGNING FIELD-SYMBOL(<fs_punt_sel_2>)
              WHERE z_codi_crit_punt CS <fs_aux_punt_2>-z_codi_crit_punt
                AND z_num_equip      = <lv_comptador_equip>.
              IF lv_pes IS INITIAL.
                lv_pes = 100.
              ENDIF.
              lv_operacion  = CONV #( <fs_punt_sel_2>-z_punts ).
              IF <lv_comptador_equip> IS NOT INITIAL.
                lv_punt = lv_operacion.
              ELSE.
                lv_punt       = lv_punt + ( lv_operacion * ( lv_pes / 100 ) ).
              ENDIF.
              <fs_punt_sel_2>-z_punts_no_pond = lv_punt.
              APPEND <fs_punt_sel_2> TO lt_puntuacio_apartat_aux2.
            ENDLOOP.

            lv_punt_aux  = lv_punt.
            REPLACE ALL OCCURRENCES OF '.' IN lv_punt_aux WITH ','.
            <lv_punt> = lv_punt_aux.

            SELECT SINGLE z_mult_rec
              FROM zrm_dm_crit_punt
              INTO @DATA(lv_mult_rec2)
                WHERE z_mod_crit_punt  EQ @lv_mod_punt
                  AND z_codi_crit_punt EQ @<fs_aux_punt_2>-z_codi_crit_punt.

            SELECT COUNT(*)
              FROM zrm_dt_punt_equi
                WHERE z_mod_crit_punt  EQ @lv_mod_punt
                  AND z_codi_crit_punt EQ @<fs_aux_punt_2>-z_codi_crit_punt.
            IF sy-subrc = 0.
              DATA(lv_mult_equip2) = abap_on.
            ENDIF.
            "Actualitzar taula amb valors seleccionats per a poder desar-la al SAVE / CONFIRMAR DADES
            my_backend->set_punt_subapart( it_dades_subapart = lt_puntuacio_apartat_aux2
                                           lv_punt           = lv_punt
                                           lv_mult_rec       = lv_mult_rec2
                                           is_mult_equip     = lv_mult_equip2 ).
          ENDLOOP.

        ENDIF.
      ENDDO.

*>> SPEC-53130, Inici modificació - ETLJS
    ELSE.
      lt_puntuacio_apartat_aux2 = lt_puntuacio_apartat_multiple.

      LOOP AT lt_graella_equip ASSIGNING FIELD-SYMBOL(<fs_g_e>).
        DELETE lt_equip WHERE z_codi_crit_punt NE <fs_g_e>-z_codi_crit_punt.
        EXIT.
      ENDLOOP.

      my_backend->set_punt_subapart(
          it_dades_subapart = lt_puntuacio_apartat_aux2
          it_equip_sep      = lt_equip
          lv_punt           = lv_punt
          lv_mult_rec       = lv_mult_rec2
          is_mult_equip     = lv_mult_equip2
          iv_num_oferta     = lv_num_oferta ).
    ENDIF.
*<< SPEC-53130, Final modificació - ETLJS


    my_grid->check_changed_data( IMPORTING e_valid   = DATA(l_valid) ).

    TRY.
        me->recalculate( ).
      CATCH zcx_rm_valoracio .
        RETURN.
    ENDTRY.

  ENDMETHOD.


  METHOD hotspot_click_pdm_equip.
    FIELD-SYMBOLS: <lt_grid> TYPE STANDARD TABLE.

    DATA: lv_num_oferta         TYPE z_num_ofer,
          ls_ref                TYPE tabfield,
          lcx_valoracio         TYPE REF TO zcx_rm_valoracio,
          l_read_only           TYPE xfeld,
          lv_mod_punt           TYPE z_mod_crit_punt,
          lt_punt_ofer_all_equi TYPE zrm_cl_valoracio_ofertes=>ty_t_punt_ofer_dyn_equi,
          lt_punts_offer        TYPE zrm_cl_valoracio_ofertes=>ty_t_punt_gen,
          lv_punt_aux           TYPE string,
          lv_punt               TYPE z_punt_max.

    ls_ref-tabname   = 'ZRM_DT_PUNT_OFER' .
    ls_ref-fieldname = 'Z_PUNTS' .
    ASSIGN my_table_ref->* TO <lt_grid>.

    READ TABLE <lt_grid> ASSIGNING FIELD-SYMBOL(<ls_grid>) INDEX i_row_id.
    CHECK sy-subrc = 0.

    ASSIGN COMPONENT 'Z_MOD_CRIT_PUNT'  OF STRUCTURE <ls_grid> TO FIELD-SYMBOL(<lv_mod_punt>). "
    CHECK sy-subrc  = 0.
    lv_mod_punt     = <lv_mod_punt>.

    LOOP AT my_columns ASSIGNING FIELD-SYMBOL(<fs_column_sel>) WHERE fieldname = i_column_id.
      lv_num_oferta = <fs_column_sel>-key.
      EXIT.
    ENDLOOP.
    CHECK lv_num_oferta IS NOT INITIAL.

    my_backend->get_dades_ofer_dyn( IMPORTING ex_punt_ofer_dyn      = DATA(lt_punt_ofer_all)
                                              ex_punt_ofer_dyn_equi = DATA(lt_graella_equip) ).
    "ens quedem únicament amb les dades de l'equip i de puntuació de la oferta en qüestió
    DELETE lt_graella_equip WHERE z_num_ofer <> lv_num_oferta.
    DELETE lt_punt_ofer_all WHERE z_num_ofer <> lv_num_oferta.
    DELETE lt_graella_equip WHERE z_equip_pdm <> abap_on.

    lt_punts_offer = my_backend->get_punt_offers( ).
    DELETE lt_punts_offer WHERE z_num_gen <> lv_num_oferta.
    LOOP AT lt_punts_offer ASSIGNING FIELD-SYMBOL(<fs>).
      READ TABLE lt_graella_equip TRANSPORTING NO FIELDS WITH KEY z_codi_crit_punt = <fs>-z_codi_crit_punt.
      IF sy-subrc <> 0.
        DELETE lt_punts_offer.
      ENDIF.
    ENDLOOP.

    ">>>SPEC-56253, Inici modificació  - ETODR
    IF my_read_only IS NOT INITIAL OR  my_backend->check_activity( my_backend_activities-save_punct ) IS INITIAL.
      l_read_only = abap_on.
    ENDIF.
    "<<<SPEC-56253, Final modificació - ETODR


    "A partir de l'equip definit per cada oferta, es mostra una ALV on poder introduir el % Dedicació ofertada per tal de calcular la puntuació
    CALL FUNCTION 'ZRM_PUNTUA_EQUIP_PDM'
      EXPORTING
        im_mod_crit      = lv_mod_punt
        im_docclass      = gv_docclass
        im_objectid      = gv_objectid
        im_num_ofer      = lv_num_oferta
        it_graella_equip = lt_graella_equip
        im_backend       = my_backend
        im_column        = <fs_column_sel>
        im_grid          = <ls_grid>
        i_readonly       = l_read_only
      CHANGING
        ct_punts_offer   = lt_punts_offer
      EXCEPTIONS
        not_changed      = 1
        other            = 2.
    CHECK sy-subrc = 0.

    "Per cada criteri puntuar actualitzar LT_GRID..
    DESCRIBE TABLE <lt_grid> LINES DATA(l_num).
    DO l_num TIMES.
      DATA(l_index) = sy-index.
      READ TABLE <lt_grid> ASSIGNING <ls_grid> INDEX l_index.
      IF sy-subrc = 0.
        ASSIGN COMPONENT 'Z_CODI_CRIT_PUNT' OF STRUCTURE <ls_grid> TO FIELD-SYMBOL(<lv_crit_punt>).
        CHECK sy-subrc = 0 AND <lv_crit_punt> IS NOT INITIAL.
        ASSIGN COMPONENT 'Z_MOD_CRIT_PUNT'  OF STRUCTURE <ls_grid> TO <lv_mod_punt>.
        CHECK sy-subrc = 0.
        ASSIGN COMPONENT i_column_id    OF STRUCTURE <ls_grid> TO FIELD-SYMBOL(<lv_punt>).
        CHECK sy-subrc = 0.
      ENDIF.

      LOOP AT lt_graella_equip ASSIGNING FIELD-SYMBOL(<fs_aux_punt_2>) WHERE z_codi_crit_punt = <lv_crit_punt>.
        CLEAR: lv_punt, lv_punt_aux.

        LOOP AT lt_punts_offer ASSIGNING FIELD-SYMBOL(<fs_punt_sel_2>) WHERE z_codi_crit_punt = <fs_aux_punt_2>-z_codi_crit_punt
                                                                         AND z_num_gen        = lv_num_oferta
                                                                         AND z_carrec_equip   = <fs_aux_punt_2>-z_carrec_equip
                                                                         AND z_num_equip      = <fs_aux_punt_2>-z_comptador_equip.
          lv_punt  = CONV #( <fs_punt_sel_2>-z_punts ).
        ENDLOOP.
        lv_punt_aux  = lv_punt.

        REPLACE ALL OCCURRENCES OF '.' IN lv_punt_aux WITH ','.
        <lv_punt> = lv_punt_aux.
      ENDLOOP.
    ENDDO.
    "Actualitzem MY_PUNT_OFFER
    my_backend->set_punt_offer_pdm( it_punt_offer = lt_punts_offer ).

    my_grid->check_changed_data( IMPORTING e_valid   = DATA(l_valid) ).

    TRY.
        me->recalculate( ).
      CATCH zcx_rm_valoracio .
        RETURN.
    ENDTRY.
  ENDMETHOD.


  METHOD hotspot_click_puntuar.
    TYPES: BEGIN OF ty_s_codi_crit_punt,
             z_codi_crit_punt TYPE z_codi_crit_punt,
           END OF ty_s_codi_crit_punt,
           ty_t_codi_crit_punt TYPE STANDARD TABLE OF ty_s_codi_crit_punt.
    FIELD-SYMBOLS: <lt_grid>      TYPE STANDARD TABLE.

    DATA: lt_codi_crit_punt             TYPE ty_t_codi_crit_punt,
          lt_puntuacio_apartat          TYPE zrm_cl_valoracio_ofertes=>ty_t_puntuacio_subapartats,
          lt_puntuacio_apartat_multiple TYPE zrm_cl_valoracio_ofertes=>ty_t_puntuacio_subapartats, "INI MODIF ETODR SPEC-47173
          lt_punt_multiple_aux          TYPE zrm_cl_valoracio_ofertes=>ty_t_puntuacio_subapartats, "INI MODIF ETODR SPEC-47173
          lt_puntuacio_apartat_aux      TYPE zrm_cl_valoracio_ofertes=>ty_t_puntuacio_subapartats,
          wa_motiv_mult                 TYPE zrm_cl_valoracio_ofertes=>ty_s_puntuacio_subapartats, "INI MODIF ETODR SPEC-47173
          lt_punt_rec_save              TYPE zrm_tt_punt_rec,
          lt_punt_sel_save              TYPE zrm_tt_punt_sel,
          lt_punt_equi_save             TYPE zrm_tt_dt_punt_equi,
          lv_num_oferta                 TYPE z_num_ofer,
          ls_ref                        TYPE tabfield,
          lcx_valoracio                 TYPE REF TO zcx_rm_valoracio,
          lv_crit_punt                  TYPE z_codi_crit_punt,
          l_read_only                   TYPE xfeld,
          lv_mod_punt                   TYPE z_mod_crit_punt,
          lv_codi_comptador_equip       TYPE zrm_dt_punt_equi-z_comptador_equip, "SPEC-49500
          wa_ofer_all                   TYPE zrm_cl_valoracio_ofertes=>ty_s_punt_ofer_dyn_equi,
          lv_punt_aux                   TYPE string,
          lv_punt                       TYPE z_punt_max,
          lv_operacion                  TYPE z_punt,
          lt_punt_ofer_all              TYPE zrm_tt_dt_punt_ofer,
          lt_punt_ofer_all_2_aux        TYPE zrm_cl_valoracio_ofertes=>ty_t_punt_ofer_dyn_equi, "SPEC-49500
          lt_punt_ofer_all_2            TYPE zrm_tt_dt_punt_ofer,
          lt_punt_ofer_all_equi         TYPE zrm_cl_valoracio_ofertes=>ty_t_punt_ofer_dyn_equi, "SPEC-49500
          lv_pes                        TYPE i,
          lv_max_punt_rec               TYPE z_punt_max.

    ls_ref-tabname   = 'ZRM_DT_PUNT_OFER' .
    ls_ref-fieldname = 'Z_PUNTS' .
    ASSIGN my_table_ref->* TO <lt_grid>.

    READ TABLE <lt_grid> ASSIGNING FIELD-SYMBOL(<ls_grid>) INDEX i_row_id.
    CHECK sy-subrc = 0.

    ASSIGN COMPONENT 'Z_CODI_CRIT_PUNT' OF STRUCTURE <ls_grid> TO FIELD-SYMBOL(<lv_crit_punt>).
    CHECK sy-subrc = 0.
    ASSIGN COMPONENT 'Z_MOD_CRIT_PUNT'  OF STRUCTURE <ls_grid> TO FIELD-SYMBOL(<lv_mod_punt>). "
    CHECK sy-subrc = 0.
    ASSIGN COMPONENT i_column_id        OF STRUCTURE <ls_grid> TO FIELD-SYMBOL(<lv_punt>).     "Recollir empresa
    CHECK sy-subrc = 0.
**  >> INI MODIF ETODR SPEC-49500
    ASSIGN COMPONENT 'Z_COMPTADOR_EQUIP' OF STRUCTURE <ls_grid> TO FIELD-SYMBOL(<lv_comptador_equip>).     "Comptador d'equip
    CHECK sy-subrc = 0.
**  << FI MODIF ETODR SPEC-49500

    LOOP AT my_columns ASSIGNING FIELD-SYMBOL(<fs_column_sel>) WHERE fieldname = i_column_id.
      lv_num_oferta = <fs_column_sel>-key.
      EXIT.
    ENDLOOP.
    CHECK lv_num_oferta IS NOT INITIAL.

    lv_crit_punt            = <lv_crit_punt>.
    lv_mod_punt             = <lv_mod_punt>.
    lv_codi_comptador_equip = <lv_comptador_equip>. "SPEC-49500

**  >> INI MODIF ETODR SPEC-45407
    TRY.
        DATA(lt_crit_aux_punt) = my_backend->get_crit_punt_offers( im_only_used_ones = abap_off ).
      CATCH cx_root.
        RETURN.
    ENDTRY.
    LOOP AT lt_crit_aux_punt ASSIGNING FIELD-SYMBOL(<fs_aux_punt>) WHERE z_codi_subapar_punt IS NOT INITIAL.
      IF lv_crit_punt IS NOT INITIAL.
        IF <fs_aux_punt>-z_codi_crit_punt <> lv_crit_punt.
          CONTINUE.
        ENDIF.
      ENDIF.
      IF lv_mod_punt IS INITIAL.
        lv_mod_punt = <fs_aux_punt>-z_mod_crit_punt.
      ENDIF.
**    >> INI MODIF ETODR SPEC-49500
      IF <fs_aux_punt>-z_num_equip <> lv_codi_comptador_equip.
        CONTINUE.
      ENDIF.
**    << FI MODIF ETODR SPEC-49500
      APPEND <fs_aux_punt>-z_codi_crit_punt TO lt_codi_crit_punt.
    ENDLOOP.

**  >> INI MODIF ETODR SPEC-45407
    my_backend->get_dades_ofer_dyn( IMPORTING ex_punt_ofer_dyn      = lt_punt_ofer_all
                                              ex_punt_ofer_dyn_equi = DATA(lt_punt_equi) ). "SPEC-49500
    IF lt_punt_ofer_all[] IS INITIAL.
      SELECT *
        FROM zrm_dt_punt_ofer
**        >> INI MODIF ETODR SPEC-49500
*        INTO TABLE @lt_punt_ofer_all
        INTO CORRESPONDING FIELDS OF TABLE @lt_punt_ofer_all_equi
**        << FI MODIF ETODR SPEC-49500
        FOR ALL ENTRIES IN @lt_codi_crit_punt
        WHERE docclass         = @gv_docclass
          AND objectid         = @gv_objectid
          AND z_num_ofer       = @lv_num_oferta
          AND z_mod_crit_punt  = @lv_mod_punt
          AND z_codi_crit_punt = @lt_codi_crit_punt-z_codi_crit_punt
          AND z_no_aplica      = @abap_off.                          "si no aplica no s'ha de mostrar ni recuperar
      CHECK sy-subrc = 0.
    ELSE.
      LOOP AT lt_codi_crit_punt ASSIGNING FIELD-SYMBOL(<fs_crit_punt>).
        LOOP AT lt_punt_ofer_all ASSIGNING FIELD-SYMBOL(<fs_ofer_all>) WHERE z_codi_crit_punt = <fs_crit_punt>-z_codi_crit_punt
                                                                         AND z_no_aplica      = abap_off
                                                                         AND z_num_ofer       = lv_num_oferta.
**        >> INI MODIF ETODR SPEC-49500 "Només es mostra el criteri d'equip del membre seleccionat
          CLEAR: wa_ofer_all.
          MOVE-CORRESPONDING <fs_ofer_all> TO wa_ofer_all.
          IF lv_codi_comptador_equip IS NOT INITIAL.
            READ TABLE lt_punt_equi ASSIGNING FIELD-SYMBOL(<fs_equi>) WITH KEY z_codi_crit_punt  = <fs_ofer_all>-z_codi_crit_punt
                                                                               z_comptador_equip = lv_codi_comptador_equip
                                                                               z_num_ofer        = lv_num_oferta.
            IF sy-subrc <> 0.
              CONTINUE.
            ELSE.
              wa_ofer_all-z_comptador_equip = <fs_equi>-z_comptador_equip.
              wa_ofer_all-z_sec             = <fs_equi>-z_sec.
              wa_ofer_all-z_punts           = <fs_equi>-z_punts.
            ENDIF.
          ENDIF.
          APPEND wa_ofer_all TO lt_punt_ofer_all_2_aux.
**        << FI MODIF ETODR SPEC-49500
          APPEND <fs_ofer_all> TO lt_punt_ofer_all_2.
        ENDLOOP.
      ENDLOOP.
      lt_punt_ofer_all[]      = lt_punt_ofer_all_2[].
      lt_punt_ofer_all_equi[] = lt_punt_ofer_all_2_aux[]. "MODIF ETODR SPEC-49500
    ENDIF.

*    DESCRIBE TABLE lt_punt_ofer_all LINES DATA(l_num_crit_punt).     "MODIF ETODR SPEC-49500
    DESCRIBE TABLE lt_punt_ofer_all_equi LINES DATA(l_num_crit_punt). "MODIF ETODR SPEC-49500

*    LOOP AT lt_punt_ofer_all ASSIGNING FIELD-SYMBOL(<fs_all>).       "MODIF ETODR SPEC-49500
    LOOP AT lt_punt_ofer_all_equi ASSIGNING FIELD-SYMBOL(<fs_all>).   "MODIF ETODR SPEC-49500
      CLEAR: lt_puntuacio_apartat_aux[].
      CHECK <fs_all>-z_codi_subapar_punt IS NOT INITIAL.
      my_backend->get_punt_subapart( EXPORTING i_subapartat      = <fs_all>-z_codi_subapar_punt
                                     IMPORTING et_dades_subapart = lt_puntuacio_apartat_aux ).

      DELETE lt_puntuacio_apartat_aux WHERE z_num_ofer <> <fs_all>-z_num_ofer.
**    >> INI MODIF ETODR SPEC-49500
      LOOP AT lt_puntuacio_apartat_aux ASSIGNING FIELD-SYMBOL(<fs_punt_apar_aux>).
        IF lv_codi_comptador_equip IS NOT INITIAL.
          IF <fs_punt_apar_aux>-z_num_equip <> <fs_all>-z_comptador_equip.
            DELETE lt_puntuacio_apartat_aux.
            CONTINUE.
          ENDIF.
        ENDIF.
        <fs_punt_apar_aux>-z_num_equip = <fs_all>-z_comptador_equip.
      ENDLOOP.
**    << FI MODIF ETODR SPEC-49500
      APPEND LINES OF lt_puntuacio_apartat_aux TO lt_puntuacio_apartat.
    ENDLOOP.
**  >> INI MODIF ETODR SPEC-47173
    my_backend->get_motivacio_multi( IMPORTING et_motiv_mult = DATA(lt_motiv_mult) ).
    CLEAR: lt_puntuacio_apartat_multiple[].
    LOOP AT lt_motiv_mult ASSIGNING FIELD-SYMBOL(<fs_motiv_mult>).
      MOVE-CORRESPONDING <fs_motiv_mult> TO wa_motiv_mult.
      APPEND wa_motiv_mult TO lt_puntuacio_apartat_multiple.
    ENDLOOP.
**  << FI MODIF ETODR SPEC-47173

    "Reset del log temporal
    my_backend->reset_log_pt( ).
    IF my_read_only IS NOT INITIAL OR  my_backend->check_activity( my_backend_activities-save_punct ) IS INITIAL.
      l_read_only = abap_on.
    ENDIF.
    CALL FUNCTION 'ZRM_PUNTUACIO_OFERTES_NEW'
      EXPORTING
        im_mod_crit    = lv_mod_punt
        im_docclass    = gv_docclass
        im_objectid    = gv_objectid
        it_punt_ofer   = lt_punt_ofer_all_equi
        im_backend     = my_backend
        im_column      = <fs_column_sel>
        im_grid        = <ls_grid>
        i_readonly     = l_read_only
      IMPORTING
        et_punt_equi   = lt_punt_equi_save
        et_punt_rec    = lt_punt_rec_save
        et_punt_sel    = lt_punt_sel_save
      CHANGING
        ct_puntuacio   = lt_puntuacio_apartat_multiple
      EXCEPTIONS
        not_subapartat = 1
        not_changed    = 2
        other          = 3.

    IF sy-subrc <> 0.
      "Si s'han cancel·lat els canvis s'elimina la taula de log temporal que s'havia creat
      my_backend->reset_log_pt( ).
      EXIT.
    ENDIF.
    "Si s'han acceptat els canvis passem les dades dels registres de modificacions al log final encarregat del guardat.
    "S'ha de fer un log "temporal" per a no traspassar les dades directament i evitar així q es guardin dades cancel·lades
    my_backend->set_temporal_log_pt( ).
    "Per cada criteri puntuar actualitzar LT_GRID
    DESCRIBE TABLE <lt_grid> LINES DATA(l_num).
    DO l_num TIMES.
      DATA(l_index) = sy-index.
      READ TABLE <lt_grid> ASSIGNING <ls_grid> INDEX l_index.
      IF sy-subrc = 0.
        ASSIGN COMPONENT 'Z_CODI_CRIT_PUNT' OF STRUCTURE <ls_grid> TO <lv_crit_punt>.
        CHECK sy-subrc = 0 AND <lv_crit_punt> IS NOT INITIAL.
        ASSIGN COMPONENT 'Z_MOD_CRIT_PUNT'  OF STRUCTURE <ls_grid> TO <lv_mod_punt>.
        CHECK sy-subrc = 0.
        ASSIGN COMPONENT 'Z_PUNT_MAX' OF STRUCTURE <ls_grid> TO FIELD-SYMBOL(<lv_punt_max_2>).
        CHECK sy-subrc = 0.
        ASSIGN COMPONENT 'Z_COMPTADOR_EQUIP' OF STRUCTURE <ls_grid> TO FIELD-SYMBOL(<lv_comptador_equip2>).     "Comptador d'equip
        CHECK sy-subrc = 0.
        IF <lv_comptador_equip2> <> <lv_comptador_equip>.
          CONTINUE.
        ENDIF.

        DATA(lt_puntuacio_aux)          = lt_puntuacio_apartat_multiple."lt_puntuacio_apartat.
        DATA(lt_puntuacio_apartat_aux2) = lt_puntuacio_apartat_multiple."lt_puntuacio_apartat.
        DELETE ADJACENT DUPLICATES FROM lt_puntuacio_aux COMPARING z_codi_crit_punt.

**************        DELETE ADJACENT DUPLICATES FROM lt_puntuacio_apartat COMPARING z_codi_crit_punt z_compta_rec.
        DELETE ADJACENT DUPLICATES FROM lt_puntuacio_apartat_multiple COMPARING z_codi_crit_punt z_compta_rec.

        LOOP AT lt_puntuacio_aux ASSIGNING FIELD-SYMBOL(<fs_aux_punt_2>) WHERE z_codi_crit_punt = <lv_crit_punt>.
          CLEAR: lt_puntuacio_apartat_aux2[].
          CLEAR: lv_punt, lv_punt_aux.

*          LOOP AT lt_puntuacio_apartat ASSIGNING FIELD-SYMBOL(<fs_punt_sel_2>) WHERE z_codi_crit_punt = <fs_aux_punt_2>-z_codi_crit_punt.
          LOOP AT lt_puntuacio_apartat_multiple ASSIGNING FIELD-SYMBOL(<fs_punt_sel_2>) WHERE z_codi_crit_punt = <fs_aux_punt_2>-z_codi_crit_punt.
            IF <fs_punt_sel_2>-z_pes IS INITIAL.
              lv_pes = 100.
            ELSE.
              lv_pes = <fs_punt_sel_2>-z_pes.
            ENDIF.
            lv_operacion  = CONV #( <fs_punt_sel_2>-z_punts ).
**          >> INI MODIF ETODR SPEC-49500
            IF <lv_comptador_equip2> IS NOT INITIAL.
              lv_punt = lv_operacion.
            ELSE.
              lv_punt       = lv_punt + ( lv_operacion * ( lv_pes / 100 ) ).
            ENDIF.
            <fs_punt_sel_2>-z_punts_no_pond = lv_punt.
            APPEND <fs_punt_sel_2> TO lt_puntuacio_apartat_aux2.
          ENDLOOP.
          lv_punt_aux  = lv_punt.

          REPLACE ALL OCCURRENCES OF '.' IN lv_punt_aux WITH ','.
          <lv_punt> = lv_punt_aux.

          SELECT SINGLE z_mult_rec
            FROM zrm_dm_crit_punt
            INTO @DATA(lv_mult_rec2)
              WHERE z_mod_crit_punt  EQ @lv_mod_punt
                AND z_codi_crit_punt EQ @<fs_aux_punt_2>-z_codi_crit_punt.
**        >> INI MODIF ETODR SPEC-49500
          SELECT COUNT(*)
            FROM zrm_dt_punt_equi
              WHERE z_mod_crit_punt  EQ @lv_mod_punt
                AND z_codi_crit_punt EQ @<fs_aux_punt_2>-z_codi_crit_punt.
          IF sy-subrc = 0.
            DATA(lv_mult_equip2) = abap_on.
          ENDIF.
**        << FI MODIF ETODR SPEC-49500
          break etodr.
          "Actualitzar taula amb valors seleccionats per a poder desar-la al SAVE / CONFIRMAR DADES
          my_backend->set_punt_subapart( it_dades_subapart = lt_puntuacio_apartat_aux2
                                         lv_punt           = lv_punt
                                         lv_mult_rec       = lv_mult_rec2
                                         is_mult_equip     = lv_mult_equip2 ). "SPEC-49500
        ENDLOOP.

      ENDIF.
    ENDDO.

    my_backend->set_taules_rel_ofer( EXPORTING it_punt_rec   = lt_punt_rec_save
                                               it_punt_sel   = lt_punt_sel_save
                                               it_punt_equi  = lt_punt_equi_save ).
**>> INI SPEC-48559 ETJMD 13.06.2018
*    CLEAR: lt_punt_multiple_aux[].
*    LOOP AT lt_puntuacio_apartat_multiple ASSIGNING FIELD-SYMBOL(<fs_punt_multiple>).
*      APPEND <fs_punt_multiple> TO lt_punt_multiple_aux.
*    ENDLOOP.
    IF lt_puntuacio_apartat_multiple IS NOT INITIAL.
      my_backend->set_motivacio_mult( it_dades_subapart = lt_puntuacio_apartat_multiple ).
    ENDIF.
**<< FIN SPEC-48559 ETJMD 13.06.2018
  ENDMETHOD.


METHOD lemes_to_columns.
  FIELD-SYMBOLS: <ls_lema>  LIKE LINE OF im_lemes,
                 <ls_offer> LIKE LINE OF im_offers .
  DATA: ls_column   TYPE ty_s_column,
        l_tabix     TYPE i.

  LOOP AT im_lemes ASSIGNING <ls_lema> .
    CLEAR: ls_column,
           l_tabix.

    READ TABLE ch_columns INTO ls_column WITH KEY key = <ls_lema>-z_num_lema .
    IF sy-subrc EQ 0 .
      l_tabix = sy-tabix .
    ENDIF .

    ls_column-editable = 'X' .
    ls_column-total    = 0 .

    ls_column-key            = <ls_lema>-z_num_lema .
    ls_column-fieldname(1)   = 'L' .
    ls_column-fieldname+1(*) = ls_column-key .
    ls_column-header         = <ls_lema>-z_lema .
    ls_column-full_name      = <ls_lema>-z_lema .
    IF im_offers IS SUPPLIED .
      ls_column-editable =  space .
      ls_column-total    = 0 .
      IF <ls_lema>-z_num_ofer IS NOT INITIAL .
        READ TABLE im_offers ASSIGNING <ls_offer>
             WITH KEY z_num_ofer = <ls_lema>-z_num_ofer .
        ls_column-editable =  'X' .
        CONCATENATE <ls_offer>-nom_proveidor ` (` <ls_lema>-z_lema ')' INTO ls_column-full_name .
        ls_column-header         = ls_column-full_name .
        ls_column-adjudicat      = <ls_offer>-z_adj_prov.
      ENDIF .
    ENDIF .

    IF l_tabix IS INITIAL .
      INSERT ls_column INTO TABLE ch_columns .
    ELSE .
      MODIFY ch_columns FROM ls_column INDEX l_tabix .
    ENDIF .
  ENDLOOP .
ENDMETHOD.


METHOD offers_to_columns.

  FIELD-SYMBOLS: <ls_oferta>    LIKE LINE OF im_offers.
  DATA: ls_column TYPE ty_s_column,
        l_tabix   TYPE i,
        l_num     TYPE char20.

  LOOP AT im_offers ASSIGNING <ls_oferta> .
    CLEAR: ls_column,
           l_tabix .

    READ TABLE ch_columns INTO ls_column WITH KEY key = <ls_oferta>-z_num_ofer .
    IF sy-subrc EQ 0 .
      l_tabix = sy-tabix .
    ENDIF .
    IF     <ls_oferta>-exclos          IS NOT INITIAL
        OR <ls_oferta>-z_excl_punt_tec IS NOT INITIAL
        OR <ls_oferta>-z_excl_solv_tec IS NOT INITIAL
        OR <ls_oferta>-z_exclos_req    IS NOT INITIAL          " SPEC-73390
        OR <ls_oferta>-z_exclos_punt_capob IS NOT INITIAL.     " Insert PSPEC-1451 EVXGL.
      ls_column-editable = space .
    ELSE.
      " >> INI ETKAN 12/01/2016 P100031
      IF my_mode EQ co_mode_neg_f2.
        IF <ls_oferta>-z_sel_2volta IS NOT INITIAL.
          ls_column-editable = abap_true.
        ELSE.
          ls_column-editable = abap_false.
        ENDIF.
      ELSE.
        ls_column-editable = abap_true.
      ENDIF.
      " >> FIN ETKAN 12/01/2016 P100031
**    >> INI MODIF ETODR SPEC-49806
      "Si al puntuar al Sobre 3 s'exclou una oferta per clàusula de plec, aquesta no es pot adjudicar o és Temeraria
      IF my_mode = zrm_cl_valoracio_ofertes=>co_mode_punt_quadre4b OR
         my_mode = zrm_cl_valoracio_ofertes=>co_mode_millor_classif. " SPEC-54695
        IF <ls_oferta>-z_exclos_plec IS NOT INITIAL OR <ls_oferta>-z_temerari IS NOT INITIAL.
          ls_column-editable = abap_false.
        ENDIF.
      ENDIF.
**    << INI MODIF ETODR SPEC-49806
    ENDIF.

    ls_column-total          = 0 .

    ls_column-key            = <ls_oferta>-z_num_ofer .
    ls_column-fieldname(1)   = 'O' .
    ls_column-fieldname+1(*) = ls_column-key .
    ls_column-header         = <ls_oferta>-nom_proveidor .
    ls_column-full_name      = <ls_oferta>-nom_proveidor .
    ls_column-sort_crit1     = <ls_oferta>-num_variant.
    ls_column-adjudicat      = <ls_oferta>-z_adj_prov.
    ls_column-mill_class     = <ls_oferta>-z_mill_class . " SPEC-54695

    CASE <ls_oferta>-z_tipus_oferta .
      WHEN zrm_cl_ofertes=>oferta_base .
        ls_column-subheader = 'Base'(s01) .

      WHEN zrm_cl_ofertes=>oferta_variant .
        WRITE <ls_oferta>-num_variant TO l_num LEFT-JUSTIFIED .
        CONCATENATE 'Variant'(s02) l_num INTO ls_column-subheader SEPARATED BY space .

    ENDCASE .
**  >> INI MODIF ETODR SPEC-49806
    "a la graella de puntuacions creem una taula dins de MY_COLUMNS on es guardarà, per cada Oferta, quin és el seu equip màxim, per tal de poder pintar bé la graella
    DATA(lt_max_carrecs) = im_max_equip[].
    IF lt_max_carrecs[] IS NOT INITIAL.
      DELETE lt_max_carrecs WHERE z_num_ofer <> <ls_oferta>-z_num_ofer.
      ls_column-equip_max = lt_max_carrecs.
    ENDIF.
**  << FI MODIF ETODR SPEC-49806
    IF l_tabix IS NOT INITIAL .
      MODIFY ch_columns FROM ls_column INDEX l_tabix .
    ELSE .
      INSERT ls_column INTO TABLE ch_columns .
    ENDIF .
  ENDLOOP .

ENDMETHOD.


METHOD on_button_click.

  FIELD-SYMBOLS: <ls_column> TYPE ty_s_column,
                 <ls_row>    TYPE ty_s_row,
                 <lt_grid>   TYPE STANDARD TABLE,
                 <ls_grid>   TYPE ANY,
                 <ls_punt>   TYPE ANY .

*  CHECK es_row_no-row_id eq 2 .
  READ TABLE my_columns ASSIGNING <ls_column> WITH KEY fieldname = es_col_id-fieldname .
  IF <ls_column>-editable IS INITIAL . "En teori és impossible que passi aixó
    MESSAGE i047 DISPLAY LIKE 'E'.
    RETURN .
  ENDIF .

  LOOP AT my_columns ASSIGNING <ls_column> .
    CLEAR: <ls_column>-adjudicat ,
           <ls_column>-MILL_CLASS .

    IF <ls_column>-fieldname EQ es_col_id-fieldname .
*>> Ini  SPEC-54695  - ETMAE
      if my_mode = zrm_cl_valoracio_ofertes=>CO_MODE_MILLOR_CLASSIF.
        <ls_column>-MILL_CLASS = abap_true.
      else.
        <ls_column>-adjudicat  = abap_true.
      endif .
*<< Fi  SPEC-54695  - ETMAE
    endif.
  ENDLOOP .

  ASSIGN my_table_ref->* TO <lt_grid> .
  READ TABLE <lt_grid> INDEX es_row_no-row_id  ASSIGNING <ls_grid> .
  ASSIGN COMPONENT '_CONTROL_' OF STRUCTURE <ls_grid> TO <ls_row> .
  ASSIGN COMPONENT '_PUNTS_'   OF STRUCTURE <ls_grid> TO <ls_punt> .

*>> Ini  SPEC-54695  - ETMAE
  if my_mode = zrm_cl_valoracio_ofertes=>CO_MODE_MILLOR_CLASSIF.
    fill_best_classified_line( CHANGING ch_row = <ls_row>
                                        ch_punt = <ls_punt> ) .
  else.
    fill_awardee_line( CHANGING ch_row = <ls_row>
                                ch_punt = <ls_punt> ) .
  endif.
*<< Fi  SPEC-54695  - ETMAE

  me->refresh_table_display( ) .


ENDMETHOD.
*
*------------------------------------------------------------------------------
*


METHOD on_close_document.
*  BREAK-POINT .
ENDMETHOD.


METHOD on_close_navigation.
  toggle_navigation_box( ) .
ENDMETHOD.


  METHOD on_context_menu.

    FIELD-SYMBOLS: <lt_grid> TYPE STANDARD TABLE.

    DATA: ls_ref      TYPE tabfield,
          lv_codi_sub TYPE z_codi_subapar_punt.
    CHECK my_backend->get_my_crit_dyn( ) = abap_on. "SPEC-47173 "Només s'ha de poder introduir la motivació si és criteri dinàmic
    my_grid->get_current_cell( IMPORTING  e_col     = DATA(lv_sel_col)
                                          e_row     = DATA(lv_sel_row)
                                          es_col_id = DATA(lv_col_id) ).
    DATA(lt_columns) = my_columns.
    SORT lt_columns BY key ASCENDING.
    READ TABLE lt_columns TRANSPORTING NO FIELDS WITH KEY fieldname = lv_col_id BINARY SEARCH.
    CHECK sy-subrc = 0.

    ls_ref-tabname   = 'ZRM_DT_PUNT_OFER' .
    ls_ref-fieldname = 'Z_PUNTS' .
    ASSIGN my_table_ref->* TO <lt_grid>.

    READ TABLE <lt_grid> ASSIGNING FIELD-SYMBOL(<ls_grid>) INDEX lv_sel_row.
    CHECK sy-subrc = 0.

    ASSIGN COMPONENT 'Z_CODI_CRIT_PUNT' OF STRUCTURE <ls_grid> TO FIELD-SYMBOL(<lv_crit_punt>).
    CHECK sy-subrc = 0.
    ASSIGN COMPONENT 'Z_MOD_CRIT_PUNT'  OF STRUCTURE <ls_grid> TO FIELD-SYMBOL(<lv_mod_punt>). "
    CHECK sy-subrc = 0.

    CLEAR: lv_codi_sub.
    SELECT SINGLE z_codi_subapar_punt, z_crit_ve, z_sumatori
      FROM zrm_dm_crit_punt
      INTO (@lv_codi_sub,@DATA(lv_crit_ve),@DATA(lv_sumatori))
      WHERE z_codi_crit_punt = @<lv_crit_punt>
        AND z_mod_crit_punt  = @<lv_mod_punt>.

    CHECK sy-subrc = 0 AND lv_crit_ve IS INITIAL AND lv_sumatori IS INITIAL.

    SELECT SINGLE z_codi_subapar_punt_rel
      FROM zrm_dm_suapar_pt
      INTO @lv_codi_sub
      WHERE z_codi_subapar_punt = @lv_codi_sub.

    CHECK lv_codi_sub IS INITIAL.

    e_object->add_separator( ).
    e_object->add_function( EXPORTING fcode = '&MOTIVACIO'
                                      text  = 'Introduir Motivació' ).

  ENDMETHOD.


METHOD on_data_changed.

  FIELD-SYMBOLS: <ls_good_cell> TYPE lvc_s_modi,
                 <ls_grid>      TYPE any,
                 <lt_grid>      TYPE STANDARD TABLE,
                 <ls_row>       TYPE ty_s_row,
                 <ls_punt>      TYPE any.
  DATA: l_punts_alv(40),
        l_punts_real    TYPE zrm_dt_punt_ofer-z_punts,
        ls_ref          TYPE tabfield,
        lcx_valoracio   TYPE REF TO zcx_rm_valoracio,
        l_error         TYPE xfeld,
        l_undo          TYPE xfeld, "MODIF ETODR SPEC-40749
        l_num_equip     TYPE z_compta_equip.

** >> INI MODIF ETODR SPEC-45341
  DATA: wa_puntuacio  TYPE zrm_cl_valoracio_ofertes=>ty_s_puntuacio_subapartats,
        l_num_ofer    TYPE z_num_ofer,
        lt_dades_punt TYPE zrm_cl_valoracio_ofertes=>ty_t_puntuacio_subapartats.
** << FI MODIF ETODR SPEC-45341


  ls_ref-tabname   = 'ZRM_DT_PUNT_OFER' .
  ls_ref-fieldname = 'Z_PUNTS' .
  ASSIGN my_table_ref->* TO <lt_grid> .
  ASSIGN my_line_ref->*  TO <ls_grid> .

  ASSIGN COMPONENT '_CONTROL_' OF STRUCTURE <ls_grid> TO <ls_row> .
  ASSIGN COMPONENT '_PUNTS_'   OF STRUCTURE <ls_grid> TO <ls_punt> .

*<<INS EEMGA SPEC-7298 : Copy/paste en llistats ALV GRID no controla.....
  CLEAR my_backend->sap_error.
*>>INS EEMGA SPEC-7298 : Copy/paste en llistats ALV GRID no controla.....
**>> INI MODIF ETODR SPEC-40749
  CLEAR: l_undo.
  IF my_backend->get_is_cp_iniciada( ) = abap_on.
    "Si hi ha alguna circular de validació d'OFTEC iniciada cal determinar un motiu per a realitzar cadascun dels canvis de puntuació
    "Si no es determina un motiu, es restaurarà el valor que hi havia abans del canvi
    LOOP AT er_data_changed->mt_good_cells ASSIGNING <ls_good_cell> .
      AT NEW row_id .
        READ TABLE <lt_grid> INTO <ls_grid> INDEX <ls_good_cell>-row_id .
      ENDAT .

      READ TABLE my_columns INTO DATA(wa_col) WITH KEY fieldname = <ls_good_cell>-fieldname.

      TRY.
          my_backend->set_canvi_punt( EXPORTING  ir_data_changed    = er_data_changed
                                                 i_data_changed     = <ls_good_cell>
                                                 i_punt             = <ls_punt>
                                                 i_row              = <ls_row>
                                                 i_columns          = wa_col
                                                 is_ref             = ls_ref ).
        CATCH zcx_rm_valoracio INTO lcx_valoracio.
          IF lcx_valoracio->if_t100_message~t100key-msgno = zcx_rm_valoracio=>undo_changes-msgno.
            l_undo = abap_on.
          ELSE.
            l_error = abap_on.
            CALL METHOD er_data_changed->add_protocol_entry
              EXPORTING
                i_msgid     = lcx_valoracio->if_t100_message~t100key-msgid
                i_msgty     = 'E'
                i_msgno     = lcx_valoracio->if_t100_message~t100key-msgno
                i_msgv1     = lcx_valoracio->msgv1
                i_msgv2     = lcx_valoracio->msgv2
                i_msgv3     = lcx_valoracio->msgv3
                i_msgv4     = lcx_valoracio->msgv4
                i_fieldname = <ls_good_cell>-fieldname
                i_row_id    = <ls_good_cell>-row_id
                i_tabix     = <ls_good_cell>-tabix.
            CONTINUE.
          ENDIF.
      ENDTRY.
    ENDLOOP.
  ENDIF.

  IF l_error IS INITIAL AND l_undo IS INITIAL.
**<< FI MODIF ETODR SPEC-40749
    LOOP AT er_data_changed->mt_good_cells ASSIGNING <ls_good_cell> .
      AT NEW row_id .
        READ TABLE <lt_grid> INTO <ls_grid> INDEX <ls_good_cell>-row_id .
      ENDAT .
      CALL METHOD er_data_changed->get_cell_value
        EXPORTING
          i_tabix     = <ls_good_cell>-tabix
          i_fieldname = <ls_good_cell>-fieldname
        IMPORTING
          e_value     = l_punts_alv.

      CALL FUNCTION 'RS_CONV_EX_2_IN'
        EXPORTING
          input_external  = l_punts_alv
          table_field     = ls_ref
        IMPORTING
          output_internal = l_punts_real
        EXCEPTIONS
          OTHERS          = 21.
      IF sy-subrc <> 0.
        l_error = 'X' .
        CALL METHOD er_data_changed->add_protocol_entry
          EXPORTING
            i_msgid     = sy-msgid
            i_msgty     = 'E'
            i_msgno     = sy-msgno
            i_msgv1     = sy-msgv1
            i_msgv2     = sy-msgv2
            i_msgv3     = sy-msgv3
            i_msgv4     = sy-msgv4
            i_fieldname = <ls_good_cell>-fieldname
            i_row_id    = <ls_good_cell>-row_id
            i_tabix     = <ls_good_cell>-tabix.
        CONTINUE .
      ENDIF.


      TRY .
          CALL METHOD my_backend->set_punctuation
            EXPORTING
              im_codi_crit_punt = <ls_row>-z_codi_crit_punt
              im_mod_crit_punt  = <ls_row>-z_mod_crit_punt
              im_key_gen        = <ls_good_cell>-fieldname+1(20)
              im_value          = l_punts_real
              im_descripcio     = <ls_row>-z_descripcio
            IMPORTING
              em_num_equip      = l_num_equip.
**        >> INI MODIF ETODR SPEC-45341
          IF my_backend->get_my_crit_dyn( ) = abap_on.
            CLEAR: lt_dades_punt[], wa_puntuacio, l_num_ofer.

            LOOP AT my_columns ASSIGNING FIELD-SYMBOL(<fs_column_sel>) WHERE fieldname = <ls_good_cell>-fieldname.
              l_num_ofer = <fs_column_sel>-key.
              EXIT.
            ENDLOOP.

            wa_puntuacio-z_codi_crit_punt           = <ls_row>-z_codi_crit_punt.
            wa_puntuacio-docclass                   = gv_docclass.
            wa_puntuacio-objectid                   = gv_objectid.
            wa_puntuacio-z_num_ofer                 = l_num_ofer.
            wa_puntuacio-z_punts                    = l_punts_real.
            wa_puntuacio-z_punts_no_pond            = l_punts_real. "MODIF ETODR SPEC-49075
            wa_puntuacio-z_num_equip                = l_num_equip.
**          >> INI MODIF ETODR SPEC-47727
            my_backend->get_punt_subapart( IMPORTING et_dades_subapart = lt_dades_punt ).
            READ TABLE lt_dades_punt ASSIGNING FIELD-SYMBOL(<fs>) WITH KEY z_codi_crit_punt     = wa_puntuacio-z_codi_crit_punt
                                                                           z_num_ofer           = wa_puntuacio-z_num_ofer.
            IF sy-subrc = 0.
              wa_puntuacio-z_motivacio = <fs>-z_motivacio.
              CLEAR: lt_dades_punt[].
              APPEND wa_puntuacio TO lt_dades_punt.
            ELSE.
**          << FI MODIF ETODR SPEC-47727
              APPEND wa_puntuacio TO lt_dades_punt.
            ENDIF.

            my_backend->set_punt_subapart( EXPORTING it_dades_subapart = lt_dades_punt ).
          ENDIF.
**        << FI MODIF ETODR SPEC-45341
        CATCH zcx_rm_valoracio INTO lcx_valoracio.
          l_error = 'X' .
          CALL METHOD er_data_changed->add_protocol_entry
            EXPORTING
              i_msgid     = lcx_valoracio->if_t100_message~t100key-msgid
              i_msgty     = 'E'
              i_msgno     = lcx_valoracio->if_t100_message~t100key-msgno
              i_msgv1     = lcx_valoracio->msgv1
              i_msgv2     = lcx_valoracio->msgv2
              i_msgv3     = lcx_valoracio->msgv3
              i_msgv4     = lcx_valoracio->msgv4
              i_fieldname = <ls_good_cell>-fieldname
              i_row_id    = <ls_good_cell>-row_id
              i_tabix     = <ls_good_cell>-tabix.
      ENDTRY .
*      IF    l_punts LT <ls_row>-z_punt_min
*         OR l_punts GT <ls_row>-z_punt_max .
*        l_error = 'X' .
*        MESSAGE e040 WITH <ls_row>-z_codi_crit_punt <ls_row>-z_punt_min
*                          <ls_row>-z_punt_max INTO l_dummy .
*        CALL METHOD er_data_changed->add_protocol_entry
*          EXPORTING
*            i_msgid     = sy-msgid
*            i_msgty     = sy-msgty
*            i_msgno     = sy-msgno
*            i_msgv1     = sy-msgv1
*            i_msgv2     = sy-msgv2
*            i_msgv3     = sy-msgv3
*            i_msgv4     = sy-msgv4
*            i_fieldname = <ls_good_cell>-fieldname
*            i_row_id    = <ls_good_cell>-row_id
*            i_tabix     = <ls_good_cell>-tabix.
*      ENDIF .
    ENDLOOP .
  ENDIF. "MODIF ETODR SPEC-40749
  IF l_error IS NOT INITIAL .
    er_data_changed->display_protocol( i_optimize_columns = 'X') .

*<<INS EEMGA SPEC-7298 : Copy/paste en llistats ALV GRID no controla.....
    IF my_backend->sap_error = 'X' AND
       sy-ucomm <> 'BACK'          AND
       sy-ucomm <> 'CANCEL'.

      CALL FUNCTION 'POPUP_TO_INFORM'
        EXPORTING
          titel = 'Error'
          txt1  = 'S''ha produït un error relacionat amb la visualització de les dades. Si us plau,'
          txt2  = 'surti de l’aplicació i torni a accedir-hi.En entrar(abans de començar a puntuar)'
          txt3  = 'caldrà que mogui la barra de desplaçament situada a la dreta (Scroll Down), per'
          txt4  = 'tal que visualitzi la totalitat de les dades de la graella en sentit vertical.'.
    ENDIF.
*>>INS EEMGA SPEC-7298 : Copy/paste en llistats ALV GRID no controla.....
  ENDIF .
ENDMETHOD.


METHOD on_data_changed_finished.
  DATA: lcx TYPE REF TO zcx_rm_valoracio .
  CHECK e_modified IS NOT INITIAL .
  TRY .
** INI SPEC-80664 ECAGM 23.11.2023
*      me->recalculate( ) .
      me->recalculate_no_refresh( ) .
** END SPEC-80664 ECAGM 23.11.2023
    CATCH zcx_rm_valoracio INTO lcx .
      MESSAGE lcx TYPE 'I' DISPLAY LIKE 'E' .
  ENDTRY .
ENDMETHOD.


METHOD on_delayed_callback.

*  CHECK my_navigation_enabled IS NOT INITIAL .
*  show_navigation_box( ) .

ENDMETHOD.


  METHOD on_hotspot_click.
    TYPES: BEGIN OF ty_s_codi_crit_punt,
             z_codi_crit_punt TYPE z_codi_crit_punt,
           END OF ty_s_codi_crit_punt,
           ty_t_codi_crit_punt TYPE STANDARD TABLE OF ty_s_codi_crit_punt.
    FIELD-SYMBOLS: <lt_grid>      TYPE STANDARD TABLE.

    DATA: lt_codi_crit_punt             TYPE ty_t_codi_crit_punt,
          lt_puntuacio_apartat          TYPE zrm_cl_valoracio_ofertes=>ty_t_puntuacio_subapartats,
          lt_puntuacio_apartat_multiple TYPE zrm_cl_valoracio_ofertes=>ty_t_puntuacio_subapartats, "INI MODIF ETODR SPEC-47173
          lt_punt_multiple_aux          TYPE zrm_cl_valoracio_ofertes=>ty_t_puntuacio_subapartats, "INI MODIF ETODR SPEC-47173
          lt_puntuacio_apartat_aux      TYPE zrm_cl_valoracio_ofertes=>ty_t_puntuacio_subapartats,
          wa_motiv_mult                 TYPE zrm_cl_valoracio_ofertes=>ty_s_puntuacio_subapartats, "INI MODIF ETODR SPEC-47173
          lv_num_oferta                 TYPE z_num_ofer,
          ls_ref                        TYPE tabfield,
          lcx_valoracio                 TYPE REF TO zcx_rm_valoracio,
          lv_crit_punt                  TYPE z_codi_crit_punt,
          l_read_only                   TYPE xfeld,
          lv_mod_punt                   TYPE z_mod_crit_punt,
          lv_codi_comptador_equip       TYPE zrm_dt_punt_equi-z_comptador_equip, "SPEC-49500
          wa_ofer_all                   TYPE zrm_cl_valoracio_ofertes=>ty_s_punt_ofer_dyn_equi,
          lv_punt_aux                   TYPE string,
          lv_punt                       TYPE z_punt_max,
          lv_operacion                  TYPE z_punt,
          lt_punt_ofer_all              TYPE zrm_tt_dt_punt_ofer,
          lv_mod_crit_punt              TYPE z_mod_crit_punt,
          lv_codi_mat                   TYPE z_codi_mat,
          lt_punt_ofer_all_2_aux        TYPE zrm_cl_valoracio_ofertes=>ty_t_punt_ofer_dyn_equi, "SPEC-49500
          lt_punt_ofer_all_2            TYPE zrm_tt_dt_punt_ofer,
          lt_punt_ofer_all_equi         TYPE zrm_cl_valoracio_ofertes=>ty_t_punt_ofer_dyn_equi, "SPEC-49500
***INI MOD ETJHG - SPEC-46407
          lv_pes                        TYPE i,
          lv_max_punt_rec               TYPE z_punt_max.
***FIN MOD ETJHG - SPEC-46407
    ls_ref-tabname   = 'ZRM_DT_PUNT_OFER' .
    ls_ref-fieldname = 'Z_PUNTS' .
    ASSIGN my_table_ref->* TO <lt_grid>.

    READ TABLE <lt_grid> ASSIGNING FIELD-SYMBOL(<ls_grid>) INDEX e_row_id.
    CHECK sy-subrc = 0.
*    >>IN ETLJS SPEC-49806
    ASSIGN COMPONENT 'Z_EQUIP_MAX' OF STRUCTURE <ls_grid> TO FIELD-SYMBOL(<fs_button_equip>).
    IF sy-subrc = 0 AND <fs_button_equip> = abap_on.
      hotspot_click_equip( EXPORTING i_row_id     = e_row_id
                                     i_column_id  = e_column_id
                                     is_row_no    = es_row_no ).

      my_grid->check_changed_data( ).
      TRY.
          me->recalculate( ).
          RETURN.
        CATCH zcx_rm_valoracio .
          RETURN.
      ENDTRY.

    ENDIF.
*    <<FIN ETLJS SPEC-49806

*>> SPEC-55535, Inici modificació - ETLJS
    ASSIGN COMPONENT 'Z_INCR' OF STRUCTURE <ls_grid> TO FIELD-SYMBOL(<fs_inc>).
    IF sy-subrc = 0.
      IF <fs_inc> = abap_on.
        hotspot_click_incr( EXPORTING i_row_id     = e_row_id
                                      i_column_id  = e_column_id
                                      is_row_no    = es_row_no ).

        my_grid->check_changed_data( ).
        TRY.
            me->recalculate( ).
            RETURN.
          CATCH zcx_rm_valoracio .
            RETURN.
        ENDTRY.
      ENDIF.
    ENDIF.
*<< SPEC-55535, Final modificació - ETLJS

**  >> INI MODIF ETODR SPEC-50770
    ASSIGN COMPONENT 'Z_EQUIP_PDM' OF STRUCTURE <ls_grid> TO FIELD-SYMBOL(<fs_button_pdm_dedic_of>).
    IF sy-subrc = 0 AND <fs_button_pdm_dedic_of> = abap_on.
      hotspot_click_pdm_equip( EXPORTING i_row_id     = e_row_id
                                         i_column_id  = e_column_id
                                         is_row_no    = es_row_no ).
      my_grid->check_changed_data( ).
      TRY.
          me->recalculate( ).
          RETURN.
        CATCH zcx_rm_valoracio .
          RETURN.
      ENDTRY.

    ENDIF.
**  << FI MODIF ETODR SPEC-50770

**  >> INI MODIF ETODR SPEC-51135
    ASSIGN COMPONENT 'Z_EQUIP_COAUTOR' OF STRUCTURE <ls_grid> TO FIELD-SYMBOL(<fs_button_coautors>).
    IF sy-subrc = 0 AND <fs_button_coautors> = abap_on.
      hotspot_click_equip_coautor( EXPORTING i_row_id     = e_row_id
                                             i_column_id  = e_column_id
                                             is_row_no    = es_row_no ).
      my_grid->check_changed_data( ).
      TRY.
          me->recalculate( ).
          RETURN.
        CATCH zcx_rm_valoracio .
          RETURN.
      ENDTRY.
    ENDIF.
**  << FI MODIF ETODR SPEC-51135

**  >> INI MODIF ETODR SPEC-49500
    ASSIGN COMPONENT 'Z_EXCLOURE_LICI' OF STRUCTURE <ls_grid> TO FIELD-SYMBOL(<fs_button_excloure_from_lici>).
    IF sy-subrc = 0 AND <fs_button_excloure_from_lici> = abap_on.
      hotspot_click_exloure( EXPORTING i_row_id     = e_row_id
                                       i_column_id  = e_column_id
                                       is_row_no    = es_row_no ).

      my_grid->check_changed_data( ).
      TRY.
          me->recalculate( ).
          RETURN.
        CATCH zcx_rm_valoracio .
          RETURN.
      ENDTRY.
    ELSEIF 1 = 2 AND my_backend->get_is_nova_llei_92017( ) = abap_on AND my_backend->get_is_obert_preu( ) = abap_off.
      " Per ara aquesta funció està en desenvolupament per millorar la lògica del que ja funciona
      TRY.
          hotspot_click_puntuar( EXPORTING  i_row_id      = e_row_id
                                            i_column_id   = e_column_id
                                            is_row_no     = es_row_no ).
          my_grid->check_changed_data( ).
          me->recalculate( ).
          RETURN.
        CATCH zcx_rm_valoracio .
          RETURN.
      ENDTRY.
    ENDIF.
**  << FI MODIF ETODR SPEC-49500

    "INI ECDRB SPEC-64893
    ASSIGN COMPONENT 'Z_MULT_EQUIP_INCR' OF STRUCTURE <ls_grid> TO FIELD-SYMBOL(<fs_button_mult_equip_incr>).
    IF sy-subrc = 0 AND <fs_button_mult_equip_incr> = abap_on.
      hotspot_click_mult_equip_incr( EXPORTING i_row_id     = e_row_id
                                             i_column_id  = e_column_id
                                             is_row_no    = es_row_no ).
      my_grid->check_changed_data( ).
      TRY.
          me->recalculate( ).
          RETURN.
        CATCH zcx_rm_valoracio .
          RETURN.
      ENDTRY.
    ENDIF.
    "FI ECDRB SPEC-64893
    ">> SPEC-67070, Inici Modificació - ETODR
    ASSIGN COMPONENT 'Z_COEFI_IREF' OF STRUCTURE <ls_grid> TO FIELD-SYMBOL(<fs_button_coefi_iref>).
    IF sy-subrc = 0 AND <fs_button_coefi_iref> = abap_on.
      hotspot_click_coefi_iref( EXPORTING i_row_id     = e_row_id
                                          i_column_id  = e_column_id
                                          is_row_no    = es_row_no ).
      my_grid->check_changed_data( ).
      TRY.
          me->recalculate( ).
          RETURN.
        CATCH zcx_rm_valoracio .
          RETURN.
      ENDTRY.
    ENDIF.
    "<< SPEC-67070, Final Modificació - ETODR

    ">> SPEC-71214, Inici Modificació - ETODR
    ASSIGN COMPONENT 'Z_CO2' OF STRUCTURE <ls_grid> TO FIELD-SYMBOL(<fs_button_co2>).
    IF sy-subrc = 0 AND <fs_button_co2> = abap_on.
** INI ECAGM SPEC-79620 DUMP al no tenir material informat
      CLEAR lv_codi_mat.
      IF my_backend IS BOUND.
        DATA(ls_plec) = my_backend->get_plec( ).
        lv_mod_crit_punt = ls_plec-z_mod_crit_punt.

        SELECT SINGLE z_codi_mat INTO lv_codi_mat
             FROM zrm_dm_mat_co2
             WHERE docclass        = gv_docclass
               AND objectid        = gv_objectid
               AND z_mod_crit_punt LIKE lv_mod_crit_punt.
      ELSE.
        SELECT SINGLE z_codi_mat INTO lv_codi_mat
             FROM zrm_dm_mat_co2
             WHERE docclass        = gv_docclass
               AND objectid        = gv_objectid.
      ENDIF.
      IF lv_codi_mat IS NOT INITIAL.
** END ECAGM SPEC-79620
        hotspot_click_co2( EXPORTING i_row_id     = e_row_id
                                     i_column_id  = e_column_id
                                     is_row_no    = es_row_no ).
        my_grid->check_changed_data( ).
        TRY.
            me->recalculate( ).
            RETURN.
          CATCH zcx_rm_valoracio .
            RETURN.
        ENDTRY.
      ELSE.
        MESSAGE i222(wn).
        RETURN.
      ENDIF.
    ENDIF.
    "<< SPEC-71214, Final Modificació - ETODR

    ASSIGN COMPONENT 'Z_CODI_CRIT_PUNT' OF STRUCTURE <ls_grid> TO FIELD-SYMBOL(<lv_crit_punt>).
    CHECK sy-subrc = 0.
    ASSIGN COMPONENT 'Z_MOD_CRIT_PUNT'  OF STRUCTURE <ls_grid> TO FIELD-SYMBOL(<lv_mod_punt>). "
    CHECK sy-subrc = 0.
    ASSIGN COMPONENT e_column_id        OF STRUCTURE <ls_grid> TO FIELD-SYMBOL(<lv_punt>).     "Recollir empresa
    CHECK sy-subrc = 0.
**  >> INI MODIF ETODR SPEC-49500
    ASSIGN COMPONENT 'Z_COMPTADOR_EQUIP' OF STRUCTURE <ls_grid> TO FIELD-SYMBOL(<lv_comptador_equip>).     "Comptador d'equip
    CHECK sy-subrc = 0.
**  << FI MODIF ETODR SPEC-49500

    LOOP AT my_columns ASSIGNING FIELD-SYMBOL(<fs_column_sel>) WHERE fieldname = e_column_id.
      lv_num_oferta = <fs_column_sel>-key.
      EXIT.
    ENDLOOP.
    CHECK lv_num_oferta IS NOT INITIAL.

    lv_crit_punt = <lv_crit_punt>.
    lv_mod_punt  = <lv_mod_punt>.
    lv_codi_comptador_equip = <lv_comptador_equip>. "SPEC-49500

**  >> INI MODIF ETODR SPEC-45407
    TRY.
        DATA(lt_crit_aux_punt) = my_backend->get_crit_punt_offers( im_only_used_ones = abap_off ).
      CATCH cx_root.
        RETURN.
    ENDTRY.
    LOOP AT lt_crit_aux_punt ASSIGNING FIELD-SYMBOL(<fs_aux_punt>) WHERE z_codi_subapar_punt IS NOT INITIAL.
      IF lv_crit_punt IS NOT INITIAL.
        IF <fs_aux_punt>-z_codi_crit_punt <> lv_crit_punt.
          CONTINUE.
        ENDIF.
      ENDIF.
      IF lv_mod_punt IS INITIAL.
        lv_mod_punt = <fs_aux_punt>-z_mod_crit_punt.
      ENDIF.
**    >> INI MODIF ETODR SPEC-49500
      IF <fs_aux_punt>-z_num_equip <> lv_codi_comptador_equip.
        CONTINUE.
      ENDIF.
**    << FI MODIF ETODR SPEC-49500
      ">>>SPEC-55535, Inici modificació  - ETODR
      "Si és un criteri de INCR vol dir que es calcula a partir d'una fórmula i, tot i tenir subapartat, no s'ha de puntuar així
      IF <fs_aux_punt>-z_incr IS NOT INITIAL.
        CONTINUE.
      ENDIF.
      "<<<SPEC-55535, Final modificació - ETODR
      APPEND <fs_aux_punt>-z_codi_crit_punt TO lt_codi_crit_punt.
    ENDLOOP.
*    lt_codi_crit_punt = VALUE #( ( z_codi_crit_punt = lv_crit_punt ) ).
**  >> INI MODIF ETODR SPEC-45407
    my_backend->get_dades_ofer_dyn( IMPORTING ex_punt_ofer_dyn      = lt_punt_ofer_all
                                              ex_punt_ofer_dyn_equi = DATA(lt_punt_equi) ). "SPEC-49500
    IF lt_punt_ofer_all[] IS INITIAL.
      SELECT *
        FROM zrm_dt_punt_ofer
**        >> INI MODIF ETODR SPEC-49500
*        INTO TABLE @lt_punt_ofer_all
        INTO CORRESPONDING FIELDS OF TABLE @lt_punt_ofer_all_equi
**        << FI MODIF ETODR SPEC-49500
        FOR ALL ENTRIES IN @lt_codi_crit_punt
        WHERE docclass         = @gv_docclass
          AND objectid         = @gv_objectid
          AND z_num_ofer       = @lv_num_oferta
          AND z_mod_crit_punt  = @lv_mod_punt
          AND z_codi_crit_punt = @lt_codi_crit_punt-z_codi_crit_punt
          AND z_no_aplica      = @abap_off.                          "si no aplica no s'ha de mostrar ni recuperar
      CHECK sy-subrc = 0.
    ELSE.
      LOOP AT lt_codi_crit_punt ASSIGNING FIELD-SYMBOL(<fs_crit_punt>).
        LOOP AT lt_punt_ofer_all ASSIGNING FIELD-SYMBOL(<fs_ofer_all>) WHERE z_codi_crit_punt = <fs_crit_punt>-z_codi_crit_punt
                                                                         AND z_no_aplica      = abap_off
                                                                         AND z_num_ofer       = lv_num_oferta.
**        >> INI MODIF ETODR SPEC-49500 "Només es mostra el criteri d'equip del membre seleccionat
          CLEAR: wa_ofer_all.
          MOVE-CORRESPONDING <fs_ofer_all> TO wa_ofer_all.
          IF lv_codi_comptador_equip IS NOT INITIAL.
            READ TABLE lt_punt_equi ASSIGNING FIELD-SYMBOL(<fs_equi>) WITH KEY z_codi_crit_punt  = <fs_ofer_all>-z_codi_crit_punt
                                                                               z_comptador_equip = lv_codi_comptador_equip
                                                                               z_num_ofer        = lv_num_oferta.
            IF sy-subrc <> 0.
              CONTINUE.
            ELSE.
              wa_ofer_all-z_comptador_equip = <fs_equi>-z_comptador_equip.
              wa_ofer_all-z_sec             = <fs_equi>-z_sec.
              wa_ofer_all-z_punts           = <fs_equi>-z_punts.
            ENDIF.
          ENDIF.
          APPEND wa_ofer_all TO lt_punt_ofer_all_2_aux.
**        << FI MODIF ETODR SPEC-49500
          APPEND <fs_ofer_all> TO lt_punt_ofer_all_2.
        ENDLOOP.
      ENDLOOP.
      lt_punt_ofer_all[]      = lt_punt_ofer_all_2[].
      lt_punt_ofer_all_equi[] = lt_punt_ofer_all_2_aux[]. "MODIF ETODR SPEC-49500
    ENDIF.

*    DESCRIBE TABLE lt_punt_ofer_all LINES DATA(l_num_crit_punt).     "MODIF ETODR SPEC-49500
    DESCRIBE TABLE lt_punt_ofer_all_equi LINES DATA(l_num_crit_punt). "MODIF ETODR SPEC-49500

*    LOOP AT lt_punt_ofer_all ASSIGNING FIELD-SYMBOL(<fs_all>).       "MODIF ETODR SPEC-49500
    LOOP AT lt_punt_ofer_all_equi ASSIGNING FIELD-SYMBOL(<fs_all>).   "MODIF ETODR SPEC-49500
      CLEAR: lt_puntuacio_apartat_aux[].
      CHECK <fs_all>-z_codi_subapar_punt IS NOT INITIAL.
      my_backend->get_punt_subapart( EXPORTING i_subapartat      = <fs_all>-z_codi_subapar_punt
                                     IMPORTING et_dades_subapart = lt_puntuacio_apartat_aux ).

      DELETE lt_puntuacio_apartat_aux WHERE z_num_ofer <> <fs_all>-z_num_ofer.
**    >> INI MODIF ETODR SPEC-49500
      LOOP AT lt_puntuacio_apartat_aux ASSIGNING FIELD-SYMBOL(<fs_punt_apar_aux>).
        IF lv_codi_comptador_equip IS NOT INITIAL.
          IF <fs_punt_apar_aux>-z_num_equip <> <fs_all>-z_comptador_equip.
            DELETE lt_puntuacio_apartat_aux.
            CONTINUE.
          ENDIF.
        ENDIF.
        <fs_punt_apar_aux>-z_num_equip = <fs_all>-z_comptador_equip.
      ENDLOOP.
**    << FI MODIF ETODR SPEC-49500
      APPEND LINES OF lt_puntuacio_apartat_aux TO lt_puntuacio_apartat.
    ENDLOOP.
**  >> INI MODIF ETODR SPEC-47173
    my_backend->get_motivacio_multi( IMPORTING et_motiv_mult = DATA(lt_motiv_mult) ).
    CLEAR: lt_puntuacio_apartat_multiple[].
    LOOP AT lt_motiv_mult ASSIGNING FIELD-SYMBOL(<fs_motiv_mult>).
      MOVE-CORRESPONDING <fs_motiv_mult> TO wa_motiv_mult.
      APPEND wa_motiv_mult TO lt_puntuacio_apartat_multiple.
    ENDLOOP.
**  << FI MODIF ETODR SPEC-47173

    "Reset del log temporal
    my_backend->reset_log_pt( ).
    IF my_read_only IS NOT INITIAL OR  my_backend->check_activity( my_backend_activities-save_punct ) IS INITIAL.
      l_read_only = abap_on.
    ENDIF.
    CALL FUNCTION 'ZRM_PUNTUACIO_OFERTES'
      EXPORTING
        im_mod_crit           = lv_mod_punt
        im_docclass           = gv_docclass
        im_objectid           = gv_objectid
        it_punt_ofer          = lt_punt_ofer_all
        it_punt_ofer_equi     = lt_punt_ofer_all_equi
        im_backend            = my_backend
        im_column             = <fs_column_sel>
        im_grid               = <ls_grid>
        i_readonly            = l_read_only
      CHANGING
        ct_puntuacio          = lt_puntuacio_apartat
        ct_puntuacio_multiple = lt_puntuacio_apartat_multiple
      EXCEPTIONS
        not_subapartat        = 1
        not_changed           = 2
        other                 = 3.

    IF sy-subrc <> 0.
      "Si s'han cancel·lat els canvis s'elimina la taula de log temporal que s'havia creat
      my_backend->reset_log_pt( ).
      EXIT.
    ENDIF.
    "Si s'han acceptat els canvis passem les dades dels registres de modificacions al log final encarregat del guardat.
    "S'ha de fer un log "temporal" per a no traspassar les dades directament i evitar així q es guardin dades cancel·lades
    my_backend->set_temporal_log_pt( ).
    "Per cada criteri puntuar actualitzar LT_GRID
    DESCRIBE TABLE <lt_grid> LINES DATA(l_num).
    DO l_num TIMES.
      DATA(l_index) = sy-index.
      READ TABLE <lt_grid> ASSIGNING <ls_grid> INDEX l_index.
      IF sy-subrc = 0.
        ASSIGN COMPONENT 'Z_CODI_CRIT_PUNT' OF STRUCTURE <ls_grid> TO <lv_crit_punt>.
        CHECK sy-subrc = 0 AND <lv_crit_punt> IS NOT INITIAL.
        ASSIGN COMPONENT 'Z_MOD_CRIT_PUNT'  OF STRUCTURE <ls_grid> TO <lv_mod_punt>.
        CHECK sy-subrc = 0.
        ASSIGN COMPONENT 'Z_PUNT_MAX' OF STRUCTURE <ls_grid> TO FIELD-SYMBOL(<lv_punt_max_2>).
        CHECK sy-subrc = 0.
**  >> INI MODIF ETODR SPEC-49500
        ASSIGN COMPONENT 'Z_COMPTADOR_EQUIP' OF STRUCTURE <ls_grid> TO FIELD-SYMBOL(<lv_comptador_equip2>).     "Comptador d'equip
        CHECK sy-subrc = 0.
        IF lv_codi_comptador_equip IS NOT INITIAL.
          IF <lv_comptador_equip2> <> <lv_comptador_equip>.
            CONTINUE.
          ENDIF.
        ENDIF.
**  << FI MODIF ETODR SPEC-49500
        DATA(lt_puntuacio_aux)          = lt_puntuacio_apartat.
        DATA(lt_puntuacio_apartat_aux2) = lt_puntuacio_apartat.
        DELETE ADJACENT DUPLICATES FROM lt_puntuacio_aux COMPARING z_codi_crit_punt.
***INI MOD ETJHG - SPEC-46407
        DELETE ADJACENT DUPLICATES FROM lt_puntuacio_apartat COMPARING z_codi_crit_punt z_compta_rec.
***FIN MOD ETJHG - SPEC-46407
        LOOP AT lt_puntuacio_aux ASSIGNING FIELD-SYMBOL(<fs_aux_punt_2>) WHERE z_codi_crit_punt = <lv_crit_punt>.
          CLEAR: lt_puntuacio_apartat_aux2[].
          CLEAR: lv_punt, lv_punt_aux.

          LOOP AT lt_puntuacio_apartat ASSIGNING FIELD-SYMBOL(<fs_punt_sel_2>) WHERE z_codi_crit_punt = <fs_aux_punt_2>-z_codi_crit_punt.
            IF <fs_punt_sel_2>-z_pes IS INITIAL.
              lv_pes = 100.
            ELSE.
              lv_pes = <fs_punt_sel_2>-z_pes.
            ENDIF.
            lv_operacion  = CONV #( <fs_punt_sel_2>-z_punts ).
**          >> INI MODIF ETODR SPEC-49500
            IF <lv_comptador_equip2> IS NOT INITIAL.
              lv_punt = lv_operacion.
            ELSE.
**          << INI MODIF ETODR SPEC-49500
              lv_punt       = lv_punt + ( lv_operacion * ( lv_pes / 100 ) ).
            ENDIF.
**          >> INI MODIF ETODR SPEC-49075
            <fs_punt_sel_2>-z_punts_no_pond = lv_punt.
**          << FI MODIF ETODR SPEC-49075
            APPEND <fs_punt_sel_2> TO lt_puntuacio_apartat_aux2.
          ENDLOOP.
          lv_punt_aux  = lv_punt.

          REPLACE ALL OCCURRENCES OF '.' IN lv_punt_aux WITH ','.
          <lv_punt> = lv_punt_aux.

          SELECT SINGLE z_mult_rec
            FROM zrm_dm_crit_punt
            INTO @DATA(lv_mult_rec2)
              WHERE z_mod_crit_punt  EQ @lv_mod_punt
                AND z_codi_crit_punt EQ @<fs_aux_punt_2>-z_codi_crit_punt.
**        >> INI MODIF ETODR SPEC-49500
          SELECT COUNT(*)
            FROM zrm_dt_punt_equi
              WHERE z_mod_crit_punt  EQ @lv_mod_punt
                AND z_codi_crit_punt EQ @<fs_aux_punt_2>-z_codi_crit_punt.
          IF sy-subrc = 0.
            DATA(lv_mult_equip2) = abap_on.
          ENDIF.
**        << FI MODIF ETODR SPEC-49500
          "Actualitzar taula amb valors seleccionats per a poder desar-la al SAVE / CONFIRMAR DADES
          my_backend->set_punt_subapart( it_dades_subapart = lt_puntuacio_apartat_aux2
                                         lv_punt           = lv_punt
                                         lv_mult_rec       = lv_mult_rec2
                                         is_mult_equip     = lv_mult_equip2 ). "SPEC-49500
        ENDLOOP.

      ENDIF.
    ENDDO.

**      >> INI MODIF ETODR SPEC-47173 & ETJMD SPEC-48559
    CLEAR: lt_punt_multiple_aux[].
*    LOOP AT lt_puntuacio_apartat_multiple ASSIGNING FIELD-SYMBOL(<fs_punt_multiple>).
*      APPEND <fs_punt_multiple> TO lt_punt_multiple_aux.
*    ENDLOOP.
    IF lt_puntuacio_apartat_multiple IS NOT INITIAL.
      my_backend->set_motivacio_mult( it_dades_subapart = lt_puntuacio_apartat_multiple ).
    ENDIF.
**      << FI MODIF ETODR SPEC-47173 & ETJMD SPEC-48559
*    DESCRIBE TABLE lt_punt_ofer_all LINES DATA(l_num_crit_punt).
*    IF l_num_crit_punt > 1.
*      puntua múltiples subcriteris al mateix temps
*      LOOP AT lt_punt_ofer_all ASSIGNING FIELD-SYMBOL(<fs_all>).
*        CLEAR: lt_puntuacio_apartat_aux[].
*        my_backend->get_punt_subapart( EXPORTING i_subapartat      = <fs_all>-z_codi_subapar_punt
*                                       IMPORTING et_dades_subapart = lt_puntuacio_apartat_aux ).
*
*        DELETE lt_puntuacio_apartat_aux WHERE z_num_ofer <> <fs_all>-z_num_ofer.
*        APPEND LINES OF lt_puntuacio_apartat_aux TO lt_puntuacio_apartat.
*      ENDLOOP.
*
*      CALL FUNCTION 'ZRM_PUNTUACIO_OFERTES'
*        EXPORTING
*          im_mod_crit    = lv_mod_punt
*          im_docclass    = gv_docclass
*          im_objectid    = gv_objectid
*          it_punt_ofer   = lt_punt_ofer_all
*          im_backend     = my_backend
*          im_column      = <fs_column_sel>
*          im_grid        = <ls_grid>
*        CHANGING
*          ct_puntuacio   = lt_puntuacio_apartat
*        EXCEPTIONS
*          not_subapartat = 1.
*
*      CHECK sy-subrc = 0.
*
*      "Per cada criteri puntuar actualitzar LT_GRID
*      DESCRIBE TABLE <lt_grid> LINES DATA(l_num).
*      DO l_num TIMES.
*        DATA(l_index) = sy-index.
*        READ TABLE <lt_grid> ASSIGNING <ls_grid> INDEX l_index.
*        IF sy-subrc = 0.
*          ASSIGN COMPONENT 'Z_CODI_CRIT_PUNT' OF STRUCTURE <ls_grid> TO <lv_crit_punt>.
*          CHECK sy-subrc = 0 AND <lv_crit_punt> IS NOT INITIAL.
*          ASSIGN COMPONENT 'Z_MOD_CRIT_PUNT'  OF STRUCTURE <ls_grid> TO <lv_mod_punt>.
*          CHECK sy-subrc = 0.
*          ASSIGN COMPONENT 'Z_PUNT_MAX' OF STRUCTURE <ls_grid> TO FIELD-SYMBOL(<lv_punt_max_2>).
*          CHECK sy-subrc = 0.
*
*          DATA(lt_puntuacio_aux)          = lt_puntuacio_apartat.
*          DATA(lt_puntuacio_apartat_aux2) = lt_puntuacio_apartat.
*          DELETE ADJACENT DUPLICATES FROM lt_puntuacio_aux COMPARING z_codi_crit_punt.
****INI MOD ETJHG - SPEC-46407
*          DELETE ADJACENT DUPLICATES FROM lt_puntuacio_apartat COMPARING z_codi_crit_punt z_compta_rec.
****FIN MOD ETJHG - SPEC-46407
*          LOOP AT lt_puntuacio_aux ASSIGNING FIELD-SYMBOL(<fs_aux_punt_2>).
*            CLEAR: lt_puntuacio_apartat_aux2[].
**            CLEAR: lv_punt_rec, lv_max_punt_rec, lv_punt, lv_punt_aux.
*            CLEAR: lv_punt, lv_punt_aux.
*
*            LOOP AT lt_puntuacio_apartat ASSIGNING FIELD-SYMBOL(<fs_punt_sel_2>) WHERE z_codi_crit_punt = <fs_aux_punt_2>-z_codi_crit_punt.
**              lv_punt_rec = lv_punt_rec + <fs_punt_sel_2>-z_punts.
**              lv_max_punt_rec = lv_max_punt_rec + <lv_punt_max_2>.
*              IF <fs_punt_sel_2>-z_pes IS INITIAL.
*                lv_pes = 100.
*              ELSE.
*                lv_pes = <fs_punt_sel_2>-z_pes.
*              ENDIF.
*              lv_punt = lv_punt + ( <fs_punt_sel_2>-z_punts * ( lv_pes / 100 ) ).
*              APPEND <fs_punt_sel_2> TO lt_puntuacio_apartat_aux2.
*            ENDLOOP.
*
**            lv_operacion = lv_punt_rec * <lv_punt_max_2>.
**            lv_operacion = lv_operacion / lv_max_punt_rec.
*
**            lv_punt      = lv_operacion.
*            lv_punt_aux  = lv_punt.
*
*            REPLACE ALL OCCURRENCES OF '.' IN lv_punt_aux WITH ','.
*            <lv_punt> = lv_punt_aux.
*
*            SELECT SINGLE z_mult_rec
*              FROM zrm_dm_crit_punt
*              INTO @DATA(lv_mult_rec2)
*                WHERE z_mod_crit_punt  EQ @lv_mod_punt
*                  AND z_codi_crit_punt EQ @<fs_aux_punt_2>-z_codi_crit_punt.
*            "Actualitzar taula amb valors seleccionats per a poder desar-la al SAVE / CONFIRMAR DADES
*            my_backend->set_punt_subapart( it_dades_subapart = lt_puntuacio_apartat_aux2
*                                           lv_punt           = lv_punt
*                                           lv_mult_rec       = lv_mult_rec2 ).
*          ENDLOOP.
*
*        ENDIF.
*      ENDDO.
*
*    ELSE.
*      "puntua un sol criteri al mateix temps
*      READ TABLE lt_punt_ofer_all INTO DATA(wa_punt_ofer) WITH KEY z_codi_crit_punt = lv_crit_punt.
*
*      CHECK sy-subrc = 0.
*
*      my_backend->get_punt_subapart( EXPORTING i_subapartat      = wa_punt_ofer-z_codi_subapar_punt
*                                     IMPORTING et_dades_subapart = lt_puntuacio_apartat ).
*
*      DELETE lt_puntuacio_apartat WHERE z_num_ofer <> wa_punt_ofer-z_num_ofer.
*
*      CALL FUNCTION 'ZRM_PUNTUACIO_OFERTES'
*        EXPORTING
*          im_crit_punt   = lv_crit_punt
*          im_mod_crit    = lv_mod_punt
*          im_docclass    = gv_docclass
*          im_objectid    = gv_objectid
*          im_punt_ofer   = wa_punt_ofer
*          im_backend     = my_backend
*          im_column      = <fs_column_sel>
*          im_grid        = <ls_grid>
*        CHANGING
*          ct_puntuacio   = lt_puntuacio_apartat
*        EXCEPTIONS
*          not_subapartat = 1.
*
*      CHECK sy-subrc = 0.
*
****INI MOD ETJHG - SPEC-46407
**    READ TABLE lt_puntuacio_apartat ASSIGNING FIELD-SYMBOL(<fs_punt_sel>) INDEX 1.
**    CHECK sy-subrc = 0.
*      "Puntuació ponderada recursos puntuats
*      "Fórmula: Suma [ Puntuació Recurs * ( Pes / 100 ) ]
*      ASSIGN COMPONENT 'Z_PUNT_MAX' OF STRUCTURE <ls_grid> TO FIELD-SYMBOL(<lv_punt_max>).
*
*      LOOP AT lt_puntuacio_apartat ASSIGNING FIELD-SYMBOL(<fs_punt_sel>).
**        lv_punt_rec     = lv_punt_rec + <fs_punt_sel>-z_punts.
**        lv_max_punt_rec = lv_max_punt_rec + <lv_punt_max>.
*        IF <fs_punt_sel>-z_pes IS INITIAL.
*          lv_pes = 100.
*        ELSE.
*          lv_pes = <fs_punt_sel>-z_pes.
*        ENDIF.
*        lv_punt = lv_punt + ( <fs_punt_sel>-z_punts * ( lv_pes / 100 ) ).
*      ENDLOOP.
*
**      lv_operacion = lv_punt_rec * <lv_punt_max>.
**      lv_operacion = lv_operacion / lv_max_punt_rec.
*
**      lv_punt = lv_operacion.
*      lv_punt_aux = lv_punt.
****FIN MOD ETJHG - SPEC-46407
*
*      REPLACE ALL OCCURRENCES OF '.' IN lv_punt_aux WITH ','.
*      <lv_punt> = lv_punt_aux.
*
****INI MOD ETJHG - SPEC-46407
*      SELECT SINGLE z_mult_rec
*        FROM zrm_dm_crit_punt
*        INTO @DATA(lv_mult_rec)
*          WHERE z_mod_crit_punt   EQ @lv_mod_punt
*            AND z_codi_crit_punt  EQ @lv_crit_punt.
****FIN MOD ETJHG - SPEC-46407
*
*      "Actualitzar taula amb valors seleccionats per a poder desar-la al SAVE / CONFIRMAR DADES
*      my_backend->set_punt_subapart( it_dades_subapart = lt_puntuacio_apartat
*                                     lv_punt           = lv_punt        "MOD ETJHG - SPEC-46407
*                                     lv_mult_rec       = lv_mult_rec ). "MOD ETJHG - SPEC-46407
*
*    ENDIF.
***  << FI MODIF ETODR SPEC-45407
*
    my_grid->check_changed_data( IMPORTING e_valid   = DATA(l_valid) ).

    TRY.
        me->recalculate( ).
      CATCH zcx_rm_valoracio .
        RETURN.
    ENDTRY.
*
  ENDMETHOD.


METHOD on_menu_button.
  DATA: l_text  TYPE char40,
        l_fcode TYPE sy-ucomm,
        l_legth TYPE i,
        l_from  TYPE i,
        l_to    TYPE i,
        l_total TYPE i.

  CASE e_ucomm .
    WHEN co_fc_goto_page .
      DESCRIBE TABLE my_columns LINES l_total.
      l_from = 1 .
      WHILE l_to NE l_total .
        l_fcode = e_ucomm .
        WRITE sy-index TO l_fcode+3 LEFT-JUSTIFIED .

        l_to = l_from + co_max_cols_shown - 1 .
        IF l_to GT l_total .
          l_to = l_total .
          l_from = l_total - co_max_cols_shown + 1 .
        ENDIF .

        WRITE l_from TO l_text LEFT-JUSTIFIED .
        CONCATENATE l_text '-' INTO l_text SEPARATED BY space .
        l_legth = strlen( l_text ) + 1 .
        WRITE l_to TO l_text+l_legth LEFT-JUSTIFIED .
        CALL METHOD e_object->add_function
          EXPORTING
            fcode = l_fcode
            text  = l_text.

        ADD co_max_cols_shown TO l_from .
      ENDWHILE .

    WHEN co_fc_sort_up_name .
      CALL METHOD e_object->add_function
        EXPORTING
          fcode = co_fc_sort_up_name
          text  = text-f01.

      CALL METHOD e_object->add_function
        EXPORTING
          fcode = co_fc_sort_up_punt
          text  = text-f02.

      CALL METHOD e_object->add_function
        EXPORTING
          fcode = co_fc_sort_down_name
          text  = text-f03.

      CALL METHOD e_object->add_function
        EXPORTING
          fcode = co_fc_sort_down_punt
          text  = text-f04.

    WHEN co_fc_create_doc .
      CASE my_mode .
        WHEN co_mode_1_round .
          CALL METHOD e_object->add_function
            EXPORTING
              fcode = co_fc_create_q4_draft
              text  = text-f10.

          CALL METHOD e_object->add_function
            EXPORTING
              fcode = co_fc_create_q4_int
              text  = text-f11.
        WHEN co_mode_adj_2nd .
          CALL METHOD e_object->add_function
            EXPORTING
              fcode = co_fc_create_q4b_draft
              text  = text-f13.
        WHEN co_mode_punct_1st .
          CALL METHOD e_object->add_function
            EXPORTING
              fcode = co_fc_create_q4a_draft
              text  = text-f14.
        WHEN co_mode_punct_2nd .
          CALL METHOD e_object->add_function
            EXPORTING
              fcode = co_fc_create_q4lem_draft
              text  = text-f15.
        WHEN co_mode_punct_tec.
          CALL METHOD e_object->add_function
            EXPORTING
              fcode = co_fc_create_q2b_draft
              text  = text-f16.
        WHEN co_mode_punt_sol_part.
          CALL METHOD e_object->add_function
            EXPORTING
              fcode = co_fc_create_q1b_draft
              text  = text-f17.
**     >> INI MODIF ETODR SPEC-49075
        WHEN zrm_cl_valoracio_ofertes=>co_mode_punt_quadre2b.
          CALL METHOD e_object->add_function
            EXPORTING
              fcode = co_fc_create_q2b_92017
              text  = text-f16.
        WHEN zrm_cl_valoracio_ofertes=>co_mode_punt_quadre3b.
*** JGG SPEC-64927 -->
          IF gs_exp_cont-z_proc_adj = 'CE'.
            CALL METHOD e_object->add_function
              EXPORTING
                fcode = co_fc_create_q3b_92017
                text  = text-f16.
          ELSE.
*** JGG SPEC-64927 <--
            CALL METHOD e_object->add_function
              EXPORTING
                fcode = co_fc_create_q3b_92017
                text  = text-f20.
*** JGG SPEC-64927 -->
          ENDIF.
*** JGG SPEC-64927 <--

        WHEN zrm_cl_valoracio_ofertes=>co_mode_punt_quadre4b.
          CALL METHOD e_object->add_function
            EXPORTING
              fcode = co_fc_create_q4b_92017
              text  = text-f13.
**     << FI MODIF ETODR SPEC-49075
      ENDCASE .

    WHEN co_puntuar.
      CALL METHOD e_object->add_function
        EXPORTING
          fcode = co_puntuar
          text  = text-f18.

  ENDCASE .
ENDMETHOD.


METHOD on_toolbar.


  ">>>SPEC:SPEC-67086, Inici modificació - ECJMS
  DATA: lt_punt_gen  TYPE zrm_cl_valoracio_ofertes=>ty_t_punt_gen.
  DATA: lt_crit_punt TYPE zrm_cl_valoracio_ofertes=>ty_t_crit_punt.
  DATA: ls_crit_punt TYPE zrm_cl_valoracio_ofertes=>ty_s_crit_punt.
  "<<<SPEC:SPEC-67086, Final modificació - ECJMS

  DATA: ls_toolbar  TYPE stb_button,
        lt_toolbar  LIKE e_object->mt_toolbar,
        l_length    TYPE i,
** >> INI SPEC-45341 ETETM - Acceso a cabecera de expediente para determinar si se habilita o no
** el botón de puntuación dinámica.

        ls_exp_cont TYPE zrm_dt_exp_cont.

  SELECT SINGLE * FROM zrm_dt_exp_cont INTO ls_exp_cont
   WHERE docclass = gs_exp_cont-docclass AND
         objectid = gs_exp_cont-objectid .

** >> FI SPEC-45341 ETETM

*-- De la barra estàndar end quedarem només amb les funcions d'exportació ---------
  DELETE e_object->mt_toolbar WHERE function NE cl_gui_alv_grid=>mc_mb_export.
  lt_toolbar = e_object->mt_toolbar .

  REFRESH e_object->mt_toolbar .

  IF my_backend_activities-save_punct IS NOT INITIAL .
    CLEAR ls_toolbar .
    ls_toolbar-function  = co_fc_save .
    ls_toolbar-icon      = icon_system_save .
    ls_toolbar-text      = 'Desar'(f05).
    ls_toolbar-butn_type = 0 .
    IF  my_read_only IS NOT INITIAL
     OR my_backend->check_activity( my_backend_activities-save_punct ) IS INITIAL .
      ls_toolbar-disabled  = 'X' .
    ENDIF .
    INSERT ls_toolbar INTO TABLE e_object->mt_toolbar .
  ENDIF .

  IF my_backend_activities-confirm_punct IS NOT INITIAL .
    CLEAR ls_toolbar .
    ls_toolbar-function = co_fc_confirm .
    ls_toolbar-icon     = icon_system_okay .
    ls_toolbar-text     = 'Confirmar dades'(f06).
    ls_toolbar-butn_type = 0 .

    IF my_backend->check_activity( my_backend_activities-confirm_punct ) IS INITIAL
    OR my_read_only IS NOT INITIAL.
      ls_toolbar-disabled  = 'X' .
    ENDIF .
    INSERT ls_toolbar INTO TABLE e_object->mt_toolbar .
  ENDIF .

  IF my_backend_activities-set_awarded IS NOT INITIAL .
    CLEAR ls_toolbar .
    ls_toolbar-function = co_fc_set_awardee .
    ls_toolbar-icon     = icon_selection .
    ls_toolbar-text     = 'Adj.Prov'(f07).
    ls_toolbar-butn_type = 0 .
    IF my_backend->check_activity( my_backend_activities-set_awarded ) IS INITIAL
    OR my_read_only IS NOT INITIAL .
      ls_toolbar-disabled  = 'X' .
    ENDIF .
    INSERT ls_toolbar INTO TABLE e_object->mt_toolbar .
  ENDIF .

*>> Ini  SPEC-54695  - ETMAE

  IF my_backend_activities-set_millor_cla IS NOT INITIAL .
    CLEAR ls_toolbar .
    ls_toolbar-function  = co_fc_set_best_classified .
    ls_toolbar-icon      = icon_selection .
    ls_toolbar-text      = 'Solv.'(f22).
    ls_toolbar-quickinfo = 'Oferta Millor Classificada'.
    ls_toolbar-butn_type = 0 .
    IF my_backend->check_activity( my_backend_activities-set_millor_cla ) IS INITIAL
    OR my_read_only IS NOT INITIAL .
      ls_toolbar-disabled  = abap_true .
    ENDIF .
    INSERT ls_toolbar INTO TABLE e_object->mt_toolbar .
  ENDIF .

*<< Fi  SPEC-54695  - ETMAE


  IF my_backend_activities-unconfirm IS NOT INITIAL .
    CLEAR ls_toolbar .
    ls_toolbar-function = co_fc_unlock .
    ls_toolbar-icon     = icon_unlocked .
    ls_toolbar-text     = 'Desbloquejar'(f08).
    ls_toolbar-butn_type = 0 .
    IF my_backend->check_activity( my_backend_activities-unconfirm ) IS INITIAL
    OR my_read_only IS NOT INITIAL .
      ls_toolbar-disabled  = 'X' .
    ENDIF .
    INSERT ls_toolbar INTO TABLE e_object->mt_toolbar .
  ENDIF .

  IF e_object->mt_toolbar IS NOT INITIAL .
    CLEAR ls_toolbar .
    ls_toolbar-butn_type = 3 .
    INSERT ls_toolbar INTO TABLE e_object->mt_toolbar .
  ENDIF .

*-- Afegim sempre la possibilitat d'ordenar i mostrar detallas -----------------------
  CLEAR ls_toolbar .
  ls_toolbar-function = co_fc_sort_up_name .
  ls_toolbar-icon     = icon_sort_up .
  ls_toolbar-text     = 'Ordenació'(f00).
  ls_toolbar-butn_type = 2 .
  INSERT ls_toolbar INTO TABLE e_object->mt_toolbar .

  CLEAR ls_toolbar .
  ls_toolbar-function = co_fc_toggle_nav  .
  ls_toolbar-icon     = icon_doc_item_detail .
  ls_toolbar-text     = 'Detalls'(f09).
  ls_toolbar-checked  = my_navigation_enabled .
  ls_toolbar-butn_type = 5 .
  INSERT ls_toolbar INTO TABLE e_object->mt_toolbar .

  CLEAR ls_toolbar .
*<< INICI ECBAC 67400 30.12.2021
  IF gs_exp_cont-z_proc_adj NE 'CE'.
*>> FI ECBAC 67400 30.12.2021
    IF my_mode <> zrm_cl_valoracio_ofertes=>co_mode_val_cap_obra.   "Insert PSPEC-1451 Inici modificació - EVXGL
      CLEAR ls_toolbar .
      ls_toolbar-function = co_fc_create_doc  .
      ls_toolbar-icon     = icon_xls .
      ls_toolbar-text     = 'Quadres'(f12).
      ls_toolbar-butn_type = 2 .
      INSERT ls_toolbar INTO TABLE e_object->mt_toolbar .
    ENDIF.
  ENDIF.


** >> INI SPEC-45341 ETETM - Nuevo Botón para volver a puntuar.
  IF my_backend->get_my_crit_dyn( ) = abap_on. "El botó només apareix quan és tracta d'un criteri de puntuació dinàmic
    IF my_backend->get_is_cp_iniciada( ) EQ abap_false AND  ( ls_exp_cont-z_pt_conf_dades EQ abap_false
    OR ls_exp_cont-z_vo_conf_dades EQ abap_false ).
      IF my_mode <> zrm_cl_valoracio_ofertes=>co_mode_val_cap_obra.   "Insert PSPEC-1451 Inici modificació - EVXGL
        CLEAR ls_toolbar .
        ls_toolbar-function = co_puntuar  .
        ls_toolbar-icon     = icon_system_mark .
        ls_toolbar-text     = 'Seleccionar de nou?'(f18).
        ls_toolbar-butn_type = 0 .
        IF my_backend->check_activity( my_backend_activities-confirm_punct ) IS INITIAL
        OR my_read_only IS NOT INITIAL
        . "OR my_backend->my_mode <> my_backend->co_mode_1_round..
          ls_toolbar-disabled  = 'X' .
        ENDIF.


**    >> INI MODIF ETODR SPEC-49075
        IF my_backend->get_is_nova_llei_92017( ) = abap_on AND my_backend->get_is_obert_preu( ) = abap_off AND
        my_mode <> zrm_cl_valoracio_ofertes=>co_mode_punt_quadre2b.
          ls_toolbar-disabled  = 'X' .
        ENDIF.
**    << FI MODIF ETODR SPEC-49075

        ">>> SPEC-52548, Inici Modificació - ECTRP  27012020
        IF my_mode = zrm_cl_valoracio_ofertes=>co_mode_punt_quadre3b.
          IF ls_exp_cont-z_q3_conf_dades EQ abap_true.
            ls_toolbar-disabled = abap_true.
          ELSE.                                                                       .
            ls_toolbar-disabled = abap_false. "Desbloquejat
          ENDIF.
        ENDIF.
        ">>> SPEC-52548, Final Modificació - ECTRP  27012020
        ">>>SPEC-52548, Inici modificació  - ETODR
        "Si ja han introduït càrrecs addicionals a l'equip bàsic O s'ha puntuat el INCRvsIMIN, es bloqueja
        IF my_mode = zrm_cl_valoracio_ofertes=>co_mode_punt_quadre3b
          AND my_backend->te_equip_add( ) = abap_on
          OR my_backend->te_valor_incr( ) = abap_on
**      >> INI MODIF ETODR SPEC-61754
          OR my_backend->te_valor_iref( ) = abap_on.
**      < FI MODIF ETODR SPEC-61754
          ls_toolbar-disabled = abap_true.
        ENDIF.
        "<<<SPEC-52548, Final modificació - ETODR

        INSERT ls_toolbar INTO TABLE e_object->mt_toolbar .
      ENDIF.
    ENDIF.
  ENDIF.
** << FIN SPEC-45341 ETETM

  ">>>SPEC:SPEC-69341, Inici modificació - ECJMS

  CALL METHOD get_data
    EXPORTING
      im_from_db   = my_read_only
    IMPORTING
      ex_punt_gen  = lt_punt_gen
      ex_crit_punt = lt_crit_punt.

  LOOP AT lt_crit_punt INTO ls_crit_punt WHERE z_form_brctjv = abap_true.
    EXIT.
  ENDLOOP.

  IF sy-subrc EQ 0.

    CLEAR ls_toolbar .
    ls_toolbar-function  = co_barem.
    ls_toolbar-icon      = icon_technical_place .
    ls_toolbar-text      = 'Barem Punt. Tècnica'.
    ls_toolbar-butn_type = 0.

    ls_toolbar-disabled = abap_false.


    INSERT ls_toolbar INTO TABLE e_object->mt_toolbar .
  ENDIF.

  "<<<SPEC:SPEC-69341, Final modificació - ECJMS

** >> INI MODIF ETODR SPEC-48364
  IF my_backend->get_my_crit_dyn( ) = abap_on. "El botó només apareix quan és tracta d'un criteri de puntuació dinàmic
    IF my_backend->get_is_cp_iniciada( ) EQ abap_on AND ( ls_exp_cont-z_pt_conf_dades EQ abap_true  OR ls_exp_cont-z_vo_conf_dades EQ abap_true ).
      IF my_backend->get_is_finished( ) EQ abap_on.
        CLEAR ls_toolbar .
        ls_toolbar-function = co_fc_create_inf_pt_def.
        ls_toolbar-icon     = icon_pdf.
        ls_toolbar-text     = 'Justificació puntuació tècnica def.'(f19).
        ls_toolbar-butn_type = 0 .
        IF my_backend->check_activity( my_backend_activities-confirm_punct ) IS NOT INITIAL OR my_read_only IS NOT INITIAL.
          ls_toolbar-disabled  = 'X' .
        ENDIF.
        INSERT ls_toolbar INTO TABLE e_object->mt_toolbar .
      ENDIF.
    ENDIF.
  ENDIF.
** << FI MODIF ETODR SPEC-48364

*-- Botons de navegació en el cas que hi hagi més ofertes de les que es poden mostrar
  DESCRIBE TABLE my_columns .
  IF sy-tfill GT co_max_cols_shown .
    CLEAR ls_toolbar .
    ls_toolbar-function = co_fc_page_first .
    ls_toolbar-icon     = icon_total_left .
    ls_toolbar-butn_type = 0 .
    IF my_page_first_index EQ 1 .
      ls_toolbar-disabled = 'X' .
    ENDIF .
    INSERT ls_toolbar INTO TABLE e_object->mt_toolbar .

    CLEAR ls_toolbar .
    ls_toolbar-function = co_fc_page_left .
    ls_toolbar-icon     = icon_page_left .
    ls_toolbar-butn_type = 0 .
    IF my_page_first_index EQ 1 .
      ls_toolbar-disabled = 'X' .
    ENDIF .
    INSERT ls_toolbar INTO TABLE e_object->mt_toolbar .

    CLEAR ls_toolbar .
    ls_toolbar-function = co_fc_column_left .
    ls_toolbar-icon     = icon_column_left .
    ls_toolbar-butn_type = 0 .
    IF my_page_first_index EQ 1 .
      ls_toolbar-disabled = 'X' .
    ENDIF .
    INSERT ls_toolbar INTO TABLE e_object->mt_toolbar .

    CLEAR ls_toolbar .
    ls_toolbar-function = co_fc_goto_page .
    WRITE my_page_first_index TO ls_toolbar-text LEFT-JUSTIFIED .
    CONCATENATE ls_toolbar-text '-' INTO ls_toolbar-text SEPARATED BY space .
    l_length = strlen( ls_toolbar-text  ) + 1 .
    WRITE my_page_last_index TO ls_toolbar-text+l_length LEFT-JUSTIFIED .
    ls_toolbar-butn_type = 2 .
    INSERT ls_toolbar INTO TABLE e_object->mt_toolbar .

    CLEAR ls_toolbar .
    ls_toolbar-function = co_fc_column_right .
    ls_toolbar-icon     = icon_column_right .
    ls_toolbar-butn_type = 0 .
    IF my_page_last_index EQ sy-tfill .
      ls_toolbar-disabled = 'X' .
    ENDIF .
    INSERT ls_toolbar INTO TABLE e_object->mt_toolbar .

    CLEAR ls_toolbar .
    ls_toolbar-function = co_fc_page_right .
    ls_toolbar-icon     = icon_page_right .
    ls_toolbar-butn_type = 0 .
    IF my_page_last_index EQ sy-tfill .
      ls_toolbar-disabled = 'X' .
    ENDIF .
    INSERT ls_toolbar INTO TABLE e_object->mt_toolbar .

    CLEAR ls_toolbar .
    ls_toolbar-function = co_fc_page_last .
    ls_toolbar-icon     = icon_total_right .
    ls_toolbar-butn_type = 0 .
    IF my_page_last_index EQ sy-tfill .
      ls_toolbar-disabled = 'X' .
    ENDIF .
    INSERT ls_toolbar INTO TABLE e_object->mt_toolbar .
  ENDIF .

*-- Afegim al final les funcions estàndar que ens interessen
  CLEAR ls_toolbar .
  ls_toolbar-butn_type = 3 .
  INSERT ls_toolbar INTO TABLE e_object->mt_toolbar .

  APPEND LINES OF lt_toolbar TO e_object->mt_toolbar .
ENDMETHOD.


METHOD on_user_command.

  DATA: l_page    TYPE i .

  ">>>SPEC:SPEC-69341, Inici modificació - ECJMS

  DATA: ls_exp_cont  TYPE zrm_dt_exp_cont.

  FIELD-SYMBOLS <lt_data>  TYPE table.

  "<<<SPEC:SPEC-69341, Final modificació - ECJMS

  IF e_ucomm(3) EQ co_fc_goto_page .
    l_page = e_ucomm+3 .
    shift_shown_columns( im_page = l_page ) .
    RETURN .
  ENDIF .

  CASE e_ucomm .
    WHEN co_fc_sort_up_name .       sort_shown_columns( e_ucomm ) .
    WHEN co_fc_sort_down_name .     sort_shown_columns( e_ucomm ) .
    WHEN co_fc_sort_up_punt .       sort_shown_columns( e_ucomm ) .
    WHEN co_fc_sort_down_punt .     sort_shown_columns( e_ucomm ) .
    WHEN co_fc_toggle_nav .         toggle_navigation_box( ) .
    WHEN co_fc_page_first .         shift_shown_columns( im_direction = e_ucomm ) .
    WHEN co_fc_page_left .          shift_shown_columns( im_direction = e_ucomm ) .
    WHEN co_fc_column_left .        shift_shown_columns( im_direction = e_ucomm ) .
    WHEN co_fc_column_right .       shift_shown_columns( im_direction = e_ucomm ) .
    WHEN co_fc_page_right .         shift_shown_columns( im_direction = e_ucomm ) .
    WHEN co_fc_page_last .          shift_shown_columns( im_direction = e_ucomm ) .
    WHEN co_fc_confirm .            confirm( ) .
    WHEN co_fc_unlock .             unconfirm( ) .
    WHEN co_fc_set_awardee.         set_awardee( ) .
*>> Ini  SPEC-54695  - ETMAE
    WHEN co_fc_set_best_classified. set_best_classified( ) .
*<< Fi  SPEC-54695  - ETMAE

** >> INI MODIF ETODR SPEC-40749
*    WHEN co_fc_save .               save( ) .
    WHEN co_fc_save .
** INI SPEC-80664 ECAGM 23.11.2023
      refresh_table_display( ) .
** END SPEC-80664 ECAGM 23.11.2023
      my_backend->set_save_log_pt( abap_on ).


*      DATA: gv_save TYPE sy-ucomm.
*      gv_save =  abap_true.
*      SET PARAMETER ID 'SAV' FIELD gv_save.


**    >> INI MODIF ETODR SPEC-49500
      IF 1 = 2 AND my_backend->get_is_nova_llei_92017( ) = abap_on AND my_backend->get_is_obert_preu( ) = abap_off.
        " Per ara aquesta funció està en desenvolupament per millorar la lògica del que ja funciona
        my_backend->save_taules_rel_ofer( ).
      ELSE.
**    << INI MODIF ETODR SPEC-49500
***INI MOD ETJHG - SPEC-46407
        "Función creada para llamar a la dynpro 0500 para guardar los datos procesados en la tabla ZRM_DT_PUNT_REC
        "Una vez en la Dynpro 0500 en status_0500 procesamos el SAVE guardando los datos en la tabla.
*        CALL FUNCTION 'ZRM_SAVE_PUNT_REC'. "SPEC-50381
***FIN MOD ETJHG - SPEC-46407
      ENDIF.
      save( ) .
** << FI MODIF ETODR SPEC-40749
    WHEN co_fc_create_q4_draft .    create_document( e_ucomm ) .
    WHEN co_fc_create_q4a_draft .   create_document( e_ucomm ) .
    WHEN co_fc_create_q4b_draft .   create_document( e_ucomm ) .
    WHEN co_fc_create_q4lem_draft . create_document( e_ucomm ) .
    WHEN co_fc_create_q4_int .      create_document( e_ucomm ) .
    WHEN co_fc_create_q2b_draft .   create_document( e_ucomm ) .
    WHEN co_fc_create_q1b_draft.    create_document( e_ucomm ) .

      ">>>SPEC:SPEC-69341, Inici modificació - ECJMS

    WHEN co_barem.

      SELECT SINGLE * FROM zrm_dt_exp_cont INTO ls_exp_cont
       WHERE docclass = gs_exp_cont-docclass AND
             objectid = gs_exp_cont-objectid .

      ASSIGN my_table_ref->* TO <lt_data> .

      CALL FUNCTION 'ZRM_GRAELLA_PUNTUAR_OFE_LICITA'
        EXPORTING
          is_zrm_dt_exp_cont = ls_exp_cont
        CHANGING
          it_crit_punt       = gt_crit_punt
          it_dat             = <lt_data>
          co_alv             = my_grid.

      "<<<SPEC:SPEC-69341, Final modificació - ECJMS

** >> INI SPEC-45341 ETETM - Nuevo Botón para volver a puntuar. Dirige a dynpro
**    200 del módulo de funciones ZRM_VALORACIO_OFERTES.
    WHEN co_puntuar.
      DATA: lt_dades_ofer_dyn TYPE zrm_tt_dt_punt_ofer,
            lt_punt_equi      TYPE ztt_punt_equi.
      my_backend->get_dades_ofer_dyn( EXPORTING im_sel_dyn   = abap_on "ETODR SPEC-49075
                                      IMPORTING ex_crit_punt = DATA(lt_crit_punt) ).
      CALL FUNCTION 'ZRM_SELECCIO_APARTATS'
        EXPORTING
          im_crit_punt     = lt_crit_punt
          im_mode          = my_mode       ">>> SPEC-52548 ECTRP Insert
        IMPORTING
          et_punt_ofer_dyn = lt_dades_ofer_dyn
          et_punt_equi     = lt_punt_equi.

      ">>>SPEC-52548, Inici modificació  - ETODR
      "En el canvi de criteris des del Q3B hem de forçar que es recalculin els criteris per si hi ha equip..
      IF my_mode = zrm_cl_valoracio_ofertes=>co_mode_punt_quadre3b.
        my_backend->update_dyn_data( EXCEPTIONS not_punt_ofer = 0 ).
      ENDIF.
      "<<<SPEC-52548, Final modificació - ETODR

      IF lt_dades_ofer_dyn[] IS NOT INITIAL OR lt_punt_equi[] IS NOT INITIAL.
        SORT lt_punt_equi BY z_codi_crit_punt z_comptador_equip.
        my_backend->set_dades_ofer_dyn( EXPORTING it_punt_ofer_dyn = lt_dades_ofer_dyn
                                                  it_punt_equi     = lt_punt_equi ).
      ENDIF.

      TRY.
***INI MOD ETJHG - SPEC-46407
*          me->recalculate( ).
          "Recalcular puntuación en el caso que se hayan añadido o eliminado recursos
          me->recalculate( EXPORTING  dades_ofer_dyn = lt_dades_ofer_dyn ).
***FIN MOD ETJHG - SPEC-46407

        CATCH zcx_rm_valoracio .
          RETURN.
      ENDTRY.
**  >> INI MODIF ETODR SPEC-49075
    WHEN co_fc_create_q2b_92017.        " SPEC-49077 22.05.2018 ETJMD
      create_document( e_ucomm ).
    WHEN co_fc_create_q3b_92017.
      create_document( e_ucomm ).
    WHEN co_fc_create_q4a_92017.
      create_document( e_ucomm ).
    WHEN co_fc_create_q4b_92017.
      create_document( e_ucomm ).
**  << FI MODIF ETODR SPEC-49075
**  >> INI MODIF ETODR SPEC-45341
    WHEN co_fc_motivacio.
      edit_motivacio( EXPORTING i_docclass  = gv_docclass
                                i_objectid  = gv_objectid ).
** << FI  SPEC-45341
** >> INI MODIF ETODR SPEC-48364
    WHEN co_fc_create_inf_pt_def. create_document( e_ucomm ).
** << FI MODIF ETODR SPEC-48364
    WHEN OTHERS.                MESSAGE e_ucomm TYPE 'I' DISPLAY LIKE 'E'.
  ENDCASE .

ENDMETHOD.


METHOD populate_matrix.

  DATA: l_char40(40),
        lt_punt_gen             TYPE zrm_cl_valoracio_ofertes=>ty_t_punt_gen,
        lt_crit_punt            TYPE zrm_cl_valoracio_ofertes=>ty_t_crit_punt,
        lt_ofertes              TYPE TABLE OF zrm_dt_punt_ofer,
        ls_ofertes              TYPE zrm_dt_punt_ofer,
        ls_crit_punt            LIKE LINE OF lt_crit_punt,
        l_total_index           TYPE i,
        ls_style                TYPE lvc_s_styl,
        lt_style_sum            TYPE lvc_t_styl,
        lt_style_noapply        TYPE lvc_t_styl, "INI MODIF ETODR SPEC-45341
        lt_style_hotspot        TYPE lvc_t_styl, "INI MODIF ETODR SPEC-45341
        lt_style_hotspot_b      TYPE lvc_t_styl, "INI MODIF ETODR SPEC-45407
        lt_style_nohotspot      TYPE lvc_t_styl, "INI MODIF ETODR SPEC-45341
        lt_style_aux            TYPE lvc_t_styl, "INI MODIF ETODR SPEC-49500
        lt_style_equipmax       TYPE lvc_t_styl, "INI MODIF ETODR SPEC-49806
        lt_style_equippdm       TYPE lvc_t_styl, "INI MODIF ETODR SPEC-50770
        lt_style_incr           TYPE lvc_t_styl, "INI MODIF ETODR SPEC-55535
        lt_style_co2            TYPE lvc_t_styl, "INI MODIF ETODR SPEC-71214
        l_cal_recalcular        TYPE xfeld,      "INI MODIF ETODR SPEC-45341
        ls_color                TYPE lvc_s_scol,
        lt_color_key            TYPE lvc_t_scol,
        ls_color_my_columns     TYPE lvc_s_scol, " Modif. SPEC-59951 ETXGL
        lt_color_key_my_columns TYPE lvc_t_scol, " Modif. SPEC-59951 ETXGL
        lt_color_aux            TYPE lvc_t_scol, "INI MODIF ETODR SPEC-49500
        lv_mod_punt             TYPE z_mod_crit_punt,
        lv_crit_punt            TYPE z_codi_crit_punt,
        lv_codi_sub             TYPE z_codi_subapar_punt,
        lv_no_aplica            TYPE z_no_aplica,
        lv_crit_dep_no_aplica   TYPE xfeld. "SPEC-52568.

" >>>PSPEC-1451 Inici modificació - EVXGL
  FIELD-SYMBOLS: <fs_grid_aux3>        TYPE any,
                 <fs_grid_aux4>        TYPE any,
                 <fs_itab_style>       TYPE ANY TABLE,
                 <fs_cell_color>       TYPE ANY TABLE,
                 <fs_color>            TYPE any,
                 <fs_style>            TYPE any,
                 <fs_fieldname>        TYPE any,
                 <fs_fname>            TYPE any,
                 <fs_fieldname_style>  TYPE any,
                 <fs_style_cell_color> TYPE any,
                 <fs_col>              TYPE any,
                 <fs_int>              TYPE any,
                 <fs_inv>              TYPE any.

  DATA: lv_1 TYPE i VALUE 1,
        lv_4 TYPE i VALUE 4.

  FIELD-SYMBOLS: <fs_1> TYPE i,
                 <fs_4> TYPE i.

  DATA: lv_registres  TYPE i,
        lv_field      TYPE fieldname VALUE 'STYLE',
        lv_fieldname  TYPE fieldname VALUE 'FIELDNAME',
        lv_fname      TYPE fieldname VALUE 'FNAME',
        lv_cell_color TYPE fieldname VALUE 'CELL_COLOR',
        lv_color      TYPE fieldname VALUE 'COLOR',
        lv_col        TYPE fieldname VALUE 'COL',
        lv_int        TYPE fieldname VALUE 'INT',
        lv_inv        TYPE fieldname VALUE 'INV'.

  DATA: lv_select_clause  TYPE string,
        lv_select_clause2 TYPE string.
" <<<PSPEC-1451 Fi modificació - EVXGL

  " Afegir botó Aportacions i mesures
  DATA: ls_column TYPE ty_s_column.
  ls_column-fieldname = 'APORTACIONS_MESURES'.
  ls_column-text = 'Actualitza aportacions i mesures'.
  ls_column-hotspot = abap_true.
  ls_column-pushbutton = abap_true.
  APPEND ls_column TO lt_columns.

  ">>>SPEC:67070, Inici modificació - ECJMS
  TYPES: BEGIN OF ty_cod_punt,
           z_codi_crit_punt TYPE z_codi_crit_punt,
         END OF ty_cod_punt.
  DATA: lt_cod_punt             TYPE TABLE OF ty_cod_punt.
  DATA: ls_cod_punt             TYPE          ty_cod_punt.
  DATA: ls_fieldcat             TYPE          lvc_s_fcat.
  DATA: lv_num_oferta           TYPE          z_num_ofer.
  "<<<SPEC:67070, Final modificació - ECJMS

  FIELD-SYMBOLS: <ls_grid>         TYPE any,
                 <lt_grid>         TYPE STANDARD TABLE,
                 <ls_punt_gen>     LIKE LINE OF lt_punt_gen,
                 <ls_column>       TYPE ty_s_column,
                 <ls_column_color> TYPE ty_s_column, " Modif. SPEC-59951 ETXGL
                 <ls_row>          TYPE ty_s_row,
                 <ls_punt>         TYPE any,
                 <l_punt>          TYPE clike,
*>> Inici Modificació ECAGE SPEC-66771 26/07/2022 TEST
                 <ls_grid_aux>     TYPE any,
                 <l_crit_punt>     TYPE clike.
*>> FI Modificació ECAGE SPEC-66771 26/07/2022 TEST


  CALL METHOD get_data
    EXPORTING
      im_from_db   = my_read_only
    IMPORTING
      ex_punt_gen  = lt_punt_gen
      ex_crit_punt = lt_crit_punt.

  gt_crit_punt = lt_crit_punt.

** >> INI MODIF ETODR SPEC-49806
  "No es pot clicar als subapartats de l'equip si es tracta d'un criteri de puntuació amb equip màxim
  DATA(lv_no_subapartat) = abap_off.
  READ TABLE lt_crit_punt TRANSPORTING NO FIELDS WITH KEY z_equip_max = abap_on.
  IF sy-subrc = 0.
    my_backend->get_dades_ofer_dyn( IMPORTING ex_punt_ofer_dyn_equi = DATA(lt_criteris_equip) ).
    SORT lt_criteris_equip BY z_codi_crit_punt.
    DELETE ADJACENT DUPLICATES FROM lt_criteris_equip COMPARING z_codi_crit_punt.
    DATA(lv_equip_max) = abap_on.
  ENDIF.
** << FI MODIF ETODR SPEC-49806
**>> INI MODIF ETODR SPEC-51135
  READ TABLE lt_crit_punt TRANSPORTING NO FIELDS WITH KEY z_equip_coautor = abap_on.
  IF sy-subrc = 0.
    my_backend->get_dades_ofer_dyn( IMPORTING ex_punt_ofer_dyn_equi = lt_criteris_equip ).
    SORT lt_criteris_equip BY z_codi_crit_punt.
    DELETE ADJACENT DUPLICATES FROM lt_criteris_equip COMPARING z_codi_crit_punt.
    DATA(lv_equip_coautors) = abap_on.
  ENDIF.
**<< FI MODIF ETODR SPEC-51135

  SELECT *
    FROM zrm_dm_crit_punt
    INTO TABLE @DATA(lt_crit_punt_aux)
     FOR ALL ENTRIES IN @lt_crit_punt
   WHERE  z_mod_crit_punt = @lt_crit_punt-z_mod_crit_punt AND
          z_codi_crit_punt = @lt_crit_punt-z_codi_crit_punt AND
          z_incr = @abap_true.

  SELECT *
  FROM zrm_dm_crit_punt
  INTO TABLE @DATA(lt_crit_punt_aux2)
        FOR ALL ENTRIES IN @lt_crit_punt
        WHERE  z_mod_crit_punt = @lt_crit_punt-z_mod_crit_punt.

* Obtenim els totals de cada proveïdor/lema i creem l'estil de les línies corresponents
* a criteris no editables (total, valoració económica, etc...)
  LOOP AT my_columns ASSIGNING <ls_column> .
    <ls_column>-punt_total = 0 .
    READ TABLE lt_punt_gen ASSIGNING <ls_punt_gen>
                   WITH  KEY z_codi_crit_punt = zrm_cl_valoracio_ofertes=>co_codi_crit_total
                             z_num_gen        = <ls_column>-key .
    IF sy-subrc EQ 0 .
**    >> INI MODIF ETODR SPEC-49075
      IF my_backend->get_is_nova_llei_92017( ) = abap_on AND my_backend->get_is_obert_preu( ) = abap_off.
        IF my_mode EQ zrm_cl_valoracio_ofertes=>co_mode_punt_quadre2b.
          READ TABLE lt_crit_punt INTO ls_crit_punt
            WITH KEY z_crit_q2 = abap_on.
        ELSEIF my_mode EQ zrm_cl_valoracio_ofertes=>co_mode_punt_quadre3b.
          READ TABLE lt_crit_punt INTO ls_crit_punt
            WITH KEY z_crit_q3 = abap_on.
        ELSE.
          LOOP AT lt_crit_punt INTO ls_crit_punt WHERE z_codi_crit_punt IS INITIAL.
            EXIT.
          ENDLOOP.
        ENDIF.

        READ TABLE lt_punt_gen ASSIGNING <ls_punt_gen>
                   WITH  KEY z_codi_crit_punt = ls_crit_punt-z_codi_crit_punt
                             z_num_gen        = <ls_column>-key.

        <ls_column>-punt_total = <ls_punt_gen>-z_punts .
        READ TABLE lt_punt_gen ASSIGNING <ls_punt_gen>
                 WITH KEY z_codi_crit_punt = space z_num_gen = <ls_punt_gen>-z_num_gen.
        <ls_punt_gen>-z_punts = <ls_column>-punt_total.
      ELSE.
**    << FI MODIF ETODR SPEC-49075
        IF my_mode EQ co_mode_punct_tec.

          READ TABLE lt_crit_punt INTO ls_crit_punt
            WITH KEY z_crit_ve = zrm_cl_valoracio_ofertes=>co_crit_val_tecnic.

          IF sy-subrc <> 0.
            READ TABLE lt_crit_punt INTO ls_crit_punt
              WITH KEY z_crit_ve = zrm_cl_valoracio_ofertes=>co_crit_tecnic.
          ENDIF.

          READ TABLE lt_punt_gen ASSIGNING <ls_punt_gen>
                     WITH  KEY z_codi_crit_punt = ls_crit_punt-z_codi_crit_punt
                               z_num_gen        = <ls_column>-key.

          <ls_column>-punt_total = <ls_punt_gen>-z_punts .
          READ TABLE lt_punt_gen ASSIGNING <ls_punt_gen>
                   WITH KEY z_codi_crit_punt = space z_num_gen = <ls_punt_gen>-z_num_gen.
          <ls_punt_gen>-z_punts = <ls_column>-punt_total.
        ELSE.
          <ls_column>-punt_total = <ls_punt_gen>-z_punts.
        ENDIF.
      ENDIF.
    ENDIF .
    ls_style-fieldname = <ls_column>-fieldname  .
    ls_style-style     = cl_gui_alv_grid=>mc_style_disabled .
    INSERT ls_style INTO TABLE lt_style_sum .
**  >> INI MODIF ETODR SPEC-45341
    IF my_backend->get_my_crit_dyn( ) = abap_on.
      IF <ls_column>-editable = abap_on.
        CLEAR: ls_style.
        ls_style-fieldname = <ls_column>-fieldname  .
        ls_style-style     = cl_gui_alv_grid=>mc_style_hotspot.
        INSERT ls_style INTO TABLE lt_style_hotspot_b.
      ENDIF.
      LOOP AT lt_crit_punt INTO ls_crit_punt.

        CHECK <ls_column>-editable IS NOT INITIAL. "no s'afegeix el hotspot a aquelles que no són puntuables
        IF ls_crit_punt-z_no_aplica = abap_on.
          "Per criteris dinàmics es deixen deshabilitats els apartats que no apliquen
          CLEAR: ls_style.
          ls_style-fieldname = <ls_column>-fieldname  .
          ls_style-style     = cl_gui_alv_grid=>mc_style_disabled .
          INSERT ls_style INTO TABLE lt_style_noapply .
          CONTINUE.
        ELSE.
**        >> INI MODIF ETODR SPEC-49806
          CLEAR: lv_no_subapartat.
          "No es pot clicar als subapartats de l'equip si es tracta d'un criteri de puntuació amb equip màxim
**        >> INI MODIF ETODR SPEC-51135
*          IF lv_equip_max = abap_on.
          "Ni tampoc a un criteri de puntuació de Redacció de Projectes
          IF lv_equip_max = abap_on OR lv_equip_coautors = abap_on.
**        << FI MODIF ETODR SPEC-51135
            READ TABLE lt_criteris_equip TRANSPORTING NO FIELDS WITH KEY z_codi_crit_punt = ls_crit_punt-z_codi_crit_punt
                                                                         z_mod_crit_punt  = ls_crit_punt-z_mod_crit_punt.
            IF sy-subrc = 0.
              lv_no_subapartat = abap_on.
            ENDIF.
          ENDIF.
**        >> INI MODIF ETODR SPEC-50770
          IF ls_crit_punt-z_equip_pdm = abap_on.
            "Els criteris amb marca d'equip PDM es calculen introduint la dedicació ofertada per tècnic
            CLEAR: ls_style.
            ls_style-fieldname = <ls_column>-fieldname.
            ls_style-style     = cl_gui_alv_grid=>mc_style_disabled .
            INSERT ls_style INTO TABLE lt_style_equippdm.
            CONTINUE.
          ENDIF.
**        << FI MODIF ETODR SPEC-50770
          IF lv_no_subapartat = abap_on.
            CLEAR: ls_style.
            ls_style-fieldname = <ls_column>-fieldname.
            ls_style-style     = cl_gui_alv_grid=>mc_style_disabled .
            INSERT ls_style INTO TABLE lt_style_equipmax.
            CONTINUE.
          ENDIF.
**        << FI MODIF ETODR SPEC-49806

          " Para cada criterio determinamos si tiene o no subapartados.
          CLEAR: lv_codi_sub.
          SELECT SINGLE z_codi_subapar_punt FROM  zrm_dm_crit_punt INTO lv_codi_sub
                                            WHERE z_codi_crit_punt = ls_crit_punt-z_codi_crit_punt
                                            AND   z_mod_crit_punt  = ls_crit_punt-z_mod_crit_punt.

          SELECT SINGLE z_codi_subapar_punt_rel FROM  zrm_dm_suapar_pt INTO lv_codi_sub
                                                WHERE z_codi_subapar_punt = lv_codi_sub.

          IF lv_codi_sub IS NOT INITIAL.
            CLEAR: ls_style.
            ls_style-fieldname = <ls_column>-fieldname  .
            ls_style-style     = cl_gui_alv_grid=>mc_style_hotspot .
            INSERT ls_style INTO TABLE lt_style_hotspot .
          ELSE.
            CLEAR: ls_style.
            ls_style-fieldname = <ls_column>-fieldname  .
            ls_style-style     = cl_gui_alv_grid=>mc_style_hotspot_no.
            INSERT ls_style INTO TABLE lt_style_nohotspot.
          ENDIF.
        ENDIF.
        ">> SPEC-71214, Inici Modificació - ETODR
        IF ls_crit_punt-z_co2 IS NOT INITIAL.
          "No es pot clicar al criteri del CO2 ja qe va mitjançant botó independent
          CLEAR: ls_style.
          ls_style-fieldname = <ls_column>-fieldname  .
          ls_style-style     = cl_gui_alv_grid=>mc_style_disabled.
          INSERT ls_style INTO TABLE lt_style_co2.
        ENDIF.
        "<< SPEC-71214, Final Modificació - ETODR
*>> SPEC-55535, Inici modificació - ETLJS
        IF ls_crit_punt-z_incr IS NOT INITIAL.
          CLEAR: ls_style.
          ls_style-fieldname = <ls_column>-fieldname.
          ls_style-style     = cl_gui_alv_grid=>mc_style_disabled .
          INSERT ls_style INTO TABLE lt_style_incr.
          CONTINUE.
        ENDIF.
*<< SPEC-55535, Final modificació - ETLJS
      ENDLOOP.
    ENDIF.
**  << FI MODIF ETODR SPEC-45341
  ENDLOOP .

  IF ex_table_ref IS NOT BOUND .
    CALL METHOD build_matrix
      IMPORTING
        ex_table_ref = ex_table_ref
        ex_line_ref  = ex_line_ref
      CHANGING
        ch_columns   = my_columns.
  ENDIF .
** >> INI MODIF ETODR SPEC-49462
  IF ex_table_ref IS NOT BOUND OR ex_line_ref IS NOT BOUND.
    RAISE EXCEPTION TYPE zcx_rm_valoracio
      EXPORTING
        textid = zcx_rm_valoracio=>can_not_be_opened_not_punt.
  ENDIF.
** << FI MODIF ETODR SPEC-49462
  CHECK ex_table_ref IS BOUND.
  CHECK ex_line_ref IS BOUND.
  ASSIGN ex_table_ref->* TO <lt_grid> .
  ASSIGN ex_line_ref->*  TO <ls_grid> .
  REFRESH <lt_grid> .

  ASSIGN COMPONENT '_CONTROL_' OF STRUCTURE <ls_grid> TO <ls_row> .
  ASSIGN COMPONENT '_PUNTS_'   OF STRUCTURE <ls_grid> TO <ls_punt> .

* Color de les columnes clau
  CLEAR lt_color_key .
  ls_color-color-col = 4 .
  ls_color-color-int = 1 .
  ls_color-color-inv = 4 .
  ls_color-fname = 'Z_CODI_CRIT_PUNT'.  INSERT ls_color INTO TABLE lt_color_key.
  ls_color-fname = 'Z_DESCRIPCIO'.      INSERT ls_color INTO TABLE lt_color_key.
  ls_color-fname = 'Z_PUNT_MIN'.        INSERT ls_color INTO TABLE lt_color_key.
  ls_color-fname = 'Z_PUNT_MAX'.        INSERT ls_color INTO TABLE lt_color_key.
  ls_color-fname = 'Z_RANG'.            INSERT ls_color INTO TABLE lt_color_key.


  ">>>  SPEC-59951 Inici Modificació ETXGL
  CLEAR lt_color_key_my_columns.
  lt_color_key_my_columns[] = lt_color_key[].

  LOOP AT my_columns ASSIGNING <ls_column_color>.
    CLEAR ls_color_my_columns.
    ls_color_my_columns-color-col = 4 .
    ls_color_my_columns-color-int = 1 .
    ls_color_my_columns-color-inv = 4 .
    ls_color_my_columns-fname = <ls_column_color>-fieldname.
    INSERT ls_color_my_columns INTO TABLE lt_color_key_my_columns.

  ENDLOOP.
  "<<<  SPEC-59951 Final Modificació ETXGL

*--- Dades de puntuació ------------------------------------------------------------------
  ">>>SPEC: 67070, Inici modificació - ECJMS
  REFRESH lt_cod_punt.
  "<<<SPEC: 67070, Final modificació - ECJMS

  LOOP AT lt_crit_punt INTO ls_crit_punt .
    CLEAR <ls_grid> .
**  >> INI MODIF ETODR SPEC-45341
*
    IF my_backend->get_my_crit_dyn( ) = abap_on.
      IF ls_crit_punt-z_no_aplica = abap_on.
*        "Si no aplica es mostra deshabilitat.
        <ls_row>-style = lt_style_noapply.
      ELSE.
**        >> INI MODIF ETODR SPEC-49806
        CLEAR: lv_no_subapartat.
        "No es pot clicar als subapartats de l'equip si es tracta d'un criteri de puntuació amb equip màxim
**      >> INI MODIF ETODR SPEC-51135
*        IF lv_equip_max = abap_on.
        IF lv_equip_max = abap_on OR lv_equip_coautors = abap_on.
**      << FI MODIF ETODR SPEC-51135
          READ TABLE lt_criteris_equip TRANSPORTING NO FIELDS WITH KEY z_codi_crit_punt = ls_crit_punt-z_codi_crit_punt
                                                                       z_mod_crit_punt  = ls_crit_punt-z_mod_crit_punt.
          IF sy-subrc = 0.
            lv_no_subapartat = abap_on.
          ENDIF.
        ENDIF.
**       >> INI MODIF ETODR SPEC-50770
**      >> INI MODIF ETODR SPEC-51135
*        IF ls_crit_punt-z_equip_pdm = abap_on.
*>> SPEC-55535, Inici modificació - ETLJS
        READ TABLE lt_crit_punt_aux TRANSPORTING NO FIELDS
          WITH KEY z_codi_crit_punt = ls_crit_punt-z_codi_crit_punt.
        IF sy-subrc EQ 0.
          <ls_row>-style = lt_style_incr.

        ELSE.
*<< SPEC-55535, Final modificació - ETLJS
          IF ( ls_crit_punt-z_equip_pdm = abap_on AND lv_equip_coautors = abap_off ).
**      << FI MODIF ETODR SPEC-51135
            <ls_row>-style = lt_style_equippdm.
            ">> SPEC-71214, Inici Modificació - ETODR
          ELSEIF ls_crit_punt-z_co2 IS NOT INITIAL.
            <ls_row>-style = lt_style_co2.
            "<< SPEC-71214, Final Modificació - ETODR

          ELSE.
**       << FI MODIF ETODR SPEC-50770
            IF lv_no_subapartat = abap_on.
              <ls_row>-style = lt_style_equipmax.
            ELSE.
**        << FI MODIF ETODR SPEC-49806
*        " Para cada criterio determinamos si tiene o no subapartados.
              SELECT SINGLE z_codi_subapar_punt FROM  zrm_dm_crit_punt INTO lv_codi_sub
                                                WHERE z_codi_crit_punt = ls_crit_punt-z_codi_crit_punt
                                                AND   z_mod_crit_punt  = ls_crit_punt-z_mod_crit_punt.

              SELECT SINGLE z_codi_subapar_punt_rel FROM  zrm_dm_suapar_pt INTO lv_codi_sub
                                                    WHERE z_codi_subapar_punt = lv_codi_sub.
              IF lv_codi_sub IS NOT INITIAL.
                <ls_row>-style = lt_style_hotspot.
              ELSE.
                <ls_row>-style = lt_style_nohotspot.
              ENDIF.
            ENDIF.
          ENDIF.
        ENDIF.
      ENDIF.
**  >> INI MODIF ETODR SPEC-49500
      <ls_row>-z_comptador_equip = ls_crit_punt-z_num_equip.
**  << FI MODIF ETODR SPEC-49500
    ENDIF.
**  << FI MODIF ETODR SPEC-45341
*    CLEAR ls_style.

    <ls_row>-z_mod_crit_punt  = ls_crit_punt-z_mod_crit_punt .
    <ls_row>-z_codi_crit_punt = ls_crit_punt-z_codi_crit_punt .
    <ls_row>-z_descripcio     = ls_crit_punt-z_descripcio .
    <ls_row>-z_punt_min       = ls_crit_punt-z_punt_min .
    <ls_row>-z_punt_max       = ls_crit_punt-z_punt_max .

    IF ls_crit_punt-z_codi_crit_punt EQ zrm_cl_valoracio_ofertes=>co_codi_crit_total .
      <ls_row>-row_color = 'C311' .
      l_total_index = sy-tabix .
    ELSE .
      ">>>  SPEC-59951 Inici Modificació ETXGL
*      <ls_row>-cell_color = lt_color_key .
      IF ls_crit_punt-z_sumatori IS NOT INITIAL
        OR ls_crit_punt-z_no_aplica IS NOT INITIAL
        OR ls_crit_punt-z_crit_ve IS NOT INITIAL.
        <ls_row>-cell_color = lt_color_key_my_columns.
      ELSE.
        <ls_row>-cell_color = lt_color_key.
      ENDIF.
      "<<<  SPEC-59951 Final Modificació ETXGL
    ENDIF.


    IF ls_crit_punt-z_crit_ve IS NOT INITIAL
      OR ls_crit_punt-z_sumatori IS NOT INITIAL .
      <ls_row>-style = lt_style_sum .
    ENDIF .

    "INI ECDRB SPEC-69341
    IF ls_crit_punt-z_form_brctjv = 'X'.
      <ls_row>-style = lt_style_sum . "estil disabled
    ENDIF.
    "FI ECDRB SPEC-69341

    CONCATENATE '[' l_char40 '-' INTO <ls_row>-z_rang .
**  >> INI MODIF ETODR SPEC-52568
    "Hi ha casos en que quan s'aplica un coeficient multiplicador, al criteri afectat se li incremente el màxim
    lv_crit_dep_no_aplica = abap_off.
    IF ls_crit_punt-z_crit_depenent IS NOT INITIAL.
      READ TABLE lt_crit_punt TRANSPORTING NO FIELDS WITH KEY z_no_aplica      = abap_on
                                                              z_codi_crit_punt = ls_crit_punt-z_crit_depenent.
      IF sy-subrc = 0.
        lv_crit_dep_no_aplica = abap_on.
      ENDIF.
    ENDIF.
**  << FI MODIF ETODR SPEC-52568
    WRITE ls_crit_punt-z_punt_max TO l_char40 LEFT-JUSTIFIED .
    CONCATENATE '[0,00-' l_char40 ']' INTO <ls_row>-z_rang .
**  >> INI MODIF ETODR SPEC-52568
    IF lv_crit_dep_no_aplica = abap_on.
      WRITE ls_crit_punt-z_sum_mes_max TO l_char40 LEFT-JUSTIFIED.
      CONCATENATE <ls_row>-z_rang 'màxim' l_char40 'per no aplicació de l''apartat'
                  ls_crit_punt-z_crit_depenent INTO <ls_row>-z_rang
                  SEPARATED BY space.
    ENDIF.
**  << FI MODIF ETODR SPEC-52568
    IF ls_crit_punt-z_punt_min IS NOT INITIAL .
      WRITE ls_crit_punt-z_punt_min TO l_char40 LEFT-JUSTIFIED .

      ">>>  SPEC-60699 Inici Modificació ETXGL
*      CONCATENATE <ls_row>-z_rang 'mín.' l_char40
*             INTO <ls_row>-z_rang SEPARATED BY space.

      " En cas que la puntuació mínima del Criteri de Puntuació
      " sigui inferior a zero...
      IF ls_crit_punt-z_punt_min < 0.
        IF l_char40 IS NOT INITIAL.
          CALL FUNCTION 'CLOI_PUT_SIGN_IN_FRONT'
            CHANGING
              value = l_char40.
        ENDIF.
        CONCATENATE '[' l_char40 '-0,00]' INTO <ls_row>-z_rang .
      ENDIF.
      "<<<  SPEC-59951 Final Modificació ETXGL

    ENDIF .

    my_backend->check_dades_incr( EXPORTING  iv_num_ofer = lv_num_oferta
                                  EXCEPTIONS not_imin    = 1
                                             OTHERS      = 2 ).

    LOOP AT lt_punt_gen ASSIGNING <ls_punt_gen>
                             WHERE z_codi_crit_punt EQ  ls_crit_punt-z_codi_crit_punt AND
                                   z_num_equip      EQ  ls_crit_punt-z_num_equip.

      READ TABLE my_columns  ASSIGNING <ls_column>
                           WITH KEY key = <ls_punt_gen>-z_num_gen.
      CHECK sy-subrc EQ 0 .

      ">>>SPEC:67070, Inici modificació - ECJMS
*      IF ls_crit_punt-z_coeficient_iref EQ abap_false.
******      IF ls_crit_punt-z_coeficient_iref IS INITIAL.
      "<<<SPEC:67070, Final modificació - ECJMS

      ASSIGN COMPONENT <ls_column>-colpos OF STRUCTURE <ls_punt> TO <l_punt> .
      WRITE <ls_punt_gen>-z_punts TO <l_punt> .

      ">>>SPEC:67070, Inici modificació - ECJMS
****      ELSE.
****
****        my_backend->get_punt_incr_obj( EXPORTING is_punts_offer = <ls_punt_gen>
****                                                 is_column      = <ls_column>
****                                       CHANGING  cs_linia       = <ls_grid> ).
****
****      ENDIF.
      "<<<SPEC:67070, Final modificació - ECJMS
    ENDLOOP .

*    IF ls_crit_punt-z_equip EQ abap_true AND <lt_grid> IS NOT INITIAL.
*      READ TABLE <lt_grid> TRANSPORTING NO FIELDS WITH TABLE KEY z_descripcio = ls_crit_punt-z_descripcio.
*      IF sy_subrc EQ 0.
*        DATA(lv_pos) = sy-tabix.
*        INSERT <ls_grid> INTO <lt_grid> INDEX lv_pos.
*      ELSE.
*        APPEND <ls_grid> TO <lt_grid> .
*      ENDIF.
*    ELSE.
    ">>ETODR SPEC-67070 ho comento perquè quan hi ha PCAP que tenen repetit els criteris, per a cada càrrec, això no funciona bé
*********************************************************************************    ">>>SPEC:67070, Inici modificació - ECJMS
*********************************************************************************    IF ls_crit_punt-z_coeficient_iref NE space.
*********************************************************************************
*********************************************************************************      <ls_row>-style      = lt_style_nohotspot.
*********************************************************************************      <ls_row>-cell_color = lt_color_key_my_columns.
*********************************************************************************
*********************************************************************************      ls_fieldcat-edit = space.
*********************************************************************************      LOOP AT my_columns ASSIGNING <ls_column> .
*********************************************************************************        MODIFY my_fieldcat FROM ls_fieldcat TRANSPORTING edit
*********************************************************************************             WHERE fieldname EQ <ls_column>-fieldname.
*********************************************************************************      ENDLOOP.
*********************************************************************************
*********************************************************************************    ENDIF.
*********************************************************************************
*********************************************************************************    READ TABLE lt_cod_punt TRANSPORTING NO FIELDS
*********************************************************************************     WITH KEY z_codi_crit_punt = ls_crit_punt-z_codi_crit_punt.
*********************************************************************************
*********************************************************************************    CHECK sy-subrc NE 0.
*********************************************************************************
*********************************************************************************    ls_cod_punt-z_codi_crit_punt = ls_crit_punt-z_codi_crit_punt.
*********************************************************************************
*********************************************************************************    COLLECT ls_cod_punt INTO lt_cod_punt.
*********************************************************************************    "<<<SPEC:67070, Final modificació - ECJMS
    "<<ETODR SPEC-67070
    APPEND <ls_grid> TO <lt_grid> .
*    ENDIF.
*    APPEND <ls_row> TO my_rows .

  ENDLOOP .

* La puntuació total, al principi i al final -----------------------------------------
  IF l_total_index IS NOT INITIAL .
    READ TABLE <lt_grid> INTO <ls_grid> INDEX l_total_index .
    APPEND <ls_grid> TO <lt_grid> .
  ENDIF .

  IF    my_mode EQ co_mode_1_round
*     OR my_mode EQ co_mode_punct_1st
     OR my_mode EQ co_mode_adj_2nd
    OR my_mode EQ co_mode_neg_f2 "P100031 ADD ETRCM
    OR my_mode EQ zrm_cl_valoracio_ofertes=>co_mode_punt_quadre4b. "ETODR SPEC-49075
    ASSIGN ex_line_ref->*  TO <ls_grid> .
    fill_awardee_line( CHANGING ch_row = <ls_row>
                                ch_punt  = <ls_punt> ) .
    INSERT <ls_grid> INTO <lt_grid> INDEX 1 .
  ENDIF .

*>> Ini  SPEC-54695  - ETMAE
  IF my_mode = zrm_cl_valoracio_ofertes=>co_mode_millor_classif.
    ASSIGN ex_line_ref->*  TO <ls_grid> .
    fill_best_classified_line( CHANGING ch_row = <ls_row>
                                      ch_punt  = <ls_punt> ) .
    INSERT <ls_grid> INTO <lt_grid> INDEX 1 .
  ENDIF .
*<< Fi  SPEC-54695  - ETMAE


**>> INI MODIF ETODR SPEC-49500
  DATA: l_num_ofer TYPE z_num_ofer.
  IF my_backend->get_my_crit_dyn( ) = abap_on.
    IF my_backend->has_exclusio_clausula_plec( ) = abap_on.
*-- Afegim també una lína que indica el si la oferta es pot excloure de la licitació directament per no assolir clàusules del Plec -------------------------------
      IF  my_mode EQ zrm_cl_valoracio_ofertes=>co_mode_punt_quadre2b OR
          my_mode EQ zrm_cl_valoracio_ofertes=>co_mode_punt_quadre3b OR
          my_mode EQ zrm_cl_valoracio_ofertes=>co_mode_punt_quadre4b.
        ASSIGN ex_line_ref->*  TO <ls_grid> .
        LOOP AT my_columns ASSIGNING <ls_column> .
          CLEAR <ls_row>.
          <ls_row>-z_excloure_lici = abap_on.
          ASSIGN COMPONENT <ls_column>-colpos OF STRUCTURE <ls_punt> TO <l_punt> .
          CHECK sy-subrc = 0.
          l_num_ofer = <ls_column>-key.
          my_backend->get_te_exclusio_clausula_plec( EXPORTING i_num_ofer = l_num_ofer
                                                     IMPORTING e_exclusio = DATA(l_exclos_plec) ).
          IF l_exclos_plec = abap_on.
            ls_color-color-col = 6 .
            ls_color-color-int = 1 .
            ls_color-color-inv = 1 .
*            <ls_row>-cell_color  = 'C611' .
            <l_punt>             = CONV #( 'Exclòs' ).
          ELSE.
            ls_color-color-col = 2 .
            ls_color-color-int = 1 .
            ls_color-color-inv = 1 .
*            <ls_row>-cell_color  = 'C211' .
*            <ls_row>-row_color   = 'C211' .
            <l_punt>             = CONV #( 'No Exclòs' ).
          ENDIF.

          ls_color-fname = <ls_column>-fieldname.   INSERT ls_color INTO TABLE lt_color_aux .
*          <ls_row>-z_descripcio   = 'Excloure oferta d''acord amb clàusula [A] del Plec'.
          my_backend->has_exclusio_clausula_plec( IMPORTING e_clausula_plec = DATA(l_clausula_plec) ).
*          REPLACE ALL OCCURRENCES OF '[A]' IN <ls_row>-z_descripcio WITH l_clausula_plec.
          <ls_row>-z_descripcio = l_clausula_plec.
          ls_style-fieldname    = <ls_column>-fieldname.
          IF my_mode = zrm_cl_valoracio_ofertes=>co_mode_punt_quadre3b.
            ls_style-style        = cl_gui_alv_grid=>mc_style_hotspot.
          ELSE.
            ls_style-style        = cl_gui_alv_grid=>mc_style_hotspot_no.
          ENDIF.
          INSERT ls_style INTO TABLE lt_style_aux.
          <ls_row>-style      = lt_style_aux .
          <ls_row>-cell_color = lt_color_aux.
        ENDLOOP .
        INSERT <ls_grid> INTO <lt_grid> INDEX 1 .
      ENDIF.
    ENDIF.

**  >> INI MODIF ETODR SPEC-50770
    IF my_backend->mod_crit_punt_has_pdm( ) = abap_on.
**      >> INI MODIF ETODR SPEC-51135
      READ TABLE lt_crit_punt TRANSPORTING NO FIELDS WITH KEY z_equip_coautor = abap_on.
      IF sy-subrc <> 0.
**      << FI MODIF ETODR SPEC-51135
        IF  my_mode EQ zrm_cl_valoracio_ofertes=>co_mode_punt_quadre3b.
*-- Afegim també una lína per tal de poder introduir el % de dedicació ofertada per cada membre de l'equip per cada oferta -------------------------------
          ASSIGN ex_line_ref->*  TO <ls_grid>.
          LOOP AT my_columns ASSIGNING <ls_column> .
            CLEAR <ls_row> .
            <ls_row>-row_color    = 'C111' .
            <ls_row>-z_equip_pdm  = abap_on.
            ">> SPEC-77824, Inici Modificació - ETODR
            CLEAR: ls_style.
            ls_style-fieldname      = <ls_column>-fieldname.
            "<< SPEC-77824, Final Modificació - ETODR
            ls_style-style          = cl_gui_alv_grid=>mc_style_hotspot.
            INSERT ls_style INTO TABLE lt_style_aux.
            <ls_row>-style        = lt_style_aux .
            ASSIGN COMPONENT <ls_column>-colpos OF STRUCTURE <ls_punt> TO <l_punt> .
            <l_punt>              = CONV #( 'Dedicació ofertada' ).
          ENDLOOP .
          INSERT <ls_grid> INTO <lt_grid> INDEX 1.
        ENDIF.
      ENDIF.
    ENDIF.
**  << FI MODIF ETODR SPEC-50770
  ENDIF.
**<< FI MODIF ETODR SPEC-49500

*-- Afegim també una lína que indica el tipus d'oferta -------------------------------
  IF    my_mode EQ co_mode_1_round
     OR my_mode EQ co_mode_punct_1st
     OR my_mode EQ co_mode_punct_tec
**   >> INI MODIF ETODR SPEC-49075
     OR my_mode EQ zrm_cl_valoracio_ofertes=>co_mode_punt_quadre2b
     OR my_mode EQ zrm_cl_valoracio_ofertes=>co_mode_punt_quadre3b
     OR my_mode EQ zrm_cl_valoracio_ofertes=>co_mode_punt_quadre4b
*>> Ini  SPEC-54695  - ETMAE
     OR my_mode = zrm_cl_valoracio_ofertes=>co_mode_millor_classif .
*<< Fi  SPEC-54695  - ETMAE

**   << FI MODIF ETODR SPEC-49075
    ASSIGN ex_line_ref->*  TO <ls_grid> .
    LOOP AT my_columns ASSIGNING <ls_column> .
      CLEAR <ls_row> .
      <ls_row>-row_color      = 'C511' .
      <ls_row>-z_descripcio   = 'Tipus oferta'(l04) .
      <ls_row>-style = lt_style_sum .
**    >> INI MODIF ETODR SPEC-46407
      IF my_backend->get_my_crit_dyn( ) = abap_on.
        <ls_row>-style = lt_style_hotspot_b.
      ENDIF.
**    << FI MODIF ETODR SPEC-46407
      <ls_row>-z_base = abap_on. "SPEC-49500
      ASSIGN COMPONENT <ls_column>-colpos OF STRUCTURE <ls_punt> TO <l_punt> .
      <l_punt> = <ls_column>-subheader .
    ENDLOOP .
    INSERT <ls_grid> INTO <lt_grid> INDEX 1 .

    "INI ECDRB SPEC-64893
    "Si és z_mult_equip_incr, afegir linea Equip i no afegir la resta de linies,
    "fer exit del codi
    READ TABLE lt_crit_punt TRANSPORTING NO FIELDS WITH KEY z_mult_equip_incr = abap_true.
    IF sy-subrc = 0.
      ASSIGN ex_line_ref->*  TO <ls_grid> .
      LOOP AT my_columns ASSIGNING <ls_column> .
        CLEAR <ls_row> .
        <ls_row>-row_color      = 'C711' .
        <ls_row>-z_descripcio   = ''.
        <ls_row>-style = lt_style_sum .

        IF my_backend->get_my_crit_dyn( ) = abap_on.
          <ls_row>-style = lt_style_hotspot_b.
        ENDIF.

        <ls_row>-z_mult_equip_incr = abap_on. "SPEC-49500
        ASSIGN COMPONENT <ls_column>-colpos OF STRUCTURE <ls_punt> TO <l_punt> .
        <l_punt> = 'Equip' .
      ENDLOOP .
      INSERT <ls_grid> INTO <lt_grid> INDEX 2 .
      EXIT.
    ENDIF.
    "FI ECDRB SPEC-64893

*>> SPEC-55535, Inici modificació - ETLJS

    READ TABLE lt_crit_punt TRANSPORTING NO FIELDS WITH KEY z_incr = abap_true.

    IF sy-subrc = 0.
      ASSIGN ex_line_ref->*  TO <ls_grid> .
      LOOP AT my_columns ASSIGNING <ls_column> .
        CLEAR <ls_row> .
        <ls_row>-row_color      = 'C711' .
        <ls_row>-z_descripcio   = ''.
        <ls_row>-style = lt_style_sum .
        IF my_backend->get_my_crit_dyn( ) = abap_on.
          <ls_row>-style = lt_style_hotspot_b.
        ENDIF.
        <ls_row>-z_incr = abap_on.
        ASSIGN COMPONENT <ls_column>-colpos OF STRUCTURE <ls_punt> TO <l_punt> .

        <l_punt> = 'Idoneïtat cap d''Obra' .

      ENDLOOP .
      INSERT <ls_grid> INTO <lt_grid> INDEX 2 .
    ENDIF. "
*<< SPEC-55535, Final modificació - ETLJS

    ">>>SPEC:67070, Inici modificació - ECJMS
    READ TABLE lt_crit_punt TRANSPORTING NO FIELDS
         WITH KEY z_coeficient_iref = co_coeficient_iref.

    IF sy-subrc = 0.
      ASSIGN ex_line_ref->*  TO <ls_grid> .
      LOOP AT my_columns ASSIGNING <ls_column> .
        CLEAR <ls_row> .
        <ls_row>-row_color      = 'C711' .
        <ls_row>-z_descripcio   = ''.
        <ls_row>-style = lt_style_sum .
        IF my_backend->get_my_crit_dyn( ) = abap_on.
          <ls_row>-style = lt_style_hotspot_b.
        ENDIF.
        ">> SPEC-67070, Inici Modificació - ETODR
        "S'ha de canviar aquesta condició i fer que vagi per Z_MULT_INCR_EQUIP o alguna nova, ja que Z_INCR és per les obres
*        <ls_row>-z_incr = abap_on.
        <ls_row>-z_coefi_iref = abap_on.
        "<< SPEC-67070, Final Modificació - ETODR
        ASSIGN COMPONENT <ls_column>-colpos OF STRUCTURE <ls_punt> TO <l_punt> .

        <l_punt> = text-t10.

      ENDLOOP .
      INSERT <ls_grid> INTO <lt_grid> INDEX 2 .
    ENDIF. "
    "<<<SPEC:67070, Final modificació - ECJMS

    ">> SPEC-71214, Inici Modificació - ETODR
    READ TABLE lt_crit_punt TRANSPORTING NO FIELDS
         WITH KEY z_co2 = abap_on.

    IF sy-subrc = 0.
      ASSIGN ex_line_ref->*  TO <ls_grid> .
      LOOP AT my_columns ASSIGNING <ls_column> .
        CLEAR <ls_row> .
        <ls_row>-row_color      = 'C711' .
        <ls_row>-z_descripcio   = ''.
        <ls_row>-style          = lt_style_sum .
        IF my_backend->get_my_crit_dyn( ) = abap_on.
          <ls_row>-style        = lt_style_hotspot_b.
        ENDIF.
        <ls_row>-z_co2          = abap_on.
        ASSIGN COMPONENT <ls_column>-colpos OF STRUCTURE <ls_punt> TO <l_punt> .
        IF sy-subrc = 0.
          <l_punt>              = text-t11. "CO2eq
        ENDIF.
      ENDLOOP .
      INSERT <ls_grid> INTO <lt_grid> INDEX 2 .
    ENDIF.
    "<< SPEC-71214, Final Modificació - ETODR

    READ TABLE lt_crit_punt TRANSPORTING NO FIELDS WITH KEY z_equip_max = abap_true.
*    CHECK sy-subrc EQ 0. "SPEC-50770
    IF sy-subrc = 0."SPEC-50770
      ASSIGN ex_line_ref->*  TO <ls_grid> .
      LOOP AT my_columns ASSIGNING <ls_column> .
        CLEAR <ls_row> .
        <ls_row>-row_color      = 'C711' .
        <ls_row>-z_descripcio   = ''.
        <ls_row>-style = lt_style_sum .
**    >> INI MODIF ETODR SPEC-46407
        IF my_backend->get_my_crit_dyn( ) = abap_on.
          <ls_row>-style = lt_style_hotspot_b.
        ENDIF.
**    << FI MODIF ETODR SPEC-46407
        <ls_row>-z_equip_max = abap_on. "SPEC-49500
        ASSIGN COMPONENT <ls_column>-colpos OF STRUCTURE <ls_punt> TO <l_punt> .
        <l_punt> = 'Equip' .
      ENDLOOP .
      INSERT <ls_grid> INTO <lt_grid> INDEX 2 .
    ENDIF. " SPEC-50770

**>> Inici Modificació ECAGE SPEC-66771 26/07/2022 TEST
*    READ TABLE lt_crit_punt TRANSPORTING NO FIELDS
*      WITH KEY z_sumatori = abap_true
*               z_mult_equip = abap_true
*               z_equip_coautor = abap_true.
*    IF sy-subrc = 0.
**      DATA(lv_index2) = sy-tabix + 1.
*      ASSIGN ex_line_ref->*  TO <ls_grid> .
*      READ TABLE lt_crit_punt_aux2 TRANSPORTING NO FIELDS
*      WITH KEY z_sumatori = abap_true
*             z_mult_equip = abap_true
*             z_equip_coautor = abap_true.
*      IF sy-subrc = 0.
*        LOOP AT lt_crit_punt_aux2 ASSIGNING FIELD-SYMBOL(<fs_crit_punt2>)
*        WHERE z_sumatori = abap_true
*         AND  z_mult_equip = abap_true
*         AND  z_equip_coautor = abap_true.
*          LOOP AT my_columns ASSIGNING <ls_column> .
*            CLEAR <ls_row> .
*            <ls_row>-row_color      = 'C711' .
*            <ls_row>-z_descripcio   = ''.
*            <ls_row>-style = lt_style_sum .
*            IF my_backend->get_my_crit_dyn( ) = abap_on.
*              <ls_row>-style = lt_style_hotspot_b.
*            ENDIF.
*            <ls_row>-z_equip_coautor = abap_on.
*            ASSIGN COMPONENT <ls_column>-colpos OF STRUCTURE <ls_punt> TO <l_punt> .
*            <l_punt> = <fs_crit_punt2>-z_descripcio.
*          ENDLOOP .
** insertamos la linea justo antes del coautor
*          LOOP AT <lt_grid> ASSIGNING <ls_grid_aux>.
*            ASSIGN COMPONENT 'z_codi_crit_punt' OF STRUCTURE <ls_grid_aux> TO <l_crit_punt> .
*            IF <l_crit_punt> = <fs_crit_punt2>-z_codi_crit_punt.
*              DATA(lv_index2) = sy-tabix.
*              EXIT.
*            ENDIF.
*          ENDLOOP.
**          lv_index2 = lv_index2 + 1.
*          INSERT <ls_grid> INTO <lt_grid> INDEX lv_index2 .
*        ENDLOOP.
*      ENDIF.
*    ELSE.
**>> FI Modificació ECAGE SPEC-66771 26/07/2022  TEST

**      >> INI MODIF ETODR SPEC-51135
    READ TABLE lt_crit_punt TRANSPORTING NO FIELDS WITH KEY z_equip_coautor = abap_true.
    IF sy-subrc = 0.
      DATA(lv_index) = sy-tabix + 1.
      ASSIGN ex_line_ref->*  TO <ls_grid> .
      READ TABLE lt_crit_punt_aux2 TRANSPORTING NO FIELDS WITH KEY z_equip_sep = abap_true.
      IF sy-subrc = 0.
        ">> SPEC-66771, Inici Modificació - ETODR
        READ TABLE lt_crit_punt_aux2 TRANSPORTING NO FIELDS WITH KEY z_equip_sep = abap_true
                                                                     z_equip_pdm = abap_true.
        IF sy-subrc <> 0.
          "<< SPEC-66771, Final Modificació - ETODR
          LOOP AT lt_crit_punt_aux2 ASSIGNING FIELD-SYMBOL(<fs_crit_punt>)
          WHERE z_equip_sep = abap_true.
            LOOP AT my_columns ASSIGNING <ls_column> .
              CLEAR <ls_row> .
              <ls_row>-row_color      = 'C711' .
              <ls_row>-z_descripcio   = ''.
              <ls_row>-style = lt_style_sum .
              IF my_backend->get_my_crit_dyn( ) = abap_on.
                <ls_row>-style = lt_style_hotspot_b.
              ENDIF.
              <ls_row>-z_equip_coautor = abap_on.
              ASSIGN COMPONENT <ls_column>-colpos OF STRUCTURE <ls_punt> TO <l_punt> .
              <l_punt> = <fs_crit_punt>-z_descripcio.

            ENDLOOP .
            lv_index = lv_index + 1.
            INSERT <ls_grid> INTO <lt_grid> INDEX lv_index .

          ENDLOOP.
          ">> SPEC-66771, Inici Modificació - ETODR
        ELSE.
          LOOP AT lt_crit_punt ASSIGNING FIELD-SYMBOL(<fs_crit_punt2>) WHERE z_equip_coautor = abap_true
                                                                        AND z_equip_sep     = abap_true.
            DATA(lv_tabix_aux) = sy-tabix.
            LOOP AT <lt_grid> ASSIGNING FIELD-SYMBOL(<fs_grid_aux>).
              ASSIGN COMPONENT 'Z_CODI_CRIT_PUNT' OF STRUCTURE <fs_grid_aux> TO FIELD-SYMBOL(<fs_criteri>).
              CHECK sy-subrc = 0.
              IF <fs_criteri> = <fs_crit_punt2>-z_codi_crit_punt.
                lv_index = sy-tabix.
              ENDIF.
            ENDLOOP.
            IF lv_index IS INITIAL.
              lv_index = lv_tabix_aux.
            ENDIF.
            LOOP AT my_columns ASSIGNING <ls_column> .
              CLEAR <ls_row> .
              <ls_row>-row_color      = 'C711' .
              <ls_row>-z_descripcio   = ''.
              <ls_row>-style = lt_style_sum .
              IF my_backend->get_my_crit_dyn( ) = abap_on.
                <ls_row>-style = lt_style_hotspot_b.
              ENDIF.
              <ls_row>-z_equip_coautor = abap_on.
              <ls_row>-z_equip_sep      = abap_on.
              <ls_row>-z_mod_crit_punt            = <fs_crit_punt2>-z_mod_crit_punt.
              <ls_row>-z_codi_crit_punt_equip_sep = <fs_crit_punt2>-z_codi_crit_punt.
              ASSIGN COMPONENT <ls_column>-colpos OF STRUCTURE <ls_punt> TO <l_punt> .
              <l_punt> = <fs_crit_punt2>-z_descripcio.
            ENDLOOP.
            INSERT <ls_grid> INTO <lt_grid> INDEX lv_index .
            "<< SPEC-66771, Final Modificació - ETODR
          ENDLOOP.
        ENDIF.

      ELSE.
        LOOP AT my_columns ASSIGNING <ls_column> .
          CLEAR <ls_row> .
          <ls_row>-row_color      = 'C711' .
          <ls_row>-z_descripcio   = ''.
          <ls_row>-style = lt_style_sum .
          IF my_backend->get_my_crit_dyn( ) = abap_on.
            <ls_row>-style = lt_style_hotspot_b.
          ENDIF.
          <ls_row>-z_equip_coautor = abap_on.
          ASSIGN COMPONENT <ls_column>-colpos OF STRUCTURE <ls_punt> TO <l_punt> .
          <l_punt> = 'Equip Redactor' .
        ENDLOOP .
        INSERT <ls_grid> INTO <lt_grid> INDEX 2 .
      ENDIF.
    ENDIF.
**      << FI MODIF ETODR SPEC-51135
  ENDIF .


  " >>>PSPEC-1451 Inici modificació - EVXGL
  " Quadre Validació Cap'd'Obra
  IF my_mode = zrm_cl_valoracio_ofertes=>co_mode_val_cap_obra.
    CLEAR: ls_crit_punt.
    READ TABLE lt_crit_punt INTO ls_crit_punt WITH KEY z_verif_cap_obra = 'X'.

    IF sy-subrc EQ 0.
      CLEAR: ls_crit_punt.
      LOOP AT lt_crit_punt INTO ls_crit_punt WHERE z_verif_cap_obra IS INITIAL
                                               AND z_codi_crit_punt IS NOT INITIAL.

        lv_tabix_aux = sy-tabix.

        READ TABLE <lt_grid> ASSIGNING <fs_grid_aux3> INDEX lv_tabix_aux.
        ASSIGN COMPONENT lv_field OF STRUCTURE <fs_grid_aux3> TO <fs_itab_style>.

        LOOP AT <fs_itab_style> ASSIGNING FIELD-SYMBOL(<wa_style>).
          " Camp editable o no
          ASSIGN COMPONENT lv_field OF STRUCTURE <wa_style> TO <fs_style> .
          ASSIGN COMPONENT lv_fieldname OF STRUCTURE <wa_style> TO <fs_fieldname_style>.

          IF sy-subrc IS INITIAL
            AND <fs_style> <> cl_gui_alv_grid=>mc_style_disabled.  " No editable
            <fs_style> = cl_gui_alv_grid=>mc_style_disabled.
          ENDIF.


          " Color camp
          ASSIGN COMPONENT lv_cell_color OF STRUCTURE <fs_grid_aux3> TO <fs_cell_color>.

          CLEAR: lv_select_clause,
                 lv_select_clause2.

          lv_select_clause = 'FNAME ='.
          CONCATENATE  '''' <fs_fieldname_style> '''' INTO lv_select_clause2 .
          CONCATENATE lv_select_clause lv_select_clause2 INTO lv_select_clause SEPARATED BY space.

          LOOP AT <fs_cell_color> ASSIGNING FIELD-SYMBOL(<wa_cell_color>) WHERE (lv_select_clause).

            IF sy-subrc = 0.
              ASSIGN COMPONENT lv_color OF STRUCTURE <wa_cell_color> TO <fs_color> .

              ASSIGN COMPONENT lv_col OF STRUCTURE <fs_color> TO <fs_col>.
              ASSIGN COMPONENT lv_int OF STRUCTURE <fs_color> TO <fs_int>.
              ASSIGN COMPONENT lv_inv OF STRUCTURE <fs_color> TO <fs_inv>.

              ASSIGN lv_1 TO <fs_1>.
              ASSIGN lv_4 TO <fs_4>.

              IF  <fs_col> <> <fs_4>.
                <fs_col> = <fs_4>.
              ENDIF.

              IF <fs_int> <> <fs_1>.
                <fs_int> = <fs_1>.
              ENDIF.

              IF <fs_inv> <> <fs_4>.
                <fs_inv> = <fs_4>.
              ENDIF.

*            ELSE.
*
*              ASSIGN lv_1 TO <fs_1>.
*              ASSIGN lv_4 TO <fs_4>.

            ENDIF.

          ENDLOOP.
        ENDLOOP.
      ENDLOOP.
    ENDIF.

  ENDIF.
  " <<<PSPEC-1451 Fi modificació - EVXGL


ENDMETHOD.


METHOD prepare_data.

  DATA: lt_ofertax   TYPE zrm_cl_valoracio_ofertes=>ty_t_ofertax,
        lt_crit_punt TYPE  zrm_cl_valoracio_ofertes=>ty_t_crit_punt,
        lt_lema      TYPE zrm_cl_valoracio_ofertes=>ty_t_lema,
        l_read_only  TYPE xfeld.

  my_backend->get_max_punts_equi( IMPORTING et_max_punts_equi = DATA(lt_max_carrecs) ). "SPEC-49806

  CASE my_mode .
    WHEN  co_mode_1_round OR co_mode_punct_1st OR
          co_mode_punct_tec OR co_mode_punt_sol_part.
      lt_ofertax  = my_backend->get_offers( ) .
      offers_to_columns( EXPORTING im_offers = lt_ofertax
                         CHANGING  ch_columns = my_columns ) .
    WHEN co_mode_neg_f2. "P100031 - ETRCM Fase 2 negciació
      lt_ofertax  = my_backend->get_offers( ) .
      offers_to_columns( EXPORTING im_offers  = lt_ofertax
                                   my_mode    = my_mode
                         CHANGING  ch_columns = my_columns ).
    WHEN  co_mode_punct_2nd .
      lt_lema     = my_backend->get_lemes( ) .
      lemes_to_columns( EXPORTING  im_lemes = lt_lema
                         CHANGING  ch_columns = my_columns ) .

    WHEN  co_mode_adj_2nd .
      lt_ofertax  = my_backend->get_offers( ) .
      lt_lema     = my_backend->get_lemes( ) .
      lemes_to_columns( EXPORTING  im_lemes = lt_lema
                                   im_offers = lt_ofertax
                         CHANGING  ch_columns = my_columns ) .
**  >> INI MODIF ETODR SPEC-49075
    WHEN zrm_cl_valoracio_ofertes=>co_mode_punt_quadre2b.
      lt_ofertax  = my_backend->get_offers( ) .
      offers_to_columns( EXPORTING im_offers    = lt_ofertax
                         CHANGING  ch_columns   = my_columns ) .
    WHEN zrm_cl_valoracio_ofertes=>co_mode_punt_quadre3b.
      lt_ofertax  = my_backend->get_offers( ) .
      offers_to_columns( EXPORTING im_offers    = lt_ofertax
                                   im_max_equip = lt_max_carrecs "SPEC-49806
                         CHANGING  ch_columns   = my_columns ) .
    WHEN zrm_cl_valoracio_ofertes=>co_mode_punt_quadre4b.
      lt_ofertax  = my_backend->get_offers( ) .
      offers_to_columns( EXPORTING im_offers  = lt_ofertax
                                   my_mode    = my_mode         "SPEC-49806
                         CHANGING  ch_columns = my_columns ) .
**  << FI MODIF ETODR SPEC-49075

*>> Ini  SPEC-54695  - ETMAE
    WHEN zrm_cl_valoracio_ofertes=>co_mode_millor_classif.
      lt_ofertax  = my_backend->get_offers( ) .
      offers_to_columns( EXPORTING im_offers  = lt_ofertax
                                   my_mode    = my_mode
                         CHANGING  ch_columns = my_columns ) .
*<< Fi  SPEC-54695  - ETMAE

      " >>>PSPEC-1451 Inici modificació - EVXGL
    WHEN zrm_cl_valoracio_ofertes=>co_mode_val_cap_obra.
      lt_ofertax  = my_backend->get_offers( ) .
      lt_crit_punt = im_crit_punt.
      offers_to_columns( EXPORTING im_offers    = lt_ofertax
                                   im_crit_punt = lt_crit_punt
                                   my_mode      = my_mode
                         CHANGING  ch_columns   = my_columns ) .

      " <<<PSPEC-1451 Fi modificació - EVXGL

  ENDCASE .

  IF    my_read_only IS NOT INITIAL
     OR my_backend_activities-save_punct IS INITIAL.
    l_read_only = 'X' .
  ELSEIF my_backend->check_activity( my_backend_activities-save_punct ) IS INITIAL .
    l_read_only = 'X' .
  ENDIF .

  my_fieldcat = create_catalog( im_read_only = l_read_only
                                im_columns   = my_columns ).

  CALL METHOD me->populate_matrix
    IMPORTING
      ex_line_ref  = my_line_ref
      ex_table_ref = my_table_ref.

  IF      my_mode EQ co_mode_punct_1st
      OR  my_mode EQ co_mode_punct_2nd
      OR  my_mode EQ co_mode_adj_2nd
   OR (   my_mode EQ co_mode_1_round
      AND my_backend->check_activity( my_backend_activities-set_awarded ) NE space )
    OR my_mode EQ co_mode_punt_sol_part.
    sort_shown_columns( co_fc_sort_down_punt ) .
  ELSE .
    sort_shown_columns( co_fc_sort_up_name ) .
  ENDIF .

ENDMETHOD.


METHOD recalculate.
***INI MOD ETJHG - SPEC-46407
*  my_backend->recalculate( ) .
  "Recalcular puntuación en el caso que se hayan añadido o eliminado recursos
  my_backend->recalculate(
    EXPORTING
      dades_ofer_dyn = dades_ofer_dyn ).

***FIN MOD ETJHG - SPEC-46407
  CALL METHOD me->populate_matrix
    IMPORTING
      ex_line_ref  = my_line_ref
      ex_table_ref = my_table_ref.
  refresh_table_display( ) .
ENDMETHOD.


  METHOD recalculate_no_refresh.

    my_backend->recalculate(
      EXPORTING
        dades_ofer_dyn = dades_ofer_dyn ).

    CALL METHOD me->populate_matrix
      IMPORTING
        ex_line_ref  = my_line_ref
        ex_table_ref = my_table_ref.

  ENDMETHOD.


method REFRESH_TABLE_DISPLAY.
  DATA: ls_stable TYPE lvc_s_stbl .

  ls_stable-row = 'X' .
  ls_stable-col = 'X' .
  CALL METHOD my_grid->refresh_table_display
    EXPORTING
      is_stable      = ls_stable
      i_soft_refresh = 'X'
    EXCEPTIONS
      finished       = 1
      OTHERS         = 2.

endmethod.


METHOD request_close.
  DATA: l_save  TYPE xfeld VALUE 'X',
        l_valid TYPE xfeld.

*-- Vol sortir sense desar els canvis en les puntuacions? -----------------------------
  re_can_close = 'X' .
  IF my_read_only IS INITIAL .
    my_grid->check_changed_data( IMPORTING e_valid = l_valid ) .
    IF my_backend->has_changed( ) IS NOT INITIAL
       OR l_valid IS INITIAL .
      CASE me->confirm_data_loss( ) .
        WHEN '1' .
          "ECJSA - SPEC-52574 - No està recollint les diferents modificacions dels
          "canvis de puntuació en la circular de puntuacions tècniques de
          "les licitacions CT1070591 i CT1070577
          "Li diem al LOG que guardi...
          "-----------------------------------------------------------
          me->my_backend->set_save_log_pt( i_set_save_to_log = abap_on ).
          "-----------------------------------------------------------
          l_save = 'X' .
        WHEN '2' . l_save = space .
        WHEN 'A' . CLEAR re_can_close . RETURN .
      ENDCASE.
    ELSE.
      CLEAR l_save. "ETLJS SPEC-51089
    ENDIF.

    IF l_save IS NOT INITIAL .
      IF l_valid IS INITIAL .
        CLEAR re_can_close .
        RETURN .
      ELSE .
        re_can_close = 'X' .
        save( ) .
      ENDIF .
    ENDIF .
  ELSE .
*-- Vol sortir sense adjudicar?
    IF     my_backend->co_act_awardee IS NOT INITIAL
       AND my_backend->check_activity( my_backend->co_act_awardee ) IS NOT INITIAL
       AND (    my_backend->is_2_round( ) IS INITIAL
             OR my_mode EQ co_mode_adj_2nd ) .
      READ TABLE my_columns TRANSPORTING NO FIELDS WITH KEY adjudicat = 'X' .
      IF sy-subrc EQ 0 .
        CASE me->confirm_not_awarded( ) .
          WHEN '1' . re_can_close = 'X' .
          WHEN '2' . CLEAR re_can_close .
        ENDCASE .
      ENDIF .
    ENDIF .
  ENDIF .
ENDMETHOD.


METHOD save.
  DATA: l_valid TYPE xfeld .
**>> INI MODIF ETODR SPEC-47344
  IF my_backend->get_my_crit_dyn( ) IS NOT INITIAL.
    my_grid->check_changed_data( IMPORTING e_valid = l_valid ) .
    IF my_backend->has_changed( ) IS NOT INITIAL OR l_valid EQ abap_on.
      show_popup_warnings( ).
      my_backend->save( ) .
      MESSAGE i013(zrm_errors) .
    ENDIF.
  ELSE.
**<< FI MODIF ETODR SPEC-47344
    my_grid->check_changed_data( IMPORTING e_valid = l_valid ) .
    CHECK l_valid EQ 'X' .
    IF my_backend->has_changed( ) IS NOT INITIAL .
**>> INI MODIF ETODR SPEC-47344
***  >> INI MODIF ETODR SPEC-46407
*      IF my_backend->get_my_crit_dyn( ) IS NOT INITIAL.
*        show_popup_warnings( ).
*      ENDIF.
***  << FI MODIF ETODR SPEC-46407
**<< FI MODIF ETODR SPEC-47344
      my_backend->save( ) .
      MESSAGE i013(zrm_errors) .
    ENDIF .
  ENDIF .
ENDMETHOD.


  METHOD seleccio_apartats_dyn.
**  >> INI MODIF ETODR SPEC-61754
    IF my_mode = zrm_cl_valoracio_ofertes=>co_mode_punt_formulari.
      my_backend->seleccio_apartats_dyn_form( ).
    ELSE.
**  << FI MODIF ETODR SPEC-61754
      my_backend->seleccio_apartats_dyn( EXCEPTIONS not_punt_ofer = 1 ).
      IF sy-subrc <> 0.
        RAISE EXCEPTION TYPE zcx_rm_valoracio .
      ELSE.
        me->recalculate( ) .
      ENDIF.
    ENDIF.
  ENDMETHOD.


METHOD set_awardee.
*inici SPEC-65311
  TYPES: BEGIN OF lt_contr,
           z_subtipus_cont TYPE z_subtipus_cont,
           data_inici      TYPE dats,
           data_fi         TYPE dats,
         END OF lt_contr.
  DATA : it_contr TYPE TABLE OF lt_contr.

  DATA: iv_resposta TYPE c.

*fi SPEC-65311

  DATA: ls_column_adj    TYPE ty_s_column,
        ls_column_better TYPE ty_s_column,
        l_answer         TYPE c,
        lcx              TYPE REF TO zcx_rm_valoracio,
        l_message        TYPE string,
        l_continua       TYPE xfeld,
        lv_proc_adj      TYPE z_proc_adj.

  DATA: lr_mant_bossa_am      TYPE REF TO zrm_cl_mant_bossa_am, "ETODR SPEC-59973
        lv_codi_exp           TYPE z_codi_exp, "ETODR SPEC-59973
        lv_result_arquitectes TYPE xfeld. "SPEC-65852

  DATA: l_total TYPE z_punts.

*>> INI MODIF EVAGE SPEC-86239
  DATA: lt_props  TYPE TABLE OF bapiproptb,
        ls_props  TYPE bapiproptb,
        ls_return TYPE bapiret2,
        lv_modelo TYPE z_model_exp.

  DATA: lv_repid      TYPE repid VALUE 'ZRM_CL_VALORACIO_OFERTES',
        lv_field_info TYPE zsap_de_field VALUE 'CONFIRM_PUNT_TEC',
        lt_param      TYPE STANDARD TABLE OF zsap_dt_param_hc,
        r_model       TYPE RANGE OF bapipropva,
        ls_model      LIKE LINE OF r_model.

  SELECT * FROM zsap_dt_param_hc INTO TABLE lt_param
    WHERE repid      = lv_repid AND
          field_info = lv_field_info.

  " montamos rango de parametros de los modelos que no deben aplicar para los errores
  CLEAR: r_model.
  LOOP AT lt_param ASSIGNING FIELD-SYMBOL(<fs_param>).
    ls_model-sign   = 'I'.
    ls_model-option = 'EQ'.
    ls_model-low    = <fs_param>-value.
    APPEND ls_model TO r_model.
  ENDLOOP.

  CALL FUNCTION 'SRM_RECORD_GETPROPERTIES'
    EXPORTING
      objectid            = me->gv_objectid
      documentclass       = me->gv_docclass
      whole_document      = abap_true
    IMPORTING
      return              = ls_return
    TABLES
      properties          = lt_props
    EXCEPTIONS
      container_is_locked = 1
      not_authorized      = 2
      parameter_error     = 3
      container_not_found = 4
      container_corrupt   = 5
      internal_error      = 6
      customizing_error   = 7
      OTHERS              = 8.

  READ TABLE lt_props INTO ls_props WITH KEY name = 'SRM_MODEL'.
  lv_modelo  = ls_props-value.

*<< FI MODIF EVAGE SPEC-86239




  READ TABLE my_columns INTO ls_column_adj WITH KEY adjudicat = 'X' .
  IF sy-subrc NE 0.
    SELECT SINGLE z_proc_adj
      FROM zrm_dt_exp_cont
      INTO lv_proc_adj
     WHERE docclass = me->gv_docclass AND
           objectid = me->gv_objectid.
    IF lv_proc_adj NE 'CE'.
      MESSAGE i049 DISPLAY LIKE 'E'.
      RETURN .
    ENDIF.
  ENDIF .

  l_total = ls_column_adj-punt_total .
  LOOP AT my_columns INTO ls_column_better WHERE editable IS NOT INITIAL
                                              AND punt_total GT l_total .
    EXIT.
  ENDLOOP .
*inici SPEC-65311
  CLEAR iv_resposta.
  SELECT a~z_subtipus_cont b~data_inici b~data_fi
    INTO CORRESPONDING FIELDS OF TABLE it_contr
      FROM zrm_dt_exp_cont AS a INNER JOIN zrm_dedtec_subco AS b
                                   ON b~subtipus_contracte EQ a~z_subtipus_cont
      WHERE
       b~data_inici LE a~z_data_creacio AND
       b~data_fi    GE a~z_data_creacio AND
       a~docclass   EQ me->gv_docclass  AND
       a~objectid   EQ me->gv_objectid  AND
       b~data_inici LE sy-datum         AND
       b~data_fi    GE sy-datum.

  IF sy-subrc EQ 0.
    iv_resposta = abap_true.
  ENDIF.

*  IF sy-subrc NE 0.


  IF ls_column_better-key IS NOT INITIAL .
    l_message = text-q04 .
  ELSE .
    l_message = text-q05 .
  ENDIF .

  CALL FUNCTION 'POPUP_TO_CONFIRM'
    EXPORTING
      titlebar              = 'Adjudicació provisional'(006)
      text_question         = l_message
      display_cancel_button = space
    IMPORTING
      answer                = l_answer.

*  ELSE.
*
*    l_answer = '1'.
*
*  ENDIF.
*fi SPEC-65311

  CHECK l_answer EQ '1' .
  TRY .
      l_continua = abap_true.
**     >> INI MODIF ETODR SPEC-54282
      "Aquesta comprovació només la fem pels procediments Oberts de la Llei 9/2017
      IF my_backend->get_is_nova_llei_92017( ) = abap_on AND my_backend->get_proc_adj( ) = 'CP'.
        "Si és obert preu o simplificat criteri preu no ha de fer la comprovació
        IF my_backend->get_is_obert_preu( ) = abap_off AND my_backend->get_is_tipus_simpl( ) <> 'S'.
          ">>>SPEC-56319, Inici modificació  - ETODR
          "Els "convertits en criteri preu" no s'han de considerar per a la comprovació
          IF my_backend->get_is_convert_preu( ) = abap_off.
            "<<<SPEC-56319, Final modificació - ETODR
            IF gv_subtipus NE 'CQ'.
*      IF gv_subtipus NE 'CQ' OR my_backend->get_is_obert_preu( ) = abap_off OR my_backend->get_is_tipus_simpl( ) = 'S'.
**     << FI MODIF ETODR SPEC-54282

*>> INI MODIF EVAGE SPEC-86239
              IF lv_modelo NOT IN r_model.
*<< FI MODIF EVAGE SPEC-86239
                SELECT *
                FROM zrm_dt_carrecs
                INTO TABLE @DATA(lt_carrecs)
                      WHERE docclass EQ @me->gv_docclass
                      AND objectid EQ @me->gv_objectid.
                IF sy-subrc NE 0 AND iv_resposta NE abap_true.
                  MESSAGE 'Atenció, abans d''adjudicar provisionalment cal haver informat les dades de dedicació dels tècnics per a la oferta provisionalment adjudicataria'
                  TYPE 'I' .
                  CLEAR l_continua.
                ENDIF.
              ENDIF.
*>> INI MODIF EVAGE SPEC-86239
            ENDIF.
*<< FI MODIF EVAGE SPEC-86239

*            INI ETLJS SPEC-65852
            "Comprovar si arquitectes estan informats
            comprovacio_arquitectes(
              EXPORTING
                iv_docclass =     me->gv_docclass
                iv_objectid =     me->gv_objectid
                im_num_ofer =     ls_column_adj-key "ETODR
              IMPORTING
                ov_resultat =    lv_result_arquitectes
            ).
            "Si no estan informats, llençar excepció
            IF lv_result_arquitectes IS INITIAL.
              RAISE EXCEPTION TYPE zcx_rm_valoracio
                EXPORTING
                  textid = zcx_rm_valoracio=>arquitecte_uninformed_new.
            ENDIF.
*FIN ETLJS SPEC-65852
          ENDIF.
        ENDIF.
        "INI ECDRB SPEC-65852
*      ELSEIF my_backend->get_is_nova_llei_92017( ) = abap_off.
*        "Comprovar si arquitectes estan informats
*        comprovacio_arquitectes(
*          EXPORTING
*            iv_docclass =     me->gv_docclass
*            iv_objectid =     me->gv_objectid
*          IMPORTING
*            ov_resultat =    lv_result_arquitectes
*        ).
*        "Si no estan informats, llençar excepció
*        IF lv_result_arquitectes IS INITIAL.
*          RAISE EXCEPTION TYPE zcx_rm_valoracio
*            EXPORTING
*              textid = zcx_rm_valoracio=>arquitecte_uninformed_new.
*        ENDIF.

        "FI ECDRB SPEC-65852
      ENDIF.
      CHECK l_continua IS NOT INITIAL.
      "INI MODIF ETODR SPEC-59973
      TRY.
          CLEAR: lv_codi_exp.
          SELECT SINGLE z_codi_exp
            FROM zrm_dt_exp_cont
            INTO lv_codi_exp
            WHERE docclass     = me->gv_docclass
              AND objectid     = me->gv_objectid
              AND z_acord_marc = abap_on.
          IF sy-subrc = 0.
            CREATE OBJECT lr_mant_bossa_am
              EXPORTING
                iv_codi_exp = lv_codi_exp.
            IF lr_mant_bossa_am IS BOUND.
              lr_mant_bossa_am->set_awardee_am( ).
            ENDIF.
          ENDIF.
        CATCH zcx_rm_mant_bossa_am.

      ENDTRY.
      "FI MODIF ETODR SPEC-59973
      my_backend->set_awardee( ls_column_adj-key ) .
      my_backend->set_save_log_pt( abap_off ). " INI MODIF ETODR SPEC-40749
      my_backend->send_notificacions('ADJPROV'). "INI MODIF ETLJS SPEC-47798
      me->save( ) .
      prepare_data( ) .
    CATCH zcx_rm_valoracio INTO lcx .
      MESSAGE lcx TYPE 'I' DISPLAY LIKE 'E' .
  ENDTRY .

  me->refresh_table_display( ) .

ENDMETHOD.


METHOD set_best_classified.

*>> Ini  SPEC-54695  - ETMAE  - copia de set_awardee

  DATA: ls_column_mc TYPE ty_s_column, " millor classificat
        lr_zcx       TYPE REF TO zcx_rm_valoracio,
        lv_answer    TYPE c,
        lv_question  TYPE text255.

  lv_question = text-q18.

  CLEAR : lv_answer.

  CALL FUNCTION 'POPUP_TO_CONFIRM'
    EXPORTING
      titlebar              = text-t08  " Oferta millor classificada
      text_question         = lv_question
      icon_button_1         = 'ICON_SYSTEM_OKAY'
      default_button        = '1'
      display_cancel_button = ' '
    IMPORTING
      answer                = lv_answer.

  CHECK lv_answer = '1' .

  READ TABLE my_columns INTO ls_column_mc
    WITH KEY mill_class = abap_true .
  IF sy-subrc IS NOT INITIAL.
    MESSAGE i114 DISPLAY LIKE 'E'.
    RETURN .
  ENDIF .

  TRY.
*   update zrm_dt_exp_cont y zrm_dt_ofertes
      my_backend->set_best_classified( ls_column_mc-key ) .
*   enviar email de notificació al cap de´l'expedient
      my_backend->notif_oferta_millor_classifica( ).

******************************************************************************************
      "Enviament d'avís automàtic (mail) al tècnic adjudicador Oferta Millor Classificada
      "EVEEM 27.05.25 PSPEC-1485: PR13 - Informe Control de Fases
      my_backend->send_warning_best_ranked_offer( ).
******************************************************************************************

      me->save( ) .
      prepare_data( ) .

    CATCH zcx_rm_valoracio INTO lr_zcx     .
      MESSAGE lr_zcx   TYPE 'I' DISPLAY LIKE 'E' .
  ENDTRY .

  me->refresh_table_display( ) .

*<< Fi  SPEC-54695  - ETMAE
ENDMETHOD.
*
*------------------------------------------------------------------------------
*


METHOD shift_shown_columns.
  DATA: l_tabix TYPE i,
        l_total TYPE i.
  FIELD-SYMBOLS: <ls_fcat>   TYPE lvc_s_fcat,
                 <ls_column> TYPE ty_s_column .

  DESCRIBE TABLE my_columns LINES l_total .

  IF l_total GT co_max_cols_shown .
    IF im_direction IS SUPPLIED .
      CASE im_direction .
        WHEN co_fc_page_first .
          my_page_first_index = 1 .
          IF l_total GT co_max_cols_shown .
            my_page_last_index = co_max_cols_shown .
          ELSE .
            my_page_last_index = l_total .
          ENDIF .

        WHEN co_fc_page_left .
          IF my_page_first_index GT co_max_cols_shown .
            SUBTRACT co_max_cols_shown FROM  my_page_first_index .
          ELSE .
            my_page_first_index = 1 .
          ENDIF .
          my_page_last_index = my_page_first_index + co_max_cols_shown - 1 .
          IF my_page_last_index GT l_total .
            my_page_last_index = l_total .
          ENDIF.

        WHEN co_fc_column_left .
          IF my_page_first_index GT 1.
            SUBTRACT 1 FROM  my_page_first_index .
          ELSE .
            my_page_first_index = 1 .
          ENDIF .
          my_page_last_index = my_page_first_index + co_max_cols_shown - 1 .
          IF my_page_last_index GT l_total .
            my_page_last_index = l_total .
          ENDIF.

        WHEN co_fc_column_right .
          ADD 1 TO my_page_last_index .
          IF my_page_last_index GT l_total .
            my_page_last_index = l_total .
          ENDIF .
          IF my_page_last_index GT co_max_cols_shown .
            my_page_first_index = my_page_last_index - co_max_cols_shown + 1.
          ELSE .
            my_page_first_index = 1 .
          ENDIF .

        WHEN co_fc_page_right .
          ADD co_max_cols_shown TO my_page_last_index .
          IF my_page_last_index GT l_total .
            my_page_last_index = l_total .
          ENDIF .
          IF my_page_last_index GT co_max_cols_shown .
            my_page_first_index = my_page_last_index - co_max_cols_shown + 1.
          ELSE .
            my_page_first_index = 1 .
          ENDIF .

        WHEN co_fc_page_last .
          my_page_last_index = l_total .
          IF l_total GT co_max_cols_shown .
            my_page_first_index = my_page_last_index - co_max_cols_shown + 1.
          ELSE .
            my_page_first_index = 1 .
          ENDIF.
        WHEN OTHERS .             RETURN .
      ENDCASE .
    ELSEIF im_page IS SUPPLIED .
      my_page_first_index = 1 + co_max_cols_shown * ( im_page - 1 ).
      my_page_last_index  = my_page_first_index + co_max_cols_shown - 1 .
      IF my_page_last_index GT l_total .
        my_page_last_index = l_total .
        my_page_first_index = my_page_last_index - co_max_cols_shown + 1 .
      ENDIF .
    ENDIF .

    LOOP AT my_columns ASSIGNING <ls_column> .
      l_tabix = sy-tabix .
      READ TABLE my_fieldcat ASSIGNING <ls_fcat> WITH KEY fieldname = <ls_column>-fieldname.
      IF     l_tabix GE my_page_first_index
         AND l_tabix LE my_page_last_index .
        <ls_fcat>-no_out    = ' ' .
      ELSE .
        <ls_fcat>-no_out    = 'X' .
      ENDIF .
    ENDLOOP .
  ENDIF .

  IF my_grid IS BOUND .
    CALL METHOD my_grid->set_frontend_fieldcatalog
      EXPORTING
        it_fieldcatalog = my_fieldcat.
    my_grid->refresh_table_display( ).
  ENDIF .
ENDMETHOD.


METHOD show_navigation_box.
  DATA: ls_row_id   TYPE lvc_s_row,
        ls_col_id   TYPE lvc_s_col,
        l_value     TYPE char20,
        lr_columns  TYPE REF TO cl_salv_columns_table,
        ls_col      TYPE ty_s_column,
        lr_col      TYPE REF TO cl_salv_column_table,
        l_height    TYPE i,
        ls_nav_info TYPE ty_s_nav_info.
  FIELD-SYMBOLS: <ls_grid>      TYPE ANY,
                 <lt_grid>      TYPE STANDARD TABLE,
                 <ls_row>       TYPE ty_s_row .

  ASSIGN my_table_ref->* TO <lt_grid> .
  ASSIGN my_line_ref->*  TO <ls_grid> .
  ASSIGN COMPONENT '_CONTROL_' OF STRUCTURE <ls_grid> TO <ls_row> .

  CALL METHOD my_grid->get_current_cell
    IMPORTING
      es_row_id = ls_row_id
      es_col_id = ls_col_id
      e_value   = l_value.

  READ TABLE <lt_grid> INTO <ls_grid> INDEX ls_row_id-index .
  REFRESH my_navigation_info .
*  READ TABLE my_rows    INTO ls_row  INDEX ls_row_id-index .
  READ TABLE my_columns INTO ls_col
         WITH KEY fieldname = ls_col_id-fieldname .
  IF sy-subrc EQ 0 .
    ls_nav_info-label   = text-l01 .
    ls_nav_info-content = ls_col-key .
    APPEND ls_nav_info TO my_navigation_info .

    ls_nav_info-label   = text-l02 .
    ls_nav_info-content = ls_col-full_name .
    APPEND ls_nav_info TO my_navigation_info .

    IF    my_mode EQ co_mode_1_round
       OR my_mode EQ co_mode_punct_1st .
      ls_nav_info-label   = text-l04 .
      ls_nav_info-content = ls_col-subheader.
      APPEND ls_nav_info TO my_navigation_info .
    ENDIF .

    ls_nav_info-label   = text-l03 .
    WRITE ls_col-punt_total TO ls_nav_info-content LEFT-JUSTIFIED .
    APPEND ls_nav_info TO my_navigation_info .

    ls_nav_info-label   = <ls_row>-z_descripcio.
    ls_nav_info-content = l_value .
    APPEND ls_nav_info TO my_navigation_info .

    DESCRIBE TABLE my_navigation_info LINES l_height .
    l_height = l_height * 20 .
  ENDIF .
  TRY.
      IF my_navigation_box IS INITIAL .
        CREATE OBJECT my_navigation_box
          EXPORTING
            caption = text-f09
            top = 50
            left = 80
            width = '750'
            height = l_height.
        SET HANDLER me->on_close_navigation FOR my_navigation_box .
        CALL METHOD cl_salv_table=>factory
          EXPORTING
            list_display = if_salv_c_bool_sap=>false
            r_container  = my_navigation_box
          IMPORTING
            r_salv_table = my_navigation_grid
          CHANGING
            t_table      = my_navigation_info.
        lr_columns = my_navigation_grid->get_columns( ) .
        lr_columns->set_optimize( 'X' ) .
        lr_columns->set_headers_visible( space ) .
        lr_columns->set_key_fixation( 'X' ) .
        lr_col ?= lr_columns->get_column( 'LABEL' ) .
        lr_col->set_key( 'X' ) .
        my_navigation_grid->display( ) .
      ELSE .
        lr_columns = my_navigation_grid->get_columns( ) .
        lr_columns->set_optimize( 'X' ) .
        my_navigation_grid->refresh( ) .
      ENDIF .
    CATCH cx_salv_msg cx_salv_not_found .
      my_navigation_enabled = space .
  ENDTRY.
ENDMETHOD.


  METHOD show_popup_warnings.
    TYPES: BEGIN OF ty_s_codi_crit_punt,
             z_codi_crit_punt TYPE z_codi_crit_punt,
           END OF ty_s_codi_crit_punt,
           ty_t_codi_crit_punt TYPE STANDARD TABLE OF ty_s_codi_crit_punt.

    DATA: lt_ofertax               TYPE zrm_cl_valoracio_ofertes=>ty_t_ofertax,
          lt_codi_crit_punt        TYPE ty_t_codi_crit_punt,
          lt_puntuacio_apartat     TYPE zrm_cl_valoracio_ofertes=>ty_t_puntuacio_subapartats,
          lt_puntuacio_apartat_aux TYPE zrm_cl_valoracio_ofertes=>ty_t_puntuacio_subapartats,
          lt_punt_ofer_all         TYPE zrm_tt_dt_punt_ofer,
          lt_punt_ofer_all_2       TYPE zrm_tt_dt_punt_ofer,
          lv_mod_punt              TYPE z_mod_crit_punt.

    CLEAR: lt_puntuacio_apartat[], lt_punt_ofer_all[], lt_codi_crit_punt[], lt_punt_ofer_all_2[].

    TRY.
        DATA(lt_crit_aux_punt) = my_backend->get_crit_punt_offers( im_only_used_ones = abap_off ).
      CATCH cx_root.
        RETURN.
    ENDTRY.
    LOOP AT lt_crit_aux_punt ASSIGNING FIELD-SYMBOL(<fs_aux_punt>) WHERE z_codi_subapar_punt IS NOT INITIAL.
      IF lv_mod_punt IS INITIAL.
        lv_mod_punt = <fs_aux_punt>-z_mod_crit_punt.
      ENDIF.
      APPEND <fs_aux_punt>-z_codi_crit_punt TO lt_codi_crit_punt.
    ENDLOOP.


    my_backend->get_dades_ofer_dyn( IMPORTING ex_punt_ofer_dyn = lt_punt_ofer_all ).
    IF lt_punt_ofer_all[] IS INITIAL.
      SELECT *
        FROM zrm_dt_punt_ofer
        INTO TABLE @lt_punt_ofer_all
        FOR ALL ENTRIES IN @lt_codi_crit_punt
        WHERE docclass         = @gv_docclass
          AND objectid         = @gv_objectid
          AND z_mod_crit_punt  = @lv_mod_punt
          AND z_codi_crit_punt = @lt_codi_crit_punt-z_codi_crit_punt
          AND z_no_aplica      = @abap_off.                          "si no aplica no s'ha de mostrar ni recuperar
      CHECK sy-subrc = 0.
    ELSE.
      LOOP AT lt_codi_crit_punt ASSIGNING FIELD-SYMBOL(<fs_crit_punt>).
        LOOP AT lt_punt_ofer_all ASSIGNING FIELD-SYMBOL(<fs_ofer_all>) WHERE z_codi_crit_punt = <fs_crit_punt>-z_codi_crit_punt
                                                                         AND z_no_aplica      = abap_off.
          APPEND <fs_ofer_all> TO lt_punt_ofer_all_2.
        ENDLOOP.
      ENDLOOP.
      lt_punt_ofer_all[] = lt_punt_ofer_all_2[].
    ENDIF.

    LOOP AT lt_punt_ofer_all ASSIGNING FIELD-SYMBOL(<fs_all>).
      CLEAR: lt_puntuacio_apartat_aux[].
      CHECK <fs_all>-z_codi_subapar_punt IS NOT INITIAL.
      my_backend->get_punt_subapart( EXPORTING i_subapartat      = <fs_all>-z_codi_subapar_punt
                                     IMPORTING et_dades_subapart = lt_puntuacio_apartat_aux ).

      DELETE lt_puntuacio_apartat_aux WHERE z_num_ofer <> <fs_all>-z_num_ofer.
      APPEND LINES OF lt_puntuacio_apartat_aux TO lt_puntuacio_apartat.
    ENDLOOP.

    TRY.
        lt_ofertax = my_backend->get_offers( ).
      CATCH cx_root.
        RETURN.
    ENDTRY.

    CALL FUNCTION 'ZRM_MOSTRA_PUNT_WARNINGS'
      EXPORTING
        im_mod_crit     = lv_mod_punt
        im_docclass     = gv_docclass
        im_objectid     = gv_objectid
        it_punt_ofer    = lt_punt_ofer_all
        it_punt_apartat = lt_puntuacio_apartat
        it_ofertes      = lt_ofertax
      EXCEPTIONS
        not_subapartat  = 0.
*
  ENDMETHOD.


METHOD sort_shown_columns.
  DATA: ls_column TYPE ty_s_column,
        l_pos     TYPE i .
  FIELD-SYMBOLS: <ls_fcat> TYPE lvc_s_fcat .

  CASE im_sort_order .
    WHEN co_fc_sort_up_name .
      SORT my_columns STABLE BY editable  DESCENDING
                                full_name  ASCENDING AS TEXT
                                sort_crit1 ASCENDING.

    WHEN co_fc_sort_down_name .
      SORT my_columns STABLE BY editable  DESCENDING
                               full_name  DESCENDING AS TEXT
                               sort_crit1 ASCENDING.

    WHEN co_fc_sort_up_punt .
      SORT my_columns STABLE BY editable   DESCENDING
                                punt_total ASCENDING
                                sort_crit1 ASCENDING.

    WHEN co_fc_sort_down_punt .
      SORT my_columns STABLE BY editable   DESCENDING
                                punt_total DESCENDING
                                sort_crit1 ASCENDING.

    WHEN OTHERS.
      RETURN .
  ENDCASE .

  LOOP AT my_columns INTO ls_column .
    l_pos = sy-tabix + co_fixed_cols_left .
    READ TABLE my_fieldcat ASSIGNING <ls_fcat> WITH KEY fieldname = ls_column-fieldname.
    <ls_fcat>-col_pos = l_pos .
  ENDLOOP .
  shift_shown_columns( im_direction = co_fc_page_first ) .

ENDMETHOD.


METHOD start.


  DATA: l_changed           TYPE xfeld,
        l_first_time        TYPE xfeld,
        l_locked            TYPE xfeld,
        l_user              TYPE sy-uname,
        lcx                 TYPE REF TO zcx_rm_valoracio,
        ls_consist_lema     TYPE zrm_cl_valoracio_ofertes=>ty_s_consistency,
        ls_consist_ofer     TYPE zrm_cl_valoracio_ofertes=>ty_s_consistency,
        ls_consist_sol_part TYPE zrm_cl_valoracio_ofertes=>ty_s_consistency.

  my_backend->start( IMPORTING ex_first_time = l_first_time ) .

** >> INI MODIF ETODR SPEC-49075
  IF my_backend->get_is_nova_llei_92017( ) = abap_on AND my_backend->get_is_obert_preu( ) = abap_off.
    IF my_mode EQ zrm_cl_valoracio_ofertes=>co_mode_punt_quadre4b.
      IF my_backend->check_conf_seq( ) = abap_off. "només es pot accedir al Q4 si s'ha confirmat Q2 i Q3
        RAISE EXCEPTION TYPE zcx_rm_valoracio
          EXPORTING
            textid = zcx_rm_valoracio=>not_confirmed_ptq3_yet.
      ENDIF.
      me->check_punt_tec_seq( ).
**    >> INI MODIF ETODR SPEC-49806
*      IF my_backend->obert_pliq_expired( ) IS NOT INITIAL.
*        my_read_only = 'X' .
*        MESSAGE i086 .
*      ENDIF.
**    << FI MODIF ETODR SPEC-49806
    ENDIF.
**    >> INI MODIF ETODR SPEC-49806
    IF my_mode EQ zrm_cl_valoracio_ofertes=>co_mode_punt_quadre2b.
      IF my_backend->obert_pliq_expired( ) IS NOT INITIAL.
        my_read_only = 'X' .
        MESSAGE i086 .
      ENDIF.
    ENDIF.
**    << FI MODIF ETODR SPEC-49806
    IF my_mode EQ zrm_cl_valoracio_ofertes=>co_mode_punt_quadre3b.
      IF my_backend->check_conf_seq( ) = abap_off. "només es pot accedir al Q3 si s'ha confirmat Q2
        RAISE EXCEPTION TYPE zcx_rm_valoracio
          EXPORTING
            textid = zcx_rm_valoracio=>not_confirmed_ptq2_yet.
      ENDIF.
    ENDIF.
  ENDIF.
  IF my_backend->get_is_nova_llei_92017( ) = abap_off. " ETODR SPEC-49075
** << FI MODIF ETODR SPEC-49075
    IF my_backend->is_2_round( ) IS INITIAL .
      IF my_mode  NE co_mode_1_round AND
        my_mode   NE co_mode_punct_tec AND
        my_mode   NE co_mode_punt_sol_part.
        RAISE EXCEPTION TYPE zcx_rm_valoracio
          EXPORTING
            textid = zcx_rm_valoracio=>only_for_2_round.
      ENDIF .

    ELSE .
      IF my_mode EQ co_mode_1_round .
        RAISE EXCEPTION TYPE zcx_rm_valoracio
          EXPORTING
            textid = zcx_rm_valoracio=>not_for_2_round.
      ENDIF .
      me->check_2_round_sequence( ) .
    ENDIF .
  ENDIF .

  IF my_mode EQ co_mode_punct_tec.

    me->check_punt_tec_seq( ).
    IF my_backend->obert_pliq_expired( ) IS NOT INITIAL.
      my_read_only = 'X' .
      MESSAGE i086 .
    ENDIF.
  ENDIF.

  IF my_mode EQ co_mode_punt_sol_part.
    me->check_sol_part_seq( ).
  ENDIF.
**>> INI MODIF ETODR SPEC-61754
  "Quan estem accedint des del node per generar el formulari de les puntuacions objectives, encara no tenim ofertes...
  IF my_mode <> zrm_cl_valoracio_ofertes=>co_mode_punt_formulari.
**<< FI MODIF ETODR SPEC-61754
    TRY .
        my_backend->lock( IMPORTING ex_success = l_locked
                                    ex_lock_user = l_user
                                    ex_changed   = l_changed ) .
      CATCH zcx_rm_valoracio INTO lcx .
        my_read_only = 'X' .
        MESSAGE lcx TYPE 'I' DISPLAY LIKE 'E' .
    ENDTRY .

    IF l_locked IS INITIAL .
      IF me->gv_docclass <> 'ZQDC'. "modi 1482 EVCHA
        MESSAGE i081 WITH l_user .
        my_read_only = 'X' .
      ENDIF.
    ENDIF .
**  >> INI MODIF ETODR SPEC-61754
    "Aquest missatge no es genera només quan és el primer cop, deixem el funcionament pels casos anteriors a LCP 9/2017
    "ja que amb les noves puntuacions cada cop que s'accedeix es recalculen les dades de les diferents taules de puntuacions (abans només n'hi havia una)
    IF my_backend->get_is_nova_llei_92017( ) <> abap_on.
**  << FI MODIF ETODR SPEC-61754
      IF      l_changed IS NOT INITIAL
          AND l_first_time IS INITIAL .
        MESSAGE i054(zrm_valoracio) .
      ENDIF .
    ENDIF .

    IF my_read_only IS INITIAL .
      CALL METHOD my_backend->get_consistency_info
        IMPORTING
          ex_consistency_offer    = ls_consist_ofer
          ex_consistency_lema     = ls_consist_lema
          ex_consistency_sol_part = ls_consist_sol_part.
      CASE my_mode .
        WHEN  co_mode_1_round OR co_mode_punct_1st .
* Si es vol canviar la puntuació però ens han canviat els criteris avisem que hi ha inconsistències
          IF    my_backend->check_activity( my_backend_activities-save_punct )    IS NOT INITIAL
             OR my_backend->check_activity( my_backend_activities-confirm_punct ) IS NOT INITIAL .
            my_read_only = check_consistency( ls_consist_ofer ) .
          ENDIF .
          IF     my_read_only IS INITIAL
             AND ( my_backend->check_activity( my_backend_activities-save_punct ) IS NOT INITIAL
              OR my_backend->check_activity( my_backend_activities-confirm_punct ) IS NOT INITIAL ).
            check_temeritats( ) .
          ENDIF .

        WHEN  co_mode_punct_2nd .
* Si es vol canviar la puntuació però ens han canviat els criteris avisem que hi ha inconsistències
          IF    my_backend->check_activity( my_backend_activities-save_punct )    IS NOT INITIAL
             OR my_backend->check_activity( my_backend_activities-confirm_punct ) IS NOT INITIAL .
            my_read_only = check_consistency( ls_consist_lema ) .
          ENDIF .

        WHEN co_mode_punct_tec .
          IF    my_backend->check_activity( my_backend_activities-save_punct )    IS NOT INITIAL
             OR my_backend->check_activity( my_backend_activities-confirm_punct ) IS NOT INITIAL .
            my_read_only = check_consistency( ls_consist_ofer ) .
          ENDIF .

        WHEN  co_mode_punt_sol_part.
          IF    my_backend->check_activity( my_backend_activities-save_punct )    IS NOT INITIAL
             OR my_backend->check_activity( my_backend_activities-confirm_punct ) IS NOT INITIAL .
            my_read_only = check_consistency( ls_consist_sol_part ) .
          ENDIF.
** >> INI MODIF ETODR SPEC-49075
        WHEN zrm_cl_valoracio_ofertes=>co_mode_punt_quadre2b.
          IF    my_backend->check_activity( my_backend_activities-save_punct )    IS NOT INITIAL
             OR my_backend->check_activity( my_backend_activities-confirm_punct ) IS NOT INITIAL .
            my_read_only = check_consistency( ls_consist_ofer ) .
          ENDIF .
        WHEN zrm_cl_valoracio_ofertes=>co_mode_punt_quadre3b.
          IF    my_backend->check_activity( my_backend_activities-save_punct )    IS NOT INITIAL
             OR my_backend->check_activity( my_backend_activities-confirm_punct ) IS NOT INITIAL .
            my_read_only = check_consistency( ls_consist_ofer ) .
          ENDIF .
          " >>>PSPEC-1451 Inici modificació - EVXGL
        WHEN zrm_cl_valoracio_ofertes=>co_mode_val_cap_obra.
          IF    my_backend->check_activity( my_backend_activities-save_punct )    IS NOT INITIAL
             OR my_backend->check_activity( my_backend_activities-confirm_punct ) IS NOT INITIAL .
            my_read_only = check_consistency( ls_consist_ofer ) .
          ENDIF .
          " <<<PSPEC-1451 Fi modificació - EVXGL
        WHEN zrm_cl_valoracio_ofertes=>co_mode_punt_quadre4b.
* Si es vol canviar la puntuació però ens han canviat els criteris avisem que hi ha inconsistències
          IF    my_backend->check_activity( my_backend_activities-save_punct )    IS NOT INITIAL
             OR my_backend->check_activity( my_backend_activities-confirm_punct ) IS NOT INITIAL .
            my_read_only = check_consistency( ls_consist_ofer ) .
          ENDIF .
          IF     my_read_only IS INITIAL
             AND ( my_backend->check_activity( my_backend_activities-save_punct ) IS NOT INITIAL
              OR my_backend->check_activity( my_backend_activities-confirm_punct ) IS NOT INITIAL ).
            check_temeritats( ) .
          ENDIF .
** << FI MODIF ETODR SPEC-49075

*>>   Ini  SPEC-54695  - ETMAE
        WHEN zrm_cl_valoracio_ofertes=>co_mode_millor_classif. " Solvència
*     Si es vol canviar la puntuació però ens han canviat els criteris avisem que hi ha inconsistències
          IF my_backend->check_activity( my_backend_activities-save_punct )    IS NOT INITIAL OR
             my_backend->check_activity( my_backend_activities-confirm_punct ) IS NOT INITIAL .
            my_read_only = check_consistency( ls_consist_ofer ) .
          ENDIF .
          IF  my_read_only IS INITIAL  AND
            ( my_backend->check_activity( my_backend_activities-save_punct )    IS NOT INITIAL OR
              my_backend->check_activity( my_backend_activities-confirm_punct ) IS NOT INITIAL ).
            check_temeritats( ) .
          ENDIF .
*<<   Fi  SPEC-54695  - ETMAE

      ENDCASE .
    ENDIF .

    prepare_data( ) .

    create_gui_controls( im_container ) .

**>> INI MODIF ETODR SPEC-40749
    "validar si s'ha de crear el log pel mode que s'està executant
    IF my_backend->check_set_log( ) = abap_on .
      my_backend->set_if_circul_punt_iniciada( ).
      my_backend->check_first_time_log( IMPORTING e_first_time = DATA(l_first_time_log) ).
      my_backend->set_log_pt( i_first_time = l_first_time_log ).
    ENDIF.
**<< FI MODIF ETODR SPEC-40749
  ENDIF .
ENDMETHOD.


METHOD toggle_navigation_box.

  IF my_navigation_enabled EQ space .
    my_navigation_enabled = 'X' .
    show_navigation_box( ) .
  ELSE .
    CLEAR: my_navigation_enabled,
           my_navigation_grid .
    my_navigation_box->free( ) .
    CLEAR my_navigation_box .
  ENDIF .
  my_grid->set_toolbar_interactive( ) .
ENDMETHOD.


METHOD unconfirm.


  DATA: l_answer    TYPE c,
        lcx         TYPE REF TO zcx_rm_valoracio,
        l_question  TYPE text100,
        l_changed   TYPE xfeld,
        act         TYPE c VALUE ' ',
        lv_titlebar TYPE text100 . " spec-54695

  lv_titlebar = text-006. " SPEC-54695  Titulo por defecto

  CASE my_mode .

    WHEN co_mode_1_round .
      IF my_submode <> co_submode_rd817_2009.
        l_question = 'Realment desitja desbloquejar la puntuació?'(q03) .
      ELSE.
        l_question = 'Realment desitja anul·lar l''adjudicació?'(q09) .
      ENDIF.

    WHEN co_mode_punct_1st  .
      IF my_submode <> co_submode_rd817_2009.
        l_question = 'Realment desitja desbloquejar la puntuació d''ofertes?'(q07) .
      ELSE.
        l_question = 'Realment desitja desconfirmar la puntuació?'(q09) .
      ENDIF.

    WHEN co_mode_punct_2nd.
      l_question = 'Realment desitja desbloquejar la puntuació de lemes?'(q08) .

    WHEN co_mode_adj_2nd
      OR co_mode_neg_f2. "ADD P100031 - ETRCM
      l_question = 'Realment desitja anul·lar l''adjudicació?'(q09) .

    WHEN co_mode_punct_tec .
      l_question = 'Realment desitja desbloquejar la puntuació?'(q03) .

    WHEN co_mode_punt_sol_part .
      l_question = 'Realment desitja desbloquejar la sol·licitud de participants?'(q14) .
**  >> INI MODIF ETODR SPEC-49075
    WHEN  zrm_cl_valoracio_ofertes=>co_mode_punt_quadre2b.
      l_question = 'Realment desitja desbloquejar la puntuació?'(q03) .
    WHEN  zrm_cl_valoracio_ofertes=>co_mode_punt_quadre3b.
      l_question = 'Realment desitja desbloquejar la puntuació?'(q03) .
      " >>>PSPEC-1451 Inici modificació - EVXGL
    WHEN  zrm_cl_valoracio_ofertes=>co_mode_val_cap_obra.
      l_question = 'Realment desitja desbloquejar la puntuació?'(q03) .
      lv_titlebar = text-t12. " Verificació Cap d'Obra
      " <<<PSPEC-1451 Inici modificació - EVXGL
    WHEN  zrm_cl_valoracio_ofertes=>co_mode_punt_quadre4b.
      l_question = 'Realment desitja anul·lar l''adjudicació?'(q09) .
**  << FI MODIF ETODR SPEC-49075
*>> Ini  SPEC-54695  - ETMAE
    WHEN  zrm_cl_valoracio_ofertes=>co_mode_millor_classif.
      l_question = 'Realment desitja anul·lar la selecció de la millor classificada?'(Q17) .
      lv_titlebar = text-t08. " Oferta millor classificada
*<< Fi  SPEC-54695  - ETMAE

    WHEN OTHERS .
      MESSAGE 'Acció no rellevant!'(e00) TYPE 'I' DISPLAY LIKE 'E' .
      RETURN .

  ENDCASE .

  CALL FUNCTION 'POPUP_TO_CONFIRM'
    EXPORTING
      titlebar              = lv_titlebar  " spec-54695
      text_question         = l_question
      icon_button_1         = 'ICON_UNLOCKED'
      default_button        = '1'
      display_cancel_button = ' '
    IMPORTING
      answer                = l_answer.
  CHECK l_answer EQ '1' .

  TRY .
      CASE my_mode .
        WHEN co_mode_adj_2nd OR co_mode_neg_f2.
          my_backend->unconfirm_awardee( ) .
        WHEN co_mode_1_round OR co_mode_punct_1st .
          my_backend->unconfirm_offers( IMPORTING ex_punctuation_changed = l_changed ) .
          me->recalculate( ).
        WHEN co_mode_punct_tec.
          my_backend->unconfirm_tec_offers( IMPORTING ex_punctuation_changed = l_changed ) .
          me->recalculate( ).
        WHEN co_mode_punct_2nd.
          my_backend->unconfirm_lemes( ) .
          me->recalculate( ).
        WHEN co_mode_punt_sol_part .
          my_backend->unconfirm_sol_part( IMPORTING ex_punctuation_changed = l_changed  ).
          me->recalculate( ).
**  >> INI MODIF ETODR SPEC-49075
        WHEN  zrm_cl_valoracio_ofertes=>co_mode_punt_quadre2b.
          my_backend->unconfirm_tec_offers( IMPORTING ex_punctuation_changed = l_changed ) .
          me->recalculate( ).
        WHEN  zrm_cl_valoracio_ofertes=>co_mode_punt_quadre3b.
          my_backend->unconfirm_q3_offers( IMPORTING ex_punctuation_changed = l_changed ) .
          me->recalculate( ).
          " >>>PSPEC-1451 Inici modificació - EVXGL
        WHEN  zrm_cl_valoracio_ofertes=>co_mode_val_cap_obra.
          my_backend->unconfirm_q3_offers( IMPORTING ex_punctuation_changed = l_changed ) .
          me->recalculate( ).
          " <<<PSPEC-1451 Fi modificació - EVXGL
        WHEN  zrm_cl_valoracio_ofertes=>co_mode_punt_quadre4b.
          my_backend->unconfirm_offers( IMPORTING ex_punctuation_changed = l_changed ) .
          me->recalculate( ).
**  << FI MODIF ETODR SPEC-49075
*>> Ini  SPEC-54695  - ETMAE
        WHEN zrm_cl_valoracio_ofertes=>co_mode_millor_classif.
          my_backend->unconfirm_offers_best_classif(
                        IMPORTING ex_punctuation_changed = l_changed ) .
*<< Fi  SPEC-54695  - ETMAE

      ENDCASE .
      my_backend->set_save_log_pt( abap_off ). " INI MODIF ETODR SPEC-40749
      me->save( ) .
      prepare_data( ) .
    CATCH zcx_rm_valoracio INTO lcx .
      MESSAGE lcx TYPE 'I' DISPLAY LIKE 'E' .
      RETURN .
  ENDTRY .

  refresh_table_display( ) .

  IF l_changed IS NOT INITIAL .
    MESSAGE i053(zrm_valoracio) .
  ENDIF .

ENDMETHOD.


  METHOD z_editable_puntuacio.

    DATA: lcx       TYPE REF TO zcx_rm_valoracio,
          l_changed TYPE xfeld.

    TRY .
        DATA(t_crit_punt) = me->gt_crit_punt.
        READ TABLE t_crit_punt INTO DATA(ls_crit_punt) WITH KEY z_verif_cap_obra = 'X'. "Mirem si hi ha alguna oferta amb el cap d'obra marcat
        IF sy-subrc = 0.
*          my_backend->unconfirm_q3_offers( IMPORTING ex_punctuation_changed = l_changed ) .
          my_backend->set_save_log_pt( abap_off ).
          prepare_data( EXPORTING im_crit_punt = t_crit_punt ) .
        ELSE.
*        my_backend->confirm_punt_q3b( IMPORTING ex_punctuation_changed = l_changed ).
          my_backend->set_save_log_pt( abap_on ).
          prepare_data( ) .
        ENDIF.

      CATCH zcx_rm_valoracio INTO lcx .
      MESSAGE lcx TYPE 'I' DISPLAY LIKE 'E' .
        RETURN .
    ENDTRY .

    refresh_table_display( ) .

*  IF l_changed IS NOT INITIAL .
*    MESSAGE i053(zrm_valoracio) .
*  ENDIF .


  ENDMETHOD.
ENDCLASS.