class ZRM_CL_VALORACIO_OFERTES definition
  public
  create public .

*"* public components of class ZRM_CL_VALORACIO_OFERTES
*"* do not include other source files here!!!
public section.

  types:
*** >> INI ETODR SPEC-41444
    ty_t_log_pt_crit_punt TYPE STANDARD TABLE OF zrm_dt_log_pt_cr .
  types:
*** << FI ETODR SPEC-41444
*** >> INI ETODR SPEC-40749
    ty_t_log_pt TYPE STANDARD TABLE OF zrm_dt_log_pt .
  types:
    ty_t_log_pt_clas TYPE STANDARD TABLE OF zrm_dt_log_pt_cl .
  types:
    BEGIN OF ty_s_canvis_punt,
        proveidor        TYPE zrm_dt_log_pt-z_proveidor,
        nom_proveidor    TYPE string,
        z_codi_crit_punt TYPE zrm_dt_log_pt-z_codi_crit_punt,
        z_punt_ant       TYPE zrm_dt_log_pt-z_punt_anterior,
        z_punt_post      TYPE zrm_dt_log_pt-z_punt_posterior,
        z_motiu          TYPE zrm_dt_log_pt-z_motiu,
        z_codi_esm       TYPE zrm_dt_tpes_ofer-z_codi_esm,          "ETXGL SPEC-42402
        z_desc_esm       TYPE zrm_dt_tpes_ofer-z_desc_esm,          "ETXGL SPEC-42402
      END OF ty_s_canvis_punt .
  types:
    ty_t_canvis_punt TYPE STANDARD TABLE OF ty_s_canvis_punt .
  types:
*** << FI ETODR SPEC-40749
    BEGIN OF ty_s_formula_ve,
        bmax(16)            TYPE p DECIMALS 8,          "Baixa màxima
        bmax_2_dec(10)      TYPE p DECIMALS 2,          "Baixa màxima amb 2 decimals       " Insert SPEC-51378 ETXGL
        z_imp_ofertamin(16) TYPE p DECIMALS 8,          "Import mínim de l'oferta
        z_descripcio        TYPE zrm_dm_formules-z_descripcio.
        INCLUDE TYPE zrm_dm_param_ve .
      TYPES: END OF ty_s_formula_ve .
  types:
    BEGIN OF ty_s_formula_ve2,
        bmin(16)       TYPE p DECIMALS 8,               "SPEC-37697 ETRFV, Baixa mínima
        bmin_2_dec(10) TYPE p DECIMALS 2,               "Baixa mínima amb 2 decimals       " Insert SPEC-51378 ETXGL
        z_descripcio   TYPE zrm_dm_formules-z_descripcio.
        INCLUDE TYPE zrm_dm_param_ve .
      TYPES: END OF ty_s_formula_ve2 .
  types:
*** << INI ECDRB SPEC-48767
    BEGIN OF ty_s_formula_n_param.
        INCLUDE          TYPE zrm_dm_param_ve.
        TYPES: z_codi_crit_punt TYPE zrm_dt_log_pt-z_codi_crit_punt,
        z_bd(16)         TYPE p DECIMALS 8,
        z_pd(16)         TYPE p DECIMALS 8,
        z_descripcio     TYPE zrm_dm_formules-z_descripcio,
        z_txt_formula    TYPE zrm_dm_formules-z_formula.
    TYPES: END OF ty_s_formula_n_param .
  types:
                            "TYPES ty_t_formula_n_param TYPE ty_s_formula_n_param .
                            "    DATA: ty_t_formula_n_param TYPE TABLE OF ty_s_formula_n_param.
    ty_t_formula_n_param TYPE STANDARD TABLE OF ty_s_formula_n_param WITH NON-UNIQUE DEFAULT KEY .
  types:
    BEGIN OF ty_s_formula_ve_n.
    TYPES: bmax(16)                TYPE p DECIMALS 8,
           bmax_2_dec(10)          TYPE p DECIMALS 2,               "Baixa mínima amb 2 decimals       " Insert SPEC-51378 ETXGL
           bmin(16)                TYPE p DECIMALS 8,
           bmin_2_dec(10)          TYPE p DECIMALS 2,               "Baixa mínima amb 2 decimals       " Insert SPEC-51378 ETXGL
           z_imp_ofertamin(16)     TYPE p DECIMALS 8,
           z_imp_ofertamin_var(16) TYPE p DECIMALS 8,               "Import mínim considerant només tiplogies econòmiques variables SPEC-72969 ETODR
           info_formula            TYPE ty_t_formula_n_param.
    TYPES: END OF ty_s_formula_ve_n .
  types:
*** << FI ECDRB SPEC-48767
    BEGIN OF ty_s_phase,
        done           TYPE xfeld,
        can_be_undone  TYPE xfeld,
        can_be_started TYPE xfeld,
      END   OF ty_s_phase .
  types:
    BEGIN OF ty_s_consistency,
        model_has_changed TYPE xfeld, "S'ha canviat el model de criteris?
        new_criteria      TYPE xfeld, "El model de criteris té més codis de criteris?
        deleted_criteria  TYPE xfeld, "El model de criteris té menys codis de criteris
        imin_has_changed  TYPE xfeld, "El valor de IMIN de l'expedient s'ha modificat? "SPEC-55535
      END   OF ty_s_consistency .
  types:
    ty_t_punt_lema TYPE STANDARD TABLE OF zrm_dt_punt_lema
                                                           WITH NON-UNIQUE KEY z_num_lema z_codi_crit_punt .
  types TY_T_LEMA type ZRM_TT_DT_LEMES .
  types:
    BEGIN OF ty_s_proveidor,
        nom_proveidor TYPE string,
        stcd1         TYPE lfa1-stcd1,
        zute          TYPE lfa1-zute,
      END   OF ty_s_proveidor .
  types:
    BEGIN OF ty_s_ofertax.
        INCLUDE TYPE zrm_dt_ofertes       AS offer_data.
        INCLUDE TYPE ty_s_proveidor       AS vendor_data.
        TYPES:            boi(16)       TYPE p DECIMALS 8,
        boi_2_dec(10) TYPE p DECIMALS 2,                      " Insert SPEC-51378 ETXGL
        importmin(16) TYPE p DECIMALS 8,
        exclos        TYPE xfeld,
        num_variant   TYPE i,
* >> INI OVB SPEC-37724
        exclos_pt     TYPE xfeld,
* >> FIN OVB SPEC-37724
        ">> SPEC-72969, Inici Modificació - ETODR
        tip_econ_ofer TYPE zst_tip_import,
        "<< SPEC-72969, Final Modificació - ETODR
      END   OF ty_s_ofertax .
  types:
    ty_t_ofertax TYPE HASHED TABLE OF ty_s_ofertax WITH UNIQUE KEY z_num_ofer .
  types:
    BEGIN OF ty_s_punt_gen,
        z_mod_crit_punt  TYPE zrm_dm_crit_punt-z_mod_crit_punt,
        z_codi_crit_punt TYPE zrm_dm_crit_punt-z_codi_crit_punt,
        z_num_gen(20),
        z_punts          TYPE zrm_dt_punt_ofer-z_punts,
        z_punts_no_pond  TYPE zrm_dt_punt_ofer-z_punts_no_pond, "MODIF ETODR SPEC-49075
        z_num_equip      TYPE z_compta_equip, "ETLJS SPEC-47173, posición en el equipo
        z_carrec_equip   TYPE zrm_dt_punt_equi-z_carrec_equip, "ETODR SPEC-49498
        z_equip_max      TYPE zrm_dt_punt_equi-z_equip_max, "ETODR SPEC-49498
        z_exclos         TYPE zrm_dt_punt_equi-z_exclos, "ETLJS SPEC-49806
        z_pes            TYPE zrm_dt_punt_equi-z_pes,
      END   OF ty_s_punt_gen .
  types:
    ty_t_punt_gen TYPE SORTED TABLE OF ty_s_punt_gen
                                                            WITH NON-UNIQUE KEY z_num_gen z_mod_crit_punt z_codi_crit_punt .
  types:
    ty_t_punt_gen_nosorted TYPE STANDARD TABLE OF ty_s_punt_gen WITH KEY z_num_gen z_mod_crit_punt z_codi_crit_punt .             "SPEC-49075
  types:
    BEGIN OF ty_s_sum_info,
        z_ponderacio     TYPE zrm_dm_crit_punt-z_ponderacio,
        z_codi_crit_punt TYPE zrm_dm_crit_punt-z_codi_crit_punt,
        z_mod_crit_punt  TYPE zrm_dm_crit_punt-z_mod_crit_punt,
      END   OF ty_s_sum_info .
  types:
    ty_t_sum_info TYPE STANDARD TABLE OF ty_s_sum_info WITH NON-UNIQUE DEFAULT KEY .
  types:
    BEGIN OF ty_s_crit_punt.
        INCLUDE TYPE zrm_dm_crit_punt.
        TYPES: equip_max TYPE ztt_equip_max. "SPEC-49806.
    TYPES: sum_info         TYPE ty_t_sum_info,
           sum_info_quadres TYPE ty_t_sum_info, "SPEC-55448
           z_no_aplica      TYPE z_no_aplica, "INI MODIF ETODR SPEC-45341
           do_sum_dyn       TYPE xfeld, "INI MODIF ETODR SPEC-45341
           z_num_equip      TYPE z_compta_equip, " ETLJS SPEC-47173, posición en el equipo
           z_equip          TYPE flag, "SPEC-47173, Puntuación de equipo
           END OF ty_s_crit_punt .
  types:
    ty_t_crit_punt TYPE SORTED TABLE OF ty_s_crit_punt
                                                                           WITH NON-UNIQUE KEY z_mod_crit_punt z_codi_crit_punt .
  types:
**>> INI MODIF ETODR SPEC-49500
    BEGIN OF ty_s_punt_ofer_dyn_equi.
        INCLUDE TYPE zrm_dt_punt_ofer.
        TYPES: z_comptador_equip TYPE z_compta_equip,
      END OF ty_s_punt_ofer_dyn_equi .
  types:
    ty_t_punt_ofer_dyn_equi TYPE TABLE OF ty_s_punt_ofer_dyn_equi .
  types:
**<< FI MODIF ETODR SPEC-49500
    BEGIN OF ty_s_column,
        fieldname(30),
        colpos        TYPE i,
        key(20),
        header(30),
        total         TYPE z_punt_max,
        editable      TYPE xfeld,
        sort_crit1    TYPE char20,
        punt_total    TYPE zrm_dt_punt_ofer-z_punts,
        subheader(40),
        full_name     TYPE string,
        adjudicat     TYPE xfeld,
        mill_class    TYPE zrm_dt_ofertes-z_mill_class . " SPEC-54695
    TYPES: equip_max TYPE ztt_equip_max. "SPEC-49806
*             actual_pos  TYPE i, "Posició actual a l'ALV
    TYPES: END   OF ty_s_column .
  types:
    ty_t_column TYPE STANDARD TABLE OF ty_s_column WITH NON-UNIQUE KEY key .
  types:
    BEGIN OF ty_s_puntuacio_subapartats,
        z_codi_crit_punt        TYPE z_codi_crit_punt,
        z_codi_subapar_punt     TYPE z_codi_subapar_punt,
        z_codi_subapar_punt_rel TYPE z_codi_subapar_punt,
        cont_doc                TYPE n LENGTH 2,
        docclass                TYPE bapiguid,
        objectid                TYPE bapiguid,
        z_num_ofer              TYPE z_num_ofer,
        z_sec                   TYPE c LENGTH 5,
        z_punts                 TYPE z_punt_max,
        z_motivacio             TYPE REF TO zrm_cl_sapscript_texts,
        z_comentaris            TYPE REF TO zrm_cl_sapscript_texts,
***INI MOD ETJHG - SPEC-46407
        z_compta_rec            TYPE z_compta_rec,
        z_pes                   TYPE z_pes,
        z_sec_resta             TYPE c LENGTH 5,
        z_motivacio_resta       TYPE REF TO zrm_cl_sapscript_texts,
        z_comentaris_resta      TYPE REF TO zrm_cl_sapscript_texts,
        z_num_equip             TYPE z_compta_equip, " ETLJS SPEC-47173, posición en el equipo
***FIN MOD ETJHG - SPEC-46407
**>> INI MODIF ETODR SPEC-49075
        z_experiencia           TYPE zrm_dm_crit_punt-z_experiencia,
        z_punts_no_pond         TYPE zrm_dt_punt_ofer-z_punts,
        z_km_verif              TYPE z_km_verif,
        z_km_oferta	            TYPE z_km_oferta,
        z_num_ob_oferta	        TYPE z_num_ob_oferta,
        z_num_ob_tip_ok	        TYPE z_num_ob_tip_ok,
        z_num_ob_acredit_ok	    TYPE z_num_ob_acredit_ok, "SPEC-49921
**<< FI MODIF ETODR SPEC-49075
      END OF ty_s_puntuacio_subapartats .
  types:
    ty_t_puntuacio_subapartats TYPE STANDARD TABLE OF ty_s_puntuacio_subapartats .
  types:
    BEGIN OF ty_s_motiv_subapartats_mult,
        z_codi_crit_punt        TYPE z_codi_crit_punt,
        z_codi_subapar_punt     TYPE z_codi_subapar_punt,
        z_codi_subapar_punt_rel TYPE z_codi_subapar_punt,
        cont_doc                TYPE n LENGTH 2,
        docclass                TYPE bapiguid,
        objectid                TYPE bapiguid,
        z_num_ofer              TYPE z_num_ofer,
        z_sec                   TYPE c LENGTH 5,
        z_punts                 TYPE z_punt_max,
        z_motivacio             TYPE REF TO zrm_cl_sapscript_texts,
        z_comentaris            TYPE REF TO zrm_cl_sapscript_texts,
        z_compta_rec            TYPE z_compta_rec,
        z_pes                   TYPE z_pes,
        z_num_equip             TYPE z_compta_equip, " ETLJS SPEC-47173, posición en el equipo
      END OF ty_s_motiv_subapartats_mult .
  types:
    ty_t_motiv_subapartats_mult TYPE STANDARD TABLE OF ty_s_motiv_subapartats_mult .
  types:
**>> INI MODIF ETODR SPEC-49806
    BEGIN OF ty_s_carrec_punts,
        z_descripcio      TYPE z_descripcio,
        z_text_carrec     TYPE z_descripcio,
        z_carrec_equip    TYPE z_carrec_equip,
        z_comptador_equip TYPE z_compta_equip,
        z_num_ofer        TYPE z_num_ofer,
        z_punts           TYPE z_punts,
        z_pes             TYPE i,
        z_punts_pes       TYPE z_punts,
      END OF ty_s_carrec_punts .
  types:
    ty_t_carrec_punts TYPE STANDARD TABLE OF ty_s_carrec_punts .

**<< FI MODIF ETODR SPEC-49806
  constants CO_ACT_AWARDEE type I value 1 ##NO_TEXT.
  constants CO_ACT_BEST_CLASSIFIED type I value 15 ##NO_TEXT.
  constants CO_ACT_CONFIRM_CAP_OBRA type I value 16 ##NO_TEXT.
  constants CO_ACT_CONFIRM_Q3B type I value 13 ##NO_TEXT.
  constants CO_ACT_CONFIRM_1ST type I value 2 ##NO_TEXT.
  constants CO_ACT_CONFIRM_2ND type I value 3 ##NO_TEXT.
  constants CO_ACT_DISPLAY type I value 4 ##NO_TEXT.
  constants CO_ACT_PUNCT_1ST type I value 5 ##NO_TEXT.
  constants CO_ACT_PUNCT_2ND type I value 6 ##NO_TEXT.
  constants CO_ACT_UNCONFIRM_1ST type I value 7 ##NO_TEXT.
  constants CO_ACT_UNCONFIRM_CAP_OBRA type I value 14 ##NO_TEXT.
  constants CO_ACT_UNCONFIRM_Q3B type I value 14 ##NO_TEXT.
  constants CO_ACT_UNCONFIRM_2ND type I value 8 ##NO_TEXT.
  constants CO_ACT_UNCONFIRM_ADJ type I value 9 ##NO_TEXT.
  constants CO_ACT_CONFIRM_SP type I value 10 ##NO_TEXT.
  constants CO_ACT_UNCONFIRM_SP type I value 11 ##NO_TEXT.
  constants CO_ACT_PUNCT_SP type I value 12 ##NO_TEXT.
  constants CO_CODI_CRIT_TOTAL type Z_CODI_CRIT_PUNT value ' ' ##NO_TEXT.
  data SAP_ERROR type FLAG .
  constants CO_MODE_NEG_F2 type CHAR1 value 'G' ##NO_TEXT.
  constants CO_MODE_PUNCT_1ST type CHAR1 value 'B' ##NO_TEXT.
  constants CO_MODE_1_ROUND type CHAR1 value 'A' ##NO_TEXT.
  constants CO_MODE_PUNCT_TEC type CHAR1 value 'E' ##NO_TEXT.
  constants CO_MODE_PUNT_SOL_PART type CHAR1 value 'F' ##NO_TEXT.
  constants CO_MODE_VAL_CAP_OBRA type CHAR1 value 'R' ##NO_TEXT.
  constants CO_MODE_PUNT_QUADRE2B type CHAR1 value 'P' ##NO_TEXT.
  constants CO_MODE_PUNT_QUADRE3A type CHAR1 value '3' ##NO_TEXT.
  constants CO_MODE_PUNT_QUADRE3B type CHAR1 value 'O' ##NO_TEXT.
  constants CO_MODE_PUNT_QUADRE4B type CHAR1 value 'J' ##NO_TEXT.
  constants CO_MODE_PUNT_FORMULARI type CHAR1 value 'I' ##NO_TEXT.
  constants CO_MODE_MILLOR_CLASSIF type CHAR1 value 'S' ##NO_TEXT.
  constants CO_MODE_PUNT_QUADRE4B_SIM type CHAR1 value 'j' ##NO_TEXT.
  constants CO_CRIT_TECNIC type Z_TIPUS_CRIT value 'T' ##NO_TEXT.
  constants CO_CRIT_VAL_TECNIC type Z_TIPUS_CRIT value 'V' ##NO_TEXT.
  constants OFERTA_VARIANT type Z_TIPUS_OFERTA value 'V' ##NO_TEXT.
  constants CO_ADJ_CR type CHAR2 value 'CR' ##NO_TEXT.
  data Z_FIRST type FLAG .                                                        "SPEC-37724

  methods GET_CALCUL_PDM_COAUTORS_SEP
    exporting
      !ET_DADES_PDM_COAUTORS type ZRM_TT_CALCULS_PDM .
  methods TE_EQUIP_ADD
    returning
      value(R_HAS_EQUIP_ADD) type XFELD .
  methods TE_VALOR_IREF
    returning
      value(R_HAS_INCR_DONE) type XFELD .
  methods TE_VALOR_INCR
    returning
      value(R_HAS_INCR_DONE) type XFELD .
  methods CHECK_DADES_INCR
    importing
      !IV_NUM_OFER type Z_NUM_OFER
    exceptions
      NOT_IMIN .
  methods NOTIF_OFERTA_MILLOR_CLASSIFICA .
  methods SET_NEW_EQUIP
    importing
      !IT_EQUIP type ZRM_TT_DT_PUNT_EQUI .
  methods SET_PUNT_OFFER_PDM
    importing
      !IT_PUNT_OFFER type ZRM_CL_VALORACIO_OFERTES=>TY_T_PUNT_GEN .
  methods MOD_CRIT_PUNT_HAS_PDM
    returning
      value(RE_HAS_PDM) type Z_EQUIP_PDM .
  methods GET_PUNTS_GEN_EQUI
    exporting
      !ET_PUNTS_GEN_EQUI type ZRM_CL_VALORACIO_OFERTES=>TY_T_PUNT_GEN .
  methods GET_MAX_PUNTS_EQUI
    exporting
      !ET_MAX_PUNTS_EQUI type ZTT_EQUIP_MAX .
  methods SET_PUNTS_GEN_EQUI
    importing
      !IT_PUNT_GEN type ZRM_CL_VALORACIO_OFERTES=>TY_T_PUNT_GEN .
  methods SET_MAX_PUNTS_EQUI
    importing
      !IT_PUNT_MAX_EQUIP type ZTT_EQUIP_MAX .
  methods CHECK_CONF_SEQ
    returning
      value(RE_OK) type XFELD .
  methods SIM_RECALC_VAL_ECON
    exporting
      !EX_PUNT_OFER type TY_T_PUNT_GEN .
  methods GET_TE_EXCLUSIO_CLAUSULA_PLEC
    importing
      !I_NUM_OFER type Z_NUM_OFER
    exporting
      !E_EXCLUSIO type Z_EXCLOS_PLEC .
  methods SAVE_TAULES_REL_OFER .
  methods HAS_EXCLUSIO_CLAUSULA_PLEC
    exporting
      !E_CLAUSULA_PLEC type Z_CLAUSULA_EXCL
    returning
      value(R_EXCLOURE_PLEC) type Z_EXCLOURE_PLEC .
  class-methods CALL_SUMMATORY_MAX_DYN
    importing
      !IM_SUM_INFO type TY_T_SUM_INFO
      !IM_CRIT_PUNT type TY_T_CRIT_PUNT
    exporting
      !EV_PUNTMAX_POSSIBLES type Z_PUNTS .
  methods SET_TE_EXCLUSIO_PLEC_EQUIP
    importing
      !I_NUM_OFER type Z_NUM_OFER
      !I_MODIF_EQUIP type CHAR1
      !IT_EQUIP type ZTT_PUNT_EQU optional .
  methods SET_TE_EXCLUSIO_CLAUSULA_PLEC
    importing
      !I_NUM_OFER type Z_NUM_OFER .
  methods SET_TAULES_REL_OFER
    importing
      !IT_PUNT_REC type ZRM_TT_PUNT_REC
      !IT_PUNT_SEL type ZRM_TT_PUNT_SEL
      !IT_PUNT_EQUI type ZRM_TT_DT_PUNT_EQUI .
  methods UNCONFIRM_Q3_OFFERS
    exporting
      !EX_PUNCTUATION_CHANGED type XFELD
    raising
      ZCX_RM_VALORACIO .
  methods CONFIRM_PUNT_Q4B
    importing
      !IM_CRIT_PUNT type TY_T_CRIT_PUNT optional
      !IM_PUNT_OFER type TY_T_PUNT_GEN optional
      !IM_TEST type XFELD default SPACE
    exporting
      !EX_OFERTES type ZRM_TT_DT_OFERTES
      !EX_OFERTESX type TY_T_OFERTAX
      !EX_PUNCTUATION_CHANGED type XFELD
      !EX_PUNT_OFER type TY_T_PUNT_GEN
    raising
      ZCX_RM_VALORACIO .
  methods CONFIRM_MILLOR_CLAS
    importing
      !IM_CRIT_PUNT type TY_T_CRIT_PUNT optional
      !IM_PUNT_OFER type TY_T_PUNT_GEN optional
      !IM_TEST type XFELD default SPACE
    exporting
      !EX_OFERTES type ZRM_TT_DT_OFERTES
      !EX_OFERTESX type TY_T_OFERTAX
      !EX_PUNCTUATION_CHANGED type XFELD
      !EX_PUNT_OFER type TY_T_PUNT_GEN .
  methods CONFIRM_PUNT_VERIF_CAP_OBRA
    importing
      !IM_CRIT_PUNT type TY_T_CRIT_PUNT optional
      !IM_PUNT_OFER type TY_T_PUNT_GEN optional
      !IM_TEST type XFELD default SPACE
    exporting
      !EX_OFERTES type ZRM_TT_DT_OFERTES
      !EX_OFERTESX type TY_T_OFERTAX
      !EX_PUNCTUATION_CHANGED type XFELD
      !EX_PUNT_OFER type TY_T_PUNT_GEN
    raising
      ZCX_RM_VALORACIO .
  methods CONFIRM_PUNT_Q3B
    importing
      !IM_CRIT_PUNT type TY_T_CRIT_PUNT optional
      !IM_PUNT_OFER type TY_T_PUNT_GEN optional
      !IM_TEST type XFELD default SPACE
    exporting
      !EX_OFERTES type ZRM_TT_DT_OFERTES
      !EX_OFERTESX type TY_T_OFERTAX
      !EX_PUNCTUATION_CHANGED type XFELD
      !EX_PUNT_OFER type TY_T_PUNT_GEN
    raising
      ZCX_RM_VALORACIO .
  methods CONFIRM_PUNT_Q2B
    importing
      !IM_TEST type XFELD default SPACE
      !IM_CRIT_PUNT type TY_T_CRIT_PUNT optional
      !IM_PUNT_OFER type TY_T_PUNT_GEN optional
    exporting
      !EX_PUNCTUATION_CHANGED type XFELD
      !EX_PUNT_OFER type TY_T_PUNT_GEN
      !EX_OFERTESX type TY_T_OFERTAX
      !EX_OFERTES type ZRM_TT_DT_OFERTES
    raising
      ZCX_RM_VALORACIO .
  methods GET_IS_TIPUS_SIMPL
    returning
      value(R_TIP_SIMPLIFICAT) type Z_OBERT_SIMPL .
  methods GET_IS_CONVERT_PREU
    returning
      value(R_IS_OBERT_PREU) type ZRM_DT_EXP_CONT-Z_CONV_OB_PREU .
  methods GET_IS_OBERT_PREU
    returning
      value(R_IS_OBERT_PREU) type Z_OBERT_PREU .
  methods GET_PROC_ADJ
    returning
      value(R_PROC_ADJ) type ZRM_DT_EXP_CONT-Z_PROC_ADJ .
  methods GET_IS_FINISHED
    exporting
      value(E_DATE_FINISHED) type DATS
    returning
      value(RE_IS_CP_FINISHED) type XFELD .
  methods SET_MOTIVACIO_MULT
    importing
      !IT_DADES_SUBAPART type ZRM_CL_VALORACIO_OFERTES=>TY_T_PUNTUACIO_SUBAPARTATS .
  methods SET_TEMPORAL_LOG_PT .
  methods RESET_LOG_PT .
  methods SELECCIO_APARTATS_DYN_FORM .
  methods SELECCIO_APARTATS_DYN
    exceptions
      NOT_PUNT_OFER .
  methods CHECK_SET_LOG
    returning
      value(RE_LOG_PT_PERMES) type XFELD .
  methods CHECK_FIRST_TIME_LOG
    exporting
      !E_FIRST_TIME type XFELD .
  methods GET_EQUIP
    importing
      !IV_NUM_OFER type Z_NUM_OFER
      !IV_PER_EXCLOURE type XFELD optional
    exporting
      !ET_EQUIP type ZTT_PUNT_EQU .
  methods SET_CANVI_PUNT_DYN
    importing
      !I_PUNT type ANY
      !I_ROW type ANY
      !I_COLUMNS type TY_S_COLUMN
      !IS_REF type TABFIELD
      !IS_PUNTUACIO_ACT type ZRM_CL_VALORACIO_OFERTES=>TY_S_PUNTUACIO_SUBAPARTATS
      !IS_PUNTUACIO_ANT type ZRM_CL_VALORACIO_OFERTES=>TY_S_PUNTUACIO_SUBAPARTATS
      !I_TEMPORAL type XFELD default ''
    raising
      ZCX_RM_VALORACIO .
  methods SET_CANVI_PUNT
    importing
      !IR_DATA_CHANGED type ref to CL_ALV_CHANGED_DATA_PROTOCOL
      !I_DATA_CHANGED type LVC_S_MODI
      !I_PUNT type ANY
      !I_ROW type ANY
      !I_COLUMNS type TY_S_COLUMN
      !IS_REF type TABFIELD
    raising
      ZCX_RM_VALORACIO .
  methods SET_LOG_PT
    importing
      !I_FIRST_TIME type XFELD
      !IT_CANVIS_PUNT type TY_T_CANVIS_PUNT optional
      !I_SAVE_DB type XFELD default SPACE .
  methods CHECK_ACTIVITY
    importing
      !IM_ACTIVITY like CO_ACT_DISPLAY
    returning
      value(RE_ALLOWED) type XFELD .
  methods CLOSE .
  methods CONFIRM_PUNT_LEMES
    importing
      !IM_TEST type XFELD optional
    exporting
      !EX_LEMES type ZRM_TT_DT_LEMES
    raising
      ZCX_RM_VALORACIO .
  methods CONFIRM_PUNT_TEC_OFFERS
    importing
      !IM_TEST type XFELD default SPACE
      !IM_CRIT_PUNT type TY_T_CRIT_PUNT optional
      !IM_PUNT_OFER type TY_T_PUNT_GEN optional
    exporting
      !EX_PUNCTUATION_CHANGED type XFELD
      !EX_PUNT_OFER type TY_T_PUNT_GEN
      !EX_OFERTESX type TY_T_OFERTAX
      !EX_OFERTES type ZRM_TT_DT_OFERTES
    raising
      ZCX_RM_VALORACIO .
  methods CONFIRM_PUNT_OFFERS
    importing
      !IM_TEST type XFELD default SPACE
    exporting
      !EX_PUNCTUATION_CHANGED type XFELD
      !EX_PUNT_OFER type TY_T_PUNT_GEN
      !EX_OFERTESX type TY_T_OFERTAX
      !EX_OFERTES type ZRM_TT_DT_OFERTES
    raising
      ZCX_RM_VALORACIO .
  methods CONFIRM_PUNT_SOL_PART
    importing
      !IM_TEST type XFELD default SPACE
    exporting
      !EX_PUNCTUATION_CHANGED type XFELD
      !EX_PUNT_OFER type TY_T_PUNT_GEN
      !EX_OFERTESX type TY_T_OFERTAX
      !EX_OFERTES type ZRM_TT_DT_OFERTES
    raising
      ZCX_RM_VALORACIO .
  methods CONSTRUCTOR
    importing
      !IM_OBJECTID type BAPIGUID
      !IM_DOCCLASS type BAPIDCLASS
      !IM_ACTION type CHAR1
      !IS_DYNAMIC type XFELD default ''
    raising
      ZCX_RM_VALORACIO .
  methods GET_2_ROUND_PHASE
    exporting
      !EX_PUNCTUATE_OFFER type TY_S_PHASE
      !EX_PUNCTUATE_LEMA type TY_S_PHASE
      !EX_SET_AWARDEE type TY_S_PHASE
      !EX_LOGICAL_PHASE type I
      !EX_2ND_ROUND_OFFERS type I
      !EX_LEMES_COUNT type I
    raising
      ZCX_RM_VALORACIO .
  methods GET_CONSISTENCY_INFO
    exporting
      !EX_CONSISTENCY_OFFER type TY_S_CONSISTENCY
      !EX_CONSISTENCY_LEMA type TY_S_CONSISTENCY
      !EX_CONSISTENCY_SOL_PART type TY_S_CONSISTENCY
    raising
      ZCX_RM_VALORACIO .
  methods GET_CRIT_PUNT_LEMES
    importing
      !IM_ONLY_USED_ONES type XFELD
    returning
      value(RE_CRIT_PUNT) type TY_T_CRIT_PUNT
    raising
      ZCX_RM_VALORACIO .
  methods GET_CRIT_PUNT_OFFERS_EQUI
    returning
      value(RE_CRIT_PUNT) type TY_T_CRIT_PUNT .
  methods GET_CRIT_PUNT_OFFERS
    importing
      !IM_ONLY_USED_ONES type XFELD
    returning
      value(RE_CRIT_PUNT) type TY_T_CRIT_PUNT
    raising
      ZCX_RM_VALORACIO .
  methods GET_CRIT_PUNT_SOL_PART
    importing
      !IM_ONLY_USED_ONES type XFELD
    returning
      value(RE_CRIT_PUNT) type TY_T_CRIT_PUNT .
  methods GET_IS_CP_INICIADA
    returning
      value(RE_IS_CP_INICIADA) type XFELD .
  methods GET_HEADER
    returning
      value(RE_HEADER) type ZRM_DT_EXP_CONT
    raising
      ZCX_RM_VALORACIO .
  methods GET_LEMES
    returning
      value(RE_LEMES) type TY_T_LEMA
    raising
      ZCX_RM_VALORACIO .
  methods GET_OFFERS
    returning
      value(RE_OFFERS) type TY_T_OFERTAX
    raising
      ZCX_RM_VALORACIO .
  methods GET_PLEC
    returning
      value(RE_PLEC) type ZRM_DM_PLECS
    raising
      ZCX_RM_VALORACIO .
  methods GET_PUNT_LEMES
    importing
      !IM_FROM_DB type XFELD default SPACE
    returning
      value(RE_PUNC) type TY_T_PUNT_GEN
    raising
      ZCX_RM_VALORACIO .
  methods GET_PUNT_OFFERS_VAL_CAP_OBRA
    importing
      !IM_FROM_DB type XFELD default SPACE
    returning
      value(RE_PUNC) type TY_T_PUNT_GEN
    raising
      ZCX_RM_VALORACIO .
  methods GET_PUNT_OFFERS
    importing
      !IM_FROM_DB type XFELD default SPACE
    returning
      value(RE_PUNC) type TY_T_PUNT_GEN
    raising
      ZCX_RM_VALORACIO .
  methods GET_PUNT_SOL_PART
    importing
      !IM_FROM_DB type XFELD default SPACE
    returning
      value(RE_PUNC) type TY_T_PUNT_GEN .
  methods GET_SOLV_TEC_EXCLUSION
    importing
      !IM_COLUMNS type TY_T_COLUMN
    exporting
      !EX_ALL_EXCLUDED type XFELD
      !EX_OFERTES type ZRM_TT_DT_OFERTES
      !EX_OFERTESX type TY_T_OFERTAX .
  methods GET_TECHNICAL_EXCLUSION
    exporting
      !EX_ALL_EXCLUDED type XFELD
      !EX_OFERTES type ZRM_TT_DT_OFERTES
      !EX_OFERTESX type TY_T_OFERTAX
    raising
      ZCX_RM_VALORACIO .
  methods HAS_CHANGED
    returning
      value(RE_CHANGED) type XFELD .
  methods CHECK_PUNT_TEC_SEQ
    returning
      value(RE_OK) type XFELD
    raising
      ZCX_RM_VALORACIO .
  methods CHECK_SOL_PART
    returning
      value(RE_OK) type XFELD
    raising
      ZCX_RM_VALORACIO .
  methods IS_2_ROUND
    returning
      value(RE_2_ROUND) type XFELD .
  methods OBERT_PLIQ_EXPIRED
    returning
      value(RE_EXPIRED) type XFELD .
  methods LOCK
    exporting
      !EX_SUCCESS type XFELD
      !EX_LOCK_USER type SY-UNAME
      !EX_CHANGED type XFELD
    raising
      ZCX_RM_VALORACIO .
  methods RECALCULATE
    importing
      !DADES_OFER_DYN type ZRM_TT_DT_PUNT_OFER optional
    exporting
      !EX_CHANGED type XFELD
    raising
      ZCX_RM_VALORACIO .
  methods SAVE
    importing
      !NO_ACTV type ABAP_BOOL optional .
  methods SET_AWARDEE
    importing
      !IM_KEY_GEN type CHAR20
    raising
      ZCX_RM_VALORACIO .
  methods SET_BEST_CLASSIFIED
    importing
      !IM_KEY_GEN type CHAR20
    raising
      ZCX_RM_VALORACIO .
  methods SET_PUNCTUATION
    importing
      !IM_CODI_CRIT_PUNT type Z_CODI_CRIT_PUNT
      !IM_MOD_CRIT_PUNT type Z_MOD_CRIT_PUNT
      !IM_VALUE type ZRM_DT_PUNT_OFER-Z_PUNTS
      !IM_KEY_GEN type CHAR20
      !IM_DESCRIPCIO type Z_DESCRIP120 optional
    exporting
      !EM_NUM_EQUIP type Z_COMPTA_EQUIP
    raising
      ZCX_RM_VALORACIO .
  methods START
    exporting
      !EX_FIRST_TIME type XFELD
    raising
      ZCX_RM_VALORACIO .
  methods UNCONFIRM_AWARDEE
    exporting
      !EX_PUNCTUATION_CHANGED type XFELD
    raising
      ZCX_RM_VALORACIO .
  methods UNCONFIRM_LEMES
    raising
      ZCX_RM_VALORACIO .
  methods UNCONFIRM_OFFERS
    exporting
      !EX_PUNCTUATION_CHANGED type XFELD
    raising
      ZCX_RM_VALORACIO .
  methods UNCONFIRM_OFFERS_BEST_CLASSIF
    exporting
      !EX_PUNCTUATION_CHANGED type XFELD
    raising
      ZCX_RM_VALORACIO .
  methods UNCONFIRM_TEC_OFFERS
    exporting
      !EX_PUNCTUATION_CHANGED type XFELD
    raising
      ZCX_RM_VALORACIO .
  methods UNCONFIRM_SOL_PART
    exporting
      !EX_PUNCTUATION_CHANGED type XFELD
    raising
      ZCX_RM_VALORACIO .
  methods GET_RD817_2009
    returning
      value(RE_RD817_2009) type Z_RD817_2009
    raising
      ZCX_RM_VALORACIO .
  methods IS_AWARDEE
    returning
      value(RC) type ABAP_BOOL .
  methods IS_BEST_CLASSIFIED
    returning
      value(RC) type ABAP_BOOL .
  methods SET_IF_CIRCUL_PUNT_INICIADA .
  methods SET_SAVE_LOG_PT
    importing
      !I_SET_SAVE_TO_LOG type XFELD .
  methods GET_MY_CRIT_DYN
    returning
      value(R_CRIT_DYN) type XFELD .
  methods GET_PUNT_SUBAPART
    importing
      !I_SUBAPARTAT type Z_CODI_SUBAPAR_PUNT optional
    exporting
      !ET_DADES_SUBAPART type ZRM_CL_VALORACIO_OFERTES=>TY_T_PUNTUACIO_SUBAPARTATS .
  methods SET_PUNT_SUBAPART
    importing
      value(IT_DADES_SUBAPART) type ZRM_CL_VALORACIO_OFERTES=>TY_T_PUNTUACIO_SUBAPARTATS
      !LV_PUNT type Z_PUNTS optional
      !LV_MULT_REC type CHAR1 optional
      !IS_MULT_EQUIP type XFELD optional
      !IT_EQUIP_SEP type ZRM_TT_DT_PUNT_EQUI optional
      !IV_NUM_OFERTA type Z_NUM_OFER optional .
  methods SET_DADES_OFER_DYN
    importing
      !IT_PUNT_OFER_DYN type ZRM_TT_DT_PUNT_OFER
      !IT_PUNT_EQUI type ZTT_PUNT_EQUI optional .
  methods GET_DADES_OFER_DYN
    importing
      !IM_SEL_DYN type XFELD default ABAP_OFF
    exporting
      !EX_PUNT_OFER_DYN type ZRM_TT_DT_PUNT_OFER
      !EX_CRIT_PUNT type TY_T_CRIT_PUNT
      !EX_PUNT_OFER_DYN_EQUI type ZRM_TT_DT_PUNT_EQUI
      !EX_PUNT_OFER_DYN_INCR type ZTT_PUNT_INCR
      !ES_INCR type ZTT_PUNT_INCR
      !ET_CO2 type ZRM_TT_PUNT_CO2 .
  class-methods GET_PUNTUACIONS
    importing
      !IV_DOCCLASS type BAPIDCLASS
      !IV_OBJECTID type BAPIGUID
    exporting
      !ET_CRIT_PUNT type ZRM_CL_VALORACIO_OFERTES=>TY_T_CRIT_PUNT
      !ET_CRIT_DYN_REL type ZRM_CL_VALORACIO_OFERTES_FE=>TY_T_CRIT_REL
      !ET_PUNT_OFFER_NOPOND type ZRM_CL_VALORACIO_OFERTES=>TY_T_PUNT_GEN
      !ET_PUNT_OFFER_POND type ZRM_CL_VALORACIO_OFERTES=>TY_T_PUNT_GEN
      !ET_CRIT_PUNT_ALL type ZRM_CL_VALORACIO_OFERTES=>TY_T_CRIT_PUNT
    raising
      ZCX_RM_VALORACIO .
  methods GET_CRIT_DYN_REL
    exporting
      !EX_CRIT_PUNT type ZRM_CL_VALORACIO_OFERTES=>TY_T_CRIT_PUNT
      !EX_CRIT_DYN_REL type ZRM_CL_VALORACIO_OFERTES_FE=>TY_T_CRIT_REL
      !EX_CRIT_DYN_REL_FULL type ZRM_CL_VALORACIO_OFERTES_FE=>TY_T_CRIT_REL
      !ET_CRIT_PUNT_ALL type ZRM_CL_VALORACIO_OFERTES=>TY_T_CRIT_PUNT .
  methods GET_MOTIVACIO_MULTI
    exporting
      !ET_MOTIV_MULT type ZRM_CL_VALORACIO_OFERTES=>TY_T_MOTIV_SUBAPARTATS_MULT .
  methods SEND_NOTIFICACIONS
    importing
      !IM_TIPO_NOTIF type CDSTRINGVAL .
  methods GET_N_FORMULES_VE
    importing
      !IM_PLEC type ZRM_DM_PLECS
    exporting
      !E_N_FORMULES type XFELD .
  methods GET_FORMULES_VE_N
    exporting
      !EX_FORMULA_VE_N type TY_S_FORMULA_VE_N .
  class-methods RECALCULATE_PUNT_TOT_SIM
    importing
      !IM_OBJECTID type BAPIGUID
      !IM_DOCCLASS type BAPIDCLASS
    exporting
      !EX_PUNT_GEN type TY_T_PUNT_GEN
    raising
      ZCX_RM_VALORACIO .
  class-methods RECALCULATE_VAL_ECON_SIM
    importing
      !IM_OBJECTID type BAPIGUID
      !IM_DOCCLASS type BAPIDCLASS
    exporting
      !EX_PUNT_GEN type TY_T_PUNT_GEN
    raising
      ZCX_RM_VALORACIO .
  class-methods RECALCULATE_PUNT_PDM_COAUT_SIM
    importing
      !IM_OBJECTID type BAPIGUID
      !IM_DOCCLASS type BAPIDCLASS
    exporting
      !ET_DADES_PDM_COAUTORS type ZRM_TT_CALCULS_PDM
      !ET_CRIT_RELATIONS type ZRM_CL_VALORACIO_OFERTES_FE=>TY_T_CRIT_REL
      !ET_CRIT_PUNT type ZRM_CL_VALORACIO_OFERTES=>TY_T_CRIT_PUNT
    raising
      ZCX_RM_VALORACIO .
  methods GET_IS_NOVA_LLEI_92017
    returning
      value(R_IS_LCP_92017) type Z_LLEI92017 .
  methods GET_CALCUL_PDM_COAUTORS
    exporting
      !ET_DADES_PDM_COAUTORS type ZRM_TT_CALCULS_PDM .
  methods UPDATE_PUNT_CO2
    importing
      !IT_PUNT_CO2 type ZRM_TT_PUNT_CO2
      !IT_PUNTS_OFFER type ZRM_CL_VALORACIO_OFERTES=>TY_T_PUNT_GEN .
  methods GET_PUNT_INCR
    exporting
      !ET_INCR type ZTT_PUNT_INCR
      !ET_PUNTS_OFFER type ZRM_CL_VALORACIO_OFERTES=>TY_T_PUNT_GEN .
  methods SET_PUNT_INCR
    importing
      !IT_INCR type ZTT_PUNT_INCR
      !IT_PUNTS_OFFER type ZRM_CL_VALORACIO_OFERTES=>TY_T_PUNT_GEN .
  methods SET_PUNT_INCR_OBJ
    importing
      !IV_OFERTA type Z_NUM_OFER
    changing
      !IT_INCR type ZRM_TT_DT_PUNT_EQUI
      !IV_COLUMN type TY_S_COLUMN
      !IT_PUNTS_OFFER type TABLE .
  methods GET_PUNT_INCR_OBJ
    importing
      !IS_PUNTS_OFFER type ANY
      !IS_COLUMN type TY_S_COLUMN
    changing
      !CS_LINIA type ANY .
  methods UPDATE_DYN_DATA
    exceptions
      NOT_PUNT_OFER .
  methods RECALCULATE_VAL_BASAT_MARC
    importing
      !CH_CRIT_PUNT type TY_T_CRIT_PUNT
    changing
      !CH_PUNT_GEN type TY_T_PUNT_GEN
    raising
      ZCX_RM_VALORACIO .
  methods RECALCULATE_HARMONITZAT
    importing
      !IM_PROVEIDORS type TY_T_PUNT_GEN
      !IM_CRIT_PUNT type TY_T_CRIT_PUNT
    changing
      !CH_PUNT_GEN type TY_T_PUNT_GEN .
  methods SEND_WARNING_BEST_RANKED_OFFER .
protected section.
*"* protected components of class ZRM_CL_VALORACIO_OFERTES
*"* do not include other source files here!!!

  types:
    ty_t_punt_ofer TYPE SORTED TABLE OF zrm_dt_punt_ofer
       WITH NON-UNIQUE KEY z_num_ofer z_codi_crit_punt .

  data MY_EXP_CONT type ZRM_DT_EXP_CONT .
  constants CO_CRIT_ECONOMIC type Z_TIPUS_CRIT value 'X' ##NO_TEXT.
  constants CO_CRIT_PUNT_TECNIC type Z_TIPUS_CRIT value 'P' ##NO_TEXT.
  constants CO_CRIT_TERMINI type Z_TIPUS_CRIT value 'D' ##NO_TEXT.
  constants CO_VE_TYPE_A type Z_TIPUS_FORM_VE value 'A' ##NO_TEXT.
  constants CO_VE_TYPE_B type Z_TIPUS_FORM_VE value 'B' ##NO_TEXT.
  constants CO_VE_TYPE_C type Z_TIPUS_FORM_VE value 'C' ##NO_TEXT.
  constants CO_VE_TYPE_HARDCODED type Z_TIPUS_FORM_VE value ' ' ##NO_TEXT.
  data MY_CHANGED type XFELD .
  data MY_CONSISTENCY_LEMA type TY_S_CONSISTENCY .
  data MY_CONSISTENCY_OFFER type TY_S_CONSISTENCY .
  data MY_CONSISTENCY_SOL_PART type TY_S_CONSISTENCY .
  data MY_CRIT_PUNT_EQUI type TY_T_CRIT_PUNT .
  data MY_CRIT_PUNT type TY_T_CRIT_PUNT .
  data MY_CRIT_PUNT_DYN type TY_T_CRIT_PUNT .
  data MY_CRIT_PUNT_ALL type TY_T_CRIT_PUNT .
  data MY_CRIT_PUNT_PROP_GRAF type TY_T_CRIT_PUNT .
  data MY_CRIT_PUNT_SOL_PART type TY_T_CRIT_PUNT .
  data MY_DOCCLASS type BAPIDCLASS .
  data MY_EXP_CONT_DB type ZRM_DT_EXP_CONT .
  data MY_FORMULA_VE2 type TY_S_FORMULA_VE2 .
  data MY_FORMULA_VE type TY_S_FORMULA_VE .
  data MY_FORMULA_VT type ZRM_DM_FORMULES .
  data MY_LEMES type TY_T_LEMA .
  data MY_LOCKED type XFELD .
  data MY_OBJECTID type BAPIGUID .
  data MY_OB_OFERTES type ref to ZRM_CL_OFERTES .
  data MY_OFERTESX type TY_T_OFERTAX .
  data MY_OPENED type XFELD .
  data MY_PLEC type ZRM_DM_PLECS .
  data MY_PUNT_LEMA type TY_T_PUNT_GEN .
  data MY_PUNT_LEMA_DB type TY_T_PUNT_GEN .
  data MY_PUNT_OFER_VAL_CAP_OBRA type TY_T_PUNT_GEN .
  data MY_PUNT_OFER type TY_T_PUNT_GEN .
  data MY_PUNT_CO2 type ZRM_TT_PUNT_CO2 .
  data MY_INCR type ZTT_PUNT_INCR .
  data MY_PUNT_OFER_DB type TY_T_PUNT_GEN .
  data MY_PUNT_SOL_PART type TY_T_PUNT_GEN .
  data MY_PUNT_SOL_PART_DB type TY_T_PUNT_GEN .
  data MY_MODE type CHAR1 .
  data MY_MIN_SOLV_TEC type Z_MIN_SOLV_TEC .

  methods BUILD_ACTIVITY_LIST .
  class-methods CHECK_FORMULA_EXISTS
    importing
      !IM_CODI_FORM type Z_CODI_FORM
      !IM_TIPUS_FORM type Z_TIPUS_FORM
    returning
      value(RE_FORMULA) type ZRM_DM_FORMULES
    raising
      ZCX_RM_VALORACIO .
  class-methods COMPLETE_VENDOR_DATA
    importing
      !IM_LIFNR type LFA1-LIFNR
    returning
      value(RE_DATA) type TY_S_PROVEIDOR .
  class-methods CONFIRM_PUNT_OFFERS_INT_ECO
    importing
      !IM_CRIT_PUNT type TY_T_CRIT_PUNT
      !IM_PLEC type ZRM_DM_PLECS
      !IM_2_ROUND type XFELD
    exporting
      !EX_PUNCTUATION_CHANGED type XFELD
    changing
      !CH_PUNT_OFER type TY_T_PUNT_GEN
      !CH_OFERTESX type TY_T_OFERTAX .
  methods CONFIRM_PUNT_OFFERS_INT_TEC
    importing
      !IM_CRIT_PUNT type TY_T_CRIT_PUNT
      !IM_PLEC type ZRM_DM_PLECS
      !IM_2_ROUND type XFELD
    exporting
      !EX_PUNCTUATION_CHANGED type XFELD
    changing
      !CH_PUNT_OFER type TY_T_PUNT_GEN
      !CH_OFERTESX type TY_T_OFERTAX .
  class-methods CONFIRM_PUNT_OFFERS_INT_SOL
    importing
      !IM_CRIT_PUNT type TY_T_CRIT_PUNT
      !IM_PLEC type ZRM_DM_PLECS
      !IM_2_ROUND type XFELD
      !IM_MIN_SOLV_TEC type Z_MIN_SOLV_TEC
    exporting
      !EX_PUNCTUATION_CHANGED type XFELD
    changing
      !CH_PUNT_OFER type TY_T_PUNT_GEN
      !CH_OFERTESX type TY_T_OFERTAX .
  methods RECALC_PUNT_OFFERS_INT_TEC
    importing
      !IM_CRIT_PUNT type TY_T_CRIT_PUNT
      !IM_PLEC type ZRM_DM_PLECS
      !IM_2_ROUND type XFELD
    exporting
      !EX_PUNCTUATION_CHANGED type XFELD
    changing
      !CH_PUNT_OFER type TY_T_PUNT_GEN
      !CH_OFERTESX type TY_T_OFERTAX .
  methods ENQUEUE
    exporting
      !EX_SUCCESS type XFELD
      !EX_LOCK_USER type SY-UNAME .
  methods READ_AND_CHECK_CRIT_PUNT
    importing
      !IM_MOD_CRIT_PUNT type Z_MOD_CRIT_PUNT
      !IM_MODE type CHAR1 optional
    returning
      value(RE_CRIT_PUNT) type TY_T_CRIT_PUNT
    raising
      ZCX_RM_VALORACIO .
  class-methods READ_AND_CHECK_FORM_VAL_ECON
    importing
      !IM_PLEC type ZRM_DM_PLECS
    returning
      value(RE_FORMULA_VE) type TY_S_FORMULA_VE
    raising
      ZCX_RM_VALORACIO .
  class-methods READ_AND_CHECK_FORM_VAL_TERM
    importing
      !IM_PLEC type ZRM_DM_PLECS
    returning
      value(RE_FORMULA_VT) type ZRM_DM_FORMULES
    raising
      ZCX_RM_VALORACIO .
  methods READ_AND_CHECK_HEADER
    returning
      value(RE_HEADER) type ZRM_DT_EXP_CONT
    raising
      ZCX_RM_VALORACIO .
  methods READ_AND_CHECK_OFFERS
    importing
      !IM_OB_OFERTES type ref to ZRM_CL_OFERTES
      !IM_HEADER type ZRM_DT_EXP_CONT
    exporting
      !EX_OFERTESX type TY_T_OFERTAX
      !EX_BMAX type P
    raising
      ZCX_RM_VALORACIO .
  methods READ_AND_CHECK_PLEC
    importing
      !IM_HEADER type ZRM_DT_EXP_CONT
      !IM_MODE type CHAR1 optional
    exporting
      value(EX_PLEC) type ZRM_DM_PLECS
      !EX_CRIT_PUNT type TY_T_CRIT_PUNT
      !EX_CRIT_PUNT_PROP_GRAF type TY_T_CRIT_PUNT
      !EX_CRIT_PUNT_SOL_PART type TY_T_CRIT_PUNT
      !EX_FORMULA_VE type TY_S_FORMULA_VE
      !EX_FORMULA_VT type ZRM_DM_FORMULES
      !EX_MIN_SOLV_TEC type Z_MIN_SOLV_TEC
      !EX_FORMULA_VE_N type TY_S_FORMULA_VE_N
    raising
      ZCX_RM_VALORACIO .
  class-methods READ_AND_CHECK_PUNT_LEMA
    importing
      !IM_MOD_CRIT_PUNT type Z_MOD_CRIT_PUNT
      !IM_CRIT_PUNT type TY_T_CRIT_PUNT
      !IM_HEADER type ZRM_DT_EXP_CONT
      !IM_LEMA type TY_T_LEMA
    exporting
      !EX_PUNT_LEMA type TY_T_PUNT_GEN
      !EX_PUNT_LEMA_DB type TY_T_PUNT_GEN
      !EX_CONSISTENCY type TY_S_CONSISTENCY .
  methods READ_AND_CHECK_PUNT_OFER
    importing
      !IM_MOD_CRIT_PUNT type Z_MOD_CRIT_PUNT
      !IM_CRIT_PUNT type TY_T_CRIT_PUNT
      !IM_HEADER type ZRM_DT_EXP_CONT
      !IM_OFERTESX type TY_T_OFERTAX
    exporting
      !EX_PUNT_OFER type TY_T_PUNT_GEN
      !EX_PUNT_OFER_DB type TY_T_PUNT_GEN
      !EX_CONSISTENCY type TY_S_CONSISTENCY .
  methods READ_AND_CHECK_PUNT_SOL_PART
    importing
      !IM_MOD_CRIT_PUNT type Z_MOD_CRIT_PUNT
      !IM_CRIT_PUNT type TY_T_CRIT_PUNT
      !IM_HEADER type ZRM_DT_EXP_CONT
      !IM_OFERTESX type TY_T_OFERTAX
    exporting
      !EX_PUNT_OFER_SP type TY_T_PUNT_GEN
      !EX_PUNT_OFER_SP_DB type TY_T_PUNT_GEN
      !EX_CONSISTENCY type TY_S_CONSISTENCY .
  methods READ_DATA
    raising
      ZCX_RM_VALORACIO .
  methods RECALCULATE_LEMES
    exporting
      !EX_CHANGED type XFELD
    raising
      ZCX_RM_VALORACIO .
  methods RECALCULATE_OFFER
    exporting
      !EX_CHANGED type XFELD
    raising
      ZCX_RM_VALORACIO .
  methods RECALCULATE_MULT_REC
    importing
      !DADES_OFER_DYN type ZRM_TT_DT_PUNT_OFER
    exporting
      !EX_CHANGED type XFELD .
  methods RECALCULATE_SOL_PART
    exporting
      !EX_CHANGED type XFELD .
  methods SAVE_CHANGE_DOCUMENTS .
  methods DEQUEUE .
private section.
*"* private components of class ZRM_CL_VALORACIO_OFERTES
*"* do not include other source files here!!!

  data MY_PUNT_EQUI type ZRM_TT_DT_PUNT_EQUI .
  data MY_PUNT_REC type ZRM_TT_PUNT_REC .
  data MY_PUNT_SEL type ZRM_TT_PUNT_SEL .
  data MY_IS_LCP_92017 type Z_LLEI92017 .
  data MY_FORMULA_VE_N type TY_S_FORMULA_VE_N .
  data G_CP_DATE_FINISHED type DATS .
  data IS_CP_FINISHED type XFELD value abap_off ##NO_TEXT.
  data MY_SAVE_TO_LOG_PT type XFELD .
  data IS_CP_INICIADA type XFELD .
  data MY_ACTIVITY_LIST type TY_ACTIVITY_LIST .
  data MY_QUADRES type TY_S_QUADRES .
  constants CO_DATE_EXCL_PUNT_TEC type DATUM value '20090708' ##NO_TEXT.
  data MY_LOG_PT type TY_T_LOG_PT .
  data MY_NUM_CANVI type Z_NUM_CANVI .
  data MY_LOG_PT_CLAS type TY_T_LOG_PT_CLAS .
  data MY_PUNT_OFER_CALC_LOG type TY_T_PUNT_GEN .
  data MY_LOG_PT_CRIT_PUNT type TY_T_LOG_PT_CRIT_PUNT .
  data MY_CRIT_IS_DYN type XFELD value '' ##NO_TEXT.
  data GT_DADES_PUNT type ZRM_CL_VALORACIO_OFERTES=>TY_T_PUNTUACIO_SUBAPARTATS .
  data GT_PUNT_OFER_DYN type ZRM_TT_DT_PUNT_OFER .
  data GT_CRIT_DYN_REL type ZRM_CL_VALORACIO_OFERTES_FE=>TY_T_CRIT_REL .
  data GT_TEMPORAL_CANVIS_PUNT type ZRM_CL_VALORACIO_OFERTES=>TY_T_CANVIS_PUNT .
  data GT_EQUIP type ZRM_TT_DT_PUNT_EQUI .
  data GT_DADES_MOTIV_MULTIPLES type ZRM_CL_VALORACIO_OFERTES=>TY_T_MOTIV_SUBAPARTATS_MULT .
  data GT_PUNT_OFER_DYN_EQUI type TY_T_PUNT_OFER_DYN_EQUI .
  data MY_PUNT_MAX_EQUIP type ZTT_EQUIP_MAX .
  data MY_PUNT_GEN_EQUI type ZRM_CL_VALORACIO_OFERTES=>TY_T_PUNT_GEN .
  data GT_INCR type ZTT_PUNT_INCR .
  data GT_INCR_AUX type ZTT_PUNT_INCR .

  methods RECALCULATE_CRIT_PDM_COAUT_SEP
    importing
      !IM_CRIT_PUNT type TY_T_CRIT_PUNT
    exporting
      !EX_CHANGED type XFELD
    changing
      !CH_PUNT_GEN type TY_T_PUNT_GEN .
  methods SET_PUNT_CO2 .
  methods GET_CALCUL_COEFIREF
    exporting
      !ET_DADES_COEFIREF type ZTT_EQUIP_COAUTOR .
  methods RECALCULATE_CRIT_COEFIREF
    importing
      !IM_CRIT_PUNT type TY_T_CRIT_PUNT
    exporting
      !EX_CHANGED type XFELD
    changing
      !CH_PUNT_GEN type TY_T_PUNT_GEN .
  methods GET_CALCUL_COAUTORS
    exporting
      !ET_DADES_COAUTORS type ZTT_EQUIP_COAUTOR .
  methods SIM_RECALC_PUNT
    exporting
      !ET_PUNT_OFFER_NOPOND type ZRM_CL_VALORACIO_OFERTES=>TY_T_PUNT_GEN
      !ET_PUNT_OFFER_POND type ZRM_CL_VALORACIO_OFERTES=>TY_T_PUNT_GEN .
  methods RECALCULATE_FINAL_DYN
    importing
      !IM_CRIT_PUNT type TY_T_CRIT_PUNT
    exporting
      !EX_CHANGED type XFELD
    changing
      !CH_PUNT_GEN type TY_T_PUNT_GEN
    raising
      ZCX_RM_VALORACIO .
  methods RECALCULATE_CRIT_EQUIP_MAX
    importing
      !IM_CRIT_PUNT type TY_T_CRIT_PUNT
    exporting
      !EX_CHANGED type XFELD
    changing
      !CH_PUNT_GEN type TY_T_PUNT_GEN .
  methods RECALCULATE_CRIT_COAUTORS
    importing
      !IM_CRIT_PUNT type TY_T_CRIT_PUNT
    exporting
      !EX_CHANGED type XFELD
    changing
      !CH_PUNT_GEN type TY_T_PUNT_GEN .
  methods RECALCULATE_CRIT_PDM_COAUTORS
    importing
      !IM_CRIT_PUNT type TY_T_CRIT_PUNT
    exporting
      !EX_CHANGED type XFELD
    changing
      !CH_PUNT_GEN type TY_T_PUNT_GEN .
  methods RECALCULATE_CRIT_PDM
    importing
      !IM_CRIT_PUNT type TY_T_CRIT_PUNT
    exporting
      !EX_CHANGED type XFELD
    changing
      !CH_PUNT_GEN type TY_T_PUNT_GEN .
  methods SUMMATORY_EQUIP_MAX
    importing
      !IM_SUM_INFO type TY_T_SUM_INFO
      !IM_CRIT_PUNT type TY_T_CRIT_PUNT
      !IM_NUM_GEN type CHAR20
      !IM_PUNT_GEN type TY_T_PUNT_GEN
    changing
      !CH_SUM type Z_PUNTS .
  methods RECALCULATE_SI_FACTOR_MULT
    importing
      !IM_CRIT_NO_APLICA type TY_S_CRIT_PUNT
      !IM_CRIT_PUNT type TY_T_CRIT_PUNT
      !IM_CRIT_REL type ZRM_CL_VALORACIO_OFERTES_FE=>TY_T_CRIT_REL
      !IM_NUM_GEN type TY_S_PUNT_GEN-Z_NUM_GEN
    exporting
      !EX_CHANGED type XFELD
      !E_RECALCULATED type XFELD
    changing
      !CH_PUNT_GEN type TY_T_PUNT_GEN
    exceptions
      NOT_FACTOR .
  methods SET_IS_NOVA_LLEI_92017
    importing
      !I_LCP_92017 type Z_LLEI92017 .
  methods RECALCULATE_VAL_TECNIC_DYN
    importing
      !IM_CRIT_PUNT type TY_T_CRIT_PUNT
      !I_RECALCULATED type XFELD default ABAP_OFF
    exporting
      !EX_CHANGED type XFELD
    changing
      !CH_PUNT_GEN type TY_T_PUNT_GEN .
  methods RECALCULATE_VAL_TECNIC2_DYN
    importing
      !IM_CRIT_PUNT type TY_T_CRIT_PUNT
      !I_RECALCULATED type XFELD default ABAP_OFF
    exporting
      !EX_CHANGED type XFELD
    changing
      !CH_PUNT_GEN type TY_T_PUNT_GEN .
  methods SUMMATORY_CURR_DYN
    importing
      !IM_SUM_INFO type TY_T_SUM_INFO
      !IM_CRIT_PUNT type TY_T_CRIT_PUNT
      !IM_NUM_GEN type CHAR20
      !IM_PUNT_GEN type TY_T_PUNT_GEN
    changing
      !CH_SUM type Z_PUNTS .
  methods SUMMATORY_MAX_DYN
    importing
      !IM_SUM_INFO type TY_T_SUM_INFO
      !IM_CRIT_PUNT type TY_T_CRIT_PUNT
      !IM_NUM_GEN type CHAR20
      !IM_PUNT_GEN type TY_T_PUNT_GEN
    changing
      !CH_SUM type Z_PUNTS .
  methods SET_DYN_DATA_FORMULARI
    importing
      !IM_DOCCLASS type BAPIDCLASS
      !IM_OBJECTID type BAPIGUID .
  methods SET_DYN_DATA
    importing
      !IM_DOCCLASS type BAPIDCLASS
      !IM_OBJECTID type BAPIGUID
    exceptions
      NOT_PUNT_OFER .
  methods RECALCULATE_CRIT_DYN
    importing
      !IM_CRIT_PUNT type TY_T_CRIT_PUNT
    exporting
      !EX_CHANGED type XFELD
    changing
      !CH_PUNT_GEN type TY_T_PUNT_GEN .
  methods RECALCULATE_SI_NO_APLICA
    exporting
      !EX_CHANGED type XFELD
      !E_RECALCULATED type XFELD
    changing
      !CH_CRIT_PUNT type TY_T_CRIT_PUNT
      !CH_PUNT_GEN type TY_T_PUNT_GEN .
  methods RECALCULATE_SI_RESTA
    importing
      !IM_CRIT_PUNT type TY_T_CRIT_PUNT
      !I_RECALCULATED type XFELD default ABAP_OFF
    exporting
      !EX_CHANGED type XFELD
    changing
      !CH_PUNT_GEN type TY_T_PUNT_GEN .
  methods CHANGE_PUNT_OFER
    importing
      !IT_PUNT_DADES type ZRM_CL_VALORACIO_OFERTES=>TY_T_PUNTUACIO_SUBAPARTATS
    changing
      !CT_PUNT_OFER type ZRM_TT_DT_PUNT_OFER
      !CT_PUNT_EQUIP type ZRM_TT_DT_PUNT_EQUI optional .
  methods SAVE_DADES_SAPSCRIPT
    importing
      !IT_PUNT_DADES type ZRM_CL_VALORACIO_OFERTES=>TY_T_PUNTUACIO_SUBAPARTATS
      !IT_MOTIV_MULT type ZRM_CL_VALORACIO_OFERTES=>TY_T_MOTIV_SUBAPARTATS_MULT .
  methods GET_CHECK_SAVE_LOG
    returning
      value(RE_CHECK_SAVE_LOT_PT) type XFELD .
  methods SET_PUNT_OFER_CALC_LOG .
  methods SET_MOTIU_CANVI_PUNT
    changing
      !CT_CANVIS_PUNT type TY_T_CANVIS_PUNT
    exceptions
      CANCELLED .
  methods CHECK_CHANGED_FIRST_TIME
    exporting
      !EX_CHANGED type XFELD .
  methods NETEJAR_VALORS
    importing
      !IM_CRIT_PUNT type TY_T_CRIT_PUNT
    exporting
      !EX_CHANGED type XFELD
    changing
      !CH_PUNT_OFER type TY_T_PUNT_GEN .
  methods RECALCULATE_VAL_TECNIC2
    importing
      !IM_CRIT_PUNT type TY_T_CRIT_PUNT
    exporting
      !EX_CHANGED type XFELD
    changing
      !CH_PUNT_GEN type TY_T_PUNT_GEN .
  methods SAVE_PUNT_OFER_LOG .
  methods RECALCULATE_BOI_BMAX
    importing
      !IM_EXP_CONT type ZRM_DT_EXP_CONT
    changing
      !CH_OFERTESX type TY_T_OFERTAX
      !CH_BMAX type NUMERIC
    raising
      ZCX_RM_VALORACIO .
  methods RECALCULATE_OMIN
    importing
      !IM_EXP_CONT type ZRM_DT_EXP_CONT
    changing
      !CH_OFERTESX type TY_T_OFERTAX
      !CH_IMPORTMIN type NUMERIC
      !CH_IMPORTMIN_VAR type NUMERIC optional
    raising
      ZCX_RM_VALORACIO .
  methods RECALCULATE_BOI_BMIN
    importing
      !IM_EXP_CONT type ZRM_DT_EXP_CONT
    changing
      !CH_OFERTESX type TY_T_OFERTAX
      !CH_BMIN type NUMERIC
    raising
      ZCX_RM_VALORACIO .
  methods RECALCULATE_VAL_ECON
    importing
      !IM_CRIT_PUNT type TY_T_CRIT_PUNT
    exporting
      !EX_CHANGED type XFELD
    changing
      !CH_PUNT_GEN type TY_T_PUNT_GEN
    raising
      ZCX_RM_VALORACIO .
  methods RECALCULATE_VAL_TERM
    importing
      !IM_CRIT_PUNT type TY_T_CRIT_PUNT
    exporting
      !EX_CHANGED type XFELD
    changing
      !CH_PUNT_GEN type TY_T_PUNT_GEN
    raising
      ZCX_RM_VALORACIO .
  methods RECALCULATE_VAL_TECNIC
    importing
      !IM_CRIT_PUNT type TY_T_CRIT_PUNT
    exporting
      !EX_CHANGED type XFELD
    changing
      !CH_PUNT_GEN type TY_T_PUNT_GEN
    raising
      ZCX_RM_VALORACIO .
  class-methods SUMMATORY
    importing
      !IM_SUM_INFO type TY_T_SUM_INFO
      !IM_CRIT_PUNT type TY_T_CRIT_PUNT
      !IM_NUM_GEN type CHAR20
      !IM_PUNT_GEN type TY_T_PUNT_GEN
    changing
      !CH_SUM type Z_PUNTS .
  methods IS_EMPRESA_ARQUITECTE
    returning
      value(RE_EMPRESA_ARQUITECTE) type ABAP_BOOL .
  methods RECALCULATE_VAL_ECON_N
    importing
      !IM_CRIT_PUNT type TY_T_CRIT_PUNT
    exporting
      !EX_CHANGED type XFELD
    changing
      !CH_PUNT_GEN type TY_T_PUNT_GEN
    raising
      ZCX_RM_VALORACIO .
  methods READ_AND_CHECK_N_FORM_VAL_ECON
    importing
      !IM_PLEC type ZRM_DM_PLECS
      !IM_CRIT_PUNT type TY_T_CRIT_PUNT
    returning
      value(RE_FORMULA_VE_N) type TY_S_FORMULA_VE_N
    raising
      ZCX_RM_VALORACIO .
ENDCLASS.



CLASS ZRM_CL_VALORACIO_OFERTES IMPLEMENTATION.


METHOD build_activity_list.

  DATA: l_1st_phase TYPE ty_s_phase,
        l_2nd_phase TYPE ty_s_phase,
        l_adj_phase TYPE ty_s_phase.

  REFRESH my_activity_list .

  CHECK: my_locked           IS NOT INITIAL,
         my_exp_cont-z_estat NE 'ZCA',
         my_exp_cont-z_estat NE 'ZTA'.

*-- Licitacions dues voltes ----------------------------------------------------------
  IF  is_2_round( ) IS NOT INITIAL .
    CALL METHOD get_2_round_phase
      IMPORTING
        ex_punctuate_offer = l_1st_phase
        ex_punctuate_lema  = l_2nd_phase
        ex_set_awardee     = l_adj_phase.

    INSERT: co_act_display INTO TABLE my_activity_list .

    IF      my_exp_cont-z_adjudicatari  IS NOT INITIAL .
      l_adj_phase-done = 'X' .
      l_2nd_phase-done = 'X' .
      l_1st_phase-done = 'X' .
    ELSEIF  my_exp_cont-z_v2_conf_dades IS NOT INITIAL .
      l_2nd_phase-done = 'X' .
      l_1st_phase-done = 'X' .
    ELSEIF  my_exp_cont-z_vo_conf_dades IS NOT INITIAL .
      l_1st_phase-done = 'X' .
    ENDIF .

    IF my_mode = co_mode_neg_f2."P100031  ETRCM
      INSERT: co_act_punct_1st     INTO TABLE my_activity_list.
      "ETKAN INICIO P100031 28/04/2016
      INSERT co_act_confirm_1st INTO TABLE my_activity_list.
      IF my_exp_cont-z_adjudicatari IS INITIAL. "SPEC-40705
        INSERT co_act_awardee     INTO TABLE my_activity_list.
        me->recalculate( ).


        TRY.
            me->confirm_punt_offers( IMPORTING ex_punctuation_changed = DATA(l_changed) ) .
          CATCH zcx_rm_valoracio .
            MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
            WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
        ENDTRY.



      ENDIF.
      me->save( 'X' ).
      "FIN ETKAN P100031 28/04/2016
    ENDIF.

* Només es pot anul·lar la confirmació de nivell més alt
    IF my_mode = co_mode_punct_tec.
      IF     my_exp_cont-z_pt_conf_dades IS INITIAL.
        INSERT: co_act_punct_1st     INTO TABLE my_activity_list,
                co_act_confirm_1st   INTO TABLE my_activity_list.
      ELSEIF my_exp_cont-z_vo_conf_dades IS INITIAL.
        INSERT: co_act_unconfirm_1st INTO TABLE my_activity_list.
      ENDIF .

    ELSE.

      IF     l_adj_phase-can_be_undone IS NOT INITIAL .
        INSERT: co_act_unconfirm_adj INTO TABLE my_activity_list.
      ELSEIF l_2nd_phase-can_be_undone IS NOT INITIAL .
        INSERT: co_act_unconfirm_2nd INTO TABLE my_activity_list .
      ELSEIF l_1st_phase-can_be_undone IS NOT INITIAL .
        INSERT: co_act_unconfirm_1st INTO TABLE my_activity_list .
      ENDIF .

* Només es pot fer la puntuació i confirmació del nivell més baix
      IF       l_1st_phase-can_be_started IS NOT INITIAL .
        INSERT: co_act_punct_1st     INTO TABLE my_activity_list,
                co_act_confirm_1st   INTO TABLE my_activity_list .
        IF my_exp_cont-z_proc_adj = 'NF' AND my_exp_cont-z_negociacio = 'X'. "P100031
          IF my_exp_cont-z_req_homog IS INITIAL.
            LOOP AT my_ofertesx TRANSPORTING NO FIELDS
              WHERE exclos IS INITIAL AND exclos_pt IS INITIAL AND z_import_oferta IS  INITIAL.
              DELETE my_activity_list WHERE table_line = co_act_confirm_1st. EXIT.
            ENDLOOP.
          ELSE.

            LOOP AT my_ofertesx TRANSPORTING NO FIELDS
              WHERE exclos IS INITIAL AND exclos_pt IS INITIAL AND z_import_homog IS NOT INITIAL.
              DELETE my_activity_list WHERE table_line = co_act_confirm_1st. EXIT.
            ENDLOOP.
          ENDIF.


        ENDIF.
      ELSEIF   l_2nd_phase-can_be_started IS NOT INITIAL .
        INSERT: co_act_punct_2nd     INTO TABLE my_activity_list,
                co_act_confirm_2nd   INTO TABLE my_activity_list.
      ELSEIF   l_adj_phase-can_be_started IS NOT INITIAL.
        INSERT: co_act_awardee INTO TABLE my_activity_list.
      ENDIF .
    ENDIF.

  ELSE .
*-- Licitacions una volta ------------------------------------------------------------
    INSERT: co_act_display INTO TABLE my_activity_list .

* Mentre no s'hagi confirmat la puntuació i no s'hagi adjudicat es pot puntuar i confirmar
    IF my_mode = co_mode_punct_tec OR
       my_mode = co_mode_punt_quadre2b. "ETODR SPEC-49075 "Confirmacions de les puntuacions tècniques de criteris tècnics sujectes a judici de valor.
      IF     my_exp_cont-z_pt_conf_dades IS INITIAL.
        INSERT: co_act_punct_1st     INTO TABLE my_activity_list,
                co_act_confirm_1st   INTO TABLE my_activity_list.
      ELSEIF my_exp_cont-z_vo_conf_dades IS INITIAL.
        INSERT: co_act_unconfirm_1st INTO TABLE my_activity_list.
      ENDIF .
**  >> INI MODIF ETODR SPEC-49075
    ELSEIF my_mode = co_mode_punt_quadre3b. "Confirmacions de les puntuacions tècniques de criteris tècnics objectius
      IF     my_exp_cont-z_q3_conf_dades IS INITIAL.
        INSERT: co_act_punct_1st     INTO TABLE my_activity_list,
                co_act_confirm_q3b   INTO TABLE my_activity_list.
      ELSEIF my_exp_cont-z_q3_conf_dades IS NOT INITIAL.
        ">>>SPEC-55535, Inici modificació  - ETODR
        IF my_exp_cont-z_vo_conf_dades IS INITIAL.
          "<<<SPEC-55535, Final modificació - ETODR
          INSERT: co_act_unconfirm_q3b INTO TABLE my_activity_list.
        ENDIF.
      ENDIF .
      " >>>PSPEC-1451 Inici modificació - EVXGL
    ELSEIF my_mode = co_mode_val_cap_obra. "Confirmacions de les puntuacions tècniques de Verificació Cap d'Obra
      IF   my_exp_cont-z_q3_conf_dades IS INITIAL.
        INSERT: co_act_punct_1st     INTO TABLE my_activity_list,
                co_act_confirm_cap_obra  INTO TABLE my_activity_list.
      ELSEIF my_exp_cont-z_q3_conf_dades IS NOT INITIAL.
        IF my_exp_cont-z_vo_conf_dades IS INITIAL.
          INSERT: co_act_unconfirm_cap_obra INTO TABLE my_activity_list.
        ENDIF.
      ENDIF .
      " <<<PSPEC-1451 Fi modificació - EVXGL
    ELSEIF my_mode = co_mode_punt_quadre4b.
      IF  my_exp_cont-z_vo_conf_dades IS INITIAL
         AND my_exp_cont-z_adjudicatari  IS INITIAL .
        INSERT: co_act_punct_1st     INTO TABLE my_activity_list,
                co_act_confirm_1st   INTO TABLE my_activity_list.
      ELSE.
        INSERT: co_act_unconfirm_1st INTO TABLE my_activity_list.
        IF my_exp_cont-z_adjudicatari IS INITIAL .
          INSERT co_act_awardee    INTO TABLE my_activity_list.
        ENDIF .
      ENDIF .
**  << FI MODIF ETODR SPEC-49075
****  >>>SPEC-54695, Inici modificació  - ETODR
    ELSEIF my_mode = co_mode_millor_classif.
      "Si ja s'ha confirmat la graella i hi ha adjudicatari, no es pot fer canvis
      "només es pot seleccionar el millor classificat
      IF    my_exp_cont-z_vo_conf_dades IS NOT INITIAL.
        IF my_exp_cont-z_conf_mill_class  IS NOT INITIAL.
          INSERT: co_act_unconfirm_1st   INTO  TABLE my_activity_list.
          READ TABLE my_ofertesx TRANSPORTING NO FIELDS WITH KEY z_mill_class = abap_on.
          IF sy-subrc <> 0.
            INSERT co_act_best_classified	INTO TABLE my_activity_list.
          ENDIF.
        ELSE.
          INSERT: co_act_confirm_1st INTO  TABLE my_activity_list,
                  co_act_punct_1st   INTO TABLE my_activity_list.
        ENDIF.
      ELSE.
        "només es pot confirmar i sel·leccionar la solvència si s'ha confirmat el Q3
        IF my_exp_cont-z_q3_conf_dades IS NOT INITIAL.
          IF my_exp_cont-z_conf_mill_class  IS NOT INITIAL.
            INSERT: co_act_unconfirm_1st   INTO  TABLE my_activity_list.
            READ TABLE my_ofertesx TRANSPORTING NO FIELDS WITH KEY z_mill_class = abap_on.
            IF sy-subrc <> 0.
              INSERT co_act_best_classified	INTO TABLE my_activity_list.
            ENDIF.
            "SPEC-70167 - S'afegeix el co_act_punct_1st, perquè més endavant
            "s'executi el mètode recalculate_offer
            INSERT: co_act_punct_1st   INTO TABLE my_activity_list.
          ELSE.
            INSERT: co_act_confirm_1st INTO  TABLE my_activity_list,
                    co_act_punct_1st   INTO TABLE my_activity_list.
          ENDIF.
        ENDIF.
      ENDIF.
****  <<<SPEC-54695, Final modificació - ETODR
    ELSEIF my_mode = co_mode_punt_sol_part.
      IF     my_exp_cont-z_sp_conf_dades IS INITIAL.
        INSERT: co_act_punct_sp     INTO TABLE my_activity_list,
                co_act_confirm_sp   INTO TABLE my_activity_list.
      ELSE.
        IF my_exp_cont-z_rd817_2009 = 'X'.
          IF my_exp_cont-z_pt_conf_dades IS INITIAL.
            INSERT: co_act_unconfirm_sp INTO TABLE my_activity_list.
          ENDIF  .
        ELSE.
          IF my_exp_cont-z_vo_conf_dades IS INITIAL.
            INSERT: co_act_unconfirm_sp INTO TABLE my_activity_list.
          ENDIF.
        ENDIF.
      ENDIF.
    ELSE.
      IF  my_exp_cont-z_vo_conf_dades IS INITIAL
         AND my_exp_cont-z_adjudicatari  IS INITIAL .
        INSERT: co_act_punct_1st     INTO TABLE my_activity_list,
                co_act_confirm_1st   INTO TABLE my_activity_list.
      ELSE.
        INSERT: co_act_unconfirm_1st INTO TABLE my_activity_list.
        IF my_exp_cont-z_adjudicatari IS INITIAL .
          INSERT co_act_awardee    INTO TABLE my_activity_list.
        ENDIF .
      ENDIF .
    ENDIF.

  ENDIF .

ENDMETHOD.


  METHOD call_summatory_max_dyn.

    FIELD-SYMBOLS: <ls_sum_info>   LIKE LINE OF im_sum_info,
                   <ls_crit_ahead> LIKE LINE OF im_crit_punt.
    DATA: lv_punts            TYPE z_punt_max,
          lv_codi_equip       TYPE z_codi_crit_punt,
          lv_punts_subcriteri TYPE zrm_dm_crit_punt-z_punt_max.

    CLEAR: ev_puntmax_possibles.

    LOOP AT im_sum_info ASSIGNING <ls_sum_info> .
      READ TABLE im_crit_punt ASSIGNING <ls_crit_ahead>
         WITH TABLE KEY z_mod_crit_punt  = <ls_sum_info>-z_mod_crit_punt
                        z_codi_crit_punt = <ls_sum_info>-z_codi_crit_punt.
      CHECK sy-subrc EQ 0.
      CHECK <ls_crit_ahead>-z_no_aplica IS INITIAL.

      DESCRIBE TABLE <ls_crit_ahead>-sum_info LINES DATA(lv_lines_sumatori).
      IF lv_lines_sumatori > 0.
        CLEAR: lv_punts_subcriteri.
        LOOP AT <ls_crit_ahead>-sum_info ASSIGNING FIELD-SYMBOL(<fs_criteris_sum>).
          READ TABLE im_crit_punt ASSIGNING FIELD-SYMBOL(<fs_check2_subcriteri>) WITH KEY z_codi_crit_punt = <fs_criteris_sum>-z_codi_crit_punt.
          IF sy-subrc = 0.
            IF <ls_crit_ahead>-z_mult_equip = abap_on.
              IF lv_codi_equip IS INITIAL OR lv_codi_equip <> <ls_crit_ahead>-z_codi_crit_punt.
                lv_codi_equip = <ls_crit_ahead>-z_codi_crit_punt.
                "Si es l'equip, agafem la puntuació total de l'equip, però només el comptem 1 vegada, no per cada subcriteri
                lv_punts_subcriteri = <ls_crit_ahead>-z_punt_max.
              ELSE.
                CONTINUE.
              ENDIF.
            ELSE.
              IF <fs_check2_subcriteri>-z_no_factor_mult = abap_true.
                "Si té aquest flag marcat vol dir que si algun dels seus subcriteris no aplica
                "el total seu no es veu ponderat, per tant passa a ser menys
                LOOP AT im_crit_punt ASSIGNING FIELD-SYMBOL(<fs_subcriteri>) WHERE z_codi_crit_punt = <fs_criteris_sum>-z_codi_crit_punt
                                                                               AND z_no_aplica      = abap_off
                                                                               AND z_no_factor_mult = abap_true.
                  lv_punts_subcriteri = <fs_subcriteri>-z_punt_max + lv_punts_subcriteri.
                ENDLOOP.
              ELSE.
                "INICI - SPEC-93599 - EVMRG - Es verifica que el subcriteri no aplica.
                READ TABLE im_crit_punt TRANSPORTING NO FIELDS WITH KEY z_codi_crit_punt = <fs_criteris_sum>-z_codi_crit_punt
                                                                        z_no_aplica      = abap_off.
                IF sy-subrc = 0.
                  lv_punts_subcriteri = <fs_check2_subcriteri>-z_punt_max + lv_punts_subcriteri.
                ENDIF.
                "FI - SPEC-93599 - EVMRG
              ENDIF.
            ENDIF.
          ENDIF.
        ENDLOOP.
        IF lv_punts_subcriteri <= <ls_crit_ahead>-z_punt_max.
          lv_punts = lv_punts_subcriteri + lv_punts.
        ELSE.
          lv_punts = <ls_crit_ahead>-z_punt_max + lv_punts.
        ENDIF.
      ELSE.
        lv_punts = <ls_crit_ahead>-z_punt_max + lv_punts.
      ENDIF.

    ENDLOOP .
    ev_puntmax_possibles = lv_punts .
*    summatory_max_dyn( EXPORTING im_sum_info  = im_sum_info
*                                 im_crit_punt = im_crit_punt
*                                 im_num_gen   = im_num_gen
*                                 im_punt_gen  = im_punt_gen
*                       CHANGING  ch_sum       = ch_sum ).
  ENDMETHOD.


  METHOD change_punt_ofer.
    SELECT * INTO TABLE @DATA(lt_crit_punt)
       FROM zrm_dm_crit_punt
       WHERE z_mod_crit_punt EQ @my_plec-z_mod_crit_punt .

    LOOP AT ct_punt_ofer ASSIGNING FIELD-SYMBOL(<fs_punt_ofer>).
      READ TABLE gt_punt_ofer_dyn ASSIGNING FIELD-SYMBOL(<fs_puntofer_dyn>) WITH KEY z_num_ofer       = <fs_punt_ofer>-z_num_ofer
                                                                                     z_mod_crit_punt  = <fs_punt_ofer>-z_mod_crit_punt
                                                                                     z_codi_crit_punt = <fs_punt_ofer>-z_codi_crit_punt.
      CHECK sy-subrc = 0.
      READ TABLE lt_crit_punt ASSIGNING FIELD-SYMBOL(<fs_crit_punt>) WITH KEY z_codi_crit_punt = <fs_punt_ofer>-z_codi_crit_punt.
      CHECK sy-subrc = 0.
      <fs_punt_ofer>-z_no_aplica         = <fs_puntofer_dyn>-z_no_aplica.
      <fs_punt_ofer>-z_resta             = <fs_crit_punt>-z_resta.
      <fs_punt_ofer>-z_codi_subapar_punt = <fs_puntofer_dyn>-z_codi_subapar_punt.
      <fs_punt_ofer>-z_sec               = <fs_puntofer_dyn>-z_sec.
      <fs_punt_ofer>-z_sec_resta         = <fs_puntofer_dyn>-z_sec_resta.
**    >> INI MODIF ETODR SPEC-49075
*      <fs_punt_ofer>-z_punts_no_pond     = <fs_puntofer_dyn>-z_punts_no_pond. " ETLJS SPEC-51880 20.12.2018 12:13:12
**    << FI MODIF ETODR SPEC-49075

      "A it_punt_dades tenim les dades puntuades en l'execució actual
      READ TABLE it_punt_dades ASSIGNING FIELD-SYMBOL(<fs_punt_dades_dyn>) WITH KEY z_codi_crit_punt    = <fs_punt_ofer>-z_codi_crit_punt
                                                                                    z_num_ofer          = <fs_punt_ofer>-z_num_ofer.
      IF  sy-subrc = 0.
        IF <fs_punt_ofer>-z_sec IS INITIAL.
          <fs_punt_ofer>-z_sec               = <fs_punt_dades_dyn>-z_sec.
        ENDIF.
        IF <fs_punt_ofer>-z_sec_resta IS INITIAL.
          <fs_punt_ofer>-z_sec_resta         = <fs_punt_dades_dyn>-z_sec_resta.
        ENDIF.
      ENDIF.
***INI MOD ETJHG - SPEC-46407
*      READ TABLE it_punt_dades ASSIGNING FIELD-SYMBOL(<fs_punt_dades>) WITH KEY z_codi_crit_punt    = <fs_punt_ofer>-z_codi_crit_punt
*                                                                                z_num_ofer          = <fs_punt_ofer>-z_num_ofer
*                                                                                z_codi_subapar_punt = <fs_punt_ofer>-z_codi_subapar_punt.

      "Actualizamos la puntuación de la tabla CT_PUNT_OFER con la puntuación de la tabla my_punt_ofer
      READ TABLE my_punt_ofer ASSIGNING FIELD-SYMBOL(<fs_punt_dades>) WITH KEY z_codi_crit_punt    = <fs_punt_ofer>-z_codi_crit_punt
                                                                               z_num_gen           = <fs_punt_ofer>-z_num_ofer.

      CHECK sy-subrc = 0.
      <fs_punt_ofer>-z_punts = <fs_punt_dades>-z_punts.
*******FIN MOD ETJHG - SPEC-46407
      "INI ECDRB SPEC-69341
      "si mod_crit_punt-Z_FORM_BRCTJV = 'X' omplir el camp ZRM_DT_PUNT_OFER-z_barem_punt_tec amb el valor
      "de base de dades.
      "és fa així aquí per no modificar la estructura de la taula interna
      "(per no afegir el camp nou z_barem_punt_tec)

      READ TABLE lt_crit_punt ASSIGNING <fs_crit_punt> WITH KEY z_codi_crit_punt = <fs_punt_ofer>-z_codi_crit_punt.
      IF <fs_crit_punt>-z_form_brctjv = 'X'.

        SELECT SINGLE z_barem_punt_tec INTO <fs_punt_ofer>-z_barem_punt_tec
          FROM zrm_dt_punt_ofer
          WHERE docclass = <fs_punt_ofer>-docclass AND
          objectid = <fs_punt_ofer>-objectid AND
          z_num_ofer = <fs_punt_ofer>-z_num_ofer AND
          z_mod_crit_punt = <fs_punt_ofer>-z_mod_crit_punt AND
          z_codi_crit_punt = <fs_punt_ofer>-z_codi_crit_punt .
*
      ENDIF.
      "FI ECDRB SPEC-69341
    ENDLOOP.

    LOOP AT ct_punt_equip ASSIGNING FIELD-SYMBOL(<fs_equip>).
**    >> INI MODIF ETODR SPEC-49500
*      READ TABLE gt_punt_ofer_dyn ASSIGNING <fs_puntofer_dyn> WITH KEY z_num_ofer       = <fs_equip>-z_num_ofer
      READ TABLE gt_punt_ofer_dyn_equi ASSIGNING FIELD-SYMBOL(<fs_puntofer_dyn_equi>) WITH KEY z_num_ofer       = <fs_equip>-z_num_ofer
**    << FI MODIF ETODR SPEC-49500
                                                                                               z_mod_crit_punt  = <fs_equip>-z_mod_crit_punt
                                                                                               z_codi_crit_punt = <fs_equip>-z_codi_crit_punt.
      CHECK sy-subrc = 0.
      READ TABLE lt_crit_punt ASSIGNING <fs_crit_punt> WITH KEY z_codi_crit_punt = <fs_equip>-z_codi_crit_punt
                                                                 .
      CHECK sy-subrc = 0.
      <fs_equip>-z_punt_max          = <fs_crit_punt>-z_punt_max.

      "Actualizamos la puntuación de la tabla CT_PUNT_OFER con la puntuación de la tabla my_punt_ofer
      READ TABLE my_punt_ofer ASSIGNING <fs_punt_dades> WITH KEY z_codi_crit_punt    = <fs_equip>-z_codi_crit_punt
                                                                 z_num_gen           = <fs_equip>-z_num_ofer
                                                                 z_num_equip         = <fs_equip>-z_comptador_equip.

      CHECK sy-subrc = 0.
      <fs_equip>-z_punts = <fs_punt_dades>-z_punts.
    ENDLOOP.
*    IF sy-subrc = 0.
*      my_changed = abap_on.
*    ENDIF.
  ENDMETHOD.


METHOD check_activity.
  CLEAR re_allowed .
  CHECK my_locked IS NOT INITIAL .
  READ TABLE my_activity_list TRANSPORTING NO FIELDS
       WITH TABLE KEY table_line = im_activity .
  IF sy-subrc EQ 0 .
    re_allowed = 'X' .
  ENDIF .

*  IF sy-uname = 'ETLJS'.
*    re_allowed = abap_true.
*  ENDIF.
ENDMETHOD.


  METHOD check_changed_first_time.
    IF my_punt_ofer_db IS INITIAL AND my_punt_ofer IS NOT INITIAL.
      ex_changed = my_changed = 'X'.
    ENDIF.
  ENDMETHOD.


  METHOD check_conf_seq.
    re_ok = abap_off.
    CASE my_mode.
      WHEN co_mode_punt_quadre4b.
        IF my_exp_cont_db-z_pt_conf_dades IS INITIAL
*** INI SPEC-51062
          AND my_exp_cont_db-z_obert_simpl IS INITIAL
*** JGG SPEC-64927 -->
          AND my_exp_cont_db-z_proc_adj NE 'CE'
*** JGG SPEC-64927 <--
          AND my_exp_cont_db-z_proc_adj NE 'NB'."INI ETOVB SPEC-73390
*** FIN SPEC-51062
          re_ok = abap_off.
          EXIT.
        ENDIF.
        IF my_exp_cont_db-z_q3_conf_dades IS INITIAL
*** JGG SPEC-64927 -->
          AND my_exp_cont_db-z_proc_adj NE 'CE'
*** JGG SPEC-64927 <--
          AND my_exp_cont_db-z_proc_adj NE 'NB'."INI ETOVB SPEC-73390
          re_ok = abap_off.
          EXIT.
        ENDIF.
        re_ok = abap_on.
      WHEN co_mode_punt_quadre3b.
        IF my_exp_cont_db-z_pt_conf_dades IS INITIAL
*** INI SPEC-51062
          AND my_exp_cont_db-z_obert_simpl IS INITIAL
          AND my_exp_cont_db-z_proc_adj NE 'CE'
          AND my_exp_cont_db-z_proc_adj NE 'NB'."INI ETOVB SPEC-73390

*** FIN SPEC-51062
          re_ok = abap_off.
          EXIT.
        ENDIF.
        re_ok = abap_on.
      WHEN OTHERS.
        re_ok = abap_on.
        EXIT.
    ENDCASE.
  ENDMETHOD.


  METHOD check_dades_incr.
    IF my_exp_cont_db-z_imin IS INITIAL.
      RAISE not_imin.
    ENDIF.

    LOOP AT gt_incr ASSIGNING FIELD-SYMBOL(<fs_incr>) WHERE z_num_ofer = iv_num_ofer.
      IF <fs_incr>-z_imin <> my_exp_cont_db-z_imin.
        <fs_incr>-z_imin = my_exp_cont_db-z_imin.
      ENDIF.
    ENDLOOP.

    IF my_incr[] IS INITIAL.
      my_incr[] = gt_incr[].
    ENDIF.
  ENDMETHOD.


  METHOD check_first_time_log.

    SELECT COUNT(*),MAX( z_num_canvi )
      FROM zrm_dt_log_pt
      INTO (@DATA(l_dbcnt),@my_num_canvi)
      WHERE z_codi_exp  = @my_exp_cont-z_codi_exp.
    IF sy-subrc <> 0 OR l_dbcnt = 0.
      CLEAR: my_num_canvi.
      e_first_time = abap_on.
    ELSE.
      ADD 1 TO my_num_canvi.
    ENDIF.

    set_punt_ofer_calc_log( ).
  ENDMETHOD.


METHOD check_formula_exists.
  DATA: l_dummy TYPE xfeld .                                "#EC NEEDED

* Existeix la fórmula?
  SELECT SINGLE *
           INTO re_formula
           FROM zrm_dm_formules
          WHERE     z_codi_form  EQ im_codi_form
                AND z_tipus_form EQ im_tipus_form .
  IF sy-subrc NE 0 .
    CASE im_tipus_form .
      WHEN 'TE' .   MESSAGE e006 WITH im_codi_form INTO l_dummy .
      WHEN 'VE' .   MESSAGE e029 WITH im_codi_form INTO l_dummy .
      WHEN 'AP' .   MESSAGE e032 WITH im_codi_form INTO l_dummy .
      WHEN 'RP' .   MESSAGE e030 WITH im_codi_form INTO l_dummy .
      WHEN 'VT' .   MESSAGE e031 WITH im_codi_form INTO l_dummy .
      WHEN OTHERS . MESSAGE e033 WITH im_codi_form im_tipus_form INTO l_dummy .
    ENDCASE .
    zcx_rm_valoracio=>raise_from_message( ) .
  ENDIF .
ENDMETHOD.


METHOD check_punt_tec_seq.

  CLEAR re_ok .
  IF my_exp_cont-z_vo_conf_dades IS INITIAL .
    re_ok = 'X' .
  ENDIF .

  IF my_exp_cont-z_proc_adj EQ co_adj_cr.
    IF my_exp_cont-z_sp_conf_dades IS INITIAL .
      RAISE EXCEPTION TYPE zcx_rm_valoracio
          EXPORTING
            textid = zcx_rm_valoracio=>not_confirmed_sol_part .
    ENDIF.
  ENDIF.
ENDMETHOD.


  METHOD check_set_log.
    DATA: lt_abap_callstack TYPE abap_callstack.

    re_log_pt_permes = abap_off.

    "Es recupera el nom del mètode per tal de comprovar si el mode d'accés està parametritzat i, per tant, no està permès el guardat de logs
    CALL FUNCTION 'SYSTEM_CALLSTACK'
      IMPORTING
        callstack = lt_abap_callstack.
    READ TABLE lt_abap_callstack INTO DATA(wa_callstack) WITH KEY mainprogram   = sy-repid
                                                                  blocktype     = 'METHOD'.
    CHECK sy-subrc = 0.
    DATA(l_method_name) = CONV string( wa_callstack-blockname ).

    SELECT COUNT(*)
      FROM zsap_dt_param_hc
      WHERE repid      = l_method_name
        AND field_info = 'NEW_LOG_PT'
        AND value      = my_mode.
    "Si el mode està a la taula és que no està permés realitzar el guardat del log de puntuacions tècniques
    IF sy-subrc <> 0.
      re_log_pt_permes = abap_on.
    ENDIF.
**  >> INI MODIF ETODR SPEC-49075
    IF get_is_nova_llei_92017( ) = abap_on AND get_is_obert_preu( ) = abap_off.
      "El log de canvis per circular als nous plecs de la LCP 9/2017 només es té en compte al Q2B
      IF my_mode EQ co_mode_punt_quadre3b OR my_mode EQ co_mode_punt_quadre4b.
        re_log_pt_permes = abap_off.
      ENDIF.
    ENDIF.
**  << FI MODIF ETODR SPEC-49075
  ENDMETHOD.


method CHECK_SOL_PART.
  CLEAR re_ok .
  IF my_exp_cont-z_pt_conf_dades IS INITIAL .
    re_ok = 'X' .
  ENDIF .
endmethod.


METHOD close.
  me->dequeue( ) .
ENDMETHOD.


METHOD COMPLETE_VENDOR_DATA.
  DATA: l_name1 TYPE lfa1-name1,
        l_name2 TYPE lfa1-name2,
        l_name3 TYPE lfa1-name3,
        l_name4 TYPE lfa1-name4.

  SELECT SINGLE name1 name2 name3 name4 zute stcd1
           INTO (l_name1,      l_name2, l_name3, l_name4,
                 re_data-zute, re_data-stcd1 )
           FROM lfa1 WHERE lifnr EQ im_lifnr .

*-- Nom sencer del proveidor ------------------------------------
  CONCATENATE l_name1 l_name2 l_name3 l_name4
         INTO re_data-nom_proveidor
    SEPARATED BY space.
  CONDENSE re_data-nom_proveidor .

ENDMETHOD.


  METHOD confirm_millor_clas.
    TRY .
        IF im_test IS INITIAL .
          LOOP AT my_ofertesx ASSIGNING FIELD-SYMBOL(<ls_ofertax>).
            my_ob_ofertes->modificar_oferta( <ls_ofertax>-offer_data ).
          ENDLOOP .
          my_exp_cont-z_conf_mill_class  = 'X' .
*          my_exp_cont-z_user_sel_m_clas  = sy-uname .
*          my_exp_cont-z_data_sel_m_clas  = sy-datum .
          build_activity_list( ) .
          ex_punctuation_changed = my_changed = 'X' .
        ENDIF .
      CATCH zcx_rm_valoracio .
        RAISE EXCEPTION TYPE zcx_rm_valoracio .
    ENDTRY .
  ENDMETHOD.


METHOD confirm_punt_lemes.
  DATA: l_dummy TYPE c .                                    "#EC NEEDED
  FIELD-SYMBOLS: <ls_punt_lema> TYPE ty_s_punt_gen,
                 <ls_lema>      LIKE LINE OF my_lemes,
                 <lt_lema>      LIKE my_lemes .

  IF im_test IS INITIAL .
    IF my_locked IS INITIAL .
      RAISE EXCEPTION TYPE zcx_rm_valoracio
        EXPORTING textid = zcx_rm_valoracio=>not_opened_for_update .
    ENDIF .

* Reconfirmar? No!!
    IF my_exp_cont-z_v2_conf_dades IS NOT INITIAL .
      MESSAGE e060 WITH my_exp_cont-z_v2_conf_user my_exp_cont-z_v2_conf_data
         INTO l_dummy .
      zcx_rm_valoracio=>raise_from_message( ).
    ENDIF .

    IF check_activity( co_act_confirm_2nd ) IS INITIAL .
      RAISE EXCEPTION TYPE zcx_rm_valoracio.
    ENDIF .

    READ TABLE my_ofertesx WITH KEY exclos = space z_rev_s2_fin = space
            TRANSPORTING NO FIELDS .
    IF sy-subrc EQ 0 .
      RAISE EXCEPTION TYPE zcx_rm_valoracio
        EXPORTING textid = zcx_rm_valoracio=>s2_not_completed .
    ENDIF .
    ASSIGN my_lemes TO <lt_lema> .
  ELSE .
    IF my_opened IS INITIAL .
      RAISE EXCEPTION TYPE zcx_rm_valoracio
        EXPORTING textid = zcx_rm_valoracio=>not_opened_for_update .
    ENDIF .

    ex_lemes = my_lemes .
    IF my_exp_cont-z_v2_conf_dades IS NOT INITIAL .
      RETURN .
    ENDIF .
    ASSIGN ex_lemes TO <lt_lema> .
  ENDIF .

  LOOP AT <lt_lema> ASSIGNING <ls_lema> .
    READ TABLE my_punt_lema ASSIGNING <ls_punt_lema>
           WITH TABLE KEY z_num_gen        = <ls_lema>-z_num_lema
                          z_mod_crit_punt  = my_plec-z_mod_crit_prop
                          z_codi_crit_punt = co_codi_crit_total .
    <ls_lema>-z_punts_lema = <ls_punt_lema>-z_punts .
  ENDLOOP .

  IF im_test IS INITIAL .
    my_exp_cont-z_v2_conf_dades = 'X' .
    my_exp_cont-z_v2_conf_user  = sy-uname .
    my_exp_cont-z_v2_conf_data  = sy-datum .

    build_activity_list( ) .
    my_changed = 'X' .
  ENDIF .

ENDMETHOD.


METHOD confirm_punt_offers.
  DATA: l_dummy   TYPE c,                                   "#EC NEEDED
        l_2_round TYPE xfeld.
  FIELD-SYMBOLS: <lt_ofertesx>  TYPE ty_t_ofertax,
                 <lt_punt_ofer> TYPE ty_t_punt_gen,
                 <ls_ofertax>   TYPE ty_s_ofertax.


*>> INI MODIF EVAGM SPEC-86239
  DATA: lt_props  TYPE TABLE OF bapiproptb,
        ls_props  TYPE bapiproptb,
        ls_return TYPE bapiret2,
        lv_modelo TYPE z_model_exp.

  DATA: lv_repid      TYPE repid VALUE 'ZRM_CL_VALORACIO_OFERTES',
        lv_field_info TYPE zsap_de_field VALUE 'CONFIRM_PUNT_TEC',
        lt_param      TYPE STANDARD TABLE OF zsap_dt_param_hc,
        r_model       TYPE RANGE OF bapipropva,
        ls_model      LIKE LINE OF r_model.

  SELECT * FROM zsap_dt_param_hc INTO TABLE lt_param
    WHERE repid      = lv_repid AND
          field_info = lv_field_info.

  " montamos rango de parametros de los modelos que no deben aplicarpara los errores
  CLEAR: r_model.
  LOOP AT lt_param ASSIGNING FIELD-SYMBOL(<fs_param>).
    ls_model-sign   = 'I'.
    ls_model-option = 'EQ'.
    ls_model-low    = <fs_param>-value.
    APPEND ls_model TO r_model.
  ENDLOOP.

  CALL FUNCTION 'SRM_RECORD_GETPROPERTIES'
    EXPORTING
      objectid            = my_exp_cont-objectid
      documentclass       = my_exp_cont-docclass
      whole_document      = abap_true
    IMPORTING
      return              = ls_return
    TABLES
      properties          = lt_props
    EXCEPTIONS
      container_is_locked = 1
      not_authorized      = 2
      parameter_error     = 3
      container_not_found = 4
      container_corrupt   = 5
      internal_error      = 6
      customizing_error   = 7
      OTHERS              = 8.

  READ TABLE lt_props INTO ls_props WITH KEY name = 'SRM_MODEL'.
  lv_modelo  = ls_props-value.
*<< FI MODIF EVAGM SPEC-86239


  IF im_test IS INITIAL .
    IF my_locked IS INITIAL .
      RAISE EXCEPTION TYPE zcx_rm_valoracio
        EXPORTING
          msgid  = zcx_rm_valoracio=>not_opened_for_update-msgid " ETLJS SPEC-51986 08.01.2019 11:14:43
          msgno  = zcx_rm_valoracio=>not_opened_for_update-msgno " ETLJS SPEC-51986 08.01.2019 11:14:43
          textid = zcx_rm_valoracio=>not_opened_for_update.
    ENDIF .

* Reconfirmar? No!!
    IF my_exp_cont-z_vo_conf_dades IS NOT INITIAL .
      IF my_mode NE co_mode_neg_f2."ETKAN P100031 28/04/2016
        MESSAGE e048 WITH my_exp_cont-z_vo_conf_user my_exp_cont-z_vo_conf_data
           INTO l_dummy .
        zcx_rm_valoracio=>raise_from_message( ).
      ENDIF.
    ENDIF .

    IF check_activity( co_act_confirm_1st ) IS INITIAL .
      RAISE EXCEPTION TYPE zcx_rm_valoracio.
    ENDIF .

    READ TABLE my_ofertesx WITH KEY exclos = space z_rev_s2_fin = space
            TRANSPORTING NO FIELDS .
    IF sy-subrc EQ 0 .
      IF my_exp_cont-z_proc_adj = 'NF' AND my_exp_cont-z_negociacio = 'X'.
        RAISE EXCEPTION TYPE zcx_rm_valoracio
          EXPORTING
            msgid  = zcx_rm_valoracio=>dt_not_completed-msgid " ETLJS SPEC-51986 08.01.2019 11:14:43
            msgno  = zcx_rm_valoracio=>dt_not_completed-msgno " ETLJS SPEC-51986 08.01.2019 11:14:43
            textid = zcx_rm_valoracio=>dt_not_completed.
      ELSE.
*** INI SPEC-44267 ETOVB
        IF my_exp_cont-z_obert_preu NE abap_true
*** JGG SPEC-64927 -->
          AND my_exp_cont-z_proc_adj NE 'CE'
          AND my_exp_cont-z_proc_adj NE 'NB'"ETOVB SPEC-73390
*** JGG SPEC-64927 <--
*** FIN SPEC-44267 ETOVB
*>> INI MODIF EVAGM SPEC-86239
          AND lv_modelo NOT IN r_model.
*<< FI MODIF EVAGM SPEC-86239

          RAISE EXCEPTION TYPE zcx_rm_valoracio
            EXPORTING
              msgid  = zcx_rm_valoracio=>s2_not_completed-msgid " ETLJS SPEC-51986 08.01.2019 11:14:43
              msgno  = zcx_rm_valoracio=>s2_not_completed-msgno " ETLJS SPEC-51986 08.01.2019 11:14:50
              textid = zcx_rm_valoracio=>s2_not_completed.
*** INI SPEC-44267 ETOVB
        ENDIF.
*** FIN SPEC-44267 ETOVB
      ENDIF.
    ENDIF .

*   Els exclosos per Variant tècnicament no adient s'han de revisar completament...
    READ TABLE my_ofertesx WITH KEY exclos = 'X' z_exclos_var_tec = 'X' z_rev_s2_fin = space
            TRANSPORTING NO FIELDS .
    IF sy-subrc EQ 0 .
*** INI SPEC-44267 ETOVB
      IF my_exp_cont-z_obert_preu NE abap_true
*** FIN SPEC-44267 ETOVB
*>> INI MODIF EVAGM SPEC-86239
          AND lv_modelo NOT IN r_model.
*<< FI MODIF EVAGM SPEC-86239
        RAISE EXCEPTION TYPE zcx_rm_valoracio
          EXPORTING
            msgid  = zcx_rm_valoracio=>s2_not_completed-msgid " ETLJS SPEC-51986 08.01.2019 11:14:26
            msgno  = zcx_rm_valoracio=>s2_not_completed-msgno " ETLJS SPEC-51986 08.01.2019 11:14:30
            textid = zcx_rm_valoracio=>s2_not_completed.
*** INI SPEC-44267 ETOVB
      ENDIF.
*** FIN SPEC-44267 ETOVB
    ENDIF .

    ASSIGN: my_punt_ofer TO <lt_punt_ofer>,
            my_ofertesx  TO <lt_ofertesx> .
  ELSE .
    IF my_opened IS INITIAL .
      RAISE EXCEPTION TYPE zcx_rm_valoracio .
    ENDIF .

    ex_punt_ofer = my_punt_ofer .
    ex_ofertesx  = my_ofertesx .
    IF my_exp_cont-z_vo_conf_dades IS NOT INITIAL .
      ex_ofertes   = my_ob_ofertes->obtenir_ofertes_exp( ) .
      RETURN .
    ENDIF .
    ASSIGN: ex_punt_ofer TO <lt_punt_ofer>,
            ex_ofertesx  TO <lt_ofertesx> .
  ENDIF .

  IF my_mode NE co_mode_neg_f2."ETKAN P100031 28/04/2016
    l_2_round = is_2_round( ) .
  ENDIF.

  IF my_exp_cont-z_rd817_2009 IS NOT INITIAL.
* A V.O. per RD817/2009 només confirmem la part econòmica. La tècnica es confirma a Punt. tèc.

    CALL METHOD me->recalc_punt_offers_int_tec
      EXPORTING
        im_crit_punt           = my_crit_punt
        im_plec                = my_plec
        im_2_round             = l_2_round
      IMPORTING
        ex_punctuation_changed = ex_punctuation_changed
      CHANGING
        ch_punt_ofer           = <lt_punt_ofer>
        ch_ofertesx            = <lt_ofertesx>.

    CALL METHOD zrm_cl_valoracio_ofertes=>confirm_punt_offers_int_eco
      EXPORTING
        im_crit_punt           = my_crit_punt
        im_plec                = my_plec
        im_2_round             = l_2_round
      IMPORTING
        ex_punctuation_changed = ex_punctuation_changed
      CHANGING
        ch_punt_ofer           = <lt_punt_ofer>
        ch_ofertesx            = <lt_ofertesx>.

  ELSE.


    CALL METHOD me->confirm_punt_offers_int_tec
      EXPORTING
        im_crit_punt           = my_crit_punt
        im_plec                = my_plec
        im_2_round             = l_2_round
      IMPORTING
        ex_punctuation_changed = ex_punctuation_changed
      CHANGING
        ch_punt_ofer           = <lt_punt_ofer>
        ch_ofertesx            = <lt_ofertesx>.

* Es torna a calcular la valoració econòmica per a fer els càlculs sense els exclosos
* per puntuació tècnica per a procediments NH amb anunci perfil posterior al 08/07/09(SPEC-15023)

    IF my_exp_cont-z_publ_anun_dogc > co_date_excl_punt_tec.

*      CALL METHOD me->recalculate_val_econ
*        EXPORTING
*          im_crit_punt = my_crit_punt
*        IMPORTING
*          ex_changed   = ex_punctuation_changed
*        CHANGING
*          ch_punt_gen  = <lt_punt_ofer>.

      CALL METHOD me->recalculate_val_econ_n
        EXPORTING
          im_crit_punt = my_crit_punt
        IMPORTING
          ex_changed   = ex_punctuation_changed
        CHANGING
          ch_punt_gen  = <lt_punt_ofer>.

      CALL METHOD me->recalculate_val_tecnic
        EXPORTING
          im_crit_punt = my_crit_punt
        IMPORTING
          ex_changed   = ex_punctuation_changed
        CHANGING
          ch_punt_gen  = <lt_punt_ofer>.
**>> INI MODIF ETODR SPEC-45341
      IF get_my_crit_dyn( ) = abap_on.
        recalculate_crit_dyn( EXPORTING im_crit_punt      = my_crit_punt
                              IMPORTING ex_changed        = ex_punctuation_changed
                              CHANGING  ch_punt_gen       = <lt_punt_ofer> ).

        confirm_punt_offers_int_tec( EXPORTING  im_crit_punt           = my_crit_punt
                                                im_plec                = my_plec
                                                im_2_round             = l_2_round
                                     IMPORTING  ex_punctuation_changed = ex_punctuation_changed
                                     CHANGING   ch_punt_ofer           = <lt_punt_ofer>
                                                ch_ofertesx            = <lt_ofertesx> ).
      ENDIF.
**<< FI MODIF ETODR SPEC-45341
    ENDIF.

    CALL METHOD zrm_cl_valoracio_ofertes=>confirm_punt_offers_int_eco
      EXPORTING
        im_crit_punt           = my_crit_punt
        im_plec                = my_plec
        im_2_round             = l_2_round
      IMPORTING
        ex_punctuation_changed = ex_punctuation_changed
      CHANGING
        ch_punt_ofer           = <lt_punt_ofer>
        ch_ofertesx            = <lt_ofertesx>.

  ENDIF.


  IF im_test IS INITIAL .
    LOOP AT my_ofertesx ASSIGNING <ls_ofertax> .
      my_ob_ofertes->modificar_oferta( <ls_ofertax>-offer_data ).
    ENDLOOP .

    my_exp_cont-z_vo_conf_dades = 'X' .
    my_exp_cont-z_vo_conf_user  = sy-uname .
    my_exp_cont-z_vo_conf_data  = sy-datum .

    IF my_mode NE co_mode_neg_f2."ETKAN P100031 28/04/2016
      build_activity_list( ) .
    ENDIF.
    my_changed = 'X' .
  ENDIF .

  IF ex_ofertes IS REQUESTED .
    REFRESH ex_ofertes .
    LOOP AT <lt_ofertesx> ASSIGNING <ls_ofertax> .
      INSERT <ls_ofertax>-offer_data INTO TABLE ex_ofertes .
    ENDLOOP .
  ENDIF .


ENDMETHOD.


METHOD confirm_punt_offers_int_eco.
  DATA: l_dummy TYPE c .                                    "#EC NEEDED
  FIELD-SYMBOLS: <ls_crit_punt> TYPE ty_s_crit_punt,
                 <ls_ofertax>   TYPE ty_s_ofertax,
                 <ls_punt_ofer> TYPE ty_s_punt_gen .


  DATA: BEGIN OF ls_codi_crit,
         codi_punt_econ    TYPE zrm_dm_crit_punt-z_codi_crit_punt,
         codi_punt_tec     TYPE zrm_dm_crit_punt-z_codi_crit_punt,
        END   OF ls_codi_crit.


* Obtenim els codis de criteris que ens serveixen per a informar cada camp de puntació
* de la taula d'ofertes...
  CLEAR ls_codi_crit .
  LOOP AT  im_crit_punt ASSIGNING <ls_crit_punt> .
    CASE <ls_crit_punt>-z_crit_ve .
      WHEN co_crit_economic .   ls_codi_crit-codi_punt_econ = <ls_crit_punt>-z_codi_crit_punt .
    ENDCASE .
  ENDLOOP .

* Pas A: Inicialialitzear totes les variables rellevants -------------------------------
  LOOP AT ch_ofertesx ASSIGNING <ls_ofertax> .
    CLEAR: <ls_ofertax>-offer_data-z_punts_ofert,
           <ls_ofertax>-offer_data-z_punt_econ,
           <ls_ofertax>-offer_data-z_punt_total,
           <ls_ofertax>-offer_data-z_adj_prov .
  ENDLOOP .

* Pas D: Informem la resta de camps de puntuació ---------------------------------------
  LOOP AT ch_ofertesx ASSIGNING <ls_ofertax> .
    IF ls_codi_crit-codi_punt_econ IS NOT INITIAL .
      READ TABLE ch_punt_ofer ASSIGNING <ls_punt_ofer>
             WITH TABLE KEY z_num_gen        = <ls_ofertax>-z_num_ofer
                            z_mod_crit_punt  = im_plec-z_mod_crit_punt
                            z_codi_crit_punt = ls_codi_crit-codi_punt_econ .
      <ls_ofertax>-offer_data-z_punt_econ = <ls_punt_ofer>-z_punts .
    ENDIF .

    READ TABLE ch_punt_ofer ASSIGNING <ls_punt_ofer>
           WITH TABLE KEY z_num_gen        = <ls_ofertax>-z_num_ofer
                          z_mod_crit_punt  = im_plec-z_mod_crit_punt
                          z_codi_crit_punt = co_codi_crit_total .
*ATENCIÓ: en licitacions d'una volta Z_PUNTS_OFERT = Z_PUNT_TOTAL = total i
* en dobles voltes Z_PUNTS_OFERT és la puntuació de primera volta i Z_PUNTS_TOTAL
* és la puntuació de proposta gràfica
    IF im_2_round IS INITIAL
       .
      <ls_ofertax>-offer_data-z_punt_total  = <ls_punt_ofer>-z_punts .
      <ls_ofertax>-offer_data-z_punts_ofert = <ls_punt_ofer>-z_punts .
    ELSE .
      <ls_ofertax>-offer_data-z_punts_ofert = <ls_punt_ofer>-z_punts .
    ENDIF .
*    my_ob_ofertes->modificar_oferta( <ls_ofertax>-offer_data ).
  ENDLOOP .


ENDMETHOD.


METHOD confirm_punt_offers_int_sol.
  FIELD-SYMBOLS: <ls_punt_sol_part> TYPE ty_s_punt_gen,
               <ls_ofertax>   TYPE ty_s_ofertax.

  LOOP AT ch_ofertesx ASSIGNING <ls_ofertax> .
    READ TABLE ch_punt_ofer  ASSIGNING <ls_punt_sol_part>
         WITH TABLE KEY z_num_gen        = <ls_ofertax>-z_num_ofer
                        z_mod_crit_punt  =  im_plec-z_mod_crit_sol
                        z_codi_crit_punt =  co_codi_crit_total .
    <ls_ofertax>-offer_data-z_punt_sol =  <ls_punt_sol_part>-z_punts .
* <== EDLSM 15/06/2010 Excl. punt.solv.tèc.
    IF im_min_solv_tec IS NOT INITIAL AND
       <ls_ofertax>-offer_data-z_punt_sol LT im_min_solv_tec.
      <ls_ofertax>-offer_data-z_excl_solv_tec = 'X'.
    ENDIF.
* ==> EDLSM
  ENDLOOP .
ENDMETHOD.


METHOD confirm_punt_offers_int_tec.
  DATA: l_dummy TYPE c .                                    "#EC NEEDED
  FIELD-SYMBOLS: <ls_crit_punt> TYPE ty_s_crit_punt,
                 <ls_ofertax>   TYPE ty_s_ofertax,
                 <ls_punt_ofer> TYPE ty_s_punt_gen.


  DATA: BEGIN OF ls_codi_crit,
          codi_punt_econ TYPE zrm_dm_crit_punt-z_codi_crit_punt,
          codi_punt_tec  TYPE zrm_dm_crit_punt-z_codi_crit_punt,
        END   OF ls_codi_crit.


* Obtenim els codis de criteris que ens serveixen per a informar cada camp de puntació
* de la taula d'ofertes...
  CLEAR ls_codi_crit .
  LOOP AT  im_crit_punt ASSIGNING <ls_crit_punt> .
    CASE <ls_crit_punt>-z_crit_ve .
      WHEN co_crit_tecnic .     ls_codi_crit-codi_punt_tec  = <ls_crit_punt>-z_codi_crit_punt .
    ENDCASE .
  ENDLOOP .


* Pas A: Inicialialitzear totes les variables rellevants -------------------------------
  LOOP AT ch_ofertesx ASSIGNING <ls_ofertax> .
** >> INI MODIF ETODR SPEC-42453
    IF <ls_ofertax>-exclos IS INITIAL.
** <<< FI MODIF ETODR SPEC-42453
      CLEAR: <ls_ofertax>-offer_data-z_punt_tec,
             <ls_ofertax>-offer_data-z_excl_punt_tec.
    ENDIF.

    IF my_mode <> co_mode_punct_tec.
      CLEAR: <ls_ofertax>-offer_data-z_punts_ofert,
             <ls_ofertax>-offer_data-z_punt_total,
             <ls_ofertax>-offer_data-z_adj_prov.
    ENDIF.
  ENDLOOP .

* Pas B: Obtenir la puntuació tècnica i excloure, si cal  -----------------------------
  IF ls_codi_crit-codi_punt_tec IS NOT INITIAL .
    READ TABLE im_crit_punt ASSIGNING <ls_crit_punt>
           WITH TABLE KEY z_mod_crit_punt  = im_plec-z_mod_crit_punt
                          z_codi_crit_punt = ls_codi_crit-codi_punt_tec .
    LOOP AT ch_ofertesx ASSIGNING <ls_ofertax> WHERE exclos IS INITIAL.
      READ TABLE ch_punt_ofer ASSIGNING <ls_punt_ofer>
             WITH TABLE KEY z_num_gen        = <ls_ofertax>-z_num_ofer
                            z_mod_crit_punt  = im_plec-z_mod_crit_punt
                            z_codi_crit_punt = ls_codi_crit-codi_punt_tec .
***INI ETOVB SPEC-45341
      IF sy-subrc EQ 0.
***FIN ETOV SPEC-45341
        <ls_ofertax>-offer_data-z_punt_tec = <ls_punt_ofer>-z_punts .
        IF <ls_punt_ofer>-z_punts LT <ls_crit_punt>-z_punt_min .
          <ls_ofertax>-offer_data-z_excl_punt_tec = 'X' .
        ENDIF .
***INI ETOVB SPEC-45341
      ENDIF.
***FIN ETOV SPEC-45341
    ENDLOOP .
  ENDIF .

* Pas C: Si no s'arriba al mínim de puntuació de qualsevol dels criteris,
*        independent del tipus de criteri, excloem
  LOOP AT ch_ofertesx ASSIGNING <ls_ofertax> WHERE z_excl_punt_tec IS INITIAL
                                               AND exclos IS INITIAL .
    LOOP AT im_crit_punt ASSIGNING <ls_crit_punt>
                  WHERE     z_mod_crit_punt EQ im_plec-z_mod_crit_punt
                        AND z_punt_min      GT 0 .
      READ TABLE ch_punt_ofer ASSIGNING <ls_punt_ofer>
             WITH TABLE KEY z_num_gen        = <ls_ofertax>-z_num_ofer
                            z_mod_crit_punt  = im_plec-z_mod_crit_punt
                            z_codi_crit_punt = <ls_crit_punt>-z_codi_crit_punt.
      CHECK <ls_punt_ofer>-z_punts LT <ls_crit_punt>-z_punt_min .
      <ls_ofertax>-offer_data-z_excl_punt_tec = 'X' .
      EXIT .
    ENDLOOP .
  ENDLOOP .

* Pas D: Informem la resta de camps de puntuació ---------------------------------------
  LOOP AT ch_ofertesx ASSIGNING <ls_ofertax> .

    IF ls_codi_crit-codi_punt_tec IS NOT INITIAL .
      READ TABLE ch_punt_ofer ASSIGNING <ls_punt_ofer>
             WITH TABLE KEY z_num_gen        = <ls_ofertax>-z_num_ofer
                            z_mod_crit_punt  = im_plec-z_mod_crit_punt
                            z_codi_crit_punt = ls_codi_crit-codi_punt_tec .
      <ls_ofertax>-offer_data-z_punt_tec = <ls_punt_ofer>-z_punts .
    ENDIF .

    READ TABLE ch_punt_ofer ASSIGNING <ls_punt_ofer>
           WITH TABLE KEY z_num_gen        = <ls_ofertax>-z_num_ofer
                          z_mod_crit_punt  = im_plec-z_mod_crit_punt
                          z_codi_crit_punt = co_codi_crit_total .
*ATENCIÓ: en licitacions d'una volta Z_PUNTS_OFERT = Z_PUNT_TOTAL = total i
* en dobles voltes Z_PUNTS_OFERT és la puntuació de primera volta i Z_PUNTS_TOTAL
* és la puntuació de proposta gràfica

    CHECK <ls_punt_ofer> IS ASSIGNED. " SPEC-88482 dump

    IF my_mode <> co_mode_punct_tec.
      IF im_2_round IS INITIAL .
        <ls_ofertax>-offer_data-z_punt_total  = <ls_punt_ofer>-z_punts .
        <ls_ofertax>-offer_data-z_punts_ofert = <ls_punt_ofer>-z_punts .
      ELSE .
        <ls_ofertax>-offer_data-z_punts_ofert = <ls_punt_ofer>-z_punts .
      ENDIF .
    ENDIF.
*    my_ob_ofertes->modificar_oferta( <ls_ofertax>-offer_data ).
  ENDLOOP .


ENDMETHOD.


  METHOD confirm_punt_q2b.
    DATA: exc  TYPE REF TO zcx_rm_valoracio,
          text TYPE string.
    TRY .
        confirm_punt_tec_offers( IMPORTING ex_punctuation_changed = ex_punctuation_changed ) .
      CATCH zcx_rm_valoracio INTO exc.

        CALL METHOD exc->get_text
          RECEIVING
            result = text.

        MESSAGE text TYPE 'I' DISPLAY LIKE 'E'.
        LEAVE PROGRAM.

    ENDTRY .
  ENDMETHOD.


  METHOD confirm_punt_q3b.
    DATA: lv_imin_no_update TYPE xfeld.
    ">>>SPEC-55535, Inici modificació - ETODR
    IF gt_incr IS NOT INITIAL.
      IF my_exp_cont_db-z_imin IS NOT INITIAL.
        CLEAR: lv_imin_no_update.
        "Pot ser que el IMIN hagi canviat, en aquest cas, no permetem confirmar si no s'ha verificat la puntuació
        LOOP AT gt_incr ASSIGNING FIELD-SYMBOL(<fs_crit_incr>).
          IF <fs_crit_incr>-z_imin <> my_exp_cont_db-z_imin.
            lv_imin_no_update = abap_on.
          ENDIF.
        ENDLOOP.
      ELSE.
        RAISE EXCEPTION TYPE zcx_rm_valoracio
          EXPORTING
            textid = zcx_rm_valoracio=>not_imin_informed.
      ENDIF.
    ENDIF.
    IF lv_imin_no_update IS NOT INITIAL.
      RAISE EXCEPTION TYPE zcx_rm_valoracio
        EXPORTING
          textid = zcx_rm_valoracio=>imin_changed_not_sync.
      EXIT.
    ELSE.
      "<<<SPEC-55535, Final modificació - ETODR
      TRY .
*        confirm_punt_tec_offers( IMPORTING ex_punctuation_changed = ex_punctuation_changed ) .
          IF im_test IS INITIAL .
            LOOP AT my_ofertesx ASSIGNING FIELD-SYMBOL(<ls_ofertax>).
              my_ob_ofertes->modificar_oferta( <ls_ofertax>-offer_data ).
            ENDLOOP .
            my_exp_cont-z_q3_conf_dades = 'X' .
            my_exp_cont-z_q3_conf_user  = sy-uname .
            my_exp_cont-z_q3_conf_data  = sy-datum .
            build_activity_list( ) .
            ex_punctuation_changed = my_changed = 'X' .
          ENDIF .
        CATCH zcx_rm_valoracio .
          RAISE EXCEPTION TYPE zcx_rm_valoracio .
      ENDTRY .
    ENDIF.
  ENDMETHOD.


  METHOD confirm_punt_q4b.
    DATA:
        lcx TYPE REF TO zcx_rm_valoracio.

    TRY .
        confirm_punt_offers( IMPORTING ex_punctuation_changed = ex_punctuation_changed ) .

*>> INI SPEC-51986 08.01.2019 11:15:32
      CATCH zcx_rm_valoracio INTO lcx.
        zcx_rm_valoracio=>raise_from_message( EXPORTING im_msgid = lcx->msgid
                                                         im_msgno = lcx->msgno ).
*<< FIN SPEC-51986 08.01.2019 11:15:32
    ENDTRY .
  ENDMETHOD.


METHOD confirm_punt_sol_part.
  DATA: l_dummy     TYPE c,
        l_2_round   TYPE xfeld.

  FIELD-SYMBOLS: <lt_ofertesx>      TYPE ty_t_ofertax,
                 <ls_ofertax>       TYPE ty_s_ofertax,
                 <lt_punt_sol_part> TYPE ty_t_punt_gen,
                 <ls_punt_sol_part> TYPE ty_s_punt_gen.



  IF im_test IS INITIAL .
    IF my_locked IS INITIAL .
      RAISE EXCEPTION TYPE zcx_rm_valoracio
        EXPORTING textid = zcx_rm_valoracio=>not_opened_for_update .
    ENDIF .
* Reconfirmar? No!!
    IF my_exp_cont-z_sp_conf_dades IS NOT INITIAL .
      MESSAGE e089 WITH my_exp_cont-z_sp_conf_user my_exp_cont-z_sp_conf_data
         INTO l_dummy .
      zcx_rm_valoracio=>raise_from_message( ).
    ENDIF .

    IF check_activity( co_act_confirm_sp ) IS INITIAL .
      RAISE EXCEPTION TYPE zcx_rm_valoracio.
    ENDIF .

    READ TABLE my_ofertesx WITH KEY exclos = space z_rev_s1_fin = space
           TRANSPORTING NO FIELDS .
    IF sy-subrc EQ 0 .
      RAISE EXCEPTION TYPE zcx_rm_valoracio
        EXPORTING textid = zcx_rm_valoracio=>s1_not_completed .
    ENDIF .

  ELSE.
    IF my_opened IS INITIAL .
      RAISE EXCEPTION TYPE zcx_rm_valoracio .
    ENDIF .
    IF my_exp_cont-z_sp_conf_dades IS NOT INITIAL .
      ex_ofertes   = my_ob_ofertes->obtenir_ofertes_exp( ) .
      RETURN .
    ENDIF .

    ex_punt_ofer = my_punt_sol_part .
    ex_ofertesx  = my_ofertesx .


  ENDIF.

  ASSIGN: my_punt_sol_part TO <lt_punt_sol_part>,
          my_ofertesx      TO <lt_ofertesx> .



  CALL METHOD zrm_cl_valoracio_ofertes=>confirm_punt_offers_int_sol
    EXPORTING
      im_crit_punt           = my_crit_punt
      im_plec                = my_plec
      im_2_round             = l_2_round
      im_min_solv_tec        = my_min_solv_tec  "EDLSM
    IMPORTING
      ex_punctuation_changed = ex_punctuation_changed
    CHANGING
      ch_punt_ofer           = <lt_punt_sol_part>
      ch_ofertesx            = <lt_ofertesx>.

  IF im_test IS INITIAL .
    LOOP AT my_ofertesx ASSIGNING <ls_ofertax> .
      my_ob_ofertes->modificar_oferta( <ls_ofertax>-offer_data ).
    ENDLOOP .

    my_exp_cont-z_sp_conf_dades = 'X' .
    my_exp_cont-z_sp_conf_user  = sy-uname .
    my_exp_cont-z_sp_conf_data  = sy-datum .

    build_activity_list( ) .
    my_changed = 'X' .
  ENDIF .

  IF ex_ofertes IS REQUESTED .
    REFRESH ex_ofertes .
    LOOP AT <lt_ofertesx> ASSIGNING <ls_ofertax> .
      INSERT <ls_ofertax>-offer_data INTO TABLE ex_ofertes .
    ENDLOOP .
  ENDIF .

ENDMETHOD.


METHOD confirm_punt_tec_offers.
  DATA: l_dummy   TYPE c,                                   "#EC NEEDED
        l_2_round TYPE xfeld.
  FIELD-SYMBOLS: <lt_ofertesx>  TYPE ty_t_ofertax,
                 <lt_punt_ofer> TYPE ty_t_punt_gen,
                 <ls_ofertax>   TYPE ty_s_ofertax.

*>> INI MODIF EVAGE SPEC-86239
  DATA: lt_props  TYPE TABLE OF bapiproptb,
        ls_props  TYPE bapiproptb,
        ls_return TYPE bapiret2,
        lv_modelo TYPE z_model_exp.

  DATA: lv_repid      TYPE repid VALUE 'ZRM_CL_VALORACIO_OFERTES',
        lv_field_info TYPE zsap_de_field VALUE 'CONFIRM_PUNT_TEC',
        lt_param      TYPE STANDARD TABLE OF zsap_dt_param_hc,
        r_model       TYPE RANGE OF bapipropva,
        ls_model      LIKE LINE OF r_model.

  SELECT * FROM zsap_dt_param_hc INTO TABLE lt_param
    WHERE repid      = lv_repid AND
          field_info = lv_field_info.

  " montamos rango de parametros de los modelos que no deben aplicar para los errores
  CLEAR: r_model.
  LOOP AT lt_param ASSIGNING FIELD-SYMBOL(<fs_param>).
    ls_model-sign   = 'I'.
    ls_model-option = 'EQ'.
    ls_model-low    = <fs_param>-value.
    APPEND ls_model TO r_model.
  ENDLOOP.

  CALL FUNCTION 'SRM_RECORD_GETPROPERTIES'
    EXPORTING
      objectid            = my_exp_cont-objectid
      documentclass       = my_exp_cont-docclass
      whole_document      = abap_true
    IMPORTING
      return              = ls_return
    TABLES
      properties          = lt_props
    EXCEPTIONS
      container_is_locked = 1
      not_authorized      = 2
      parameter_error     = 3
      container_not_found = 4
      container_corrupt   = 5
      internal_error      = 6
      customizing_error   = 7
      OTHERS              = 8.

  READ TABLE lt_props INTO ls_props WITH KEY name = 'SRM_MODEL'.
  lv_modelo  = ls_props-value.

*<< FI MODIF EVAGE SPEC-86239

  IF im_test IS INITIAL .
    IF my_locked IS INITIAL .
      RAISE EXCEPTION TYPE zcx_rm_valoracio
        EXPORTING
          textid = zcx_rm_valoracio=>not_opened_for_update.
    ENDIF .

* Reconfirmar? No!!
    IF my_exp_cont-z_pt_conf_dades IS NOT INITIAL .
      MESSAGE e048 WITH my_exp_cont-z_pt_conf_user my_exp_cont-z_pt_conf_data
         INTO l_dummy .
      zcx_rm_valoracio=>raise_from_message( ).
    ENDIF .

    IF check_activity( co_act_confirm_1st ) IS INITIAL .
      RAISE EXCEPTION TYPE zcx_rm_valoracio.
    ENDIF .

    READ TABLE my_ofertesx TRANSPORTING NO FIELDS WITH KEY z_rev_s1_fin = space
                                                           z_tipus_oferta = 'B' .
    IF sy-subrc EQ 0 .
      RAISE EXCEPTION TYPE zcx_rm_valoracio
        EXPORTING
          textid = zcx_rm_valoracio=>s1_no_revisat.
    ENDIF .

*>> INI MODIF EVAGE SPEC-86239
    IF lv_modelo NOT IN r_model.
*<< FI MODIF EVAGE SPEC-86239
      READ TABLE my_ofertesx WITH KEY exclos = space z_rev_s2_fin = space
              TRANSPORTING NO FIELDS .
      IF sy-subrc EQ 0 .
        RAISE EXCEPTION TYPE zcx_rm_valoracio
          EXPORTING
            textid = zcx_rm_valoracio=>s2_no_revisat.
      ENDIF .

*   Els exclosos per Variant tècnicament no adient s'han de revisar completament...
    READ TABLE my_ofertesx WITH KEY exclos = 'X' z_exclos_var_tec = 'X' z_rev_s2_fin = space
            TRANSPORTING NO FIELDS .
    IF sy-subrc EQ 0 .
      RAISE EXCEPTION TYPE zcx_rm_valoracio
        EXPORTING
          textid = zcx_rm_valoracio=>s2_not_completed.
    ENDIF .

*>> INI MODIF EVAGE SPEC-86239
    ENDIF.
*<< FI MODIF EVAGE SPEC-86239

    ASSIGN: my_punt_ofer TO <lt_punt_ofer>,
            my_ofertesx  TO <lt_ofertesx> .
  ELSE .
    IF my_opened IS INITIAL .
      RAISE EXCEPTION TYPE zcx_rm_valoracio .
    ENDIF .

    ex_punt_ofer = my_punt_ofer .
    ex_ofertesx  = my_ofertesx .
* SPEC-43882
*    IF my_exp_cont-z_pt_conf_dades IS NOT INITIAL .
*      ex_ofertes   = my_ob_ofertes->obtenir_ofertes_exp( ) .
*      RETURN .
*    ENDIF .
    ASSIGN: ex_punt_ofer TO <lt_punt_ofer>,
            ex_ofertesx  TO <lt_ofertesx> .
  ENDIF .

  l_2_round = is_2_round( ) .
**>> INI MODIF ETODR SPEC-40749
  DATA: lt_crit_punt TYPE ty_t_crit_punt.
  IF im_crit_punt IS INITIAL.
    lt_crit_punt = my_crit_punt.
  ELSE.
    lt_crit_punt = im_crit_punt.
  ENDIF.
  IF im_punt_ofer IS NOT INITIAL.
    ex_punt_ofer = im_punt_ofer.
    ASSIGN: ex_punt_ofer TO <lt_punt_ofer>.
  ENDIF.
**<< FI MODIF ETODR SPEC-40749
  CALL METHOD me->confirm_punt_offers_int_tec
    EXPORTING
**>> INI MODIF ETODR SPEC-40749
*     im_crit_punt           = my_crit_punt
      im_crit_punt           = lt_crit_punt
**<< FI MODIF ETODR SPEC-40749
      im_plec                = my_plec
      im_2_round             = l_2_round
    IMPORTING
      ex_punctuation_changed = ex_punctuation_changed
    CHANGING
      ch_punt_ofer           = <lt_punt_ofer>
      ch_ofertesx            = <lt_ofertesx>.


  IF im_test IS INITIAL .
    LOOP AT my_ofertesx ASSIGNING <ls_ofertax> .
      my_ob_ofertes->modificar_oferta( <ls_ofertax>-offer_data ).
    ENDLOOP .

    my_exp_cont-z_pt_conf_dades = 'X' .
    my_exp_cont-z_pt_conf_user  = sy-uname .
    my_exp_cont-z_pt_conf_data  = sy-datum .

    build_activity_list( ) .
    my_changed = 'X' .
  ENDIF .

  IF ex_ofertes IS REQUESTED .
    REFRESH ex_ofertes .
    LOOP AT <lt_ofertesx> ASSIGNING <ls_ofertax> .
      INSERT <ls_ofertax>-offer_data INTO TABLE ex_ofertes .
    ENDLOOP .
  ENDIF .


ENDMETHOD.


  METHOD confirm_punt_verif_cap_obra.


    DATA: lv_imin_no_update TYPE xfeld.
    ">>>SPEC-55535, Inici modificació - ETODR
    IF gt_incr IS NOT INITIAL.
      IF my_exp_cont_db-z_imin IS NOT INITIAL.
        CLEAR: lv_imin_no_update.
        "Pot ser que el IMIN hagi canviat, en aquest cas, no permetem confirmar si no s'ha verificat la puntuació
        LOOP AT gt_incr ASSIGNING FIELD-SYMBOL(<fs_crit_incr>).
          IF <fs_crit_incr>-z_imin <> my_exp_cont_db-z_imin.
            lv_imin_no_update = abap_on.
          ENDIF.
        ENDLOOP.
      ELSE.
        RAISE EXCEPTION TYPE zcx_rm_valoracio
          EXPORTING
            textid = zcx_rm_valoracio=>not_imin_informed.
      ENDIF.
    ENDIF.
    IF lv_imin_no_update IS NOT INITIAL.
      RAISE EXCEPTION TYPE zcx_rm_valoracio
        EXPORTING
          textid = zcx_rm_valoracio=>imin_changed_not_sync.
      EXIT.
    ELSE.
      "<<<SPEC-55535, Final modificació - ETODR
      TRY .
*        confirm_punt_tec_offers( IMPORTING ex_punctuation_changed = ex_punctuation_changed ) .
          IF im_test IS INITIAL .
            LOOP AT my_ofertesx ASSIGNING FIELD-SYMBOL(<ls_ofertax>).
              my_ob_ofertes->modificar_oferta( <ls_ofertax>-offer_data ).
            ENDLOOP .
            my_exp_cont-z_q3_conf_dades = 'X' .
            my_exp_cont-z_q3_conf_user  = sy-uname .
            my_exp_cont-z_q3_conf_data  = sy-datum .
            build_activity_list( ) .
            ex_punctuation_changed = my_changed = 'X' .
          ENDIF .
        CATCH zcx_rm_valoracio .
          RAISE EXCEPTION TYPE zcx_rm_valoracio .
      ENDTRY .
    ENDIF.
  ENDMETHOD.


METHOD constructor.
  my_objectid = im_objectid.
  my_docclass = im_docclass.
  my_mode     = im_action.
**>> INI MODIF ETODR SPEC-45341
  my_crit_is_dyn = is_dynamic.
**<< FI MODIF ETODR SPEC-45341
ENDMETHOD.


METHOD DEQUEUE.
  CHECK my_locked IS NOT INITIAL .

  my_ob_ofertes->desbloqueja( ) .
  CALL FUNCTION 'DEQUEUE_EZRM_CONTRACTACI'
    EXPORTING
      mandt    = sy-mandt
      docclass = my_docclass
      objectid = my_objectid.
  CLEAR: my_locked,
         my_changed .
ENDMETHOD.


METHOD enqueue.
  CHECK my_locked IS INITIAL .

  CLEAR: ex_success,
         ex_lock_user .

  CALL METHOD my_ob_ofertes->bloqueja
    EXCEPTIONS
      OTHERS = 1.
  IF sy-subrc NE 0 .
    ex_lock_user = sy-msgv1 .
    RETURN .
  ENDIF .

  CALL FUNCTION 'ENQUEUE_EZRM_CONTRACTACI'
    EXPORTING
      mandt          = sy-mandt
      docclass       = my_docclass
      objectid       = my_objectid
    EXCEPTIONS
      foreign_lock   = 1
      system_failure = 2
      OTHERS         = 3.
  CASE sy-subrc .
    WHEN 0 .
      ex_success = 'X' .
    WHEN 1 .
      ex_lock_user = sy-msgv1 .
      my_ob_ofertes->desbloqueja( ) .
  ENDCASE .
ENDMETHOD.


METHOD get_2_round_phase.
  IF is_2_round( ) IS INITIAL .
    RAISE EXCEPTION TYPE zcx_rm_valoracio
       EXPORTING
         textid = zcx_rm_valoracio=>only_for_2_round .
  ENDIF .

  CLEAR: ex_punctuate_offer,
         ex_punctuate_lema,
         ex_set_awardee .

* Si s'ha executat un pas completament, els passos anteriors també
  IF      my_exp_cont-z_adjudicatari  IS NOT INITIAL .
    ex_set_awardee-done     = 'X' .
    ex_punctuate_lema-done  = 'X' .
    ex_punctuate_offer-done = 'X' .
  ELSEIF  my_exp_cont-z_v2_conf_dades IS NOT INITIAL .
    ex_punctuate_lema-done  = 'X' .
    ex_punctuate_offer-done = 'X' .
  ELSEIF  my_exp_cont-z_vo_conf_dades IS NOT INITIAL .
    ex_punctuate_offer-done = 'X' .
  ENDIF .


* Només es pot anul·lar la confirmació de nivell més alt
  IF     ex_set_awardee-done IS NOT INITIAL .
    ex_set_awardee-can_be_undone     = 'X' .
  ELSEIF ex_punctuate_lema-done IS NOT INITIAL .
    ex_punctuate_lema-can_be_undone  = 'X' .
  ELSEIF ex_punctuate_offer-done  IS NOT INITIAL .
    ex_punctuate_offer-can_be_undone = 'X' .
  ENDIF .

* Només es pot fer la puntuació i confirmació del nivell més baix
  IF       ex_punctuate_offer-done IS INITIAL .
    ex_punctuate_offer-can_be_started = 'X' .
  ELSEIF   ex_punctuate_lema-done IS INITIAL .
    ex_punctuate_lema-can_be_started = 'X' .
  ELSEIF   ex_set_awardee-done IS INITIAL.
    ex_set_awardee-can_be_started = 'X' .
  ENDIF .

  DESCRIBE TABLE my_lemes LINES ex_lemes_count .
  FIELD-SYMBOLS: <ls_offer> LIKE LINE OF my_ofertesx .

  ex_2nd_round_offers = 0 .
  LOOP AT my_ofertesx ASSIGNING <ls_offer> WHERE z_sel_2volta IS NOT INITIAL .
    ADD 1 TO ex_2nd_round_offers.
  ENDLOOP .
ENDMETHOD.


  METHOD get_calcul_coautors.

    DATA: lt_calcul_coautor       TYPE ztt_equip_coautor,
          ls_calcul_coautor       TYPE zst_equip_coautor,
          lt_calcul_coaut_carrecs TYPE ztt_equip_coautor,
          lv_compta_equip         TYPE i,
          lv_suma_crit_puntuats   TYPE decfloat34.

    DATA(lt_crit_punt) = my_crit_punt.

    DATA lv_num_plec TYPE z_num_plec.


    DATA(lt_num_equips) = gt_equip[].
    SORT lt_num_equips BY z_num_ofer z_comptador_equip z_carrec_equip.
    DELETE lt_num_equips WHERE z_is_header EQ abap_true.
    DELETE ADJACENT DUPLICATES FROM lt_num_equips COMPARING z_num_ofer z_comptador_equip z_carrec_equip.
    DESCRIBE TABLE lt_num_equips LINES DATA(lv_num_equips).

    get_punts_gen_equi( IMPORTING et_punts_gen_equi = DATA(lt_punt_gen) ).

    DATA(lt_num_ofertes) = my_punt_ofer[].
    DELETE ADJACENT DUPLICATES FROM lt_num_ofertes COMPARING z_num_gen.
    DESCRIBE TABLE lt_num_ofertes LINES DATA(l_num_ofertes).

    DATA(lt_punt_gen_aux) = my_punt_ofer.

    SELECT *
      FROM zrm_dt_punt_equi
      INTO TABLE @DATA(lt_equip_basic_bd)
       FOR ALL ENTRIES IN @lt_num_equips
     WHERE docclass      = @lt_num_equips-docclass
       AND objectid      = @lt_num_equips-objectid
       AND z_equip_basic = @abap_on
       AND z_num_ofer    = @lt_num_equips-z_num_ofer.

    "Primer actualitzem les puntuacions
    LOOP AT lt_num_ofertes ASSIGNING FIELD-SYMBOL(<fs_oferta>).
      DATA(lv_index_oferta_aux) = CONV z_num_ofer( <fs_oferta>-z_num_gen ).
      LOOP AT lt_punt_gen ASSIGNING FIELD-SYMBOL(<fs_punt_gen>) WHERE z_num_gen      = lv_index_oferta_aux.
"INICI - SPEC-90501 - EVMRG - S'ha comentat el codi de la SPEC-73458
        ">> SPEC-73458, Inici Modificació - ETODR
*        IF <fs_punt_gen>-z_num_equip IS NOT INITIAL.
          "<< SPEC-73458, Final Modificació - ETODR
"FI - SPEC-90501 - EVMRG
          LOOP AT lt_punt_gen_aux ASSIGNING FIELD-SYMBOL(<fs_punts_aux>) WHERE z_num_gen        = <fs_punt_gen>-z_num_gen
                                                                           AND z_carrec_equip   = <fs_punt_gen>-z_carrec_equip
                                                                           AND z_codi_crit_punt = <fs_punt_gen>-z_codi_crit_punt
                                                                           AND z_num_equip      = <fs_punt_gen>-z_num_equip.
            <fs_punts_aux>-z_punts          = <fs_punt_gen>-z_punts.
            <fs_punts_aux>-z_punts_no_pond  = <fs_punt_gen>-z_punts.
          ENDLOOP.
"INICI - SPEC-90501 - EVMRG - S'ha comentat el codi de la SPEC-73458
*        ENDIF.
"FI - SPEC-90501 - EVMRG
      ENDLOOP.
    ENDLOOP.

    "Recuperem la fórmula del PDM del Plec
    LOOP AT lt_crit_punt ASSIGNING FIELD-SYMBOL(<fs_crit_punt>) WHERE z_equip_coautor EQ abap_on
                                                                  AND z_sumatori IS NOT INITIAL.
      DATA(lv_sum_info)      = <fs_crit_punt>-sum_info.
      DATA(l_crit_punt_pare) = <fs_crit_punt>-z_codi_crit_punt.
    ENDLOOP.

    LOOP AT lt_num_ofertes ASSIGNING FIELD-SYMBOL(<fs_loop_oferta>). "SPEC-50770
      "Per cada criteri de cada oferta diferent de cada equip amb la marca de EQUIP_COAUTOR = , s'omple la taula LT_CALCUL_COAUTOR
      DATA(lv_index_oferta) = CONV z_num_ofer( <fs_loop_oferta>-z_num_gen ).
      CLEAR: lt_calcul_coautor[].
      LOOP AT lt_num_equips ASSIGNING FIELD-SYMBOL(<fs_equip_oferta>) WHERE z_num_ofer = lv_index_oferta AND z_is_header IS INITIAL.
        DATA(lv_comptador_equip)  = CONV z_compta_equip( <fs_equip_oferta>-z_comptador_equip ).
        CLEAR: ls_calcul_coautor.
        ls_calcul_coautor-z_comptador_equip = <fs_equip_oferta>-z_comptador_equip.
        ls_calcul_coautor-z_num_ofer        = lv_index_oferta.
        "Càlcul de la puntuació sense aplicar el factor de correcció del PDM
"INICI - SPEC-90501 - EVMRG - S'ha comentat el codi de la SPEC-73458
        ">> SPEC-73458, Inici Modificació - ETODR
        "Fem el càlcul pel camp de proporció en cas que existeixi
*        READ TABLE my_crit_punt TRANSPORTING NO FIELDS WITH KEY z_proporcio = abap_on.
*        IF sy-subrc = 0.
*          LOOP AT lt_punt_gen ASSIGNING FIELD-SYMBOL(<fs_punt_prop>) WHERE z_num_gen      = lv_index_oferta
*                                                                       AND z_num_equip    = lv_comptador_equip
*                                                                       AND z_carrec_equip = <fs_equip_oferta>-z_carrec_equip.
*            "Mirem si és el criteri de proporció, en aquest cas no s'acumula sinó que en acabar la suma dels criteris "reals",
*            "multipliquem el criteri de proporció a la suma dels criteris totals
*            READ TABLE lt_equip_basic_bd TRANSPORTING NO FIELDS WITH KEY z_carrec_equip   = <fs_equip_oferta>-z_carrec_equip
*                                                                         z_codi_crit_punt = <fs_punt_prop>-z_codi_crit_punt
*                                                                         z_proporcio      = abap_on.
*            IF sy-subrc <> 0.
*              ls_calcul_coautor-z_punts_abans_pes = ls_calcul_coautor-z_punts_abans_pes + <fs_punt_prop>-z_punts.
*            ENDIF.
*          ENDLOOP.
*
*          LOOP AT lt_punt_gen ASSIGNING <fs_punt_prop> WHERE z_num_gen      = lv_index_oferta
*                                                         AND z_num_equip    = lv_comptador_equip
*                                                         AND z_carrec_equip = <fs_equip_oferta>-z_carrec_equip.
*            READ TABLE lt_equip_basic_bd TRANSPORTING NO FIELDS WITH KEY z_carrec_equip   = <fs_equip_oferta>-z_carrec_equip
*                                                                         z_codi_crit_punt = <fs_punt_prop>-z_codi_crit_punt
*                                                                         z_proporcio      = abap_on.
*            IF sy-subrc = 0.
*              ls_calcul_coautor-z_punts_abans_pes = ls_calcul_coautor-z_punts_abans_pes * <fs_punt_prop>-z_punts.
*            ENDIF.
*          ENDLOOP.
*        ELSE.
"FI - SPEC-90501 - EVMRG
          LOOP AT lt_punt_gen_aux ASSIGNING FIELD-SYMBOL(<fs_punts>) WHERE z_num_gen      = lv_index_oferta
                                                              AND z_num_equip    = lv_comptador_equip
                                                              AND z_carrec_equip = <fs_equip_oferta>-z_carrec_equip.

            ls_calcul_coautor-z_punts_abans_pes = ls_calcul_coautor-z_punts_abans_pes + <fs_punts>-z_punts.
          ENDLOOP.
*>> SPEC-60778, Inici modificació - ETLJS
          IF sy-subrc NE 0.
            LOOP AT lt_punt_gen ASSIGNING FIELD-SYMBOL(<fs_pun_gen>)  WHERE z_num_gen      = lv_index_oferta
                                                                     AND z_num_equip    = lv_comptador_equip
                                                                     AND z_carrec_equip = <fs_equip_oferta>-z_carrec_equip.

              ls_calcul_coautor-z_punts_abans_pes = ls_calcul_coautor-z_punts_abans_pes + <fs_pun_gen>-z_punts.
            ENDLOOP.
          ENDIF.
"INICI - SPEC-90501 - EVMRG - S'ha comentat el codi de la SPEC-73458
*        ENDIF.
"FI - SPEC-90501 - EVMRG
*<< SPEC-60778, Final modificació - ETLJS
        IF <fs_crit_punt> IS ASSIGNED.
          READ TABLE <fs_crit_punt>-sum_info ASSIGNING FIELD-SYMBOL(<fs_sum_info>)
             WITH KEY z_codi_crit_punt = <fs_equip_oferta>-z_codi_crit_punt.

        ENDIF.
        DATA(lv_pes)                         = CONV i( <fs_equip_oferta>-z_pes ).
        ls_calcul_coautor-z_pes               = CONV i( <fs_equip_oferta>-z_pes ).
        IF <fs_sum_info> IS ASSIGNED.
          CLEAR lv_compta_equip.

          "INI ECDRB SPEC-66503
          "1. Consultar el plec a la taula zrm_plec_coaut_a
          SELECT SINGLE z_num_plec INTO lv_num_plec
            FROM  zrm_plec_coaut_a
            WHERE z_num_plec = me->my_exp_cont-z_num_plec.
          IF sy-subrc = 0.
            "Si el plec surt a la taula, en el loop no fer la condició z_comptador_equip
            LOOP AT lt_num_equips TRANSPORTING NO FIELDS
            WHERE z_num_ofer = lv_index_oferta AND z_carrec_equip = <fs_equip_oferta>-z_carrec_equip.
              ADD 1 TO lv_compta_equip.
            ENDLOOP.
          ELSE.
            "FI ECDRB SPEC-66503

            LOOP AT lt_num_equips TRANSPORTING NO FIELDS
              WHERE z_num_ofer = lv_index_oferta AND z_carrec_equip = <fs_equip_oferta>-z_carrec_equip
                AND z_comptador_equip = ls_calcul_coautor-z_comptador_equip. "ETODR SPEC-62360
              ADD 1 TO lv_compta_equip.
            ENDLOOP.
          ENDIF.

          READ TABLE lt_equip_basic_bd ASSIGNING FIELD-SYMBOL(<fs_bs>)
           WITH KEY z_num_ofer = <fs_equip_oferta>-z_num_ofer
                    z_carrec_equip = <fs_equip_oferta>-z_carrec_equip
                    z_comptador_equip = ls_calcul_coautor-z_comptador_equip. "ETODR SPEC-62360
          IF sy-subrc EQ 0.
            "">> INI MODIF ETODR SPEC-61918
*              ls_calcul_coautor-z_punts = CONV z_punts( ( ls_calcul_coautor-z_punts_abans_pes * ( <fs_bs>-z_pes / 100 )  ) / lv_compta_equip ).
            ls_calcul_coautor-z_punts_noround = CONV #( ( ls_calcul_coautor-z_punts_abans_pes * ( <fs_bs>-z_pes / 100 )  ) / lv_compta_equip ).
            ""<< FI MODIF ETODR SPEC-61918
          ELSE.
            "">> INI MODIF ETODR SPEC-61918
*              ls_calcul_coautor-z_punts = CONV z_punts( ( ls_calcul_coautor-z_punts_abans_pes * ( <fs_equip_oferta>-z_pes / 100 )  ) / lv_compta_equip ).
            ls_calcul_coautor-z_punts_noround = CONV #( ( ls_calcul_coautor-z_punts_abans_pes * ( <fs_equip_oferta>-z_pes / 100 )  ) / lv_compta_equip ).
            ""<< FI MODIF ETODR SPEC-61918
          ENDIF.

        ELSE.
          ls_calcul_coautor-z_punts             = CONV z_punts( ls_calcul_coautor-z_punts_abans_pes * ( lv_pes / 100 ) ).
        ENDIF.
        ls_calcul_coautor-z_punts_pes         = ls_calcul_coautor-z_punts.
        ls_calcul_coautor-z_carrec_equip      = <fs_equip_oferta>-z_carrec_equip.

        READ TABLE lt_calcul_coautor TRANSPORTING NO FIELDS WITH KEY z_comptador_equip  = ls_calcul_coautor-z_comptador_equip
                                                                     z_carrec_equip     = <fs_equip_oferta>-z_carrec_equip.
        IF sy-subrc <> 0.
          APPEND ls_calcul_coautor TO lt_calcul_coautor.
        ENDIF.
      ENDLOOP.
      "En aquest punt crec que tenim els totals ja ponderats per cada membre de cada càrrec de cada oferta.
      DATA(lt_carrecs) = lt_calcul_coautor.
      ">> INI MODIF ETODR SPEC-62360
*      SORT lt_carrecs BY z_carrec_equip.
*      DELETE ADJACENT DUPLICATES FROM lt_carrecs COMPARING z_carrec_equip.
      SORT lt_carrecs BY z_comptador_equip z_carrec_equip .
      DELETE ADJACENT DUPLICATES FROM lt_carrecs COMPARING z_comptador_equip z_carrec_equip.
      "<< FI MODIF ETODR SPEC-62360

      CLEAR: lv_suma_crit_puntuats, lt_calcul_coaut_carrecs[].

      LOOP AT lt_carrecs ASSIGNING FIELD-SYMBOL(<fs_carrec>).
        CLEAR: lv_suma_crit_puntuats, lv_compta_equip.
        LOOP AT lt_calcul_coautor ASSIGNING FIELD-SYMBOL(<fs_calcul_coautor>) WHERE z_carrec_equip    = <fs_carrec>-z_carrec_equip
                                                                                AND z_comptador_equip = <fs_carrec>-z_comptador_equip. "MODIF ETODR SPEC-62360
          "Puntuació total de cada grup de càrrecs
          "">> INI MODIF ETODR SPEC-61918
*          lv_suma_crit_puntuats    = <fs_calcul_coautor>-z_punts + lv_suma_crit_puntuats.
          lv_suma_crit_puntuats    = <fs_calcul_coautor>-z_punts_noround + lv_suma_crit_puntuats.
          ""<< FI MODIF ETODR SPEC-61918
          ADD 1 TO lv_compta_equip.
        ENDLOOP.

        IF lv_compta_equip = 0.
          lv_compta_equip = 1.
        ENDIF.

        READ TABLE lt_calcul_coaut_carrecs ASSIGNING FIELD-SYMBOL(<fs_total_coaut_carrecs>) WITH KEY z_carrec_equip    = <fs_carrec>-z_carrec_equip
                                                                                                     z_comptador_equip = <fs_carrec>-z_comptador_equip. "MODIF ETODR SPEC-62360
        IF sy-subrc <> 0.
          CLEAR: ls_calcul_coautor.
          ls_calcul_coautor-z_carrec_equip    = <fs_carrec>-z_carrec_equip.
          ls_calcul_coautor-z_carrec_equip    = <fs_carrec>-z_carrec_equip.
          ls_calcul_coautor-z_num_ofer        = <fs_carrec>-z_num_ofer.
          ls_calcul_coautor-z_comptador_equip = <fs_carrec>-z_comptador_equip.
          ls_calcul_coautor-z_total_carrec    = lv_suma_crit_puntuats." / lv_compta_equip.
          APPEND ls_calcul_coautor TO lt_calcul_coaut_carrecs.
        ELSE.

          <fs_total_coaut_carrecs>-z_total_carrec = ( <fs_total_coaut_carrecs>-z_total_carrec + lv_suma_crit_puntuats )." / lv_compta_equip.
        ENDIF.
      ENDLOOP.


      APPEND LINES OF lt_calcul_coautor TO et_dades_coautors.

      LOOP AT et_dades_coautors ASSIGNING FIELD-SYMBOL(<fs_result>) WHERE z_num_ofer = lv_index_oferta.
        READ TABLE lt_calcul_coaut_carrecs ASSIGNING <fs_total_coaut_carrecs> WITH KEY z_carrec_equip    = <fs_result>-z_carrec_equip
                                                                                       z_comptador_equip = <fs_result>-z_comptador_equip
                                                                                       z_num_ofer        = <fs_result>-z_num_ofer.
        IF sy-subrc = 0.
          <fs_result>-z_total_carrec = <fs_total_coaut_carrecs>-z_total_carrec.
        ENDIF.
      ENDLOOP.
    ENDLOOP.

  ENDMETHOD.


  METHOD get_calcul_coefiref.

    DATA: lt_calcul_coefiref         TYPE ztt_equip_coautor,
          ls_calcul_coefiref         TYPE zst_equip_coautor,
          lt_calcul_coefiref_carrecs TYPE ztt_equip_coautor,
          lv_compta_equip            TYPE i,
          lv_suma_crit_puntuats      TYPE decfloat34.

    DATA(lt_crit_punt) = my_crit_punt.

    DATA lv_num_plec TYPE z_num_plec.


    DATA(lt_num_equips) = gt_equip[].
    SORT lt_num_equips BY z_num_ofer z_comptador_equip z_carrec_equip.
    DELETE lt_num_equips WHERE z_is_header EQ abap_true.
    DELETE ADJACENT DUPLICATES FROM lt_num_equips COMPARING z_num_ofer z_comptador_equip z_carrec_equip.
    DESCRIBE TABLE lt_num_equips LINES DATA(lv_num_equips).

    get_punts_gen_equi( IMPORTING et_punts_gen_equi = DATA(lt_punt_gen) ).

    DATA(lt_num_ofertes) = my_punt_ofer[].
    DELETE ADJACENT DUPLICATES FROM lt_num_ofertes COMPARING z_num_gen.
    DESCRIBE TABLE lt_num_ofertes LINES DATA(l_num_ofertes).

    DATA(lt_punt_gen_aux) = my_punt_ofer.

    SELECT *
      FROM zrm_dt_punt_equi
      INTO TABLE @DATA(lt_equip_basic_bd)
       FOR ALL ENTRIES IN @lt_num_equips
     WHERE docclass      = @lt_num_equips-docclass
       AND objectid      = @lt_num_equips-objectid
       AND z_equip_basic = @abap_on
       AND z_num_ofer    = @lt_num_equips-z_num_ofer.

    "Primer actualitzem les puntuacions
    LOOP AT lt_num_ofertes ASSIGNING FIELD-SYMBOL(<fs_oferta>).
      DATA(lv_index_oferta_aux) = CONV z_num_ofer( <fs_oferta>-z_num_gen ).
      LOOP AT lt_punt_gen ASSIGNING FIELD-SYMBOL(<fs_punt_gen>) WHERE z_num_gen      = lv_index_oferta_aux.
        LOOP AT lt_punt_gen_aux ASSIGNING FIELD-SYMBOL(<fs_punts_aux>) WHERE z_num_gen        = <fs_punt_gen>-z_num_gen
                                                                         AND z_carrec_equip   = <fs_punt_gen>-z_carrec_equip
                                                                         AND z_codi_crit_punt = <fs_punt_gen>-z_codi_crit_punt
                                                                         AND z_num_equip      = <fs_punt_gen>-z_num_equip.
          <fs_punts_aux>-z_punts          = <fs_punt_gen>-z_punts.
          <fs_punts_aux>-z_punts_no_pond  = <fs_punt_gen>-z_punts.
        ENDLOOP.
      ENDLOOP.
    ENDLOOP.

    "Recuperem la fórmula del PDM del Plec
    LOOP AT lt_crit_punt ASSIGNING FIELD-SYMBOL(<fs_crit_punt>) WHERE z_coeficient_iref <> space
                                                                  AND z_sumatori        IS NOT INITIAL.
      DATA(lv_sum_info)      = <fs_crit_punt>-sum_info.
      DATA(l_crit_punt_pare) = <fs_crit_punt>-z_codi_crit_punt.
    ENDLOOP.

    LOOP AT lt_num_ofertes ASSIGNING FIELD-SYMBOL(<fs_loop_oferta>).
      DATA(lv_index_oferta) = CONV z_num_ofer( <fs_loop_oferta>-z_num_gen ).
      CLEAR: lt_calcul_coefiref[].
      LOOP AT lt_num_equips ASSIGNING FIELD-SYMBOL(<fs_equip_oferta>) WHERE z_num_ofer = lv_index_oferta AND z_is_header IS INITIAL.
        DATA(lv_comptador_equip)  = CONV z_compta_equip( <fs_equip_oferta>-z_comptador_equip ).
        CLEAR: ls_calcul_coefiref.
        ls_calcul_coefiref-z_comptador_equip = <fs_equip_oferta>-z_comptador_equip.
        ls_calcul_coefiref-z_num_ofer        = lv_index_oferta.
        "Càlcul de la puntuació sense aplicar el factor de correcció del PDM
        LOOP AT lt_punt_gen_aux ASSIGNING FIELD-SYMBOL(<fs_punts>) WHERE z_num_gen      = lv_index_oferta
                                                                 AND z_num_equip    = lv_comptador_equip
                                                                 AND z_carrec_equip = <fs_equip_oferta>-z_carrec_equip.
          ls_calcul_coefiref-z_punts_abans_pes = ls_calcul_coefiref-z_punts_abans_pes + <fs_punts>-z_punts.
        ENDLOOP.
        IF sy-subrc NE 0.
          LOOP AT lt_punt_gen ASSIGNING FIELD-SYMBOL(<fs_pun_gen>)  WHERE z_num_gen      = lv_index_oferta
                                                                   AND z_num_equip    = lv_comptador_equip
                                                                   AND z_carrec_equip = <fs_equip_oferta>-z_carrec_equip.

            ls_calcul_coefiref-z_punts_abans_pes = ls_calcul_coefiref-z_punts_abans_pes + <fs_pun_gen>-z_punts.
          ENDLOOP.
        ENDIF.
        IF <fs_crit_punt> IS ASSIGNED.
          READ TABLE <fs_crit_punt>-sum_info ASSIGNING FIELD-SYMBOL(<fs_sum_info>)
             WITH KEY z_codi_crit_punt = <fs_equip_oferta>-z_codi_crit_punt.

        ENDIF.
        DATA(lv_pes)                         = CONV i( <fs_equip_oferta>-z_pes ).
        ls_calcul_coefiref-z_pes               = CONV i( <fs_equip_oferta>-z_pes ).
        IF <fs_sum_info> IS ASSIGNED.
          CLEAR lv_compta_equip.

          "1. Consultar el plec a la taula zrm_plec_coaut_a
          SELECT SINGLE z_num_plec INTO lv_num_plec
            FROM  zrm_plec_coaut_a
            WHERE z_num_plec = me->my_exp_cont-z_num_plec.
          IF sy-subrc = 0.
            "Si el plec surt a la taula, en el loop no fer la condició z_comptador_equip
            LOOP AT lt_num_equips TRANSPORTING NO FIELDS
            WHERE z_num_ofer = lv_index_oferta AND z_carrec_equip = <fs_equip_oferta>-z_carrec_equip.
              ADD 1 TO lv_compta_equip.
            ENDLOOP.
          ELSE.
            LOOP AT lt_num_equips TRANSPORTING NO FIELDS
              WHERE z_num_ofer = lv_index_oferta AND z_carrec_equip = <fs_equip_oferta>-z_carrec_equip
                AND z_comptador_equip = ls_calcul_coefiref-z_comptador_equip.
              ADD 1 TO lv_compta_equip.
            ENDLOOP.
          ENDIF.

          READ TABLE lt_equip_basic_bd ASSIGNING FIELD-SYMBOL(<fs_bs>)
           WITH KEY z_num_ofer = <fs_equip_oferta>-z_num_ofer
                    z_carrec_equip = <fs_equip_oferta>-z_carrec_equip
                    z_comptador_equip = ls_calcul_coefiref-z_comptador_equip.
          IF sy-subrc EQ 0.
            ls_calcul_coefiref-z_punts_noround = CONV #( ( ls_calcul_coefiref-z_punts_abans_pes * ( <fs_bs>-z_pes / 100 )  ) / lv_compta_equip ).
          ELSE.
            ls_calcul_coefiref-z_punts_noround = CONV #( ( ls_calcul_coefiref-z_punts_abans_pes * ( <fs_equip_oferta>-z_pes / 100 )  ) / lv_compta_equip ).
          ENDIF.

        ELSE.
          ls_calcul_coefiref-z_punts             = CONV z_punts( ls_calcul_coefiref-z_punts_abans_pes * ( lv_pes / 100 ) ).
        ENDIF.
        ls_calcul_coefiref-z_punts_pes         = ls_calcul_coefiref-z_punts.
        ls_calcul_coefiref-z_carrec_equip      = <fs_equip_oferta>-z_carrec_equip.

        READ TABLE lt_calcul_coefiref TRANSPORTING NO FIELDS WITH KEY z_comptador_equip  = ls_calcul_coefiref-z_comptador_equip
                                                                      z_carrec_equip     = <fs_equip_oferta>-z_carrec_equip.
        IF sy-subrc <> 0.
          APPEND ls_calcul_coefiref TO lt_calcul_coefiref.
        ENDIF.
      ENDLOOP.
      "En aquest punt crec que tenim els totals ja ponderats per cada membre de cada càrrec de cada oferta.
      DATA(lt_carrecs) = lt_calcul_coefiref.
      SORT lt_carrecs BY z_comptador_equip z_carrec_equip .
      DELETE ADJACENT DUPLICATES FROM lt_carrecs COMPARING z_comptador_equip z_carrec_equip.

      CLEAR: lv_suma_crit_puntuats, lt_calcul_coefiref_carrecs[].

      LOOP AT lt_carrecs ASSIGNING FIELD-SYMBOL(<fs_carrec>).
        CLEAR: lv_suma_crit_puntuats, lv_compta_equip.
        LOOP AT lt_calcul_coefiref ASSIGNING FIELD-SYMBOL(<fs_calcul_coautor>) WHERE z_carrec_equip    = <fs_carrec>-z_carrec_equip
                                                                                AND z_comptador_equip = <fs_carrec>-z_comptador_equip.
          "Puntuació total de cada grup de càrrecs
          lv_suma_crit_puntuats    = <fs_calcul_coautor>-z_punts_noround + lv_suma_crit_puntuats.
          ADD 1 TO lv_compta_equip.
        ENDLOOP.

        IF lv_compta_equip = 0.
          lv_compta_equip = 1.
        ENDIF.

        READ TABLE lt_calcul_coefiref_carrecs ASSIGNING FIELD-SYMBOL(<fs_total_coaut_carrecs>) WITH KEY z_carrec_equip    = <fs_carrec>-z_carrec_equip
                                                                                                     z_comptador_equip = <fs_carrec>-z_comptador_equip.
        IF sy-subrc <> 0.
          CLEAR: ls_calcul_coefiref.
          ls_calcul_coefiref-z_carrec_equip    = <fs_carrec>-z_carrec_equip.
          ls_calcul_coefiref-z_carrec_equip    = <fs_carrec>-z_carrec_equip.
          ls_calcul_coefiref-z_num_ofer        = <fs_carrec>-z_num_ofer.
          ls_calcul_coefiref-z_comptador_equip = <fs_carrec>-z_comptador_equip.
          ls_calcul_coefiref-z_total_carrec    = lv_suma_crit_puntuats." / lv_compta_equip.
          APPEND ls_calcul_coefiref TO lt_calcul_coefiref_carrecs.
        ELSE.

          <fs_total_coaut_carrecs>-z_total_carrec = ( <fs_total_coaut_carrecs>-z_total_carrec + lv_suma_crit_puntuats ).
        ENDIF.
      ENDLOOP.


      APPEND LINES OF lt_calcul_coefiref TO et_dades_coefiref.

      LOOP AT et_dades_coefiref ASSIGNING FIELD-SYMBOL(<fs_result>) WHERE z_num_ofer = lv_index_oferta.
        READ TABLE lt_calcul_coefiref_carrecs ASSIGNING <fs_total_coaut_carrecs> WITH KEY z_carrec_equip    = <fs_result>-z_carrec_equip
                                                                                       z_comptador_equip = <fs_result>-z_comptador_equip
                                                                                       z_num_ofer        = <fs_result>-z_num_ofer.
        IF sy-subrc = 0.
          <fs_result>-z_total_carrec = <fs_total_coaut_carrecs>-z_total_carrec.
        ENDIF.
      ENDLOOP.
    ENDLOOP.

  ENDMETHOD.


  METHOD get_calcul_pdm_coautors.

    DATA: lt_calcul_pdm            TYPE zrm_tt_calculs_pdm,
          lt_calcul_pdm_carrecs    TYPE zrm_tt_calculs_pdm,
          wa_calcul_pdm            TYPE zrm_ts_calculs_pdm,
          lv_suma_crit_puntuats    TYPE decfloat34,
          lv_suma_crit_punt_no_pes TYPE decfloat34,
          lv_suma_dedic_ofert      TYPE decfloat34,
          lv_suma_crit_max         TYPE z_punts,
          lv_puntuacio_pdm         TYPE char10,
          lv_resultat_formula_pdm  TYPE decfloat34,
          lv_total_pdm             TYPE decfloat34,
          lv_punts_recalculats     TYPE z_punts.

    DATA(lt_crit_punt) = my_crit_punt.
    READ TABLE gt_equip TRANSPORTING NO FIELDS WITH KEY z_equip_pdm = abap_on.
    CHECK sy-subrc = 0.

    DATA(lt_num_equips) = gt_equip[].
    SORT lt_num_equips BY z_num_ofer z_comptador_equip.
    DELETE ADJACENT DUPLICATES FROM lt_num_equips COMPARING z_num_ofer z_comptador_equip.
    DESCRIBE TABLE lt_num_equips LINES DATA(lv_num_equips).

    get_punts_gen_equi( IMPORTING et_punts_gen_equi = DATA(lt_punt_gen) ).

    DATA(lt_num_ofertes) = my_punt_ofer[].
    DELETE ADJACENT DUPLICATES FROM lt_num_ofertes COMPARING z_num_gen.
    DESCRIBE TABLE lt_num_ofertes LINES DATA(l_num_ofertes).

    DATA(lt_punt_gen_aux) = my_punt_ofer.

    "Primer actualitzem les puntuacions
    LOOP AT lt_num_ofertes ASSIGNING FIELD-SYMBOL(<fs_oferta>).
      DATA(lv_index_oferta_aux) = CONV z_num_ofer( <fs_oferta>-z_num_gen ).
      LOOP AT lt_punt_gen ASSIGNING FIELD-SYMBOL(<fs_punt_gen>) WHERE z_num_gen      = lv_index_oferta_aux.
        LOOP AT lt_punt_gen_aux ASSIGNING FIELD-SYMBOL(<fs_punts_aux>) WHERE z_num_gen        = <fs_punt_gen>-z_num_gen
                                                                         AND z_carrec_equip   = <fs_punt_gen>-z_carrec_equip
                                                                         AND z_codi_crit_punt = <fs_punt_gen>-z_codi_crit_punt
                                                                         AND z_num_equip      = <fs_punt_gen>-z_num_equip.
          <fs_punts_aux>-z_punts          = <fs_punt_gen>-z_punts.
          <fs_punts_aux>-z_punts_no_pond  = <fs_punt_gen>-z_punts.
        ENDLOOP.
      ENDLOOP.
    ENDLOOP.

    "Recuperem la fórmula del PDM del Plec
    LOOP AT lt_crit_punt ASSIGNING FIELD-SYMBOL(<fs_crit_punt>) WHERE z_equip_pdm EQ abap_on
                                                                  AND z_sumatori IS NOT INITIAL.
      DATA(lv_formula_pdm)   = <fs_crit_punt>-z_formula_pdm.
      DATA(lv_sum_info)      = <fs_crit_punt>-sum_info.
      DATA(l_crit_punt_pare) = <fs_crit_punt>-z_codi_crit_punt.
    ENDLOOP.

    LOOP AT lt_num_ofertes ASSIGNING FIELD-SYMBOL(<fs_loop_oferta>). "SPEC-50770
      "Per cada criteri de cada oferta diferent de cada equip de GT_EQUIPS amb la marca de EQUIP_PDM = , s'omple la taula LT_CALCUL_PDM
      DATA(lv_index_oferta) = CONV z_num_ofer( <fs_loop_oferta>-z_num_gen ).
      CLEAR: lt_calcul_pdm[].
      LOOP AT lt_num_equips ASSIGNING FIELD-SYMBOL(<fs_equip_oferta>) WHERE z_num_ofer = lv_index_oferta.
        DATA(lv_comptador_equip)  = CONV z_compta_equip( <fs_equip_oferta>-z_comptador_equip ).
        CLEAR: wa_calcul_pdm.
        wa_calcul_pdm-z_comptador_equip = <fs_equip_oferta>-z_comptador_equip.
        wa_calcul_pdm-z_num_ofer        = lv_index_oferta.
        "Càlcul de la puntuació sense aplicar el factor de correcció del PDM
        LOOP AT lt_punt_gen_aux ASSIGNING FIELD-SYMBOL(<fs_punts>) WHERE z_num_gen      = lv_index_oferta
                                                                 AND z_num_equip    = lv_comptador_equip.
          wa_calcul_pdm-z_punts_abans_formula_pdm = wa_calcul_pdm-z_punts_abans_formula_pdm + <fs_punts>-z_punts.
        ENDLOOP.

*>> SPEC-60778, Inici modificació - ETLJS
      IF sy-subrc NE 0.
        LOOP AT LT_PUNT_GEN ASSIGNING FIELD-SYMBOL(<fs_pun_gen>)  WHERE z_num_gen      = lv_index_oferta
        AND z_num_equip    = lv_comptador_equip.

          wa_calcul_pdm-z_punts_abans_formula_pdm = wa_calcul_pdm-z_punts_abans_formula_pdm + <fs_pun_gen>-z_punts.
        ENDLOOP.
      ENDIF.
*<< SPEC-60778, Final modificació - ETLJS
        DATA(lv_pes) = CONV i( <fs_equip_oferta>-z_pes ).
        wa_calcul_pdm-z_punts_abans_pes         = CONV z_punts( wa_calcul_pdm-z_punts_abans_formula_pdm ).
        wa_calcul_pdm-z_pes                     = CONV i( <fs_equip_oferta>-z_pes ).
        wa_calcul_pdm-z_punts_abans_formula_pdm = CONV z_punts( wa_calcul_pdm-z_punts_abans_formula_pdm * ( lv_pes / 100 ) ).
        "Busquem fórmula
        LOOP AT gt_equip ASSIGNING FIELD-SYMBOL(<fs_equip_pdm>) WHERE z_num_ofer         = lv_index_oferta
                                                                  AND z_comptador_equip  = lv_comptador_equip
                                                                  AND z_equip_pdm        = abap_on
                                                                  AND z_is_header        = abap_off.
          DATA(lv_formula_pdm_temporal) = lv_formula_pdm.
          ASSIGN COMPONENT 'Z_PUNT_MAX' OF STRUCTURE <fs_equip_pdm> TO FIELD-SYMBOL(<fs_puntuacio_pdm>).
          CHECK sy-subrc = 0.
          lv_puntuacio_pdm = CONV #( <fs_puntuacio_pdm> ).
          SHIFT lv_puntuacio_pdm LEFT DELETING LEADING space.
          REPLACE ALL OCCURRENCES OF '[PDM]' IN lv_formula_pdm_temporal WITH lv_puntuacio_pdm.
          CHECK sy-subrc = 0.
          CLEAR: lv_resultat_formula_pdm.
          CALL FUNCTION 'EVAL_FORMULA'
            EXPORTING
              formula = lv_formula_pdm_temporal
              program = sy-repid
            IMPORTING
              value   = lv_resultat_formula_pdm
            EXCEPTIONS
              OTHERS  = 11.
          CHECK sy-subrc = 0.
          wa_calcul_pdm-z_formula_pdm         = lv_resultat_formula_pdm.
          wa_calcul_pdm-z_carrec_equip        = <fs_equip_pdm>-z_carrec_equip.
          wa_calcul_pdm-z_dedicacio_ofertada  = <fs_equip_pdm>-z_dedicacio_ofertada.
          EXIT.
        ENDLOOP.

        READ TABLE lt_calcul_pdm TRANSPORTING NO FIELDS WITH KEY z_comptador_equip  = wa_calcul_pdm-z_comptador_equip.
        IF sy-subrc <> 0.
          APPEND wa_calcul_pdm TO lt_calcul_pdm.
        ENDIF.
      ENDLOOP.
      "En aquest punt crec que tenim els totals ja ponderats per cada membre de cada càrrec de cada oferta.
      "S'ha d'aplicar lògica nova:
      DATA(lt_carrecs) = lt_calcul_pdm.
      SORT lt_carrecs BY z_carrec_equip.
      DELETE ADJACENT DUPLICATES FROM lt_carrecs COMPARING z_carrec_equip.
      LOOP AT lt_calcul_pdm ASSIGNING FIELD-SYMBOL(<fs_calcul_pdm>).
        <fs_calcul_pdm>-z_total_pdm        = <fs_calcul_pdm>-z_formula_pdm * <fs_calcul_pdm>-z_punts_abans_formula_pdm.
        <fs_calcul_pdm>-z_punts_no_pes_pdm = <fs_calcul_pdm>-z_punts_abans_pes * <fs_calcul_pdm>-z_formula_pdm.
      ENDLOOP.

      CLEAR: lv_suma_dedic_ofert, lv_suma_crit_puntuats, lt_calcul_pdm_carrecs[], lv_suma_crit_punt_no_pes.

      LOOP AT lt_carrecs ASSIGNING FIELD-SYMBOL(<fs_carrec>).
        CLEAR: lv_suma_dedic_ofert, lv_suma_crit_puntuats, lv_suma_crit_punt_no_pes.
        LOOP AT lt_calcul_pdm ASSIGNING <fs_calcul_pdm> WHERE z_carrec_equip = <fs_carrec>-z_carrec_equip.
          "Puntuació total de cada grup de càrrecs = Suma( Puntuació Total membre equip càrrec X * Dedicació Ofertada membre equip càrrec X)  / Suma(dedicacións ofertades membres equip càrrec X)
          lv_suma_crit_puntuats    = ( <fs_calcul_pdm>-z_total_pdm * <fs_calcul_pdm>-z_dedicacio_ofertada ) + lv_suma_crit_puntuats.
          lv_suma_crit_punt_no_pes = ( <fs_calcul_pdm>-z_punts_no_pes_pdm * <fs_calcul_pdm>-z_dedicacio_ofertada ).

          <fs_calcul_pdm>-z_punts_ajustats = lv_suma_crit_punt_no_pes.
        ENDLOOP.
        LOOP AT lt_calcul_pdm ASSIGNING <fs_calcul_pdm> WHERE z_carrec_equip = <fs_carrec>-z_carrec_equip.
          "Puntuació total de cada grup de càrrecs = Suma( Puntuació Total membre equip càrrec X * Dedicació Ofertada membre equip càrrec X)  / Suma(dedicacións ofertades membres equip càrrec X)
          lv_suma_dedic_ofert = <fs_calcul_pdm>-z_dedicacio_ofertada + lv_suma_dedic_ofert.

        ENDLOOP.
        LOOP AT lt_calcul_pdm ASSIGNING <fs_calcul_pdm> WHERE z_carrec_equip = <fs_carrec>-z_carrec_equip.
          IF lv_suma_dedic_ofert > 0.
            <fs_calcul_pdm>-z_punts_ajustats = <fs_calcul_pdm>-z_punts_ajustats / lv_suma_dedic_ofert.
          ELSE.
            <fs_calcul_pdm>-z_punts_ajustats = 0.
          ENDIF.
        ENDLOOP.
        IF lv_suma_dedic_ofert > 0.
          lv_suma_crit_puntuats = lv_suma_crit_puntuats / lv_suma_dedic_ofert.
        ELSE.
          lv_suma_crit_puntuats = 0.
        ENDIF.

        READ TABLE lt_calcul_pdm_carrecs ASSIGNING FIELD-SYMBOL(<fs_total_pdm_carrecs>) WITH KEY z_carrec_equip = <fs_carrec>-z_carrec_equip.
        IF sy-subrc <> 0.
          CLEAR: wa_calcul_pdm.
          wa_calcul_pdm-z_carrec_equip    = <fs_carrec>-z_carrec_equip.
          wa_calcul_pdm-z_carrec_equip    = <fs_carrec>-z_carrec_equip.
          wa_calcul_pdm-z_num_ofer        = <fs_carrec>-z_num_ofer.
          wa_calcul_pdm-z_comptador_equip = <fs_carrec>-z_comptador_equip.
          wa_calcul_pdm-z_total_carrec    = lv_suma_crit_puntuats.
          APPEND wa_calcul_pdm TO lt_calcul_pdm_carrecs.
        ELSE.
          <fs_total_pdm_carrecs>-z_total_carrec = <fs_total_pdm_carrecs>-z_total_carrec + lv_suma_crit_puntuats.
        ENDIF.
      ENDLOOP.


      APPEND LINES OF lt_calcul_pdm TO et_dades_pdm_coautors.
      LOOP AT et_dades_pdm_coautors ASSIGNING FIELD-SYMBOL(<fs_result>) WHERE z_num_ofer = lv_index_oferta.
        READ TABLE lt_calcul_pdm_carrecs ASSIGNING <fs_total_pdm_carrecs> WITH KEY z_carrec_equip    = <fs_result>-z_carrec_equip
                                                                                   z_comptador_equip = <fs_result>-z_comptador_equip
                                                                                   z_num_ofer        = <fs_result>-z_num_ofer.
        IF sy-subrc = 0.
          <fs_result>-z_total_carrec = <fs_total_pdm_carrecs>-z_total_carrec.
        ENDIF.
      ENDLOOP.


    ENDLOOP.
  ENDMETHOD.


  METHOD get_calcul_pdm_coautors_sep.

    DATA: lt_calcul_pdm            TYPE zrm_tt_calculs_pdm,
          lt_calcul_pdm_carrecs    TYPE zrm_tt_calculs_pdm,
          wa_calcul_pdm            TYPE zrm_ts_calculs_pdm,
          lv_suma_crit_puntuats    TYPE decfloat34,
          lv_suma_crit_punt_no_pes TYPE decfloat34,
          lv_suma_dedic_ofert      TYPE decfloat34,
          lv_suma_crit_max         TYPE z_punts,
          lv_puntuacio_pdm         TYPE char10,
          lv_resultat_formula_pdm  TYPE decfloat34,
          lv_total_pdm             TYPE decfloat34,
          lv_punts_recalculats     TYPE z_punts.



    DATA(lt_crit_punt) = my_crit_punt.
    READ TABLE gt_equip TRANSPORTING NO FIELDS WITH KEY z_equip_pdm = abap_on.
    CHECK sy-subrc = 0.

    DATA(lt_num_equips) = gt_equip[].
    SORT lt_num_equips BY z_num_ofer z_comptador_equip.
    DELETE ADJACENT DUPLICATES FROM lt_num_equips COMPARING z_num_ofer z_comptador_equip.
    DESCRIBE TABLE lt_num_equips LINES DATA(lv_num_equips).

    get_punts_gen_equi( IMPORTING et_punts_gen_equi = DATA(lt_punt_gen) ).

    DATA(lt_num_ofertes) = my_punt_ofer[].
    DELETE ADJACENT DUPLICATES FROM lt_num_ofertes COMPARING z_num_gen.
    DESCRIBE TABLE lt_num_ofertes LINES DATA(l_num_ofertes).

    DATA(lt_punt_gen_aux) = my_punt_ofer.

    "Primer actualitzem les puntuacions
    LOOP AT lt_num_ofertes ASSIGNING FIELD-SYMBOL(<fs_oferta>).
      DATA(lv_index_oferta_aux) = CONV z_num_ofer( <fs_oferta>-z_num_gen ).
      LOOP AT lt_punt_gen ASSIGNING FIELD-SYMBOL(<fs_punt_gen>) WHERE z_num_gen      = lv_index_oferta_aux.
        LOOP AT lt_punt_gen_aux ASSIGNING FIELD-SYMBOL(<fs_punts_aux>) WHERE z_num_gen        = <fs_punt_gen>-z_num_gen
                                                                         AND z_carrec_equip   = <fs_punt_gen>-z_carrec_equip
                                                                         AND z_codi_crit_punt = <fs_punt_gen>-z_codi_crit_punt
                                                                         AND z_num_equip      = <fs_punt_gen>-z_num_equip.
          <fs_punts_aux>-z_punts          = <fs_punt_gen>-z_punts.
          <fs_punts_aux>-z_punts_no_pond  = <fs_punt_gen>-z_punts.
        ENDLOOP.
      ENDLOOP.
    ENDLOOP.

    "Recuperem la fórmula del PDM del Plec de cada equip PDM existent, pot ser diferent..
    LOOP AT lt_crit_punt ASSIGNING FIELD-SYMBOL(<fs_crit_punt>) WHERE z_equip_pdm EQ abap_on
                                                                  AND z_sumatori IS NOT INITIAL.
      CLEAR: wa_calcul_pdm.
      DATA(lv_formula_pdm)   = <fs_crit_punt>-z_formula_pdm.
      DATA(lt_sum_info)      = <fs_crit_punt>-sum_info.
      DATA(lv_crit_punt_pare) = <fs_crit_punt>-z_codi_crit_punt.

      LOOP AT lt_num_ofertes ASSIGNING FIELD-SYMBOL(<fs_loop_oferta>).
        "Per cada criteri de cada oferta diferent de cada equip de GT_EQUIPS amb la marca de EQUIP_PDM = , s'omple la taula LT_CALCUL_PDM
        DATA(lv_index_oferta) = CONV z_num_ofer( <fs_loop_oferta>-z_num_gen ).
        CLEAR: lt_calcul_pdm[].
        LOOP AT lt_num_equips ASSIGNING FIELD-SYMBOL(<fs_equip_oferta>) WHERE z_num_ofer = lv_index_oferta.
          DATA(lv_comptador_equip)  = CONV z_compta_equip( <fs_equip_oferta>-z_comptador_equip ).
          CLEAR: wa_calcul_pdm.
          wa_calcul_pdm-z_comptador_equip = <fs_equip_oferta>-z_comptador_equip.
          wa_calcul_pdm-z_num_ofer        = lv_index_oferta.
          wa_calcul_pdm-z_codi_crit_punt  = lv_crit_punt_pare.
          "Càlcul de la puntuació sense aplicar el factor de correcció del PDM
          LOOP AT lt_sum_info ASSIGNING FIELD-SYMBOL(<fs_sum_info>).
            LOOP AT lt_punt_gen ASSIGNING FIELD-SYMBOL(<fs_punts>) WHERE z_num_gen        = lv_index_oferta
*            LOOP AT lt_punt_gen_aux ASSIGNING FIELD-SYMBOL(<fs_punts>) WHERE z_num_gen        = lv_index_oferta
                                                                         AND z_num_equip      = lv_comptador_equip
                                                                         AND z_codi_crit_punt = <fs_sum_info>-z_codi_crit_punt.
              wa_calcul_pdm-z_punts_abans_formula_pdm = wa_calcul_pdm-z_punts_abans_formula_pdm + <fs_punts>-z_punts.
            ENDLOOP.
          ENDLOOP.
          IF sy-subrc NE 0.
            LOOP AT lt_punt_gen ASSIGNING FIELD-SYMBOL(<fs_pun_gen>)  WHERE z_num_gen      = lv_index_oferta
            AND z_num_equip    = lv_comptador_equip.

              wa_calcul_pdm-z_punts_abans_formula_pdm = wa_calcul_pdm-z_punts_abans_formula_pdm + <fs_pun_gen>-z_punts.
            ENDLOOP.
          ENDIF.
          DATA(lv_pes) = CONV i( <fs_equip_oferta>-z_pes ).
          wa_calcul_pdm-z_punts_abans_pes         = CONV z_punts( wa_calcul_pdm-z_punts_abans_formula_pdm ).
          wa_calcul_pdm-z_pes                     = CONV i( <fs_equip_oferta>-z_pes ).
          wa_calcul_pdm-z_punts_abans_formula_pdm = CONV z_punts( wa_calcul_pdm-z_punts_abans_formula_pdm * ( lv_pes / 100 ) ).
          "Busquem fórmula
          LOOP AT lt_sum_info ASSIGNING <fs_sum_info>.
            LOOP AT gt_equip ASSIGNING FIELD-SYMBOL(<fs_equip_pdm>) WHERE z_num_ofer         = lv_index_oferta
                                                                      AND z_comptador_equip  = lv_comptador_equip
                                                                      AND z_equip_pdm        = abap_on
                                                                      AND z_is_header        = abap_off
                                                                      AND z_codi_crit_punt   = <fs_sum_info>-z_codi_crit_punt.
              DATA(lv_formula_pdm_temporal) = lv_formula_pdm.
              ASSIGN COMPONENT 'Z_PUNT_MAX' OF STRUCTURE <fs_equip_pdm> TO FIELD-SYMBOL(<fs_puntuacio_pdm>).
              CHECK sy-subrc = 0.
              lv_puntuacio_pdm = CONV #( <fs_puntuacio_pdm> ).
              SHIFT lv_puntuacio_pdm LEFT DELETING LEADING space.
              REPLACE ALL OCCURRENCES OF '[PDM]' IN lv_formula_pdm_temporal WITH lv_puntuacio_pdm.
              CHECK sy-subrc = 0.
              CLEAR: lv_resultat_formula_pdm.
              CALL FUNCTION 'EVAL_FORMULA'
                EXPORTING
                  formula = lv_formula_pdm_temporal
                  program = sy-repid
                IMPORTING
                  value   = lv_resultat_formula_pdm
                EXCEPTIONS
                  OTHERS  = 11.
              CHECK sy-subrc = 0.
              wa_calcul_pdm-z_formula_pdm         = lv_resultat_formula_pdm.
              wa_calcul_pdm-z_carrec_equip        = <fs_equip_pdm>-z_carrec_equip.
              wa_calcul_pdm-z_dedicacio_ofertada  = <fs_equip_pdm>-z_dedicacio_ofertada.
              EXIT.
            ENDLOOP.
            IF wa_calcul_pdm-z_formula_pdm IS NOT INITIAL.
              EXIT.
            ENDIF.
          ENDLOOP.

          READ TABLE lt_calcul_pdm TRANSPORTING NO FIELDS WITH KEY z_comptador_equip  = wa_calcul_pdm-z_comptador_equip
                                                                   z_num_ofer         = wa_calcul_pdm-z_num_ofer
                                                                   z_codi_crit_punt   = wa_calcul_pdm-z_codi_crit_punt.
          IF sy-subrc <> 0.
            APPEND wa_calcul_pdm TO lt_calcul_pdm.
          ENDIF.
        ENDLOOP.
        "En aquest punt crec que tenim els totals ja ponderats per cada membre de cada càrrec de cada oferta.
        "S'ha d'aplicar lògica nova:
        DATA(lt_carrecs) = lt_calcul_pdm.
        SORT lt_carrecs BY z_carrec_equip z_num_ofer z_codi_crit_punt.
        DELETE ADJACENT DUPLICATES FROM lt_carrecs COMPARING z_carrec_equip z_num_ofer z_codi_crit_punt.
        LOOP AT lt_calcul_pdm ASSIGNING FIELD-SYMBOL(<fs_calcul_pdm>).
          <fs_calcul_pdm>-z_total_pdm        = <fs_calcul_pdm>-z_formula_pdm * <fs_calcul_pdm>-z_punts_abans_formula_pdm.
          <fs_calcul_pdm>-z_punts_no_pes_pdm = <fs_calcul_pdm>-z_punts_abans_pes * <fs_calcul_pdm>-z_formula_pdm.
        ENDLOOP.

        CLEAR: lv_suma_dedic_ofert, lv_suma_crit_puntuats, lt_calcul_pdm_carrecs[], lv_suma_crit_punt_no_pes.

        LOOP AT lt_carrecs ASSIGNING FIELD-SYMBOL(<fs_carrec>).
          CLEAR: lv_suma_dedic_ofert, lv_suma_crit_puntuats, lv_suma_crit_punt_no_pes.
          LOOP AT lt_calcul_pdm ASSIGNING <fs_calcul_pdm> WHERE z_carrec_equip    = <fs_carrec>-z_carrec_equip
                                                            AND z_codi_crit_punt  = <fs_carrec>-z_codi_crit_punt
                                                            AND z_num_ofer        = <fs_carrec>-z_num_ofer.
            "Puntuació total de cada grup de càrrecs = Suma( Puntuació Total membre equip càrrec X * Dedicació Ofertada membre equip càrrec X)  / Suma(dedicacións ofertades membres equip càrrec X)
            lv_suma_crit_puntuats    = ( <fs_calcul_pdm>-z_total_pdm * <fs_calcul_pdm>-z_dedicacio_ofertada ) + lv_suma_crit_puntuats.
            lv_suma_crit_punt_no_pes = ( <fs_calcul_pdm>-z_punts_no_pes_pdm * <fs_calcul_pdm>-z_dedicacio_ofertada ).

            <fs_calcul_pdm>-z_punts_ajustats = lv_suma_crit_punt_no_pes.
          ENDLOOP.
          LOOP AT lt_calcul_pdm ASSIGNING <fs_calcul_pdm> WHERE z_carrec_equip    = <fs_carrec>-z_carrec_equip
                                                            AND z_codi_crit_punt  = <fs_carrec>-z_codi_crit_punt
                                                            AND z_num_ofer        = <fs_carrec>-z_num_ofer.
            "Puntuació total de cada grup de càrrecs = Suma( Puntuació Total membre equip càrrec X * Dedicació Ofertada membre equip càrrec X)  / Suma(dedicacións ofertades membres equip càrrec X)
            lv_suma_dedic_ofert = <fs_calcul_pdm>-z_dedicacio_ofertada + lv_suma_dedic_ofert.

          ENDLOOP.
          LOOP AT lt_calcul_pdm ASSIGNING <fs_calcul_pdm> WHERE z_carrec_equip = <fs_carrec>-z_carrec_equip.
            IF lv_suma_dedic_ofert > 0.
              <fs_calcul_pdm>-z_punts_ajustats = <fs_calcul_pdm>-z_punts_ajustats / lv_suma_dedic_ofert.
            ELSE.
              <fs_calcul_pdm>-z_punts_ajustats = 0.
            ENDIF.
          ENDLOOP.
          IF lv_suma_dedic_ofert > 0.
            lv_suma_crit_puntuats = lv_suma_crit_puntuats / lv_suma_dedic_ofert.
          ELSE.
            lv_suma_crit_puntuats = 0.
          ENDIF.

          READ TABLE lt_calcul_pdm_carrecs ASSIGNING FIELD-SYMBOL(<fs_total_pdm_carrecs>) WITH KEY z_carrec_equip   = <fs_carrec>-z_carrec_equip
                                                                                                   z_codi_crit_punt = lv_crit_punt_pare
                                                                                                   z_num_ofer       = <fs_carrec>-z_num_ofer.
          IF sy-subrc <> 0.
            CLEAR: wa_calcul_pdm.
            wa_calcul_pdm-z_carrec_equip    = <fs_carrec>-z_carrec_equip.
            wa_calcul_pdm-z_carrec_equip    = <fs_carrec>-z_carrec_equip.
            wa_calcul_pdm-z_num_ofer        = <fs_carrec>-z_num_ofer.
            wa_calcul_pdm-z_comptador_equip = <fs_carrec>-z_comptador_equip.
            wa_calcul_pdm-z_codi_crit_punt  = lv_crit_punt_pare.
            wa_calcul_pdm-z_total_carrec    = lv_suma_crit_puntuats.
            APPEND wa_calcul_pdm TO lt_calcul_pdm_carrecs.
          ELSE.
            <fs_total_pdm_carrecs>-z_total_carrec = <fs_total_pdm_carrecs>-z_total_carrec + lv_suma_crit_puntuats.
          ENDIF.
        ENDLOOP.


        APPEND LINES OF lt_calcul_pdm TO et_dades_pdm_coautors.
        LOOP AT et_dades_pdm_coautors ASSIGNING FIELD-SYMBOL(<fs_result>) WHERE z_num_ofer = lv_index_oferta.
          READ TABLE lt_calcul_pdm_carrecs ASSIGNING <fs_total_pdm_carrecs> WITH KEY z_carrec_equip    = <fs_result>-z_carrec_equip
                                                                                     z_comptador_equip = <fs_result>-z_comptador_equip
                                                                                     z_num_ofer        = <fs_result>-z_num_ofer
                                                                                     z_codi_crit_punt  = <fs_result>-z_codi_crit_punt.
          IF sy-subrc = 0.
            <fs_result>-z_total_carrec = <fs_total_pdm_carrecs>-z_total_carrec.
          ENDIF.
        ENDLOOP.


      ENDLOOP.
    ENDLOOP.
  ENDMETHOD.


  METHOD get_check_save_log.
    re_check_save_lot_pt = my_save_to_log_pt.
  ENDMETHOD.


METHOD get_consistency_info.
  IF my_opened IS INITIAL .
    RAISE EXCEPTION TYPE zcx_rm_valoracio .
  ENDIF .
  ex_consistency_offer    = my_consistency_offer.
  ex_consistency_lema     = my_consistency_lema .
  ex_consistency_sol_part = my_consistency_sol_part.
ENDMETHOD.


  METHOD get_crit_dyn_rel.
    DATA: wa_crit_rel TYPE zrm_cl_valoracio_ofertes_fe=>ty_s_crit_rel.
    ex_crit_dyn_rel = gt_crit_dyn_rel.
    ex_crit_punt    = my_crit_punt.
    IF ex_crit_dyn_rel IS INITIAL.
      LOOP AT my_crit_punt ASSIGNING FIELD-SYMBOL(<fs_crit_punt>).
        CLEAR: wa_crit_rel.
        wa_crit_rel-z_mod_crit_punt = <fs_crit_punt>-z_mod_crit_punt.
        wa_crit_rel-z_parent        = <fs_crit_punt>-z_codi_crit_punt.
        IF <fs_crit_punt>-sum_info IS NOT INITIAL.
          LOOP AT <fs_crit_punt>-sum_info ASSIGNING FIELD-SYMBOL(<fs_sum_info>).
            wa_crit_rel-z_child = <fs_sum_info>-z_codi_crit_punt.
            CHECK wa_crit_rel-z_parent IS NOT INITIAL.
            APPEND wa_crit_rel TO ex_crit_dyn_rel.
          ENDLOOP.
        ENDIF.
      ENDLOOP.
    ENDIF.
    ">>>SPEC-55448, Inici modificació  - ETODR
    IF ex_crit_dyn_rel_full IS SUPPLIED.
      CLEAR: ex_crit_dyn_rel_full.
      LOOP AT my_crit_punt ASSIGNING <fs_crit_punt>.
        CLEAR: wa_crit_rel.
        wa_crit_rel-z_mod_crit_punt = <fs_crit_punt>-z_mod_crit_punt.
        wa_crit_rel-z_parent        = <fs_crit_punt>-z_codi_crit_punt.
        IF <fs_crit_punt>-sum_info IS NOT INITIAL.
          LOOP AT <fs_crit_punt>-sum_info ASSIGNING <fs_sum_info>.
            wa_crit_rel-z_child = <fs_sum_info>-z_codi_crit_punt.
            CHECK wa_crit_rel-z_parent IS NOT INITIAL.
            APPEND wa_crit_rel TO ex_crit_dyn_rel_full.
          ENDLOOP.
        ELSE.
          wa_crit_rel-z_child = wa_crit_rel-z_parent.
          APPEND wa_crit_rel TO ex_crit_dyn_rel_full.
        ENDIF.
      ENDLOOP.
    ENDIF.
    "<<<SPEC-55448, Final modificació - ETODR
    et_crit_punt_all = my_crit_punt_all. "SPEC-85003
  ENDMETHOD.


METHOD get_crit_punt_lemes.
  DATA: ls_crit_punt LIKE LINE OF re_crit_punt,
        ls_punt_lema LIKE LINE OF my_punt_lema_db .

  IF my_opened IS INITIAL .
    RAISE EXCEPTION TYPE zcx_rm_valoracio .
  ENDIF .
  re_crit_punt = my_crit_punt_prop_graf .

  IF im_only_used_ones IS NOT INITIAL .
    LOOP AT my_punt_lema_db INTO ls_punt_lema WHERE z_codi_crit_punt NE co_codi_crit_total.
      READ TABLE re_crit_punt TRANSPORTING NO FIELDS
         WITH TABLE KEY z_mod_crit_punt  = ls_punt_lema-z_mod_crit_punt
                        z_codi_crit_punt = ls_punt_lema-z_codi_crit_punt .
      CHECK sy-subrc NE 0 .
      CLEAR ls_crit_punt .
      ls_crit_punt-z_codi_crit_punt = ls_punt_lema-z_codi_crit_punt .
      ls_crit_punt-z_mod_crit_punt  = ls_punt_lema-z_mod_crit_punt .
      ls_crit_punt-z_descripcio     = '??' .
      INSERT ls_crit_punt INTO TABLE re_crit_punt .
    ENDLOOP .
    LOOP AT re_crit_punt INTO ls_crit_punt .
      READ TABLE my_punt_lema_db TRANSPORTING NO FIELDS
         WITH KEY z_mod_crit_punt  = ls_crit_punt-z_mod_crit_punt
                  z_codi_crit_punt = ls_crit_punt-z_codi_crit_punt .
      IF sy-subrc NE 0 .
        DELETE re_crit_punt .
      ELSEIF ls_crit_punt-z_descripcio EQ '??' .
        SELECT SINGLE z_descripcio INTO ls_crit_punt-z_descripcio
                FROM zrm_dm_crit_punt
               WHERE     z_mod_crit_punt  EQ ls_crit_punt-z_mod_crit_punt
                     AND z_codi_crit_punt EQ ls_crit_punt-z_codi_crit_punt .
        MODIFY re_crit_punt FROM ls_crit_punt TRANSPORTING z_descripcio .
      ENDIF .
    ENDLOOP .
  ENDIF .
ENDMETHOD.


METHOD get_crit_punt_offers.
  DATA: ls_crit_punt LIKE LINE OF re_crit_punt,
        ls_punt_ofer LIKE LINE OF my_punt_ofer_db .
  IF my_opened IS INITIAL .
    RAISE EXCEPTION TYPE zcx_rm_valoracio .
  ENDIF .
  re_crit_punt = my_crit_punt .

  IF im_only_used_ones IS NOT INITIAL .
    LOOP AT my_punt_ofer_db INTO ls_punt_ofer WHERE z_codi_crit_punt NE co_codi_crit_total.
      READ TABLE re_crit_punt TRANSPORTING NO FIELDS
         WITH TABLE KEY z_mod_crit_punt  = ls_punt_ofer-z_mod_crit_punt
                        z_codi_crit_punt = ls_punt_ofer-z_codi_crit_punt .
      CHECK sy-subrc NE 0 .
      CLEAR ls_crit_punt .
      ls_crit_punt-z_codi_crit_punt = ls_punt_ofer-z_codi_crit_punt .
      ls_crit_punt-z_mod_crit_punt  = ls_punt_ofer-z_mod_crit_punt .
      ls_crit_punt-z_descripcio     = '??' .
      INSERT ls_crit_punt INTO TABLE re_crit_punt .
    ENDLOOP .
    LOOP AT re_crit_punt INTO ls_crit_punt .
      READ TABLE my_punt_ofer_db TRANSPORTING NO FIELDS
         WITH KEY z_mod_crit_punt  = ls_crit_punt-z_mod_crit_punt
                  z_codi_crit_punt = ls_crit_punt-z_codi_crit_punt .
      IF sy-subrc NE 0 .
        DELETE re_crit_punt .
      ELSEIF ls_crit_punt-z_descripcio EQ '??' .
        SELECT SINGLE z_descripcio INTO ls_crit_punt-z_descripcio
                FROM zrm_dm_crit_punt
               WHERE     z_mod_crit_punt  EQ ls_crit_punt-z_mod_crit_punt
                     AND z_codi_crit_punt EQ ls_crit_punt-z_codi_crit_punt .
        MODIFY re_crit_punt FROM ls_crit_punt TRANSPORTING z_descripcio .
      ENDIF .
    ENDLOOP .

  ENDIF .
ENDMETHOD.


  method GET_CRIT_PUNT_OFFERS_EQUI.
    re_crit_punt = my_crit_punt_equi.
  endmethod.


METHOD get_crit_punt_sol_part.
  DATA: ls_crit_punt     LIKE LINE OF re_crit_punt,
        ls_punt_sol_part LIKE LINE OF my_punt_sol_part_db .

  IF my_opened IS INITIAL .
    RAISE EXCEPTION TYPE zcx_rm_valoracio .
  ENDIF .
  re_crit_punt = my_crit_punt_sol_part .

  IF im_only_used_ones IS NOT INITIAL .
    LOOP AT my_punt_sol_part_db INTO ls_punt_sol_part WHERE z_codi_crit_punt NE co_codi_crit_total.
      READ TABLE re_crit_punt TRANSPORTING NO FIELDS
         WITH TABLE KEY z_mod_crit_punt  = ls_punt_sol_part-z_mod_crit_punt
                        z_codi_crit_punt = ls_punt_sol_part-z_codi_crit_punt .
      CHECK sy-subrc NE 0 .
      CLEAR ls_crit_punt .
      ls_crit_punt-z_codi_crit_punt = ls_punt_sol_part-z_codi_crit_punt .
      ls_crit_punt-z_mod_crit_punt  = ls_punt_sol_part-z_mod_crit_punt .
      ls_crit_punt-z_descripcio     = '??' .
      INSERT ls_crit_punt INTO TABLE re_crit_punt .
    ENDLOOP .
    LOOP AT re_crit_punt INTO ls_crit_punt .
      READ TABLE my_punt_sol_part_db  TRANSPORTING NO FIELDS
         WITH KEY z_mod_crit_punt  = ls_crit_punt-z_mod_crit_punt
                  z_codi_crit_punt = ls_crit_punt-z_codi_crit_punt .
      IF sy-subrc NE 0 .
        DELETE re_crit_punt .
      ELSEIF ls_crit_punt-z_descripcio EQ '??' .
        SELECT SINGLE z_descripcio INTO ls_crit_punt-z_descripcio
                FROM zrm_dm_crit_punt
               WHERE     z_mod_crit_punt  EQ ls_crit_punt-z_mod_crit_punt
                     AND z_codi_crit_punt EQ ls_crit_punt-z_codi_crit_punt .
        MODIFY re_crit_punt FROM ls_crit_punt TRANSPORTING z_descripcio .
      ENDIF .
    ENDLOOP .
  ENDIF .
ENDMETHOD.


  METHOD get_dades_ofer_dyn.
    ex_punt_ofer_dyn = gt_punt_ofer_dyn[].

    LOOP AT my_crit_punt ASSIGNING FIELD-SYMBOL(<fs_crit_punt>).
      READ TABLE gt_punt_ofer_dyn INTO DATA(wa_aplica) WITH KEY z_codi_crit_punt = <fs_crit_punt>-z_codi_crit_punt
                                                                z_mod_crit_punt  = <fs_crit_punt>-z_mod_crit_punt.
      IF sy-subrc = 0.
        <fs_crit_punt>-z_no_aplica = wa_aplica-z_no_aplica.
      ENDIF.

    ENDLOOP.

    ex_crit_punt = my_crit_punt[].

**  >> INI MODIF ETODR SPEC-49075
    IF get_is_obert_preu( ) = abap_off AND get_is_nova_llei_92017( ) = abap_on AND my_crit_punt_dyn[] IS NOT INITIAL AND im_sel_dyn = abap_on.
      LOOP AT my_crit_punt_dyn ASSIGNING FIELD-SYMBOL(<fs_crit_punt_tot>).
        READ TABLE gt_punt_ofer_dyn INTO DATA(wa_aplica_tot) WITH KEY z_codi_crit_punt = <fs_crit_punt_tot>-z_codi_crit_punt
                                                                      z_mod_crit_punt  = <fs_crit_punt_tot>-z_mod_crit_punt.
        IF sy-subrc = 0.
          <fs_crit_punt_tot>-z_no_aplica = wa_aplica_tot-z_no_aplica.
        ENDIF.

      ENDLOOP.
      ex_crit_punt = my_crit_punt_dyn[].
    ENDIF.
**  << FI MODIF ETODR SPEC-49075
**    >> INI MODIF ETODR SPEC-49500
*    ex_punt_ofer_dyn_equi[] = gt_punt_ofer_dyn_equi[].
    ex_punt_ofer_dyn_equi[] = gt_equip[].
**    << FI MODIF ETODR SPEC-49500
*>> SPEC-55535, Inici modificació - ETLJS
    IF my_incr IS INITIAL.
      my_incr[] = gt_incr[].
    ENDIF.
    ex_punt_ofer_dyn_incr[] = my_incr[].
    es_incr[] = gt_incr_aux[].
*<< SPEC-55535, Final modificació - ETLJS

    ">> SPEC-71214, Inici Modificació - ETODR
    et_co2 = my_punt_co2.
    "<< SPEC-71214, Final Modificació - ETODR
  ENDMETHOD.


  METHOD get_equip.
    DATA: wa_equip TYPE zty_punt_equ.

    LOOP AT gt_equip ASSIGNING FIELD-SYMBOL(<fs_equip>)
      WHERE z_num_ofer  = iv_num_ofer.
      IF iv_per_excloure = abap_on.
        IF <fs_equip>-z_is_header = abap_on. CONTINUE. ENDIF.
      ENDIF.
      MOVE-CORRESPONDING <fs_equip> TO wa_equip.
      APPEND wa_equip TO et_equip.

    ENDLOOP.

    SORT et_equip.
    DELETE ADJACENT DUPLICATES FROM et_equip.

  ENDMETHOD.


  METHOD get_formules_ve_n.
    ex_formula_ve_n = my_formula_ve_n.
  ENDMETHOD.


METHOD GET_HEADER.
  IF my_opened IS INITIAL .
    RAISE EXCEPTION TYPE zcx_rm_valoracio .
  ENDIF .
  re_header = my_exp_cont .
ENDMETHOD.


  METHOD get_is_convert_preu.
    r_is_obert_preu = my_exp_cont_db-z_conv_ob_preu.
  ENDMETHOD.


  METHOD get_is_cp_iniciada.
**  >> INI MODIF ETODR SPEC-46407
    IF  me->is_cp_iniciada IS INITIAL.
      IF check_set_log( ) = abap_on .
        set_if_circul_punt_iniciada( ).
      ENDIF.
    ENDIF.
**  << FI MODIF ETODR SPEC-46407
    re_is_cp_iniciada = me->is_cp_iniciada.
  ENDMETHOD.


  METHOD get_is_finished.
    CHECK get_is_cp_iniciada( ) = abap_on.
    re_is_cp_finished = me->is_cp_finished.
    e_date_finished   = me->g_cp_date_finished.
  ENDMETHOD.


  method GET_IS_NOVA_LLEI_92017.
    r_is_lcp_92017 = my_exp_cont_db-z_llei92017.
  endmethod.


  METHOD get_is_obert_preu.
    r_is_obert_preu = my_exp_cont_db-z_obert_preu.
  ENDMETHOD.


  METHOD get_is_tipus_simpl.
    r_tip_simplificat = my_exp_cont_db-z_obert_simpl.
  ENDMETHOD.


METHOD get_lemes.
  IF my_opened IS INITIAL .
    RAISE EXCEPTION TYPE zcx_rm_valoracio .
  ENDIF .
  re_lemes = my_lemes .
ENDMETHOD.


  METHOD get_max_punts_equi.
    DATA: wa_punt_max_equip TYPE zst_equip_max.

    IF my_punt_max_equip[] IS INITIAL.
      SELECT *
        FROM zrm_dt_punt_equi
        INTO TABLE @DATA(lt_dades_equi)
        WHERE docclass    = @my_docclass
          AND objectid    = @my_objectid
          AND z_is_header = @abap_off.

      "Inicialitzem la taula d'equips màxims
      IF lt_dades_equi[] IS NOT INITIAL.
        READ TABLE lt_dades_equi TRANSPORTING NO FIELDS WITH KEY z_equip_max = abap_on. "Només entrem aquí si és un Model de Puntuació d'Equip Màxim
        IF sy-subrc = 0.
          LOOP AT lt_dades_equi ASSIGNING FIELD-SYMBOL(<fs_equip_max>) WHERE z_equip_max IS NOT INITIAL.
            READ TABLE my_punt_max_equip TRANSPORTING NO FIELDS WITH KEY z_num_ofer        = <fs_equip_max>-z_num_ofer
                                                                         z_comptador_equip = <fs_equip_max>-z_comptador_equip.
            IF sy-subrc <> 0.
              CLEAR: wa_punt_max_equip.
              LOOP AT my_punt_ofer ASSIGNING FIELD-SYMBOL(<fs_punt_ofer_equi>) WHERE z_num_equip = <fs_equip_max>-z_comptador_equip
                                                                                 AND z_num_gen   = <fs_equip_max>-z_num_ofer.
                ADD <fs_punt_ofer_equi>-z_punts TO wa_punt_max_equip-z_punts.
              ENDLOOP.
              wa_punt_max_equip-z_descripcio      = <fs_equip_max>-z_descripcio.
*        wa_punt_max_equip-z_text_carrec     = ''.
              wa_punt_max_equip-z_carrec_equip    = <fs_equip_max>-z_carrec_equip.
              wa_punt_max_equip-z_comptador_equip = <fs_equip_max>-z_comptador_equip.
              wa_punt_max_equip-z_num_ofer        = <fs_equip_max>-z_num_ofer.
              wa_punt_max_equip-z_pes             = <fs_equip_max>-z_pes.
              wa_punt_max_equip-z_punts_pes       = wa_punt_max_equip-z_punts * ( <fs_equip_max>-z_pes / 100 ).
              APPEND wa_punt_max_equip TO my_punt_max_equip.
            ENDIF.
          ENDLOOP.
          IF my_punt_max_equip[] IS INITIAL.
            LOOP AT lt_dades_equi ASSIGNING FIELD-SYMBOL(<fs_equip_basic>) WHERE z_equip_basic IS NOT INITIAL.
              READ TABLE my_punt_max_equip TRANSPORTING NO FIELDS WITH KEY z_num_ofer        = <fs_equip_basic>-z_num_ofer
                                                                           z_comptador_equip = <fs_equip_basic>-z_comptador_equip.
              IF sy-subrc <> 0.
                CLEAR: wa_punt_max_equip.
                LOOP AT my_punt_ofer ASSIGNING FIELD-SYMBOL(<fs_punt_ofer_equi2>) WHERE z_num_equip = <fs_equip_basic>-z_comptador_equip
                                                                                    AND z_num_gen   = <fs_equip_basic>-z_num_ofer.
                  ADD <fs_punt_ofer_equi2>-z_punts TO wa_punt_max_equip-z_punts.
                ENDLOOP.
                wa_punt_max_equip-z_descripcio      = <fs_equip_basic>-z_descripcio.
*        wa_punt_max_equip-z_text_carrec     = ''.
                wa_punt_max_equip-z_carrec_equip    = <fs_equip_basic>-z_carrec_equip.
                wa_punt_max_equip-z_comptador_equip = <fs_equip_basic>-z_comptador_equip.
                wa_punt_max_equip-z_num_ofer        = <fs_equip_basic>-z_num_ofer.
                wa_punt_max_equip-z_pes             = <fs_equip_basic>-z_pes.
                wa_punt_max_equip-z_punts_pes       = wa_punt_max_equip-z_punts * ( <fs_equip_basic>-z_pes / 100 ).
                APPEND wa_punt_max_equip TO my_punt_max_equip.
              ENDIF.
            ENDLOOP.
          ENDIF.
        ENDIF.
      ENDIF.
    ENDIF.


    et_max_punts_equi = my_punt_max_equip[].
  ENDMETHOD.


  METHOD get_motivacio_multi.
    et_motiv_mult = gt_dades_motiv_multiples.
  ENDMETHOD.


  METHOD get_my_crit_dyn.
    r_crit_dyn = my_crit_is_dyn.
  ENDMETHOD.


  METHOD get_n_formules_ve.
    CLEAR e_n_formules.

    IF im_plec-z_form_val_econ IS NOT INITIAL .
      e_n_formules = ''.
    ELSE.
      DATA(lv_mod) = im_plec-z_mod_crit_punt.
      DATA: lv_lines TYPE i.
      SELECT *
        FROM zrm_dm_crit_punt
        INTO TABLE @DATA(lt_crit)
        WHERE z_mod_crit_punt EQ @lv_mod.

      DESCRIBE TABLE lt_crit LINES lv_lines.
      IF lv_lines > 1. "més d'1 fórmula
        e_n_formules = 'X'.
      ELSE.
        e_n_formules = ''.
      ENDIF.

    ENDIF .


  ENDMETHOD.


METHOD get_offers.
  IF my_opened IS INITIAL .
    RAISE EXCEPTION TYPE zcx_rm_valoracio .
  ENDIF .
  re_offers = my_ofertesx .
ENDMETHOD.


METHOD get_plec.
  IF my_opened IS INITIAL .
    RAISE EXCEPTION TYPE zcx_rm_valoracio .
  ENDIF .
  re_plec = my_plec .
ENDMETHOD.


  METHOD get_proc_adj.
    r_proc_adj = my_exp_cont_db-z_proc_adj.
  ENDMETHOD.


  method GET_PUNTS_GEN_EQUI.
    et_punts_gen_equi = my_punt_gen_equi[].
  endmethod.


  METHOD get_puntuacions.
    DATA: lr_valoracio_ofertes TYPE REF TO zrm_cl_valoracio_ofertes.

    FIELD-SYMBOLS: <lt_ofertesx>  TYPE ty_t_ofertax,
                   <lt_punt_ofer> TYPE ty_t_punt_gen,
                   <ls_ofertax>   TYPE ty_s_ofertax.

    SELECT SINGLE z_num_plec FROM zrm_dt_exp_cont INTO @DATA(lv_plec_bases) WHERE docclass EQ @iv_docclass
                                                                              AND objectid EQ @iv_objectid.

    SELECT SINGLE z_mod_crit_punt FROM zrm_dm_plecs INTO @DATA(lv_mod_crit_punt) WHERE z_num_plec = @lv_plec_bases.
    SELECT * FROM zrm_dm_crit_punt INTO TABLE @DATA(lt_crit_punt) WHERE z_mod_crit_punt = @lv_mod_crit_punt.
    SELECT SINGLE z_cri_din FROM zrm_dm_mod_crit INTO @DATA(lv_dyn) WHERE z_mod_crit_punt = @lv_mod_crit_punt.

    CREATE OBJECT lr_valoracio_ofertes
      EXPORTING
        im_docclass = iv_docclass
        im_objectid = iv_objectid
        im_action   = co_mode_punt_quadre4b_sim
        is_dynamic  = lv_dyn.

    lr_valoracio_ofertes->start( IMPORTING ex_first_time = DATA(l_first_time) ) .
    TRY.
        lr_valoracio_ofertes->get_crit_dyn_rel( IMPORTING ex_crit_punt         = et_crit_punt
                                                          ex_crit_dyn_rel_full = et_crit_dyn_rel
                                                          et_crit_punt_all     = et_crit_punt_all ). "SPEC-85003

        lr_valoracio_ofertes->sim_recalc_punt( IMPORTING et_punt_offer_nopond = et_punt_offer_nopond
                                                         et_punt_offer_pond   = et_punt_offer_pond ).

      CATCH zcx_rm_valoracio .
        RAISE EXCEPTION TYPE zcx_rm_valoracio .
    ENDTRY.
  ENDMETHOD.


  method GET_PUNT_INCR.
    data: ls_incr TYPE zrm_dt_punt_incr.

  IF my_incr IS NOT INITIAL.

  ENDIF.

  endmethod.


  METHOD get_punt_incr_obj.

    DATA: ls_incr  TYPE zrm_dt_punt_equi.
    DATA: ls_inc2  TYPE zrm_dt_punt_equi.
    DATA: iv_punts TYPE z_punts.

    DATA: it_incr TYPE zrm_tt_dt_punt_equi.
    DATA: is_incr TYPE zrm_dt_punt_equi.

    ASSIGN COMPONENT is_column-fieldname OF STRUCTURE cs_linia
         TO FIELD-SYMBOL(<fs_punts>).

    CHECK sy-subrc EQ 0.

    MOVE-CORRESPONDING is_punts_offer TO ls_incr.

    it_incr = gt_equip.

    DELETE it_incr WHERE z_num_ofer       NE is_column-key.

    DELETE it_incr WHERE z_codi_crit_punt NE ls_incr-z_codi_crit_punt.

    CLEAR: iv_punts.
    LOOP AT it_incr INTO ls_inc2.

      iv_punts = iv_punts + ( ls_inc2-z_punts * ls_inc2-z_pes / 100 ).

      AT LAST.

        WRITE iv_punts TO <fs_punts> .

      ENDAT.

    ENDLOOP.

  ENDMETHOD.


METHOD GET_PUNT_LEMES.
  IF my_opened IS INITIAL .
    RAISE EXCEPTION TYPE zcx_rm_valoracio .
  ENDIF .
  CASE im_from_db .
    WHEN space .  re_punc = my_punt_lema .
    WHEN OTHERS . re_punc = my_punt_lema_db .
  ENDCASE .
ENDMETHOD.


METHOD get_punt_offers.
  IF my_opened IS INITIAL .
    RAISE EXCEPTION TYPE zcx_rm_valoracio .
  ENDIF .
  CASE im_from_db .
    WHEN space .  re_punc = my_punt_ofer .
    WHEN OTHERS . re_punc = my_punt_ofer_db .
  ENDCASE .
ENDMETHOD.


METHOD get_punt_offers_val_cap_obra.

  DATA: g_docclass_pare              TYPE bapidclass,
        g_objectid_pare              TYPE bapiguid,
        g_docclass_fill              TYPE bapidclass,
        g_objectid_fill              TYPE bapiguid,
        lt_zrm_dt_punt_cap           TYPE STANDARD TABLE OF zrm_dt_punt_cap,
        ls_zrm_dt_punt_cap           TYPE zrm_dt_punt_cap,
        ls_my_punt_ofer_val_cap_obra LIKE LINE OF my_punt_ofer_val_cap_obra,
        ls_my_punt_ofer              LIKE LINE OF my_punt_ofer,
        ls_my_punt_ofer_db           LIKE LINE OF my_punt_ofer,
        lt_ofer_val_cap_obra         TYPE TABLE OF zrm_dt_punt_cap,
        ls_ofer_val_cap_obra         TYPE zrm_dt_punt_cap,
        lt_ofer_val_cap_obra_aux     TYPE TABLE OF zrm_dt_punt_cap,
        ls_ofer_val_cap_obra_aux     TYPE zrm_dt_punt_cap,
        lt_ofer_val_cap_obra_aux2    TYPE TABLE OF zrm_dt_punt_cap,
        ls_ofer_val_cap_obra_aux2    TYPE zrm_dt_punt_cap.


  IF my_opened IS INITIAL.
    RAISE EXCEPTION TYPE zcx_rm_valoracio.
  ENDIF.

  CLEAR: g_docclass_pare,
         g_objectid_pare,
         g_docclass_fill,
         g_objectid_fill.

  GET PARAMETER ID 'DOCCLASS_PARE_VCO' FIELD g_docclass_pare.
  GET PARAMETER ID 'OBJECTID_PARE_VCO' FIELD g_objectid_pare.

  GET PARAMETER ID 'DOCCLASS_FILL_VCO' FIELD g_docclass_fill.
  GET PARAMETER ID 'OBJECTID_FILL_VCO' FIELD g_objectid_fill.


*  CASE im_from_db.
*    WHEN space.

  re_punc = my_punt_ofer.

  CLEAR: my_punt_ofer_val_cap_obra.

  " Mirem si existeix l'Expedient Fill a la taula ZRM_DT_PUNT_CAP.
  " Si no existeix, el creem.
  SELECT zrm_dt_punt_cap~z_mod_crit_punt
       zrm_dt_punt_cap~z_codi_crit_punt
       zrm_dt_punt_cap~z_punts
       zrm_dt_punt_cap~z_num_ofer AS z_num_gen
       zrm_dt_punt_ofer~z_punts_no_pond
   FROM zrm_dt_punt_cap
     LEFT JOIN zrm_dt_punt_ofer
       ON zrm_dt_punt_cap~objectid = zrm_dt_punt_ofer~objectid
      AND zrm_dt_punt_cap~docclass = zrm_dt_punt_ofer~docclass
      AND zrm_dt_punt_cap~z_num_ofer = zrm_dt_punt_ofer~z_num_ofer
      AND zrm_dt_punt_cap~z_mod_crit_punt = zrm_dt_punt_ofer~z_mod_crit_punt
      AND zrm_dt_punt_cap~z_codi_crit_punt = zrm_dt_punt_ofer~z_codi_crit_punt
       INTO CORRESPONDING FIELDS OF TABLE my_punt_ofer_val_cap_obra
           WHERE zrm_dt_punt_cap~objectid EQ g_objectid_pare
             AND zrm_dt_punt_cap~docclass EQ g_docclass_pare
             AND zrm_dt_punt_cap~objectid_fill EQ g_objectid_fill
             AND zrm_dt_punt_cap~docclass_fill EQ g_docclass_fill.


  IF my_punt_ofer_val_cap_obra IS INITIAL.
    CLEAR: ls_my_punt_ofer.
    LOOP AT my_punt_ofer INTO ls_my_punt_ofer.
      CLEAR:ls_ofer_val_cap_obra.
      MOVE-CORRESPONDING ls_my_punt_ofer TO ls_ofer_val_cap_obra.
      ls_ofer_val_cap_obra-docclass = g_docclass_pare.
      ls_ofer_val_cap_obra-objectid = g_objectid_pare.
      ls_ofer_val_cap_obra-docclass_fill = g_docclass_fill.
      ls_ofer_val_cap_obra-objectid_fill = g_objectid_fill.
      ls_ofer_val_cap_obra-z_num_ofer = ls_my_punt_ofer-z_num_gen.


      SELECT SINGLE proveidor
       FROM zrm_dt_ofertes
        INTO ls_ofer_val_cap_obra-num_proveidor
         WHERE docclass = g_docclass_pare
           AND objectid = g_objectid_pare
           AND z_num_ofer = ls_my_punt_ofer-z_num_gen.


      APPEND ls_ofer_val_cap_obra TO lt_ofer_val_cap_obra.
      CLEAR: ls_my_punt_ofer.
    ENDLOOP.
    MODIFY zrm_dt_punt_cap FROM TABLE lt_ofer_val_cap_obra.
  ENDIF.


  " Modifiquem les puntiacions de l'Expedient Fill.
  CLEAR: lt_ofer_val_cap_obra_aux.
  SELECT *
   FROM zrm_dt_punt_cap
     INTO CORRESPONDING FIELDS OF TABLE lt_ofer_val_cap_obra_aux
         WHERE zrm_dt_punt_cap~objectid EQ g_objectid_pare
           AND zrm_dt_punt_cap~docclass EQ g_docclass_pare
           AND zrm_dt_punt_cap~objectid_fill EQ g_objectid_fill
           AND zrm_dt_punt_cap~docclass_fill EQ g_docclass_fill.

  IF lt_ofer_val_cap_obra_aux IS NOT INITIAL.
    CLEAR: ls_ofer_val_cap_obra_aux.
    LOOP AT lt_ofer_val_cap_obra_aux INTO ls_ofer_val_cap_obra_aux.

      CLEAR: ls_my_punt_ofer.
      READ TABLE my_punt_ofer INTO ls_my_punt_ofer WITH KEY z_mod_crit_punt = ls_ofer_val_cap_obra_aux-z_mod_crit_punt
                                                            z_codi_crit_punt = ls_ofer_val_cap_obra_aux-z_codi_crit_punt
                                                            z_num_gen = ls_ofer_val_cap_obra_aux-z_num_ofer.

      CLEAR: ls_ofer_val_cap_obra_aux2.
      MOVE-CORRESPONDING ls_ofer_val_cap_obra_aux2 TO ls_ofer_val_cap_obra_aux2.
      ls_ofer_val_cap_obra_aux2-mandt = ls_ofer_val_cap_obra_aux-mandt.
      ls_ofer_val_cap_obra_aux2-docclass = ls_ofer_val_cap_obra_aux-docclass.
      ls_ofer_val_cap_obra_aux2-objectid = ls_ofer_val_cap_obra_aux-objectid.
      ls_ofer_val_cap_obra_aux2-docclass_fill = ls_ofer_val_cap_obra_aux-docclass_fill.
      ls_ofer_val_cap_obra_aux2-objectid_fill = ls_ofer_val_cap_obra_aux-objectid_fill.
      ls_ofer_val_cap_obra_aux2-z_num_ofer = ls_my_punt_ofer-z_num_gen.


      SELECT SINGLE proveidor
       FROM zrm_dt_ofertes
        INTO ls_ofer_val_cap_obra_aux2-num_proveidor
         WHERE docclass = ls_ofer_val_cap_obra_aux-docclass
           AND objectid = ls_ofer_val_cap_obra_aux-objectid
           AND z_num_ofer = ls_my_punt_ofer-z_num_gen..


      APPEND ls_ofer_val_cap_obra_aux2 TO lt_ofer_val_cap_obra_aux2.
      DELETE lt_ofer_val_cap_obra_aux2 WHERE z_mod_crit_punt IS INITIAL.
      CLEAR: ls_ofer_val_cap_obra_aux.
    ENDLOOP.

    MODIFY zrm_dt_punt_cap FROM TABLE lt_ofer_val_cap_obra_aux2.
  ENDIF.

*    WHEN OTHERS.
*      re_punc = my_punt_ofer_db.
*
*  ENDCASE .

ENDMETHOD.


METHOD get_punt_sol_part.
  IF my_opened IS INITIAL .
    RAISE EXCEPTION TYPE zcx_rm_valoracio .
  ENDIF .
  CASE im_from_db .
    WHEN space .  re_punc = my_punt_sol_part .
    WHEN OTHERS . re_punc = my_punt_sol_part_db .
  ENDCASE .

ENDMETHOD.


  METHOD get_punt_subapart.
    IF i_subapartat IS NOT INITIAL.
      DATA(lt_dades_punt) = gt_dades_punt[].
      DELETE lt_dades_punt WHERE z_codi_subapar_punt <> i_subapartat.
      et_dades_subapart[] = lt_dades_punt[].
    ELSE.
      et_dades_subapart[] = gt_dades_punt[].
    ENDIF.
  ENDMETHOD.


method GET_RD817_2009.

   IF my_opened IS INITIAL .
    RAISE EXCEPTION TYPE zcx_rm_valoracio .
  ENDIF .
  re_rd817_2009 = my_exp_cont-Z_rd817_2009 .


endmethod.


METHOD get_solv_tec_exclusion.
  FIELD-SYMBOLS: <ls_ofertax>   LIKE LINE OF my_ofertesx,
               <ls_crit_punt> LIKE LINE OF my_crit_punt,
               <ls_columns> TYPE ty_s_column .
  DATA: l_not_excluded_count  TYPE i,
        l_tech_excluded_count TYPE i,
        l_tech_excluded       TYPE xfeld,
        ls_ofertax            TYPE ty_s_ofertax .
  CHECK my_min_solv_tec IS NOT INITIAL.
  CLEAR ex_all_excluded .
  IF my_opened IS INITIAL .
    RAISE EXCEPTION TYPE zcx_rm_valoracio .
  ENDIF .

  LOOP AT my_ofertesx ASSIGNING <ls_ofertax> WHERE  exclos IS INITIAL .
    ADD 1 TO l_not_excluded_count .
    CLEAR l_tech_excluded .
    READ TABLE im_columns ASSIGNING <ls_columns> WITH KEY key = <ls_ofertax>-z_num_ofer.

    CHECK <ls_columns>-punt_total LT my_min_solv_tec.
    ADD 1 TO l_tech_excluded_count .
    l_tech_excluded = 'X' .

    IF    ex_ofertes  IS REQUESTED
       OR ex_ofertesx IS REQUESTED .
      ls_ofertax = <ls_ofertax> .
      ls_ofertax-z_excl_solv_tec = l_tech_excluded .

      IF ex_ofertes IS REQUESTED .
        INSERT ls_ofertax-offer_data INTO TABLE ex_ofertes .
      ENDIF .

      IF ex_ofertesx IS REQUESTED .
        INSERT ls_ofertax INTO TABLE ex_ofertesx .
      ENDIF .
    ENDIF .
  ENDLOOP .

  IF l_not_excluded_count EQ l_tech_excluded_count .
    ex_all_excluded = 'X' .
  ENDIF .
ENDMETHOD.


METHOD get_technical_exclusion.
  FIELD-SYMBOLS: <ls_ofertax>   LIKE LINE OF my_ofertesx,
                 <ls_crit_punt> LIKE LINE OF my_crit_punt,
                 <ls_punt_ofer> LIKE LINE OF my_punt_ofer .
  DATA: l_not_excluded_count  TYPE i,
        l_tech_excluded_count TYPE i,
        l_tech_excluded       TYPE xfeld,
        ls_ofertax            TYPE ty_s_ofertax .

  CLEAR ex_all_excluded .
  IF my_opened IS INITIAL .
    RAISE EXCEPTION TYPE zcx_rm_valoracio .
  ENDIF .

  LOOP AT my_ofertesx ASSIGNING <ls_ofertax> WHERE  exclos IS INITIAL .
    ADD 1 TO l_not_excluded_count .
    CLEAR l_tech_excluded .
    LOOP AT my_crit_punt ASSIGNING <ls_crit_punt>
                  WHERE     z_mod_crit_punt EQ my_plec-z_mod_crit_punt
                        AND z_punt_min      GT 0 .
      READ TABLE my_punt_ofer ASSIGNING <ls_punt_ofer>
             WITH TABLE KEY z_num_gen        = <ls_ofertax>-z_num_ofer
                            z_mod_crit_punt  = my_plec-z_mod_crit_punt
                            z_codi_crit_punt = <ls_crit_punt>-z_codi_crit_punt.
      CHECK sy-subrc = 0.                                  "SPEC-37724
      CHECK <ls_punt_ofer>-z_punts LT <ls_crit_punt>-z_punt_min .
      ADD 1 TO l_tech_excluded_count .

      l_tech_excluded = 'X' .
      EXIT .
    ENDLOOP .
    IF    ex_ofertes  IS REQUESTED
       OR ex_ofertesx IS REQUESTED .
      ls_ofertax = <ls_ofertax> .
      ls_ofertax-z_excl_punt_tec = l_tech_excluded .

      IF ex_ofertes IS REQUESTED .
        INSERT ls_ofertax-offer_data INTO TABLE ex_ofertes .
      ENDIF .

      IF ex_ofertesx IS REQUESTED .
        INSERT ls_ofertax INTO TABLE ex_ofertesx .
      ENDIF .
    ENDIF .

  ENDLOOP .

  IF l_not_excluded_count EQ l_tech_excluded_count .
    ex_all_excluded = 'X' .
  ENDIF .


ENDMETHOD.


  METHOD get_te_exclusio_clausula_plec.
    LOOP AT my_ofertesx ASSIGNING FIELD-SYMBOL(<fs_oferta>) WHERE z_num_ofer = i_num_ofer.
      e_exclusio = <fs_oferta>-z_exclos_plec.
    ENDLOOP.
  ENDMETHOD.


METHOD has_changed.
  re_changed = my_changed .
ENDMETHOD.


  METHOD has_exclusio_clausula_plec.
    CLEAR: e_clausula_plec, r_excloure_plec.
    LOOP AT my_crit_punt ASSIGNING FIELD-SYMBOL(<fs_crit_punt>) WHERE z_excloure_lici = abap_on.
      e_clausula_plec = <fs_crit_punt>-z_clausula_excl_lici.
      r_excloure_plec = abap_on.
    ENDLOOP.
  ENDMETHOD.


METHOD is_2_round.
  CLEAR re_2_round .
  IF      my_exp_cont-z_proc_adj EQ 'CD'   "Doble Volta
       OR my_exp_cont-z_proc_adj EQ 'CI'   "Idees
 "      OR my_exp_cont-z_proc_adj EQ 'CR' . "Restringit
    OR ( my_exp_cont-z_proc_adj EQ 'NF' and my_exp_cont-z_negociacio = 'X'). "ADD P100031 11/11/2015
    re_2_round = 'X' .
  ENDIF .
ENDMETHOD.


  METHOD is_awardee.
    IF my_exp_cont-z_adjudicatari IS NOT  INITIAL.
      rc = abap_true.
    ELSE.
      rc = abap_false.
    ENDIF.
  ENDMETHOD.


METHOD is_best_classified.
*>> Ini  SPEC-54695  - ETMAE
  READ TABLE my_ofertesx TRANSPORTING NO FIELDS WITH KEY z_mill_class = abap_on.
  IF sy-subrc = 0.
    rc = abap_true.
  ELSE.
    rc = abap_false.
  ENDIF.
*  IF my_exp_cont-z_conf_mill_class = abap_on.
*    rc = abap_true.
*  ELSE.
*    rc = abap_false.
*  ENDIF.

*<< Fi  SPEC-54695  - ETMAE
ENDMETHOD.
*
*------------------------------------------------------------------------------
*


METHOD is_empresa_arquitecte.
  IF my_exp_cont-z_subtipus_cont EQ 'PD' OR
     my_exp_cont-z_subtipus_cont EQ 'PO'.
    re_empresa_arquitecte = abap_true.
  ELSE.
    re_empresa_arquitecte = abap_false.
  ENDIF.
ENDMETHOD.


METHOD lock.
  DATA: l_dummy TYPE c.                                     "#EC NEEDED

  CHECK my_locked IS INITIAL .

  CLEAR: ex_success,
         ex_lock_user .

  IF    my_exp_cont_db-z_estat EQ 'ZTA'.
    MESSAGE e020 INTO l_dummy .
    zcx_rm_valoracio=>raise_from_message( ) .
  ELSEIF my_exp_cont_db-z_estat EQ 'ZCA' .
    RAISE EXCEPTION TYPE zcx_rm_valoracio
      EXPORTING
        textid = zcx_rm_valoracio=>cancelled.
  ENDIF .

  CALL METHOD enqueue
    IMPORTING
      ex_success   = ex_success
      ex_lock_user = ex_lock_user.

  CHECK ex_success IS NOT INITIAL .
  my_locked = 'X' .
  build_activity_list( ) .
  me->recalculate( IMPORTING ex_changed = ex_changed ) .
  my_changed = ex_changed .



* si encara és possible puntuar i hem detectat inconsitències hem de començar de nou. mala sort!
  IF check_activity( co_act_punct_1st ) IS NOT INITIAL.
    IF   my_consistency_offer-model_has_changed IS NOT INITIAL
      OR my_consistency_offer-new_criteria      IS NOT INITIAL
      OR my_consistency_offer-deleted_criteria  IS NOT INITIAL .
      DATA: ls_punt_ofer LIKE LINE OF my_punt_ofer .
      ls_punt_ofer-z_punts =  0.
      MODIFY my_punt_ofer FROM ls_punt_ofer TRANSPORTING z_punts WHERE z_punts NE 0 .
      me->recalculate( ) . "Recalculem valoració econòmica
      my_changed = 'X' .
      ex_changed = 'X' .
    ENDIF .
  ENDIF .

** >> INI MODIF ETODR SPEC-40388
  check_changed_first_time( IMPORTING ex_changed = ex_changed ).
** << FI MODIF ETODR SPEC-40388


ENDMETHOD.


  METHOD mod_crit_punt_has_pdm.
    re_has_pdm = abap_off.
    LOOP AT my_crit_punt ASSIGNING FIELD-SYMBOL(<fs_crit_punt>) WHERE z_equip_pdm = abap_on.
      re_has_pdm = abap_on.
    ENDLOOP.
  ENDMETHOD.


  METHOD netejar_valors.
*    FIELD-SYMBOLS: <ls_crit_punt> TYPE ty_s_crit_punt,
*                   <ls_ofertes>   TYPE LINE OF ty_t_punt_gen,
*                   <ls_ofertes2>  TYPE LINE OF ty_t_punt_gen,
*                   <ls_ofertax>   TYPE ty_s_ofertax .
*
*    IF ch_punt_ofer[] IS INITIAL.
*      SELECT   z_num_ofer AS z_num_gen z_mod_crit_punt z_codi_crit_punt z_punts
*           INTO CORRESPONDING FIELDS OF TABLE ch_punt_ofer
*           FROM zrm_dt_punt_ofer
*          WHERE     docclass EQ me->my_docclass
*                AND objectid EQ me->my_objectid.
*    ENDIF.
*
*
*    LOOP AT im_crit_punt ASSIGNING <ls_crit_punt>
*                             WHERE z_punt_min IS NOT INITIAL.
*      LOOP AT ch_punt_ofer ASSIGNING <ls_ofertes>
*                               WHERE z_codi_crit_punt = <ls_crit_punt>-z_codi_crit_punt
*                                 AND z_punts          < <ls_crit_punt>-z_punt_min.
*        READ TABLE ch_punt_ofer ASSIGNING <ls_ofertes2>
*                                 WITH KEY z_codi_crit_punt = '1'
*                                          z_num_gen        = <ls_ofertes>-z_num_gen.
*        CLEAR <ls_ofertes2>-z_punts.
*        READ TABLE ch_punt_ofer ASSIGNING <ls_ofertes2>
*                         WITH KEY z_codi_crit_punt = '1.1'
*                                  z_num_gen        = <ls_ofertes>-z_num_gen.
*        CLEAR <ls_ofertes2>-z_punts.
*        READ TABLE my_ofertesx ASSIGNING <ls_ofertax> WITH KEY z_num_ofer = <ls_ofertes>-z_num_gen.
**        <ls_ofertax>-exclos = 'X'.
*        <ls_ofertax>-z_exclos_var_tec = 'X'.
*        <ls_ofertax>-z_excl_punt_tec  = 'X'.
*      ENDLOOP.
*
*    ENDLOOP.
  ENDMETHOD.


method NOTIF_OFERTA_MILLOR_CLASSIFICA.
*>> Ini  SPEC-54695  - ETMAE
* Notificació de oferta millor classificada al cap de´l'expedient .

  types: begin of ty_np ,  " Nombre de proveedor
          name1 type lfa1-name1,
          name2 type lfa1-name2,
          name3 type lfa1-name3,
          name4 type lfa1-name4,
         end  of  ty_np.

  data: lv_fullname  type text180,
        ls_np        type ty_np ,
        ls_ofertax   type ty_s_ofertax ,
        ls_address   type bapiaddr3 ,
        lt_return    type bapiret2_tab .
  data: lt_para      type bcsy_smtpa ,
        lv_asunto    type so_obj_des,
        lt_cuerpo    type soli_tab,
        ls_cuerpo    type soli ,        " estructura solo campo 'line' 255
        lv_enviado   type flag.

  CALL FUNCTION 'BAPI_USER_GET_DETAIL'
    EXPORTING
      username = my_exp_cont-z_cap_exp
    IMPORTING
      address  = ls_address
    TABLES
      return   = lt_return.

  check ls_address-e_mail is not initial.

  READ TABLE my_ofertesx into ls_ofertax WITH KEY z_mill_class = abap_true .

  CHECK sy-subrc is initial.

  select single name1 name2 name3 name4
    into ls_NP
    from lfa1
   where lifnr = ls_ofertax-proveidor .

  CHECK sy-subrc is initial.

  concatenate ls_NP-name1  ls_NP-name2  ls_NP-name3  ls_NP-name4
         into lv_fullname SEPARATED BY space.
  condense lv_fullname.

*  ----------------------------------------------------------

  APPEND ls_address-e_mail TO lt_para .

  lv_asunto = ` Sel. Solvència ` && my_exp_cont-Z_CODI_EXP.

  ls_cuerpo-line = `S'ha seleccionat al proveïdor ` && lv_fullname .
  append ls_cuerpo to lt_cuerpo.

  ls_cuerpo-line = `per a demanar-li la solvència de l'expedient ` &&
                    my_exp_cont-Z_DESCRIP_ABR .
  append ls_cuerpo to lt_cuerpo.

  CALL FUNCTION 'ZFM_ENVIAR_CORREO'
    EXPORTING
      i_asunto  = lv_asunto
      it_para   = lt_para
      it_cuerpo = lt_cuerpo
    IMPORTING
      e_enviado = lv_enviado.


*<< Fi  SPEC-54695  - ETMAE

endmethod.
*
*------------------------------------------------------------------------------
*


METHOD obert_pliq_expired.
  CLEAR re_expired .

  IF  my_exp_cont-z_data_ober_pliq LT sy-datum OR
    ( my_exp_cont-z_data_ober_pliq =  sy-datum AND
      my_exp_cont-z_hora_ober_pliq LT sy-uzeit ).
    re_expired = 'X' .
  ENDIF.

ENDMETHOD.


METHOD read_and_check_crit_punt.
  DATA: l_dummy          TYPE c,                            "#EC NEEDED
        l_tabix          TYPE i,
        l_tab1           TYPE i,
        l_tab2           TYPE i,
        ls_crit_ahead    TYPE ty_s_crit_punt,
        ls_sum_info      TYPE ty_s_sum_info,
        ls_sum_info_quad TYPE ty_s_sum_info, "SPEC-55448
        l_sum_level      TYPE z_nivell_criteri,
        l_sum_level_quad TYPE z_nivell_quadres, "SPEC-55448
        lv_copy_max_lvl  TYPE zrm_dm_crit_punt-z_nivell_quadres, "SPEC-55448
        l_sum_ponder     TYPE zrm_dm_crit_punt-z_ponderacio,
        l_pond_ve        TYPE zrm_dm_crit_punt-z_ponderacio,  "Ponderació valoració econòmica
        l_pond_vt        TYPE zrm_dm_crit_punt-z_ponderacio,  "Ponderació valoració tècnica
        l_pond_char_ve   TYPE char10,
        l_pond_char_vt   TYPE char10,
        l_max_nivell     TYPE zrm_dm_crit_punt-z_nivell_criteri.
  FIELD-SYMBOLS: <ls_crit_punt> TYPE ty_s_crit_punt .

  SELECT * INTO CORRESPONDING FIELDS OF TABLE re_crit_punt
       FROM zrm_dm_crit_punt
       WHERE z_mod_crit_punt EQ im_mod_crit_punt .
  IF sy-subrc NE 0 .
    MESSAGE e027 WITH im_mod_crit_punt INTO l_dummy .
    zcx_rm_valoracio=>raise_from_message( ) .
  ENDIF.
** >> INI MODIF ETODR SPEC-49075
  IF get_is_nova_llei_92017( ) = abap_on AND my_exp_cont_db-z_obert_preu = abap_off.
*    LOOP AT re_crit_punt ASSIGNING FIELD-SYMBOL(<fs_crit_tot_initial>) WHERE z_mod_crit_punt = im_mod_crit_punt
*                                                                         AND ( z_crit_q4     = abap_off ).
**      DELETE re_crit_punt.
*    ENDLOOP.
  ELSE.
** << FI MODIF ETODR SPEC-49075
* Cas Reial Decret: Només mostrarem els criteris tècnics a la tasca de Puntuació tècnica
    IF im_mode EQ co_mode_punct_tec.
      READ TABLE re_crit_punt ASSIGNING <ls_crit_punt> WITH KEY z_mod_crit_punt = im_mod_crit_punt
                                                                z_crit_ve = co_crit_val_tecnic.
*** INI ETOVB
      IF sy-subrc <> 0 .
        READ TABLE re_crit_punt ASSIGNING <ls_crit_punt> WITH KEY z_mod_crit_punt = im_mod_crit_punt
                                                                z_crit_ve = 'F'.
        IF sy-subrc <> 0 .
*** FIN ETOVB
          READ TABLE re_crit_punt ASSIGNING <ls_crit_punt> WITH KEY z_mod_crit_punt = im_mod_crit_punt
                                                                  z_crit_ve = co_crit_tecnic.
*** INI ETOVB SPEC-48889
        ENDIF.
*** FIN ETOVB SPEC-48889
      ENDIF.

      l_tab1 = sy-tabix - 1.
      l_tab2 = sy-tabix + 1.

*  Mirem si hi ha més criteris d'altres tipus després i els esborrem
      LOOP AT re_crit_punt ASSIGNING <ls_crit_punt> FROM l_tab2 WHERE z_crit_ve IS NOT INITIAL.
        EXIT.
      ENDLOOP.

      IF sy-subrc = 0.
        DELETE re_crit_punt FROM sy-tabix.
      ENDIF.

*  Ens carreguem els criteris que no són tècnics situats avans dels tècnics
      IF l_tab1 GE 1.
        DELETE re_crit_punt TO l_tab1.
      ENDIF.
    ENDIF.
  ENDIF.

* Tenim dos casos:
*a) Seqüència econòmica+tècnica (X+T). A la T assumim que és sumatori encara que la parametrizació no
*   ho digui
*b) Seqüència econòmica+tècnica+puntuació tècnica+valoració tècnica (X+T+P+V). En aquest cas:
*   b1) T és un còpia exacta del resultat del criteri P. Ignorem el flag sumatori
*   b2) P és una ponderació de V. A l'oferta que tingui el màxim V li donem el valor màxim
*       admés pel criteri i a la resta li sumem la mateixa diferència
*   b3) V és el sumatori de nivell inferiors, independentment del que digui el flag.

* Per comoditat fem una passada als criteris i "arreglem" les dades de parametrització

  LOOP AT re_crit_punt ASSIGNING <ls_crit_punt> .
    l_tabix = sy-tabix .
*    <ls_crit_punt>-display_order = sy-tabix .
    IF <ls_crit_punt>-z_nivell_criteri GT l_max_nivell .
      l_max_nivell = <ls_crit_punt>-z_nivell_criteri .
    ENDIF .

    IF      <ls_crit_punt>-z_ponderacio IS NOT INITIAL
        AND <ls_crit_punt>-z_nivell_criteri NE 1 .
      CLEAR <ls_crit_punt>-z_ponderacio .
    ENDIF .

    ADD <ls_crit_punt>-z_ponderacio TO l_sum_ponder .

    IF     <ls_crit_punt>-z_crit_ve EQ co_crit_economic    "X
        OR <ls_crit_punt>-z_crit_ve EQ co_crit_termini .   "D
      CLEAR <ls_crit_punt>-z_sumatori .
    ELSEIF <ls_crit_punt>-z_crit_ve EQ co_crit_tecnic .    "T
      ADD 1 TO l_tabix .
      READ TABLE re_crit_punt INTO ls_crit_ahead INDEX l_tabix .
      IF sy-subrc NE 0 . "No té sentit... no hi ha més criteris (!?)
        CLEAR <ls_crit_punt>-z_sumatori .
      ELSEIF ls_crit_ahead-z_crit_ve EQ co_crit_punt_tecnic . "T+P
        CLEAR <ls_crit_punt>-z_sumatori .
      ELSE .
        <ls_crit_punt>-z_sumatori = 'X' .
      ENDIF .
    ELSEIF <ls_crit_punt>-z_crit_ve EQ co_crit_punt_tecnic . "P
      CLEAR <ls_crit_punt>-z_sumatori .
    ELSEIF ( <ls_crit_punt>-z_crit_ve EQ co_crit_val_tecnic OR <ls_crit_punt>-z_crit_ve EQ 'F' ). "SPEC-48889 ETLJS  "V, D
      <ls_crit_punt>-z_sumatori = 'X' .
    ENDIF .
  ENDLOOP .

* Si la ponderació no está indicada a cap criteri de nivell 1 per raons històriques
* assumim que equival al 100% (suma de critris).
* Si, pel contrari, està informada ens hem d'assegurar que la suma és del 100%.
* EDCPC 29-09-2009 Modificació l_sum_ponder per llegir-la directament del plec de bases
  SELECT SUM( z_ponderacio ) INTO l_sum_ponder
  FROM zrm_dm_crit_punt
  WHERE z_mod_crit_punt = im_mod_crit_punt.

  IF l_sum_ponder EQ 0 .
    ls_crit_ahead-z_ponderacio = 100 .
    MODIFY re_crit_punt FROM ls_crit_ahead TRANSPORTING z_ponderacio
          WHERE z_nivell_criteri = '01'.
  ELSEIF l_sum_ponder NE 100 .
    MESSAGE e039 WITH im_mod_crit_punt INTO l_dummy .
    zcx_rm_valoracio=>raise_from_message( ) .
  ENDIF .

* Els sumatoris SEMPRE són sobre nivells inferiors així que l'últim nivell no pot ser
* un sumatori .
  CLEAR ls_crit_ahead-z_sumatori .
  MODIFY re_crit_punt FROM ls_crit_ahead TRANSPORTING z_sumatori
        WHERE z_nivell_criteri = l_max_nivell .

  l_max_nivell = l_max_nivell - 1.
  ">>>SPEC-55448, Inici modificació  - ETODR
  lv_copy_max_lvl = l_max_nivell.
  "<<<SPEC-55448, Final modificació - ETODR
  WHILE l_max_nivell GT 0 .
*Fem passades per a determinar quins criteris intervenen a cada subtotal i aprofitem per
*"expandir" els sumatoris de sumatoris
    LOOP AT re_crit_punt ASSIGNING <ls_crit_punt> WHERE z_nivell_criteri EQ l_max_nivell .
      l_tabix = sy-tabix .
      IF <ls_crit_punt>-z_sumatori EQ 'X'  .
        l_sum_level = <ls_crit_punt>-z_nivell_criteri + 1 .
        DO .
          ADD 1 TO l_tabix .
          READ TABLE re_crit_punt INTO ls_crit_ahead INDEX l_tabix .
          IF     sy-subrc NE 0
              OR ls_crit_ahead-z_nivell_criteri LT l_sum_level.
            EXIT .
          ENDIF .
          IF  ls_crit_ahead-z_nivell_criteri GT l_sum_level .
            CONTINUE .
          ENDIF .
          CLEAR ls_sum_info .
          ls_sum_info-z_codi_crit_punt = ls_crit_ahead-z_codi_crit_punt .
          ls_sum_info-z_mod_crit_punt  = ls_crit_ahead-z_mod_crit_punt .
          IF l_sum_level EQ 1 .
            ls_sum_info-z_ponderacio     = ls_crit_ahead-z_ponderacio .
          ELSE .
            ls_sum_info-z_ponderacio     = 100 .
          ENDIF .
          INSERT ls_sum_info INTO TABLE <ls_crit_punt>-sum_info .
*          ENDIF .
        ENDDO .
      ELSEIF <ls_crit_punt>-z_crit_ve EQ co_crit_economic .
      ELSEIF    <ls_crit_punt>-z_crit_ve EQ co_crit_tecnic    "Fem T=P; P=V
             OR <ls_crit_punt>-z_crit_ve EQ co_crit_punt_tecnic .
        ADD 1 TO l_tabix .
        READ TABLE re_crit_punt INTO ls_crit_ahead INDEX l_tabix .
        ls_sum_info-z_codi_crit_punt = ls_crit_ahead-z_codi_crit_punt .
        ls_sum_info-z_mod_crit_punt  = ls_crit_ahead-z_mod_crit_punt .
        ls_sum_info-z_ponderacio     = 100 .
        INSERT ls_sum_info INTO TABLE <ls_crit_punt>-sum_info .
*      ELSEIF <ls_crit_punt>-z_crit_ve EQ co_crit_punt_tecnic .
      ELSEIF <ls_crit_punt>-z_crit_ve EQ co_crit_val_tecnic .
      ENDIF .
    ENDLOOP .
    l_max_nivell = l_max_nivell - 1 .
  ENDWHILE .

  ">>>SPEC-55448, Inici modificació  - ETODR
* "Necessitem la estructuració per "nivell quadres" per no tindre en compte
  "els criteris superflus que utilitzem per acumular i ponderar. Però no volem
  "tocar el SUM_INFO actual.
  WHILE lv_copy_max_lvl GT 0 .
*Fem passades per a determinar quins criteris intervenen a cada subtotal i aprofitem per
*"expandir" els sumatoris de sumatoris
    LOOP AT re_crit_punt ASSIGNING <ls_crit_punt> WHERE z_nivell_quadres EQ lv_copy_max_lvl .
      l_tabix = sy-tabix .
      IF <ls_crit_punt>-z_sumatori EQ 'X'  .
        l_sum_level_quad = <ls_crit_punt>-z_nivell_quadres + 1 .
        DO .
          ADD 1 TO l_tabix .
          READ TABLE re_crit_punt INTO ls_crit_ahead INDEX l_tabix .
          IF     sy-subrc NE 0
              OR ls_crit_ahead-z_nivell_quadres LT l_sum_level_quad.
            EXIT .
          ENDIF .
          IF  ls_crit_ahead-z_nivell_quadres GT l_sum_level_quad .
            CONTINUE .
          ENDIF .
          CLEAR ls_sum_info_quad .
          ls_sum_info_quad-z_codi_crit_punt = ls_crit_ahead-z_codi_crit_punt .
          ls_sum_info_quad-z_mod_crit_punt  = ls_crit_ahead-z_mod_crit_punt .
          IF l_sum_level_quad EQ 1 .
            ls_sum_info_quad-z_ponderacio     = ls_crit_ahead-z_ponderacio .
          ELSE .
            ls_sum_info_quad-z_ponderacio     = 100 .
          ENDIF .
          INSERT ls_sum_info_quad INTO TABLE <ls_crit_punt>-sum_info_quadres .
        ENDDO .
      ELSEIF <ls_crit_punt>-z_crit_ve EQ co_crit_economic .
      ELSEIF    <ls_crit_punt>-z_crit_ve EQ co_crit_tecnic    "Fem T=P; P=V
             OR <ls_crit_punt>-z_crit_ve EQ co_crit_punt_tecnic .
        ADD 1 TO l_tabix .
        READ TABLE re_crit_punt INTO ls_crit_ahead INDEX l_tabix .
        ls_sum_info_quad-z_codi_crit_punt = ls_crit_ahead-z_codi_crit_punt .
        ls_sum_info_quad-z_mod_crit_punt  = ls_crit_ahead-z_mod_crit_punt .
        ls_sum_info_quad-z_ponderacio     = 100 .
        INSERT ls_sum_info_quad INTO TABLE <ls_crit_punt>-sum_info_quadres.
      ELSEIF <ls_crit_punt>-z_crit_ve EQ co_crit_val_tecnic .
      ENDIF .
    ENDLOOP .
    lv_copy_max_lvl = lv_copy_max_lvl - 1 .
  ENDWHILE .
  "<<<SPEC-55448, Final modificació - ETODR

  DATA: l_char TYPE char40.
*Afegim una nova línia sense codi de criteri que correspondrà al total
  CLEAR ls_crit_ahead .
  ls_crit_ahead-z_mod_crit_punt  = im_mod_crit_punt .
  ls_crit_ahead-z_codi_crit_punt = co_codi_crit_total .
  ls_crit_ahead-z_descripcio     = 'Total' .
* <== EDLSM 15/06/2010 Excl.punt.solv.tèc.
  IF my_min_solv_tec IS NOT INITIAL.
    l_char = my_min_solv_tec.
    CONDENSE l_char.
    CONCATENATE ls_crit_ahead-z_descripcio '( mín.' l_char ')' INTO ls_crit_ahead-z_descripcio
              SEPARATED BY space.
  ENDIF.
* ==> EDLSM
  ls_crit_ahead-z_punt_min       = 0 .
  ls_crit_ahead-z_punt_max       = 0 .
  ls_crit_ahead-z_sumatori       = 'X' .
  l_pond_ve = 1  .
  l_pond_vt = 1  .

  IF my_mode EQ co_mode_punct_tec OR
    my_mode EQ co_mode_punt_quadre2b OR my_mode EQ co_mode_punt_quadre3b. "MODIF ETODR SPEC-49075
    LOOP AT re_crit_punt ASSIGNING <ls_crit_punt>
             WHERE z_nivell_criteri EQ '01'
                   AND    z_crit_ve IS INITIAL
                       OR z_crit_ve EQ co_crit_tecnic
                       OR z_crit_ve EQ co_crit_val_tecnic
                       OR z_crit_ve = 'F'. "SPEC-48692
**    >> INI MODIF ETODR SPEC-49075
      "El criteri "Total" ha de mostrar els punts totals de cada màxim de cada graella
      IF my_mode EQ co_mode_punt_quadre2b. IF <ls_crit_punt>-z_crit_q2 = abap_off. CONTINUE. ENDIF. ENDIF.
      IF my_mode EQ co_mode_punt_quadre3b. IF <ls_crit_punt>-z_crit_q3 = abap_off. CONTINUE. ENDIF. ENDIF.
      IF my_mode EQ co_mode_punt_quadre4b. IF <ls_crit_punt>-z_crit_q4 = abap_off. CONTINUE. ENDIF. ENDIF.
**    << FI MODIF ETODR SPEC-49075
      CLEAR ls_sum_info .
*      ls_crit_ahead-z_punt_max = ls_crit_ahead-z_punt_max +
*                                 <ls_crit_punt>-z_ponderacio * <ls_crit_punt>-z_punt_max / 100 .
      ls_crit_ahead-z_punt_max = ls_crit_ahead-z_punt_max + <ls_crit_punt>-z_punt_max .
      ls_sum_info-z_codi_crit_punt = <ls_crit_punt>-z_codi_crit_punt .
*      ls_sum_info-z_ponderacio     = <ls_crit_punt>-z_ponderacio .
      ls_sum_info-z_ponderacio     = 100 .
      ls_sum_info-z_mod_crit_punt  = <ls_crit_punt>-z_mod_crit_punt .
*      IF <ls_crit_punt>-z_crit_ve EQ co_crit_tecnic .
*        l_pond_vt = <ls_crit_punt>-z_ponderacio / 100 .
*      ELSE .
*        l_pond_ve = <ls_crit_punt>-z_ponderacio / 100.
*      ENDIF .
      INSERT ls_sum_info INTO TABLE ls_crit_ahead-sum_info .
    ENDLOOP .
    IF sy-subrc EQ 0 .
*      IF l_pond_ve NE 1 OR l_pond_vt NE 1 .
*        WRITE: l_pond_ve TO l_pond_char_ve LEFT-JUSTIFIED DECIMALS 2,
*               l_pond_vt TO l_pond_char_vt LEFT-JUSTIFIED DECIMALS 2.
*
*        CONCATENATE 'Total (' l_pond_char_ve '*PE+'
*                              l_pond_char_vt '*PT)'
*               INTO ls_crit_ahead-z_descripcio .
*      ENDIF .
      INSERT ls_crit_ahead INTO TABLE re_crit_punt .
    ENDIF .
  ELSE.
    LOOP AT re_crit_punt ASSIGNING <ls_crit_punt>
         WHERE z_nivell_criteri EQ '01'
               AND    z_crit_ve IS INITIAL
                   OR z_crit_ve EQ co_crit_tecnic .
      CLEAR ls_sum_info .
      ls_crit_ahead-z_punt_max = ls_crit_ahead-z_punt_max +
                                 <ls_crit_punt>-z_ponderacio * <ls_crit_punt>-z_punt_max / 100 .
      ls_sum_info-z_codi_crit_punt = <ls_crit_punt>-z_codi_crit_punt .
      ls_sum_info-z_ponderacio     = <ls_crit_punt>-z_ponderacio .
      ls_sum_info-z_mod_crit_punt  = <ls_crit_punt>-z_mod_crit_punt .
      IF <ls_crit_punt>-z_crit_ve EQ co_crit_tecnic .
        l_pond_vt = <ls_crit_punt>-z_ponderacio / 100 .
      ELSE .
        l_pond_ve = <ls_crit_punt>-z_ponderacio / 100.
      ENDIF .
      INSERT ls_sum_info INTO TABLE ls_crit_ahead-sum_info .
    ENDLOOP .
    IF sy-subrc EQ 0 .
      IF l_pond_ve NE 1 OR l_pond_vt NE 1 .
        WRITE: l_pond_ve TO l_pond_char_ve LEFT-JUSTIFIED DECIMALS 2,
               l_pond_vt TO l_pond_char_vt LEFT-JUSTIFIED DECIMALS 2.

        CONCATENATE 'Total (' l_pond_char_ve '*PE+'
                              l_pond_char_vt '*PT)'
               INTO ls_crit_ahead-z_descripcio .
      ENDIF .
      INSERT ls_crit_ahead INTO TABLE re_crit_punt .
    ENDIF .
  ENDIF.
** >> INI MODIF ETODR SPEC-49075
  IF get_is_nova_llei_92017( ) = abap_on AND my_exp_cont_db-z_obert_preu = abap_off.
*    SELECT COUNT(*)
*      FROM  zrm_dt_punt_ofer
*      WHERE docclass = @my_exp_cont_db-docclass
*        AND objectid = @my_exp_cont_db-objectid.
*    IF sy-subrc <> 0.
    my_crit_punt_all = my_crit_punt_dyn = re_crit_punt.
    LOOP AT my_crit_punt_dyn ASSIGNING FIELD-SYMBOL(<fs_crit_tot_initial>) WHERE z_mod_crit_punt = im_mod_crit_punt
                                                                             AND ( z_crit_q4     = abap_off OR z_crit_ve = co_crit_economic ).
      DELETE my_crit_punt_dyn.
    ENDLOOP.
*    ENDIF.
    CASE im_mode.
      WHEN co_mode_punt_quadre4b.
        LOOP AT re_crit_punt ASSIGNING FIELD-SYMBOL(<fs_crit_q4>) WHERE z_mod_crit_punt = im_mod_crit_punt
                                                                    AND z_crit_q4       = abap_off
                                                                    AND z_codi_crit_punt IS NOT INITIAL.
          IF <fs_crit_q4>-z_resta = abap_on.
            CONTINUE.
          ELSE.
            DELETE re_crit_punt.
          ENDIF.
        ENDLOOP.
      WHEN co_mode_punt_quadre2b.
        LOOP AT re_crit_punt ASSIGNING FIELD-SYMBOL(<fs_crit_q2>) WHERE z_mod_crit_punt = im_mod_crit_punt
                                                                    AND z_crit_q2       = abap_off
                                                                    AND z_codi_crit_punt IS NOT INITIAL.
          IF <fs_crit_q2>-z_resta = abap_on.
            CONTINUE.
          ELSE.
            DELETE re_crit_punt.
          ENDIF.
        ENDLOOP.
      WHEN co_mode_punt_quadre3a.
        LOOP AT re_crit_punt ASSIGNING FIELD-SYMBOL(<fs_crit_q3a>) WHERE z_mod_crit_punt = im_mod_crit_punt
                                                                     AND z_crit_ve       <> co_crit_economic
                                                                     AND z_codi_crit_punt IS NOT INITIAL.
          DELETE re_crit_punt.
        ENDLOOP.
      WHEN co_mode_punt_quadre3b.
        LOOP AT re_crit_punt ASSIGNING FIELD-SYMBOL(<fs_crit_q3>) WHERE z_mod_crit_punt = im_mod_crit_punt
                                                                    AND z_crit_q3       = abap_off
                                                                    AND z_codi_crit_punt IS NOT INITIAL.
          DELETE re_crit_punt.
        ENDLOOP.
    ENDCASE.
  ENDIF.
** << FI MODIF ETODR SPEC-49075
ENDMETHOD.


METHOD read_and_check_form_val_econ.
  DATA: l_dummy    TYPE xfeld,                              "#EC NEEDED
        ls_formula TYPE zrm_dm_formules .

  IF im_plec-z_form_val_econ IS INITIAL .
    MESSAGE e023 WITH im_plec-z_num_plec INTO l_dummy .
    zcx_rm_valoracio=>raise_from_message( ) .
  ENDIF .

  CALL METHOD check_formula_exists
    EXPORTING
      im_codi_form  = im_plec-z_form_val_econ
      im_tipus_form = 'VE'
    RECEIVING
      re_formula    = ls_formula.

  re_formula_ve-z_descripcio = ls_formula-z_descripcio .

  SELECT SINGLE *
           FROM zrm_dm_param_ve
            INTO CORRESPONDING FIELDS OF re_formula_ve
          WHERE z_form_val_econ EQ im_plec-z_form_val_econ .
  IF sy-subrc NE 0 .
    MESSAGE e034 WITH im_plec-z_form_val_econ INTO l_dummy .
    zcx_rm_valoracio=>raise_from_message( ) .
  ENDIF .

  CASE re_formula_ve-z_tipus_form_ve .
    WHEN co_ve_type_hardcoded .
* EDCPC 01-09-2009 Es comenta el missatge d'error per l'aplicació de la fórmula VE9 hardcoded
*      MESSAGE e035 WITH im_plec-z_form_val_econ INTO l_dummy .
*      zcx_rm_valoracio=>raise_from_message( ) .

    WHEN co_ve_type_a .
      IF re_formula_ve-z_param_ve_f IS INITIAL .
        MESSAGE e037 WITH im_plec-z_form_val_econ INTO l_dummy .
        zcx_rm_valoracio=>raise_from_message( ) .
      ENDIF .
    WHEN co_ve_type_b .

    WHEN co_ve_type_c .

    WHEN OTHERS.
      MESSAGE e036 WITH im_plec-z_form_val_econ re_formula_ve-z_tipus_form_ve INTO l_dummy .
      zcx_rm_valoracio=>raise_from_message( ) .
  ENDCASE .
ENDMETHOD.


METHOD read_and_check_form_val_term.
  DATA: l_dummy    TYPE xfeld.                              "#EC NEEDED

  IF im_plec-z_form_val_term IS INITIAL .
    MESSAGE e024 WITH im_plec-z_num_plec INTO l_dummy .
    zcx_rm_valoracio=>raise_from_message( ) .
  ENDIF .

  IF im_plec-z_form_val_term NE 'VT1' .
    MESSAGE e076 WITH im_plec-z_form_val_term INTO l_dummy .
    zcx_rm_valoracio=>raise_from_message( ) .
  ENDIF .

  CALL METHOD check_formula_exists
    EXPORTING
      im_codi_form  = im_plec-z_form_val_term
      im_tipus_form = 'VT'
    RECEIVING
      re_formula    = re_formula_vt.

ENDMETHOD.


METHOD read_and_check_header.
  DATA: l_dummy TYPE c .                                    "#EC NEEDED
  DATA: ls_zrm_dt_exp_con type ZRM_DT_EXP_CONT.   "SPEC-83935 - EVMRG

  SELECT SINGLE * INTO re_header
          FROM zrm_dt_exp_cont
         WHERE     docclass EQ me->my_docclass
               AND objectid EQ me->my_objectid .

** >> INI MODIF ETODR SPEC-49075
  set_is_nova_llei_92017( re_header-z_llei92017 ).
** >> INI MODIF ETODR SPEC-49075
  IF re_header-z_llei92017 = abap_on AND re_header-z_obert_preu = abap_off.
    IF re_header-z_pressup_licit IS INITIAL .
      MESSAGE e008 INTO l_dummy .
      zcx_rm_valoracio=>raise_from_message( ) .
    ENDIF .
    CASE my_mode.
      WHEN co_mode_punt_quadre2b.
      WHEN co_mode_punt_quadre3b.
        IF re_header-z_pt_conf_dades IS INITIAL AND
*** INI SPEC-51062
         re_header-z_obert_simpl IS INITIAL AND
          re_header-z_proc_adj NE 'CE'
          AND re_header-z_proc_adj NE 'NB'."INI ETOVB SPEC-73390
*** FIN SPEC-51062
          MESSAGE e084 INTO l_dummy .
          zcx_rm_valoracio=>raise_from_message( ) .
        ENDIF.
      WHEN co_mode_punt_quadre4b.
        IF re_header-z_pres_tem_calc IS INITIAL.
          "INICI - SPEC-83935 - EVMRG

              CLEAR ls_zrm_dt_exp_con.

            SELECT single *
              INTO ls_zrm_dt_exp_con
              from zrm_dt_exp_cont
              where objectid = re_header-objectid.

            if ls_zrm_dt_exp_con-Z_PROC_ADJ = 'NB' and ( ls_zrm_dt_exp_con-Z_TIPUS_CONT = 'OB' OR ls_zrm_dt_exp_con-Z_TIPUS_CONT = 'SE')
              AND ( ls_zrm_dt_exp_con-Z_TIP_BAM = '14.2' OR ls_zrm_dt_exp_con-Z_TIP_BAM = '14.2A' ).

              ELSE.
            "FI - SPEC-83935 - EVMRG
          MESSAGE e013 INTO l_dummy .
          zcx_rm_valoracio=>raise_from_message( ) .
          ENDIF. "SPEC-83935 - EVMRG
        ENDIF.
*        IF my_exp_cont-z_q3_conf_dades IS INITIAL.
*          MESSAGE e106 INTO l_dummy .
*          zcx_rm_valoracio=>raise_from_message( ) .
*        ENDIF.
      WHEN co_mode_punt_quadre4b_sim. "ETODR SPEC-49921
        "en mode simulació no cal fer res, en principi... Per tant ens saltem validació i sobreescrivim valor pq faci mateixa lògica que el que volem, però simulant
        my_mode = co_mode_punt_quadre4b.
      WHEN OTHERS.
    ENDCASE.
  ELSE.
** << FI MODIF ETODR SPEC-49075
*-- Sense pressupost de licitació no podem fer els càlculs
    IF my_mode <> co_mode_punct_tec AND my_mode <> co_mode_punt_sol_part .
      IF re_header-z_pressup_licit IS INITIAL .
        MESSAGE e008 INTO l_dummy .
        zcx_rm_valoracio=>raise_from_message( ) .
      ENDIF .
*-- Si no s'han fet les tasques prèvies no es poder fer els càlculs
      IF re_header-z_proc_adj = 'NF' AND re_header-z_negociacio = 'X'."ADD P100031 NF
        " Els negociats nomès calculen temeritats en la segona fase
      ELSE.
        IF re_header-z_req_homog IS INITIAL .
**      >> INI MODIF ETODR SPEC-40278
*        IF re_header-z_pres_tem_calc IS INITIAL .
          IF re_header-z_pres_tem_calc IS INITIAL AND re_header-z_subtipus_cont <> 'CQ'.
**      << FI MODIF ETODR SPEC-40278
            MESSAGE e013 INTO l_dummy .
            zcx_rm_valoracio=>raise_from_message( ) .
          ENDIF .
        ELSE .
**      >> INI MODIF ETODR SPEC-40278
*        IF re_header-z_hom_tem_calc IS INITIAL .
          IF re_header-z_hom_tem_calc IS INITIAL  AND re_header-z_subtipus_cont <> 'CQ'.
**      << FI MODIF ETODR SPEC-40278
            MESSAGE e022 INTO l_dummy .
            zcx_rm_valoracio=>raise_from_message( ) .
          ENDIF .
        ENDIF .
      ENDIF.
*-- Per Reial Decret: Si no s'han confirmat les puntuacions tècniques no es poden fer els càlculs
      IF re_header-z_rd817_2009 IS NOT INITIAL.
        IF my_mode = co_mode_1_round OR
          my_mode = co_mode_punct_1st.
          IF re_header-z_pt_conf_dades IS INITIAL.
            MESSAGE e084 INTO l_dummy .
            zcx_rm_valoracio=>raise_from_message( ) .
          ENDIF.
        ENDIF.
      ENDIF.
    ENDIF.
  ENDIF.

ENDMETHOD.


  METHOD read_and_check_n_form_val_econ.

    DATA: l_dummy    TYPE xfeld,                            "#EC NEEDED
          ls_formula TYPE zrm_dm_formules.

    DATA: ls_n_formules  TYPE xfeld,
          ls_crit_punt   TYPE ty_s_crit_punt,
          info_formula_s TYPE ty_s_formula_n_param,
          info_formula_t TYPE ty_t_formula_n_param.


    CALL METHOD get_n_formules_ve
      EXPORTING
        im_plec      = im_plec
      IMPORTING
        e_n_formules = ls_n_formules.

    IF ls_n_formules = abap_true.

      LOOP AT im_crit_punt INTO ls_crit_punt WHERE z_crit_ve EQ co_crit_economic AND z_form_val_econ = ''.
        MESSAGE e104 WITH ls_crit_punt-z_codi_crit_punt ls_crit_punt-z_mod_crit_punt INTO l_dummy .
        zcx_rm_valoracio=>raise_from_message( ) .
      ENDLOOP.

      READ TABLE im_crit_punt TRANSPORTING NO FIELDS WITH KEY z_crit_ve = co_crit_economic.
      IF sy-subrc = 0.
        SELECT *
          FROM zrm_dm_param_ve
          INTO TABLE @DATA(lt_formules_ve_params)
          FOR ALL ENTRIES IN @im_crit_punt
          WHERE z_form_val_econ EQ @im_crit_punt-z_form_val_econ.

        SORT lt_formules_ve_params BY z_form_val_econ.
        DELETE ADJACENT DUPLICATES FROM lt_formules_ve_params COMPARING z_form_val_econ.

        LOOP AT im_crit_punt INTO ls_crit_punt WHERE z_crit_ve EQ co_crit_economic. "AND z_form_val_econ = im_plec-z_form_val_econ.
          CLEAR info_formula_s.
          info_formula_s-z_codi_crit_punt = ls_crit_punt-z_codi_crit_punt.
          info_formula_s-z_form_val_econ  = ls_crit_punt-z_form_val_econ.
          READ TABLE lt_formules_ve_params ASSIGNING FIELD-SYMBOL(<fs_param_formula>) WITH KEY z_form_val_econ = info_formula_s-z_form_val_econ.
          IF sy-subrc = 0.
            info_formula_s-z_form_val_econ = <fs_param_formula>-z_form_val_econ.
            info_formula_s-z_tipus_form_ve = <fs_param_formula>-z_tipus_form_ve.
            info_formula_s-z_param_ve_c    = <fs_param_formula>-z_param_ve_c.
            info_formula_s-z_param_ve_d    = <fs_param_formula>-z_param_ve_d.
            info_formula_s-z_param_ve_e    = <fs_param_formula>-z_param_ve_e.
            info_formula_s-z_param_ve_f    = <fs_param_formula>-z_param_ve_f.
          ENDIF.
          APPEND info_formula_s TO info_formula_t.
        ENDLOOP.
        re_formula_ve_n-info_formula = info_formula_t.
      ENDIF.

    ELSE.

      IF im_plec-z_form_val_econ IS INITIAL . "si no està informada
        MESSAGE e023 WITH im_plec-z_num_plec INTO l_dummy .
        zcx_rm_valoracio=>raise_from_message( ).

      ELSE.

        CLEAR info_formula_s.
        READ TABLE im_crit_punt INTO ls_crit_punt WITH KEY z_crit_ve = co_crit_economic.
*        LOOP AT im_crit_punt INTO ls_crit_punt WHERE z_crit_ve = co_crit_economic.
*          CLEAR info_formula_s.
        info_formula_s-z_codi_crit_punt = ls_crit_punt-z_codi_crit_punt.
        info_formula_s-z_form_val_econ  = im_plec-z_form_val_econ.
        APPEND info_formula_s TO info_formula_t.
*        ENDLOOP.
        re_formula_ve_n-info_formula = info_formula_t.

      ENDIF.

    ENDIF.


    CLEAR info_formula_s.
    LOOP AT re_formula_ve_n-info_formula INTO info_formula_s.

      CALL METHOD check_formula_exists
        EXPORTING
          im_codi_form  = info_formula_s-z_form_val_econ
          im_tipus_form = 'VE'
        RECEIVING
          re_formula    = ls_formula.

      info_formula_s-z_descripcio  = ls_formula-z_descripcio .
      info_formula_s-z_txt_formula = ls_formula-z_formula.

      SELECT SINGLE *
         FROM zrm_dm_param_ve
          INTO CORRESPONDING FIELDS OF info_formula_s
        WHERE z_form_val_econ EQ info_formula_s-z_form_val_econ .
      IF sy-subrc NE 0 .

        IF ls_n_formules = abap_true.
          MESSAGE e034 WITH ls_crit_punt-z_form_val_econ INTO l_dummy .
          zcx_rm_valoracio=>raise_from_message( ) .
        ELSE.
          MESSAGE e034 WITH im_plec-z_form_val_econ INTO l_dummy .
          zcx_rm_valoracio=>raise_from_message( ) .
        ENDIF.

      ENDIF.


      CASE info_formula_s-z_tipus_form_ve .
        WHEN co_ve_type_hardcoded .
* EDCPC 01-09-2009 Es comenta el missatge d'error per l'aplicació de la fórmula VE9 hardcoded
*      MESSAGE e035 WITH im_plec-z_form_val_econ INTO l_dummy .
*      zcx_rm_valoracio=>raise_from_message( ) .

        WHEN co_ve_type_a .
          IF info_formula_s-z_param_ve_f IS INITIAL .
            MESSAGE e037 WITH info_formula_s-z_form_val_econ INTO l_dummy .
            zcx_rm_valoracio=>raise_from_message( ) .
          ENDIF .
        WHEN co_ve_type_b .

        WHEN co_ve_type_c .

        WHEN OTHERS.
          MESSAGE e036 WITH info_formula_s-z_form_val_econ info_formula_s-z_tipus_form_ve INTO l_dummy .
          zcx_rm_valoracio=>raise_from_message( ) .
      ENDCASE .

      MODIFY re_formula_ve_n-info_formula FROM info_formula_s INDEX sy-tabix.

    ENDLOOP.


  ENDMETHOD.


METHOD read_and_check_offers.
  DATA: lt_oferta     TYPE zrm_tt_dt_ofertes,
        ls_ofertax    TYPE ty_s_ofertax,
        l_num_variant TYPE i,
        l_dummy       TYPE c .                              "#EC NEEDED
  FIELD-SYMBOLS: <ls_oferta>  TYPE zrm_dt_ofertes .
  FIELD-SYMBOLS: <ls_ofertax>  TYPE ty_s_ofertax .

  CLEAR ex_bmax .

  lt_oferta = im_ob_ofertes->obtenir_ofertes_exp( )  .
  DELETE lt_oferta WHERE z_renun_ofert IS NOT INITIAL .

  SORT lt_oferta BY proveidor ASCENDING z_tipus_oferta ASCENDING z_num_ofer ASCENDING .
  LOOP AT lt_oferta ASSIGNING <ls_oferta> .
    IF ls_ofertax-proveidor NE <ls_oferta>-proveidor .
      l_num_variant = 0 .
    ENDIF .
    CLEAR ls_ofertax .
    IF <ls_oferta>-z_tipus_oferta EQ zrm_cl_ofertes=>oferta_variant .
      ADD 1 TO l_num_variant .
    ENDIF .
    ls_ofertax-offer_data  = <ls_oferta> .
    ls_ofertax-vendor_data = complete_vendor_data( ls_ofertax-proveidor ) .
    ls_ofertax-num_variant = l_num_variant .
    INSERT ls_ofertax INTO TABLE ex_ofertesx .
  ENDLOOP .

** >> INI MODIF ETODR SPEC-49075
  IF get_is_nova_llei_92017( ) = abap_on AND my_exp_cont_db-z_obert_preu = abap_off.
    IF my_mode <> co_mode_punt_quadre2b.
      CALL METHOD recalculate_boi_bmax
        EXPORTING
          im_exp_cont = im_header
        CHANGING
          ch_ofertesx = ex_ofertesx
          ch_bmax     = ex_bmax.
    ELSE.
* En cas de exclosos per S2 i per var. tec. no es tenen en compte per a la sol·licitud de
* participants.
      LOOP AT ex_ofertesx ASSIGNING <ls_ofertax> .
        IF    <ls_ofertax>-z_exclos_s1         IS NOT INITIAL
           OR ( <ls_ofertax>-z_exclos_s2       IS NOT INITIAL AND my_mode NE co_mode_punt_sol_part )
           OR ( <ls_ofertax>-z_exclos_var_tec  IS NOT INITIAL AND my_mode NE co_mode_punt_sol_part )
           OR ( my_mode EQ co_mode_punct_tec AND <ls_ofertax>-z_pres_proposta IS INITIAL  AND
                my_exp_cont-z_proc_adj EQ co_adj_cr ).
          <ls_ofertax>-exclos = 'X' .
        ELSE .
          <ls_ofertax>-exclos = space .
        ENDIF .
      ENDLOOP.
    ENDIF.
    IF my_mode = co_mode_punt_quadre4b.
      "Es marquen com excloses aquelles que s'han exclós per clàusula del Plec al Q3
      LOOP AT ex_ofertesx ASSIGNING <ls_ofertax> WHERE z_exclos_plec IS NOT INITIAL.
        <ls_ofertax>-exclos = 'X' .
      ENDLOOP.
    ENDIF.
  ELSE.


** << FI MODIF ETODR SPEC-49075
    IF my_mode <> co_mode_punct_tec AND my_mode <> co_mode_punt_sol_part.

      CALL METHOD recalculate_boi_bmax
        EXPORTING
          im_exp_cont = im_header
        CHANGING
          ch_ofertesx = ex_ofertesx
          ch_bmax     = ex_bmax.

    ELSE.
* En cas de exclosos per S2 i per var. tec. no es tenen en compte per a la sol·licitud de
* participants.
      LOOP AT ex_ofertesx ASSIGNING <ls_ofertax> .
        IF    <ls_ofertax>-z_exclos_s1         IS NOT INITIAL
           OR ( <ls_ofertax>-z_exclos_s2       IS NOT INITIAL AND my_mode NE co_mode_punt_sol_part )
           OR ( <ls_ofertax>-z_exclos_var_tec  IS NOT INITIAL AND my_mode NE co_mode_punt_sol_part )
           OR ( my_mode EQ co_mode_punct_tec AND <ls_ofertax>-z_pres_proposta IS INITIAL  AND
                my_exp_cont-z_proc_adj EQ co_adj_cr ).
          <ls_ofertax>-exclos = 'X' .
        ELSE .
          <ls_ofertax>-exclos = space .
        ENDIF .
      ENDLOOP.

    ENDIF.
  ENDIF.

ENDMETHOD.


METHOD read_and_check_plec.
  DATA: l_dummy TYPE c.                                     "#EC NEEDED
  DATA: wa_mod_crit    TYPE zrm_dm_mod_crit.  "EDLSM
  DATA: wa_dades_equip TYPE zst_equip_max,
        lv_incr        TYPE xfeld,
        ls_incr        TYPE zrm_dt_punt_incr.

  IF im_header-z_num_plec IS INITIAL .
    MESSAGE e295(zrm_errors) INTO l_dummy .
    zcx_rm_valoracio=>raise_from_message( ) .
  ENDIF .

*---- El plec ha d'existir ---------------------
  SELECT SINGLE *
           INTO ex_plec
           FROM zrm_dm_plecs
          WHERE z_num_plec EQ im_header-z_num_plec .
  IF sy-subrc NE 0 .
    MESSAGE e007 WITH im_header-z_num_plec INTO l_dummy .
    zcx_rm_valoracio=>raise_from_message( ) .
  ENDIF .

*--- Criteris de puntuació primera volta --------------------
  IF ex_plec-z_mod_crit_punt IS INITIAL .
    MESSAGE e025 WITH im_header-z_num_plec INTO l_dummy .
    zcx_rm_valoracio=>raise_from_message( ) .
  ELSE .
**>> INI MODIF ETODR SPEC-40749
    DATA: l_mode TYPE char1.
    IF im_mode IS INITIAL.
      l_mode = my_mode.
    ELSE.
      l_mode = im_mode.
    ENDIF.
**<< FI MODIF ETODR SPEC-40749
**>> INI MODIF ETODR SPEC-40749
*    ex_crit_punt = read_and_check_crit_punt( ex_plec-z_mod_crit_punt ) .
    ex_crit_punt = read_and_check_crit_punt( im_mod_crit_punt = ex_plec-z_mod_crit_punt
                                             im_mode          = l_mode ) .
**<< FI MODIF ETODR SPEC-40749
  ENDIF .

* <== EDLSM 14/06/2010
  IF ex_plec-z_mod_crit_sol IS NOT INITIAL.
*   Es busca la puntuació mínima per a la solvència tècnica
    SELECT SINGLE * INTO wa_mod_crit
        FROM zrm_dm_mod_crit
        WHERE z_mod_crit_punt EQ ex_plec-z_mod_crit_sol.
    IF sy-subrc IS INITIAL.
      IF wa_mod_crit-z_flag_solv_tec IS NOT INITIAL AND
       wa_mod_crit-z_min_solv_tec IS INITIAL.
        MESSAGE e094 INTO l_dummy .
        zcx_rm_valoracio=>raise_from_message( ) .
      ELSE.
        ex_min_solv_tec = wa_mod_crit-z_min_solv_tec.
      ENDIF.
    ENDIF.
  ENDIF.
* ==> EDLSM


*--- Criteris de puntuació segona volta --------------------
  IF      im_header-z_proc_adj EQ 'CD'   "Doble Volta
       OR im_header-z_proc_adj EQ 'CI'.  "Idees
    "      OR im_header-z_proc_adj EQ 'CR' . "Restringit
    IF ex_plec-z_mod_crit_prop IS INITIAL .
      MESSAGE e026 WITH im_header-z_num_plec INTO l_dummy .
      zcx_rm_valoracio=>raise_from_message( ) .
    ELSE .
      ex_crit_punt_prop_graf = read_and_check_crit_punt( ex_plec-z_mod_crit_prop ) .
    ENDIF .
  ENDIF .

*--- Criteris de puntuació concurs restringit ----------------
  IF  im_header-z_proc_adj EQ 'CR'.
    IF ex_plec-z_mod_crit_sol IS INITIAL.
      MESSAGE e088 WITH im_header-z_num_plec INTO l_dummy .
      zcx_rm_valoracio=>raise_from_message( ) .
    ELSE.
      ex_crit_punt_sol_part = read_and_check_crit_punt( ex_plec-z_mod_crit_sol ) .
    ENDIF.
  ENDIF.

*-- En funció dels criteris de puntuació esbrinem quines fórmules necessitem informades
  DATA: lt_crit_punt LIKE ex_crit_punt,
        BEGIN OF ls_needed_formula,
          z_form_val_econ TYPE xfeld,
          z_form_val_term TYPE xfeld,
        END   OF ls_needed_formula.
  FIELD-SYMBOLS: <ls_crit_punt> LIKE LINE OF ex_crit_punt .

  lt_crit_punt = ex_crit_punt .
  INSERT LINES OF ex_crit_punt_prop_graf INTO TABLE lt_crit_punt .


  LOOP AT lt_crit_punt ASSIGNING <ls_crit_punt> WHERE z_crit_ve IS NOT INITIAL .
    CASE <ls_crit_punt>-z_crit_ve .
      WHEN co_crit_economic .    ls_needed_formula-z_form_val_econ = 'X' .
      WHEN co_crit_punt_tecnic .
      WHEN co_crit_tecnic .
      WHEN co_crit_termini .     ls_needed_formula-z_form_val_term = 'X' .
      WHEN co_crit_val_tecnic .
      WHEN 'F'.
      WHEN 'A'. "SPEC-75738 - ECMRG
      WHEN OTHERS .
        MESSAGE e028 WITH <ls_crit_punt>-z_codi_crit_punt <ls_crit_punt>-z_mod_crit_punt
                          <ls_crit_punt>-z_crit_ve  INTO l_dummy .
        zcx_rm_valoracio=>raise_from_message( ) .
    ENDCASE .
  ENDLOOP.

*>> SPEC-55535, Inici modificació - ETLJS
  LOOP AT lt_crit_punt ASSIGNING <ls_crit_punt> WHERE z_incr IS NOT INITIAL.

    lv_incr = abap_true.
    IF im_header-z_imin IS INITIAL.

      MESSAGE e115 INTO l_dummy .
      zcx_rm_valoracio=>raise_from_message( ) .
    ENDIF.

  ENDLOOP .
*<< SPEC-55535, Final modificació - ETLJS

  ">> SPEC-71214, Inici Modificació - ETODR
  READ TABLE lt_crit_punt TRANSPORTING NO FIELDS WITH KEY z_co2 = abap_on.
  IF sy-subrc = 0.
    set_punt_co2( ).
  ENDIF.
  "<< SPEC-71214, Final Modificació - ETODR

*--- Necessitem que les fórmules existeixin i estiguin ben parametritzades
  IF ls_needed_formula-z_form_val_econ EQ 'X' .
*    ex_formula_ve = read_and_check_form_val_econ( ex_plec ) .
    ex_formula_ve_n = read_and_check_n_form_val_econ( EXPORTING im_plec = ex_plec im_crit_punt = ex_crit_punt ) .
  ENDIF .

  IF ls_needed_formula-z_form_val_term EQ 'X' .
    ex_formula_vt = read_and_check_form_val_term( ex_plec ) .
  ENDIF .

* >>INI ETLJS SPEC-47173

  DATA: ls_crit_punt TYPE ty_s_crit_punt,
        lv_cargo     TYPE string.

  CLEAR gt_equip.
  SELECT * FROM zrm_dt_punt_equi
    INTO TABLE @gt_equip
    WHERE docclass    EQ @my_docclass AND
          objectid    EQ @my_objectid." AND
*          z_is_header EQ @abap_off. "INI MODIF ETODR SPEC-49500 "SPEC-49806

*>> SPEC-55535, Inici modificació - ETLJS
  IF lv_incr IS NOT INITIAL.
    CLEAR gt_incr.
    SELECT * FROM zrm_dt_punt_incr
       INTO TABLE @gt_incr
            WHERE docclass    EQ @my_docclass AND
                  objectid    EQ @my_objectid.

    CLEAR gt_incr_aux.
    LOOP AT lt_crit_punt ASSIGNING FIELD-SYMBOL(<fs_crit_punt>)
      WHERE z_incr IS NOT INITIAL.
      DATA(lv_tabix) = sy-tabix.

      ls_incr-docclass = my_docclass.
      ls_incr-objectid = my_objectid.
      ls_incr-z_carrec = 'Y9'. "Cap d'obra
      ls_incr-z_mod_crit_punt = <fs_crit_punt>-z_mod_crit_punt.
      ls_incr-z_codi_crit_punt = <fs_crit_punt>-z_codi_crit_punt.
      ls_incr-z_comptador_equip = 1.
      ls_incr-z_imin = im_header-z_imin.
      APPEND ls_incr TO gt_incr_aux.

    ENDLOOP.
  ENDIF.
*<< SPEC-55535, Final modificació - ETLJS

  DATA(lt_equip) = gt_equip.
  SORT lt_equip BY z_codi_crit_punt z_comptador_equip.
  DELETE ADJACENT DUPLICATES FROM lt_equip COMPARING z_codi_crit_punt z_comptador_equip.
**>> INI MODIF ETODR SPEC-49806
  "Per defecte l'equip màxim es considera l'equip bàsic, en cas que s'afegexi equips, ja es recalcula el valor de Z_EQUIP_MAX
  "A la graella de puntuacions principal només s'ha de mostrar la informació referent a l'equip més ben puntuat
  READ TABLE ex_crit_punt TRANSPORTING NO FIELDS WITH KEY z_equip_max = abap_on.
  IF sy-subrc = 0.
    DATA(lv_modcrit_equip_max) = abap_on.
  ENDIF.
**<< FI MODIF ETODR SPEC-49806
**>> INI MODIF ETODR SPEC-51135
  READ TABLE ex_crit_punt TRANSPORTING NO FIELDS WITH KEY z_equip_coautor = abap_on.
  "A la graella de puntuacions principal només s'ha de mostrar la informació referent a l'equip amb la puntuació resultant total
  IF sy-subrc = 0.
    DATA(lv_modcrit_equip_coautor) = abap_on.
  ENDIF.
**<< FI MODIF ETODR SPEC-51135
**>> INI MODIF ETODR SPEC-67070
  LOOP AT ex_crit_punt TRANSPORTING NO FIELDS WHERE z_coeficient_iref IS NOT INITIAL .
    "A la graella de puntuacions principal només s'ha de mostrar la informació referent a l'equip amb la puntuació resultant total
    DATA(lv_coeficient_iref) = abap_on.
    EXIT.
  ENDLOOP.
**<< FI MODIF ETODR SPEC-67070

  DATA(lt_crit_punt_temp) = ex_crit_punt.
  CLEAR ex_crit_punt.
**>> INI MODIF ETODR SPEC-49806
**  >> INI MODIF ETODR SPEC-51135
*  IF lv_modcrit_equip_max = abap_on.
**>> INI MODIF ETODR SPEC-67070
*  IF lv_modcrit_equip_max = abap_on OR lv_modcrit_equip_coautor = abap_on.
  IF lv_modcrit_equip_max = abap_on OR lv_modcrit_equip_coautor = abap_on OR
     lv_coeficient_iref   = abap_on.
**<< FI MODIF ETODR SPEC-67070
    "Quan es defineix l'equip per la Redacció de Projectes, només mostrem el criteri capçalera ja que varia per cada oferta
**  << FI MODIF ETODR SPEC-51135
    "Quan es defineix equip màxim, només mostrem el criteri capçalera ja que l'equip varia cada cop per cada oferta en funció del que es puntuiï
    LOOP AT lt_crit_punt_temp INTO ls_crit_punt.
      READ TABLE lt_equip TRANSPORTING NO FIELDS WITH KEY z_codi_crit_punt = ls_crit_punt-z_codi_crit_punt.
      IF sy-subrc EQ 0.
        READ TABLE lt_equip TRANSPORTING NO FIELDS WITH KEY z_codi_crit_punt = ls_crit_punt-z_codi_crit_punt
                                                            z_is_header      = abap_on.
        IF sy-subrc = 0.
          APPEND ls_crit_punt TO ex_crit_punt.
        ENDIF.
      ELSE.
        APPEND ls_crit_punt TO ex_crit_punt.
      ENDIF.

    ENDLOOP.
  ELSE.
    DELETE lt_equip WHERE z_is_header = abap_on. "Per la resta de models de puntuació que tenen equip però no es calcula en funció del màxim, no s'ha de mostrar la capçalera de cadascun, només la bàsica
**<< FI MODIF ETODR SPEC-49806
    LOOP AT lt_crit_punt_temp INTO ls_crit_punt.
      READ TABLE lt_equip TRANSPORTING NO FIELDS WITH KEY z_codi_crit_punt = ls_crit_punt-z_codi_crit_punt.
      IF sy-subrc EQ 0.
        DATA(lv_descripcio) = ls_crit_punt-z_descripcio.
        LOOP AT lt_equip ASSIGNING FIELD-SYMBOL(<fs_equip>) WHERE z_codi_crit_punt = ls_crit_punt-z_codi_crit_punt.
          ls_crit_punt-z_ponderacio = <fs_equip>-z_pes.
          ls_crit_punt-z_num_equip  = <fs_equip>-z_comptador_equip.
          ls_crit_punt-z_equip      = abap_true.
          ls_crit_punt-z_punt_max   = <fs_equip>-z_punt_max. "SPEC-49500

          CALL FUNCTION 'CONVERSION_EXIT_CARRE_OUTPUT'
            EXPORTING
              input  = <fs_equip>-z_carrec_equip
            IMPORTING
              output = lv_cargo.
**        >> INI MODIF ETODR SPEC-49806
          CONCATENATE lv_descripcio '-' lv_cargo <fs_equip>-z_descripcio
                 INTO ls_crit_punt-z_descripcio SEPARATED BY space.
*          CONCATENATE lv_cargo <fs_equip>-z_descripcio lv_descripcio
*                 INTO ls_crit_punt-z_descripcio SEPARATED BY space.
**        << FI MODIF ETODR SPEC-49806
          APPEND ls_crit_punt TO ex_crit_punt.
        ENDLOOP.
      ELSE.
        APPEND ls_crit_punt TO ex_crit_punt.
      ENDIF.

    ENDLOOP.
  ENDIF.


* <<FIN ETLJS SPEC-47173

** >> INI MODIF ETODR SPEC-49806
*  DATA(lt_crit_punt_temp) = ex_crit_punt.
  CLEAR my_crit_punt_equi.
  DELETE lt_equip WHERE z_equip_basic = abap_off.
  LOOP AT lt_crit_punt_temp INTO ls_crit_punt.
    READ TABLE lt_equip ASSIGNING FIELD-SYMBOL(<fs_tmp>) WITH KEY z_codi_crit_punt = ls_crit_punt-z_codi_crit_punt.
    IF sy-subrc EQ 0.
      IF <fs_tmp>-z_is_header = abap_on. CONTINUE. ENDIF.
      lv_descripcio = ls_crit_punt-z_descripcio.
      LOOP AT lt_equip ASSIGNING <fs_equip> WHERE z_codi_crit_punt = ls_crit_punt-z_codi_crit_punt.
***********************************      >> INI MODIF ETODR SPEC-49806
*********************************        "Com que pot haver-hi equips màxims diferents per cada oferta, guardem taula d'equips
*********************************        LOOP AT lt_equip_max ASSIGNING FIELD-SYMBOL(<fs_equip_max>) WHERE z_comptador_equip = <fs_equip>-z_comptador_equip.
*********************************          LOOP AT gt_equip ASSIGNING FIELD-SYMBOL(<fs_aux>) WHERE z_comptador_equip = <fs_equip_max>-z_comptador_equip.
*********************************            CLEAR: wa_dades_equip.
*********************************            wa_dades_equip-z_descripcio       = <fs_aux>-z_descripcio.
*********************************            wa_dades_equip-z_carrec_equip     = <fs_aux>-z_carrec_equip.
*********************************            wa_dades_equip-z_num_ofer         = <fs_aux>-z_num_ofer.
*********************************            wa_dades_equip-z_comptador_equip  = <fs_aux>-z_comptador_equip.
*********************************            wa_dades_equip-z_pes              = <fs_aux>-z_pes.
*********************************            READ TABLE ls_crit_punt-equip_max TRANSPORTING NO FIELDS WITH KEY z_comptador_equip = <fs_aux>-z_comptador_equip
*********************************                                                                              z_carrec_equip    = <fs_aux>-z_carrec_equip
*********************************                                                                              z_num_ofer        = <fs_aux>-z_num_ofer.
*********************************            IF sy-subrc <> 0.
*********************************              APPEND wa_dades_equip TO ls_crit_punt-equip_max.
*********************************            ENDIF.
*********************************          ENDLOOP.
*********************************          DELETE lt_equip_max.
*********************************        ENDLOOP.
*********************************        IF sy-subrc <> 0. CONTINUE. ENDIF.
***********************************      << FI MODIF ETODR SPEC-49806
        ls_crit_punt-z_ponderacio = <fs_equip>-z_pes.
        ls_crit_punt-z_num_equip  = <fs_equip>-z_comptador_equip.
        ls_crit_punt-z_equip      = abap_true.
        ls_crit_punt-z_punt_max   = <fs_equip>-z_punt_max. "SPEC-49500
        CALL FUNCTION 'CONVERSION_EXIT_CARRE_OUTPUT'
          EXPORTING
            input  = <fs_equip>-z_carrec_equip
          IMPORTING
            output = lv_cargo.

        CONCATENATE lv_cargo '-' lv_descripcio INTO ls_crit_punt-z_descripcio SEPARATED BY space.
        APPEND ls_crit_punt TO my_crit_punt_equi.
      ENDLOOP.
    ELSE.
      APPEND ls_crit_punt TO my_crit_punt_equi.
    ENDIF.

  ENDLOOP.
** >> INI MODIF ETODR SPEC-49806

ENDMETHOD.


METHOD read_and_check_punt_lema.
  DATA:   ls_punt_lema TYPE ty_s_punt_gen,
          ls_crit_punt TYPE ty_s_crit_punt .
  FIELD-SYMBOLS: <ls_lema> TYPE zrm_dt_lemes .

  SELECT z_num_lema AS z_num_gen z_mod_crit_punt z_codi_crit_punt z_punts
          INTO CORRESPONDING FIELDS OF TABLE ex_punt_lema_db
         FROM zrm_dt_punt_lema
        WHERE     docclass EQ im_header-docclass
              AND objectid EQ im_header-objectid .
  CHECK ex_punt_lema IS REQUESTED .

  ex_punt_lema = ex_punt_lema_db .
  CLEAR ex_consistency .

*-- Puntuació d'lema --------------------------------------------------------------------
  LOOP AT ex_punt_lema INTO ls_punt_lema .
    IF ls_punt_lema-z_mod_crit_punt NE im_mod_crit_punt .
      ex_consistency-model_has_changed = 'X' .
    ENDIF .
    READ TABLE im_crit_punt TRANSPORTING NO FIELDS
                            WITH TABLE KEY z_mod_crit_punt  = ls_punt_lema-z_mod_crit_punt
                                           z_codi_crit_punt = ls_punt_lema-z_codi_crit_punt .
    CHECK sy-subrc NE 0 .
* A l'lema tenim puntuació d'un criteri que no està a la parametrització. Canvi de plec, potser??
    DELETE ex_punt_lema .
    ex_consistency-deleted_criteria = 'X' .
  ENDLOOP .

  LOOP AT im_lema ASSIGNING <ls_lema> .
    LOOP AT im_crit_punt INTO ls_crit_punt .
      READ TABLE ex_punt_lema TRANSPORTING NO FIELDS
                              WITH TABLE KEY z_codi_crit_punt = ls_crit_punt-z_codi_crit_punt
                                             z_mod_crit_punt  = ls_crit_punt-z_mod_crit_punt
                                             z_num_gen        = <ls_lema>-z_num_lema .
      CHECK sy-subrc NE 0 .
* No tinc la puntuacio d'un criteri que pertany al model. Es perfectament normal la primera
* vegada que es crida al programa però no si ja s'havia puntuat abans.
      IF ls_crit_punt-z_codi_crit_punt NE co_codi_crit_total .
        ex_consistency-new_criteria   = 'X' .
      ENDIF .
      CLEAR ls_punt_lema .
      ls_punt_lema-z_num_gen        = <ls_lema>-z_num_lema .
      ls_punt_lema-z_mod_crit_punt  = ls_crit_punt-z_mod_crit_punt .
      ls_punt_lema-z_codi_crit_punt = ls_crit_punt-z_codi_crit_punt .
      INSERT ls_punt_lema INTO TABLE ex_punt_lema .
    ENDLOOP .
  ENDLOOP .

  IF ex_punt_lema_db IS INITIAL .
    CLEAR ex_consistency-new_criteria .
  ENDIF .


ENDMETHOD.


METHOD read_and_check_punt_ofer.

  DATA: ls_punt_ofer TYPE ty_s_punt_gen,
        ls_crit_punt TYPE ty_s_crit_punt,
        l_lines      TYPE i,
        l_tab1       TYPE i,
        l_tab2       TYPE i,
        lt_crit_punt LIKE im_crit_punt,
        l_dummy      TYPE c.

  " >>>PSPEC-1541 Inici modificació - EVXGL
  DATA: lt_zrm_dt_punt_cap TYPE TABLE OF zrm_dt_punt_cap,
        ls_zrm_dt_punt_cap TYPE zrm_dt_punt_cap,
        ls_ex_punt_ofer_db LIKE LINE OF  ex_punt_ofer_db.
  " <<<PSPEC-1541 Fi modificació - EVXGL

  DATA: l_changed TYPE xfeld.

  FIELD-SYMBOLS: <ls_oferta>    TYPE ty_s_ofertax,
                 <ls_crit_punt> TYPE ty_s_crit_punt.

* >>INI ETLJS SPEC-47173
  SELECT * FROM zrm_dt_punt_equi
    INTO TABLE @DATA(lt_equip)
    WHERE docclass    EQ @my_docclass AND
          objectid    EQ @my_objectid AND
          z_is_header EQ @abap_off. "ETODR SPEC-49500
* <<FIN ETLJS SPEC-47173

** >> INI MODIF ETODR SPEC-51135
  IF gt_equip[] IS NOT INITIAL.
    CLEAR: lt_equip.
    LOOP AT gt_equip ASSIGNING FIELD-SYMBOL(<fs_equip_aux>) WHERE z_is_header EQ abap_off.
      APPEND <fs_equip_aux> TO lt_equip.
    ENDLOOP.
  ENDIF.
** << FI MODIF ETODR SPEC-51135

**>> INI MODIF ETODR SPEC-50770
  IF lt_equip[] IS NOT INITIAL.
    SELECT *
      FROM zrm_dt_punt_sel
      INTO TABLE @DATA(lt_equip_sel)
      FOR ALL ENTRIES IN @lt_equip
      WHERE docclass = @lt_equip-docclass
        AND objectid = @lt_equip-objectid.
  ENDIF.
**<< FI MODIF ETODR SPEC-50770

  " >>>PSPEC-1451 Inici modificació - EVXGL
*    " ZRM_DT_PUNT_OFER
*    SELECT z_num_ofer AS z_num_gen z_mod_crit_punt z_codi_crit_punt z_punts
*      INTO CORRESPONDING FIELDS OF TABLE ex_punt_ofer_db
*        FROM zrm_dt_punt_ofer
*         WHERE docclass EQ im_header-docclass
*           AND objectid EQ im_header-objectid.

  CLEAR: ex_punt_ofer_db.

  IF my_mode EQ co_mode_val_cap_obra.    " Node Organizer -> Verificació Cap D'Obra

    READ TABLE im_crit_punt WITH KEY z_verif_cap_obra = 'X' INTO DATA(l_verif_cap_obra).
    DATA: g_docclass_pare TYPE bapidclass,
          g_objectid_pare TYPE bapiguid,
          g_docclass_fill TYPE bapidclass,
          g_objectid_fill TYPE bapiguid.

    CLEAR: g_docclass_pare,
           g_objectid_pare,
           g_docclass_fill,
           g_objectid_fill.

    GET PARAMETER ID 'DOCCLASS_PARE_VCO' FIELD g_docclass_pare.
    GET PARAMETER ID 'OBJECTID_PARE_VCO' FIELD g_objectid_pare.

    GET PARAMETER ID 'DOCCLASS_FILL_VCO' FIELD g_docclass_fill.
    GET PARAMETER ID 'OBJECTID_FILL_VCO' FIELD g_objectid_fill.


    IF sy-subrc = 0.
      " ZRM_DT_PUNT_OFER
      SELECT z_num_ofer AS z_num_gen z_mod_crit_punt z_codi_crit_punt z_punts
        INTO CORRESPONDING FIELDS OF TABLE ex_punt_ofer_db
          FROM zrm_dt_punt_ofer
           WHERE docclass EQ im_header-docclass
             AND objectid EQ im_header-objectid.

      " ZRM_DT_PUNT_CAP
      CLEAR: ls_zrm_dt_punt_cap.
      SELECT SINGLE *
         FROM zrm_dt_punt_cap
          INTO ls_zrm_dt_punt_cap
            WHERE docclass EQ g_docclass_pare         " DOCCLASS Pare
              AND objectid EQ g_objectid_pare         " OBJECTID Pare
              AND docclass_fill EQ g_docclass_fill    " DOCCLASS Fill
              AND objectid_fill EQ g_objectid_fill.   " OBJECTID Fill

      IF ls_zrm_dt_punt_cap IS NOT INITIAL.
        CLEAR: ls_ex_punt_ofer_db,
               lt_zrm_dt_punt_cap.

        LOOP AT ex_punt_ofer_db INTO ls_ex_punt_ofer_db.
          CLEAR ls_zrm_dt_punt_cap.
          SELECT SINGLE *
           FROM zrm_dt_punt_cap
            INTO  CORRESPONDING FIELDS OF ls_zrm_dt_punt_cap
             WHERE docclass EQ g_docclass_pare                             " DOCCLASS Pare
               AND objectid EQ g_objectid_pare                             " OBJECTID Pare
               AND docclass_fill EQ g_docclass_fill                        " DOCCLASS Fill
               AND objectid_fill EQ g_objectid_fill                        " OBJECTID Fill
               AND z_mod_crit_punt EQ ls_ex_punt_ofer_db-z_mod_crit_punt
               AND z_codi_crit_punt EQ ls_ex_punt_ofer_db-z_codi_crit_punt
               AND z_num_ofer EQ ls_ex_punt_ofer_db-z_num_gen.

          APPEND ls_zrm_dt_punt_cap TO lt_zrm_dt_punt_cap.
          CLEAR: ls_ex_punt_ofer_db.
        ENDLOOP.

        IF lt_zrm_dt_punt_cap IS NOT INITIAL.
          CLEAR:  ex_punt_ofer_db.
          LOOP AT lt_zrm_dt_punt_cap INTO ls_zrm_dt_punt_cap.
            MOVE-CORRESPONDING ls_zrm_dt_punt_cap TO ls_ex_punt_ofer_db.
            ls_ex_punt_ofer_db-z_num_gen = ls_zrm_dt_punt_cap-z_num_ofer.
            APPEND ls_ex_punt_ofer_db TO ex_punt_ofer_db.
          ENDLOOP.
        ENDIF.
      ENDIF.
    ENDIF.

  ELSE.
    " ZRM_DT_PUNT_OFER
    SELECT z_num_ofer AS z_num_gen z_mod_crit_punt z_codi_crit_punt z_punts
      INTO CORRESPONDING FIELDS OF TABLE ex_punt_ofer_db
        FROM zrm_dt_punt_ofer
         WHERE docclass EQ im_header-docclass
           AND objectid EQ im_header-objectid.

  ENDIF.
  "   <<<PSPEC-1451 Fi modificació - EVXGL


  CHECK ex_punt_ofer IS REQUESTED.


**  >> INI MODIF ETODR SPEC-51139 Només tenim en compte les no renunciades
  IF my_ob_ofertes IS BOUND.
    LOOP AT ex_punt_ofer_db INTO ls_punt_ofer.
      IF my_ob_ofertes->es_oferta_retirada( CONV #( ls_punt_ofer-z_num_gen ) ) = abap_on.
        DELETE ex_punt_ofer    WHERE z_num_gen = ls_punt_ofer-z_num_gen.
        DELETE ex_punt_ofer_db WHERE z_num_gen = ls_punt_ofer-z_num_gen.
      ENDIF.
    ENDLOOP.
  ELSE.
    LOOP AT ex_punt_ofer_db INTO ls_punt_ofer.
      READ TABLE im_ofertesx TRANSPORTING NO FIELDS WITH KEY z_num_ofer = ls_punt_ofer-z_num_gen.
      IF sy-subrc <> 0.
        DELETE ex_punt_ofer_db WHERE z_num_gen = ls_punt_ofer-z_num_gen.
      ENDIF.
    ENDLOOP.
  ENDIF.
**  << FI MODIF ETODR SPEC-51139

  CLEAR ex_consistency .
* >>INI ETLJS SPEC-47173
*  ex_punt_ofer = ex_punt_ofer_db .
  CLEAR ex_punt_ofer.
** >> INI MODIF ETODR SPEC-49806
  "Per defecte l'equip màxim es considera l'equip bàsic, en cas que s'afegexi equips, ja es recalcula el valor de Z_EQUIP_MAX
  "A la graella de puntuacions principal només s'ha de mostrar la informació referent a l'equip més ben puntuat
***  DELETE lt_equip WHERE z_equip_max <> abap_on.
*  READ TABLE im_crit_punt TRANSPORTING NO FIELDS WITH KEY z_equip_max = abap_on.
*  IF sy-subrc = 0.
*    DATA(lv_modcrit_equip_max) = abap_on.
*  ENDIF.
** << FI MODIF ETODR SPEC-49806
  LOOP AT ex_punt_ofer_db INTO  ls_punt_ofer.
    DATA(lv_tabix) = sy-tabix."ETLJS SPEC-49806
    READ TABLE lt_equip TRANSPORTING NO FIELDS WITH KEY z_codi_crit_punt = ls_punt_ofer-z_codi_crit_punt
                                                        z_num_ofer       = ls_punt_ofer-z_num_gen.
    IF sy-subrc EQ 0.
      DELETE ex_punt_ofer_db  INDEX lv_tabix."ETLJS SPEC-49806
**    >> INI MODIF ETODR SPEC-49806
*      IF lv_modcrit_equip_max = abap_on.
*        READ TABLE lt_equip TRANSPORTING NO FIELDS WITH KEY z_codi_crit_punt = ls_punt_ofer-z_codi_crit_punt
*                                                            z_is_header      = abap_on.
*        IF sy-subrc = 0.
*          APPEND ls_punt_ofer TO ex_punt_ofer.
*        ENDIF.
*      ELSE.
**    << FI MODIF ETODR SPEC-49806
      LOOP AT lt_equip ASSIGNING FIELD-SYMBOL(<fs_equip>) WHERE z_codi_crit_punt = ls_punt_ofer-z_codi_crit_punt AND
                                                                z_num_ofer       = ls_punt_ofer-z_num_gen.
**      >> INI MODIF ETODR SPEC-50770
*        ls_punt_ofer-z_punts = <fs_equip>-z_punts.
        CLEAR: ls_punt_ofer-z_punts.
        LOOP AT lt_equip_sel ASSIGNING FIELD-SYMBOL(<fs_equip_sel>) WHERE z_codi_crit_punt    = ls_punt_ofer-z_codi_crit_punt
                                                                      AND z_num_ofer          = ls_punt_ofer-z_num_gen
                                                                      AND z_comptador_recurs  = <fs_equip>-z_comptador_equip.
          ADD <fs_equip_sel>-z_punts TO ls_punt_ofer-z_punts.
        ENDLOOP.
        IF sy-subrc <> 0 OR <fs_equip_sel>-z_punts IS INITIAL.
          ls_punt_ofer-z_punts = <fs_equip>-z_punts.
        ENDIF.
**      < FI MODIF ETODR SPEC-50770
        ls_punt_ofer-z_num_equip = <fs_equip>-z_comptador_equip.
        ls_punt_ofer-z_carrec_equip = <fs_equip>-z_carrec_equip. "ETODR SPEC-49498
        ls_punt_ofer-z_equip_max    = <fs_equip>-z_equip_max. "ETODR SPEC-49498
        ls_punt_ofer-z_pes          = <fs_equip>-z_pes.
        APPEND ls_punt_ofer TO ex_punt_ofer.
      ENDLOOP.
*      ENDIF.
    ELSE.
      APPEND ls_punt_ofer TO ex_punt_ofer.
    ENDIF.
  ENDLOOP.
  ex_punt_ofer_db[] = ex_punt_ofer[].
  CLEAR ls_punt_ofer. "ETLJS SPEC-49806
* <<FIN ETLJS SPEC-47173
  IF my_mode = co_mode_punct_tec OR
    my_mode EQ co_mode_punt_quadre2b. "MODIF ETODR SPEC-49075

    SELECT * INTO CORRESPONDING FIELDS OF TABLE lt_crit_punt
       FROM zrm_dm_crit_punt
       WHERE z_mod_crit_punt EQ im_mod_crit_punt .

    IF sy-subrc NE 0 .
      MESSAGE e027 WITH im_mod_crit_punt INTO l_dummy .
      zcx_rm_valoracio=>raise_from_message( ) .
    ENDIF .

    READ TABLE lt_crit_punt ASSIGNING <ls_crit_punt> WITH KEY z_mod_crit_punt = im_mod_crit_punt
                                                              z_crit_ve = co_crit_val_tecnic.
    IF sy-subrc <> 0 .
*** INI ETOVB SPEC-48889
      READ TABLE lt_crit_punt ASSIGNING <ls_crit_punt> WITH KEY z_mod_crit_punt = im_mod_crit_punt
                                                              z_crit_ve = 'F'.
      IF sy-subrc <> 0 .
*** FIN ETOVB SPEC-48889
        READ TABLE lt_crit_punt ASSIGNING <ls_crit_punt> WITH KEY z_mod_crit_punt = im_mod_crit_punt
                                                              z_crit_ve = co_crit_tecnic.
*** INI ETOVB SPEC-48889
      ENDIF.
*** FIN ETOVB SPEC-48889
    ENDIF.

    l_tab1 = sy-tabix - 1.
    l_tab2 = sy-tabix + 1.

*  Mirem si hi ha més criteris d'altres tipus després i els esborrem
    LOOP AT lt_crit_punt ASSIGNING <ls_crit_punt> FROM l_tab2 WHERE z_crit_ve IS NOT INITIAL.
      EXIT.
    ENDLOOP.

    IF sy-subrc = 0.
      l_tab2 = sy-tabix.
      LOOP AT lt_crit_punt ASSIGNING <ls_crit_punt> FROM l_tab2 .
        DELETE ex_punt_ofer WHERE z_mod_crit_punt  = im_mod_crit_punt AND
                                  z_codi_crit_punt = <ls_crit_punt>-z_codi_crit_punt.
      ENDLOOP.
    ENDIF.

*  Ens carreguem els criteris que no són tècnics situats avans dels tècnics
    IF l_tab1 GE 1.
      LOOP AT lt_crit_punt ASSIGNING <ls_crit_punt> TO l_tab1 .
        DELETE ex_punt_ofer WHERE z_mod_crit_punt  = im_mod_crit_punt AND
                                  z_codi_crit_punt = <ls_crit_punt>-z_codi_crit_punt.
      ENDLOOP.
    ENDIF.

    ex_punt_ofer_db = ex_punt_ofer .

  ENDIF.
*  ENDIF.
** >> INI MODIF ETODR SPEC-49075
**          ">>>SPEC-55448, Inici modificació  - ETODR
*  IF my_mode EQ co_mode_punt_quadre3b OR my_mode EQ co_mode_punt_quadre4b AND get_is_nova_llei_92017( ) = abap_on AND my_exp_cont_db-z_obert_preu = abap_off.
  IF my_mode EQ co_mode_millor_classif OR my_mode EQ co_mode_punt_quadre3b OR my_mode EQ co_mode_punt_quadre4b AND get_is_nova_llei_92017( ) = abap_on AND my_exp_cont_db-z_obert_preu = abap_off.
**          "<<<SPEC-55448, Final modificació - ETODR
    "Per a la puntuació dels nous plecs, al puntuar el 3B i 4B la graella de puntuacions canvia, cal saltar-se la lògica de "deleted_criteria"
    LOOP AT ex_punt_ofer INTO ls_punt_ofer .
      IF ls_punt_ofer-z_mod_crit_punt NE im_mod_crit_punt .
        ex_consistency-model_has_changed = 'X' .
        EXIT.
      ENDIF .
    ENDLOOP .
  ELSE.
** << FI MODIF ETODR SPEC-49075
*-- Puntuació d'ofertes --------------------------------------------------------------------
    LOOP AT ex_punt_ofer INTO ls_punt_ofer .
      IF ls_punt_ofer-z_mod_crit_punt NE im_mod_crit_punt .
        ex_consistency-model_has_changed = 'X' .
      ENDIF .
      READ TABLE im_crit_punt TRANSPORTING NO FIELDS
                              WITH TABLE KEY z_mod_crit_punt  = ls_punt_ofer-z_mod_crit_punt
                                             z_codi_crit_punt = ls_punt_ofer-z_codi_crit_punt .
      CHECK sy-subrc NE 0 .
* A l'oferta tenim puntuació d'un criteri que no està a la parametrització. Canvi de plec, potser??
      DELETE ex_punt_ofer .
      ex_consistency-deleted_criteria = 'X' .
    ENDLOOP .
  ENDIF.
  LOOP AT im_ofertesx ASSIGNING <ls_oferta> .
    LOOP AT im_crit_punt INTO ls_crit_punt .
      READ TABLE ex_punt_ofer TRANSPORTING NO FIELDS
                              WITH TABLE KEY z_codi_crit_punt = ls_crit_punt-z_codi_crit_punt
                                             z_mod_crit_punt  = ls_crit_punt-z_mod_crit_punt
                                             z_num_gen        = <ls_oferta>-z_num_ofer .
      CHECK: sy-subrc NE 0.
** >> INI MODIF ETODR SPEC-49075
      "Per a la puntuació dels nous plecs, al puntuar el 3B i 4B la graella de puntuacions canvia, cal saltar-se la lògica de "new_criteria"
      IF my_mode EQ co_mode_punt_quadre3b OR my_mode EQ co_mode_punt_quadre4b AND get_is_nova_llei_92017( ) = abap_on AND my_exp_cont_db-z_obert_preu = abap_off.
      ELSE.
** << FI MODIF ETODR SPEC-49075
* No tinc la puntuacio d'un criteri que pertany al model. Es perfectament normal la primera
* vegada que es crida al programa però no si ja s'havia puntuat abans.
        IF ls_crit_punt-z_codi_crit_punt NE co_codi_crit_total .
          ex_consistency-new_criteria = 'X' .
        ENDIF .
      ENDIF .
      CLEAR ls_punt_ofer .
      ls_punt_ofer-z_num_gen          = <ls_oferta>-z_num_ofer .
      ls_punt_ofer-z_codi_crit_punt   = ls_crit_punt-z_codi_crit_punt .
      ls_punt_ofer-z_mod_crit_punt    = ls_crit_punt-z_mod_crit_punt .
      INSERT ls_punt_ofer INTO TABLE ex_punt_ofer .
    ENDLOOP .
  ENDLOOP .

  ">>>SPEC-55535, Inici modificació  - ETODR
  IF gt_incr IS NOT INITIAL.
    "Pot ser que el IMIN hagi canviat, en aquest cas, n'actualitzem el seu valor
    "i avisem per a que sàpiquen que s'ha de recalcular les puntuacions
    LOOP AT gt_incr ASSIGNING FIELD-SYMBOL(<fs_crit_incr>).
      IF <fs_crit_incr>-z_imin <> im_header-z_imin.
        ex_consistency-imin_has_changed = abap_on.
        EXIT.
*        <fs_crit_incr>-z_imin = im_header-z_imin.
      ENDIF.
    ENDLOOP.
  ENDIF.
  "<<<SPEC-55535, Final modificació - ETODR

  IF ex_punt_ofer_db IS INITIAL .
    CLEAR ex_consistency-new_criteria .
  ENDIF .
*  MODIFY ex_punt_ofer FROM ls_punt_ofer TRANSPORTING z_mod_crit_punt
*                                              WHERE z_mod_crit_punt EQ space .

ENDMETHOD.


METHOD read_and_check_punt_sol_part.
  DATA:   ls_punt_ofer TYPE ty_s_punt_gen,
          ls_crit_punt TYPE ty_s_crit_punt,
          l_lines      TYPE i,
          l_tab1       TYPE i,
          l_tab2       TYPE i,
          lt_crit_punt LIKE im_crit_punt,
          l_dummy      TYPE c .
  FIELD-SYMBOLS: <ls_oferta> TYPE ty_s_ofertax,
                 <ls_crit_punt> TYPE ty_s_crit_punt .

  SELECT      z_num_ofer AS z_num_gen z_mod_crit_punt z_codi_crit_punt z_punts
         INTO CORRESPONDING FIELDS OF TABLE ex_punt_ofer_sp_db
         FROM zrm_dt_punt_sol
        WHERE     docclass EQ im_header-docclass
              AND objectid EQ im_header-objectid .
  CHECK ex_punt_ofer_sp IS REQUESTED .

  CLEAR ex_consistency .
  ex_punt_ofer_sp = ex_punt_ofer_sp_db .

  IF my_mode = co_mode_punt_sol_part.

    SELECT * INTO CORRESPONDING FIELDS OF TABLE lt_crit_punt
       FROM zrm_dm_crit_punt
       WHERE z_mod_crit_punt EQ im_mod_crit_punt .

    IF sy-subrc NE 0 .
      MESSAGE e027 WITH im_mod_crit_punt INTO l_dummy .
      zcx_rm_valoracio=>raise_from_message( ) .
    ENDIF .




*-- Puntuació d'ofertes --------------------------------------------------------------------
  LOOP AT ex_punt_ofer_sp INTO ls_punt_ofer .
    IF ls_punt_ofer-z_mod_crit_punt NE im_mod_crit_punt .
      ex_consistency-model_has_changed = 'X' .
    ENDIF .
    READ TABLE im_crit_punt TRANSPORTING NO FIELDS
                            WITH TABLE KEY z_mod_crit_punt  = ls_punt_ofer-z_mod_crit_punt
                                           z_codi_crit_punt = ls_punt_ofer-z_codi_crit_punt .
    CHECK sy-subrc NE 0 .
* A l'oferta tenim puntuació d'un criteri que no està a la parametrització. Canvi de plec, potser??
    DELETE ex_punt_ofer_sp .
    ex_consistency-deleted_criteria = 'X' .
  ENDLOOP .

  LOOP AT im_ofertesx ASSIGNING <ls_oferta> .
    LOOP AT im_crit_punt INTO ls_crit_punt .
      READ TABLE ex_punt_ofer_sp TRANSPORTING NO FIELDS
                              WITH TABLE KEY z_codi_crit_punt = ls_crit_punt-z_codi_crit_punt
                                             z_mod_crit_punt  = ls_crit_punt-z_mod_crit_punt
                                             z_num_gen        = <ls_oferta>-z_num_ofer .
      CHECK: sy-subrc NE 0.
* No tinc la puntuacio d'un criteri que pertany al model. Es perfectament normal la primera
* vegada que es crida al programa però no si ja s'havia puntuat abans.
      IF ls_crit_punt-z_codi_crit_punt NE co_codi_crit_total .
        ex_consistency-new_criteria = 'X' .
      ENDIF .
      CLEAR ls_punt_ofer .
      ls_punt_ofer-z_num_gen          = <ls_oferta>-z_num_ofer .
      ls_punt_ofer-z_codi_crit_punt   = ls_crit_punt-z_codi_crit_punt .
      ls_punt_ofer-z_mod_crit_punt    = ls_crit_punt-z_mod_crit_punt .
      INSERT ls_punt_ofer INTO TABLE ex_punt_ofer_sp .
    ENDLOOP .
  ENDLOOP .


  IF ex_punt_ofer_sp_db IS INITIAL .
    CLEAR ex_consistency-new_criteria .
  ENDIF .


  ENDIF.

ENDMETHOD.


METHOD read_data.
  DATA: l_anchor TYPE zrm_dt_gmd_activ-anchor .
  my_opened = 'X' .

  my_exp_cont_db = me->read_and_check_header(   ) .
  my_exp_cont    = my_exp_cont_db .

*-- Quadres generats --------------------------------------------------------
  DEFINE _check_quadre .
    select single anchor into l_anchor
             from zrm_dt_gmd_activ
            where     docclass eq my_docclass
                  and objectid eq my_objectid
                  and anchor   eq &1 .
    if sy-subrc eq 0 .
      my_quadres-&2 = 'X' .
    endif .
  END-OF-DEFINITION .

  _check_quadre: 'QUADRE4'      quadre4,
                 'QUADRE4A'     quadre4a,
                 'QUADRE4B'     quadre4b,
                 'QUADRE4_LEM'  quadre4_lemes,
                 'CP064'        quadre2b,
                 'QUADRE1B'     quadre1b,
                 'QUADRE4A_92017' quadre4a_92017, "ETODR SPEC-49075
                 'QUADRE4B_92017' quadre4b_92017. "ETODR SPEC-49075
  .
*-- Consistència de Plec de Bases -------------------------------------------
  CALL METHOD read_and_check_plec
    EXPORTING
      im_header              = my_exp_cont_db
    IMPORTING
      ex_plec                = my_plec
      ex_crit_punt           = my_crit_punt
      ex_crit_punt_prop_graf = my_crit_punt_prop_graf
      ex_crit_punt_sol_part  = my_crit_punt_sol_part
      ex_formula_ve          = my_formula_ve
      ex_formula_vt          = my_formula_vt
      ex_min_solv_tec        = my_min_solv_tec  "EDLSM
      ex_formula_ve_n        = my_formula_ve_n.
**>> INI MODIF ETODR SPEC-61754 - Per MY_MODE = I (generació del formulari de puntuacions objectives) no tenim ofertes encara
  IF my_mode <> zrm_cl_valoracio_ofertes=>co_mode_punt_formulari.
**<< FI MODIF ETODR SPEC-61754
    CREATE OBJECT my_ob_ofertes
      EXPORTING
        im_objectid = me->my_objectid
        im_docclass = me->my_docclass.

    CALL METHOD read_and_check_offers
      EXPORTING
        im_header     = my_exp_cont_db
        im_ob_ofertes = my_ob_ofertes
      IMPORTING
        ex_ofertesx   = my_ofertesx
  "     ex_bmax       = my_formula_ve-bmax.
        ex_bmax       = my_formula_ve_n-bmax.

    CALL METHOD read_and_check_punt_ofer
      EXPORTING
        im_header        = my_exp_cont_db
        im_mod_crit_punt = my_plec-z_mod_crit_punt
        im_crit_punt     = my_crit_punt
        im_ofertesx      = my_ofertesx
      IMPORTING
        ex_punt_ofer     = my_punt_ofer
        ex_punt_ofer_db  = my_punt_ofer_db
        ex_consistency   = my_consistency_offer.

    CALL METHOD read_and_check_punt_sol_part
      EXPORTING
        im_header          = my_exp_cont_db
        im_mod_crit_punt   = my_plec-z_mod_crit_sol
        im_crit_punt       = my_crit_punt_sol_part
        im_ofertesx        = my_ofertesx
      IMPORTING
        ex_punt_ofer_sp    = my_punt_sol_part
        ex_punt_ofer_sp_db = my_punt_sol_part_db
        ex_consistency     = my_consistency_sol_part.


    IF my_plec-z_mod_crit_prop IS NOT INITIAL .
      SELECT * INTO CORRESPONDING FIELDS OF TABLE my_lemes
             FROM zrm_dt_lemes
           WHERE     docclass EQ my_docclass
                 AND objectid EQ my_objectid .

      CALL METHOD read_and_check_punt_lema
        EXPORTING
          im_header        = my_exp_cont_db
          im_mod_crit_punt = my_plec-z_mod_crit_prop
          im_crit_punt     = my_crit_punt_prop_graf
          im_lema          = my_lemes
        IMPORTING
          ex_punt_lema     = my_punt_lema
          ex_punt_lema_db  = my_punt_lema_db
          ex_consistency   = my_consistency_lema.
    ENDIF .

** >> INI MODIF ETODR SPEC-45341
    set_dyn_data( EXPORTING   im_docclass   = my_docclass
                              im_objectid   = my_objectid
                  EXCEPTIONS  not_punt_ofer = 0 ).
** << FI MODIF ETODR SPEC-45341
  ENDIF.
ENDMETHOD.


METHOD recalculate.
  DATA: l_changed TYPE xfeld .

  IF my_locked IS INITIAL .
    RAISE EXCEPTION TYPE zcx_rm_valoracio
      EXPORTING
        textid = zcx_rm_valoracio=>not_opened_for_update.
  ENDIF .


***INI MOD ETJHG - SPEC-46407
  "Actualizar puntuación si se han agregado o quitado recursos
  IF dades_ofer_dyn[] IS NOT INITIAL.
    recalculate_mult_rec(
      EXPORTING
        dades_ofer_dyn = dades_ofer_dyn
      IMPORTING
        ex_changed = l_changed ) .
  ENDIF.
***FIN MOD ETJHG - SPEC-46407
* Des de fora de la clase només es pot recalcular la puntuació si
* l'estat actual de la valoració permet canviar puntuacions individuals
  IF    check_activity( co_act_punct_1st ) IS NOT INITIAL.
    recalculate_offer( IMPORTING ex_changed = l_changed ) .
    IF l_changed IS NOT INITIAL .
      ex_changed = 'X' .
    ENDIF .
  ENDIF .

  IF check_activity( co_act_punct_2nd ) IS NOT INITIAL .
    recalculate_lemes( IMPORTING ex_changed = l_changed ) .
    IF l_changed IS NOT INITIAL .
      ex_changed = 'X' .
    ENDIF .
  ENDIF .

  IF check_activity( co_act_punct_sp ) IS NOT INITIAL.
    recalculate_sol_part( IMPORTING ex_changed = l_changed ) .
    IF l_changed IS NOT INITIAL .
      ex_changed = 'X' .
    ENDIF .
  ENDIF.

ENDMETHOD.


METHOD recalculate_boi_bmax.
  DATA: l_import                 TYPE zrm_dt_ofertes-z_import_homog,
        l_non_excluded           TYPE xfeld,
        l_num                    TYPE zrm_dt_ofertes-z_import_oferta,
        l_den                    TYPE zrm_dt_ofertes-z_import_oferta,
        l_dummy                  TYPE c,                    "#EC NEEDED
        lv_tipologia_variable    TYPE xfeld,                      "SPEC-51404
        lv_import_iva_variable   TYPE zrm_dt_ofer_tip-import_iva, "SPEC-51404
        lv_pressup_variable      TYPE zrm_dt_tip_eco-pressupost,  "SPEC-51404
        lv_import_siva_variable  TYPE zrm_dt_ofer_tip-import, "SPEC-53460
        lv_pressup_siva_variable TYPE zrm_dt_tip_eco-pressupost,  "SPEC-53460
        lv_calc_sense_iva        TYPE xfeld. "SPEC-53460
  FIELD-SYMBOLS: <ls_ofertax>  TYPE ty_s_ofertax .


  DATA: ls_zrm_dt_exp_con TYPE zrm_dt_exp_cont.   "SPEC-83935 - EVMRG

  CLEAR ch_bmax .

** >> INI MODIF ETODR SPEC-51404
  CLEAR: lv_tipologia_variable.
  SELECT *
    INTO TABLE @DATA(lt_tip_eco)
    FROM zrm_dt_tip_eco
   WHERE docclass = @im_exp_cont-docclass
     AND objectid = @im_exp_cont-objectid
     AND ( tipus_ofer <> 3 AND tipus_ofer <> 4 ).

  IF lt_tip_eco IS NOT INITIAL.
    lv_tipologia_variable = abap_on.

    SELECT *
      INTO TABLE @DATA(lt_ofer_tip)
      FROM zrm_dt_ofer_tip
     WHERE  docclass =  @im_exp_cont-docclass
       AND  objectid =  @im_exp_cont-objectid
       AND ( tipus_ofer <> 3 AND tipus_ofer <> 4 ).
  ENDIF.
** << FI MODIF ETODR SPEC-51404

**  >> INI MODIF ETODR SPEC-53460
  lv_calc_sense_iva = abap_off.
  SELECT SINGLE value
    FROM zsap_dt_param_hc
    INTO @DATA(lv_value_sense_iva)
    WHERE repid      = 'CALCULATE_NOUS_PLECS_BLIM'
      AND field_info = 'CALC_SENSE_IVA'.
  IF sy-subrc = 0 .
    lv_calc_sense_iva = lv_value_sense_iva.
  ENDIF.
**  << FI MODIF ETODR SPEC-53460

  LOOP AT ch_ofertesx ASSIGNING <ls_ofertax>." WHERE exclos = abap_false. OVB SPEC-37724
**  >> INI MODIF ETODR SPEC-49921
    IF get_is_nova_llei_92017( ) = abap_on AND get_is_obert_preu( ) = abap_off.
      IF   <ls_ofertax>-z_exclos_s1         IS NOT INITIAL
        OR <ls_ofertax>-z_exclos_s2         IS NOT INITIAL
        OR <ls_ofertax>-z_exclos_s3         IS NOT INITIAL
        OR <ls_ofertax>-z_exclos_punt_capob IS NOT INITIAL"PSPEC-1451 - EVMRG
        OR <ls_ofertax>-z_excl_homog        IS NOT INITIAL
        OR <ls_ofertax>-z_exclos_var_tec    IS NOT INITIAL
*        OR <ls_ofertax>-z_exclos_plec       IS NOT INITIAL "SPEC-50770
*        OR <ls_ofertax>-z_temerari          IS NOT INITIAL "SPEC-52334
        OR <ls_ofertax>-z_excl_punt_tec     IS NOT INITIAL.
        <ls_ofertax>-exclos = 'X' .
      ELSE .
        l_non_excluded = 'X' .
        <ls_ofertax>-exclos = space .
      ENDIF .
    ELSE.
**  << FI MODIF ETODR SPEC-49921
      IF my_exp_cont-z_rd817_2009 IS NOT INITIAL.
        IF    <ls_ofertax>-z_exclos_s1         IS NOT INITIAL
           OR <ls_ofertax>-z_exclos_s2         IS NOT INITIAL
           OR <ls_ofertax>-z_exclos_s3         IS NOT INITIAL
           OR <ls_ofertax>-z_exclos_punt_capob  IS NOT INITIAL"PSPEC-1451 - EVMRG
           OR <ls_ofertax>-z_excl_homog        IS NOT INITIAL
           OR <ls_ofertax>-z_exclos_var_tec    IS NOT INITIAL
           OR <ls_ofertax>-z_excl_punt_tec     IS NOT INITIAL
           OR <ls_ofertax>-z_temerari          IS NOT INITIAL
           OR ( <ls_ofertax>-z_pres_proposta   IS INITIAL AND my_exp_cont-z_proc_adj = co_adj_cr ) .
          <ls_ofertax>-exclos = 'X' .
        ELSE .
          l_non_excluded = 'X' .
          <ls_ofertax>-exclos = space .
        ENDIF .
      ELSE.

        IF    <ls_ofertax>-z_exclos_s1         IS NOT INITIAL
           OR <ls_ofertax>-z_exclos_s2         IS NOT INITIAL
           OR <ls_ofertax>-z_exclos_s3         IS NOT INITIAL
          OR <ls_ofertax>-z_exclos_punt_capob  IS NOT INITIAL"PSPEC-1451 - EVMRG
           OR <ls_ofertax>-z_excl_homog        IS NOT INITIAL
           OR <ls_ofertax>-z_exclos_var_tec    IS NOT INITIAL
           OR ( <ls_ofertax>-z_excl_punt_tec   IS NOT INITIAL     " SPEC-15023 No es tenen en compte el exclosos per el càlcul
                  AND my_exp_cont-z_publ_anun_dogc > co_date_excl_punt_tec ) " a partir de la data 08/07/2009
           OR <ls_ofertax>-z_temerari          IS NOT INITIAL
           OR ( <ls_ofertax>-z_pres_proposta   IS INITIAL AND my_exp_cont-z_proc_adj = co_adj_cr )
           OR ( my_exp_cont-z_proc_adj = 'NF' AND  my_exp_cont-z_negociacio = 'X' AND my_exp_cont-z_estat = 'ZN2' AND <ls_ofertax>-z_sel_2volta <> 'X' ). "P100031 NF
          <ls_ofertax>-exclos = 'X' .
        ELSE .
          l_non_excluded = 'X' .
          <ls_ofertax>-exclos = space .
        ENDIF .

      ENDIF.
    ENDIF.

    IF <ls_ofertax>-exclos IS INITIAL
**>> INI OVB SPEC-37724
      AND <ls_ofertax>-exclos_pt IS INITIAL
      AND <ls_ofertax>-z_excl_punt_tec IS INITIAL. "SPEC-49498
**>> FIN OVB
      IF     im_exp_cont-z_req_homog IS INITIAL .
        l_import = <ls_ofertax>-z_import_oferta .
**        >> INI MODIF ETODR SPEC-SPEC-53460
        IF lv_calc_sense_iva = abap_on.
          l_import = <ls_ofertax>-z_imp_oferta_b.
        ENDIF.
**        << FI MODIF ETODR SPEC-SPEC-53460
        IF l_import IS INITIAL.
          IF im_exp_cont-z_proc_adj = 'NF' AND im_exp_cont-z_negociacio = 'X'.

          ELSE.
            "INICI - SPEC-83935 - EVMRG

            CLEAR ls_zrm_dt_exp_con.

            SELECT SINGLE *
              INTO ls_zrm_dt_exp_con
              FROM zrm_dt_exp_cont
              WHERE objectid = <ls_ofertax>-objectid.

            IF ls_zrm_dt_exp_con-z_proc_adj = 'NB' AND ( ls_zrm_dt_exp_con-z_tipus_cont = 'OB' OR ls_zrm_dt_exp_con-z_tipus_cont = 'SE')
              AND ( ls_zrm_dt_exp_con-z_tip_bam = '14.2' OR ls_zrm_dt_exp_con-z_tip_bam = '14.2A' ).

            ELSE.
              "FI - SPEC-83935 - EVMRG
              MESSAGE e004 INTO l_dummy.
              zcx_rm_valoracio=>raise_from_message( ) .
            ENDIF. "SPEC-83935 - EVMRG

          ENDIF.
        ENDIF .
      ELSE .
        l_import = <ls_ofertax>-z_import_homog .
**        >> INI MODIF ETODR SPEC-53460
        IF lv_calc_sense_iva = abap_on.
          l_import = <ls_ofertax>-z_imp_homog_b.
        ENDIF.
**        << FI MODIF ETODR SPEC-53460
        IF l_import IS INITIAL .
          IF im_exp_cont-z_proc_adj = 'NF' AND im_exp_cont-z_negociacio = 'X'.

          ELSE.
            MESSAGE e017 INTO l_dummy .
            zcx_rm_valoracio=>raise_from_message( ) .
          ENDIF.
        ENDIF .
      ENDIF .

*     [EDECG - 27.07.2011 - Modificació comportament valoració d'ofertes per igualar GISA
*      i REGSA - SPEC 23416 INICI]
      IF im_exp_cont-z_publ_anun_dogc >= '20110428'.
        IF im_exp_cont-z_met_alemany IS NOT INITIAL .
          l_num = l_import + <ls_ofertax>-z_imp_com_fin .
          l_den = im_exp_cont-z_pressup_licit + im_exp_cont-z_import_comp_fi .
**        >> INI MODIF ETODR SPEC-53460
          IF lv_calc_sense_iva = abap_on .
            l_num = l_import + <ls_ofertax>-z_imp_com_fin_b.
            l_den = im_exp_cont-z_pres_licit_b + im_exp_cont-z_imp_comp_fi_b .
          ENDIF.
**        << FI MODIF ETODR SPEC-53460
        ELSE .
          l_num = l_import .
          l_den = im_exp_cont-z_pressup_licit .
**        >> INI MODIF ETODR SPEC-53460
          IF lv_calc_sense_iva = abap_on .
            l_num = l_import.
            l_den = im_exp_cont-z_pres_licit_b.
          ENDIF.
**        << FI MODIF ETODR SPEC-53460
        ENDIF .
      ELSE.
        IF im_exp_cont-societat EQ 'REGS' .
          IF im_exp_cont-z_met_alemany IS NOT INITIAL .
            l_den = im_exp_cont-z_pressup_licit + im_exp_cont-z_import_comp_fi .
            IF im_exp_cont-z_tipus_credit IS NOT INITIAL .
              l_num = l_import + <ls_ofertax>-z_imp_com_fin + <ls_ofertax>-z_estalvi_fin .
            ELSE .
              l_num = l_import + <ls_ofertax>-z_imp_com_fin .
            ENDIF .
          ELSE .
            l_den = im_exp_cont-z_pressup_licit .
            IF im_exp_cont-z_tipus_credit IS NOT INITIAL .
              l_num = l_import + <ls_ofertax>-z_estalvi_fin .
            ELSE .
              l_num = l_import .
            ENDIF .
          ENDIF .
        ELSE .
          IF im_exp_cont-z_met_alemany IS NOT INITIAL .
            l_num = l_import + <ls_ofertax>-z_imp_com_fin .
            l_den = im_exp_cont-z_pressup_licit + im_exp_cont-z_import_comp_fi .
          ELSE .
            l_num = l_import .
            l_den = im_exp_cont-z_pressup_licit .
          ENDIF .
        ENDIF .
      ENDIF.
*     [EDECG - 27.07.2011 - Modificació comportament valoració d'ofertes per igualar GISA
*      i REGSA - SPEC 23416 FI]

**    >> INI MODIF ETODR SPEC-51404
      IF get_is_nova_llei_92017( ) = abap_on AND lv_tipologia_variable = abap_on.
        CLEAR: lv_pressup_variable, lv_import_iva_variable.
        CLEAR: lv_import_siva_variable, lv_pressup_siva_variable."SPEC-53460
        LOOP AT lt_ofer_tip ASSIGNING FIELD-SYMBOL(<fs_import_variable_oferta>) WHERE num_ofer = <ls_ofertax>-z_num_ofer.
          ADD <fs_import_variable_oferta>-import_iva TO lv_import_iva_variable.
          ADD <fs_import_variable_oferta>-import TO lv_import_siva_variable. "SPEC-53460
        ENDLOOP.
        LOOP AT lt_tip_eco ASSIGNING FIELD-SYMBOL(<fs_tipologia_econ>).
          ADD <fs_tipologia_econ>-pressupost_iva TO lv_pressup_variable.
          ADD <fs_tipologia_econ>-pressupost TO lv_pressup_siva_variable. "SPEC-53460
        ENDLOOP.
**        >> INI MODIF ETODR SPEC-53460
        IF lv_calc_sense_iva = abap_on.
          IF lv_import_siva_variable IS NOT INITIAL AND lv_pressup_siva_variable IS NOT INITIAL.
            l_num = lv_import_siva_variable .
            l_den = lv_pressup_siva_variable .
          ENDIF.
        ELSE.
**        << FI MODIF ETODR SPEC-53460
          IF lv_pressup_variable IS NOT INITIAL AND lv_import_iva_variable IS NOT INITIAL.
            l_num = lv_import_iva_variable .
            l_den = lv_pressup_variable .
          ENDIF.
        ENDIF.
      ENDIF.
**    << FI MODIF ETODR SPEC-51404

      <ls_ofertax>-boi = 100 * ( 1 - l_num / l_den ) .

      IF     <ls_ofertax>-boi  GT ch_bmax .
        ch_bmax = <ls_ofertax>-boi .
      ENDIF .
    ENDIF .

  ENDLOOP .

  IF ch_ofertesx[] IS INITIAL .
    RAISE EXCEPTION TYPE zcx_rm_valoracio
      EXPORTING
        textid = zcx_rm_valoracio=>no_offers.
  ENDIF .

  IF l_non_excluded IS INITIAL .
    RAISE EXCEPTION TYPE zcx_rm_valoracio
      EXPORTING
        textid = zcx_rm_valoracio=>all_offers_discarded.
  ENDIF .

ENDMETHOD.


METHOD recalculate_boi_bmin.
  DATA: l_import                 TYPE zrm_dt_ofertes-z_import_homog,
        l_non_excluded           TYPE xfeld,
        l_num                    TYPE zrm_dt_ofertes-z_import_oferta,
        l_den                    TYPE zrm_dt_ofertes-z_import_oferta,
        l_dummy                  TYPE c,                    "#EC NEEDED
        lv_tipologia_variable    TYPE xfeld,                      "SPEC-51404
        lv_import_iva_variable   TYPE zrm_dt_ofer_tip-import_iva, "SPEC-51404
        lv_pressup_variable      TYPE zrm_dt_tip_eco-pressupost,  "SPEC-51404
        lv_import_siva_variable  TYPE zrm_dt_ofer_tip-import, "SPEC-53460
        lv_pressup_siva_variable TYPE zrm_dt_tip_eco-pressupost,  "SPEC-53460
        lv_calc_sense_iva        TYPE xfeld. "SPEC-53460
  FIELD-SYMBOLS: <ls_ofertax>  TYPE ty_s_ofertax .

** >> INI MODIF ETODR SPEC-51404
  CLEAR: lv_tipologia_variable.
  SELECT *
    INTO TABLE @DATA(lt_tip_eco)
    FROM zrm_dt_tip_eco
   WHERE docclass = @im_exp_cont-docclass
     AND objectid = @im_exp_cont-objectid
     AND ( tipus_ofer <> 3 AND tipus_ofer <> 4 ).

  IF lt_tip_eco IS NOT INITIAL.
    lv_tipologia_variable = abap_on.

    SELECT *
      INTO TABLE @DATA(lt_ofer_tip)
      FROM zrm_dt_ofer_tip
     WHERE  docclass =  @im_exp_cont-docclass
       AND  objectid =  @im_exp_cont-objectid
       AND ( tipus_ofer <> 3 AND tipus_ofer <> 4 ).
  ENDIF.
** << FI MODIF ETODR SPEC-51404


**  >> INI MODIF ETODR SPEC-53460
  lv_calc_sense_iva = abap_off.
  SELECT SINGLE value
    FROM zsap_dt_param_hc
    INTO @DATA(lv_value_sense_iva)
    WHERE repid      = 'CALCULATE_NOUS_PLECS_BLIM'
      AND field_info = 'CALC_SENSE_IVA'.
  IF sy-subrc = 0 .
    lv_calc_sense_iva = lv_value_sense_iva.
  ENDIF.
**  << FI MODIF ETODR SPEC-53460

*  CLEAR ch_bmin .
  ch_bmin = '100'. "La variable ch_bmin comença amb el valor mes alt (100).

  LOOP AT ch_ofertesx ASSIGNING <ls_ofertax>." WHERE exclos = abap_false. OVB SPEC-37724
**  >> INI MODIF ETODR SPEC-49921
    IF get_is_nova_llei_92017( ) = abap_on AND get_is_obert_preu( ) = abap_off.
      IF   <ls_ofertax>-z_exclos_s1         IS NOT INITIAL
        OR <ls_ofertax>-z_exclos_s2         IS NOT INITIAL
        OR <ls_ofertax>-z_exclos_s3         IS NOT INITIAL
        OR <ls_ofertax>-z_exclos_punt_capob IS NOT INITIAL "PSPEC-1451 - EVMRG
        OR <ls_ofertax>-z_excl_homog        IS NOT INITIAL
*        OR <ls_ofertax>-z_exclos_plec       IS NOT INITIAL "SPEC-50770
*        OR <ls_ofertax>-z_temerari          IS NOT INITIAL "SPEC-52334
        OR <ls_ofertax>-z_exclos_var_tec    IS NOT INITIAL
        OR <ls_ofertax>-z_excl_punt_tec     IS NOT INITIAL.
        <ls_ofertax>-exclos = 'X' .
      ELSE .
        l_non_excluded = 'X' .
        <ls_ofertax>-exclos = space .
      ENDIF .
    ELSE.
**  << FI MODIF ETODR SPEC-49921
      IF my_exp_cont-z_rd817_2009 IS NOT INITIAL.
        IF    <ls_ofertax>-z_exclos_s1         IS NOT INITIAL
           OR <ls_ofertax>-z_exclos_s2         IS NOT INITIAL
           OR <ls_ofertax>-z_exclos_s3         IS NOT INITIAL
           OR <ls_ofertax>-z_exclos_punt_capob IS NOT INITIAL "PSPEC-1451 - EVMRG
           OR <ls_ofertax>-z_excl_homog        IS NOT INITIAL
           OR <ls_ofertax>-z_exclos_var_tec    IS NOT INITIAL
           OR <ls_ofertax>-z_excl_punt_tec     IS NOT INITIAL
           OR <ls_ofertax>-z_temerari          IS NOT INITIAL
           OR ( <ls_ofertax>-z_pres_proposta   IS INITIAL AND my_exp_cont-z_proc_adj = co_adj_cr ) .
          <ls_ofertax>-exclos = 'X' .
        ELSE .
          l_non_excluded = 'X' .
          <ls_ofertax>-exclos = space .
        ENDIF .
      ELSE.

        IF    <ls_ofertax>-z_exclos_s1         IS NOT INITIAL
           OR <ls_ofertax>-z_exclos_s2         IS NOT INITIAL
           OR <ls_ofertax>-z_exclos_s3         IS NOT INITIAL
           OR <ls_ofertax>-z_exclos_punt_capob IS NOT INITIAL "PSPEC-1451 - EVMRG
           OR <ls_ofertax>-z_excl_homog        IS NOT INITIAL
           OR <ls_ofertax>-z_exclos_var_tec    IS NOT INITIAL
           OR ( <ls_ofertax>-z_excl_punt_tec   IS NOT INITIAL     " SPEC-15023 No es tenen en compte el exclosos per el càlcul
                  AND my_exp_cont-z_publ_anun_dogc > co_date_excl_punt_tec ) " a partir de la data 08/07/2009
           OR <ls_ofertax>-z_temerari          IS NOT INITIAL
           OR ( <ls_ofertax>-z_pres_proposta   IS INITIAL AND my_exp_cont-z_proc_adj = co_adj_cr )
           OR ( my_exp_cont-z_proc_adj = 'NF' AND  my_exp_cont-z_negociacio = 'X' AND my_exp_cont-z_estat = 'ZN2' AND <ls_ofertax>-z_sel_2volta <> 'X' ). "P100031 NF
          <ls_ofertax>-exclos = 'X' .
        ELSE .
          l_non_excluded = 'X' .
          <ls_ofertax>-exclos = space .
        ENDIF .

      ENDIF.
    ENDIF.

    IF <ls_ofertax>-exclos IS INITIAL
**>> INI OVB SPEC-37724
      AND <ls_ofertax>-exclos_pt IS INITIAL.
**>> FIN OVB
      IF     im_exp_cont-z_req_homog IS INITIAL .
        l_import = <ls_ofertax>-z_import_oferta .
**        >> INI MODIF ETODR SPEC-SPEC-53460
        IF lv_calc_sense_iva = abap_on.
          l_import = <ls_ofertax>-z_imp_oferta_b.
        ENDIF.
**        << FI MODIF ETODR SPEC-SPEC-53460
        IF l_import IS INITIAL .
          IF im_exp_cont-z_proc_adj = 'NF' AND im_exp_cont-z_negociacio = 'X'.
          ELSE.
            MESSAGE e004 INTO l_dummy.
            zcx_rm_valoracio=>raise_from_message( ) .
          ENDIF.
        ENDIF .
      ELSE .
        l_import = <ls_ofertax>-z_import_homog .
**        >> INI MODIF ETODR SPEC-53460
        IF lv_calc_sense_iva = abap_on.
          l_import = <ls_ofertax>-z_imp_homog_b.
        ENDIF.
**        << FI MODIF ETODR SPEC-53460
        IF l_import IS INITIAL .
          IF im_exp_cont-z_proc_adj = 'NF' AND im_exp_cont-z_negociacio = 'X'.
          ELSE.
            MESSAGE e017 INTO l_dummy .
            zcx_rm_valoracio=>raise_from_message( ) .
          ENDIF.
        ENDIF .
      ENDIF .

* Comportament valoració d'ofertes per igualar GISA i REGSA
      IF im_exp_cont-z_publ_anun_dogc >= '20110428'.
        IF im_exp_cont-z_met_alemany IS NOT INITIAL .
          l_num = l_import + <ls_ofertax>-z_imp_com_fin .
          l_den = im_exp_cont-z_pressup_licit + im_exp_cont-z_import_comp_fi .
**        >> INI MODIF ETODR SPEC-53460
          IF lv_calc_sense_iva = abap_on .
            l_num = l_import + <ls_ofertax>-z_imp_com_fin_b.
            l_den = im_exp_cont-z_pres_licit_b + im_exp_cont-z_imp_comp_fi_b .
          ENDIF.
**        << FI MODIF ETODR SPEC-53460
        ELSE .
          l_num = l_import .
          l_den = im_exp_cont-z_pressup_licit .
**        >> INI MODIF ETODR SPEC-53460
          IF lv_calc_sense_iva = abap_on .
            l_num = l_import.
            l_den = im_exp_cont-z_pres_licit_b.
          ENDIF.
**        << FI MODIF ETODR SPEC-53460
        ENDIF .
      ELSE.
        IF im_exp_cont-societat EQ 'REGS' .
          IF im_exp_cont-z_met_alemany IS NOT INITIAL .
            l_den = im_exp_cont-z_pressup_licit + im_exp_cont-z_import_comp_fi .
            IF im_exp_cont-z_tipus_credit IS NOT INITIAL .
              l_num = l_import + <ls_ofertax>-z_imp_com_fin + <ls_ofertax>-z_estalvi_fin .
            ELSE .
              l_num = l_import + <ls_ofertax>-z_imp_com_fin .
            ENDIF .
          ELSE .
            l_den = im_exp_cont-z_pressup_licit .
            IF im_exp_cont-z_tipus_credit IS NOT INITIAL .
              l_num = l_import + <ls_ofertax>-z_estalvi_fin .
            ELSE .
              l_num = l_import .
            ENDIF .
          ENDIF .
        ELSE .
          IF im_exp_cont-z_met_alemany IS NOT INITIAL .
            l_num = l_import + <ls_ofertax>-z_imp_com_fin .
            l_den = im_exp_cont-z_pressup_licit + im_exp_cont-z_import_comp_fi .
          ELSE .
            l_num = l_import .
            l_den = im_exp_cont-z_pressup_licit .
          ENDIF .
        ENDIF .
      ENDIF.

**    >> INI MODIF ETODR SPEC-51404
      IF get_is_nova_llei_92017( ) = abap_on AND lv_tipologia_variable = abap_on.
        CLEAR: lv_pressup_variable, lv_import_iva_variable.
        CLEAR: lv_import_siva_variable, lv_pressup_siva_variable."SPEC-53460
        LOOP AT lt_ofer_tip ASSIGNING FIELD-SYMBOL(<fs_import_variable_oferta>) WHERE num_ofer = <ls_ofertax>-z_num_ofer.
          ADD <fs_import_variable_oferta>-import_iva TO lv_import_iva_variable.
          ADD <fs_import_variable_oferta>-import TO lv_import_siva_variable. "SPEC-53460
        ENDLOOP.
        LOOP AT lt_tip_eco ASSIGNING FIELD-SYMBOL(<fs_tipologia_econ>).
          ADD <fs_tipologia_econ>-pressupost_iva TO lv_pressup_variable.
          ADD <fs_tipologia_econ>-pressupost TO lv_pressup_siva_variable. "SPEC-53460
        ENDLOOP.
**        >> INI MODIF ETODR SPEC-53460
        IF lv_calc_sense_iva = abap_on.
          IF lv_import_siva_variable IS NOT INITIAL AND lv_pressup_siva_variable IS NOT INITIAL.
            l_num = lv_import_siva_variable .
            l_den = lv_pressup_siva_variable .
          ENDIF.
        ELSE.
**        << FI MODIF ETODR SPEC-53460
          IF lv_pressup_variable IS NOT INITIAL AND lv_import_iva_variable IS NOT INITIAL.
            l_num = lv_import_iva_variable .
            l_den = lv_pressup_variable .
          ENDIF.
        ENDIF.
      ENDIF.
**    << FI MODIF ETODR SPEC-51404

      <ls_ofertax>-boi = 100 * ( 1 - l_num / l_den ) .

      IF <ls_ofertax>-boi LT ch_bmin . "Valor més petit
        ch_bmin = <ls_ofertax>-boi .
      ENDIF .

    ENDIF .

  ENDLOOP .

  IF ch_ofertesx[] IS INITIAL .
    RAISE EXCEPTION TYPE zcx_rm_valoracio
      EXPORTING
        textid = zcx_rm_valoracio=>no_offers.
  ENDIF .

  IF l_non_excluded IS INITIAL .
    RAISE EXCEPTION TYPE zcx_rm_valoracio
      EXPORTING
        textid = zcx_rm_valoracio=>all_offers_discarded.
  ENDIF .

ENDMETHOD.


  METHOD recalculate_crit_coautors.
    DATA: lv_suma_crit_max      TYPE z_punts,
          lv_punts_recalculats  TYPE z_punts,
          lv_suma_crit_puntuats TYPE decfloat34,
          lv_actual_parent      TYPE z_codi_crit_punt,
** >> INI MODIF ECAGE SPEC-73458
          lv_cont_carrec        TYPE i,
          lv_total_carrec       TYPE zst_equip_coautor-z_total_carrec.
** << FI MODIF ECAGE SPEC-73458.

    get_calcul_coautors( IMPORTING et_dades_coautors = DATA(lt_dades_coautors) ).

    DATA(lt_crit_punt) = im_crit_punt.
    READ TABLE gt_equip TRANSPORTING NO FIELDS INDEX 1.
    IF sy-subrc = 0.
      DATA(lt_num_equips) = gt_equip[].
      SORT lt_num_equips BY z_num_ofer z_comptador_equip.
      DELETE ADJACENT DUPLICATES FROM lt_num_equips COMPARING z_num_ofer z_comptador_equip.
      DESCRIBE TABLE lt_num_equips LINES DATA(lv_num_equips).

      get_punts_gen_equi( IMPORTING et_punts_gen_equi = DATA(lt_punt_gen) ).

      DATA(lt_num_ofertes) = ch_punt_gen[].
      DELETE ADJACENT DUPLICATES FROM lt_num_ofertes COMPARING z_num_gen.
      DESCRIBE TABLE lt_num_ofertes LINES DATA(l_num_ofertes).

      "Primer actualitzem les puntuacions
      LOOP AT lt_num_ofertes ASSIGNING FIELD-SYMBOL(<fs_oferta>).
        DATA(lv_index_oferta_aux) = CONV z_num_ofer( <fs_oferta>-z_num_gen ).
        LOOP AT lt_punt_gen ASSIGNING FIELD-SYMBOL(<fs_punt_gen>) WHERE z_num_gen      = lv_index_oferta_aux.
"INICI - SPEC-90501 - EVMRG - S'ha comentat el codi de la SPEC-73458
          ">> SPEC-73458, Inici Modificació - ETODR
*          IF <fs_punt_gen>-z_num_equip IS NOT INITIAL.
            "<< SPEC-73458, Final Modificació - ETODR
"FI - SPEC-90501 - EVMRG
            LOOP AT ch_punt_gen ASSIGNING FIELD-SYMBOL(<fs_punts_aux>) WHERE z_num_gen        = <fs_punt_gen>-z_num_gen
                                                                         AND z_carrec_equip   = <fs_punt_gen>-z_carrec_equip
                                                                         AND z_codi_crit_punt = <fs_punt_gen>-z_codi_crit_punt
                                                                         AND z_num_equip      = <fs_punt_gen>-z_num_equip.
              <fs_punts_aux>-z_punts          = <fs_punt_gen>-z_punts.
              <fs_punts_aux>-z_punts_no_pond  = <fs_punt_gen>-z_punts.
              ex_changed                      = abap_on.
            ENDLOOP.
"INICI - SPEC-90501 - EVMRG - S'ha comentat el codi de la SPEC-73458
*          ENDIF.
"FI - SPEC-90501 - EVMRG
        ENDLOOP.
      ENDLOOP.

      "Recuperem el criteri que té indicat Co-AUTOR, per tal d'acomular allà el seu total
      LOOP AT lt_crit_punt ASSIGNING FIELD-SYMBOL(<fs_crit_punt>) WHERE z_equip_coautor EQ abap_on
                                                                    AND z_sumatori      IS NOT INITIAL.
        DATA(lv_sum_info)      = <fs_crit_punt>-sum_info.
        DATA(l_crit_punt_pare) = <fs_crit_punt>-z_codi_crit_punt.
      ENDLOOP.

      LOOP AT lt_num_ofertes ASSIGNING FIELD-SYMBOL(<fs_loop_oferta>).
        DATA(lv_index_oferta) = CONV z_num_ofer( <fs_loop_oferta>-z_num_gen ).
        CLEAR: lv_suma_crit_puntuats.
"INICI - SPEC-90501 - EVMRG - S'ha comentat el codi de la SPEC-73458
** >> INI MODIF ECAGE SPEC-73458
        DATA(lt_dades_coautors_ofer) = lt_dades_coautors.
        DELETE lt_dades_coautors_ofer WHERE z_num_ofer <> lv_index_oferta.
** << FI MODIF ECAGE SPEC-73458
"FI - SPEC-90501 - EVMRG
        LOOP AT lt_dades_coautors ASSIGNING FIELD-SYMBOL(<fs_dades_equi_punts>) WHERE z_num_ofer = lv_index_oferta.
"INICI - SPEC-90501 - EVMRG - S'ha DEScomentat el codi de la SPEC-73458
*** >> INI MODIF ECAGE SPEC-73458
          CLEAR: lv_cont_carrec, lv_total_carrec.
          LOOP AT lt_dades_coautors_ofer ASSIGNING FIELD-SYMBOL(<fs_dades_coautors_ofer>) WHERE z_carrec_equip = <fs_dades_equi_punts>-z_carrec_equip.
            lv_cont_carrec = lv_cont_carrec + 1.
          ENDLOOP.
          IF lv_cont_carrec IS NOT INITIAL.
            lv_total_carrec = <fs_dades_equi_punts>-z_total_carrec / lv_cont_carrec.
          ELSE.
            lv_total_carrec = <fs_dades_equi_punts>-z_total_carrec.
          ENDIF.
          lv_suma_crit_puntuats = lv_suma_crit_puntuats + lv_total_carrec.
*          lv_suma_crit_puntuats = lv_suma_crit_puntuats + <fs_dades_equi_punts>-z_total_carrec.
*** << FI MODIF ECAGE SPEC-73458
"FI - SPEC-90501 - EVMRG
*          lv_suma_crit_puntuats = lv_suma_crit_puntuats + <fs_dades_equi_punts>-z_total_carrec.

        ENDLOOP.
        LOOP AT ch_punt_gen ASSIGNING FIELD-SYMBOL(<fs_punts2>) WHERE z_num_gen        = lv_index_oferta
                                                                  AND z_codi_crit_punt = l_crit_punt_pare.
          <fs_punts2>-z_punts = lv_suma_crit_puntuats.
        ENDLOOP.

        "Criteri pare del Z_EQUIP_COAUTOR
        READ TABLE gt_crit_dyn_rel ASSIGNING FIELD-SYMBOL(<fs_crit_rel_pare>) WITH KEY z_child = l_crit_punt_pare.
        IF sy-subrc = 0.
          READ TABLE im_crit_punt ASSIGNING FIELD-SYMBOL(<fs_crit_total>) WITH KEY z_codi_crit_punt = <fs_crit_rel_pare>-z_parent.
          IF sy-subrc = 0.
            LOOP AT lt_num_ofertes ASSIGNING FIELD-SYMBOL(<fs_punts>).
              CLEAR: lv_suma_crit_max.
              CALL METHOD summatory_curr_dyn
                EXPORTING
                  im_sum_info  = <fs_crit_total>-sum_info
                  im_crit_punt = im_crit_punt
                  im_num_gen   = CONV #( <fs_punts>-z_num_gen )
                  im_punt_gen  = ch_punt_gen
                CHANGING
                  ch_sum       = lv_suma_crit_max.
              READ TABLE ch_punt_gen ASSIGNING FIELD-SYMBOL(<fs_punt_ofer_coaut_tot>) WITH KEY z_num_gen        = <fs_punts>-z_num_gen
                                                                                               z_codi_crit_punt = <fs_crit_total>-z_codi_crit_punt.
              IF sy-subrc = 0.
                <fs_punt_ofer_coaut_tot>-z_punts = lv_suma_crit_max.
                ex_changed = abap_on.
              ENDIF.
            ENDLOOP.
          ENDIF.
          "Hem d'acumular el criteri actual on hem acumulat al seus possibles pares
          lv_actual_parent = <fs_crit_rel_pare>-z_parent.
          WHILE lv_actual_parent IS NOT INITIAL.
            LOOP AT gt_crit_dyn_rel ASSIGNING <fs_crit_rel_pare> WHERE z_child = lv_actual_parent.
              lv_actual_parent = <fs_crit_rel_pare>-z_parent.
              READ TABLE im_crit_punt ASSIGNING <fs_crit_total> WITH KEY z_codi_crit_punt = <fs_crit_rel_pare>-z_parent.
              IF sy-subrc = 0.
                LOOP AT lt_num_ofertes ASSIGNING <fs_punts>.
                  CLEAR: lv_suma_crit_max.
                  CALL METHOD summatory_curr_dyn
                    EXPORTING
                      im_sum_info  = <fs_crit_total>-sum_info
                      im_crit_punt = im_crit_punt
                      im_num_gen   = CONV #( <fs_punts>-z_num_gen )
                      im_punt_gen  = ch_punt_gen
                    CHANGING
                      ch_sum       = lv_suma_crit_max.
                  READ TABLE ch_punt_gen ASSIGNING FIELD-SYMBOL(<fs_punt_ofer_totals>) WITH KEY z_num_gen        = <fs_punts>-z_num_gen
                                                          z_codi_crit_punt = <fs_crit_total>-z_codi_crit_punt.
                  IF sy-subrc = 0.
                    <fs_punt_ofer_totals>-z_punts = lv_suma_crit_max.
                    ex_changed = abap_on.
                  ENDIF.
                ENDLOOP.
              ENDIF.
            ENDLOOP.
            IF sy-subrc <> 0.
              CLEAR: lv_actual_parent.
            ENDIF.
          ENDWHILE.
        ENDIF.
      ENDLOOP.
    ENDIF.
  ENDMETHOD.


  METHOD recalculate_crit_coefiref.
    DATA: lv_suma_crit_max      TYPE z_punts,
          lv_punts_recalculats  TYPE z_punts,
          lv_suma_crit_puntuats TYPE decfloat34,
          lv_actual_parent      TYPE z_codi_crit_punt.

    get_calcul_coefiref( IMPORTING et_dades_coefiref = DATA(lt_dades_coefiref) ).

    DATA(lt_crit_punt) = im_crit_punt.
    READ TABLE gt_equip TRANSPORTING NO FIELDS INDEX 1.
    IF sy-subrc = 0.
      DATA(lt_num_equips) = gt_equip[].
      SORT lt_num_equips BY z_num_ofer z_comptador_equip.
      DELETE ADJACENT DUPLICATES FROM lt_num_equips COMPARING z_num_ofer z_comptador_equip.
      DESCRIBE TABLE lt_num_equips LINES DATA(lv_num_equips).

      get_punts_gen_equi( IMPORTING et_punts_gen_equi = DATA(lt_punt_gen) ).

      DATA(lt_num_ofertes) = ch_punt_gen[].
      DELETE ADJACENT DUPLICATES FROM lt_num_ofertes COMPARING z_num_gen.
      DESCRIBE TABLE lt_num_ofertes LINES DATA(l_num_ofertes).

      "Primer actualitzem les puntuacions
      LOOP AT lt_num_ofertes ASSIGNING FIELD-SYMBOL(<fs_oferta>).
        DATA(lv_index_oferta_aux) = CONV z_num_ofer( <fs_oferta>-z_num_gen ).
        LOOP AT lt_punt_gen ASSIGNING FIELD-SYMBOL(<fs_punt_gen>) WHERE z_num_gen      = lv_index_oferta_aux.
          LOOP AT ch_punt_gen ASSIGNING FIELD-SYMBOL(<fs_punts_aux>) WHERE z_num_gen        = <fs_punt_gen>-z_num_gen
                                                                       AND z_carrec_equip   = <fs_punt_gen>-z_carrec_equip
                                                                       AND z_codi_crit_punt = <fs_punt_gen>-z_codi_crit_punt
                                                                       AND z_num_equip      = <fs_punt_gen>-z_num_equip.
            <fs_punts_aux>-z_punts          = <fs_punt_gen>-z_punts.
            <fs_punts_aux>-z_punts_no_pond  = <fs_punt_gen>-z_punts.
            ex_changed                      = abap_on.
          ENDLOOP.
        ENDLOOP.
      ENDLOOP.

      "Recuperem el criteri que té indicat Co-AUTOR, per tal d'acomular allà el seu total
      LOOP AT lt_crit_punt ASSIGNING FIELD-SYMBOL(<fs_crit_punt>) WHERE z_mult_equip EQ abap_on
                                                                    AND z_sumatori   IS NOT INITIAL.
        DATA(lv_sum_info)      = <fs_crit_punt>-sum_info.
        DATA(l_crit_punt_pare) = <fs_crit_punt>-z_codi_crit_punt.
      ENDLOOP.

      LOOP AT lt_num_ofertes ASSIGNING FIELD-SYMBOL(<fs_loop_oferta>).
        DATA(lv_index_oferta) = CONV z_num_ofer( <fs_loop_oferta>-z_num_gen ).
        CLEAR: lv_suma_crit_puntuats.
        LOOP AT lt_dades_coefiref ASSIGNING FIELD-SYMBOL(<fs_dades_equi_punts>) WHERE z_num_ofer = lv_index_oferta.
          lv_suma_crit_puntuats = lv_suma_crit_puntuats + <fs_dades_equi_punts>-z_total_carrec.
        ENDLOOP.
        LOOP AT ch_punt_gen ASSIGNING FIELD-SYMBOL(<fs_punts2>) WHERE z_num_gen        = lv_index_oferta
                                                                  AND z_codi_crit_punt = l_crit_punt_pare.
          <fs_punts2>-z_punts = lv_suma_crit_puntuats.
        ENDLOOP.

        "Criteri pare del Z_EQUIP_COEFICIENTIREF
        READ TABLE gt_crit_dyn_rel ASSIGNING FIELD-SYMBOL(<fs_crit_rel_pare>) WITH KEY z_child = l_crit_punt_pare.
        IF sy-subrc = 0.
          READ TABLE im_crit_punt ASSIGNING FIELD-SYMBOL(<fs_crit_total>) WITH KEY z_codi_crit_punt = <fs_crit_rel_pare>-z_parent.
          IF sy-subrc = 0.
            LOOP AT lt_num_ofertes ASSIGNING FIELD-SYMBOL(<fs_punts>).
              CLEAR: lv_suma_crit_max.
              CALL METHOD summatory_curr_dyn
                EXPORTING
                  im_sum_info  = <fs_crit_total>-sum_info
                  im_crit_punt = im_crit_punt
                  im_num_gen   = CONV #( <fs_punts>-z_num_gen )
                  im_punt_gen  = ch_punt_gen
                CHANGING
                  ch_sum       = lv_suma_crit_max.
              READ TABLE ch_punt_gen ASSIGNING FIELD-SYMBOL(<fs_punt_ofer_coaut_tot>) WITH KEY z_num_gen        = <fs_punts>-z_num_gen
                                                                                               z_codi_crit_punt = <fs_crit_total>-z_codi_crit_punt.
              IF sy-subrc = 0.
                <fs_punt_ofer_coaut_tot>-z_punts = lv_suma_crit_max.
                ex_changed = abap_on.
              ENDIF.
            ENDLOOP.
          ENDIF.
          "Hem d'acumular el criteri actual on hem acumulat al seus possibles pares
          lv_actual_parent = <fs_crit_rel_pare>-z_parent.
          WHILE lv_actual_parent IS NOT INITIAL.
            LOOP AT gt_crit_dyn_rel ASSIGNING <fs_crit_rel_pare> WHERE z_child = lv_actual_parent.
              lv_actual_parent = <fs_crit_rel_pare>-z_parent.
              READ TABLE im_crit_punt ASSIGNING <fs_crit_total> WITH KEY z_codi_crit_punt = <fs_crit_rel_pare>-z_parent.
              IF sy-subrc = 0.
                LOOP AT lt_num_ofertes ASSIGNING <fs_punts>.
                  CLEAR: lv_suma_crit_max.
                  CALL METHOD summatory_curr_dyn
                    EXPORTING
                      im_sum_info  = <fs_crit_total>-sum_info
                      im_crit_punt = im_crit_punt
                      im_num_gen   = CONV #( <fs_punts>-z_num_gen )
                      im_punt_gen  = ch_punt_gen
                    CHANGING
                      ch_sum       = lv_suma_crit_max.
                  READ TABLE ch_punt_gen ASSIGNING FIELD-SYMBOL(<fs_punt_ofer_totals>) WITH KEY z_num_gen        = <fs_punts>-z_num_gen
                                                          z_codi_crit_punt = <fs_crit_total>-z_codi_crit_punt.
                  IF sy-subrc = 0.
                    <fs_punt_ofer_totals>-z_punts = lv_suma_crit_max.
                    ex_changed = abap_on.
                  ENDIF.
                ENDLOOP.
              ENDIF.
            ENDLOOP.
            IF sy-subrc <> 0.
              CLEAR: lv_actual_parent.
            ENDIF.
          ENDWHILE.
        ENDIF.
      ENDLOOP.
    ENDIF.
  ENDMETHOD.


  METHOD recalculate_crit_dyn.
    DATA: lt_crit_punt   TYPE ty_t_crit_punt,
          l_recalculated TYPE xfeld.

    lt_crit_punt[] = im_crit_punt[].
    ">>>SPEC-55448, Inici modificació  - ETODR
*    READ TABLE lt_crit_punt TRANSPORTING NO FIELDS WITH KEY z_no_aplica = abap_on.
*    IF sy-subrc = 0.
*      recalculate_si_no_aplica( IMPORTING ex_changed     = ex_changed
*                                CHANGING  ch_punt_gen    = ch_punt_gen
*                                          ch_crit_punt   = lt_crit_punt ).
*      LOOP AT lt_crit_punt ASSIGNING FIELD-SYMBOL(<fs_crit_punt>) WHERE z_no_aplica = abap_on.
*        LOOP AT ch_punt_gen ASSIGNING FIELD-SYMBOL(<fs_punts>) WHERE z_codi_crit_punt = <fs_crit_punt>-z_codi_crit_punt.
*          CLEAR <fs_punts>-z_punts.
*        ENDLOOP.
*        "Si ja s'ha recalculat i ponderat no es sumarà el total després de restar ja que ja s'ha fet al ponderar
*        l_recalculated = abap_on.
*      ENDLOOP.
*    ENDIF.
    "<<<SPEC-55448, Final modificació - ETODR

**  >> INI MODIF ETODR SPEC-49500
    READ TABLE lt_crit_punt TRANSPORTING NO FIELDS WITH KEY z_equip_pdm = abap_on.
    "Si té criteri PDM s'ha de comprovar que si <10 punts, es repondera cada total de cada membre a partir de la fórmula [=40 / (30+PDM) ]
    IF sy-subrc = 0.
**  >> INI MODIF ETODR SPEC-51135
      READ TABLE lt_crit_punt TRANSPORTING NO FIELDS WITH KEY z_equip_coautor = abap_on.
      IF sy-subrc = 0.
        ">> SPEC-66771, Inici Modificació - ETODR
        READ TABLE lt_crit_punt TRANSPORTING NO FIELDS WITH KEY z_equip_sep = abap_on.
        IF sy-subrc = 0.
          "Si és un PCAP amb Equips separats, cal calcular el PDM individualment
          recalculate_crit_pdm_coaut_sep( EXPORTING im_crit_punt    = lt_crit_punt
                                             IMPORTING ex_changed      = ex_changed
                                             CHANGING  ch_punt_gen     = ch_punt_gen ).

        ELSE.
          "<< SPEC-66771, Final Modificació - ETODR
          "Si a més de PDM és equip de Redacció de Projectes, el PDM ha de tindre en compte els múltiples membres per cada càrrec
          recalculate_crit_pdm_coautors( EXPORTING im_crit_punt    = lt_crit_punt
                                         IMPORTING ex_changed      = ex_changed
                                         CHANGING  ch_punt_gen     = ch_punt_gen ).
        ENDIF.
      ELSE.
**  << FI MODIF ETODR SPEC-51135
        recalculate_crit_pdm( EXPORTING im_crit_punt    = lt_crit_punt
                              IMPORTING ex_changed      = ex_changed
                              CHANGING  ch_punt_gen     = ch_punt_gen ).
      ENDIF.
    ENDIF.
**  << FI MODIF ETODR SPEC-49500
**  >> INI MODIF ETODR SPEC-49498
    READ TABLE lt_crit_punt TRANSPORTING NO FIELDS WITH KEY z_equip_max = abap_on.
    "Si té criteri EQUIP MAX vol dir que ens hem de quedar amb el càrrec de l'equip que més punts té per cada grup de càrrecs i per tant la suma total canvia
    IF sy-subrc = 0.
      recalculate_crit_equip_max( EXPORTING im_crit_punt    = lt_crit_punt
                                  IMPORTING ex_changed      = DATA(lv_changed)
                                  CHANGING  ch_punt_gen     = ch_punt_gen ).
    ENDIF.
**  << FI MODIF ETODR SPEC-49498
    ">> INI MODIF ETODR SPEC-60289
    "Recalculem en cas que hi hagi co-autors sense PDM
    READ TABLE lt_crit_punt TRANSPORTING NO FIELDS WITH KEY z_equip_coautor = abap_on
                                                            z_equip_pdm     = abap_off.
    IF sy-subrc = 0.
      recalculate_crit_coautors( EXPORTING im_crit_punt    = lt_crit_punt
                                 IMPORTING ex_changed      = ex_changed
                                 CHANGING  ch_punt_gen     = ch_punt_gen ).
    ENDIF.
    "<< FI MODIF ETODR SPEC-60289
    ">> SPEC-67070, Inici Modificació - ETODR
    "Recalculem en cas que hi hagi càlcul coeficient IREF
    READ TABLE lt_crit_punt TRANSPORTING NO FIELDS WITH KEY z_coeficient_iref = zrm_cl_valoracio_ofertes_fe=>co_coeficient_iref
                                                            z_equip_coautor   = abap_off
                                                            z_equip_max       = abap_off
                                                            z_equip_pdm       = abap_off.
    IF sy-subrc = 0.
      recalculate_crit_coefiref( EXPORTING im_crit_punt    = lt_crit_punt
                                 IMPORTING ex_changed      = ex_changed
                                 CHANGING  ch_punt_gen     = ch_punt_gen ).
    ENDIF.
    "<< SPEC-67070, Final Modificació - ETODR
*******  >> INI MODIF ETODR SPEC-51135
*****    READ TABLE lt_crit_punt TRANSPORTING NO FIELDS WITH KEY z_equip_coautor = abap_on.
*****    "Si té criteri EQUIP COAUTOR vol dir que s'ha de puntuar independentment cada autor/col·laborador presentat
*****    "afectant el resultat pel factor corresponent a la proporció de dedicació ofertada de cadascun, respecte la dedicació total
*****    IF sy-subrc = 0.
*****      recalculate_crit_coautors( EXPORTING im_crit_punt    = lt_crit_punt
*****                                 IMPORTING ex_changed      = ex_changed
*****                                 CHANGING  ch_punt_gen     = ch_punt_gen ).
*****    ENDIF.
*******  << FI MODIF ETODR SPEC-51135

    ">>>SPEC-55448, Inici modificació  - ETODR
    READ TABLE lt_crit_punt TRANSPORTING NO FIELDS WITH KEY z_no_aplica = abap_on.
    IF sy-subrc = 0.
      recalculate_si_no_aplica( IMPORTING ex_changed     = ex_changed
                                CHANGING  ch_punt_gen    = ch_punt_gen
                                          ch_crit_punt   = lt_crit_punt ).
      LOOP AT lt_crit_punt ASSIGNING FIELD-SYMBOL(<fs_crit_punt>) WHERE z_no_aplica = abap_on.
        LOOP AT ch_punt_gen ASSIGNING FIELD-SYMBOL(<fs_punts>) WHERE z_codi_crit_punt = <fs_crit_punt>-z_codi_crit_punt.
          CLEAR <fs_punts>-z_punts.
        ENDLOOP.
        "Si ja s'ha recalculat i ponderat no es sumarà el total després de restar ja que ja s'ha fet al ponderar
        l_recalculated = abap_on.
      ENDLOOP.
    ENDIF.
    "<<<SPEC-55448, Final modificació - ETODR


    READ TABLE lt_crit_punt TRANSPORTING NO FIELDS WITH KEY z_resta = abap_on.
    IF sy-subrc = 0.
      recalculate_si_resta( EXPORTING im_crit_punt    = lt_crit_punt
                                      i_recalculated  = l_recalculated
                            IMPORTING ex_changed      = ex_changed
                            CHANGING  ch_punt_gen     = ch_punt_gen ).
    ENDIF.
    "Es fa el recalcul per la valoració tècnica
    recalculate_val_tecnic2_dyn(  EXPORTING im_crit_punt    = im_crit_punt
                                            i_recalculated  =  abap_true "l_recalculated ETLJS SPEC-47173
                                  IMPORTING ex_changed      = ex_changed
                                  CHANGING  ch_punt_gen     = ch_punt_gen ).
*    recalculate_val_tecnic_dyn( EXPORTING im_crit_punt    = im_crit_punt
*                                          i_recalculated  = l_recalculated
*                                IMPORTING ex_changed      = ex_changed
*                                CHANGING  ch_punt_gen     = ch_punt_gen ).

**  >> INI MODIF ETODR SPEC-49075
    "Després de calcular la part tècnica cal, si correspon en el moment d'execució, recalcular la part econòmica
    recalculate_val_econ_n( EXPORTING im_crit_punt = im_crit_punt
                            IMPORTING ex_changed   = ex_changed
                            CHANGING  ch_punt_gen  = ch_punt_gen ).
**  << FI MODIF ETODR SPEC-49075
**  >> INI MODIF ETODR SPEC-50694
    recalculate_final_dyn( EXPORTING im_crit_punt = im_crit_punt
                           IMPORTING ex_changed   = ex_changed
                           CHANGING  ch_punt_gen  = ch_punt_gen ).

**  << FI MODIF ETODR SPEC-50694
    IF lv_changed = abap_on. ex_changed = abap_on. ENDIF. "SPEC-49806
  ENDMETHOD.


  METHOD recalculate_crit_equip_max.
    DATA: lv_suma_crit_max TYPE z_punts,
          lv_actual_parent TYPE z_codi_crit_punt.

**** >> INI MODIF SPEC-49806
    READ TABLE gt_equip TRANSPORTING NO FIELDS INDEX 1.
    IF sy-subrc = 0.
      "Primer reiniciem tots els MAX definits
      LOOP AT ch_punt_gen ASSIGNING FIELD-SYMBOL(<fs_max_default>).
        <fs_max_default>-z_equip_max = abap_off.
      ENDLOOP.
      DATA(lt_num_ofertes) = ch_punt_gen[].
      DELETE ADJACENT DUPLICATES FROM lt_num_ofertes COMPARING z_num_gen.
      DESCRIBE TABLE lt_num_ofertes LINES DATA(l_num_ofertes).
      get_max_punts_equi( IMPORTING et_max_punts_equi = DATA(lt_max_punts_carrec) ).
      get_punts_gen_equi( IMPORTING et_punts_gen_equi = DATA(lt_punt_gen) ).

      DESCRIBE TABLE lt_max_punts_carrec LINES DATA(l_num_carrecs).

      "Primer actualitzem les puntuacions
      DO l_num_ofertes TIMES.
        DATA(lv_index_oferta) = CONV z_num_ofer( sy-index ).
        READ TABLE lt_num_ofertes ASSIGNING FIELD-SYMBOL(<fs_num_oferta>) INDEX lv_index_oferta.
        IF sy-subrc = 0.
          LOOP AT lt_punt_gen ASSIGNING FIELD-SYMBOL(<fs_punt_gen>) WHERE z_num_gen      = <fs_num_oferta>-z_num_gen.
            LOOP AT ch_punt_gen ASSIGNING FIELD-SYMBOL(<fs_punts>) WHERE z_num_gen        = <fs_punt_gen>-z_num_gen
                                                                     AND z_carrec_equip   = <fs_punt_gen>-z_carrec_equip
                                                                     AND z_codi_crit_punt = <fs_punt_gen>-z_codi_crit_punt
                                                                     AND z_num_equip      = <fs_punt_gen>-z_num_equip.
              <fs_punts>-z_punts          = <fs_punt_gen>-z_punts.
              <fs_punts>-z_punts_no_pond  = <fs_punt_gen>-z_punts.
              ex_changed                  = abap_on.
            ENDLOOP.
          ENDLOOP.
        ENDIF.
      ENDDO.


      "Un cop modificades les puntuacions, es marca aquelles que són d'equip màxim
      DO l_num_ofertes TIMES.
        lv_index_oferta = CONV z_num_ofer( sy-index ).
        READ TABLE lt_num_ofertes ASSIGNING <fs_num_oferta> INDEX lv_index_oferta.
        IF sy-subrc = 0.
          LOOP AT lt_max_punts_carrec ASSIGNING FIELD-SYMBOL(<fs_punts_carrec>) WHERE z_num_ofer = CONV z_num_ofer( <fs_num_oferta>-z_num_gen ).
*            LOOP AT lt_punt_gen ASSIGNING <fs_punt_gen> WHERE z_num_gen      = <fs_punts_carrec>-z_num_ofer
*                                                          AND z_carrec_equip = <fs_punts_carrec>-z_carrec_equip
*                                                          AND z_num_equip    = <fs_punts_carrec>-z_comptador_equip.
            LOOP AT ch_punt_gen ASSIGNING <fs_punts> WHERE z_num_gen        = <fs_punts_carrec>-z_num_ofer
*                                                       AND z_codi_crit_punt = <fs_punt_gen>-z_codi_crit_punt
                                                       AND z_num_equip      = <fs_punts_carrec>-z_comptador_equip.
*                <fs_punts>-z_equip_max      = <fs_punt_gen>-z_equip_max.
              <fs_punts>-z_equip_max      = abap_on.
            ENDLOOP.
*            ENDLOOP.
          ENDLOOP.
          "Acomulem fórmula per aplicar a total
          CLEAR: lv_suma_crit_max.
          LOOP AT lt_max_punts_carrec ASSIGNING <fs_punts_carrec> WHERE z_num_ofer = CONV z_num_ofer( <fs_num_oferta>-z_num_gen ).
            ADD <fs_punts_carrec>-z_punts_pes TO lv_suma_crit_max.
          ENDLOOP.
          "Finalment fem el summatory al criteri pare de l'equip
          "I després acumulem al pare del total de l'equip
          READ TABLE im_crit_punt ASSIGNING FIELD-SYMBOL(<fs_crit_max>) WITH KEY z_equip_max = abap_on.
          IF sy-subrc = 0.
            LOOP AT ch_punt_gen ASSIGNING FIELD-SYMBOL(<fs_punts2>) WHERE z_num_gen        = <fs_num_oferta>-z_num_gen
                                                                      AND z_codi_crit_punt = <fs_crit_max>-z_codi_crit_punt.
              <fs_punts2>-z_punts = lv_suma_crit_max.
            ENDLOOP.
            READ TABLE gt_crit_dyn_rel ASSIGNING FIELD-SYMBOL(<fs_crit_rel_pare>) WITH KEY z_child = <fs_crit_max>-z_codi_crit_punt.
            IF sy-subrc = 0.
              READ TABLE im_crit_punt ASSIGNING FIELD-SYMBOL(<fs_crit_total>) WITH KEY z_codi_crit_punt = <fs_crit_rel_pare>-z_parent.
              IF sy-subrc = 0.
                CLEAR: lv_suma_crit_max.
                CALL METHOD summatory_curr_dyn
                  EXPORTING
                    im_sum_info  = <fs_crit_total>-sum_info
                    im_crit_punt = im_crit_punt
                    im_num_gen   = CONV #( <fs_num_oferta>-z_num_gen )
                    im_punt_gen  = ch_punt_gen
                  CHANGING
                    ch_sum       = lv_suma_crit_max.
                READ TABLE ch_punt_gen ASSIGNING FIELD-SYMBOL(<fs_punt_ofer_max_tot>) WITH KEY z_num_gen        = <fs_num_oferta>-z_num_gen
                                                                                               z_codi_crit_punt = <fs_crit_total>-z_codi_crit_punt.
                IF sy-subrc = 0.
                  <fs_punt_ofer_max_tot>-z_punts = lv_suma_crit_max.
                  ex_changed = abap_on.
                ENDIF.
              ENDIF.
              ">>>SPEC-55448, Inici modificació  - ETODR
              "Hem d'acumular el criteri actual on hem acumulat al seus possibles pares
              CLEAR: lv_actual_parent.
              lv_actual_parent = <fs_crit_rel_pare>-z_parent.
              WHILE lv_actual_parent IS NOT INITIAL.
                LOOP AT gt_crit_dyn_rel ASSIGNING <fs_crit_rel_pare> WHERE z_child = lv_actual_parent.
                  lv_actual_parent = <fs_crit_rel_pare>-z_parent.
                  READ TABLE im_crit_punt ASSIGNING <fs_crit_total> WITH KEY z_codi_crit_punt = <fs_crit_rel_pare>-z_parent.
                  IF sy-subrc = 0.
                    CALL METHOD summatory_curr_dyn
                      EXPORTING
                        im_sum_info  = <fs_crit_total>-sum_info
                        im_crit_punt = im_crit_punt
                        im_num_gen   = CONV #( <fs_num_oferta>-z_num_gen )
                        im_punt_gen  = ch_punt_gen
                      CHANGING
                        ch_sum       = lv_suma_crit_max.
                    READ TABLE ch_punt_gen ASSIGNING FIELD-SYMBOL(<fs_punt_ofer_totals>) WITH KEY z_num_gen        = <fs_num_oferta>-z_num_gen
                                                                                                  z_codi_crit_punt = <fs_crit_total>-z_codi_crit_punt.
                    IF sy-subrc = 0.
                      <fs_punt_ofer_totals>-z_punts = lv_suma_crit_max.
                      ex_changed = abap_on.
                    ENDIF.
                  ENDIF.
                ENDLOOP.
                IF sy-subrc <> 0.
                  CLEAR: lv_actual_parent.
                ENDIF.
              ENDWHILE.
              "<<<SPEC-55448, Final modificació - <usuari>
            ENDIF.
          ENDIF.
        ENDIF.
      ENDDO.
    ENDIF.
**** << FI MODIF SPEC-49806
****    TYPES: BEGIN OF ty_s_carrec_punts,
****             z_carrec_equip    TYPE z_carrec_equip,
****             z_comptador_equip TYPE z_compta_equip,
****             z_punts           TYPE z_punts,
****             z_pes             TYPE i,
****             z_punts_pes       TYPE z_punts,
****           END OF ty_s_carrec_punts,
****           ty_t_carrec_punts TYPE STANDARD TABLE OF ty_s_carrec_punts.
**    DATA: lt_max_punts_carrec TYPE ty_t_carrec_punts,
**          wa_punts_carrec     TYPE ty_s_carrec_punts,
**          lv_suma_crit_max    TYPE z_punts.
**
**    READ TABLE gt_equip TRANSPORTING NO FIELDS INDEX 1.
**    IF sy-subrc = 0.
**      "Primer reiniciem tots els MAX definits
**      LOOP AT ch_punt_gen ASSIGNING FIELD-SYMBOL(<fs_max_default>).
**        <fs_max_default>-z_equip_max = abap_off.
**      ENDLOOP.
**
**      CLEAR: lt_max_punts_carrec[].
**      "Recorrerem tots els punts de cada equip i en comprovarem quin és el càrrec amb MAX_PUNTS i serà el que acumularem al TOTAL i al seu immediat superior
**      DATA(lt_num_equips) = gt_equip[].
**      SORT lt_num_equips BY z_num_ofer z_comptador_equip z_carrec_equip.
**      DELETE ADJACENT DUPLICATES FROM lt_num_equips COMPARING z_num_ofer z_comptador_equip z_carrec_equip.
**      DESCRIBE TABLE lt_num_equips LINES DATA(lv_num_equips).
**
**      DATA(lt_num_ofertes) = ch_punt_gen[].
**      DELETE ADJACENT DUPLICATES FROM lt_num_ofertes COMPARING z_num_gen.
**      DESCRIBE TABLE lt_num_ofertes LINES DATA(l_num_ofertes).
**      DO l_num_ofertes TIMES.
**        DATA(lv_index_oferta) = CONV z_num_ofer( sy-index ).
**        CLEAR: lt_max_punts_carrec[].
**        "Per cada oferta recorrem l'equip sencer, buscant el màxim de cada càrrec
**        LOOP AT lt_num_equips ASSIGNING FIELD-SYMBOL(<fs_equip_oferta>) WHERE z_num_ofer = lv_index_oferta.
**          DATA(lv_index_carrec)     = CONV z_carrec_equip( <fs_equip_oferta>-z_carrec_equip ).
**          DATA(lv_comptador_equip)  = CONV z_compta_equip( <fs_equip_oferta>-z_comptador_equip ).
**
**          CLEAR: wa_punts_carrec.
**          wa_punts_carrec-z_carrec_equip    = lv_index_carrec.
**          wa_punts_carrec-z_comptador_equip = lv_comptador_equip.
**          wa_punts_carrec-z_pes             = CONV i( <fs_equip_oferta>-z_pes ).
**          LOOP AT ch_punt_gen ASSIGNING FIELD-SYMBOL(<fs_punts>) WHERE z_num_gen      = lv_index_oferta
**                                                                   AND z_carrec_equip = lv_index_carrec
**                                                                   AND z_num_equip    = lv_comptador_equip.
**            wa_punts_carrec-z_punts = wa_punts_carrec-z_punts + <fs_punts>-z_punts.
**          ENDLOOP.
**          wa_punts_carrec-z_punts_pes = CONV z_punts( wa_punts_carrec-z_punts * ( wa_punts_carrec-z_pes / 100 ) ).
**          READ TABLE lt_max_punts_carrec ASSIGNING FIELD-SYMBOL(<fs_punts_carrec>) WITH KEY z_carrec_equip = lv_index_carrec.
**          IF sy-subrc <> 0.
**            APPEND wa_punts_carrec TO lt_max_punts_carrec.
**          ELSE.
**            IF <fs_punts_carrec>-z_punts < wa_punts_carrec-z_punts.
**              <fs_punts_carrec>-z_punts           = wa_punts_carrec-z_punts.
**              <fs_punts_carrec>-z_comptador_equip = wa_punts_carrec-z_comptador_equip.
**              <fs_punts_carrec>-z_punts_pes       = wa_punts_carrec-z_punts_pes.
**            ENDIF.
**          ENDIF.
**        ENDLOOP.
**        LOOP AT lt_max_punts_carrec ASSIGNING <fs_punts_carrec>.
**          LOOP AT ch_punt_gen ASSIGNING <fs_punts> WHERE z_num_gen      = lv_index_oferta
**                                                     AND z_carrec_equip = <fs_punts_carrec>-z_carrec_equip
**                                                     AND z_num_equip    = <fs_punts_carrec>-z_comptador_equip.
**            <fs_punts>-z_equip_max = abap_on.
**            ex_changed             = abap_on.
**          ENDLOOP.
**        ENDLOOP.
**        "Criteri MAX
**        CLEAR: lv_suma_crit_max.
**        LOOP AT lt_max_punts_carrec ASSIGNING <fs_punts_carrec>.
**          "Acomulem fórmula per aplicar a total
**          lv_suma_crit_max = lv_suma_crit_max + <fs_punts_carrec>-z_punts_pes.
**        ENDLOOP.
**        READ TABLE im_crit_punt ASSIGNING FIELD-SYMBOL(<fs_crit_max>) WITH KEY z_equip_max = abap_on.
**        IF sy-subrc = 0.
**          LOOP AT ch_punt_gen ASSIGNING FIELD-SYMBOL(<fs_punts2>) WHERE z_num_gen        = lv_index_oferta
**                                                                    AND z_codi_crit_punt = <fs_crit_max>-z_codi_crit_punt.
**            <fs_punts2>-z_punts = lv_suma_crit_max.
**          ENDLOOP.
**          "Criteri pare del MAX
**          READ TABLE gt_crit_dyn_rel ASSIGNING FIELD-SYMBOL(<fs_crit_rel_pare>) WITH KEY z_child = <fs_crit_max>-z_codi_crit_punt.
**          IF sy-subrc = 0.
**            READ TABLE im_crit_punt ASSIGNING FIELD-SYMBOL(<fs_crit_total>) WITH KEY z_codi_crit_punt = <fs_crit_rel_pare>-z_parent.
**            IF sy-subrc = 0.
**              LOOP AT lt_num_ofertes ASSIGNING <fs_punts>.
**                CLEAR: lv_suma_crit_max.
**                CALL METHOD summatory_curr_dyn
**                  EXPORTING
**                    im_sum_info  = <fs_crit_total>-sum_info
**                    im_crit_punt = im_crit_punt
**                    im_num_gen   = CONV #( <fs_punts>-z_num_gen )
**                    im_punt_gen  = ch_punt_gen
**                  CHANGING
**                    ch_sum       = lv_suma_crit_max.
**                READ TABLE ch_punt_gen ASSIGNING FIELD-SYMBOL(<fs_punt_ofer_max_tot>) WITH KEY z_num_gen        = <fs_punts>-z_num_gen
**                                                                                               z_codi_crit_punt = <fs_crit_total>-z_codi_crit_punt.
**                IF sy-subrc = 0.
**                  <fs_punt_ofer_max_tot>-z_punts = lv_suma_crit_max.
**                  ex_changed = abap_on.
**                ENDIF.
**              ENDLOOP.
**            ENDIF.
**          ENDIF.
**        ENDIF.
**      ENDDO.
**    ENDIF.
  ENDMETHOD.


  METHOD recalculate_crit_pdm.
    TYPES: BEGIN OF ty_s_suma_pdm,
             z_comptador_equip         TYPE z_compta_equip,
             z_punts_abans_formula_pdm TYPE z_punts,
             z_formula_pdm             TYPE decfloat34,
             z_total_pdm               TYPE z_punts,
           END OF ty_s_suma_pdm,
           ty_t_suma_pdm TYPE STANDARD TABLE OF ty_s_suma_pdm.

    DATA: lt_calcul_pdm           TYPE ty_t_suma_pdm,
          wa_calcul_pdm           TYPE ty_s_suma_pdm,
          lv_suma_crit_puntuats   TYPE z_punts,
          lv_suma_crit_max        TYPE z_punts,
          lv_puntuacio_pdm        TYPE char10,
          lv_pdm                  TYPE z_formula_pdm,
          lv_resultat_formula_pdm TYPE decfloat34,
          lv_total_pdm            TYPE decfloat34,
          lv_punts_recalculats    TYPE z_punts,
          lv_actual_parent        TYPE z_codi_crit_punt, "SPEC-55448
          ls_equip                TYPE zrm_dt_punt_equi, "SPEC-73534
          lv_dedicacio_ofertada   TYPE z_dedicacio_ofertada,
          lv_dedicacio_minima     TYPE z_dedicacio_min,
          lv_dt                   TYPE z_dedicacio_min,
          ls_punts                TYPE f.

    DATA(lt_crit_punt) = im_crit_punt.
    READ TABLE gt_equip TRANSPORTING NO FIELDS WITH KEY z_equip_pdm = abap_on.

    DATA(lt_num_equips) = gt_equip[].
    SORT lt_num_equips BY z_num_ofer z_comptador_equip.
    DELETE ADJACENT DUPLICATES FROM lt_num_equips COMPARING z_num_ofer z_comptador_equip.
    DESCRIBE TABLE lt_num_equips LINES DATA(lv_num_equips).

    DATA(lt_num_ofertes) = ch_punt_gen[].
    DELETE ADJACENT DUPLICATES FROM lt_num_ofertes COMPARING z_num_gen.
    DESCRIBE TABLE lt_num_ofertes LINES DATA(l_num_ofertes).

    "Recuperem la fórmula del PDM del Plec
    LOOP AT lt_crit_punt ASSIGNING FIELD-SYMBOL(<fs_crit_punt>) WHERE z_equip_pdm EQ abap_on
                                                                  AND z_sumatori IS NOT INITIAL.
      DATA(lv_formula_pdm)   = <fs_crit_punt>-z_formula_pdm.
      DATA(lv_sum_info)      = <fs_crit_punt>-sum_info.
      DATA(l_crit_punt_pare) = <fs_crit_punt>-z_codi_crit_punt.
    ENDLOOP.

*    DO l_num_ofertes TIMES. "SPEC-50770
    LOOP AT lt_num_ofertes ASSIGNING FIELD-SYMBOL(<fs_loop_oferta>). "SPEC-50770
      "Per cada criteri de cada oferta diferent de cada equip de GT_EQUIPS amb la marca de EQUIP_PDM = , s'omple la taula LT_CALCUL_PDM
**    >> INI MODIF ETODR SPEC-50770
*      DATA(lv_index_oferta) = CONV z_num_ofer( sy-index ).
      DATA(lv_index_oferta) = CONV z_num_ofer( <fs_loop_oferta>-z_num_gen ).
**    << INI MODIF ETODR SPEC-50770
      CLEAR: lt_calcul_pdm[].
      LOOP AT lt_num_equips ASSIGNING FIELD-SYMBOL(<fs_equip_oferta>) WHERE z_num_ofer = lv_index_oferta.
        DATA(lv_comptador_equip)  = CONV z_compta_equip( <fs_equip_oferta>-z_comptador_equip ).
        CLEAR: wa_calcul_pdm.
        wa_calcul_pdm-z_comptador_equip = <fs_equip_oferta>-z_comptador_equip.
        "Càlcul de la puntuació sense aplicar el factor de correcció del PDM
        LOOP AT ch_punt_gen ASSIGNING FIELD-SYMBOL(<fs_punts>) WHERE z_num_gen      = lv_index_oferta
                                                                 AND z_num_equip    = lv_comptador_equip.
          wa_calcul_pdm-z_punts_abans_formula_pdm = wa_calcul_pdm-z_punts_abans_formula_pdm + <fs_punts>-z_punts.
        ENDLOOP.
        DATA(lv_pes) = CONV i( <fs_equip_oferta>-z_pes ).
        wa_calcul_pdm-z_punts_abans_formula_pdm = CONV z_punts( wa_calcul_pdm-z_punts_abans_formula_pdm * ( lv_pes / 100 ) ).
        "Busquem fórmula
        LOOP AT gt_equip ASSIGNING FIELD-SYMBOL(<fs_equip_pdm>) WHERE z_num_ofer         = lv_index_oferta
                                                                  AND z_comptador_equip  = lv_comptador_equip
                                                                  AND z_equip_pdm        = abap_on
          ">>> Inici modificació ECJMS SPEC:73534 Data: 24.10.2022 09:08:23
*                                                                  AND z_is_header        = abap_on.
          "<<< Final modificació ECJMS SPEC:73534 Data: 24.10.2022 09:08:23
                                                                  AND z_is_header        = abap_off. " SPEC-79086 ECAGM necessitem fer el cálcul per a cada node fill

          DATA(lv_formula_pdm_temporal) = lv_formula_pdm.
          ASSIGN COMPONENT 'Z_PUNT_MAX' OF STRUCTURE <fs_equip_pdm> TO FIELD-SYMBOL(<fs_puntuacio_pdm>).
          CHECK sy-subrc = 0.
          lv_puntuacio_pdm = CONV #( <fs_puntuacio_pdm> ).
          SHIFT lv_puntuacio_pdm LEFT DELETING LEADING space.
          REPLACE ALL OCCURRENCES OF '[PDM]' IN lv_formula_pdm_temporal WITH lv_puntuacio_pdm.
          CHECK sy-subrc = 0.
          CLEAR: lv_resultat_formula_pdm.
*** INI SPEC-79086 ECAGM càlcul del PDM
          lv_dedicacio_minima =    <fs_equip_pdm>-z_dedicacio_min.
          IF <fs_equip_pdm>-z_exclusivitat = abap_on.
            <fs_equip_pdm>-z_dedicacio_ofertada = 100.
          ENDIF.
          lv_dedicacio_ofertada =  <fs_equip_pdm>-z_dedicacio_ofertada.
          IF ( lv_dedicacio_minima + 20 ) < 100.
            lv_dt = lv_dedicacio_minima.
          ELSE.
            lv_dt = 100.
          ENDIF.

          lv_pdm = ( lv_dt - lv_dedicacio_minima ) / 5.

*          lv_formula_pdm_temporal = lv_pdm.
*          SHIFT lv_puntuacio_pdm LEFT DELETING LEADING space.
*          REPLACE ALL OCCURRENCES OF '[PDM]' IN lv_formula_pdm_temporal WITH lv_puntuacio_pdm.
*** END SPEC-79086 ECAGM nou PDM

          CALL FUNCTION 'EVAL_FORMULA'
            EXPORTING
              formula = lv_formula_pdm_temporal
              program = sy-repid
            IMPORTING
              value   = lv_resultat_formula_pdm
            EXCEPTIONS
              OTHERS  = 11.
          CHECK sy-subrc = 0.
          wa_calcul_pdm-z_formula_pdm = lv_resultat_formula_pdm.
          "EXIT.    " SPEC-79086 ECAGM
          "ENDLOOP. " SPEC-79086 ECAGM movem el endloop mes abaix per tenir una fórmula diferent per a cada node

**************************
**************************

          READ TABLE lt_calcul_pdm TRANSPORTING NO FIELDS WITH KEY z_comptador_equip  = wa_calcul_pdm-z_comptador_equip.
          IF sy-subrc <> 0.
            ">>> Inici modificació ECJMS SPEC:73534 Data: 24.10.2022 09:13:32

*     Es realitza un registre per cada node fill del tractat
            LOOP AT gt_equip INTO ls_equip
              WHERE z_num_ofer         = lv_index_oferta    AND
                    z_comptador_equip  = lv_comptador_equip AND
                    z_is_header        = abap_false.

              READ TABLE ch_punt_gen ASSIGNING FIELD-SYMBOL(<fs_gen>)
                    WITH KEY z_mod_crit_punt  = ls_equip-z_mod_crit_punt
                             z_codi_crit_punt = ls_equip-z_codi_crit_punt
                             z_num_gen        = ls_equip-z_num_ofer
                             z_num_equip      = ls_equip-z_comptador_equip.

              ls_punts = <fs_gen>-z_punts * ls_equip-z_pes / 100.
              wa_calcul_pdm-z_punts_abans_formula_pdm = ls_punts.

** INI ECAGM SPEC-79086 ARA, el càlcul de la formula PDM aplica als 3 subapartats, per tant asumirem que si el node pare es PDM, tots els subapartats apliquen
              READ TABLE gt_equip TRANSPORTING NO FIELDS WITH KEY z_num_ofer         = lv_index_oferta
                                                                  z_comptador_equip  = lv_comptador_equip
                                                                  z_is_header        = abap_true
                                                                  z_equip_pdm        = abap_true.
              IF sy-subrc = 0.
                wa_calcul_pdm-z_formula_pdm = lv_resultat_formula_pdm.
              ENDIF.

**** esto se asterisca, no sirve
*              IF ls_equip-z_equip_pdm EQ abap_false.
**     Si el node fill NO es PDM el factor sera 1.
*                wa_calcul_pdm-z_formula_pdm = 1.
*              ELSE.
**     Si el node fill ES PDM el factor sera el calculat per la formula.
**                wa_calcul_pdm-z_formula_pdm = lv_resultat_formula_pdm.
*                  wa_calcul_pdm-z_formula_pdm = 1.
*              ENDIF.

** END ECAGM SPEC-79086

              APPEND wa_calcul_pdm TO lt_calcul_pdm.

            ENDLOOP.

            "<<< Final modificació ECJMS SPEC:73534 Data: 24.10.2022 09:13:32

          ENDIF.
        ENDLOOP."**********  SPEC-79086 ECAGM endloop mogut aqui
      ENDLOOP.

      LOOP AT lt_calcul_pdm ASSIGNING FIELD-SYMBOL(<fs_calcul_pdm>).
        "Acomulem fórmula per aplicar a total
        <fs_calcul_pdm>-z_total_pdm  = <fs_calcul_pdm>-z_formula_pdm * <fs_calcul_pdm>-z_punts_abans_formula_pdm.
        lv_suma_crit_puntuats = lv_suma_crit_puntuats + <fs_calcul_pdm>-z_total_pdm.
      ENDLOOP.
      LOOP AT ch_punt_gen ASSIGNING FIELD-SYMBOL(<fs_punts2>) WHERE z_num_gen        = lv_index_oferta
                                                               AND z_codi_crit_punt = l_crit_punt_pare.
        <fs_punts2>-z_punts = lv_suma_crit_puntuats.
      ENDLOOP.

*       "Criteri pare del PDM
      READ TABLE gt_crit_dyn_rel ASSIGNING FIELD-SYMBOL(<fs_crit_rel_pare>) WITH KEY z_child = l_crit_punt_pare.
      IF sy-subrc = 0.
        READ TABLE im_crit_punt ASSIGNING FIELD-SYMBOL(<fs_crit_total>) WITH KEY z_codi_crit_punt = <fs_crit_rel_pare>-z_parent.
        IF sy-subrc = 0.
          LOOP AT lt_num_ofertes ASSIGNING <fs_punts>.
            CLEAR: lv_suma_crit_max.
            CALL METHOD summatory_curr_dyn
              EXPORTING
                im_sum_info  = <fs_crit_total>-sum_info
                im_crit_punt = im_crit_punt
                im_num_gen   = CONV #( <fs_punts>-z_num_gen )
                im_punt_gen  = ch_punt_gen
              CHANGING
                ch_sum       = lv_suma_crit_max.
            READ TABLE ch_punt_gen ASSIGNING FIELD-SYMBOL(<fs_punt_ofer_pdm_tot>) WITH KEY z_num_gen        = <fs_punts>-z_num_gen
                                                                                           z_codi_crit_punt = <fs_crit_total>-z_codi_crit_punt.
            IF sy-subrc = 0.
              <fs_punt_ofer_pdm_tot>-z_punts = lv_suma_crit_max.
              ex_changed = abap_on.
            ENDIF.
          ENDLOOP.
        ENDIF.
        ">>>SPEC-55448, Inici modificació  - ETODR
        "Hem d'acumular el criteri actual on hem acumulat al seus possibles pares
        lv_actual_parent = <fs_crit_rel_pare>-z_parent.
        WHILE lv_actual_parent IS NOT INITIAL.
          LOOP AT gt_crit_dyn_rel ASSIGNING <fs_crit_rel_pare> WHERE z_child = lv_actual_parent.
            lv_actual_parent = <fs_crit_rel_pare>-z_parent.
            READ TABLE im_crit_punt ASSIGNING <fs_crit_total> WITH KEY z_codi_crit_punt = <fs_crit_rel_pare>-z_parent.
            IF sy-subrc = 0.
              LOOP AT lt_num_ofertes ASSIGNING <fs_punts>.
                CLEAR: lv_suma_crit_max.
                CALL METHOD summatory_curr_dyn
                  EXPORTING
                    im_sum_info  = <fs_crit_total>-sum_info
                    im_crit_punt = im_crit_punt
                    im_num_gen   = CONV #( <fs_punts>-z_num_gen )
                    im_punt_gen  = ch_punt_gen
                  CHANGING
                    ch_sum       = lv_suma_crit_max.
                READ TABLE ch_punt_gen ASSIGNING FIELD-SYMBOL(<fs_punt_ofer_totals>) WITH KEY z_num_gen        = <fs_punts>-z_num_gen
                                                                                              z_codi_crit_punt = <fs_crit_total>-z_codi_crit_punt.
                IF sy-subrc = 0.
                  <fs_punt_ofer_totals>-z_punts = lv_suma_crit_max.
                  ex_changed = abap_on.
                ENDIF.
              ENDLOOP.
            ENDIF.
          ENDLOOP.
          IF sy-subrc <> 0.
            CLEAR: lv_actual_parent.
          ENDIF.
        ENDWHILE.
        "<<<SPEC-55448, Final modificació - <usuari>
      ENDIF.
      CLEAR: lv_suma_crit_puntuats.
    ENDLOOP.
*    ENDDO.
  ENDMETHOD.


  METHOD recalculate_crit_pdm_coautors.
    TYPES: BEGIN OF ty_s_suma_pdm,
             z_comptador_equip         TYPE z_compta_equip,
             z_carrec_equip            TYPE z_carrec_equip,
             z_punts_abans_formula_pdm TYPE z_punts,
             z_formula_pdm             TYPE decfloat34,
             z_total_pdm               TYPE z_punts,
             z_dedicacio_ofertada      TYPE z_dedicacio_ofertada,
             z_total_carrec            TYPE z_punts,
           END OF ty_s_suma_pdm,
           ty_t_suma_pdm TYPE STANDARD TABLE OF ty_s_suma_pdm.

    DATA: lt_calcul_pdm           TYPE ty_t_suma_pdm,
          lt_calcul_pdm_carrecs   TYPE ty_t_suma_pdm,
          wa_calcul_pdm           TYPE ty_s_suma_pdm,
          lv_suma_crit_puntuats   TYPE decfloat34, "z_punts,
          lv_suma_dedic_ofert     TYPE decfloat34, "z_punts,
          lv_suma_crit_max        TYPE z_punts,
          lv_puntuacio_pdm        TYPE char10,
          lv_resultat_formula_pdm TYPE decfloat34,
          lv_total_pdm            TYPE decfloat34,
          lv_punts_recalculats    TYPE z_punts,
          lv_actual_parent        TYPE z_codi_crit_punt.        "SPEC-55448

    get_calcul_pdm_coautors( IMPORTING et_dades_pdm_coautors = DATA(lt_dades_pdm_coautors) ).

    DATA(lt_crit_punt) = im_crit_punt.
    READ TABLE gt_equip TRANSPORTING NO FIELDS WITH KEY z_equip_pdm = abap_on.
    CHECK sy-subrc = 0.

    DATA(lt_num_equips) = gt_equip[].
    SORT lt_num_equips BY z_num_ofer z_comptador_equip.
    DELETE ADJACENT DUPLICATES FROM lt_num_equips COMPARING z_num_ofer z_comptador_equip.
    DESCRIBE TABLE lt_num_equips LINES DATA(lv_num_equips).

    get_punts_gen_equi( IMPORTING et_punts_gen_equi = DATA(lt_punt_gen) ).

    DATA(lt_num_ofertes) = ch_punt_gen[].
    DELETE ADJACENT DUPLICATES FROM lt_num_ofertes COMPARING z_num_gen.
    DESCRIBE TABLE lt_num_ofertes LINES DATA(l_num_ofertes).

    "Primer actualitzem les puntuacions
    LOOP AT lt_num_ofertes ASSIGNING FIELD-SYMBOL(<fs_oferta>).
      DATA(lv_index_oferta_aux) = CONV z_num_ofer( <fs_oferta>-z_num_gen ).
      LOOP AT lt_punt_gen ASSIGNING FIELD-SYMBOL(<fs_punt_gen>) WHERE z_num_gen      = lv_index_oferta_aux.
        LOOP AT ch_punt_gen ASSIGNING FIELD-SYMBOL(<fs_punts_aux>) WHERE z_num_gen        = <fs_punt_gen>-z_num_gen
                                                                     AND z_carrec_equip   = <fs_punt_gen>-z_carrec_equip
                                                                     AND z_codi_crit_punt = <fs_punt_gen>-z_codi_crit_punt
                                                                     AND z_num_equip      = <fs_punt_gen>-z_num_equip.
          <fs_punts_aux>-z_punts          = <fs_punt_gen>-z_punts.
          <fs_punts_aux>-z_punts_no_pond  = <fs_punt_gen>-z_punts.
          ex_changed                      = abap_on.
        ENDLOOP.
      ENDLOOP.
    ENDLOOP.

    "Recuperem la fórmula del PDM del Plec
    LOOP AT lt_crit_punt ASSIGNING FIELD-SYMBOL(<fs_crit_punt>) WHERE z_equip_pdm EQ abap_on
                                                                  AND z_sumatori IS NOT INITIAL.
      DATA(lv_formula_pdm)   = <fs_crit_punt>-z_formula_pdm.
      DATA(lv_sum_info)      = <fs_crit_punt>-sum_info.
      DATA(l_crit_punt_pare) = <fs_crit_punt>-z_codi_crit_punt.
    ENDLOOP.

    LOOP AT lt_num_ofertes ASSIGNING FIELD-SYMBOL(<fs_loop_oferta>). "SPEC-50770
      "Per cada criteri de cada oferta diferent de cada equip de GT_EQUIPS amb la marca de EQUIP_PDM = , s'omple la taula LT_CALCUL_PDM
      DATA(lv_index_oferta) = CONV z_num_ofer( <fs_loop_oferta>-z_num_gen ).
*      CLEAR: lt_calcul_pdm[].
*      LOOP AT lt_num_equips ASSIGNING FIELD-SYMBOL(<fs_equip_oferta>) WHERE z_num_ofer = lv_index_oferta.
*        DATA(lv_comptador_equip)  = CONV z_compta_equip( <fs_equip_oferta>-z_comptador_equip ).
*        CLEAR: wa_calcul_pdm.
*        wa_calcul_pdm-z_comptador_equip = <fs_equip_oferta>-z_comptador_equip.
*        "Càlcul de la puntuació sense aplicar el factor de correcció del PDM
*        LOOP AT ch_punt_gen ASSIGNING FIELD-SYMBOL(<fs_punts>) WHERE z_num_gen      = lv_index_oferta
*                                                                 AND z_num_equip    = lv_comptador_equip.
*          wa_calcul_pdm-z_punts_abans_formula_pdm = wa_calcul_pdm-z_punts_abans_formula_pdm + <fs_punts>-z_punts.
*        ENDLOOP.
*        DATA(lv_pes) = CONV i( <fs_equip_oferta>-z_pes ).
*        wa_calcul_pdm-z_punts_abans_formula_pdm = CONV z_punts( wa_calcul_pdm-z_punts_abans_formula_pdm * ( lv_pes / 100 ) ).
*        "Busquem fórmula
*        LOOP AT gt_equip ASSIGNING FIELD-SYMBOL(<fs_equip_pdm>) WHERE z_num_ofer         = lv_index_oferta
*                                                                  AND z_comptador_equip  = lv_comptador_equip
*                                                                  AND z_equip_pdm        = abap_on
*                                                                  AND z_is_header        = abap_off.
*          DATA(lv_formula_pdm_temporal) = lv_formula_pdm.
*          ASSIGN COMPONENT 'Z_PUNT_MAX' OF STRUCTURE <fs_equip_pdm> TO FIELD-SYMBOL(<fs_puntuacio_pdm>).
*          CHECK sy-subrc = 0.
*          lv_puntuacio_pdm = CONV #( <fs_puntuacio_pdm> ).
*          SHIFT lv_puntuacio_pdm LEFT DELETING LEADING space.
*          REPLACE ALL OCCURRENCES OF '[PDM]' IN lv_formula_pdm_temporal WITH lv_puntuacio_pdm.
*          CHECK sy-subrc = 0.
*          CLEAR: lv_resultat_formula_pdm.
*          CALL FUNCTION 'EVAL_FORMULA'
*            EXPORTING
*              formula = lv_formula_pdm_temporal
*              program = sy-repid
*            IMPORTING
*              value   = lv_resultat_formula_pdm
*            EXCEPTIONS
*              OTHERS  = 11.
*          CHECK sy-subrc = 0.
*          wa_calcul_pdm-z_formula_pdm         = lv_resultat_formula_pdm.
*          wa_calcul_pdm-z_carrec_equip        = <fs_equip_pdm>-z_carrec_equip.
*          wa_calcul_pdm-z_dedicacio_ofertada  = <fs_equip_pdm>-z_dedicacio_ofertada.
*          EXIT.
*        ENDLOOP.
*
*        READ TABLE lt_calcul_pdm TRANSPORTING NO FIELDS WITH KEY z_comptador_equip  = wa_calcul_pdm-z_comptador_equip.
*        IF sy-subrc <> 0.
*          APPEND wa_calcul_pdm TO lt_calcul_pdm.
*        ENDIF.
*      ENDLOOP.
*      "En aquest punt crec que tenim els totals ja ponderats per cada membre de cada càrrec de cada oferta.
*      "S'ha d'aplicar lògica nova:
*      DATA(lt_carrecs) = lt_calcul_pdm.
*      SORT lt_carrecs BY z_carrec_equip.
*      DELETE ADJACENT DUPLICATES FROM lt_carrecs COMPARING z_carrec_equip.
*      LOOP AT lt_calcul_pdm ASSIGNING FIELD-SYMBOL(<fs_calcul_pdm>).
*        <fs_calcul_pdm>-z_total_pdm  = <fs_calcul_pdm>-z_formula_pdm * <fs_calcul_pdm>-z_punts_abans_formula_pdm.
*      ENDLOOP.
*
*      CLEAR: lv_suma_dedic_ofert, lv_suma_crit_puntuats, lt_calcul_pdm_carrecs[].
*
*      LOOP AT lt_carrecs ASSIGNING FIELD-SYMBOL(<fs_carrec>).
*        CLEAR: lv_suma_dedic_ofert, lv_suma_crit_puntuats.
*        LOOP AT lt_calcul_pdm ASSIGNING <fs_calcul_pdm> WHERE z_carrec_equip = <fs_carrec>-z_carrec_equip.
*          "Puntuació total de cada grup de càrrecs = Suma( Puntuació Total membre equip càrrec X * Dedicació Ofertada membre equip càrrec X)  / Suma(dedicacións ofertades membres equip càrrec X)
*          lv_suma_crit_puntuats = ( <fs_calcul_pdm>-z_total_pdm * <fs_calcul_pdm>-z_dedicacio_ofertada ) + lv_suma_crit_puntuats.
*        ENDLOOP.
*        LOOP AT lt_calcul_pdm ASSIGNING <fs_calcul_pdm> WHERE z_carrec_equip = <fs_carrec>-z_carrec_equip.
*          "Puntuació total de cada grup de càrrecs = Suma( Puntuació Total membre equip càrrec X * Dedicació Ofertada membre equip càrrec X)  / Suma(dedicacións ofertades membres equip càrrec X)
*          lv_suma_dedic_ofert = <fs_calcul_pdm>-z_dedicacio_ofertada + lv_suma_dedic_ofert.
*        ENDLOOP.
*        IF lv_suma_dedic_ofert > 0.
*          lv_suma_crit_puntuats = lv_suma_crit_puntuats / lv_suma_dedic_ofert.
*        ELSE.
*          lv_suma_crit_puntuats = 0.
*        ENDIF.
*
*        READ TABLE lt_calcul_pdm_carrecs ASSIGNING FIELD-SYMBOL(<fs_total_pdm_carrecs>) WITH KEY z_carrec_equip = <fs_carrec>-z_carrec_equip.
*        IF sy-subrc <> 0.
*          CLEAR: wa_calcul_pdm.
*          wa_calcul_pdm-z_carrec_equip = <fs_carrec>-z_carrec_equip.
*          wa_calcul_pdm-z_total_carrec = lv_suma_crit_puntuats.
*          APPEND wa_calcul_pdm TO lt_calcul_pdm_carrecs.
*        ELSE.
*          <fs_total_pdm_carrecs>-z_total_carrec = <fs_total_pdm_carrecs>-z_total_carrec + lv_suma_crit_puntuats.
*        ENDIF.
*      ENDLOOP.
*
*      CLEAR: lv_suma_dedic_ofert, lv_suma_crit_puntuats.
*      LOOP AT lt_calcul_pdm_carrecs ASSIGNING <fs_calcul_pdm>.
*        "Acomulem fórmula per aplicar a total
*        lv_suma_crit_puntuats = lv_suma_crit_puntuats + <fs_calcul_pdm>-z_total_carrec.
*      ENDLOOP.
      CLEAR: lv_suma_dedic_ofert, lv_suma_crit_puntuats.
      LOOP AT lt_dades_pdm_coautors ASSIGNING FIELD-SYMBOL(<fs_dades_pdm>) WHERE z_num_ofer = lv_index_oferta.
        "Acomulem fórmula per aplicar a total
        lv_suma_crit_puntuats = lv_suma_crit_puntuats + <fs_dades_pdm>-z_total_carrec.
      ENDLOOP.

      LOOP AT ch_punt_gen ASSIGNING FIELD-SYMBOL(<fs_punts2>) WHERE z_num_gen        = lv_index_oferta
                                                                AND z_codi_crit_punt = l_crit_punt_pare.
        <fs_punts2>-z_punts = lv_suma_crit_puntuats.
      ENDLOOP.

*       "Criteri pare del PDM
      READ TABLE gt_crit_dyn_rel ASSIGNING FIELD-SYMBOL(<fs_crit_rel_pare>) WITH KEY z_child = l_crit_punt_pare.
      IF sy-subrc = 0.
        READ TABLE im_crit_punt ASSIGNING FIELD-SYMBOL(<fs_crit_total>) WITH KEY z_codi_crit_punt = <fs_crit_rel_pare>-z_parent.
        IF sy-subrc = 0.
          LOOP AT lt_num_ofertes ASSIGNING FIELD-SYMBOL(<fs_punts>).
            CLEAR: lv_suma_crit_max.
            CALL METHOD summatory_curr_dyn
              EXPORTING
                im_sum_info  = <fs_crit_total>-sum_info
                im_crit_punt = im_crit_punt
                im_num_gen   = CONV #( <fs_punts>-z_num_gen )
                im_punt_gen  = ch_punt_gen
              CHANGING
                ch_sum       = lv_suma_crit_max.
            READ TABLE ch_punt_gen ASSIGNING FIELD-SYMBOL(<fs_punt_ofer_pdm_tot>) WITH KEY z_num_gen        = <fs_punts>-z_num_gen
                                                                                           z_codi_crit_punt = <fs_crit_total>-z_codi_crit_punt.
            IF sy-subrc = 0.
              <fs_punt_ofer_pdm_tot>-z_punts = lv_suma_crit_max.
              ex_changed = abap_on.
            ENDIF.
          ENDLOOP.
        ENDIF.
        ">>>SPEC-55448, Inici modificació  - ETODR
        "Hem d'acumular el criteri actual on hem acumulat al seus possibles pares
        lv_actual_parent = <fs_crit_rel_pare>-z_parent.
        WHILE lv_actual_parent IS NOT INITIAL.
          LOOP AT gt_crit_dyn_rel ASSIGNING <fs_crit_rel_pare> WHERE z_child = lv_actual_parent.
            lv_actual_parent = <fs_crit_rel_pare>-z_parent.
            READ TABLE im_crit_punt ASSIGNING <fs_crit_total> WITH KEY z_codi_crit_punt = <fs_crit_rel_pare>-z_parent.
            IF sy-subrc = 0.
              LOOP AT lt_num_ofertes ASSIGNING <fs_punts>.
                CLEAR: lv_suma_crit_max.
                CALL METHOD summatory_curr_dyn
                  EXPORTING
                    im_sum_info  = <fs_crit_total>-sum_info
                    im_crit_punt = im_crit_punt
                    im_num_gen   = CONV #( <fs_punts>-z_num_gen )
                    im_punt_gen  = ch_punt_gen
                  CHANGING
                    ch_sum       = lv_suma_crit_max.
                READ TABLE ch_punt_gen ASSIGNING FIELD-SYMBOL(<fs_punt_ofer_totals>) WITH KEY z_num_gen        = <fs_punts>-z_num_gen
                                                                                              z_codi_crit_punt = <fs_crit_total>-z_codi_crit_punt.
                IF sy-subrc = 0.
                  <fs_punt_ofer_totals>-z_punts = lv_suma_crit_max.
                  ex_changed = abap_on.
                ENDIF.
              ENDLOOP.
            ENDIF.
          ENDLOOP.
          IF sy-subrc <> 0.
            CLEAR: lv_actual_parent.
          ENDIF.
        ENDWHILE.
        "<<<SPEC-55448, Final modificació - <usuari>
      ENDIF.
      CLEAR: lv_suma_crit_puntuats.
    ENDLOOP.
  ENDMETHOD.


  METHOD recalculate_crit_pdm_coaut_sep.
    TYPES: BEGIN OF ty_s_suma_pdm,
             z_comptador_equip         TYPE z_compta_equip,
             z_carrec_equip            TYPE z_carrec_equip,
             z_punts_abans_formula_pdm TYPE z_punts,
             z_formula_pdm             TYPE decfloat34,
             z_total_pdm               TYPE z_punts,
             z_dedicacio_ofertada      TYPE z_dedicacio_ofertada,
             z_total_carrec            TYPE z_punts,
           END OF ty_s_suma_pdm,
           ty_t_suma_pdm TYPE STANDARD TABLE OF ty_s_suma_pdm.

    DATA: lt_calcul_pdm           TYPE ty_t_suma_pdm,
          lt_calcul_pdm_carrecs   TYPE ty_t_suma_pdm,
          wa_calcul_pdm           TYPE ty_s_suma_pdm,
          lv_suma_crit_puntuats   TYPE decfloat34, "z_punts,
          lv_suma_dedic_ofert     TYPE decfloat34, "z_punts,
          lv_suma_crit_max        TYPE z_punts,
          lv_puntuacio_pdm        TYPE char10,
          lv_resultat_formula_pdm TYPE decfloat34,
          lv_total_pdm            TYPE decfloat34,
          lv_punts_recalculats    TYPE z_punts,
          lv_actual_parent        TYPE z_codi_crit_punt.

    get_calcul_pdm_coautors_sep( IMPORTING et_dades_pdm_coautors = DATA(lt_dades_pdm_coautors) ).

    DATA(lt_crit_punt) = im_crit_punt.
    READ TABLE gt_equip TRANSPORTING NO FIELDS WITH KEY z_equip_pdm = abap_on.
    CHECK sy-subrc = 0.

    DATA(lt_num_equips) = gt_equip[].
    SORT lt_num_equips BY z_num_ofer z_comptador_equip.
    DELETE ADJACENT DUPLICATES FROM lt_num_equips COMPARING z_num_ofer z_comptador_equip.
    DESCRIBE TABLE lt_num_equips LINES DATA(lv_num_equips).

    get_punts_gen_equi( IMPORTING et_punts_gen_equi = DATA(lt_punt_gen) ).

    DATA(lt_num_ofertes) = ch_punt_gen[].
    DELETE ADJACENT DUPLICATES FROM lt_num_ofertes COMPARING z_num_gen.
    DESCRIBE TABLE lt_num_ofertes LINES DATA(l_num_ofertes).

    "Primer actualitzem les puntuacions
    LOOP AT lt_num_ofertes ASSIGNING FIELD-SYMBOL(<fs_oferta>).
      DATA(lv_index_oferta_aux) = CONV z_num_ofer( <fs_oferta>-z_num_gen ).
      LOOP AT lt_punt_gen ASSIGNING FIELD-SYMBOL(<fs_punt_gen>) WHERE z_num_gen      = lv_index_oferta_aux.
        IF <fs_punt_gen>-z_num_equip IS NOT INITIAL. "66771
          LOOP AT ch_punt_gen ASSIGNING FIELD-SYMBOL(<fs_punts_aux>) WHERE z_num_gen        = <fs_punt_gen>-z_num_gen
*                                                                       AND z_carrec_equip   = <fs_punt_gen>-z_carrec_equip
                                                                       AND z_codi_crit_punt = <fs_punt_gen>-z_codi_crit_punt.
*                                                                       AND z_num_equip      = <fs_punt_gen>-z_num_equip.
            <fs_punts_aux>-z_punts          = <fs_punt_gen>-z_punts.
            <fs_punts_aux>-z_punts_no_pond  = <fs_punt_gen>-z_punts.
            ex_changed                      = abap_on.
          ENDLOOP.
        ENDIF.
      ENDLOOP.
    ENDLOOP.

    "Recuperem la fórmula del PDM del Plec
    LOOP AT lt_crit_punt ASSIGNING FIELD-SYMBOL(<fs_crit_punt>) WHERE z_equip_pdm EQ abap_on
                                                                  AND z_sumatori IS NOT INITIAL.
      DATA(lv_formula_pdm)   = <fs_crit_punt>-z_formula_pdm.
      DATA(lt_sum_info)      = <fs_crit_punt>-sum_info.
      DATA(lv_crit_punt_pare) = <fs_crit_punt>-z_codi_crit_punt.

      LOOP AT lt_num_ofertes ASSIGNING FIELD-SYMBOL(<fs_loop_oferta>).
        "Per cada criteri de cada oferta diferent de cada equip de GT_EQUIPS amb la marca de EQUIP_PDM = , s'omple la taula LT_CALCUL_PDM
        DATA(lv_index_oferta) = CONV z_num_ofer( <fs_loop_oferta>-z_num_gen ).
        CLEAR: lv_suma_dedic_ofert, lv_suma_crit_puntuats.
        LOOP AT lt_dades_pdm_coautors ASSIGNING FIELD-SYMBOL(<fs_dades_pdm>) WHERE z_num_ofer       = lv_index_oferta
                                                                               AND z_codi_crit_punt = lv_crit_punt_pare.
          "Acomulem fórmula per aplicar a total
          lv_suma_crit_puntuats = lv_suma_crit_puntuats + <fs_dades_pdm>-z_total_carrec.
        ENDLOOP.

        LOOP AT ch_punt_gen ASSIGNING FIELD-SYMBOL(<fs_punts2>) WHERE z_num_gen        = lv_index_oferta
                                                                  AND z_codi_crit_punt = lv_crit_punt_pare.
          <fs_punts2>-z_punts = lv_suma_crit_puntuats.
        ENDLOOP.

*       "Criteri pare del PDM
        READ TABLE gt_crit_dyn_rel ASSIGNING FIELD-SYMBOL(<fs_crit_rel_pare>) WITH KEY z_child = lv_crit_punt_pare.
        IF sy-subrc = 0.
          READ TABLE im_crit_punt ASSIGNING FIELD-SYMBOL(<fs_crit_total>) WITH KEY z_codi_crit_punt = <fs_crit_rel_pare>-z_parent.
          IF sy-subrc = 0.
            LOOP AT lt_num_ofertes ASSIGNING FIELD-SYMBOL(<fs_punts>).
              CLEAR: lv_suma_crit_max.
              CALL METHOD summatory_curr_dyn
                EXPORTING
                  im_sum_info  = <fs_crit_total>-sum_info
                  im_crit_punt = im_crit_punt
                  im_num_gen   = CONV #( <fs_punts>-z_num_gen )
                  im_punt_gen  = ch_punt_gen
                CHANGING
                  ch_sum       = lv_suma_crit_max.
              READ TABLE ch_punt_gen ASSIGNING FIELD-SYMBOL(<fs_punt_ofer_pdm_tot>) WITH KEY z_num_gen        = <fs_punts>-z_num_gen
                                                                                             z_codi_crit_punt = <fs_crit_total>-z_codi_crit_punt.
              IF sy-subrc = 0.
                <fs_punt_ofer_pdm_tot>-z_punts = lv_suma_crit_max.
                ex_changed = abap_on.
              ENDIF.
            ENDLOOP.
          ENDIF.
          "Hem d'acumular el criteri actual on hem acumulat al seus possibles pares
          lv_actual_parent = <fs_crit_rel_pare>-z_parent.
          WHILE lv_actual_parent IS NOT INITIAL.
            LOOP AT gt_crit_dyn_rel ASSIGNING <fs_crit_rel_pare> WHERE z_child = lv_actual_parent.
              lv_actual_parent = <fs_crit_rel_pare>-z_parent.
              READ TABLE im_crit_punt ASSIGNING <fs_crit_total> WITH KEY z_codi_crit_punt = <fs_crit_rel_pare>-z_parent.
              IF sy-subrc = 0.
                LOOP AT lt_num_ofertes ASSIGNING <fs_punts>.
                  CLEAR: lv_suma_crit_max.
                  CALL METHOD summatory_curr_dyn
                    EXPORTING
                      im_sum_info  = <fs_crit_total>-sum_info
                      im_crit_punt = im_crit_punt
                      im_num_gen   = CONV #( <fs_punts>-z_num_gen )
                      im_punt_gen  = ch_punt_gen
                    CHANGING
                      ch_sum       = lv_suma_crit_max.
                  READ TABLE ch_punt_gen ASSIGNING FIELD-SYMBOL(<fs_punt_ofer_totals>) WITH KEY z_num_gen        = <fs_punts>-z_num_gen
                                                                                                z_codi_crit_punt = <fs_crit_total>-z_codi_crit_punt.
                  IF sy-subrc = 0.
                    <fs_punt_ofer_totals>-z_punts = lv_suma_crit_max.
                    ex_changed = abap_on.
                  ENDIF.
                ENDLOOP.
              ENDIF.
            ENDLOOP.
            IF sy-subrc <> 0.
              CLEAR: lv_actual_parent.
            ENDIF.
          ENDWHILE.
        ENDIF.
        CLEAR: lv_suma_crit_puntuats.
      ENDLOOP.
    ENDLOOP.
  ENDMETHOD.


  METHOD recalculate_final_dyn.
    DATA: lv_suma_crit_max TYPE z_punts.
    DATA(lt_num_ofertes) = ch_punt_gen[].
    DELETE ADJACENT DUPLICATES FROM lt_num_ofertes COMPARING z_num_gen.
    DESCRIBE TABLE lt_num_ofertes LINES DATA(l_num_ofertes).

    LOOP AT im_crit_punt ASSIGNING FIELD-SYMBOL(<fs_crit_punt_econ>) WHERE z_crit_ve EQ co_crit_economic.
      DATA(ls_crit_punt_econ) = <fs_crit_punt_econ>.
      EXIT.
    ENDLOOP.
    IF ls_crit_punt_econ IS NOT INITIAL.
      "Criteri pare de l'econòmic
      READ TABLE gt_crit_dyn_rel ASSIGNING FIELD-SYMBOL(<fs_crit_rel_pare>) WITH KEY z_child = ls_crit_punt_econ-z_codi_crit_punt.
      IF sy-subrc = 0.
        READ TABLE im_crit_punt ASSIGNING FIELD-SYMBOL(<fs_crit_total_econ>) WITH KEY z_codi_crit_punt = <fs_crit_rel_pare>-z_parent.
        IF sy-subrc = 0.
          LOOP AT lt_num_ofertes ASSIGNING FIELD-SYMBOL(<fs_punts>).
            CLEAR: lv_suma_crit_max.
            CALL METHOD summatory_curr_dyn
              EXPORTING
                im_sum_info  = <fs_crit_total_econ>-sum_info
                im_crit_punt = im_crit_punt
                im_num_gen   = CONV #( <fs_punts>-z_num_gen )
                im_punt_gen  = ch_punt_gen
              CHANGING
                ch_sum       = lv_suma_crit_max.
            READ TABLE ch_punt_gen ASSIGNING FIELD-SYMBOL(<fs_punt_ofer_econ_tot>) WITH KEY z_num_gen        = <fs_punts>-z_num_gen
                                                                                            z_codi_crit_punt = <fs_crit_total_econ>-z_codi_crit_punt.
            IF sy-subrc = 0.
              <fs_punt_ofer_econ_tot>-z_punts = lv_suma_crit_max.
              ex_changed = abap_on.
            ENDIF.
          ENDLOOP.
        ENDIF.
      ENDIF.
    ENDIF.

    LOOP AT im_crit_punt ASSIGNING FIELD-SYMBOL(<fs_crit_punt_total>) WHERE z_codi_crit_punt EQ co_codi_crit_total.
      DATA(ls_crit_punt_total) = <fs_crit_punt_total>.
      EXIT.
    ENDLOOP.
    IF ls_crit_punt_total IS NOT INITIAL.
      "Criteri total
      READ TABLE im_crit_punt ASSIGNING FIELD-SYMBOL(<fs_crit_total>) WITH KEY z_codi_crit_punt = ls_crit_punt_total-z_codi_crit_punt.
      IF sy-subrc = 0.
        LOOP AT lt_num_ofertes ASSIGNING <fs_punts>.
          CLEAR: lv_suma_crit_max.
          CALL METHOD summatory
            EXPORTING
              im_sum_info  = <fs_crit_total>-sum_info
              im_crit_punt = im_crit_punt
              im_num_gen   = CONV #( <fs_punts>-z_num_gen )
              im_punt_gen  = ch_punt_gen
            CHANGING
              ch_sum       = lv_suma_crit_max.
          READ TABLE ch_punt_gen ASSIGNING FIELD-SYMBOL(<fs_punt_ofer_total>) WITH KEY z_num_gen        = <fs_punts>-z_num_gen
                                                                                       z_codi_crit_punt = <fs_crit_total>-z_codi_crit_punt.
          IF sy-subrc = 0.
            <fs_punt_ofer_total>-z_punts = lv_suma_crit_max.
            ex_changed = abap_on.
          ENDIF.
        ENDLOOP.
      ENDIF.
    ENDIF.
  ENDMETHOD.


  METHOD recalculate_harmonitzat.


    DATA : ls_crit_punt_har    TYPE ty_s_crit_punt,
           lv_suma             TYPE z_punts,
           lv_harm             TYPE dec_16_11_s,
           lv_niv              TYPE c,
           lt_zrm_dt_punt_ofer TYPE TABLE OF zrm_dt_punt_ofer,
           ls_zrm_dt_punt_ofer TYPE zrm_dt_punt_ofer,
           ls_im_crit_punt     TYPE ty_s_crit_punt,
           lv_suma_harm        TYPE z_punts,
           ls_proveidors       TYPE ty_s_punt_gen,
           ls_punt_gen         TYPE ty_s_punt_gen,
           ls_crit_punt        TYPE ty_s_crit_punt.

    CLEAR : lv_suma_harm, lv_harm, lv_niv.

    READ TABLE im_crit_punt INTO ls_crit_punt_har WITH KEY z_total_harmonitzat = abap_on.

    IF sy-subrc = 0.

      lv_suma = 100.

  SELECT *
       INTO TABLE lt_zrm_dt_punt_ofer
       FROM zrm_dt_punt_ofer
       WHERE objectid = my_objectid
       AND docclass = my_docclass.


      IF sy-subrc = 0.

        LOOP AT im_crit_punt INTO ls_im_crit_punt WHERE z_sumatori = ''.

          READ TABLE lt_zrm_dt_punt_ofer INTO ls_zrm_dt_punt_ofer WITH KEY z_no_aplica = abap_on  z_codi_crit_punt = ls_im_crit_punt-z_codi_crit_punt.

          IF sy-subrc = 0.

            lv_suma = lv_suma - ls_im_crit_punt-z_punt_max.

          ENDIF.

        ENDLOOP.

        IF lv_suma <> 0.

          lv_harm = 100 / lv_suma.

          lv_niv = ls_crit_punt_har-z_nivell_criteri + 1.

          CLEAR ls_crit_punt.

          LOOP AT im_proveidors INTO ls_proveidors.

            LOOP AT im_crit_punt INTO ls_crit_punt.

              LOOP AT ch_punt_gen INTO ls_punt_gen.

                IF ls_crit_punt-z_nivell_criteri = lv_niv AND ls_punt_gen-z_num_gen = ls_proveidors-z_num_gen AND ls_crit_punt-z_codi_crit_punt = ls_punt_gen-z_codi_crit_punt.

                  lv_suma_harm = lv_suma_harm + ls_punt_gen-z_punts.

                ENDIF.

              ENDLOOP.

            ENDLOOP.


            READ TABLE ch_punt_gen ASSIGNING FIELD-SYMBOL(<fs_punt_gen2>) WITH KEY z_codi_crit_punt = ls_crit_punt_har-z_codi_crit_punt
                                                                                   z_num_gen = ls_proveidors-z_num_gen.

            IF sy-subrc = 0.

              IF lv_suma_harm IS NOT INITIAL AND lv_harm  IS NOT INITIAL.

                <fs_punt_gen2>-z_punts = lv_suma_harm * lv_harm.

              ENDIF.

            ENDIF.

            CLEAR lv_suma_harm.

          ENDLOOP.

        ENDIF.

      ENDIF.

    ENDIF.


  ENDMETHOD.


METHOD recalculate_lemes.
  DATA: l_changed TYPE xfeld .

  IF my_locked IS INITIAL .
    RAISE EXCEPTION TYPE zcx_rm_valoracio
      EXPORTING textid = zcx_rm_valoracio=>not_opened_for_update .
  ENDIF .

*ATENCIÓ: S'ha de tenir cura de cridar aquest mètode només quan cal:
* A) Quan s'inicia la puntució, si es legítim (re)iniciar la valoració de lemes
* B) Quan es confirma la puntuació de lemes
* C) Quan s'anul·la la confirmació
  CALL METHOD me->recalculate_val_tecnic
    EXPORTING
      im_crit_punt = my_crit_punt_prop_graf
    IMPORTING
      ex_changed   = l_changed
    CHANGING
      ch_punt_gen  = my_punt_lema.
  IF l_changed IS NOT INITIAL .
    my_changed = 'X' .
  ENDIF .
  ex_changed = l_changed .
ENDMETHOD.


METHOD recalculate_mult_rec.

  "Actualizamos la tabla my_punt_ofer con las puntuacines actualizadas en el caso que se hayan quitado o agregado recursos
  "desde seleccionar de nou, solo registros que sean z_mult_rec eq 'X'
  LOOP AT my_crit_punt ASSIGNING FIELD-SYMBOL(<crit_punt>) WHERE z_mult_rec EQ abap_true.
    LOOP AT dades_ofer_dyn ASSIGNING FIELD-SYMBOL(<dades_ofer_dyn>) WHERE z_mod_crit_punt EQ <crit_punt>-z_mod_crit_punt
                                                                      AND z_codi_crit_punt EQ <crit_punt>-z_codi_crit_punt.

      READ TABLE my_punt_ofer ASSIGNING FIELD-SYMBOL(<punt_ofer>) WITH KEY z_num_gen = <dades_ofer_dyn>-z_num_ofer
                                                                           z_mod_crit_punt = <dades_ofer_dyn>-z_mod_crit_punt
                                                                           z_codi_crit_punt = <dades_ofer_dyn>-z_codi_crit_punt.
      IF sy-subrc EQ 0.
        <punt_ofer>-z_punts = <dades_ofer_dyn>-z_punts.
      ENDIF.
    ENDLOOP.
  ENDLOOP.

ENDMETHOD.


METHOD recalculate_offer.
  DATA: l_changed TYPE xfeld .

  IF my_locked IS INITIAL .
    RAISE EXCEPTION TYPE zcx_rm_valoracio
      EXPORTING
        textid = zcx_rm_valoracio=>not_opened_for_update.
  ENDIF .

*ATENCIÓ: S'ha de tenir cura de cridar aquest mètode només quan cal:
* A) Quan s'inicia la puntuació, si es legítim (re)iniciar la valoració d'ofertes
* B) Quan es confirma la puntuació d'ofertes
* C) Quan s'anul·la la confirmació
  CALL METHOD me->recalculate_val_term
    EXPORTING
      im_crit_punt = my_crit_punt
    IMPORTING
      ex_changed   = l_changed
    CHANGING
      ch_punt_gen  = my_punt_ofer.
  IF l_changed IS NOT INITIAL .
    my_changed = 'X' .
  ENDIF .

**>>INI OVB SPEC-37724 - Detectem les ofertes que no arriben a la P.Tec mínima
  CALL METHOD me->recalculate_val_tecnic2
    EXPORTING
      im_crit_punt = my_crit_punt
    IMPORTING
      ex_changed   = l_changed
    CHANGING
      ch_punt_gen  = my_punt_ofer.
  IF l_changed IS NOT INITIAL .
    my_changed = 'X' .
  ENDIF .
**>>FIN OVB
**  >> INI MODIF SPEC-48767
*    CALL METHOD me->recalculate_val_econ
*      EXPORTING
*        im_crit_punt = my_crit_punt
*      IMPORTING
*        ex_changed   = l_changed
*      CHANGING
*        ch_punt_gen  = my_punt_ofer.
  CALL METHOD me->recalculate_val_econ_n
    EXPORTING
      im_crit_punt = my_crit_punt
    IMPORTING
      ex_changed   = l_changed
    CHANGING
      ch_punt_gen  = my_punt_ofer.
**  << FI MODIF SPEC-48767
  IF l_changed IS NOT INITIAL .
    my_changed = 'X' .
  ENDIF .

  CALL METHOD me->recalculate_val_tecnic
    EXPORTING
      im_crit_punt = my_crit_punt
    IMPORTING
      ex_changed   = l_changed
    CHANGING
      ch_punt_gen  = my_punt_ofer.
  IF l_changed IS NOT INITIAL .
    my_changed = 'X' .
  ENDIF .

**>> INI MODIF ETODR SPEC-45341
  IF get_my_crit_dyn( ) = abap_on.
    recalculate_crit_dyn( EXPORTING im_crit_punt      = my_crit_punt
                          IMPORTING ex_changed        = l_changed
                          CHANGING  ch_punt_gen       = my_punt_ofer ).
    IF l_changed IS NOT INITIAL .
      my_changed = 'X' .
    ENDIF .
  ENDIF.
**<< FI MODIF ETODR SPEC-45341

  ex_changed = l_changed .
ENDMETHOD.


METHOD recalculate_omin.
  FIELD-SYMBOLS: <ls_ofertax>  TYPE ty_s_ofertax.
*Pasem filtres a les posicions de la taula interna. Si cumpleix algun filtre descartem la posició.
  LOOP AT ch_ofertesx ASSIGNING <ls_ofertax>." WHERE exclos = abap_false. OVB SPEC-37724
    ">> SPEC-72969, Inici Modificació - ETODR
    zcl_util_licitacio=>get_import_oferta_tipol_all( EXPORTING iv_docclass  = im_exp_cont-docclass
                                                               iv_objectid  = im_exp_cont-objectid
                                                               iv_num_ofer  = <ls_ofertax>-z_num_ofer
                                                     IMPORTING es_imports   = <ls_ofertax>-tip_econ_ofer ).
    "<< SPEC-72969, Final Modificació - ETODR
**   >> INI MODIF ETODR SPEC-52334
    IF get_is_nova_llei_92017( ) = abap_on AND get_is_obert_preu( ) = abap_off.
      IF    <ls_ofertax>-z_exclos_s1         IS NOT INITIAL
         OR <ls_ofertax>-z_exclos_s2         IS NOT INITIAL
         OR <ls_ofertax>-z_exclos_s3         IS NOT INITIAL
         OR <ls_ofertax>-z_exclos_punt_capob IS NOT INITIAL "PSPEC-1451 - EVMRG
         OR <ls_ofertax>-z_excl_homog        IS NOT INITIAL
         OR <ls_ofertax>-z_exclos_var_tec    IS NOT INITIAL
         OR <ls_ofertax>-z_excl_punt_tec     IS NOT INITIAL
         OR <ls_ofertax>-exclos              IS NOT INITIAL.
        CONTINUE.
*      ENDIF."SPEC-57225
        ">>>SPEC-57225, Inici modificació  - ETODR
      ELSE.
        IF ch_importmin IS INITIAL.
          ch_importmin = <ls_ofertax>-z_imp_oferta_b.
        ELSE.
          IF <ls_ofertax>-z_imp_oferta_b LT ch_importmin.
            ch_importmin = <ls_ofertax>-z_imp_oferta_b.
          ELSE.
          ENDIF.
          ">> SPEC-83700, Inici Modificació - EVODR
*          ">> SPEC-72969, Inici Modificació - ETODR
*          IF ch_importmin_var IS INITIAL.
*            ch_importmin_var = <ls_ofertax>-tip_econ_ofer-import_var.
*          ELSE.
*            IF <ls_ofertax>-tip_econ_ofer-import_var LT ch_importmin_var.
*              ch_importmin_var = <ls_ofertax>-tip_econ_ofer-import_var.
*            ENDIF.
*          ENDIF.
*          "<< SPEC-72969, Final Modificació - ETODR
          "<< SPEC-83700, Final Modificació - EVODR
        ENDIF.
        ">> SPEC-83700, Inici Modificació - EVODR
        IF ch_importmin_var IS INITIAL.
          ch_importmin_var = <ls_ofertax>-tip_econ_ofer-import_var.
        ELSE.
          IF <ls_ofertax>-tip_econ_ofer-import_var LT ch_importmin_var.
            ch_importmin_var = <ls_ofertax>-tip_econ_ofer-import_var.
          ENDIF.
        ENDIF.
        "<< SPEC-83700, Final Modificació - EVODR
      ENDIF.
      "<<<SPEC-57225, Final modificació - ETODR
    ELSE.
**   << FI MODIF ETODR SPEC-52334
      IF    <ls_ofertax>-z_exclos_s1         IS NOT INITIAL
         OR <ls_ofertax>-z_exclos_s2         IS NOT INITIAL
         OR <ls_ofertax>-z_exclos_s3         IS NOT INITIAL
         OR <ls_ofertax>-z_exclos_punt_capob IS NOT INITIAL "PSPEC-1451 - EVMRG
         OR <ls_ofertax>-z_excl_homog        IS NOT INITIAL
         OR <ls_ofertax>-z_exclos_var_tec    IS NOT INITIAL
         OR <ls_ofertax>-z_excl_punt_tec     IS NOT INITIAL
         OR <ls_ofertax>-exclos              IS NOT INITIAL
         OR <ls_ofertax>-z_temerari          IS NOT INITIAL
         OR ( <ls_ofertax>-z_pres_proposta   IS INITIAL
                  AND my_exp_cont-z_proc_adj = co_adj_cr ).

        CONTINUE.
      ELSE.
*si la posició passa els filtres, mirem si és de menor import al que hi hagi en aquell moment.
        IF ch_importmin IS INITIAL.
          ch_importmin = <ls_ofertax>-z_imp_oferta_b.
        ELSE.
          IF <ls_ofertax>-z_imp_oferta_b LT ch_importmin.
            ch_importmin = <ls_ofertax>-z_imp_oferta_b.
          ELSE.
          ENDIF.
        ENDIF.
        ">> SPEC-72969, Inici Modificació - ETODR
        IF ch_importmin_var IS INITIAL.
          ch_importmin_var = <ls_ofertax>-tip_econ_ofer-import_var.
        ELSE.
          IF <ls_ofertax>-tip_econ_ofer-import_var LT ch_importmin_var.
            ch_importmin_var = <ls_ofertax>-tip_econ_ofer-import_var.
          ENDIF.
        ENDIF.
        "<< SPEC-72969, Final Modificació - ETODR
      ENDIF.
    ENDIF.
  ENDLOOP.

  IF ch_ofertesx[] IS INITIAL .
    RAISE EXCEPTION TYPE zcx_rm_valoracio
      EXPORTING
        textid = zcx_rm_valoracio=>no_offers.
  ENDIF.

ENDMETHOD.


  METHOD recalculate_punt_pdm_coaut_sim.
    DATA: lr_valoracio_ofertes TYPE REF TO zrm_cl_valoracio_ofertes.

    FIELD-SYMBOLS: <lt_ofertesx>  TYPE ty_t_ofertax,
                   <lt_punt_ofer> TYPE ty_t_punt_gen,
                   <ls_ofertax>   TYPE ty_s_ofertax.

    SELECT SINGLE z_num_plec FROM zrm_dt_exp_cont INTO @DATA(lv_plec_bases) WHERE docclass EQ @im_docclass
                                                                              AND objectid EQ @im_objectid.

    SELECT SINGLE z_mod_crit_punt FROM zrm_dm_plecs INTO @DATA(lv_mod_crit_punt) WHERE z_num_plec = @lv_plec_bases.
    SELECT * FROM zrm_dm_crit_punt INTO TABLE @DATA(lt_crit_punt) WHERE z_mod_crit_punt = @lv_mod_crit_punt.
    SELECT SINGLE z_cri_din FROM zrm_dm_mod_crit INTO @DATA(lv_dyn) WHERE z_mod_crit_punt = @lv_mod_crit_punt.


    CREATE OBJECT lr_valoracio_ofertes
      EXPORTING
        im_docclass = im_docclass
        im_objectid = im_objectid
        im_action   = co_mode_punt_quadre4b_sim
        is_dynamic  = lv_dyn.

    lr_valoracio_ofertes->start( IMPORTING ex_first_time = DATA(l_first_time) ) .
    TRY.
        ">> SPEC-66771, Inici Modificació - ETODR
        READ TABLE lt_crit_punt TRANSPORTING NO FIELDS WITH KEY z_equip_pdm     = abap_on
                                                                z_equip_coautor = abap_on
                                                                z_equip_sep     = abap_on.
        IF sy-subrc = 0.
          lr_valoracio_ofertes->get_calcul_pdm_coautors_sep( IMPORTING et_dades_pdm_coautors = et_dades_pdm_coautors ).
        ELSE.
          "<< SPEC-66771, Final Modificació - ETODR
          lr_valoracio_ofertes->get_calcul_pdm_coautors( IMPORTING et_dades_pdm_coautors = et_dades_pdm_coautors ).
        ENDIF.
**      >> SPEC-51885
        lr_valoracio_ofertes->get_crit_dyn_rel( IMPORTING ex_crit_dyn_rel = et_crit_relations
                                                          ex_crit_punt    = et_crit_punt ).
**      << SPEC-51885
      CATCH zcx_rm_valoracio .
        RAISE EXCEPTION TYPE zcx_rm_valoracio .
    ENDTRY.
  ENDMETHOD.


  METHOD recalculate_punt_tot_sim.
    DATA: lr_valoracio_ofertes TYPE REF TO zrm_cl_valoracio_ofertes.

    FIELD-SYMBOLS: <lt_ofertesx>  TYPE ty_t_ofertax,
                   <lt_punt_ofer> TYPE ty_t_punt_gen,
                   <ls_ofertax>   TYPE ty_s_ofertax.

    SELECT SINGLE z_num_plec FROM zrm_dt_exp_cont INTO @DATA(lv_plec_bases) WHERE docclass EQ @im_docclass
                                                                              AND objectid EQ @im_objectid.

    SELECT SINGLE z_mod_crit_punt FROM zrm_dm_plecs INTO @DATA(lv_mod_crit_punt) WHERE z_num_plec = @lv_plec_bases.
    SELECT * FROM zrm_dm_crit_punt INTO TABLE @DATA(lt_crit_punt) WHERE z_mod_crit_punt = @lv_mod_crit_punt.
    SELECT SINGLE z_cri_din FROM zrm_dm_mod_crit INTO @DATA(lv_dyn) WHERE z_mod_crit_punt = @lv_mod_crit_punt.


    CREATE OBJECT lr_valoracio_ofertes
      EXPORTING
        im_docclass = im_docclass
        im_objectid = im_objectid
        im_action   = co_mode_punt_quadre4b_sim
        is_dynamic  = lv_dyn.

    lr_valoracio_ofertes->start( IMPORTING ex_first_time = DATA(l_first_time) ) .
    TRY.
        lr_valoracio_ofertes->sim_recalc_val_econ( IMPORTING ex_punt_ofer = ex_punt_gen ).

      CATCH zcx_rm_valoracio .
        RAISE EXCEPTION TYPE zcx_rm_valoracio .
    ENDTRY.

  ENDMETHOD.


  METHOD recalculate_si_factor_mult.
    DATA: lv_suma_crit_puntuats  TYPE z_punts,
          lv_valor_factor_mult   TYPE z_punts,
          lv_resultat_formula_fm TYPE decfloat34.

    e_recalculated         = abap_off.
    LOOP AT im_crit_punt ASSIGNING FIELD-SYMBOL(<fs_crit_punt>) WHERE z_crit_depenent = im_crit_no_aplica-z_codi_crit_punt
                                                                  AND z_factor_multip IS NOT INITIAL.
      "A partir del criteri relacionat al criteri que no aplica, es comprova si té factor multiplicador informat. En cas contrari RAISE.
      READ TABLE ch_punt_gen ASSIGNING FIELD-SYMBOL(<fs_punt_oferta_fact_mult>) WITH KEY z_num_gen        = im_num_gen
                                                                                         z_codi_crit_punt = <fs_crit_punt>-z_codi_crit_punt.
      "Es busca la puntuació del criteri al qual aplicar el factor de multiplicació
      CHECK sy-subrc = 0.
**    >> INI MODIF ETODR SPEC-50770
      DATA(lv_formula_factor_mult_tmp) = <fs_crit_punt>-z_factor_multip.
      CLEAR: lv_resultat_formula_fm.
      CALL FUNCTION 'EVAL_FORMULA'
        EXPORTING
          formula = lv_formula_factor_mult_tmp
          program = sy-repid
        IMPORTING
          value   = lv_resultat_formula_fm
        EXCEPTIONS
          OTHERS  = 11.
      CHECK sy-subrc = 0.
      lv_valor_factor_mult = <fs_punt_oferta_fact_mult>-z_punts_no_pond * lv_resultat_formula_fm.
*      lv_valor_factor_mult = <fs_punt_oferta_fact_mult>-z_punts_no_pond * <fs_crit_punt>-z_factor_multip.
**    << INI MODIF ETODR SPEC-50770
      "Es busca el criteri pare on es sumen i s'acomula directament
      READ TABLE im_crit_rel ASSIGNING FIELD-SYMBOL(<fs_crit_rel>) WITH KEY z_child = <fs_crit_punt>-z_codi_crit_punt.
      CHECK sy-subrc = 0.
      READ TABLE im_crit_punt ASSIGNING FIELD-SYMBOL(<fs_crit_punt_pare>) WITH KEY z_codi_crit_punt = <fs_crit_rel>-z_parent.
      CHECK sy-subrc = 0.

      READ TABLE ch_punt_gen ASSIGNING FIELD-SYMBOL(<fs_punt_oferta_recalc>) WITH KEY z_num_gen        = im_num_gen
                                                                                      z_codi_crit_punt = <fs_crit_punt_pare>-z_codi_crit_punt.
      CHECK sy-subrc = 0.
      <fs_punt_oferta_fact_mult>-z_punts = lv_valor_factor_mult."lv_suma_crit_puntuats * <fs_crit_punt>-z_factor_multip.
      e_recalculated = abap_on.

      CLEAR: lv_suma_crit_puntuats.
      "Ara recalculem el criteri pare que l'engloba
      CALL METHOD summatory_curr_dyn
        EXPORTING
          im_sum_info  = <fs_crit_punt_pare>-sum_info
          im_crit_punt = im_crit_punt
          im_num_gen   = im_num_gen
          im_punt_gen  = ch_punt_gen
        CHANGING
          ch_sum       = lv_suma_crit_puntuats.
      READ TABLE ch_punt_gen ASSIGNING FIELD-SYMBOL(<fs_punt_ofer_pare>) WITH KEY z_num_gen        = im_num_gen
                                                                                  z_codi_crit_punt = <fs_crit_punt_pare>-z_codi_crit_punt.
      IF sy-subrc = 0.
        <fs_punt_ofer_pare>-z_punts = lv_suma_crit_puntuats.
      ENDIF.
    ENDLOOP.

    IF sy-subrc <> 0 OR e_recalculated = abap_off.
      RAISE not_factor.
    ENDIF.
  ENDMETHOD.


  METHOD recalculate_si_no_aplica.
    DATA: lv_punt_max_pare               TYPE z_punts,
          wa_crit_rel                    TYPE zrm_cl_valoracio_ofertes_fe=>ty_s_crit_rel,
          lv_codi_crit_punt_recalcul     TYPE z_codi_crit_punt,
          lv_codi_crit_punt_recalcul_tot TYPE z_codi_crit_punt,
          lv_suma_crit_puntuats          TYPE z_punts,
          lv_total_rec                   TYPE z_punts,
          lv_punt_max_possibles          TYPE z_punts.

*>> INICI - SPEC-75738 - ECMRG

    recalculate_val_basat_marc( EXPORTING ch_crit_punt = ch_crit_punt
                                CHANGING ch_punt_gen = ch_punt_gen ).

*<< FI - SPEC-75738 - ECMRG

    LOOP AT ch_crit_punt ASSIGNING FIELD-SYMBOL(<fs_aux_1>).
      <fs_aux_1>-do_sum_dyn  = abap_off.
    ENDLOOP.

    IF gt_crit_dyn_rel IS INITIAL.
      LOOP AT ch_crit_punt ASSIGNING FIELD-SYMBOL(<fs_crit_punt>).
        CLEAR: wa_crit_rel.
        wa_crit_rel-z_mod_crit_punt = <fs_crit_punt>-z_mod_crit_punt.
        wa_crit_rel-z_parent        = <fs_crit_punt>-z_codi_crit_punt.
        IF <fs_crit_punt>-sum_info IS NOT INITIAL.
          LOOP AT <fs_crit_punt>-sum_info ASSIGNING FIELD-SYMBOL(<fs_2>).
            wa_crit_rel-z_child = <fs_2>-z_codi_crit_punt.
            CHECK wa_crit_rel-z_parent IS NOT INITIAL.
            APPEND wa_crit_rel TO gt_crit_dyn_rel.
          ENDLOOP.
        ENDIF.
      ENDLOOP.
    ENDIF.
    "Si criteri no aplica cal AJUSTAR TOTAL per cada ofertant
    " on TOTAL = SUMA punts aconseguits * MAX aconseguible / SUMA punts totals aconseguibles
    DATA(lt_punts_before) = ch_punt_gen[].

    "Proveïdors
    DATA(lt_proveidors) = ch_punt_gen[].
    DELETE ADJACENT DUPLICATES FROM lt_proveidors COMPARING z_num_gen.

    "Criteris puntuació
*    DATA(lt_crit_punt_aux) = ch_crit_punt[].
** >> INI MODIF ETODR SPEC-48660
    DATA: l_num_times_check_no_aplica TYPE i.
    DESCRIBE TABLE lt_proveidors LINES DATA(l_num_prov).
    "Quan només hi ha un proveïdor cal forçar que torni a passar pels criteris per tal de marcar els pares dels criteris que no apliquen com a DO_SUM_DYN = X i evitar així la suma directa
    IF l_num_prov = 1.
      l_num_times_check_no_aplica = l_num_prov + 1.
    ELSE.
      l_num_times_check_no_aplica = 1.
    ENDIF.
    DO l_num_times_check_no_aplica TIMES.
** << FI MODIF ETODR SPEC-48660
      LOOP AT lt_proveidors ASSIGNING FIELD-SYMBOL(<fs_prov>).
        CLEAR: lv_suma_crit_puntuats, lv_punt_max_pare, lv_total_rec, lv_punt_max_possibles.
        LOOP AT ch_crit_punt INTO DATA(ls_crit_punt)
          WHERE z_no_aplica = abap_on
            AND z_no_factor_mult  NE abap_true. " ETLJS SPEC-53559 14.05.2019 11:12:56
**        >> INI MODIF ETODR SPEC-49075
          recalculate_si_factor_mult( EXPORTING   im_crit_no_aplica = ls_crit_punt
                                                  im_crit_punt      = ch_crit_punt
                                                  im_crit_rel       = gt_crit_dyn_rel
                                                  im_num_gen        = <fs_prov>-z_num_gen
                                      IMPORTING   e_recalculated    = DATA(l_recalc_fact_mult)
                                                  ex_changed        = ex_changed
                                      CHANGING    ch_punt_gen       = ch_punt_gen
                                      EXCEPTIONS  not_factor        = 1
                                                  OTHERS            = 2 ).
          IF sy-subrc = 0 OR l_recalc_fact_mult IS NOT INITIAL. CONTINUE. ENDIF. "Si es retorna excepció és que s'ha de calcular ponderadament no amb factor multiplicador
**        << FI MODIF ETODR SPEC-49075
          "Es busca el criteri pare que engloba el criteri que no aplica
          LOOP AT ch_crit_punt ASSIGNING FIELD-SYMBOL(<fs_aux_crit_punt_pare>).
            READ TABLE <fs_aux_crit_punt_pare>-sum_info TRANSPORTING NO FIELDS WITH KEY z_codi_crit_punt = ls_crit_punt-z_codi_crit_punt.
            IF sy-subrc = 0.
              lv_codi_crit_punt_recalcul = <fs_aux_crit_punt_pare>-z_codi_crit_punt.
              <fs_aux_crit_punt_pare>-do_sum_dyn  = abap_on.
              EXIT.
            ENDIF.
          ENDLOOP.

          CHECK lv_codi_crit_punt_recalcul IS NOT INITIAL.

          "Amb el codi del criteri pare comprovem si aquest aplica o no en funció de si apliquen o no tots els seus fills
          READ TABLE ch_crit_punt ASSIGNING FIELD-SYMBOL(<fs_sum_info_pare>) WITH KEY z_codi_crit_punt = lv_codi_crit_punt_recalcul.
          CHECK sy-subrc = 0.
          DATA(lt_crit_rels) = <fs_sum_info_pare>-sum_info[].
*        DELETE lt_crit_rels WHERE z_codi_crit_punt <> ls_crit_punt-z_codi_crit_punt.
          DESCRIBE TABLE lt_crit_rels LINES DATA(l_lines).
          IF l_lines = 1.
*          LOOP AT lt_crit_punt_aux ASSIGNING FIELD-SYMBOL(<fs_parent_no_aplica>) WHERE z_codi_crit_punt = lv_codi_crit_punt_recalcul.
            LOOP AT ch_crit_punt ASSIGNING FIELD-SYMBOL(<fs_parent_no_aplica>) WHERE z_codi_crit_punt = lv_codi_crit_punt_recalcul.
              <fs_parent_no_aplica>-z_no_aplica = abap_on.
              <fs_parent_no_aplica>-do_sum_dyn  = abap_on.
            ENDLOOP.
            LOOP AT ch_crit_punt ASSIGNING FIELD-SYMBOL(<fs_aux_crit_punt>).
              READ TABLE <fs_aux_crit_punt>-sum_info ASSIGNING FIELD-SYMBOL(<fs_sum_info>) WITH KEY z_codi_crit_punt = lv_codi_crit_punt_recalcul.
              IF sy-subrc = 0.
                lv_codi_crit_punt_recalcul = <fs_aux_crit_punt>-z_codi_crit_punt.
                EXIT.
              ENDIF.
            ENDLOOP.
          ENDIF.

          READ TABLE ch_crit_punt ASSIGNING FIELD-SYMBOL(<fs_crit_punt_pare>) WITH KEY z_codi_crit_punt = lv_codi_crit_punt_recalcul.
          CHECK sy-subrc = 0.
          lv_punt_max_pare = <fs_crit_punt_pare>-z_punt_max.

          ">>>SPEC-56457, Inici modificació  - ETODR
          IF my_mode = co_mode_punt_quadre3b.
            ">>>SPEC-55448, Inici modificació  - ETJGG
            "Dels punts del pare hem de restar aquelles que no es mostren a la graella, per exemple, la puntuació econòmica (1.1)
            LOOP AT lt_crit_rels ASSIGNING FIELD-SYMBOL(<fs_crit_rel>).
              READ TABLE my_crit_punt_all ASSIGNING FIELD-SYMBOL(<fs_punt_all>) WITH KEY z_codi_crit_punt = <fs_crit_rel>-z_codi_crit_punt
                                                                                         z_mod_crit_punt  = <fs_crit_rel>-z_mod_crit_punt
                                                                                         z_crit_q3        = abap_off.
              IF sy-subrc EQ 0.
                lv_punt_max_pare = lv_punt_max_pare - <fs_punt_all>-z_punt_max.
              ENDIF.
            ENDLOOP.
            "<<<SPEC-55448, Final modificació - ETJGG
          ENDIF.
          "<<<SPEC-56457, Final modificació - ETODR

          "Sumem els criteris puntuats
          READ TABLE ch_crit_punt INTO DATA(wa_aux) WITH KEY z_codi_crit_punt = lv_codi_crit_punt_recalcul.

          CALL METHOD summatory_curr_dyn
            EXPORTING
              im_sum_info  = wa_aux-sum_info
              im_crit_punt = ch_crit_punt
              im_num_gen   = <fs_prov>-z_num_gen
              im_punt_gen  = ch_punt_gen
            CHANGING
              ch_sum       = lv_suma_crit_puntuats.

          "Sumem els criteris maxims que podria haver aconseguit
          CALL METHOD summatory_max_dyn
            EXPORTING
              im_sum_info  = wa_aux-sum_info
              im_crit_punt = ch_crit_punt "lt_crit_punt_aux
              im_num_gen   = <fs_prov>-z_num_gen
              im_punt_gen  = ch_punt_gen
            CHANGING
              ch_sum       = lv_punt_max_possibles.

          "Fòrmula recàlcul = lv_suma_crit_puntuats * lv_punt_max_pare / lv_punt_max_possibles.
          READ TABLE ch_punt_gen ASSIGNING FIELD-SYMBOL(<fs_punt_gen>) WITH KEY z_num_gen        = <fs_prov>-z_num_gen
                                                                                z_codi_crit_punt = lv_codi_crit_punt_recalcul.
          IF sy-subrc = 0 AND lv_punt_max_possibles IS NOT INITIAL.
*>> INICI - SPEC-75738 - ECMRG
            READ TABLE ch_crit_punt TRANSPORTING NO FIELDS WITH KEY z_total_harmonitzat = abap_on.

            IF sy-subrc = 0.
              <fs_punt_gen>-z_punts = lv_suma_crit_puntuats.

            ELSE.
*<< FI - SPEC-75738 - ECMRG
              <fs_punt_gen>-z_punts = lv_suma_crit_puntuats * lv_punt_max_pare / lv_punt_max_possibles.

            ENDIF. "SPEC-75738 - ECMRG

            READ TABLE lt_punts_before ASSIGNING FIELD-SYMBOL(<fs_punt_before>) WITH KEY z_num_gen        = <fs_prov>-z_num_gen
                                                                                         z_codi_crit_punt = <fs_punt_gen>-z_codi_crit_punt.
            IF sy-subrc = 0 AND <fs_punt_before>-z_punts <> <fs_punt_gen>-z_punts.
              ex_changed = abap_on.
            ENDIF.


            CLEAR: lv_codi_crit_punt_recalcul_tot.
            DATA(lv_aux_recalcul) = lv_codi_crit_punt_recalcul.
            DO 2 TIMES.
              LOOP AT ch_crit_punt ASSIGNING <fs_aux_crit_punt>.
                READ TABLE <fs_aux_crit_punt>-sum_info ASSIGNING <fs_sum_info> WITH KEY z_codi_crit_punt = lv_aux_recalcul.
                IF sy-subrc = 0.
                  lv_codi_crit_punt_recalcul_tot = <fs_aux_crit_punt>-z_codi_crit_punt.
                  CHECK lv_codi_crit_punt_recalcul_tot <> lv_codi_crit_punt_recalcul.
                  CHECK lv_codi_crit_punt_recalcul_tot IS NOT INITIAL.
                  "Per a qualsevol recàlcul ponderat d'un criteri fill al criteri de suma total, es torna a calcular per actualitzar els valors
                  READ TABLE ch_crit_punt ASSIGNING FIELD-SYMBOL(<fs_aux_crit_punt_2>) WITH KEY z_codi_crit_punt = lv_codi_crit_punt_recalcul_tot.
                  IF sy-subrc = 0.
                    READ TABLE ch_punt_gen ASSIGNING FIELD-SYMBOL(<fs_punt_gen_aux_2>) WITH KEY z_num_gen        = <fs_prov>-z_num_gen
                                                                                                z_codi_crit_punt = lv_codi_crit_punt_recalcul_tot.
                    CHECK sy-subrc = 0.
                    CALL METHOD summatory
                      EXPORTING
                        im_sum_info  = <fs_aux_crit_punt_2>-sum_info
                        im_crit_punt = ch_crit_punt
                        im_num_gen   = <fs_prov>-z_num_gen
                        im_punt_gen  = ch_punt_gen
                      CHANGING
                        ch_sum       = <fs_punt_gen_aux_2>-z_punts.
*                  IF lv_codi_crit_punt_recalcul_tot = '2.0.2'.
*                    recalculate_si_resta( EXPORTING im_crit_punt   = im_crit_punt
*                                                    i_recalculated = abap_on
*                                          CHANGING  ch_punt_gen    = ch_punt_gen ).
*                    e_recalculated = abap_on.
*                  ENDIF.
                    "Seguim buscant per arribar fins al recalcul pare
                    lv_aux_recalcul = lv_codi_crit_punt_recalcul_tot.
                  ENDIF.
                  EXIT.
                ENDIF.
              ENDLOOP.
            ENDDO.
          ENDIF.
          CLEAR: lv_suma_crit_puntuats, lv_punt_max_pare, lv_total_rec, lv_punt_max_possibles.
        ENDLOOP.
      ENDLOOP.
    ENDDO. "MODIF ETODR SPEC-48660

*>> INICI - SPEC-75738 - ECMRG

    recalculate_harmonitzat( EXPORTING im_crit_punt = ch_crit_punt
                                        im_proveidors = lt_proveidors
                                CHANGING ch_punt_gen = ch_punt_gen ).

*<< FI - SPEC-75738 - ECMRG


  ENDMETHOD.


  METHOD recalculate_si_resta.
    DATA: wa_crit_rel                    TYPE zrm_cl_valoracio_ofertes_fe=>ty_s_crit_rel,
          lv_codi_crit_punt_recalcul_tot TYPE z_codi_crit_punt,
          lv_codi_crit_punt_recalcul     TYPE z_codi_crit_punt.

    IF gt_crit_dyn_rel IS INITIAL.
      LOOP AT im_crit_punt ASSIGNING FIELD-SYMBOL(<fs_crit_punt>).
        CLEAR: wa_crit_rel.
        wa_crit_rel-z_mod_crit_punt = <fs_crit_punt>-z_mod_crit_punt.
        wa_crit_rel-z_parent        = <fs_crit_punt>-z_codi_crit_punt.
        IF <fs_crit_punt>-sum_info IS NOT INITIAL.
          LOOP AT <fs_crit_punt>-sum_info ASSIGNING FIELD-SYMBOL(<fs_sum_info>).
            wa_crit_rel-z_child = <fs_sum_info>-z_codi_crit_punt.
            CHECK wa_crit_rel-z_parent IS NOT INITIAL.
            APPEND wa_crit_rel TO gt_crit_dyn_rel.
          ENDLOOP.
        ENDIF.
      ENDLOOP.
    ENDIF.
    CHECK gt_crit_dyn_rel[] IS NOT INITIAL.

    DATA(lt_punts_before) = ch_punt_gen[].

    "Proveïdors
    DATA(lt_proveidors) = ch_punt_gen[].
    DELETE ADJACENT DUPLICATES FROM lt_proveidors COMPARING z_num_gen.
    LOOP AT lt_proveidors ASSIGNING FIELD-SYMBOL(<fs_prov>).
      LOOP AT im_crit_punt INTO DATA(ls_crit_punt) WHERE z_resta     = abap_on
                                                     AND z_no_aplica IS INITIAL.
        CLEAR: lv_codi_crit_punt_recalcul.
        READ TABLE gt_crit_dyn_rel ASSIGNING FIELD-SYMBOL(<fs_rel>) WITH KEY z_child = ls_crit_punt-z_codi_crit_punt.
        IF sy-subrc = 0.
          "Es busca el criteri que resta
          READ TABLE ch_punt_gen ASSIGNING FIELD-SYMBOL(<fs_criteri_resta>) WITH KEY z_codi_crit_punt = ls_crit_punt-z_codi_crit_punt
                                                                                     z_num_gen        = <fs_prov>-z_num_gen.
          IF sy-subrc = 0.
            "Es busca el pare del criteri que resta
            READ TABLE ch_punt_gen ASSIGNING FIELD-SYMBOL(<fs_pare_restat>) WITH KEY z_codi_crit_punt = <fs_rel>-z_parent
                                                                                     z_num_gen        = <fs_prov>-z_num_gen.
            IF sy-subrc = 0.
              lv_codi_crit_punt_recalcul = <fs_pare_restat>-z_codi_crit_punt.
              <fs_pare_restat>-z_punts = <fs_pare_restat>-z_punts + <fs_criteri_resta>-z_punts.
              READ TABLE lt_punts_before ASSIGNING FIELD-SYMBOL(<fs_punt_before>) WITH KEY z_num_gen        = <fs_prov>-z_num_gen
                                                                                           z_codi_crit_punt = <fs_pare_restat>-z_codi_crit_punt.
              IF sy-subrc = 0 AND <fs_punt_before>-z_punts <> <fs_pare_restat>-z_punts.
                ex_changed = abap_on.
              ENDIF.
            ENDIF.
          ENDIF.
        ENDIF.

*        IF i_recalculated IS INITIAL.
        CLEAR: lv_codi_crit_punt_recalcul_tot.
        DATA(lv_aux_recalcul) = lv_codi_crit_punt_recalcul.
        DO 2 TIMES.
          LOOP AT im_crit_punt ASSIGNING FIELD-SYMBOL(<fs_aux_crit_punt>).
            READ TABLE <fs_aux_crit_punt>-sum_info ASSIGNING <fs_sum_info> WITH KEY z_codi_crit_punt = lv_aux_recalcul.
            IF sy-subrc = 0.
              lv_codi_crit_punt_recalcul_tot = <fs_aux_crit_punt>-z_codi_crit_punt.
              CHECK lv_codi_crit_punt_recalcul_tot <> lv_codi_crit_punt_recalcul.
              CHECK lv_codi_crit_punt_recalcul_tot IS NOT INITIAL.
              "Per a qualsevol recàlcul ponderat d'un criteri fill al criteri de suma total, es torna a calcular per actualitzar els valors
              READ TABLE im_crit_punt ASSIGNING FIELD-SYMBOL(<fs_aux_crit_punt_2>) WITH KEY z_codi_crit_punt = lv_codi_crit_punt_recalcul_tot.
              IF sy-subrc = 0.
                READ TABLE ch_punt_gen ASSIGNING FIELD-SYMBOL(<fs_punt_gen_aux_2>) WITH KEY z_num_gen        = <fs_prov>-z_num_gen
                                                                                            z_codi_crit_punt = lv_codi_crit_punt_recalcul_tot.
                CHECK sy-subrc = 0.
                IF <fs_aux_crit_punt>-do_sum_dyn = abap_off.
                  "Si el no aplica afecta a un criteri pare, la suma final de resta no s'ha de fer, ja que ja s'ha calculat al mètode RECALCULATE_SI_NO_APLICA
                  CALL METHOD summatory
                    EXPORTING
                      im_sum_info  = <fs_aux_crit_punt_2>-sum_info
                      im_crit_punt = im_crit_punt
                      im_num_gen   = <fs_prov>-z_num_gen
                      im_punt_gen  = ch_punt_gen
                    CHANGING
                      ch_sum       = <fs_punt_gen_aux_2>-z_punts.
                  "Seguim buscant per arribar fins al recalcul pare
                  lv_aux_recalcul = lv_codi_crit_punt_recalcul_tot.
                ENDIF.
              ENDIF.
              EXIT.
            ENDIF.
          ENDLOOP.
        ENDDO.
*        ENDIF.

      ENDLOOP.
    ENDLOOP.
  ENDMETHOD.


METHOD recalculate_sol_part.

   DATA: l_changed TYPE xfeld .

  CALL METHOD me->recalculate_val_tecnic
    EXPORTING
      im_crit_punt = my_crit_punt_sol_part
    IMPORTING
      ex_changed   = l_changed
    CHANGING
      ch_punt_gen  = my_punt_sol_part.


***  DATA:           lt_num_gen     TYPE TABLE OF ty_s_punt_gen-z_num_gen,
***                  l_num_gen      TYPE ty_s_punt_gen-z_num_gen,
***                  l_num_crits    TYPE i,
***                  l_max_v        TYPE z_punts,
***                  l_diff_v       TYPE z_punts,
***                  l_punts_before TYPE z_punts,
***                  l_tabix        TYPE i .
***
***  FIELD-SYMBOLS: <ls_crit_punt> TYPE ty_s_crit_punt,
***                <ls_punt_gen>  TYPE ty_s_punt_gen,
***                <ls_ofertax>   TYPE ty_s_ofertax.
***
***  LOOP AT my_punt_sol_part ASSIGNING <ls_punt_gen> .
***    AT NEW z_num_gen .
***      APPEND <ls_punt_gen>-z_num_gen TO lt_num_gen .
***    ENDAT .
***  ENDLOOP .
***
**** Agafem un criteri i el calculem per a totes les ofertes/lemes. Després agafem
**** el següent criteri i fem el mateix. El mètode SUMMATORY confia en aquesta manera
**** de recòrrer la taula a l'hora de fer el rescalat de les puntuacions tècniques.
**** Calculem els en ordre invers per tal de no tenir problemes amb sumatoris de sumatoris
***  DESCRIBE TABLE my_crit_punt_sol_part LINES l_num_crits .
***  l_tabix = l_num_crits .
***
***  DO l_num_crits TIMES .
***    READ TABLE my_crit_punt_sol_part ASSIGNING <ls_crit_punt> INDEX l_tabix .
***    l_tabix = l_tabix - 1 .
***
***    CHECK NOT <ls_crit_punt>-sum_info IS INITIAL .
***    LOOP AT lt_num_gen INTO l_num_gen .
***      READ TABLE my_punt_sol_part ASSIGNING <ls_punt_gen>
***              WITH TABLE KEY z_codi_crit_punt = <ls_crit_punt>-z_codi_crit_punt
***                             z_mod_crit_punt  = <ls_crit_punt>-z_mod_crit_punt
***                             z_num_gen        = l_num_gen .
**** Important: si una oferta està exclosa o és temerèria no (re)calculem la seva valoració
**** tècnica. Si, pel que fos, l'oferta ja estava puntuada la deixem tal com estava. No
**** aplica per a lemes.
***      IF check_activity( co_act_punct_sp ) IS NOT INITIAL.
***        READ TABLE my_ofertesx ASSIGNING <ls_ofertax>
***             WITH TABLE KEY z_num_ofer = <ls_punt_gen>-z_num_gen .
***        CHECK: <ls_ofertax>-exclos IS INITIAL .
***      ENDIF.
***
***     l_punts_before = <ls_punt_gen>-z_punts.
***
***     CALL METHOD summatory
***        EXPORTING
***          im_sum_info  = <ls_crit_punt>-sum_info
***          im_crit_punt = my_crit_punt_sol_part
***          im_num_gen   = l_num_gen
***          im_punt_gen  = my_punt_sol_part
***        CHANGING
***          ch_sum       = <ls_punt_gen>-z_punts.
***
***    ENDLOOP.
***  ENDDO .

ENDMETHOD.


  METHOD recalculate_val_basat_marc.


    TYPES : BEGIN OF ty_s_fill.
              INCLUDE TYPE zrm_dt_punt_ofer AS offer_data.
              TYPES: num_proveidor TYPE z_proveidor,
            END OF ty_s_fill,
            ty_t_fill TYPE TABLE OF ty_s_fill.

    DATA : lt_zrm_dt_punt_ofer      TYPE ty_t_fill,
           ls_zrm_dt_punt_ofer      TYPE ty_s_fill,
           lt_zrm_dt_ofertes_pmam   TYPE TABLE OF zrm_dt_ofertes,                  " Insert PSPEC-1451 EVXGL
           ls_zrm_dt_ofertes_pmam   TYPE zrm_dt_ofertes,                  " Insert PSPEC-1451 EVXGL
           lt_zrm_dt_punt_ofer_piam TYPE ty_t_fill,                  " Insert PSPEC-1451 EVXGL
           ls_zrm_dt_punt_ofer_piam TYPE ty_s_fill,                  " Insert PSPEC-1451 EVXGL
           fs_zrm_dt_punt_ofer      TYPE ty_s_fill,
           lt_zrm_dm_mod_crit       TYPE TABLE OF zrm_dm_mod_crit,   " Insert PSPEC-1451 EVXGL
           ls_zrm_dm_mod_crit       TYPE zrm_dm_mod_crit,            " Insert PSPEC-1451 EVXGL
           lv_pi                    TYPE decfloat34,
           lv_pmam                  TYPE zrm_dt_punt_ofer-z_punts,
           lv_codi_exp_orig         TYPE zrm_dt_exp_cont-z_codi_exp_orig,
           lv_docclass_pare         TYPE zrm_dt_exp_cont-docclass,   " Insert PSPEC-1451 EVXGL
           lv_objectid_pare         TYPE zrm_dt_exp_cont-objectid,   " Insert PSPEC-1451 EVXGL
           lt_zrm_dt_ofertes        TYPE TABLE OF zrm_dt_ofertes,
           ls_zrm_dt_ofertes        TYPE zrm_dt_ofertes,
           ls_zrm_dt_ofertes_aux    TYPE zrm_dt_ofertes,
           lv_formula               TYPE zrm_dm_formules-z_formula,
           lv_piam_txt              TYPE z_formula,
           lv_pmam_txt              TYPE z_formula,
           lv_pi_val                TYPE zrm_dt_ofertes-z_punt_total,
           ls_crit_punt             TYPE ty_s_crit_punt,
           fs_crit_punt             TYPE ty_s_crit_punt,
           lt_ofertesx              TYPE ty_t_ofertax,
           ls_ofertesx              TYPE ty_s_ofertax,
           ls_my_ofertesx           TYPE ty_s_ofertax,               " Insert PSPEC-1451 EVXGL
           lt_ch_punt_gen           TYPE ty_t_punt_gen,              " Insert PSPEC-1451 EVXGL
           ls_ch_punt_gen           TYPE ty_s_punt_gen,              " Insert PSPEC-1451 EVXGL
           ch_punt_gen_aux          TYPE ty_t_punt_gen,              " Insert PSPEC-1451 EVXGL
           ch_s_punt_gen_aux        TYPE ty_s_punt_gen,              " Insert PSPEC-1451 EVXGL
           ls_punt_gen              TYPE ty_s_punt_gen,
           fs_punt_gen              TYPE ty_s_punt_gen,
           lv_prov_act              TYPE zrm_dt_ofertes-proveidor.


    " Amb el Codi del Model de Criteri de Puntuació, mirem si té el marcat camp
    " ZRM_DM_MOD_CRIT-Z_BAIXA_PRESENTADA per determinar si és del procés
    " de Verificació Cap D'Obra
    CLEAR: ls_zrm_dm_mod_crit.

    SELECT SINGLE *
     FROM zrm_dm_mod_crit
      INTO CORRESPONDING FIELDS OF ls_zrm_dm_mod_crit
       WHERE z_mod_crit_punt = my_plec-z_mod_crit_punt.


    " Si no és el procés de Verificació de Cap d'Obra seguirem el procés com fins ara
    " Si és el procés de Verificació de Cap d'Obra farem un nou tractament
    IF ls_zrm_dm_mod_crit-z_baixa_presentada IS INITIAL.      " NO és el procés de Verificació de Cap d'Obra

      " Cerquem les ofertes de l'Expedient fill a la taula ZRM_DT_PUNT_OFER.
      CLEAR: lt_zrm_dt_punt_ofer.

      SELECT *
       FROM zrm_dt_punt_ofer
        INTO CORRESPONDING FIELDS OF TABLE lt_zrm_dt_punt_ofer
         WHERE docclass = my_docclass
           AND objectid = my_objectid.

      LOOP AT lt_zrm_dt_punt_ofer ASSIGNING FIELD-SYMBOL(<fs_zrm_dt_punt_ofer>).
        CLEAR: ls_ofertesx.
        READ TABLE my_ofertesx INTO ls_ofertesx WITH KEY z_num_ofer = <fs_zrm_dt_punt_ofer>-z_num_ofer.

        IF sy-subrc = 0.
          <fs_zrm_dt_punt_ofer>-num_proveidor = ls_ofertesx-proveidor.
        ENDIF.
      ENDLOOP.

      CLEAR: lv_codi_exp_orig,
             lv_docclass_pare,
             lv_objectid_pare,
             lt_zrm_dt_ofertes.

      SELECT SINGLE z_codi_exp_orig
       FROM zrm_dt_exp_cont
        INTO lv_codi_exp_orig
          WHERE docclass = my_docclass
            AND objectid = my_objectid.

      SELECT SINGLE docclass objectid
       FROM zrm_dt_exp_cont
        INTO ( lv_docclass_pare, lv_objectid_pare )
         WHERE z_codi_exp = lv_codi_exp_orig.

      SELECT *
       FROM zrm_dt_ofertes
        INTO TABLE lt_zrm_dt_ofertes
          WHERE docclass = lv_docclass_pare
            AND objectid = lv_objectid_pare.


      CLEAR: lv_pmam.

      " Es recupera el valor z_punt_total dels proveidors inclosos de la taula zrm_dt_ofertes
      LOOP AT lt_zrm_dt_ofertes INTO ls_zrm_dt_ofertes.
        "INICI - SPEC-87171 - EVMRG
        READ TABLE my_ofertesx TRANSPORTING NO FIELDS WITH KEY proveidor = ls_zrm_dt_ofertes-proveidor z_exclos_s3 = abap_off
                                                               z_exclos_punt_capob = abap_off. "PSPEC-1451-EVMRG

        IF sy-subrc = 0.
          "FI - SPEC-87171 - EVMRG
          CLEAR lv_prov_act.
          READ TABLE lt_zrm_dt_punt_ofer TRANSPORTING NO FIELDS WITH KEY num_proveidor = ls_zrm_dt_ofertes-proveidor.

          IF sy-subrc <> 0.
            SELECT SINGLE lifnr
             FROM zmm_dt_hist_prov
              INTO lv_prov_act
                WHERE  z_cod_prov_ant = ls_zrm_dt_ofertes-proveidor.
            IF sy-subrc = 0.
              READ TABLE lt_zrm_dt_punt_ofer TRANSPORTING NO FIELDS WITH KEY num_proveidor = lv_prov_act.
            ENDIF.
          ENDIF.

          IF lv_pmam < ls_zrm_dt_ofertes-z_punt_total
           AND sy-subrc = 0.
            lv_pmam = ls_zrm_dt_ofertes-z_punt_total.
          ENDIF.
        ENDIF.  "SPEC-87171 - EVMRG
      ENDLOOP.

      LOOP AT ch_crit_punt INTO ls_crit_punt.

        IF ls_crit_punt-z_crit_ve = 'A'
         AND ls_crit_punt-z_no_aplica IS INITIAL.

          LOOP AT ch_punt_gen ASSIGNING FIELD-SYMBOL(<fs_punt_gen>).
            "INICI - SPEC-87171 - EVMRG
            READ TABLE my_ofertesx TRANSPORTING NO FIELDS WITH KEY z_num_ofer = <fs_punt_gen>-z_num_gen z_exclos_s3 = abap_off
                                                                   z_exclos_punt_capob = abap_off. "PSPEC-1451-EVMRG.
            IF sy-subrc = 0.
              "FI - SPEC-87171 - EVMRG
              CLEAR lv_prov_act.
              IF ls_crit_punt-z_codi_crit_punt = <fs_punt_gen>-z_codi_crit_punt.
                CLEAR : ls_zrm_dt_punt_ofer,
                        ls_zrm_dt_ofertes.

                READ TABLE lt_zrm_dt_punt_ofer INTO ls_zrm_dt_punt_ofer WITH KEY z_num_ofer = <fs_punt_gen>-z_num_gen.

                IF sy-subrc = 0.
                  READ TABLE lt_zrm_dt_ofertes INTO ls_zrm_dt_ofertes WITH KEY proveidor = ls_zrm_dt_punt_ofer-num_proveidor.
                  IF sy-subrc <> 0.
                    SELECT SINGLE z_cod_prov_ant
                     FROM zmm_dt_hist_prov
                      INTO lv_prov_act
                       WHERE lifnr = ls_zrm_dt_punt_ofer-num_proveidor.

                    IF sy-subrc = 0.
                      READ TABLE lt_zrm_dt_ofertes INTO ls_zrm_dt_ofertes WITH KEY proveidor = lv_prov_act.
                    ENDIF.
                  ENDIF.

                  IF ls_crit_punt-z_form_marc IS NOT INITIAL.
                    SELECT SINGLE z_formula
                     INTO lv_formula
                      FROM zrm_dm_formules
                       WHERE z_codi_form = ls_crit_punt-z_form_marc.

                    lv_piam_txt = ls_zrm_dt_ofertes-z_punt_total.
                    CONDENSE  lv_piam_txt NO-GAPS.
                    lv_pmam_txt  = lv_pmam.
                    CONDENSE lv_pmam_txt NO-GAPS.

                    REPLACE ALL OCCURRENCES OF 'PiAM' IN lv_formula WITH lv_piam_txt.
                    REPLACE ALL OCCURRENCES OF 'PMAM' IN lv_formula WITH lv_pmam_txt.

                    IF lv_pmam <> 0.
                      CALL FUNCTION 'EVAL_FORMULA'
                        EXPORTING
                          formula                 = lv_formula
                          program                 = sy-repid
                        IMPORTING
                          value                   = lv_pi
                        EXCEPTIONS
                          division_by_zero        = 1
                          exp_error               = 2
                          formula_table_not_valid = 3
                          invalid_expression      = 4
                          invalid_value           = 5
                          log_error               = 6
                          parameter_error         = 7
                          sqrt_error              = 8
                          units_not_valid         = 9
                          missing_parameter       = 10
                          OTHERS                  = 11.

                      IF sy-subrc <> 0.
                        "* Implement suitable error handling here
                      ENDIF.

                      IF sy-subrc = 0.
                        lv_pi_val = lv_pi.
                        <fs_punt_gen>-z_punts = lv_pi_val.
                      ENDIF.
                    ENDIF.

                  ENDIF.
                ENDIF.
              ENDIF.
            ENDIF. "SPEC-87171 - EVMRG
          ENDLOOP.

        ENDIF.
      ENDLOOP.


    ELSE.                                                     " SI és el procés de Verificació de Cap d'Obra

      " Cerquem les ofertes de l'Expedient fill a la taula ZRM_DT_PUNT_CAP.
      CLEAR: lt_zrm_dt_punt_ofer.

      SELECT *
       FROM zrm_dt_punt_cap
        INTO CORRESPONDING FIELDS OF TABLE lt_zrm_dt_punt_ofer
         WHERE docclass_fill = my_docclass     " Expedient Fill
           AND objectid_fill = my_objectid     " Expedient Fill
           AND z_codi_crit_punt = ''.


      " Traspasem les dades de les ofertes aconseguides a la taula ZRM_DT_PUNT_CAP
      " a la mostra taula interna de d'ofertes.
      CLEAR: ls_zrm_dt_punt_ofer,
             ls_zrm_dt_ofertes_aux.

      LOOP AT lt_zrm_dt_punt_ofer INTO  ls_zrm_dt_punt_ofer.
        ls_zrm_dt_ofertes_aux-docclass     = ls_zrm_dt_punt_ofer-docclass.    " Expedient Pare
        ls_zrm_dt_ofertes_aux-objectid     = ls_zrm_dt_punt_ofer-objectid.    " Expedient Pare.
        ls_zrm_dt_ofertes_aux-z_punt_total = ls_zrm_dt_punt_ofer-z_punts.
        ls_zrm_dt_ofertes_aux-proveidor    = ls_zrm_dt_punt_ofer-num_proveidor.

        " Seleccionem el Número d'Oferta de la taula interna MY_OFERTESX perquè es el correcte, perquè el
        " Número de Oferta de la taula ZRM_DT_PUNT_CAP, no ens és vàlid per fer el càcul de la fórmula.
        " També agafem els camps Z_EXCLOS_PUNT_CAPOB i Z_EXCLOS_S3 de la taula ZRM_DT_OFERTES per filtrar
        " més endavant en el codi.
        CLEAR: ls_zrm_dt_ofertes_aux-z_num_ofer,
               ls_zrm_dt_ofertes_aux-z_exclos_punt_capob,
               ls_zrm_dt_ofertes_aux-z_exclos_s3.

        "Cerquem els camps Z_EXCLOS_PUNT_CAPOB i Z_EXCLOS_S3 de la taula ZRM_DT_OFERTES
        SELECT SINGLE  z_exclos_punt_capob  z_exclos_s3
         FROM zrm_dt_ofertes
          INTO ( ls_zrm_dt_ofertes_aux-z_exclos_punt_capob, ls_zrm_dt_ofertes_aux-z_exclos_s3 )
            WHERE docclass  = my_docclass     " Expedient Fill
              AND objectid  = my_objectid     " Expedient Fill
              AND proveidor = ls_zrm_dt_ofertes_aux-proveidor.


        " Pasem, en cas que el tigui la taula interna MY_OFERTESX, el camp Número d'Oferta correcte.
        CLEAR: ls_my_ofertesx.
        READ TABLE my_ofertesx INTO ls_my_ofertesx WITH KEY proveidor = ls_zrm_dt_ofertes_aux-proveidor .

        IF ls_my_ofertesx IS NOT INITIAL.
          ls_zrm_dt_ofertes_aux-z_num_ofer = ls_my_ofertesx-z_num_ofer.
          ls_zrm_dt_punt_ofer-z_num_ofer = ls_my_ofertesx-z_num_ofer.
        ELSE.
          CLEAR: ls_zrm_dt_ofertes_aux-z_num_ofer,
                 ls_zrm_dt_punt_ofer-z_num_ofer.
        ENDIF.

        APPEND ls_zrm_dt_ofertes_aux TO lt_zrm_dt_ofertes.
        MODIFY lt_zrm_dt_punt_ofer FROM ls_zrm_dt_punt_ofer.

        CLEAR: ls_zrm_dt_punt_ofer,
               ls_zrm_dt_ofertes_aux.
      ENDLOOP.

      " Ens quedem amb les registres que tinguin Número d'Oferta
      DELETE lt_zrm_dt_ofertes WHERE z_num_ofer = '000'.
      DELETE lt_zrm_dt_punt_ofer WHERE z_num_ofer = '000'.


      " Netejem el valor PMAM únic de la fórmula per totes les ofertes y posteriorment el calculem.
      CLEAR: lv_pmam.

      " Recuperem el valor de la Puntuació Total (Z_PUNT_TOTAL) dels Proveidors inclosos de la taula LT_ZRM_DT_OFERTES
      CLEAR: ls_zrm_dt_ofertes.

      LOOP AT lt_zrm_dt_ofertes INTO ls_zrm_dt_ofertes.
        " Cerquem per Número de oferta, que no estigui exclós en el S3 i que estigui exclósde la puntuació de Cap D'Obra.
        READ TABLE my_ofertesx TRANSPORTING NO FIELDS WITH KEY proveidor = ls_zrm_dt_ofertes-proveidor
                                                               z_exclos_s3 = abap_off
                                                               z_exclos_punt_capob = abap_off.

        IF sy-subrc = 0.
          " Mirem si a la taula d'oferta existeix una oferta pel Proveidor.
          " Si no existeix el cercarem a la taula de l'històric de Proveïdors.
          CLEAR lv_prov_act.
          READ TABLE lt_zrm_dt_punt_ofer TRANSPORTING NO FIELDS WITH KEY num_proveidor = ls_zrm_dt_ofertes-proveidor.

          IF sy-subrc <> 0.
            SELECT SINGLE lifnr
             FROM zmm_dt_hist_prov
              INTO lv_prov_act
                WHERE z_cod_prov_ant = ls_zrm_dt_ofertes-proveidor.

            IF sy-subrc = 0.
              READ TABLE lt_zrm_dt_punt_ofer TRANSPORTING NO FIELDS WITH KEY num_proveidor = lv_prov_act.
            ENDIF.
          ENDIF.

          IF lv_pmam < ls_zrm_dt_ofertes-z_punt_total
           AND sy-subrc = 0.
            " Calculem el valor PMAM únic de la fórmula per totes les ofertes.
            CLEAR: lt_zrm_dt_ofertes_pmam,
                   ls_zrm_dt_ofertes_pmam.
            lt_zrm_dt_ofertes_pmam = lt_zrm_dt_ofertes.

            DELETE lt_zrm_dt_ofertes_pmam WHERE z_exclos_s3 = abap_on.             " Exclós Sobre 3
            DELETE lt_zrm_dt_ofertes_pmam WHERE z_exclos_punt_capob = abap_on.     " Exclós Verificació Cap d'Obra

            SORT lt_zrm_dt_ofertes_pmam BY z_punt_total DESCENDING.

            CLEAR ls_zrm_dt_ofertes_pmam.
            READ TABLE lt_zrm_dt_ofertes_pmam INTO ls_zrm_dt_ofertes_pmam INDEX 1.
            lv_pmam = ls_zrm_dt_ofertes_pmam-z_punt_total.
          ENDIF.
        ENDIF.

        CLEAR: ls_zrm_dt_ofertes.
      ENDLOOP.

      " Per cada Tipus deCriteri de Puntuació cercarem la seva oferta, cercarem la fórmula i calcularem la puntuació de la Valoració.
      CLEAR: ls_crit_punt.

      LOOP AT ch_crit_punt INTO ls_crit_punt.
        " Només farem el tractament pel Tipus de Criteri A -> Acord Marc i apliqui.
        IF ls_crit_punt-z_crit_ve = 'A'
         AND ls_crit_punt-z_no_aplica IS INITIAL.

          LOOP AT ch_punt_gen ASSIGNING FIELD-SYMBOL(<fs_punt_gen_capob>).

            " Cerquem per Número de oferta, que no estigui exclós en el S3 i que estigui exclósde la puntuació de Cap D'Obra.
            READ TABLE my_ofertesx TRANSPORTING NO FIELDS WITH KEY z_num_ofer  = <fs_punt_gen_capob>-z_num_gen
                                                                   z_exclos_s3 = abap_off
                                                                   z_exclos_punt_capob = abap_off.

            IF sy-subrc = 0.
              CLEAR: lv_prov_act.

              IF ls_crit_punt-z_codi_crit_punt = <fs_punt_gen_capob>-z_codi_crit_punt.
                CLEAR: ls_zrm_dt_punt_ofer,
                       ls_zrm_dt_ofertes.

                READ TABLE lt_zrm_dt_punt_ofer INTO ls_zrm_dt_punt_ofer WITH KEY z_num_ofer = <fs_punt_gen_capob>-z_num_gen.

                IF sy-subrc = 0.
                  " Mirem si a la taula d'oferta existeix una oferta pel Proveidor. Si no existeix el cercarem a la taula
                  " de l'històric de Proveïdors.
                  READ TABLE lt_zrm_dt_ofertes INTO ls_zrm_dt_ofertes WITH KEY proveidor = ls_zrm_dt_punt_ofer-num_proveidor.

                  IF sy-subrc <> 0.
                    SELECT SINGLE z_cod_prov_ant
                     FROM zmm_dt_hist_prov
                      INTO lv_prov_act
                       WHERE lifnr = ls_zrm_dt_punt_ofer-num_proveidor.

                    IF sy-subrc = 0.
                      READ TABLE lt_zrm_dt_ofertes INTO ls_zrm_dt_ofertes WITH KEY proveidor = lv_prov_act.
                    ENDIF.
                  ENDIF.

                  IF ls_crit_punt-z_form_marc IS NOT INITIAL.
                    " Cerquem la fórmula.
                    SELECT SINGLE z_formula
                     FROM zrm_dm_formules
                      INTO lv_formula
                       WHERE z_codi_form = ls_crit_punt-z_form_marc.

                    " Calculem el valor PIAM de cada oferta.
                    CLEAR: lt_zrm_dt_punt_ofer_piam,
                           ls_zrm_dt_punt_ofer_piam.

                    lt_zrm_dt_punt_ofer_piam = lt_zrm_dt_punt_ofer.
                    SORT lt_zrm_dt_punt_ofer_piam BY z_codi_crit_punt ASCENDING.
                    DELETE lt_zrm_dt_punt_ofer_piam WHERE z_codi_crit_punt <> ''.
                    READ TABLE lt_zrm_dt_punt_ofer_piam INTO ls_zrm_dt_punt_ofer_piam WITH KEY z_num_ofer = <fs_punt_gen_capob>-z_num_gen
                                                                                               num_proveidor = ls_zrm_dt_punt_ofer-num_proveidor
                                                                                               z_codi_crit_punt = ''.
                    lv_piam_txt = ls_zrm_dt_punt_ofer_piam-z_punts.

                    CONDENSE lv_piam_txt NO-GAPS.
                    lv_pmam_txt = lv_pmam.
                    CONDENSE lv_pmam_txt NO-GAPS.

                    REPLACE ALL OCCURRENCES OF 'PiAM' IN lv_formula WITH lv_piam_txt.
                    REPLACE ALL OCCURRENCES OF 'PMAM' IN lv_formula WITH lv_pmam_txt.

                    " Calculem amb la fórmula la puntuació de Valoració per cada oferta.
                    IF lv_pmam <> 0.
                      CALL FUNCTION 'EVAL_FORMULA'
                        EXPORTING
                          formula                 = lv_formula
                          program                 = sy-repid
                        IMPORTING
                          value                   = lv_pi
                        EXCEPTIONS
                          division_by_zero        = 1
                          exp_error               = 2
                          formula_table_not_valid = 3
                          invalid_expression      = 4
                          invalid_value           = 5
                          log_error               = 6
                          parameter_error         = 7
                          sqrt_error              = 8
                          units_not_valid         = 9
                          missing_parameter       = 10
                          OTHERS                  = 11.

                      IF sy-subrc = 0.
                        lv_pi_val = lv_pi.
                        <fs_punt_gen_capob>-z_punts = lv_pi_val.
                      ELSE.
                        "* Implement suitable error handling here
                      ENDIF.
                    ENDIF.
                  ENDIF.
                ENDIF.
              ENDIF.
            ENDIF.
          ENDLOOP.
        ENDIF.

        CLEAR: ls_crit_punt.
      ENDLOOP.
    ENDIF.

  ENDMETHOD.


METHOD recalculate_val_econ.

  CONSTANTS: c_1_50 TYPE p DECIMALS 8 VALUE '1.50',
             c_0_75 TYPE p DECIMALS 8 VALUE '0.75'.

  DATA: l_dummy TYPE c,                                     "#EC NEEDED
        l_punts TYPE ty_s_punt_gen-z_punts.

  DATA: lv_bd TYPE p DECIMALS 8,
        lv_pd TYPE p DECIMALS 8.

  FIELD-SYMBOLS: <ls_punt_gen>  TYPE ty_s_punt_gen,
                 <ls_crit_punt> TYPE ty_s_crit_punt,
                 <ls_ofertax>   TYPE ty_s_ofertax.

  CHECK: my_formula_ve-z_form_val_econ IS NOT INITIAL.

  CALL METHOD recalculate_boi_bmax
    EXPORTING
      im_exp_cont = my_exp_cont
    CHANGING
      ch_ofertesx = my_ofertesx
      ch_bmax     = my_formula_ve-bmax.


* SPEC-37697 ETRFV, inici
  CALL METHOD recalculate_boi_bmin
    EXPORTING
      im_exp_cont = my_exp_cont
    CHANGING
      ch_ofertesx = my_ofertesx
      ch_bmin     = my_formula_ve2-bmin.
* SPEC-37697 ETRFV, fi

  CLEAR ex_changed .
  LOOP AT im_crit_punt ASSIGNING <ls_crit_punt> WHERE z_crit_ve EQ co_crit_economic .
    LOOP AT ch_punt_gen ASSIGNING <ls_punt_gen>
              WHERE     z_codi_crit_punt EQ <ls_crit_punt>-z_codi_crit_punt
                    AND z_mod_crit_punt  EQ <ls_crit_punt>-z_mod_crit_punt .

* Important: si una oferta està exclosa o és temerèria no (re)calculem la seva valoració
* econòmica. Si, pel que fos, l'oferta ja estava puntuada la deixem tal com estava
      READ TABLE my_ofertesx ASSIGNING <ls_ofertax>
           WITH TABLE KEY z_num_ofer = <ls_punt_gen>-z_num_gen .
      CHECK: <ls_ofertax>-exclos IS INITIAL ,
**>> INI OVB SPEC-37724
             <ls_ofertax>-z_exclos_s2 IS INITIAL.
      IF <ls_ofertax>-exclos_pt IS INITIAL."Si internament està exclòs per PT el valor econòmic ha de ser 0.
**<< FIN OVB
        TRY .
            CASE my_formula_ve-z_tipus_form_ve .
              WHEN co_ve_type_a . "P = C - D * [(bmax - bi) * E / F]
                l_punts = my_formula_ve-z_param_ve_c - my_formula_ve-z_param_ve_d *
                      ( my_formula_ve-bmax  - <ls_ofertax>-boi ) * my_formula_ve-z_param_ve_e
                      / my_formula_ve-z_param_ve_f .

              WHEN co_ve_type_b . "P = C +  D * [ bi / max ]
                IF     <ls_ofertax>-boi EQ my_formula_ve-bmax  "Pel cas 0 /0
                   AND <ls_ofertax>-boi EQ 0 .
                  l_punts = my_formula_ve-z_param_ve_c +  my_formula_ve-z_param_ve_d .
                ELSE .
                  l_punts = my_formula_ve-z_param_ve_c +  my_formula_ve-z_param_ve_d *
                           ( <ls_ofertax>-boi / my_formula_ve-bmax  ).
                ENDIF .
              WHEN co_ve_type_c.
                IF my_exp_cont-z_nprima_homog >= 5.
                  lv_bd = my_exp_cont-z_br_homog.
                ELSE.
                  lv_bd = my_exp_cont-z_bm_homog.
                ENDIF.

                IF ( <ls_ofertax>-boi >= lv_bd ).
                  l_punts = my_formula_ve-z_param_ve_c - my_formula_ve-z_param_ve_d  * ( my_formula_ve-bmax - <ls_ofertax>-boi ).
                ELSE. " <ls_ofertax>-boi < lv_bd
                  lv_pd = my_formula_ve-z_param_ve_c - my_formula_ve-z_param_ve_d * ( my_formula_ve-bmax - lv_bd ).
                  l_punts = lv_pd - my_formula_ve-z_param_ve_e * ( lv_bd - <ls_ofertax>-boi ).
                ENDIF.

              WHEN co_ve_type_hardcoded .
                CASE my_formula_ve-z_form_val_econ.
                  WHEN 'VE9'.
                    IF my_exp_cont-z_nprima_homog >= 5.
                      lv_bd = my_exp_cont-z_br_homog.
                    ELSE.
                      lv_bd = my_exp_cont-z_bm_homog.
                    ENDIF.

                    IF ( <ls_ofertax>-boi >= lv_bd ).
                      l_punts = 100 - c_0_75  * ( my_formula_ve-bmax - <ls_ofertax>-boi ).
                    ELSE. " <ls_ofertax>-boi < lv_bd
                      lv_pd = 100 - c_0_75  * ( my_formula_ve-bmax - lv_bd ).
                      l_punts = lv_pd - c_1_50 * ( lv_bd - <ls_ofertax>-boi ).
                    ENDIF.

                  WHEN 'V19'.  " SPEC-37697 ETRFV, PEi = 5 * [(Bi - Bmin) / (Bmax - Bmin)]
                    l_punts = 5 * ( ( <ls_ofertax>-boi - my_formula_ve2-bmin ) / ( my_formula_ve-bmax - my_formula_ve2-bmin ) ).

*>> Inici SPEC-39884 ETXGL
                  WHEN 'V22'    " SPEC-39884 ETXGL, PEi = 70 * [(Omin / Oi)]
                    OR 'V23'   "                   PEi = 60 * [(Omin / Oi)]
                    OR 'V25' "SPEC-43291 ETKAN 08/03/20017
                    OR 'V28' "SPEC-43528 ETKAN 28/03/2017
                    OR 'V39'. "SPEC-50323 ETJMD 06/08/02018
                    CALL METHOD recalculate_omin
                      EXPORTING
                        im_exp_cont  = my_exp_cont
                      CHANGING
                        ch_ofertesx  = my_ofertesx
                        ch_importmin = my_formula_ve-z_imp_ofertamin.
                    "la puntuació que doni la formula V22 i V23, es necessari valorar-la sobre la puntuació màxima establerta al plec
                    IF   my_formula_ve-z_form_val_econ = 'V22'.
                      l_punts = 70 * ( my_formula_ve-z_imp_ofertamin / <ls_ofertax>-z_imp_oferta_b ).  "PEi = 70 * [(Omin / Oi)]
                      "Ponderació de la puntuació sobre el màxim
                      IF <ls_crit_punt>-z_crit_ve = abap_on.
                        l_punts = l_punts * ( <ls_crit_punt>-z_punt_max / 70 ).
                      ENDIF.
                    ELSEIF my_formula_ve-z_form_val_econ = 'V23'.
                      l_punts = 60 * ( my_formula_ve-z_imp_ofertamin / <ls_ofertax>-z_imp_oferta_b ).  "PEi = 60 * [(Omin / Oi)]
                      "Ponderació de la puntuació sobre el màxim
                      IF <ls_crit_punt>-z_crit_ve = abap_on.
                        l_punts = l_punts * ( <ls_crit_punt>-z_punt_max / 60 ).
                      ENDIF.
                      "inicio SPEC-43291 ETKAN 08/03/20017
                    ELSEIF my_formula_ve-z_form_val_econ EQ 'V25'.
                      l_punts = 80 * ( my_formula_ve-z_imp_ofertamin / <ls_ofertax>-z_imp_oferta_b ).  "PEi = 80 * [(Omin / Oi)]
                      "Ponderació de la puntuació sobre el màxim
                      IF <ls_crit_punt>-z_crit_ve EQ abap_on.
                        l_punts = l_punts * ( <ls_crit_punt>-z_punt_max / 80 ).
                      ENDIF.
                      "FIN SPEC-43291 ETKAN 08/03/20017
                      "INICIO "SPEC-43528 ETKAN 28/03/2017
                    ELSEIF my_formula_ve-z_form_val_econ EQ 'V28'.
                      l_punts = 75 * ( my_formula_ve-z_imp_ofertamin / <ls_ofertax>-z_imp_oferta_b ).  "PEi = 75 * [(Omin / Oi)]
                      "Ponderació de la puntuació sobre el màxim
                      IF <ls_crit_punt>-z_crit_ve EQ abap_on.
                        l_punts = l_punts * ( <ls_crit_punt>-z_punt_max / 75 ).
                      ENDIF.
                      "FIN "SPEC-43528 ETKAN 28/03/2017
                      "INICIO SPEC-50323 ETJMD 06/08/02018
                    ELSEIF my_formula_ve-z_form_val_econ EQ 'V39'.
                      l_punts = 90 * ( my_formula_ve-z_imp_ofertamin / <ls_ofertax>-z_imp_oferta_b ).  "PEi = 90 * [(Omin / Oi)]
                      "Ponderació de la puntuació sobre el màxim
                      IF <ls_crit_punt>-z_crit_ve EQ abap_on.
                        l_punts = l_punts * ( <ls_crit_punt>-z_punt_max / 90 ).
                      ENDIF.
                      "FIN SPEC-50323 ETJMD 06/08/02018
                    ENDIF.
*>> Fi SPEC-39884 ETXGL
                  WHEN OTHERS.
                    MESSAGE e035 WITH my_formula_ve-z_form_val_econ INTO l_dummy .
                    zcx_rm_valoracio=>raise_from_message( ) .
                ENDCASE.
              WHEN OTHERS. CONTINUE .
            ENDCASE .
            IF <ls_punt_gen>-z_punts NE l_punts .
*             IF my_exp_cont-z_rd817_2009 IS NOT INITIAL AND
*                <ls_punt_gen>-z_punts IS INITIAL.
*               ex_changed = space.
*             ELSE.
              ex_changed = 'X' .
*             ENDIF.
            ENDIF .
            <ls_punt_gen>-z_punts = l_punts .
          CATCH cx_sy_zerodivide
                cx_sy_conversion_overflow
                cx_sy_arithmetic_overflow .
            MESSAGE e038 WITH <ls_punt_gen>-z_num_gen INTO l_dummy .
            zcx_rm_valoracio=>raise_from_message( ) .
        ENDTRY .
**>> INI OVB SPEC-37724
      ELSE.
        CLEAR <ls_punt_gen>-z_punts.
      ENDIF.
**<< FIN OVB
    ENDLOOP .
  ENDLOOP .
ENDMETHOD.


  METHOD recalculate_val_econ_n.


    CONSTANTS: c_1_50 TYPE p DECIMALS 8 VALUE '1.50',
               c_0_75 TYPE p DECIMALS 8 VALUE '0.75'.

    DATA: l_dummy                TYPE c,                    "#EC NEEDED
          l_punts                TYPE ty_s_punt_gen-z_punts,
          l_punts_no_pond        TYPE ty_s_punt_gen-z_punts_no_pond, "SPEC-56319
          lv_resultat_formula_fm TYPE decfloat34, "SPEC-56319
          lv_imp_pres            TYPE z_pres_licit_b. "71174

    DATA: lv_bd TYPE p DECIMALS 8,
          lv_pd TYPE p DECIMALS 8.
    DATA: check_formula TYPE xfeld.

    FIELD-SYMBOLS: <ls_punt_gen>  TYPE ty_s_punt_gen,
                   <ls_crit_punt> TYPE ty_s_crit_punt,
                   <ls_ofertax>   TYPE ty_s_ofertax.

    DATA: ws_info_formula TYPE ty_s_formula_n_param .

    ">> SPEC-72969, Inici Modificació - ETODR
    DATA: lv_pres_licit_variable TYPE zrm_dt_exp_cont-z_pres_licit_b.

    CLEAR: lv_pres_licit_variable.
    zcl_util_licitacio=>get_import_exped_tipol_var( EXPORTING i_clas_exp  = my_exp_cont-docclass
                                                              i_expedient = my_exp_cont-objectid
                                                    IMPORTING e_import    = lv_pres_licit_variable ).
    IF lv_pres_licit_variable IS INITIAL.
      lv_pres_licit_variable = my_exp_cont-z_pres_licit_b.
    ENDIF.
    "<< SPEC-72969, Final Modificació - ETODR
*** >> INI MODIF ETODR SPEC-53215
*    "Pel cas del Q3B encara no s'ha de calcular la puntuació econòmica
    IF co_mode_punt_quadre3b = my_mode.
      ">> SPEC-83664, Inici Modificació - ETODR
      "Només calculem puntuació econòmica si al Q3 s'ha indicat que s'ha de calcular
      READ TABLE my_crit_punt TRANSPORTING NO FIELDS WITH KEY z_crit_ve          = abap_on
                                                              z_crit_q3          = abap_off.
      IF sy-subrc = 0.
        "<< SPEC-83664, Final Modificació - ETODR
        EXIT.
      ENDIF.
    ENDIF.
*** << FI MODIF ETODR SPEC-53215
*  CHECK: my_formula_ve-z_form_val_econ IS NOT INITIAL.
    check_formula = abap_true.

    IF my_formula_ve_n IS INITIAL OR my_formula_ve_n-info_formula[] IS INITIAL.
      check_formula = abap_false.
    ENDIF.

    LOOP AT my_formula_ve_n-info_formula INTO ws_info_formula.
      IF ws_info_formula-z_form_val_econ IS INITIAL.
        check_formula = abap_false.
        EXIT.
      ENDIF.
    ENDLOOP.

    CHECK: check_formula IS NOT INITIAL.

    CALL METHOD recalculate_boi_bmax
      EXPORTING
        im_exp_cont = my_exp_cont
      CHANGING
        ch_ofertesx = my_ofertesx
        ch_bmax     = my_formula_ve_n-bmax.


***>>> INICI Insert SPEC-51378 ETXGL
    IF my_formula_ve_n-bmax IS NOT INITIAL.
      CLEAR my_formula_ve_n-bmax_2_dec.
      my_formula_ve_n-bmax_2_dec = my_formula_ve_n-bmax.
      CLEAR my_formula_ve_n-bmax.
      my_formula_ve_n-bmax = my_formula_ve_n-bmax_2_dec.
    ELSE.
    ENDIF.
***<<< FI Insert SPEC-51378 ETXGL


* SPEC-37697 ETRFV, inici
    CALL METHOD recalculate_boi_bmin
      EXPORTING
        im_exp_cont = my_exp_cont
      CHANGING
        ch_ofertesx = my_ofertesx
        ch_bmin     = my_formula_ve_n-bmin.
* SPEC-37697 ETRFV, fi

***>>> INICI Insert SPEC-51378 ETXGL
    IF my_formula_ve_n-bmin IS NOT INITIAL.
      CLEAR my_formula_ve_n-bmin_2_dec.
      my_formula_ve_n-bmin_2_dec = my_formula_ve_n-bmin.
      CLEAR my_formula_ve_n-bmin.
      my_formula_ve_n-bmin = my_formula_ve_n-bmin_2_dec.
    ELSE.
    ENDIF.
***<<< FI Insert SPEC-51378 ETXGL


    LOOP AT my_formula_ve_n-info_formula INTO ws_info_formula.

      CLEAR ex_changed .
      LOOP AT im_crit_punt ASSIGNING <ls_crit_punt> WHERE z_crit_ve EQ co_crit_economic AND z_codi_crit_punt = ws_info_formula-z_codi_crit_punt.
        LOOP AT ch_punt_gen ASSIGNING <ls_punt_gen>
                  WHERE     z_codi_crit_punt EQ <ls_crit_punt>-z_codi_crit_punt
                        AND z_mod_crit_punt  EQ <ls_crit_punt>-z_mod_crit_punt .

* Important: si una oferta està exclosa o és temerèria no (re)calculem la seva valoració
* econòmica. Si, pel que fos, l'oferta ja estava puntuada la deixem tal com estava
          READ TABLE my_ofertesx ASSIGNING <ls_ofertax>
               WITH TABLE KEY z_num_ofer = <ls_punt_gen>-z_num_gen .
          CHECK: <ls_ofertax>-exclos IS INITIAL ,
**>> INI OVB SPEC-37724
                 <ls_ofertax>-z_exclos_s2 IS INITIAL.
          IF <ls_ofertax>-exclos_pt IS INITIAL."Si internament està exclòs per PT el valor econòmic ha de ser 0.
**<< FIN OVB


***>>> INICI Insert SPEC-51378 ETXGL
            IF <ls_ofertax>-boi IS NOT INITIAL.
              CLEAR <ls_ofertax>-boi_2_dec.
              <ls_ofertax>-boi_2_dec = <ls_ofertax>-boi.
              CLEAR <ls_ofertax>-boi.
              <ls_ofertax>-boi = <ls_ofertax>-boi_2_dec.
            ELSE.
            ENDIF.
***<<< FI Insert SPEC-51378 ETXGL

            TRY .
                CASE ws_info_formula-z_tipus_form_ve .
                  WHEN co_ve_type_a . "P = C - D * [(bmax - bi) * E / F]l.
                    ">>>SPEC:51885, Inici modificació  - ECFA
                    "En cas que el preu sigui obert calcula el 100 dels punts
                    IF my_exp_cont-z_conv_ob_preu EQ abap_true.
                      ">>>SPEC-56319, Inici modificació  - ETODR
                      READ TABLE im_crit_punt INTO DATA(ls_crit_punt) WITH KEY z_crit_ve = abap_on.
                      IF ls_crit_punt-z_crit_depenent IS NOT INITIAL.
                        CLEAR: lv_resultat_formula_fm.
                        l_punts = ws_info_formula-z_param_ve_c - ws_info_formula-z_param_ve_d *
                              ( my_formula_ve_n-bmax  - <ls_ofertax>-boi ) * ws_info_formula-z_param_ve_e
                              / ws_info_formula-z_param_ve_f.

                        l_punts_no_pond = l_punts.

                        CALL FUNCTION 'EVAL_FORMULA'
                          EXPORTING
                            formula = ls_crit_punt-z_factor_multip
                            program = sy-repid
                          IMPORTING
                            value   = lv_resultat_formula_fm
                          EXCEPTIONS
                            OTHERS  = 1.
                        IF sy-subrc = 0.
                          l_punts = l_punts * lv_resultat_formula_fm.
                        ENDIF.

                      ELSE.
                        "<<<SPEC-56319, Final modificació - ETODR
                        l_punts = 100 - ws_info_formula-z_param_ve_d * ( my_formula_ve_n-bmax  - <ls_ofertax>-boi )
                                 * ws_info_formula-z_param_ve_e  / ws_info_formula-z_param_ve_f .
                      ENDIF.

                    ELSE.
                      l_punts = ws_info_formula-z_param_ve_c - ws_info_formula-z_param_ve_d *
                            ( my_formula_ve_n-bmax  - <ls_ofertax>-boi ) * ws_info_formula-z_param_ve_e
                            / ws_info_formula-z_param_ve_f .
                    ENDIF.

                    "<<<SPEC:51885, Final modificació - ECFA
                  WHEN co_ve_type_b . "P = C +  D * [ bi / max ]
                    IF     <ls_ofertax>-boi EQ my_formula_ve_n-bmax  "Pel cas 0 /0
                       AND <ls_ofertax>-boi EQ 0 .
                      l_punts = ws_info_formula-z_param_ve_c +  ws_info_formula-z_param_ve_d .
                    ELSE .
                      l_punts = ws_info_formula-z_param_ve_c +  ws_info_formula-z_param_ve_d *
                               ( <ls_ofertax>-boi / my_formula_ve_n-bmax  ).
                    ENDIF .
                  WHEN co_ve_type_c.
                    IF my_exp_cont-z_nprima_homog >= 5.
                      lv_bd = my_exp_cont-z_br_homog.
                    ELSE.
                      lv_bd = my_exp_cont-z_bm_homog.
                    ENDIF.

                    IF ( <ls_ofertax>-boi >= lv_bd ).
                      l_punts = ws_info_formula-z_param_ve_c - ws_info_formula-z_param_ve_d  * ( my_formula_ve_n-bmax - <ls_ofertax>-boi ).
                    ELSE. " <ls_ofertax>-boi < lv_bd
                      lv_pd = ws_info_formula-z_param_ve_c - ws_info_formula-z_param_ve_d * ( my_formula_ve_n-bmax - lv_bd ).
                      l_punts = lv_pd - ws_info_formula-z_param_ve_e * ( lv_bd - <ls_ofertax>-boi ).
                    ENDIF.

                  WHEN co_ve_type_hardcoded .
                    CASE ws_info_formula-z_form_val_econ.
                      WHEN 'VE9'.
                        IF my_exp_cont-z_nprima_homog >= 5.
                          lv_bd = my_exp_cont-z_br_homog.
                        ELSE.
                          lv_bd = my_exp_cont-z_bm_homog.
                        ENDIF.

                        IF ( <ls_ofertax>-boi >= lv_bd ).
                          l_punts = 100 - c_0_75  * ( my_formula_ve_n-bmax - <ls_ofertax>-boi ).
                        ELSE. " <ls_ofertax>-boi < lv_bd
                          lv_pd = 100 - c_0_75  * ( my_formula_ve_n-bmax - lv_bd ).
                          l_punts = lv_pd - c_1_50 * ( lv_bd - <ls_ofertax>-boi ).
                        ENDIF.

                      WHEN 'V19'.  " SPEC-37697 ETRFV, PEi = 5 * [(Bi - Bmin) / (Bmax - Bmin)]
                        l_punts = 5 * ( ( <ls_ofertax>-boi - my_formula_ve_n-bmin ) / ( my_formula_ve_n-bmax - my_formula_ve_n-bmin ) ).

*>> Inici SPEC-39884 ETXGL
                      WHEN 'V22'    " SPEC-39884 ETXGL, PEi = 70 * [(Omin / Oi)]
                        OR 'V23'   "                   PEi = 60 * [(Omin / Oi)]
                        OR 'V25' "SPEC-43291 ETKAN 08/03/20017
                        OR 'V28' "SPEC-43528 ETKAN 28/03/2017
                        OR 'V39' "SPEC-50323 ETJMD 06/08/02018
                        OR 'V40' "SPEC-50332 ETODR 07/08/02018
                        OR 'V65' "SPEC-63855 ECGMD 14/04/2021
                        OR 'V58' "SPEC-57225 ETODR
                        OR 'V59' "SPEC-57868 ETODR
                        OR 'V62' "SPEC-61929 ECMSM
                        OR 'V66' "SPEC-61754 ETODR
                        OR 'V67'
                        OR 'V68'  "SPEC-67070 ECAVM
                        OR 'V69'  "SPEC-69341 ECFVC
                        OR 'V71' "SPEC-71214 ECJGG
                        OR 'V72'  "SPEC-72113 ETOVB
                        OR 'V73' "SPEC-72119 ECJBG
                        OR 'V74'
                        OR 'V75'"SPEC-75237

                        OR 'V76'" SPEC-76051 ECJBG
                        OR 'V77' " SPEC-76051 ECJBG
                        OR 'V81'. "SPEC-82871 EVCHA
                        CALL METHOD recalculate_omin
                          EXPORTING
                            im_exp_cont      = my_exp_cont
                          CHANGING
                            ch_ofertesx      = my_ofertesx
                            ch_importmin     = my_formula_ve_n-z_imp_ofertamin
                            ">> SPEC-72969, Inici Modificació - ETODR
                            ch_importmin_var = my_formula_ve_n-z_imp_ofertamin_var.
                        "<< SPEC-72969, Final Modificació - ETODR
                        "la puntuació que doni la formula V22 i V23, es necessari valorar-la sobre la puntuació màxima establerta al plec
                        IF   ws_info_formula-z_form_val_econ = 'V22'.
                          l_punts = 70 * ( my_formula_ve_n-z_imp_ofertamin / <ls_ofertax>-z_imp_oferta_b ).  "PEi = 70 * [(Omin / Oi)]
                          "Ponderació de la puntuació sobre el màxim
                          IF <ls_crit_punt>-z_crit_ve = abap_on.
                            l_punts = l_punts * ( <ls_crit_punt>-z_punt_max / 70 ).
                          ENDIF.
                        ELSEIF ws_info_formula-z_form_val_econ = 'V23'.
                          l_punts = 60 * ( my_formula_ve_n-z_imp_ofertamin / <ls_ofertax>-z_imp_oferta_b ).  "PEi = 60 * [(Omin / Oi)]
                          "Ponderació de la puntuació sobre el màxim
                          IF <ls_crit_punt>-z_crit_ve = abap_on.
                            l_punts = l_punts * ( <ls_crit_punt>-z_punt_max / 60 ).
                          ENDIF.
                          "inicio SPEC-43291 ETKAN 08/03/20017
                        ELSEIF ws_info_formula-z_form_val_econ EQ 'V25'.
                          l_punts = 80 * ( my_formula_ve_n-z_imp_ofertamin / <ls_ofertax>-z_imp_oferta_b ).  "PEi = 80 * [(Omin / Oi)]
                          "Ponderació de la puntuació sobre el màxim
                          IF <ls_crit_punt>-z_crit_ve EQ abap_on.
                            l_punts = l_punts * ( <ls_crit_punt>-z_punt_max / 80 ).
                          ENDIF.
                          "FIN SPEC-43291 ETKAN 08/03/20017
                          "INICIO "SPEC-43528 ETKAN 28/03/2017
                        ELSEIF ws_info_formula-z_form_val_econ EQ 'V28'.
                          l_punts = 75 * ( my_formula_ve_n-z_imp_ofertamin / <ls_ofertax>-z_imp_oferta_b ).  "PEi = 75 * [(Omin / Oi)]
                          "Ponderació de la puntuació sobre el màxim
                          IF <ls_crit_punt>-z_crit_ve EQ abap_on.
                            l_punts = l_punts * ( <ls_crit_punt>-z_punt_max / 75 ).
                          ENDIF.
                          "FIN "SPEC-43528 ETKAN 28/03/2017
                          "INICIO SPEC-50323 ETJMD 06/08/02018
                        ELSEIF ws_info_formula-z_form_val_econ EQ 'V39'.
                          l_punts = 90 * ( my_formula_ve_n-z_imp_ofertamin / <ls_ofertax>-z_imp_oferta_b ).  "PEi = 90 * [(Omin / Oi)]
                          "Ponderació de la puntuació sobre el màxim
                          IF <ls_crit_punt>-z_crit_ve EQ abap_on.
                            l_punts = l_punts * ( <ls_crit_punt>-z_punt_max / 90 ).
                          ENDIF.
                          "FIN SPEC-50323 ETJMD 06/08/02018
                          "INI MODIF SPEC-50332 ETODR 07/08/02018
                        ELSEIF ws_info_formula-z_form_val_econ EQ 'V40'.
                          l_punts = ( 1 - ( ( <ls_ofertax>-z_imp_oferta_b - my_formula_ve_n-z_imp_ofertamin ) / my_exp_cont-z_pres_licit_b ) ) * 55.
                          "Ponderació de la puntuació sobre el màxim
*                          IF <ls_crit_punt>-z_crit_ve EQ abap_on.
*                            l_punts = l_punts * ( <ls_crit_punt>-z_punt_max / 90 ).
*                          ENDIF.
                          "FIN MODIF SPEC-50332 ETODR 07/08/02018
                          "INI MODIF SPEC-63855 ECGMD 14/04/2021
                        ELSEIF ws_info_formula-z_form_val_econ EQ 'V65'.
                          l_punts = ( 1 - ( ( <ls_ofertax>-z_imp_oferta_b - my_formula_ve_n-z_imp_ofertamin ) / my_exp_cont-z_pres_licit_b ) ) * <ls_crit_punt>-z_punt_max.  "57. SPEC-77348 - ECMRG
                          "FIN MODIF SPEC-63855 ECGMD 14/04/2021
                          ">>>SPEC-57225, Inici modificació  - ETODR
                        ELSEIF ws_info_formula-z_form_val_econ = 'V58'.
                          l_punts = 78 * ( my_formula_ve_n-z_imp_ofertamin / <ls_ofertax>-z_imp_oferta_b ).  "PEi = 78 * [(Omin / Oi)]
                          "Ponderació de la puntuació sobre el màxim
                          IF <ls_crit_punt>-z_crit_ve = abap_on.
                            l_punts = l_punts * ( <ls_crit_punt>-z_punt_max / 78 ).
                          ENDIF.
                          "<<<SPEC-57225, Final modificació - ETODR
                          ">>>SPEC-57868, Inici modificació  - ETODR
                        ELSEIF ws_info_formula-z_form_val_econ = 'V59'.
                          l_punts = 55 * ( my_formula_ve_n-z_imp_ofertamin / <ls_ofertax>-z_imp_oferta_b ).  "PEi = 55 * [(Omin / Oi)]
                          "Ponderació de la puntuació sobre el màxim
                          IF <ls_crit_punt>-z_crit_ve = abap_on.
                            l_punts = l_punts * ( <ls_crit_punt>-z_punt_max / 55 ).
                          ENDIF.
                          "<<<SPEC-57868, Final modificació - ETODR
                          ">>>SPEC-61929, Inici modificació - ECMSM
                        ELSEIF ws_info_formula-z_form_val_econ = 'V62'.
                          l_punts = 100 * ( my_formula_ve_n-z_imp_ofertamin / <ls_ofertax>-z_imp_oferta_b ).  "PEi = 100 * (Omin / Oi)
                          "Ponderació de la puntuació sobre el màxim
                          IF <ls_crit_punt>-z_crit_ve = abap_on.
                            l_punts = l_punts * ( <ls_crit_punt>-z_punt_max / 100 ).
                          ENDIF.
                          "<<<SPEC-61929, Final modificació - ECMSM
                          ">> INI MODIF SPEC-61754 ETODR
                        ELSEIF ws_info_formula-z_form_val_econ = 'V66'. "PEi = 35 * ( 1 - (Oi – Omin) / IL )
                          ">> SPEC-72969, Inici Modificació - ETODR
*                          l_punts = 35 * ( 1 - ( <ls_ofertax>-z_imp_oferta_b - my_formula_ve_n-z_imp_ofertamin ) / my_exp_cont-z_pres_licit_b ).
                          l_punts = 35 * ( 1 - ( <ls_ofertax>-tip_econ_ofer-import_var - my_formula_ve_n-z_imp_ofertamin_var ) / lv_pres_licit_variable ).
                          "<< SPEC-72969, Final Modificació - ETODR

                        ELSEIF ws_info_formula-z_form_val_econ = 'V67'. "PEi = 45 * ( 1 - (Oi – Omin) / IL )
                          ">> SPEC-72969, Inici Modificació - ETODR
*                          l_punts = 45 * ( 1 - ( <ls_ofertax>-z_imp_oferta_b - my_formula_ve_n-z_imp_ofertamin ) / my_exp_cont-z_pres_licit_b ).
                          l_punts = 45 * ( 1 - ( <ls_ofertax>-tip_econ_ofer-import_var - my_formula_ve_n-z_imp_ofertamin_var ) / lv_pres_licit_variable ).
                          "<< SPEC-72969, Final Modificació - ETODR
                          ">> FI MODIF SPEC-61754 ETODR
                          ">>INI SPEC-67070 ECAVM
                        ELSEIF ws_info_formula-z_form_val_econ = 'V68'. "PEi = 75 * ( 1 - (Oi – Omin) / IL )
                          ">> SPEC-72969, Inici Modificació - ETODR
*                          l_punts = 75 * ( 1 - ( <ls_ofertax>-z_imp_oferta_b - my_formula_ve_n-z_imp_ofertamin ) / my_exp_cont-z_pres_licit_b ).
                          l_punts = 75 * ( 1 - ( <ls_ofertax>-tip_econ_ofer-import_var - my_formula_ve_n-z_imp_ofertamin_var ) / lv_pres_licit_variable ).
                          "<< SPEC-72969, Final Modificació - ETODR
                          ">>FI SPEC-67070 ECAVM
                          ">>INI SPEC-69341 ECFVC
                        ELSEIF ws_info_formula-z_form_val_econ = 'V69'. "PEi = 50 * ( 1 - (Oi – Omin) / IL )

                          ">> SPEC-72969, Inici Modificació - ETODR
                          l_punts = 50 * ( 1 - ( <ls_ofertax>-z_cost_obra_b - my_formula_ve_n-z_imp_ofertamin_var ) / lv_pres_licit_variable ).
*                          ">>>SPEC:71174, Inici modificació - ECACM
*
*                          SELECT tipus_ofer, pressupost
*                          FROM zrm_dt_tip_eco
*                          INTO TABLE @DATA(lt_tip_eco)
*                          WHERE objectid = @my_exp_cont-objectid.
*
*                          LOOP AT lt_tip_eco ASSIGNING FIELD-SYMBOL(<fs_tip_eco>) WHERE tipus_ofer EQ 1.
*
*                            lv_imp_pres = lv_imp_pres + <fs_tip_eco>-pressupost.
*
*                          ENDLOOP.
*
*                          SELECT import
*                          FROM zrm_dt_ofer_tip
*                          INTO TABLE @DATA(lt_ofer_tip)
*                          WHERE objectid = @my_exp_cont-objectid
*                            AND tipus_ofer EQ 1.
*
*                          IF sy-subrc EQ 0.
*                            SORT lt_ofer_tip BY import ASCENDING.
*                            READ TABLE lt_ofer_tip ASSIGNING FIELD-SYMBOL(<fs_ofer_tip>) INDEX 1.
*                          ENDIF.
*
*                          IF <fs_ofer_tip> IS ASSIGNED.
*                            l_punts = 50 * ( 1 - ( <ls_ofertax>-z_cost_obra_b - <fs_ofer_tip>-import ) / lv_imp_pres ).
*                          ELSE.
*                            l_punts = 50 * ( 1 - ( <ls_ofertax>-z_cost_obra_b - 0 ) / lv_imp_pres ).
*                          ENDIF.
*                          CLEAR lv_imp_pres.
*                          ">>>SPEC:71174, Final modificació - ECACM
                          "<< SPEC-72969, Final Modificació - ETODR
                          ">>FI SPEC-69341 ECFVC
*** JGG  SPEC-71214  -->
                        ELSEIF ws_info_formula-z_form_val_econ = 'V71'. "PEi = 30 * ( 1 - (Oi – Omin) / IL )
                          l_punts = 30 * ( 1 - ( <ls_ofertax>-z_imp_oferta_b - my_formula_ve_n-z_imp_ofertamin ) / my_exp_cont-z_pres_licit_b ).
*** JGG  SPEC-71214  <--

*** INI ETOVB  SPEC-72113
                        ELSEIF ws_info_formula-z_form_val_econ = 'V72'.
                          l_punts = ( 1 - ( ( <ls_ofertax>-z_imp_oferta_b - my_formula_ve_n-z_imp_ofertamin ) / my_exp_cont-z_pres_licit_b ) ) * 40.

*** FIN ETOVB  SPEC-72113
*** INI "SPEC-72119 ECJBG
                        ELSEIF ws_info_formula-z_form_val_econ = 'V73'.
                          l_punts = 65 * ( my_formula_ve_n-z_imp_ofertamin / <ls_ofertax>-z_imp_oferta_b ).  "PEi = 65 * [(Omin / Oi)]
                          "Ponderació de la puntuació sobre el màxim
                          IF <ls_crit_punt>-z_crit_ve = abap_on.
                            l_punts = l_punts * ( <ls_crit_punt>-z_punt_max / 65 ).
                          ENDIF.
                          """ INI ETOVB SPEC-73208
                        ELSEIF ws_info_formula-z_form_val_econ = 'V74'.
                          l_punts = 85 * ( my_formula_ve_n-z_imp_ofertamin / <ls_ofertax>-z_imp_oferta_b ).  "PEi = 85 * (Omin / Oi)
                          "Ponderació de la puntuació sobre el màxim
                          IF <ls_crit_punt>-z_crit_ve = abap_on.
                            l_punts = l_punts * ( <ls_crit_punt>-z_punt_max / 85 ).
                          ENDIF.
                        ELSEIF ws_info_formula-z_form_val_econ = 'V75'. "SPEC-75237
                          "PEi = 35 * ( 1 - (Oi – Omin) / IL )
                          l_punts = 35 * ( 1 - ( <ls_ofertax>-z_imp_oferta_b - my_formula_ve_n-z_imp_ofertamin ) / my_exp_cont-z_pres_licit_b ).
                          """ FIN ETOVB SPEC-73208
                        ELSEIF ws_info_formula-z_form_val_econ = 'V76'. "PEi = 89,74 * ( 1 - (Oi – Omin) / IL ) "" INI SPEC-76051 ECJBG

*                          l_punts = 35 * ( 1 - ( <ls_ofertax>-z_imp_oferta_b - my_formula_ve_n-z_imp_ofertamin ) / my_exp_cont-z_pres_licit_b ).
                          l_punts = 8974 / 100 * ( 1 - ( <ls_ofertax>-tip_econ_ofer-import_var - my_formula_ve_n-z_imp_ofertamin_var ) / lv_pres_licit_variable ).
                        ELSEIF ws_info_formula-z_form_val_econ = 'V77'. "PEi = 89,74 * ( 1 - (Oi – Omin) / IL ) "" SPEC-76051 ECJBG

*                          l_punts = 35 * ( 1 - ( <ls_ofertax>-z_imp_oferta_b - my_formula_ve_n-z_imp_ofertamin ) / my_exp_cont-z_pres_licit_b ).
                          l_punts = 100 * ( 1 - ( <ls_ofertax>-tip_econ_ofer-import_var - my_formula_ve_n-z_imp_ofertamin_var ) / lv_pres_licit_variable ).
                          ">> SPEC-82871, Inici Modificació - EVCHA
                        ELSEIF ws_info_formula-z_form_val_econ = 'V81'. "PEi = 70 * ( 1 - (Oi – Omin) / IL )

                          l_punts = 70 * ( 1 - ( <ls_ofertax>-tip_econ_ofer-import_var - my_formula_ve_n-z_imp_ofertamin_var ) / lv_pres_licit_variable ).
                          "<< SPEC-82871, Final Modificació - EVCHA
                        ENDIF."" FIN SPEC-76051 ECJBG
*** FIN "SPEC-72119 ECJBG
*>> Fi SPEC-39884 ETXGL
                      WHEN OTHERS.
                        MESSAGE e035 WITH ws_info_formula-z_form_val_econ INTO l_dummy .
                        zcx_rm_valoracio=>raise_from_message( ) .
                    ENDCASE.
                  WHEN OTHERS. CONTINUE .
                ENDCASE .
                IF <ls_punt_gen>-z_punts NE l_punts .
*             IF my_exp_cont-z_rd817_2009 IS NOT INITIAL AND
*                <ls_punt_gen>-z_punts IS INITIAL.
*               ex_changed = space.
*             ELSE.
                  ex_changed = 'X' .
*             ENDIF.
                ENDIF .
                <ls_punt_gen>-z_punts         = l_punts .
                ">>>SPEC-56319, Inici modificació  - ETODR
                IF l_punts_no_pond IS NOT INITIAL.
                  <ls_punt_gen>-z_punts_no_pond = l_punts_no_pond.
                ENDIF.
                "<<<SPEC-56319, Final modificació - ETODR
              CATCH cx_sy_zerodivide
                    cx_sy_conversion_overflow
                    cx_sy_arithmetic_overflow .
                MESSAGE e038 WITH <ls_punt_gen>-z_num_gen INTO l_dummy .
                zcx_rm_valoracio=>raise_from_message( ) .
            ENDTRY .
**>> INI OVB SPEC-37724
          ELSE.
            CLEAR <ls_punt_gen>-z_punts.
          ENDIF.
**<< FIN OVB
          ">> SPEC-83700, Inici Modificació - ETODR
          "Verifiquem que no superi el màxim
          READ TABLE my_crit_punt ASSIGNING FIELD-SYMBOL(<fs_crit_punt_max_ve>) WITH KEY z_codi_crit_punt = <ls_punt_gen>-z_codi_crit_punt.
          IF sy-subrc = 0.
            IF <ls_punt_gen>-z_punts > <fs_crit_punt_max_ve>-z_punt_max.
              <ls_punt_gen>-z_punts = <fs_crit_punt_max_ve>-z_punt_max.
            ENDIF.
          ENDIF.
          "<< SPEC-83700, Final Modificació - ETODR
        ENDLOOP .
      ENDLOOP .
    ENDLOOP .

  ENDMETHOD.


  METHOD recalculate_val_econ_sim.
    DATA: lr_valoracio_ofertes TYPE REF TO zrm_cl_valoracio_ofertes.

    FIELD-SYMBOLS: <lt_ofertesx>  TYPE ty_t_ofertax,
                   <lt_punt_ofer> TYPE ty_t_punt_gen,
                   <ls_ofertax>   TYPE ty_s_ofertax.

    SELECT SINGLE z_num_plec FROM zrm_dt_exp_cont INTO @DATA(lv_plec_bases) WHERE docclass EQ @im_docclass
                                                                              AND objectid EQ @im_objectid.

    SELECT SINGLE z_mod_crit_punt FROM zrm_dm_plecs INTO @DATA(lv_mod_crit_punt) WHERE z_num_plec = @lv_plec_bases.
    SELECT * FROM zrm_dm_crit_punt INTO TABLE @DATA(lt_crit_punt) WHERE z_mod_crit_punt = @lv_mod_crit_punt.
    SELECT SINGLE z_cri_din FROM zrm_dm_mod_crit INTO @DATA(lv_dyn) WHERE z_mod_crit_punt = @lv_mod_crit_punt.


    CREATE OBJECT lr_valoracio_ofertes
      EXPORTING
        im_docclass = im_docclass
        im_objectid = im_objectid
        im_action   = co_mode_punt_quadre3a
        is_dynamic  = lv_dyn.

    lr_valoracio_ofertes->start( IMPORTING ex_first_time = DATA(l_first_time) ) .
    TRY.
        lr_valoracio_ofertes->sim_recalc_val_econ( IMPORTING ex_punt_ofer = DATA(lt_punt_gen) ).

        LOOP AT lt_crit_punt ASSIGNING FIELD-SYMBOL(<fs_crit_punt>) WHERE z_crit_ve = abap_on. "Ens quedem amb els criteris econòmics
          LOOP AT lt_punt_gen ASSIGNING FIELD-SYMBOL(<fs_puntuacio_econ>) WHERE z_codi_crit_punt = <fs_crit_punt>-z_codi_crit_punt.
            INSERT <fs_puntuacio_econ> INTO TABLE ex_punt_gen. "SPEC-49921
*            APPEND <fs_puntuacio_econ> TO ex_punt_gen.
          ENDLOOP.
        ENDLOOP.

      CATCH zcx_rm_valoracio .
        RAISE EXCEPTION TYPE zcx_rm_valoracio .
    ENDTRY.

  ENDMETHOD.


METHOD recalculate_val_tecnic.
  DATA:           lt_num_gen     TYPE TABLE OF ty_s_punt_gen-z_num_gen,
                  l_num_gen      TYPE ty_s_punt_gen-z_num_gen,
                  l_num_crits    TYPE i,
                  l_max_v        TYPE z_punts,
                  l_diff_v       TYPE z_punts,
                  l_punts_before TYPE z_punts,
                  l_tabix        TYPE i,
                  l_type_val     TYPE z_tipus_crit,
                  l_decimals     TYPE decfloat34.

  FIELD-SYMBOLS: <ls_crit_punt> TYPE ty_s_crit_punt,
                 <ls_punt_gen>  TYPE ty_s_punt_gen,
                 <ls_ofertax>   TYPE ty_s_ofertax.

  CLEAR ex_changed .

*  CHECK my_exp_cont-z_vo_conf_dades   IS INITIAL .

  LOOP AT ch_punt_gen ASSIGNING <ls_punt_gen> .
    AT NEW z_num_gen .
**    >> SPEC-53119 ETODR Només ha de recuperar aquelles que no han renunciat
      READ TABLE my_ofertesx TRANSPORTING NO FIELDS WITH KEY z_num_ofer = <ls_punt_gen>-z_num_gen.
      IF sy-subrc <> 0. CONTINUE. ENDIF.
**    << SPEC-53119 ETODR
      APPEND <ls_punt_gen>-z_num_gen TO lt_num_gen .
    ENDAT .
  ENDLOOP .

* Agafem un criteri i el calculem per a totes les ofertes/lemes. Després agafem
* el següent criteri i fem el mateix. El mètode SUMMATORY confia en aquesta manera
* de recòrrer la taula a l'hora de fer el rescalat de les puntuacions tècniques.
* Calculem els en ordre invers per tal de no tenir problemes amb sumatoris de sumatoris
  DESCRIBE TABLE im_crit_punt LINES l_num_crits .
  l_tabix = l_num_crits .
  DO l_num_crits TIMES .
    READ TABLE im_crit_punt ASSIGNING <ls_crit_punt> INDEX l_tabix .
    l_tabix = l_tabix - 1 .

    CHECK NOT <ls_crit_punt>-sum_info IS INITIAL .
    LOOP AT lt_num_gen INTO l_num_gen .
      READ TABLE ch_punt_gen ASSIGNING <ls_punt_gen>
              WITH TABLE KEY z_codi_crit_punt = <ls_crit_punt>-z_codi_crit_punt
                             z_mod_crit_punt  = <ls_crit_punt>-z_mod_crit_punt
                             z_num_gen        = l_num_gen .

* Important: si una oferta està exclosa o és temerèria no (re)calculem la seva valoració
* tècnica. Si, pel que fos, l'oferta ja estava puntuada la deixem tal com estava. No
* aplica per a lemes.
      IF check_activity( co_act_punct_1st ) IS NOT INITIAL.
        READ TABLE my_ofertesx ASSIGNING <ls_ofertax>
             WITH TABLE KEY z_num_ofer = <ls_punt_gen>-z_num_gen .
        CHECK: <ls_ofertax>-exclos IS INITIAL .
      ENDIF.

      l_punts_before = <ls_punt_gen>-z_punts.
      CALL METHOD summatory
        EXPORTING
          im_sum_info  = <ls_crit_punt>-sum_info
          im_crit_punt = im_crit_punt
          im_num_gen   = l_num_gen
          im_punt_gen  = ch_punt_gen
        CHANGING
          ch_sum       = <ls_punt_gen>-z_punts.

**>> INI MODIF ETODR SPEC-51135
      IF <ls_punt_gen>-z_punts GT <ls_crit_punt>-z_punt_max. "Si la puntuació dels subapartats superA el maxim del apartar el sustituim per el maxim
        <ls_punt_gen>-z_punts = <ls_crit_punt>-z_punt_max.
      ENDIF.
**<< FI MODIF ETODR SPEC-51135

**>> INI MODIF ETODR SPEC-46407
      IF <ls_punt_gen>-z_punts < 0. "Si és un criteri amb puntuació negativa es comprova que el sumatori total no sigui inferior a 0
        CLEAR: <ls_punt_gen>-z_punts.
      ENDIF.
**<< FI MODIF ETODR SPEC-46407
      IF      ( <ls_crit_punt>-z_crit_ve EQ co_crit_val_tecnic OR <ls_crit_punt>-z_crit_ve EQ 'F' ) "SPEC-48889 ETLJS
          AND <ls_punt_gen>-z_punts GT l_max_v .
        l_max_v = <ls_punt_gen>-z_punts .
      ELSEIF  <ls_crit_punt>-z_crit_ve EQ co_crit_punt_tecnic.
* Arribem aquí SEMPRE després d'haver calculat el criteri de tipus V
* perquè calculem des del final cap al principi
        IF l_type_val EQ 'F'.
          <ls_punt_gen>-z_punts = <ls_punt_gen>-z_punts * l_decimals.
        ELSE.
          ADD l_diff_v TO <ls_punt_gen>-z_punts .
        ENDIF.
      ENDIF .
      IF l_punts_before NE <ls_punt_gen>-z_punts AND
        <ls_crit_punt>-z_crit_ve <> co_codi_crit_total.
        ex_changed = 'X' .
      ENDIF .
    ENDLOOP .
    IF  <ls_crit_punt>-z_crit_ve EQ co_crit_val_tecnic .
      l_diff_v = <ls_crit_punt>-z_punt_max - l_max_v .
      l_type_val = <ls_crit_punt>-z_crit_ve.
*      >> INI SPEC-48889 ETLJS Añadir nueva fórmula
    ELSEIF  <ls_crit_punt>-z_crit_ve EQ 'F' AND l_max_v IS NOT INITIAL.
      l_decimals = <ls_crit_punt>-z_punt_max / l_max_v .
      l_type_val = <ls_crit_punt>-z_crit_ve.
*      << FIN SPEC-48889 ETLJS Añadir nueva fórmula
    ENDIF .
  ENDDO .
ENDMETHOD.


METHOD recalculate_val_tecnic2.
  DATA:           lt_num_gen     TYPE TABLE OF ty_s_punt_gen-z_num_gen,
                  l_num_gen      TYPE ty_s_punt_gen-z_num_gen,
                  l_num_crits    TYPE i,
                  l_max_v        TYPE z_punts,
                  l_diff_v       TYPE z_punts,
                  l_punts_before TYPE z_punts,
                  l_tabix        TYPE i,
                  l_type_val     TYPE z_tipus_crit,
                  l_decimals     TYPE decfloat34.

  FIELD-SYMBOLS: <ls_crit_punt> TYPE ty_s_crit_punt,
                 <ls_punt_gen>  TYPE ty_s_punt_gen,
                 <ls_ofertax>   TYPE ty_s_ofertax.

  CLEAR ex_changed .

*  CHECK my_exp_cont-z_vo_conf_dades   IS INITIAL .

  LOOP AT ch_punt_gen ASSIGNING <ls_punt_gen> .
    AT NEW z_num_gen .
      APPEND <ls_punt_gen>-z_num_gen TO lt_num_gen .
    ENDAT .
  ENDLOOP .

* Agafem un criteri i el calculem per a totes les ofertes/lemes. Després agafem
* el següent criteri i fem el mateix. El mètode SUMMATORY confia en aquesta manera
* de recòrrer la taula a l'hora de fer el rescalat de les puntuacions tècniques.
* Calculem els en ordre invers per tal de no tenir problemes amb sumatoris de sumatoris
  DESCRIBE TABLE im_crit_punt LINES l_num_crits .
  l_tabix = l_num_crits .
  DO l_num_crits TIMES .
    READ TABLE im_crit_punt ASSIGNING <ls_crit_punt> INDEX l_tabix .
    l_tabix = l_tabix - 1 .

    CHECK NOT <ls_crit_punt>-sum_info IS INITIAL .
    LOOP AT lt_num_gen INTO l_num_gen .
      READ TABLE ch_punt_gen ASSIGNING <ls_punt_gen>
              WITH TABLE KEY z_codi_crit_punt = <ls_crit_punt>-z_codi_crit_punt
                             z_mod_crit_punt  = <ls_crit_punt>-z_mod_crit_punt
                             z_num_gen        = l_num_gen .

      l_punts_before = <ls_punt_gen>-z_punts.
      CALL METHOD summatory
        EXPORTING
          im_sum_info  = <ls_crit_punt>-sum_info
          im_crit_punt = im_crit_punt
          im_num_gen   = l_num_gen
          im_punt_gen  = ch_punt_gen
        CHANGING
          ch_sum       = <ls_punt_gen>-z_punts.

**>> INI MODIF ETODR SPEC-51135
      IF <ls_punt_gen>-z_punts GT <ls_crit_punt>-z_punt_max. "Si la puntuació dels subapartats superA el maxim del apartar el sustituim per el maxim
        <ls_punt_gen>-z_punts = <ls_crit_punt>-z_punt_max.
      ENDIF.
**<< FI MODIF ETODR SPEC-51135

**    >> INI MODIF ETODR SPEC-50770
      <ls_punt_gen>-z_punts_no_pond = <ls_punt_gen>-z_punts.
**    << FI MODIF ETODR SPEC-50770
* Important: si una oferta està exclosa o és temerèria no (re)calculem la seva valoració
* tècnica. Si, pel que fos, l'oferta ja estava puntuada la deixem tal com estava. No
* aplica per a lemes.
      IF check_activity( co_act_punct_1st ) IS NOT INITIAL.
        READ TABLE my_ofertesx ASSIGNING <ls_ofertax>
             WITH TABLE KEY z_num_ofer = <ls_punt_gen>-z_num_gen .
***INI OVB SPEC-37724
*       Avaluar si està exclòs per la puntuació tècnica (mínim)
        IF <ls_crit_punt>-z_punt_min IS NOT INITIAL.
          IF <ls_crit_punt>-z_punt_min > <ls_punt_gen>-z_punts.
            <ls_ofertax>-exclos_pt = 'X'.
          ELSE.
            CLEAR <ls_ofertax>-exclos_pt.
          ENDIF.

        ENDIF.
***FIN OVB

      ENDIF.

**>> INI MODIF ETODR SPEC-46407
      IF <ls_punt_gen>-z_punts < 0. "Si és un criteri amb puntuació negativa es comprova que el sumatori total no sigui inferior a 0
        CLEAR: <ls_punt_gen>-z_punts.
      ENDIF.
**<< FI MODIF ETODR SPEC-46407

      IF      ( <ls_crit_punt>-z_crit_ve EQ co_crit_val_tecnic OR <ls_crit_punt>-z_crit_ve EQ 'F' ) "SPEC-48889 ETLJS
          AND <ls_punt_gen>-z_punts GT l_max_v .
        l_max_v = <ls_punt_gen>-z_punts .
      ELSEIF  <ls_crit_punt>-z_crit_ve EQ co_crit_punt_tecnic.
* Arribem aquí SEMPRE després d'haver calculat el criteri de tipus V
* perquè calculem des del final cap al principi
        IF l_type_val EQ 'F'.
          <ls_punt_gen>-z_punts = <ls_punt_gen>-z_punts * l_decimals.
        ELSE.
          ADD l_diff_v TO <ls_punt_gen>-z_punts .
        ENDIF.
      ENDIF .
      IF l_punts_before NE <ls_punt_gen>-z_punts AND
        <ls_crit_punt>-z_crit_ve <> co_codi_crit_total.
        ex_changed = 'X' .
      ENDIF .
    ENDLOOP .
    IF  <ls_crit_punt>-z_crit_ve EQ co_crit_val_tecnic .
      l_diff_v = <ls_crit_punt>-z_punt_max - l_max_v .
      l_type_val = <ls_crit_punt>-z_crit_ve.
*      >> INI SPEC-48889 ETLJS Añadir nueva fórmula
    ELSEIF  <ls_crit_punt>-z_crit_ve EQ 'F' AND l_max_v IS NOT INITIAL.
      l_decimals = <ls_crit_punt>-z_punt_max / l_max_v .
      l_type_val = <ls_crit_punt>-z_crit_ve.
*      << FIN SPEC-48889 ETLJS Añadir nueva fórmula
    ENDIF .
  ENDDO .

ENDMETHOD.


  METHOD recalculate_val_tecnic2_dyn.
    DATA:           lt_num_gen            TYPE TABLE OF ty_s_punt_gen-z_num_gen,
                    l_num_gen             TYPE ty_s_punt_gen-z_num_gen,
                    l_num_crits           TYPE i,
                    l_max_v               TYPE z_punts,
                    l_diff_v              TYPE z_punts,
                    l_punts_before        TYPE z_punts,
                    l_tabix               TYPE i,
                    l_type_val            TYPE z_tipus_crit,
                    l_decimals            TYPE decfloat34,
                    lv_crit_dep_no_aplica TYPE xfeld. "SPEC-52568

    FIELD-SYMBOLS: <ls_crit_punt> TYPE ty_s_crit_punt,
                   <ls_punt_gen>  TYPE ty_s_punt_gen,
                   <ls_ofertax>   TYPE ty_s_ofertax.

    CLEAR ex_changed .

    LOOP AT ch_punt_gen ASSIGNING <ls_punt_gen> .
      AT NEW z_num_gen .
        APPEND <ls_punt_gen>-z_num_gen TO lt_num_gen .
      ENDAT .
    ENDLOOP .
    IF i_recalculated = abap_on.
      DELETE ADJACENT DUPLICATES FROM lt_num_gen.
    ENDIF.
* Agafem un criteri i el calculem per a totes les ofertes/lemes. Després agafem
* el següent criteri i fem el mateix. El mètode SUMMATORY confia en aquesta manera
* de recòrrer la taula a l'hora de fer el rescalat de les puntuacions tècniques.
* Calculem els en ordre invers per tal de no tenir problemes amb sumatoris de sumatoris
    DESCRIBE TABLE im_crit_punt LINES l_num_crits .
    l_tabix = l_num_crits .
    DO l_num_crits TIMES .
      READ TABLE im_crit_punt ASSIGNING <ls_crit_punt> INDEX l_tabix .
      l_tabix = l_tabix - 1 .

      CHECK NOT <ls_crit_punt>-sum_info IS INITIAL .
      LOOP AT lt_num_gen INTO l_num_gen .
        READ TABLE ch_punt_gen ASSIGNING <ls_punt_gen>
                WITH TABLE KEY z_codi_crit_punt = <ls_crit_punt>-z_codi_crit_punt
                               z_mod_crit_punt  = <ls_crit_punt>-z_mod_crit_punt
                               z_num_gen        = l_num_gen .

        l_punts_before = <ls_punt_gen>-z_punts.

* Important: si una oferta està exclosa o és temerèria no (re)calculem la seva valoració
* tècnica. Si, pel que fos, l'oferta ja estava puntuada la deixem tal com estava. No
* aplica per a lemes.
        IF check_activity( co_act_punct_1st ) IS NOT INITIAL.
          READ TABLE my_ofertesx ASSIGNING <ls_ofertax>
               WITH TABLE KEY z_num_ofer = <ls_punt_gen>-z_num_gen .
***INI OVB SPEC-37724
*       Avaluar si està exclòs per la puntuació tècnica (mínim)
          IF <ls_crit_punt>-z_punt_min IS NOT INITIAL.
            IF <ls_crit_punt>-z_punt_min > <ls_punt_gen>-z_punts.
              <ls_ofertax>-exclos_pt = 'X'.
            ELSE.
              CLEAR <ls_ofertax>-exclos_pt.
            ENDIF.

          ENDIF.
***FIN OVB

        ENDIF.
        l_punts_before = <ls_punt_gen>-z_punts.
        "Només fem el sumatori si no hi ha cap criteri que no apliqui o si és el criteri tècnic o el criteri fictici total
        IF i_recalculated = abap_off OR <ls_crit_punt>-z_crit_ve = co_crit_tecnic OR <ls_crit_punt>-z_codi_crit_punt IS INITIAL.
          CALL METHOD summatory
            EXPORTING
              im_sum_info  = <ls_crit_punt>-sum_info
              im_crit_punt = im_crit_punt
              im_num_gen   = l_num_gen
              im_punt_gen  = ch_punt_gen
            CHANGING
              ch_sum       = <ls_punt_gen>-z_punts.
        ENDIF.

**>> INI MODIF ETJMD SPEC-49499
        IF <ls_punt_gen>-z_punts GT <ls_crit_punt>-z_punt_max. "Si la puntuació dels subapartats super el maxim del apartar el sustituim per el maxim
**        >> INI MODIF ETODR SPEC-52568
          "Hi ha casos en que quan s'aplica un coeficient multiplicador, al criteri afectat se li incremente el màxim
          lv_crit_dep_no_aplica = abap_off.
          IF <ls_crit_punt>-z_crit_depenent IS NOT INITIAL.
            READ TABLE im_crit_punt TRANSPORTING NO FIELDS WITH KEY z_no_aplica      = abap_on
                                                                    z_codi_crit_punt = <ls_crit_punt>-z_crit_depenent.
            IF sy-subrc = 0.
              lv_crit_dep_no_aplica = abap_on.
            ENDIF.
          ENDIF.
          IF lv_crit_dep_no_aplica = abap_on.
            IF <ls_punt_gen>-z_punts GT <ls_crit_punt>-z_sum_mes_max.
              <ls_punt_gen>-z_punts = <ls_crit_punt>-z_sum_mes_max.
            ENDIF.
          ELSE.
**        << FI MODIF ETODR SPEC-52568
            <ls_punt_gen>-z_punts = <ls_crit_punt>-z_punt_max.
          ENDIF.
        ENDIF.
**<< FI MODIF ETJMD SPEC-49499

**>> INI MODIF ETODR SPEC-46407
        IF <ls_punt_gen>-z_punts < 0. "Si és un criteri amb puntuació negativa es comprova que el sumatori total no sigui inferior a 0
          CLEAR: <ls_punt_gen>-z_punts.
        ENDIF.
**<< FI MODIF ETODR SPEC-46407

        IF      ( <ls_crit_punt>-z_crit_ve EQ co_crit_val_tecnic OR <ls_crit_punt>-z_crit_ve EQ 'F' ) "SPEC-48889 ETLJS
            AND <ls_punt_gen>-z_punts GT l_max_v .
          l_max_v = <ls_punt_gen>-z_punts .
        ELSEIF  <ls_crit_punt>-z_crit_ve EQ co_crit_punt_tecnic.
* Arribem aquí SEMPRE després d'haver calculat el criteri de tipus V
* perquè calculem des del final cap al principi
          IF l_type_val EQ 'F'.
            <ls_punt_gen>-z_punts = <ls_punt_gen>-z_punts * l_decimals.
          ELSE.
            ADD l_diff_v TO <ls_punt_gen>-z_punts .
          ENDIF.
        ENDIF .
        IF l_punts_before NE <ls_punt_gen>-z_punts AND
          <ls_crit_punt>-z_crit_ve <> co_codi_crit_total.
          ex_changed = 'X' .
        ENDIF .
      ENDLOOP .
      IF  <ls_crit_punt>-z_crit_ve EQ co_crit_val_tecnic .
        l_diff_v = <ls_crit_punt>-z_punt_max - l_max_v .
        l_type_val = <ls_crit_punt>-z_crit_ve.
*      >> INI SPEC-48889 ETLJS Añadir nueva fórmula
      ELSEIF  <ls_crit_punt>-z_crit_ve EQ 'F' AND l_max_v IS NOT INITIAL.
        l_decimals = <ls_crit_punt>-z_punt_max / l_max_v .
        l_type_val = <ls_crit_punt>-z_crit_ve.
*      << FIN SPEC-48889 ETLJS Añadir nueva fórmula
      ENDIF .
    ENDDO .

  ENDMETHOD.


  METHOD recalculate_val_tecnic_dyn.
    DATA:           lt_num_gen     TYPE TABLE OF ty_s_punt_gen-z_num_gen,
                    l_num_gen      TYPE ty_s_punt_gen-z_num_gen,
                    l_num_crits    TYPE i,
                    l_max_v        TYPE z_punts,
                    l_diff_v       TYPE z_punts,
                    l_punts_before TYPE z_punts,
                    l_tabix        TYPE i,
                    l_type_val     TYPE z_tipus_crit,
                    l_decimals     TYPE decfloat34.

    FIELD-SYMBOLS: <ls_crit_punt> TYPE ty_s_crit_punt,
                   <ls_punt_gen>  TYPE ty_s_punt_gen,
                   <ls_ofertax>   TYPE ty_s_ofertax.

    CLEAR ex_changed .

    LOOP AT ch_punt_gen ASSIGNING <ls_punt_gen> .
      AT NEW z_num_gen .
        APPEND <ls_punt_gen>-z_num_gen TO lt_num_gen .
      ENDAT .
    ENDLOOP .
    IF i_recalculated = abap_on.
      DELETE ADJACENT DUPLICATES FROM lt_num_gen.
    ENDIF.
* Agafem un criteri i el calculem per a totes les ofertes/lemes. Després agafem
* el següent criteri i fem el mateix. El mètode SUMMATORY confia en aquesta manera
* de recòrrer la taula a l'hora de fer el rescalat de les puntuacions tècniques.
* Calculem els en ordre invers per tal de no tenir problemes amb sumatoris de sumatoris
    DESCRIBE TABLE im_crit_punt LINES l_num_crits .
    l_tabix = l_num_crits .
    DO l_num_crits TIMES .
      READ TABLE im_crit_punt ASSIGNING <ls_crit_punt> INDEX l_tabix .
      l_tabix = l_tabix - 1 .

      CHECK NOT <ls_crit_punt>-sum_info IS INITIAL .
      LOOP AT lt_num_gen INTO l_num_gen .
        READ TABLE ch_punt_gen ASSIGNING <ls_punt_gen>
                WITH TABLE KEY z_codi_crit_punt = <ls_crit_punt>-z_codi_crit_punt
                               z_mod_crit_punt  = <ls_crit_punt>-z_mod_crit_punt
                               z_num_gen        = l_num_gen .

* Important: si una oferta està exclosa o és temerèria no (re)calculem la seva valoració
* tècnica. Si, pel que fos, l'oferta ja estava puntuada la deixem tal com estava. No
* aplica per a lemes.
        IF check_activity( co_act_punct_1st ) IS NOT INITIAL.
          READ TABLE my_ofertesx ASSIGNING <ls_ofertax>
               WITH TABLE KEY z_num_ofer = <ls_punt_gen>-z_num_gen .
          CHECK: <ls_ofertax>-exclos IS INITIAL .
        ENDIF.
        l_punts_before = <ls_punt_gen>-z_punts.
        "Només fem el sumatori si no hi ha cap criteri que no apliqui o si és el criteri tècnic o el criteri fictici total
        IF i_recalculated = abap_off OR <ls_crit_punt>-z_crit_ve = co_crit_tecnic OR <ls_crit_punt>-z_codi_crit_punt IS INITIAL.
          CALL METHOD summatory
            EXPORTING
              im_sum_info  = <ls_crit_punt>-sum_info
              im_crit_punt = im_crit_punt
              im_num_gen   = l_num_gen
              im_punt_gen  = ch_punt_gen
            CHANGING
              ch_sum       = <ls_punt_gen>-z_punts.
        ENDIF.
**>> INI MODIF ETODR SPEC-46407
        IF <ls_punt_gen>-z_punts < 0. "Si és un criteri amb puntuació negativa es comprova que el sumatori total no sigui inferior a 0
          CLEAR: <ls_punt_gen>-z_punts.
        ENDIF.
**<< FI MODIF ETODR SPEC-46407
        IF     ( <ls_crit_punt>-z_crit_ve EQ co_crit_val_tecnic OR <ls_crit_punt>-z_crit_ve EQ 'F' ) "SPEC-48889 ETLJS
            AND <ls_punt_gen>-z_punts GT l_max_v .
          l_max_v = <ls_punt_gen>-z_punts .
        ELSEIF  <ls_crit_punt>-z_crit_ve EQ co_crit_punt_tecnic.
* Arribem aquí SEMPRE després d'haver calculat el criteri de tipus V
* perquè calculem des del final cap al principi
          IF l_type_val EQ 'F'.
            <ls_punt_gen>-z_punts = <ls_punt_gen>-z_punts * l_decimals.
          ELSE.
            ADD l_diff_v TO <ls_punt_gen>-z_punts .
          ENDIF.
        ENDIF .
        IF l_punts_before NE <ls_punt_gen>-z_punts AND
          <ls_crit_punt>-z_crit_ve <> co_codi_crit_total.
          ex_changed = 'X' .
        ENDIF .
      ENDLOOP .
      IF  <ls_crit_punt>-z_crit_ve EQ co_crit_val_tecnic .
        l_diff_v = <ls_crit_punt>-z_punt_max - l_max_v .
        l_type_val = <ls_crit_punt>-z_crit_ve.
*      >> INI SPEC-48889 ETLJS Añadir nueva fórmula
      ELSEIF  <ls_crit_punt>-z_crit_ve EQ 'F' AND l_max_v IS NOT INITIAL.
        l_decimals = <ls_crit_punt>-z_punt_max / l_max_v .
        l_type_val = <ls_crit_punt>-z_crit_ve.
*      << FIN SPEC-48889 ETLJS Añadir nueva fórmula
      ENDIF .
    ENDDO .
  ENDMETHOD.


METHOD recalculate_val_term.
  DATA: l_dummy          TYPE c,                            "#EC NEEDED
        l_punts          TYPE ty_s_punt_gen-z_punts,
        l_smallest_index TYPE i,
        l_smallest_unit  TYPE zrm_dt_exp_cont-z_unit_term_exec,
        l_term_licit     TYPE zrm_dt_exp_cont-z_termini_exec,
        l_term_offer     TYPE zrm_dt_ofertes-z_termini_exec,
        l_d(10)          TYPE p DECIMALS 4,
        lt_unit_scale    TYPE TABLE OF zrm_dt_exp_cont-z_unit_term_exec .

  FIELD-SYMBOLS: <ls_punt_gen>  TYPE ty_s_punt_gen,
                 <ls_crit_punt> TYPE ty_s_crit_punt,
                 <ls_ofertax>   TYPE ty_s_ofertax .

  CHECK: my_formula_vt-z_codi_form IS NOT INITIAL.

  IF my_exp_cont-z_termini_exec IS INITIAL .
    MESSAGE e079 INTO l_dummy .
    zcx_rm_valoracio=>raise_from_message( ) .
  ENDIF .

* Ens creem una taula on fiquem les unitats de més petita a més gran
  APPEND: zrm_cl_time_utils=>co_rms_hora    TO lt_unit_scale,
          zrm_cl_time_utils=>co_rms_dia     TO lt_unit_scale,
          zrm_cl_time_utils=>co_rms_setmana TO lt_unit_scale,
          zrm_cl_time_utils=>co_rms_mes     TO lt_unit_scale,
          zrm_cl_time_utils=>co_rms_any     TO lt_unit_scale.

  l_smallest_unit = my_exp_cont-z_unit_term_exec .
  READ TABLE lt_unit_scale WITH TABLE KEY table_line = my_exp_cont-z_unit_term_exec
        TRANSPORTING NO FIELDS .
  IF sy-subrc NE 0 .
    MESSAGE e077 INTO l_dummy .
    zcx_rm_valoracio=>raise_from_message( ) .
  ENDIF .
  l_smallest_index = sy-tabix .

* Mirem quina és la unitat de temps més petita de temps que tenim -------------------------
  IF l_smallest_index NE 1 .
    LOOP AT my_ofertesx ASSIGNING <ls_ofertax> WHERE exclos IS INITIAL .
      READ TABLE lt_unit_scale WITH TABLE KEY table_line = <ls_ofertax>-z_unit_term_exec
            TRANSPORTING NO FIELDS .
      IF sy-subrc NE 0 .
        MESSAGE e078 WITH <ls_ofertax>-z_num_ofer INTO l_dummy .
        zcx_rm_valoracio=>raise_from_message( ) .
      ENDIF .
      IF sy-tabix LT l_smallest_index .
        l_smallest_unit  = <ls_ofertax>-z_unit_term_exec .
        l_smallest_index = sy-tabix .
      ENDIF .
      IF l_smallest_index EQ 1 .
        EXIT .
      ENDIF .
    ENDLOOP .
  ENDIF .

*-- Convertim el termini de licitació a la unitat més petita de temps -------------------
  CALL METHOD zrm_cl_time_utils=>unit_conversion_rms
    EXPORTING
      im_from_unit = my_exp_cont-z_unit_term_exec
      im_to_unit   = l_smallest_unit
      im_input     = my_exp_cont-z_termini_exec
    IMPORTING
      ex_output    = l_term_licit
    EXCEPTIONS
      OTHERS       = 3.
  IF sy-subrc <> 0.
    zcx_rm_valoracio=>raise_from_message( ) .
  ENDIF.

  CLEAR ex_changed .
  LOOP AT im_crit_punt ASSIGNING <ls_crit_punt> WHERE z_crit_ve EQ co_crit_termini .
    LOOP AT ch_punt_gen ASSIGNING <ls_punt_gen>
              WHERE     z_codi_crit_punt EQ <ls_crit_punt>-z_codi_crit_punt
                    AND z_mod_crit_punt  EQ <ls_crit_punt>-z_mod_crit_punt .

* Important: si una oferta està exclosa o és temerèria no (re)calculem la seva valoració
* de terminis. Si, pel que fos, l'oferta ja estava puntuada la deixem tal com estava
      READ TABLE my_ofertesx ASSIGNING <ls_ofertax>
           WITH TABLE KEY z_num_ofer = <ls_punt_gen>-z_num_gen .
      CHECK <ls_ofertax>-exclos IS INITIAL .

      CALL METHOD zrm_cl_time_utils=>unit_conversion_rms
        EXPORTING
          im_from_unit = <ls_ofertax>-z_unit_term_exec
          im_to_unit   = l_smallest_unit
          im_input     = <ls_ofertax>-z_termini_exec
        IMPORTING
          ex_output    = l_term_offer
        EXCEPTIONS
          OTHERS       = 3.
      IF sy-subrc <> 0.
        zcx_rm_valoracio=>raise_from_message( ) .
      ENDIF.

* Qualsevol oferta amb termini d'execució més gran que el de licitació estarà exclosa
* però per si de cas ho comprovem.
      IF l_term_offer GT l_term_licit .
        MESSAGE e080 WITH <ls_ofertax>-z_num_ofer INTO l_dummy.
        zcx_rm_valoracio=>raise_from_message( ) .
      ENDIF .

      l_d = ( l_term_offer - l_term_licit ) / l_term_licit .
      IF l_d LT '0.5-' .
        l_punts = 20 .
      ELSE .
        l_punts = -40 * l_d .
      ENDIF .
      IF l_punts NE <ls_punt_gen>-z_punts .
*        IF my_exp_cont-z_rd817_2009 IS NOT INITIAL AND
*          <ls_punt_gen>-z_punts IS INITIAL.
*          ex_changed = space.
*        ELSE.
          ex_changed = 'X' .
*        ENDIF.
      ENDIF .
      <ls_punt_gen>-z_punts = l_punts .
    ENDLOOP .
  ENDLOOP .
ENDMETHOD.


METHOD RECALC_PUNT_OFFERS_INT_TEC.
  DATA: l_dummy TYPE c .                                    "#EC NEEDED
  FIELD-SYMBOLS: <ls_crit_punt> TYPE ty_s_crit_punt,
                 <ls_ofertax>   TYPE ty_s_ofertax,
                 <ls_punt_ofer> TYPE ty_s_punt_gen .


  DATA: BEGIN OF ls_codi_crit,
         codi_punt_econ    TYPE zrm_dm_crit_punt-z_codi_crit_punt,
         codi_punt_tec     TYPE zrm_dm_crit_punt-z_codi_crit_punt,
        END   OF ls_codi_crit.


* Obtenim els codis de criteris que ens serveixen per a informar cada camp de puntació
* de la taula d'ofertes...
  CLEAR ls_codi_crit .
  LOOP AT  im_crit_punt ASSIGNING <ls_crit_punt> .
    CASE <ls_crit_punt>-z_crit_ve .
      WHEN co_crit_tecnic .     ls_codi_crit-codi_punt_tec  = <ls_crit_punt>-z_codi_crit_punt .
    ENDCASE .
  ENDLOOP .


* Pas A: Inicialialitzear totes les variables rellevants -------------------------------
  LOOP AT ch_ofertesx ASSIGNING <ls_ofertax> .
    CLEAR: <ls_ofertax>-offer_data-z_punt_tec.
  ENDLOOP .

* Pas D: Informem la resta de camps de puntuació ---------------------------------------
  LOOP AT ch_ofertesx ASSIGNING <ls_ofertax> .

    IF ls_codi_crit-codi_punt_tec IS NOT INITIAL .
      READ TABLE ch_punt_ofer ASSIGNING <ls_punt_ofer>
             WITH TABLE KEY z_num_gen        = <ls_ofertax>-z_num_ofer
                            z_mod_crit_punt  = im_plec-z_mod_crit_punt
                            z_codi_crit_punt = ls_codi_crit-codi_punt_tec .
      <ls_ofertax>-offer_data-z_punt_tec = <ls_punt_ofer>-z_punts .
    ENDIF .

    READ TABLE ch_punt_ofer ASSIGNING <ls_punt_ofer>
           WITH TABLE KEY z_num_gen        = <ls_ofertax>-z_num_ofer
                          z_mod_crit_punt  = im_plec-z_mod_crit_punt
                          z_codi_crit_punt = co_codi_crit_total .
  ENDLOOP .


ENDMETHOD.


  METHOD reset_log_pt.
    CLEAR: gt_temporal_canvis_punt[].
  ENDMETHOD.


METHOD save.

  FIELD-SYMBOLS: <ls_punt> TYPE ty_s_punt_gen .

  DATA: lt_lema            TYPE STANDARD TABLE OF zrm_dt_punt_lema,
        lt_equip           TYPE STANDARD TABLE OF zrm_dt_punt_equi,
        lt_ofer            TYPE STANDARD TABLE OF zrm_dt_punt_ofer,
        lt_sol_part        TYPE STANDARD TABLE OF zrm_dt_punt_sol,
        ls_lema            TYPE zrm_dt_punt_lema,
        ls_equip           TYPE zrm_dt_punt_equi,
        ls_ofer            TYPE zrm_dt_punt_ofer,
        ls_sol_part        TYPE zrm_dt_punt_sol,
        lv_num_ofer        TYPE z_num_ofer,
        lt_crit_punt       TYPE STANDARD TABLE OF zrm_dm_crit_punt,
        ls_crit_punt       LIKE LINE OF lt_crit_punt,
        ls_punt            TYPE ty_s_punt_gen,
        lv_count           TYPE i,                 ">>>SPEC:51855,modificació  - ECFA
        lv_coeficient_iref TYPE z_coeficient_iref, ">>>SPEC:67070, modificació - ECJMS
        " >>>PSPEC-1451 Inici modificació - EVXGL
        lv_docclass_fill   TYPE bapidclass,
        lv_objectid_fill   TYPE bapiguid,
        lt_zrm_dt_punt_cap TYPE STANDARD TABLE OF zrm_dt_punt_cap,
        ls_zrm_dt_punt_cap TYPE zrm_dt_punt_cap.
  " <<<PSPEC-1451 Fi modificació - EVXGL


  CHECK my_changed IS NOT INITIAL .

  my_ob_ofertes->gravar( ) .

  CASE my_mode.
    WHEN co_mode_punt_sol_part.
      DELETE FROM zrm_dt_punt_sol WHERE docclass EQ my_docclass
                                    AND objectid EQ my_objectid .
    WHEN OTHERS.
**    >> INI MODIF ETODR SPEC-49500
*      DELETE FROM zrm_dt_punt_ofer WHERE     docclass EQ my_docclass
*                                    AND objectid EQ my_objectid .
**    << FI MODIF ETODR SPEC-49500
      SELECT *
       FROM zrm_dt_punt_equi
        INTO TABLE @DATA(lt_equip_bd)
             WHERE docclass EQ @my_docclass
               AND objectid EQ @my_objectid.
*      DELETE FROM zrm_dt_punt_equi WHERE     docclass EQ my_docclass "ETLJS SPEC-47173    "SPEC-49500
*                                    AND objectid EQ my_objectid .
      DELETE FROM zrm_dt_punt_lema WHERE docclass EQ my_docclass
                                     AND objectid EQ my_objectid .
  ENDCASE.


  IF my_mode = co_mode_punct_tec.
    SELECT *
     INTO CORRESPONDING FIELDS OF TABLE lt_crit_punt
      FROM zrm_dm_crit_punt
       WHERE z_mod_crit_punt EQ my_plec-z_mod_crit_punt.

    ls_crit_punt-z_mod_crit_punt = my_plec-z_mod_crit_punt.
    ls_crit_punt-z_codi_crit_punt = co_codi_crit_total.
    INSERT ls_crit_punt INTO TABLE lt_crit_punt.

    LOOP AT my_punt_ofer ASSIGNING <ls_punt> .
      IF lv_num_ofer <> <ls_punt>-z_num_gen.
        lv_num_ofer = <ls_punt>-z_num_gen.

        LOOP AT lt_crit_punt INTO ls_crit_punt.
          CLEAR ls_punt.

          READ TABLE my_punt_ofer INTO ls_punt WITH KEY z_mod_crit_punt  = ls_crit_punt-z_mod_crit_punt
                                                        z_codi_crit_punt = ls_crit_punt-z_codi_crit_punt
                                                        z_num_gen        = lv_num_ofer.

          ls_ofer-docclass         = my_docclass .
          ls_ofer-objectid         = my_objectid .
          ls_ofer-z_mod_crit_punt  = ls_crit_punt-z_mod_crit_punt .
          ls_ofer-z_codi_crit_punt = ls_crit_punt-z_codi_crit_punt .
          ls_ofer-z_num_ofer       = lv_num_ofer .
          ls_ofer-z_punts          = ls_punt-z_punts .
          APPEND ls_ofer TO lt_ofer .

          IF ls_crit_punt-z_mult_equip EQ abap_true.
            LOOP AT my_punt_ofer
             INTO ls_punt
              WHERE z_mod_crit_punt  EQ ls_crit_punt-z_mod_crit_punt AND
                    z_codi_crit_punt EQ ls_crit_punt-z_codi_crit_punt AND
                    z_num_gen        EQ lv_num_ofer.

              READ TABLE lt_equip_bd  ASSIGNING FIELD-SYMBOL(<fs_equip_bd>)
                                      WITH KEY z_codi_crit_punt = ls_crit_punt-z_codi_crit_punt
                                               z_comptador_equip = ls_punt-z_num_equip
                                               z_num_ofer = lv_num_ofer.
              IF sy-subrc EQ 0.
                READ TABLE my_crit_punt ASSIGNING FIELD-SYMBOL(<fs_crit_punt>)
                                        WITH KEY z_codi_crit_punt = ls_crit_punt-z_codi_crit_punt
                                                 z_num_equip = ls_punt-z_num_equip.
                ls_equip-docclass = my_docclass .
                ls_equip-objectid = my_objectid .
                ls_equip-z_carrec_equip = <fs_equip_bd>-z_carrec_equip.
                ls_equip-z_descripcio = <fs_equip_bd>-z_descripcio.
                ls_equip-z_sec = <fs_equip_bd>-z_sec.
                IF ls_punt-z_pes IS NOT INITIAL.
                  ls_equip-z_pes             = ls_punt-z_pes.
                ELSE.
                  ls_equip-z_pes             = <fs_equip_bd>-z_pes.
                ENDIF.
                ls_equip-z_mod_crit_punt   = ls_crit_punt-z_mod_crit_punt .
                ls_equip-z_codi_crit_punt  = ls_crit_punt-z_codi_crit_punt .
                ls_equip-z_num_ofer        = lv_num_ofer.
                ls_equip-z_punts           = ls_punt-z_punts.
                ls_equip-z_comptador_equip = ls_punt-z_num_equip.
                ls_equip-z_equip_max       = ls_punt-z_equip_max. "ETODR SPEC-49498
                APPEND ls_equip TO lt_equip.
              ENDIF.
            ENDLOOP.
          ENDIF.
        ENDLOOP.
      ENDIF.
    ENDLOOP.

    ">>>SPEC-54695, Inici modificació  - ETODR
  ELSEIF my_mode = co_mode_millor_classif.
    "Forcem a que no faci res ara
    "<<<SPEC-54695, Final modificació - ETODR

  ELSEIF my_mode = co_mode_punt_sol_part.
    LOOP AT  my_punt_sol_part ASSIGNING <ls_punt> .
      ls_sol_part-docclass         = my_docclass .
      ls_sol_part-objectid         = my_objectid .
      ls_sol_part-z_mod_crit_punt  = <ls_punt>-z_mod_crit_punt .
      ls_sol_part-z_codi_crit_punt = <ls_punt>-z_codi_crit_punt .
      ls_sol_part-z_num_ofer       = <ls_punt>-z_num_gen  .
      ls_sol_part-z_punts          = <ls_punt>-z_punts .
      APPEND ls_sol_part TO lt_sol_part .
    ENDLOOP.

  ELSE.
    SELECT *
     INTO CORRESPONDING FIELDS OF TABLE lt_crit_punt
      FROM zrm_dm_crit_punt
       WHERE z_mod_crit_punt EQ my_plec-z_mod_crit_punt .
    lt_equip = lt_equip_bd[]. "SPEC-49500

    ">> SPEC-66771, Inici Modificació - ETODR
    READ TABLE my_crit_punt TRANSPORTING NO FIELDS WITH KEY z_equip_sep = abap_on.
    IF sy-subrc = 0.
      "Amb equip separats s'estàn afegint registres duplicats dels criteris d'equip quan hi ha co-càrrecs
      "i aixo provoca després un DUMP al mètode save_change_documents( ).
      "Per tant, es netegen els duplicats ja que en aquest punt ja s'hàurà calculat la puntuació correctament
      DELETE ADJACENT DUPLICATES FROM my_punt_ofer COMPARING z_num_gen z_mod_crit_punt z_codi_crit_punt.
    ENDIF.
    "<< SPEC-66771, Final Modificació - ETODR

    LOOP AT my_punt_ofer ASSIGNING <ls_punt> . "WHERE z_codi_crit_punt NE co_codi_crit_total.
      ls_ofer-docclass         = my_docclass .
      ls_ofer-objectid         = my_objectid .
      ls_ofer-z_mod_crit_punt  = <ls_punt>-z_mod_crit_punt .
      ls_ofer-z_codi_crit_punt = <ls_punt>-z_codi_crit_punt .
      ls_ofer-z_num_ofer       = <ls_punt>-z_num_gen .
      ls_ofer-z_punts          = <ls_punt>-z_punts .
      ls_ofer-z_punts_no_pond = <ls_punt>-z_punts_no_pond. " ETLJS SPEC-51880 20.12.2018 12:11:43
      APPEND ls_ofer TO lt_ofer .
      READ TABLE lt_crit_punt INTO ls_crit_punt
            WITH KEY z_mod_crit_punt  = <ls_punt>-z_mod_crit_punt
                     z_codi_crit_punt = <ls_punt>-z_codi_crit_punt.
**    >> INI MODIF ETODR SOEC-49500
      LOOP AT lt_equip ASSIGNING FIELD-SYMBOL(<fs_equip_to_change>) WHERE z_codi_crit_punt   = <ls_punt>-z_codi_crit_punt
                                                                      AND z_comptador_equip  = <ls_punt>-z_num_equip
                                                                      AND z_num_ofer         = <ls_punt>-z_num_gen.
        <fs_equip_to_change>-z_punts = <ls_punt>-z_punts.
        <fs_equip_to_change>-z_equip_max = <ls_punt>-z_equip_max.
        IF <ls_punt>-z_pes IS NOT INITIAL.
          <fs_equip_to_change>-z_pes = <ls_punt>-z_pes.
        ENDIF.
        "ini ETLJS SPEC-49806
        READ TABLE gt_equip ASSIGNING FIELD-SYMBOL(<fs_eq>)
          WITH KEY z_codi_crit_punt = <ls_punt>-z_codi_crit_punt
                   z_comptador_equip = <ls_punt>-z_num_equip
                   z_num_ofer = <ls_punt>-z_num_gen.
        IF sy-subrc EQ 0.
          <fs_equip_to_change>-z_exclos = <fs_eq>-z_exclos.
        ENDIF.
      ENDLOOP.
**    << FI MODIF ETODR SOEC-49500
    ENDLOOP.

**  >> INI MODIF ETODR SPEC-49075
    IF get_is_nova_llei_92017( ) = abap_on AND get_is_obert_preu( ) = abap_off.
      DATA(lt_proveidors) = lt_ofer[].
      SORT lt_proveidors BY z_num_ofer.
      DELETE ADJACENT DUPLICATES FROM lt_proveidors COMPARING z_num_ofer.
      LOOP AT my_crit_punt_dyn ASSIGNING FIELD-SYMBOL(<fs_crit_dyn_lcp>).
        READ TABLE lt_ofer TRANSPORTING NO FIELDS WITH KEY z_codi_crit_punt = <fs_crit_dyn_lcp>-z_codi_crit_punt.
        IF sy-subrc <> 0.
          LOOP AT lt_proveidors ASSIGNING FIELD-SYMBOL(<fs_proveidor>).
            CLEAR: ls_ofer.
            ls_ofer-docclass         = my_docclass .
            ls_ofer-objectid         = my_objectid .
            ls_ofer-z_mod_crit_punt  = <fs_crit_dyn_lcp>-z_mod_crit_punt .
            ls_ofer-z_codi_crit_punt = <fs_crit_dyn_lcp>-z_codi_crit_punt .
            ls_ofer-z_num_ofer       = <fs_proveidor>-z_num_ofer.
            ls_ofer-z_no_aplica      = <fs_crit_dyn_lcp>-z_no_aplica.
            APPEND ls_ofer TO lt_ofer .
          ENDLOOP.
        ENDIF.
      ENDLOOP.
*      IF my_mode <> co_mode_punt_quadre3b.
*        IF lt_equip[] IS INITIAL.
*          lt_equip = lt_equip_bd[].
*        ENDIF.
*      ENDIF.
    ENDIF.
******    IF my_mode <> co_mode_punt_quadre3b.
******      IF lt_equip[] IS INITIAL.
******        lt_equip = lt_equip_bd[].
******      ENDIF.
******    ENDIF.
**  << FI MODIF ETODR SPEC-49075
  ENDIF.

**  >> INI MODIF ETODR SPEC-45341
  IF my_crit_is_dyn = abap_on.
    CALL FUNCTION 'ZRM_SAVE_PUNT_REC'. "SPEC-50381
    change_punt_ofer( EXPORTING it_punt_dades = gt_dades_punt
                      CHANGING  ct_punt_ofer  = lt_ofer
                                ct_punt_equip = lt_equip ).
  ENDIF.
**  << INI MODIF ETODR SPEC-45341

  LOOP AT my_punt_lema ASSIGNING <ls_punt> . "WHERE z_codi_crit_punt NE co_codi_crit_total.
    ls_lema-docclass         = my_docclass .
    ls_lema-objectid         = my_objectid .
    ls_lema-z_mod_crit_punt  = <ls_punt>-z_mod_crit_punt .
    ls_lema-z_codi_crit_punt = <ls_punt>-z_codi_crit_punt .
    ls_lema-z_num_lema       = <ls_punt>-z_num_gen .
    ls_lema-z_punts          = <ls_punt>-z_punts .
    APPEND ls_lema TO lt_lema .
  ENDLOOP .

  CASE my_mode.

    WHEN co_mode_punt_sol_part.
      INSERT  zrm_dt_punt_sol FROM TABLE lt_sol_part .
      ">>>SPEC-54695, Inici modificació  - ETODR
    WHEN co_mode_millor_classif.
      "Forcem a que no faci res ara
      "<<<SPEC-54695, Final modificació - ETODR

      " >>>PSPEC-1451 Inici modificació - EVXGL
    WHEN co_mode_val_cap_obra.

      " Recuperem OBJECTID i DOCCLASS de l'Expedient Fill.
      CLEAR: lv_docclass_fill,
             lv_objectid_fill.

      GET PARAMETER ID 'DOCCLASS_FILL_VCO' FIELD lv_docclass_fill.
      GET PARAMETER ID 'OBJECTID_FILL_VCO' FIELD lv_objectid_fill.

      CLEAR: ls_ofer,
             lt_zrm_dt_punt_cap.

      " Traspasem els registres de les Ofertes amb DOCCLASS i OBEJCTID de l'Expedient Fill.
      LOOP AT lt_ofer INTO ls_ofer.
        CLEAR: ls_zrm_dt_punt_cap.
        MOVE-CORRESPONDING ls_ofer TO ls_zrm_dt_punt_cap.
        ls_zrm_dt_punt_cap-mandt = sy-mandt.
        ls_zrm_dt_punt_cap-docclass_fill = lv_docclass_fill.
        ls_zrm_dt_punt_cap-objectid_fill = lv_objectid_fill.

        SELECT SINGLE proveidor
         FROM zrm_dt_ofertes
          INTO ls_zrm_dt_punt_cap-num_proveidor
            WHERE docclass = ls_ofer-docclass
              AND objectid = ls_ofer-objectid
              AND z_num_ofer = ls_ofer-z_num_ofer.

        APPEND ls_zrm_dt_punt_cap TO lt_zrm_dt_punt_cap.
        CLEAR: ls_ofer.
      ENDLOOP.

      " Grabem les Ofertes a la taula.
*      MODIFY zrm_dt_punt_ofer FROM TABLE lt_ofer .
      IF lt_zrm_dt_punt_cap IS NOT INITIAL.
        MODIFY zrm_dt_punt_cap FROM TABLE lt_zrm_dt_punt_cap.
      ENDIF.
      " <<<PSPEC-1451 Fi modificació - EVXGL

    WHEN OTHERS.
      INSERT zrm_dt_punt_lema FROM TABLE lt_lema .

      MODIFY zrm_dt_punt_ofer FROM TABLE lt_ofer .
      MODIFY zrm_dt_lemes     FROM TABLE my_lemes .

      IF  lt_equip IS NOT INITIAL.
**    >> INI MODIF ETODR SPEC-49500
*        INSERT zrm_dt_punt_equi FROM TABLE lt_equip.
**      >> INI MODIF ETODR SPEC-50770
*        MODIFY zrm_dt_punt_equi FROM TABLE lt_equip.
        SELECT *
          FROM zrm_dt_punt_equi
          INTO TABLE @DATA(lt_punt_equi_saved)
          WHERE docclass = @my_docclass
            AND objectid = @my_objectid.

        LOOP AT lt_equip ASSIGNING FIELD-SYMBOL(<fs_equip_from_graella>).
          LOOP AT lt_punt_equi_saved ASSIGNING FIELD-SYMBOL(<fs_equip_to_save>) WHERE z_num_ofer        = <fs_equip_from_graella>-z_num_ofer
                                                                                  AND z_comptador_equip = <fs_equip_from_graella>-z_comptador_equip
                                                                                  AND z_codi_crit_punt  = <fs_equip_from_graella>-z_codi_crit_punt
                                                                                  AND z_carrec_equip    = <fs_equip_from_graella>-z_carrec_equip.
            <fs_equip_to_save>-z_punts      = <fs_equip_from_graella>-z_punts.
            IF <fs_equip_from_graella>-z_pes IS NOT INITIAL.
              <fs_equip_to_save>-z_pes      = <fs_equip_from_graella>-z_pes.
            ENDIF.
            <fs_equip_to_save>-z_equip_max  = <fs_equip_from_graella>-z_equip_max.
            <fs_equip_to_save>-z_exclos     = <fs_equip_from_graella>-z_exclos.

            ">>>SPEC:67070, Inici modificació - ECJMS
            SELECT SINGLE z_coeficient_iref INTO lv_coeficient_iref
              FROM zrm_dm_crit_punt
              WHERE z_mod_crit_punt   EQ <fs_equip_from_graella>-z_mod_crit_punt  AND
                    z_codi_crit_punt  EQ <fs_equip_from_graella>-z_codi_crit_punt AND
                    z_coeficient_iref <> space."01 o 02 ETODR SPEC-67070

            CHECK sy-subrc EQ 0.

            READ TABLE gt_equip ASSIGNING FIELD-SYMBOL(<fs_eqp>)
              WITH KEY z_mod_crit_punt   = <fs_equip_from_graella>-z_mod_crit_punt
                       z_codi_crit_punt  = <fs_equip_from_graella>-z_codi_crit_punt
                       z_carrec_equip    = <fs_equip_from_graella>-z_carrec_equip
                       z_num_ofer        = <fs_equip_from_graella>-z_num_ofer
                       z_comptador_equip = <fs_equip_from_graella>-z_comptador_equip. "SPEC-73142 - ECMRG

            <fs_equip_to_save>-z_imp_incr_tot = <fs_eqp>-z_imp_incr_tot.
            <fs_equip_to_save>-z_imp_incr_a1  = <fs_eqp>-z_imp_incr_a1.
            <fs_equip_to_save>-z_imp_incr_a2  = <fs_eqp>-z_imp_incr_a2.
            <fs_equip_to_save>-z_imp_incr_a3  = <fs_eqp>-z_imp_incr_a3.
            <fs_equip_to_save>-z_imin         = <fs_eqp>-z_imin.
            <fs_equip_to_save>-z_acr_sing     = <fs_eqp>-z_acr_sing.
            <fs_equip_to_save>-z_aplica_bim   = <fs_eqp>-z_aplica_bim.
            ">> SPEC-71554, Inici Modificació - ETODR
            <fs_equip_to_save>-z_tcqcoef   = <fs_eqp>-z_tcqcoef.
            "<< SPEC-71554, Final Modificació - ETODR

            MOVE-CORRESPONDING <fs_eqp> TO <fs_equip_to_save>.

            "<<<SPEC:67070, Final modificació - ECJMS

          ENDLOOP.
        ENDLOOP.
        MODIFY zrm_dt_punt_equi FROM TABLE lt_punt_equi_saved.
**      << FI MODIF ETODR SPEC-50770
**    << FI MODIF ETODR SPEC-49500
      ENDIF.
  ENDCASE.

  ">>>SPEC:51885, Inici modificació  - ECFA

*INI PRL :: SPEC-89164
*  READ TABLE lt_crit_punt WITH KEY z_verif_cap_obra = 'X' INTO l_verif_cap_obra.  "PRL :: SPEC-89164
*  IF sy-subrc = 0.
*    "PRL :: SPEC-89164
*    "fem una select per veure si n'hi ha dades
*    SELECT COUNT(*) FROM zrm_dt_punt_cap JOIN zrm_dm_crit_punt
*                    ON zrm_dt_punt_cap~z_mod_crit_punt = zrm_dm_crit_punt~z_mod_crit_punt AND
*                       zrm_dt_punt_cap~z_codi_crit_punt = zrm_dm_crit_punt~z_codi_crit_punt
*                    INTO lv_count
*                    WHERE
*                    zrm_dt_punt_cap~docclass     =  my_docclass AND
*                    zrm_dt_punt_cap~objectid     =  my_objectid AND
*                    zrm_dt_punt_cap~z_no_aplica  <> 'X' AND
*                    zrm_dm_crit_punt~z_crit_ve    <> 'X' AND
*                    zrm_dm_crit_punt~z_sumatori   <> 'X'.
*  ELSE.
*    "fem una select per veure si n'hi ha dades
*    SELECT COUNT(*) FROM zrm_dt_punt_ofer JOIN zrm_dm_crit_punt
*                    ON zrm_dt_punt_ofer~z_mod_crit_punt = zrm_dm_crit_punt~z_mod_crit_punt AND
*                       zrm_dt_punt_ofer~z_codi_crit_punt = zrm_dm_crit_punt~z_codi_crit_punt
*                    INTO lv_count
*                    WHERE
*                    zrm_dt_punt_ofer~docclass     =  my_docclass AND
*                    zrm_dt_punt_ofer~objectid     =  my_objectid AND
*                    zrm_dt_punt_ofer~z_no_aplica  <> 'X' AND
*                    zrm_dm_crit_punt~z_crit_ve    <> 'X' AND
*                    zrm_dm_crit_punt~z_sumatori   <> 'X'.
*  ENDIF.

  "fem una select per veure si n'hi ha dades
  SELECT COUNT(*) FROM zrm_dt_punt_ofer JOIN zrm_dm_crit_punt
                   ON zrm_dt_punt_ofer~z_mod_crit_punt  = zrm_dm_crit_punt~z_mod_crit_punt
                  AND zrm_dt_punt_ofer~z_codi_crit_punt = zrm_dm_crit_punt~z_codi_crit_punt
                   INTO lv_count
                     WHERE zrm_dt_punt_ofer~docclass =  my_docclass
                       AND zrm_dt_punt_ofer~objectid =  my_objectid
                       AND zrm_dt_punt_ofer~z_no_aplica <> 'X'
                       AND zrm_dm_crit_punt~z_crit_ve  <> 'X'
                       AND zrm_dm_crit_punt~z_sumatori <> 'X'.
*FIN PRL :: SPEC-89164

  IF lv_count EQ 0.
    "Si no hi ha dades, marquem el camp amb una creu('x')
    my_exp_cont-z_conv_ob_preu = abap_true.
  ELSE.
    my_exp_cont-z_conv_ob_preu = abap_false.
  ENDIF.
  "<<<SPEC:51885, Final modificació - ECFA


  MODIFY zrm_dt_exp_cont  FROM my_exp_cont.

  CLEAR my_changed .
  save_change_documents( ) .
  my_punt_lema_db     = my_punt_lema .
  my_punt_ofer_db     = my_punt_ofer .
  my_exp_cont_db      = my_exp_cont .
  my_punt_sol_part_db = my_punt_sol_part.
  COMMIT WORK .
  IF no_actv IS INITIAL.
    build_activity_list( ) .
  ENDIF.
**>> INI MODIF ETODR SPEC-40749
  set_log_pt( i_first_time   = abap_off
              i_save_db      = abap_on  ).
**<< FI MODIF ETODR SPEC-40749

**  >> INI MODIF ETODR SPEC-45341
  IF my_crit_is_dyn = abap_on.
    save_dades_sapscript( EXPORTING it_punt_dades = gt_dades_punt
                                    it_motiv_mult = gt_dades_motiv_multiples ).
  ENDIF.
**  << INI MODIF ETODR SPEC-45341

  IF my_incr IS NOT INITIAL.
    MODIFY zrm_dt_punt_incr FROM TABLE my_incr.
  ENDIF.
  ">> SPEC-71214, Inici Modificació - ETODR
  IF my_punt_co2 IS NOT INITIAL.
    MODIFY zrm_dt_punt_co2 FROM TABLE my_punt_co2.
  ENDIF.
  "<< SPEC-71214, Final Modificació - ETODR

ENDMETHOD.


METHOD save_change_documents.
  DATA: lt_vpunt_lema        TYPE STANDARD TABLE OF vzrm_dt_punt_lema
                WITH NON-UNIQUE KEY z_num_lema z_codi_crit_punt,
        lt_vpunt_lema_db     LIKE lt_vpunt_lema,
        lt_vpunt_ofer        TYPE STANDARD TABLE OF vzrm_dt_punt_ofer
                WITH NON-UNIQUE KEY z_num_ofer z_codi_crit_punt,
        lt_vpunt_ofer_db     LIKE lt_vpunt_ofer,
        lt_vpunt_sol_part    TYPE STANDARD TABLE OF vzrm_dt_punt_sol
                 WITH NON-UNIQUE KEY z_num_ofer z_codi_crit_punt,
        lt_vpunt_sol_part_db LIKE lt_vpunt_sol_part,
        lt_vpunt_equi        TYPE STANDARD TABLE OF vzrm_dt_punt_equi,
        lt_vpunt_equi_db     LIKE lt_vpunt_equi,
        wa_vpunt_equi        LIKE LINE OF lt_vpunt_equi,
        lv_update            TYPE c.

  FIELD-SYMBOLS: <ls_punt_lema> TYPE ty_s_punt_gen,
                 <ls_punt_ofer> TYPE ty_s_punt_gen,
                 <ls_sol_part>  TYPE ty_s_punt_gen.

  DATA: ls_vpunt_lema     TYPE vzrm_dt_punt_lema,
        ls_vpunt_ofer     TYPE vzrm_dt_punt_ofer,
        ls_vpunt_sol_part TYPE vzrm_dt_punt_sol,
        l_objectid        TYPE cdhdr-objectid,
        l_time            TYPE sy-uzeit,
        l_date            TYPE sy-datum.

  DEFINE _add .
    loop at &1 assigning &2 .
      &3-docclass         = my_docclass .
      &3-objectid         = my_objectid .
      &3-z_mod_crit_punt  = &2-z_mod_crit_punt .
      &3-z_codi_crit_punt = &2-z_codi_crit_punt .
      &3-z_punts          = &2-z_punts .
      &3-&4       = &2-z_num_gen .
      append &3 to &5.
    endloop .
  END-OF-DEFINITION .


*-- Només guardem documents de canvi que es fan modificacions, no la primera vegada
  IF my_punt_lema_db[] IS NOT INITIAL .
    _add: my_punt_lema    <ls_punt_lema> ls_vpunt_lema z_num_lema lt_vpunt_lema,
          my_punt_lema_db <ls_punt_lema> ls_vpunt_lema z_num_lema lt_vpunt_lema_db.

    SORT: lt_vpunt_lema,      lt_vpunt_lema_db .
    CALL METHOD zrm_cl_change_documents=>compare_tables
      CHANGING
        ch_before = lt_vpunt_lema_db
        ch_after  = lt_vpunt_lema.
  ENDIF .
** >> INI MODIF ETODR SPEC-40388
*  IF my_punt_ofer_db[] IS NOT INITIAL .
** << FI MODIF ETODR SPEC-40388
  _add: my_punt_ofer    <ls_punt_ofer> ls_vpunt_ofer z_num_ofer lt_vpunt_ofer,
        my_punt_ofer_db <ls_punt_ofer> ls_vpunt_ofer z_num_ofer lt_vpunt_ofer_db.

  SORT: lt_vpunt_ofer,      lt_vpunt_ofer_db .
  CALL METHOD zrm_cl_change_documents=>compare_tables
    CHANGING
      ch_before = lt_vpunt_ofer_db
      ch_after  = lt_vpunt_ofer.
*  ENDIF .

  IF my_punt_sol_part_db[] IS NOT INITIAL .
    _add: my_punt_sol_part      <ls_sol_part> ls_vpunt_sol_part z_num_ofer lt_vpunt_sol_part,
          my_punt_sol_part_db   <ls_sol_part> ls_vpunt_sol_part z_num_ofer lt_vpunt_sol_part_db.

    SORT: lt_vpunt_sol_part, lt_vpunt_sol_part_db .

    CALL METHOD zrm_cl_change_documents=>compare_tables
      CHANGING
        ch_before = lt_vpunt_sol_part_db
        ch_after  = lt_vpunt_sol_part.
  ENDIF.

*  INI spec-47173 etljs
  CLEAR lv_update.

  DATA(lt_punt_ofer_db) = my_punt_ofer_db.

  LOOP AT lt_punt_ofer_db ASSIGNING FIELD-SYMBOL(<fs>) WHERE z_num_equip IS NOT INITIAL.
    DATA(lv_tabix) = sy-tabix.
    lv_update = 'U'.
    READ TABLE lt_vpunt_ofer_db ASSIGNING FIELD-SYMBOL(<fs_ofer>) INDEX lv_tabix.
    CHECK sy-subrc EQ 0.
    READ TABLE gt_equip ASSIGNING FIELD-SYMBOL(<fs_equip>) WITH KEY z_codi_crit_punt = <fs_ofer>-z_codi_crit_punt
                                                                    z_comptador_equip = <fs>-z_num_equip
                                                                    z_num_ofer        = <fs_ofer>-z_num_ofer.
    CHECK sy-subrc EQ 0.
    MOVE-CORRESPONDING <fs_equip> TO wa_vpunt_equi.
    wa_vpunt_equi-kz      = <fs_ofer>-kz.
    APPEND wa_vpunt_equi TO lt_vpunt_equi_db.
    DELETE lt_vpunt_ofer_db INDEX lv_tabix.
    DELETE lt_punt_ofer_db  INDEX lv_tabix.
  ENDLOOP.

  DATA(lt_punt_ofer) = my_punt_ofer.

  LOOP AT lt_punt_ofer ASSIGNING <fs> WHERE z_num_equip IS NOT INITIAL.
    lv_tabix = sy-tabix.
    READ TABLE lt_vpunt_ofer ASSIGNING <fs_ofer> INDEX lv_tabix.
    CHECK sy-subrc EQ 0.
    READ TABLE gt_equip ASSIGNING <fs_equip> WITH KEY z_codi_crit_punt = <fs_ofer>-z_codi_crit_punt
                                                      z_comptador_equip = <fs>-z_num_equip
                                                      z_num_ofer        = <fs_ofer>-z_num_ofer.
    CHECK sy-subrc EQ 0.
    MOVE-CORRESPONDING <fs_equip> TO wa_vpunt_equi.
    wa_vpunt_equi-z_punts = <fs_ofer>-z_punts.
    wa_vpunt_equi-kz      = <fs_ofer>-kz.
    APPEND wa_vpunt_equi TO lt_vpunt_equi.
    DELETE lt_vpunt_ofer INDEX lv_tabix.
    DELETE lt_punt_ofer  INDEX lv_tabix.
  ENDLOOP.
*  FIN ETLJS SPEC-47173

  CONCATENATE my_docclass my_objectid INTO l_objectid RESPECTING BLANKS .
  l_time = sy-uzeit .
  l_date = sy-datum .
  CALL FUNCTION 'Z_RM_VALORACIO_WRITE_DOCUMENT'
    EXPORTING
      objectid             = l_objectid
      tcode                = sy-tcode
      utime                = l_time
      udate                = l_date
      username             = sy-uname
      upd_zrm_dt_exp_cont  = 'U'
      upd_zrm_dt_punt_lema = 'U'
      upd_zrm_dt_punt_ofer = 'U'
      upd_zrm_dt_punt_equi = lv_update
      upd_zrm_dt_punt_sol  = 'U'
      n_zrm_dt_exp_cont    = my_exp_cont
      o_zrm_dt_exp_cont    = my_exp_cont_db
    TABLES
      xzrm_dt_punt_lema    = lt_vpunt_lema
      yzrm_dt_punt_lema    = lt_vpunt_lema_db
      xzrm_dt_punt_ofer    = lt_vpunt_ofer
      yzrm_dt_punt_ofer    = lt_vpunt_ofer_db
      xzrm_dt_punt_sol     = lt_vpunt_sol_part
      yzrm_dt_punt_sol     = lt_vpunt_sol_part_db
      xzrm_dt_punt_equi    = lt_vpunt_equi
      yzrm_dt_punt_equi    = lt_vpunt_equi_db.

ENDMETHOD.


  METHOD save_dades_sapscript.
    LOOP AT it_punt_dades ASSIGNING FIELD-SYMBOL(<fs_puntdades>).
      IF <fs_puntdades>-z_motivacio IS BOUND.
        <fs_puntdades>-z_motivacio->save_sapscript( ).
      ENDIF.
      IF <fs_puntdades>-z_motivacio_resta IS BOUND.
        <fs_puntdades>-z_motivacio_resta->save_sapscript( ).
      ENDIF.
    ENDLOOP.
**  >> INI MODIF ETODR SPEC-47173
    LOOP AT it_motiv_mult	ASSIGNING FIELD-SYMBOL(<fs>).
      IF <fs>-z_motivacio IS BOUND.
        <fs>-z_motivacio->save_sapscript( ).
      ENDIF.
    ENDLOOP.
**  << FI MODIF ETODR SPEC-47173
  ENDMETHOD.


  METHOD save_punt_ofer_log.

    DATA: lt_punt_ofer_log TYPE TABLE OF zrm_dt_pofer_log,
          lt_punt_ofer     TYPE TABLE OF zrm_dt_punt_ofer,
          wa_punt_ofer     TYPE zrm_dt_punt_ofer,
          wa_punt_ofer_log TYPE zrm_dt_pofer_log.

    CLEAR: lt_punt_ofer[], lt_punt_ofer_log[].


    SELECT *
      FROM zrm_dt_punt_ofer
      INTO TABLE lt_punt_ofer
      WHERE docclass  = my_docclass
        AND objectid  = my_objectid.

    IF sy-subrc = 0.
      LOOP AT lt_punt_ofer INTO wa_punt_ofer.
        MOVE-CORRESPONDING wa_punt_ofer TO wa_punt_ofer_log.
        wa_punt_ofer_log-z_codi_exp       = my_exp_cont-z_codi_exp.
        wa_punt_ofer_log-z_data_execucio  = sy-datum.
        APPEND wa_punt_ofer_log TO lt_punt_ofer_log.
      ENDLOOP.
      MODIFY zrm_dt_pofer_log FROM TABLE lt_punt_ofer_log.
    ENDIF.

  ENDMETHOD.


  METHOD save_taules_rel_ofer.
    IF my_punt_rec[] IS NOT INITIAL.
      MODIFY zrm_dt_punt_rec FROM TABLE my_punt_rec.
    ENDIF.

    IF my_punt_sel[] IS NOT INITIAL.
*    DELETE FROM zrm_dt_punt_sel WHERE objectid EQ g_objectid.
      MODIFY zrm_dt_punt_sel FROM TABLE my_punt_sel.
    ENDIF.

    IF my_punt_equi[] IS NOT INITIAL.
*    DELETE FROM zrm_dt_punt_equi WHERE objectid EQ g_objectid.
      MODIFY zrm_dt_punt_equi FROM TABLE my_punt_equi.
    ENDIF.
  ENDMETHOD.


  METHOD seleccio_apartats_dyn.

    DATA: lt_dades_ofer_dyn TYPE zrm_tt_dt_punt_ofer,
          lt_punt_equi      TYPE ztt_punt_equi.

    get_dades_ofer_dyn( EXPORTING im_sel_dyn   = abap_on "ETODR SPEC-49075
                        IMPORTING ex_crit_punt = DATA(lt_crit_punt) ).
    CALL FUNCTION 'ZRM_SELECCIO_APARTATS'
      EXPORTING
        im_crit_punt     = lt_crit_punt
        im_mode          = my_mode
      IMPORTING
        et_punt_ofer_dyn = lt_dades_ofer_dyn
        et_punt_equi     = lt_punt_equi.

    set_dyn_data( EXPORTING  im_docclass    = my_docclass
                             im_objectid    = my_objectid
                  EXCEPTIONS not_punt_ofer  = 1 ).
    IF sy-subrc <> 0.
      "<< PSPEC-1482, Inici Modificació - EVCHA
      READ TABLE lt_dades_ofer_dyn INTO DATA(ls_data) INDEX 1.
      IF ls_data-docclass = 'ZQDC'.
        LEAVE PROGRAM.
      ELSE.
        "<< PSPEC-1482, Final Modificació - EVCHA
        RAISE not_punt_ofer.
      ENDIF.
    ENDIF.

    IF lt_dades_ofer_dyn[] IS NOT INITIAL OR lt_punt_equi[] IS NOT INITIAL.
      SORT lt_punt_equi BY z_codi_crit_punt z_comptador_equip.
      set_dades_ofer_dyn( EXPORTING it_punt_ofer_dyn = lt_dades_ofer_dyn
                                                it_punt_equi     = lt_punt_equi ).
    ENDIF.
  ENDMETHOD.


  METHOD seleccio_apartats_dyn_form.

    SELECT *
      FROM zrm_dt_punt_form
      INTO TABLE @DATA(lt_dades_form_dyn)
      WHERE docclass = @my_exp_cont_db-docclass
        AND objectid = @my_exp_cont_db-objectid.

    LOOP AT my_crit_punt ASSIGNING FIELD-SYMBOL(<fs_crit_punt>).
      READ TABLE lt_dades_form_dyn INTO DATA(ls_aplica) WITH KEY z_codi_crit_punt = <fs_crit_punt>-z_codi_crit_punt
                                                                 z_mod_crit_punt  = <fs_crit_punt>-z_mod_crit_punt.
      IF sy-subrc = 0.
        <fs_crit_punt>-z_no_aplica         = ls_aplica-z_no_aplica.
        <fs_crit_punt>-z_codi_subapar_punt = ls_aplica-z_codi_subapar_punt.
      ENDIF.

    ENDLOOP.

    CALL FUNCTION 'ZRM_SELECCIO_APARTATS_FORM'
      EXPORTING
        im_crit_punt = my_crit_punt
        im_mode      = my_mode.
  ENDMETHOD.


  METHOD send_notificacions.


    DATA: ls_doc_data     TYPE sodocchgi1,
          lt_packing_list TYPE sopcklsti1_t,
          wa_packing_list TYPE sopcklsti1,
          lv_string_text  TYPE sodocchgi1,
          wa_msg          TYPE solisti1,
          lt_message      TYPE TABLE OF solisti1,
          entries         TYPE sy-tabix,
          lt_receivers    TYPE TABLE OF somlreci1,
          wa_receivers    TYPE somlreci1,
          c_error         TYPE c,
          ls_long         TYPE i,
          num_lines       TYPE i,
          ls_desc         TYPE z_descrip_abr,
          lv_emp_userid   TYPE fitp_user-uname,
          lv_emp_emailid  TYPE pa0105-usrid_long.

    DATA: lt_assumpte  TYPE TABLE OF tline,
          lt_cos       TYPE TABLE OF tline,
          lv_nom_assum TYPE thead-tdname,
          lv_nom_cos   TYPE thead-tdname,
          lt_return    TYPE TABLE OF bapiret2,
          lv_address   TYPE bapiaddr3.

* >> INI MODIF ECAGE SPEC-77509
    DATA: ls_lfa1             TYPE lfa1,
          lv_nom_adjudicatari TYPE string.
* << FI MODIF ECAGE SPEC-77509.

    CLEAR:
       lt_receivers,
       lt_message,
       lt_packing_list,
       ls_doc_data.

    CASE im_tipo_notif.
      WHEN 'ADJPROV'.
        CHECK my_exp_cont-z_adjudicatari IS NOT INITIAL AND my_changed EQ abap_true.
        IF my_exp_cont-z_cap_exp IS INITIAL.
          MESSAGE text-i01 TYPE 'I'.
        ELSE.

          CALL FUNCTION 'BAPI_USER_GET_DETAIL'
            EXPORTING
              username = my_exp_cont-z_cap_exp
            IMPORTING
              address  = lv_address
            TABLES
              return   = lt_return.

          READ TABLE lt_return WITH KEY type = 'E' TRANSPORTING NO FIELDS.

          CHECK lv_address-e_mail IS NOT INITIAL AND sy-subrc NE 0.

          wa_receivers-receiver = lv_address-e_mail.
          wa_receivers-rec_type   = 'U'.             "&---- Send to External Email id
          wa_receivers-com_type   = 'INT'.
          wa_receivers-notif_del  = 'X'.
          wa_receivers-notif_ndel = 'X'.
          APPEND wa_receivers TO lt_receivers.

        ENDIF.
        CHECK my_exp_cont-z_cap_exp IS NOT INITIAL.
      WHEN OTHERS.
    ENDCASE.

    CONCATENATE im_tipo_notif 'ASSUM' INTO lv_nom_assum SEPARATED BY '_'.
    CONCATENATE im_tipo_notif 'COS'   INTO lv_nom_cos SEPARATED BY '_'.

    CALL FUNCTION 'READ_TEXT'
      EXPORTING
        id                      = 'ST'
        language                = sy-langu
        name                    = lv_nom_assum
        object                  = 'TEXT'
      TABLES
        lines                   = lt_assumpte
      EXCEPTIONS
        id                      = 1
        language                = 2
        name                    = 3
        not_found               = 4
        object                  = 5
        reference_check         = 6
        wrong_access_to_archive = 7
        OTHERS                  = 8.
    CHECK sy-subrc EQ 0.

    CALL FUNCTION 'READ_TEXT'
      EXPORTING
*       CLIENT                  = SY-MANDT
        id                      = 'ST'
        language                = sy-langu
        name                    = lv_nom_cos
        object                  = 'TEXT'
      TABLES
        lines                   = lt_cos
      EXCEPTIONS
        id                      = 1
        language                = 2
        name                    = 3
        not_found               = 4
        object                  = 5
        reference_check         = 6
        wrong_access_to_archive = 7
        OTHERS                  = 8.
    CHECK sy-subrc EQ 0.

    LOOP AT lt_assumpte ASSIGNING FIELD-SYMBOL(<fs_assum>).
      CONCATENATE ls_doc_data-obj_descr <fs_assum>-tdline INTO ls_doc_data-obj_descr.
      REPLACE ALL OCCURRENCES OF 'Z_CODI_EXP' IN ls_doc_data-obj_descr WITH my_exp_cont-z_codi_exp.
    ENDLOOP.


    ls_doc_data-obj_langu   = sy-langu.
    ls_doc_data-obj_name    = 'URGENT'.
    ls_doc_data-sensitivty  = '='.               "Standard


    LOOP AT lt_cos ASSIGNING FIELD-SYMBOL(<fs_cos>).
      wa_msg = <fs_cos>-tdline.

      REPLACE ALL OCCURRENCES OF 'Z_DESCRIP_ABR' IN wa_msg WITH my_exp_cont-z_descrip_abr.

* >> INI MODIF ECAGE SPEC-77509
* Busquem el nom senser del adjudicatari
      CLEAR: ls_lfa1, lv_nom_adjudicatari.
      SELECT SINGLE * FROM lfa1 INTO ls_lfa1
        WHERE lifnr = my_exp_cont-z_adjudicatari.

      CONCATENATE ls_lfa1-name1 ls_lfa1-name2 ls_lfa1-name3 ls_lfa1-name4 INTO lv_nom_adjudicatari SEPARATED BY SPACE.

      REPLACE ALL OCCURRENCES OF 'NOM_AD' IN wa_msg WITH lv_nom_adjudicatari.
* << FI MODIF ECAGE SPEC-77509.

      APPEND wa_msg TO lt_message.
      ls_doc_data-doc_size = ls_doc_data-doc_size + strlen( wa_msg ).
    ENDLOOP.


    CLEAR wa_msg.

    IF lt_receivers IS NOT INITIAL.

      DESCRIBE TABLE lt_message LINES wa_packing_list-body_num.
      wa_packing_list-transf_bin = space.
      wa_packing_list-head_start = 1.
      wa_packing_list-head_num   = 0.
      wa_packing_list-body_start = 1.
      wa_packing_list-doc_type   = 'RAW'.
      APPEND wa_packing_list TO lt_packing_list.

      ">>> SPEC-56879, Inici Modificació - ECTRP  31122019
      CALL FUNCTION 'ZSO_NEW_DOCUMENT_ATT_SEND_API1'
        EXPORTING
          document_data              = ls_doc_data
          sender_address             = zsubc_sender
          sender_address_type        = zsubc_setype
          commit_work                = abap_true
        TABLES
          packing_list               = lt_packing_list
          contents_txt               = lt_message
          receivers                  = lt_receivers
        EXCEPTIONS
          too_many_receivers         = 1
          document_not_sent          = 2
          document_type_not_exist    = 3
          operation_no_authorization = 4
          parameter_error            = 5
          x_error                    = 6
          enqueue_error              = 7
          OTHERS                     = 8.
*      CALL FUNCTION 'SO_NEW_DOCUMENT_ATT_SEND_API1'
*        EXPORTING
*          document_data              = ls_doc_data
*          commit_work                = abap_true
*        TABLES
*          packing_list               = lt_packing_list
*          contents_txt               = lt_message
*          receivers                  = lt_receivers
*        EXCEPTIONS
*          too_many_receivers         = 1
*          document_not_sent          = 2
*          document_type_not_exist    = 3
*          operation_no_authorization = 4
*          parameter_error            = 5
*          x_error                    = 6
*          enqueue_error              = 7
*          OTHERS                     = 8.
      "<<< SPEC-56879, Final Modificació - ECTRP  31122019

    ENDIF.




  ENDMETHOD.


  METHOD send_warning_best_ranked_offer.

    DATA: lt_body    TYPE soli_tab,
          lv_text    TYPE so_text255,
          ls_body    TYPE soli,
          lv_desp    TYPE flag,
          lt_users   TYPE zrm_tt_usuaris,
          lv_subject TYPE so_obj_des.

    DATA: lr_env_mail TYPE REF TO zcl_enviament_mail.

    "Obtenim el asunto del correu electrònic
    CONCATENATE text-001 my_exp_cont-z_codi_exp INTO lv_subject SEPARATED BY space.

    "Obtenim el text del correu electrònic part fixa
    CONCATENATE text-009 my_exp_cont-z_codi_exp text-010 my_exp_cont-z_descrip_abr INTO lv_text SEPARATED BY space.
    ls_body-line = lv_text.
    APPEND ls_body TO lt_body.
    CLEAR: ls_body.
    APPEND ls_body TO lt_body. "Deixem una línia en blanc
    CLEAR: ls_body, lv_text.
    ls_body-line = text-011. "Ja es pot  demanar l´aptitud a la empresa como millor classificada:
    APPEND ls_body TO lt_body.
    CLEAR: ls_body.


    READ TABLE my_ofertesx INTO DATA(ls_ofertas) WITH KEY z_mill_class = abap_true.
    IF sy-subrc EQ 0.
      ls_body-line = ls_ofertas-nom_proveidor.
      APPEND ls_body TO lt_body.
      CLEAR ls_body.
    ENDIF.

    IF my_exp_cont-z_tadj_exp IS NOT INITIAL.
      DATA(ls_users) = VALUE zrm_es_usuaris( uname = my_exp_cont-z_tadj_exp ).
      APPEND ls_users TO lt_users.
      CLEAR ls_users.
    ENDIF.

    SELECT * FROM zrm_usua_avisos INTO TABLE @DATA(lt_usuaris) WHERE z_avis = 04.
    IF sy-subrc EQ 0.

      LOOP AT lt_usuaris INTO DATA(ls_usuaris).
        ls_users-uname = ls_usuaris-z_usuari.
        APPEND ls_users TO lt_users.
      ENDLOOP.
    ENDIF.

    IF lt_users[] IS NOT INITIAL.
      CREATE OBJECT lr_env_mail
        EXPORTING
          it_users   = lt_users[]
          iv_subject = lv_subject
          it_body    = lt_body.

      IF lr_env_mail IS BOUND.
        DATA(lv_sent_ok) = lr_env_mail->send_mail( ).
        IF lv_sent_ok IS NOT INITIAL.
          MESSAGE s154(zmm_imp).
        ELSE.
          MESSAGE s155(zmm_imp) DISPLAY LIKE 'E'.
        ENDIF.
      ENDIF.
    ELSE.
      MESSAGE s153(zmm_imp) DISPLAY LIKE 'E'.
    ENDIF.

  ENDMETHOD.


METHOD set_awardee.
  FIELD-SYMBOLS: <ls_ofertax> TYPE ty_s_ofertax,
                 <ls_lema>    LIKE LINE OF my_lemes .

  IF my_locked IS INITIAL .
    RAISE EXCEPTION TYPE zcx_rm_valoracio
      EXPORTING textid = zcx_rm_valoracio=>not_opened_for_update .
  ENDIF .

  READ TABLE my_ofertesx ASSIGNING <ls_ofertax> WITH KEY z_adj_prov = 'X' .
  IF     my_exp_cont-z_adjudicatari IS NOT INITIAL
     OR sy-subrc EQ 0 .
    RAISE EXCEPTION TYPE zcx_rm_valoracio
      EXPORTING textid = zcx_rm_valoracio=>already_awarded .
  ENDIF .

  IF check_activity( co_act_awardee ) IS INITIAL .
    RAISE EXCEPTION TYPE zcx_rm_valoracio.
  ENDIF .

  IF is_2_round( ) IS NOT INITIAL and not ( ME->MY_EXP_CONT-Z_PROC_ADJ = 'NF' AND ME->MY_EXP_CONT-Z_NEGOCIACIO = 'X' ).
    READ TABLE my_lemes  ASSIGNING <ls_lema> WITH KEY z_num_lema = im_key_gen .
    IF sy-subrc NE 0.
      RAISE EXCEPTION TYPE zcx_rm_valoracio
        EXPORTING textid = zcx_rm_valoracio=>lema_doesnot_exist .
    ENDIF .
    IF <ls_lema>-z_num_ofer IS INITIAL .
      RAISE EXCEPTION TYPE zcx_rm_valoracio
        EXPORTING textid = zcx_rm_valoracio=>lema_not_linked.
    ENDIF .
    READ TABLE my_ofertesx ASSIGNING <ls_ofertax> WITH KEY z_num_ofer = <ls_lema>-z_num_ofer .
    IF <ls_ofertax>-z_sel_2volta IS INITIAL .
      RAISE EXCEPTION TYPE zcx_rm_valoracio
        EXPORTING textid = zcx_rm_valoracio=>offer_cannot_be_awarded .
    ENDIF .
  ELSE .
    READ TABLE my_ofertesx ASSIGNING <ls_ofertax> WITH KEY z_num_ofer = im_key_gen .
  ENDIF .
  IF sy-subrc NE 0 .
    RAISE EXCEPTION TYPE zcx_rm_valoracio
      EXPORTING textid = zcx_rm_valoracio=>offer_doesnot_exist .
  ENDIF .

  IF    <ls_ofertax>-exclos          IS NOT INITIAL
     OR <ls_ofertax>-z_excl_punt_tec IS NOT INITIAL .
    RAISE EXCEPTION TYPE zcx_rm_valoracio
      EXPORTING textid = zcx_rm_valoracio=>offer_cannot_be_awarded .
  ENDIF .

*ETLJS SPEC-65852
*  IF <ls_ofertax>-z_arquitecte IS INITIAL AND me->is_empresa_arquitecte( ) EQ abap_true.
*    RAISE EXCEPTION TYPE zcx_rm_valoracio
*        EXPORTING textid = zcx_rm_valoracio=>arquitecte_uninformed .
*  ENDIF.

  <ls_ofertax>-z_adj_prov      = 'X' .
  <ls_ofertax>-z_data_adj_prov = sy-datum. "EVEEM 01.10.25 PSPEC-6559 PR13
  my_ob_ofertes->modificar_oferta( <ls_ofertax>-offer_data ).

  my_exp_cont-z_adjudicatari  = <ls_ofertax>-proveidor .
  IF my_exp_cont-z_req_homog = 'X'.
    my_exp_cont-z_import_adj    = <ls_ofertax>-z_import_homog.
    my_exp_cont-z_import_adj_b  = <ls_ofertax>-z_imp_homog_b .
  ELSE.
    my_exp_cont-z_import_adj    = <ls_ofertax>-z_import_oferta .
    my_exp_cont-z_import_adj_b  = <ls_ofertax>-z_imp_oferta_b .
  ENDIF.
  my_changed = 'X' .

* A les licitacions de dues voltes, la puntuació total de les ofertes es correspon amb
* la puntuació de la proposta gràfica.
  LOOP AT my_lemes ASSIGNING <ls_lema> .
    CHECK <ls_lema>-z_num_ofer IS NOT INITIAL .
    READ TABLE my_ofertesx ASSIGNING <ls_ofertax> WITH KEY z_num_ofer = <ls_lema>-z_num_ofer .
    <ls_ofertax>-z_punt_total = <ls_lema>-z_punts_lema .
    my_ob_ofertes->modificar_oferta( <ls_ofertax>-offer_data ).
  ENDLOOP .

ENDMETHOD.


METHOD set_best_classified.

*>> Ini  SPEC-54695  - ETMAE

  FIELD-SYMBOLS: <ls_ofertax> TYPE ty_s_ofertax .

* data: ls_ofertax TYPE ty_s_ofertax .

  IF my_locked IS INITIAL .
    RAISE EXCEPTION TYPE zcx_rm_valoracio
      EXPORTING
        textid = zcx_rm_valoracio=>not_opened_for_update.
  ENDIF .

* Inicializar valores anteriores.
  LOOP AT my_ofertesx ASSIGNING <ls_ofertax>.
    CLEAR: <ls_ofertax>-z_mill_class.
    my_ob_ofertes->modificar_oferta( <ls_ofertax>-offer_data ).
  ENDLOOP.

  READ TABLE my_ofertesx ASSIGNING <ls_ofertax> WITH KEY z_num_ofer = im_key_gen .

  CHECK sy-subrc IS INITIAL.

  <ls_ofertax>-z_mill_class = abap_true.

  my_ob_ofertes->modificar_oferta( <ls_ofertax>-offer_data ).
  my_exp_cont-z_conf_mill_class = abap_on.
  my_exp_cont-z_user_sel_m_clas = sy-uname .
  my_exp_cont-z_data_sel_m_clas = sy-datum .


**** Actualizar en el expediente Usuario y Fecha. Millor Classificat.
***  UPDATE zrm_dt_exp_cont
***     SET z_data_sel_m_clas  = sy-datum
***         z_user_sel_m_clas  = sy-uname
***         z_conf_mill_class  = abap_on
***   WHERE docclass  =  my_exp_cont-docclass
***     AND objectid  =  my_exp_cont-objectid .
***
***
**** Reset oferta con flag de millor classificat anterior.
***  UPDATE zrm_dt_ofertes
***     SET z_mill_class = abap_false
***   WHERE docclass     = my_exp_cont-docclass
***     AND objectid     = my_exp_cont-objectid
****    and z_num_ofer   = ls_ofertax-z_num_ofer
***     AND z_mill_class = abap_true .
***
**** Actualizar en la oferta seleccionada flag de millor classificat.
***  UPDATE zrm_dt_ofertes
***     SET z_mill_class = abap_true
***   WHERE docclass     = my_exp_cont-docclass
***     AND objectid     = my_exp_cont-objectid
***     AND z_num_ofer   = <ls_ofertax>-z_num_ofer  .


* Quitar de la lista de actividades.
***  DELETE my_activity_list WHERE table_line = co_act_best_classified .
  my_changed = 'X' .

*<< Fi  SPEC-54695  - ETMAE
ENDMETHOD.
*
*------------------------------------------------------------------------------
*


  METHOD set_canvi_punt.
    DATA: l_punts_alv(40),
          l_punts_real    TYPE zrm_dt_punt_ofer-z_punts,
          lcx_valoracio   TYPE REF TO zcx_rm_valoracio,
          lt_canvis_punt  TYPE zrm_cl_valoracio_ofertes=>ty_t_canvis_punt,
          wa_canvis_punt  TYPE zrm_cl_valoracio_ofertes=>ty_s_canvis_punt,
          l_dummy         TYPE c,
          l_undo          TYPE xfeld,
          l_puntuacio     TYPE string.


    ASSIGN COMPONENT 'Z_CODI_CRIT_PUNT' OF STRUCTURE i_row TO FIELD-SYMBOL(<fs_crit_punt>).
    ASSIGN COMPONENT 'Z_MOD_CRIT_PUNT'  OF STRUCTURE i_row TO FIELD-SYMBOL(<fs_modcrit_punt>).

    READ TABLE my_crit_punt ASSIGNING FIELD-SYMBOL(<ls_crit_punt>)  WITH TABLE KEY z_codi_crit_punt = <fs_crit_punt>
                                                                                   z_mod_crit_punt  = <fs_modcrit_punt> .

    "Es recupera el proveïdor modificat
    get_offers( RECEIVING re_offers = DATA(lt_ofertes) ).
    READ TABLE lt_ofertes INTO DATA(wa_of) WITH KEY z_num_ofer = i_columns-key.
    wa_canvis_punt-proveidor        = wa_of-proveidor.
    wa_canvis_punt-nom_proveidor    = wa_of-nom_proveidor.
    "Es recupera el criteri de puntuació
    wa_canvis_punt-z_codi_crit_punt  = <fs_crit_punt>.
    "Es recupera la puntuació que tenia aquell proveïdor amb aquell criteri de puntuació anteriorment
    ASSIGN COMPONENT i_data_changed-fieldname OF STRUCTURE i_punt TO FIELD-SYMBOL(<fs_punt_ant>).
    IF sy-subrc = 0.
      l_puntuacio = <fs_punt_ant>.
      SHIFT l_puntuacio LEFT DELETING LEADING space.
      REPLACE ALL OCCURRENCES OF ',' IN l_puntuacio WITH '.'.
      wa_canvis_punt-z_punt_ant = CONV z_punt_ant( l_puntuacio ).
    ENDIF.
    "Es recupera la puntuació nova
    ir_data_changed->get_cell_value( EXPORTING  i_tabix     = i_data_changed-tabix
                                                i_fieldname = i_data_changed-fieldname
                                     IMPORTING  e_value     = l_punts_alv ).
    CALL FUNCTION 'RS_CONV_EX_2_IN'
      EXPORTING
        input_external  = l_punts_alv
        table_field     = is_ref
      IMPORTING
        output_internal = wa_canvis_punt-z_punt_post
      EXCEPTIONS
        OTHERS          = 21.
    IF sy-subrc = 0.
**    >> INI MODIF ETODR SPEC-45341
*      IF    wa_canvis_punt-z_punt_post  LT 0 OR wa_canvis_punt-z_punt_post  GT <ls_crit_punt>-z_punt_max .
      IF wa_canvis_punt-z_punt_post LT <ls_crit_punt>-z_punt_min OR wa_canvis_punt-z_punt_post  GT <ls_crit_punt>-z_punt_max.
**    << FI MODIF ETODR SPEC-45341
**    >> INI MODIF ETODR SPEC-45341
*        MESSAGE e040 WITH <ls_crit_punt>-z_codi_crit_punt 0
        MESSAGE e040 WITH <ls_crit_punt>-z_codi_crit_punt <ls_crit_punt>-z_punt_min
**    << FI MODIF ETODR SPEC-45341
                          <ls_crit_punt>-z_punt_max INTO l_dummy .
        zcx_rm_valoracio=>raise_from_message( ) .
        RETURN.
      ENDIF .
    ELSE.
      CALL METHOD ir_data_changed->add_protocol_entry
        EXPORTING
          i_msgid     = sy-msgid
          i_msgty     = 'E'
          i_msgno     = sy-msgno
          i_msgv1     = sy-msgv1
          i_msgv2     = sy-msgv2
          i_msgv3     = sy-msgv3
          i_msgv4     = sy-msgv4
          i_fieldname = i_data_changed-fieldname
          i_row_id    = i_data_changed-row_id
          i_tabix     = i_data_changed-tabix.
      RAISE EXCEPTION TYPE zcx_rm_valoracio EXPORTING textid = zcx_rm_valoracio=>undo_changes.
    ENDIF.
    APPEND wa_canvis_punt TO lt_canvis_punt.
    "Cal especificar el motiu pel qual es realitzen canvis en la puntuació. OBLIGATORI. Si no se'n introdueix cap es desfaran els canvis
    set_motiu_canvi_punt( CHANGING   ct_canvis_punt = lt_canvis_punt
                          EXCEPTIONS cancelled      = 1
                                     OTHERS         = 2 ).
    IF sy-subrc = 0.
      set_log_pt( i_first_time   = abap_off
                  it_canvis_punt = lt_canvis_punt ).
    ELSE.
      TRY .
          l_undo = abap_on.
          "Cridem al mètode SET_PUNCTUATION per tal de desfer els canvis
          CALL METHOD set_punctuation
            EXPORTING
              im_codi_crit_punt = wa_canvis_punt-z_codi_crit_punt
              im_mod_crit_punt  = <fs_modcrit_punt>
              im_key_gen        = i_data_changed-fieldname+1(20)
              im_value          = wa_canvis_punt-z_punt_ant.

        CATCH zcx_rm_valoracio INTO lcx_valoracio.
          CALL METHOD ir_data_changed->add_protocol_entry
            EXPORTING
              i_msgid     = lcx_valoracio->if_t100_message~t100key-msgid
              i_msgty     = 'E'
              i_msgno     = lcx_valoracio->if_t100_message~t100key-msgno
              i_msgv1     = lcx_valoracio->msgv1
              i_msgv2     = lcx_valoracio->msgv2
              i_msgv3     = lcx_valoracio->msgv3
              i_msgv4     = lcx_valoracio->msgv4
              i_fieldname = i_data_changed-fieldname
              i_row_id    = i_data_changed-row_id
              i_tabix     = i_data_changed-tabix.
      ENDTRY .
      RAISE EXCEPTION TYPE zcx_rm_valoracio EXPORTING textid = zcx_rm_valoracio=>undo_changes.
    ENDIF.
  ENDMETHOD.


  METHOD set_canvi_punt_dyn.
    DATA: l_punts_alv(40),
          l_punts_real    TYPE zrm_dt_punt_ofer-z_punts,
          lcx_valoracio   TYPE REF TO zcx_rm_valoracio,
          lt_canvis_punt  TYPE zrm_cl_valoracio_ofertes=>ty_t_canvis_punt,
          wa_canvis_punt  TYPE zrm_cl_valoracio_ofertes=>ty_s_canvis_punt,
          l_dummy         TYPE c,
          l_undo          TYPE xfeld,
          l_puntuacio     TYPE string.


    ASSIGN COMPONENT 'Z_CODI_CRIT_PUNT' OF STRUCTURE i_row TO FIELD-SYMBOL(<fs_crit_punt>).
    ASSIGN COMPONENT 'Z_MOD_CRIT_PUNT'  OF STRUCTURE i_row TO FIELD-SYMBOL(<fs_modcrit_punt>).

    READ TABLE my_crit_punt ASSIGNING FIELD-SYMBOL(<ls_crit_punt>)  WITH TABLE KEY z_codi_crit_punt = <fs_crit_punt>
                                                                                   z_mod_crit_punt  = <fs_modcrit_punt> .

    "Es recupera el proveïdor modificat
    get_offers( RECEIVING re_offers = DATA(lt_ofertes) ).
    READ TABLE lt_ofertes INTO DATA(wa_of) WITH KEY z_num_ofer = i_columns-key.
    wa_canvis_punt-proveidor        = wa_of-proveidor.
    wa_canvis_punt-nom_proveidor    = wa_of-nom_proveidor.
    "Es recupera el criteri de puntuació
    wa_canvis_punt-z_codi_crit_punt  = <fs_crit_punt>.

    "Es recupera la puntuació que tenia aquell proveïdor amb aquell criteri de puntuació anteriorment
    l_puntuacio = is_puntuacio_ant-z_punts.
    SHIFT l_puntuacio LEFT DELETING LEADING space.
    REPLACE ALL OCCURRENCES OF ',' IN l_puntuacio WITH '.'.
    wa_canvis_punt-z_punt_ant = CONV z_punt_ant( l_puntuacio ).

    "Es recupera la puntuació nova
    l_punts_alv = is_puntuacio_act-z_punts.
    SHIFT l_punts_alv LEFT DELETING LEADING space.
    REPLACE ALL OCCURRENCES OF '.' IN l_punts_alv WITH ','.

    CALL FUNCTION 'RS_CONV_EX_2_IN'
      EXPORTING
        input_external  = l_punts_alv
        table_field     = is_ref
      IMPORTING
        output_internal = wa_canvis_punt-z_punt_post
      EXCEPTIONS
        OTHERS          = 21.
    IF sy-subrc = 0.
      IF    wa_canvis_punt-z_punt_post  LT <ls_crit_punt>-z_punt_min OR wa_canvis_punt-z_punt_post  GT <ls_crit_punt>-z_punt_max .
        MESSAGE e040 WITH <ls_crit_punt>-z_codi_crit_punt 0
                          <ls_crit_punt>-z_punt_max INTO l_dummy .
        zcx_rm_valoracio=>raise_from_message( ) .
        RETURN.
      ENDIF .
    ELSE.
      RAISE EXCEPTION TYPE zcx_rm_valoracio EXPORTING textid = zcx_rm_valoracio=>undo_changes.
    ENDIF.
    APPEND wa_canvis_punt TO lt_canvis_punt.
    "Cal especificar el motiu pel qual es realitzen canvis en la puntuació. OBLIGATORI. Si no se'n introdueix cap es desfaran els canvis
    set_motiu_canvi_punt( CHANGING   ct_canvis_punt = lt_canvis_punt
                          EXCEPTIONS cancelled      = 1
                                     OTHERS         = 2 ).
    IF sy-subrc = 0.
      IF i_temporal IS INITIAL.
        set_log_pt( i_first_time   = abap_off
                    it_canvis_punt = lt_canvis_punt ).
      ELSE.
        APPEND LINES OF lt_canvis_punt TO gt_temporal_canvis_punt.
      ENDIF.
    ELSE.
      RAISE EXCEPTION TYPE zcx_rm_valoracio EXPORTING textid = zcx_rm_valoracio=>undo_changes.
    ENDIF.
  ENDMETHOD.


  METHOD set_dades_ofer_dyn.

    DATA: lt_punt_ofer TYPE ty_t_punt_gen,
          wa_punt_ofer TYPE ty_s_punt_gen,
          lt_crit_punt TYPE ty_t_crit_punt,
          wa_crit_punt TYPE ty_s_crit_punt,
          lv_cargo     TYPE string.


    IF it_punt_ofer_dyn IS NOT INITIAL.
      gt_punt_ofer_dyn = it_punt_ofer_dyn.
**  Traspassem les dades de APLICA/NO_APLICA al criteri de puntuació, per tal de mostrar-los o no i fer el recalcul corresponent
      LOOP AT my_crit_punt ASSIGNING FIELD-SYMBOL(<fs_crit_punt>).
        DATA(lv_tabix) = sy-tabix.
        READ TABLE gt_punt_ofer_dyn ASSIGNING FIELD-SYMBOL(<fs_aplica>) WITH KEY z_codi_crit_punt = <fs_crit_punt>-z_codi_crit_punt
                                                                                 z_mod_crit_punt  = <fs_crit_punt>-z_mod_crit_punt.
        IF sy-subrc = 0.
          <fs_crit_punt>-z_no_aplica = <fs_aplica>-z_no_aplica.
          IF <fs_aplica>-z_no_aplica IS NOT INITIAL.
            LOOP AT gt_dades_punt ASSIGNING FIELD-SYMBOL(<fs>) WHERE z_codi_crit_punt = <fs_crit_punt>-z_codi_crit_punt.
              CLEAR: <fs_aplica>-z_punts, <fs>-z_punts.
            ENDLOOP.
          ENDIF.
        ENDIF.
      ENDLOOP.
    ENDIF.
**  >> INI MODIF ETODR SPEC-49075
    "Sempre guardem la puntuació no ponderada per a fer el càlcul de zero a partir del factor de multiplicació o de correcció que correspongui al criteri (RECALCULATE_SI_NO_APLICA)
    "També es guarden els valors de Km i número d'obres presentades dels criteris que els hi correspongui
    LOOP AT my_punt_ofer ASSIGNING FIELD-SYMBOL(<fs_punt_ofer>) .
      CLEAR: <fs_punt_ofer>-z_punts_no_pond.
      READ TABLE gt_punt_ofer_dyn ASSIGNING FIELD-SYMBOL(<fs_punt_no_pond>) WITH KEY z_num_ofer       = <fs_punt_ofer>-z_num_gen
                                                                                     z_codi_crit_punt = <fs_punt_ofer>-z_codi_crit_punt
                                                                                     z_mod_crit_punt  = <fs_punt_ofer>-z_mod_crit_punt.
      IF sy-subrc = 0.
        <fs_punt_ofer>-z_punts_no_pond  = <fs_punt_no_pond>-z_punts_no_pond.
      ENDIF.
    ENDLOOP.
**  << FI MODIF ETODR SPEC-49075

    ">>>SPEC-52548, Inici modificació  - ETODR
    "Al canviar l'equip des de "Seleccionar de nou?" hem de regenerar l'equip guardat a les taules internes
    DATA: lt_punt_equi TYPE zrm_tt_dt_punt_equi,
          ls_punt_equi TYPE zrm_dt_punt_equi.
    LOOP AT it_punt_equi ASSIGNING FIELD-SYMBOL(<fs_equi>).
      CLEAR: ls_punt_equi.
      MOVE-CORRESPONDING <fs_equi> TO ls_punt_equi.
      APPEND ls_punt_equi TO lt_punt_equi.
    ENDLOOP.
    IF lt_punt_equi IS NOT INITIAL.
      set_new_equip( lt_punt_equi ).
    ENDIF.
    "<<<SPEC-52548, Final modificació - ETODR

***    >> INI MODIF ETODR SPEC-49500
**    CHECK it_punt_equi IS NOT INITIAL.
*    IF it_punt_equi[] IS NOT INITIAL.
***    << INI MODIF ETODR SPEC-49500
*      CLEAR: lt_punt_ofer,
*             lt_crit_punt.
*      LOOP AT my_punt_ofer INTO wa_punt_ofer WHERE z_num_equip IS NOT INITIAL.
*        APPEND wa_punt_ofer TO lt_punt_ofer.
*      ENDLOOP.
*      DELETE my_punt_ofer WHERE z_num_equip IS NOT INITIAL.
*      LOOP AT my_crit_punt INTO wa_crit_punt WHERE z_equip EQ abap_true.
*        APPEND wa_crit_punt TO lt_crit_punt.
*        DATA(lv_mod) = wa_crit_punt-z_mod_crit_punt.
*      ENDLOOP.
*      DELETE my_crit_punt WHERE z_equip EQ abap_true.
*
*      SELECT *
*        FROM zrm_dm_crit_punt
*        INTO TABLE @DATA(lt_crit)
*       WHERE z_mod_crit_punt EQ @lv_mod
*         AND z_mult_equip    EQ @abap_true.
*
*      DATA(lt_punt_equi) = it_punt_equi.
*      SORT  lt_punt_equi BY z_comptador_equip DESCENDING.
*
*      LOOP AT lt_punt_equi ASSIGNING FIELD-SYMBOL(<fs_equi>).  "ETLJS SPEC-47173
*        IF <fs_equi>-z_num_ofer = '001'.
*
*          READ TABLE lt_crit_punt INTO wa_crit_punt WITH KEY z_codi_crit_punt = <fs_equi>-z_codi_crit_punt.
*          READ TABLE lt_crit ASSIGNING FIELD-SYMBOL(<fs_cri>) WITH KEY z_codi_crit_punt = <fs_equi>-z_codi_crit_punt.
*
*          CHECK sy-subrc EQ 0.
*
*          wa_crit_punt-z_codi_crit_punt = <fs_equi>-z_codi_crit_punt.
*          wa_crit_punt-z_ponderacio = <fs_equi>-z_pes.
*          wa_crit_punt-z_num_equip = <fs_equi>-z_comptador_equip.
*
*          CALL FUNCTION 'CONVERSION_EXIT_CARRE_OUTPUT'
*            EXPORTING
*              input  = <fs_equi>-z_carrec_equip
*            IMPORTING
*              output = lv_cargo.
*
*          CONCATENATE lv_cargo <fs_equi>-z_descripcio <fs_cri>-z_descripcio
*                 INTO wa_crit_punt-z_descripcio SEPARATED BY space.
*
*          INSERT wa_crit_punt INTO TABLE my_crit_punt.
*        ENDIF.
*
*        READ TABLE lt_punt_ofer INTO wa_punt_ofer WITH KEY z_mod_crit_punt  = <fs_equi>-z_mod_crit_punt
*                                                           z_codi_crit_punt = <fs_equi>-z_codi_crit_punt
*                                                           z_num_gen        = <fs_equi>-z_num_ofer
*                                                           z_num_equip      = <fs_equi>-z_comptador_equip.
*
*
*        IF sy-subrc EQ 0.
*          INSERT wa_punt_ofer INTO TABLE my_punt_ofer.
*        ELSE.
*          CLEAR wa_punt_ofer.
*          wa_punt_ofer-z_mod_crit_punt  = <fs_equi>-z_mod_crit_punt.
*          wa_punt_ofer-z_codi_crit_punt = <fs_equi>-z_codi_crit_punt.
*          wa_punt_ofer-z_num_equip      = <fs_equi>-z_comptador_equip.
*          wa_punt_ofer-z_num_gen        = <fs_equi>-z_num_ofer.
*          INSERT wa_punt_ofer INTO TABLE my_punt_ofer.
*        ENDIF.
*
*
*      ENDLOOP.
***    >> INI MODIF ETODR SPEC-49500
*    ENDIF.
*    DATA: wa_dades_ofer_dyn_equi TYPE ty_s_punt_ofer_dyn_equi.
*    IF gt_punt_ofer_dyn_equi[] IS INITIAL.
*      LOOP AT my_punt_ofer ASSIGNING FIELD-SYMBOL(<fs_dyn_equi>) WHERE z_num_equip IS NOT INITIAL.
*        LOOP AT lt_dades_equi ASSIGNING FIELD-SYMBOL(<fs_dades_equip>) WHERE z_comptador_equip = <fs_dyn_equi>-z_num_equip.
**          READ TABLE gt_punt_ofer_dyn ASSIGNING FIELD-SYMBOL(<fs_punt_ofer_dyn>) WITH KEY z_codi_crit_punt = <fs_dyn_equi>-z_codi_crit_punt
**                                                                                          z_num_ofer       = <fs_dyn_equi>-z_num_gen.
**          IF sy-subrc = 0.
*            CLEAR: wa_dades_ofer_dyn_equi.
**            wa_dades_ofer_dyn_equi                   = <fs_punt_ofer_dyn>.
*            wa_dades_ofer_dyn_equi-z_comptador_equip    = <fs_dyn_equi>-z_num_equip.
*            APPEND wa_dades_ofer_dyn_equi TO gt_punt_ofer_dyn_equi.
**          ENDIF.
*        ENDLOOP.
*      ENDLOOP.
*    ENDIF.
**    << FI MODIF ETODR SPEC-49500
  ENDMETHOD.


  METHOD set_dyn_data.

    DATA: lt_dades_ofer_dyn  TYPE zrm_tt_dt_punt_ofer,
          lt_dades_punt      TYPE zrm_cl_valoracio_ofertes=>ty_t_puntuacio_subapartats,
          lt_dades_mult_punt TYPE zrm_cl_valoracio_ofertes=>ty_t_motiv_subapartats_mult, "ETODR SPEC-47173
          wa_puntuacio       TYPE zrm_cl_valoracio_ofertes=>ty_s_puntuacio_subapartats,
          wa_puntuacio_mult  TYPE zrm_cl_valoracio_ofertes=>ty_s_motiv_subapartats_mult, "ETODR SPEC-47173
          wa_crit_rel        TYPE zrm_cl_valoracio_ofertes_fe=>ty_s_crit_rel,
          lv_codi_text       TYPE thead-tdname,
          l_dummy_recurs     TYPE z_compta_rec,
          ls_punt_gen_equi   TYPE ty_s_punt_gen, "SPEC-66771
          l_tabix            TYPE i.

    CLEAR: gt_dades_punt[], gt_punt_ofer_dyn[].
    CLEAR: my_punt_max_equip[], my_punt_gen_equi[]. "SPEC-49806

*INI PRL :: SPEC-89164
*DATA(lt_crit_punt) = me->MY_CRIT_PUNT.
*READ TABLE lt_crit_punt WITH KEY z_verif_cap_obra = 'X' INTO DATA(l_verif_cap_obra).  "PRL :: SPEC-89164
*IF sy-subrc = 0.
**  IF 1 = 2.
*    "zrm_dt_punt_cap
*    SELECT *
*      FROM zrm_dt_punt_cap
*      INTO TABLE @lt_dades_ofer_dyn
*      WHERE docclass = @im_docclass
*        AND objectid = @im_objectid.
*  ELSE.
*    "zrm_dt_punt_ofer
*    SELECT *
*      FROM zrm_dt_punt_ofer
*      INTO TABLE @lt_dades_ofer_dyn
*      WHERE docclass = @im_docclass
*        AND objectid = @im_objectid.
*  ENDIF.
  SELECT *
    FROM zrm_dt_punt_ofer
    INTO TABLE @lt_dades_ofer_dyn
    WHERE docclass = @im_docclass
      AND objectid = @im_objectid.
*FIN PRL :: SPEC-89164


*>> INI SPEC-47173
    SELECT *
      FROM zrm_dt_punt_equi
      INTO TABLE @DATA(lt_dades_equi)
      WHERE docclass    = @im_docclass
        AND objectid    = @im_objectid
        AND z_is_header = @abap_off. "ETODR SPEC-49500
*<< FIN SPEC-47173
    IF lt_dades_ofer_dyn[] IS NOT INITIAL.
      SELECT *
        FROM zrm_dm_suapar_pt
        INTO TABLE @DATA(lt_suapar_pt)
        FOR ALL ENTRIES IN @lt_dades_ofer_dyn
          WHERE z_codi_subapar_punt EQ @lt_dades_ofer_dyn-z_codi_subapar_punt
            AND z_codi_subapar_punt_rel EQ @lt_dades_ofer_dyn-z_codi_subapar_punt.

***INI MOD ETJHG - SPEC-46407
      SELECT *
        FROM zrm_dt_punt_rec
        INTO TABLE @DATA(lt_punt_mult_rec)
        FOR ALL ENTRIES IN @lt_dades_ofer_dyn
        WHERE docclass         EQ @lt_dades_ofer_dyn-docclass
          AND objectid         EQ @lt_dades_ofer_dyn-objectid
          AND z_mod_crit_punt  EQ @lt_dades_ofer_dyn-z_mod_crit_punt
          AND z_codi_crit_punt EQ @lt_dades_ofer_dyn-z_codi_crit_punt.
***FIN MOD ETJHG - SPEC-46407
**>> INI MODIF ETODR SPEC-47173
      SELECT *
        FROM zrm_dt_punt_sel
        INTO TABLE @DATA(lt_punt_mult_sel)
        FOR ALL ENTRIES IN @lt_dades_ofer_dyn
        WHERE docclass         EQ @lt_dades_ofer_dyn-docclass
          AND objectid         EQ @lt_dades_ofer_dyn-objectid
          AND z_mod_crit_punt  EQ @lt_dades_ofer_dyn-z_mod_crit_punt
          AND z_codi_crit_punt EQ @lt_dades_ofer_dyn-z_codi_crit_punt.
**<< FI MODIF ETODR SPEC-47173
    ELSE.
      RAISE not_punt_ofer.
    ENDIF.

    CALL METHOD read_and_check_plec
      EXPORTING
        im_header    = my_exp_cont_db
      IMPORTING
        ex_crit_punt = my_crit_punt.
**>> INI MODIF ETODR SPEC-49500
    CALL METHOD read_and_check_punt_ofer
      EXPORTING
        im_header        = my_exp_cont_db
        im_mod_crit_punt = my_plec-z_mod_crit_punt
        im_crit_punt     = my_crit_punt
        im_ofertesx      = my_ofertesx
      IMPORTING
        ex_punt_ofer     = my_punt_ofer
        ex_punt_ofer_db  = my_punt_ofer_db.
**<< FI MODIF ETODR SPEC-49500

    READ TABLE lt_dades_ofer_dyn ASSIGNING FIELD-SYMBOL(<fs_punt_ofer_db>) INDEX 1.
    CHECK sy-subrc = 0.

    set_dades_ofer_dyn( EXPORTING it_punt_ofer_dyn = lt_dades_ofer_dyn ).

    LOOP AT lt_dades_ofer_dyn ASSIGNING FIELD-SYMBOL(<fs_punt_ofer>).
      CLEAR: wa_puntuacio, lv_codi_text.

      wa_puntuacio-z_codi_crit_punt         = <fs_punt_ofer>-z_codi_crit_punt.
      wa_puntuacio-z_codi_subapar_punt      = <fs_punt_ofer>-z_codi_subapar_punt.
      wa_puntuacio-docclass                 = <fs_punt_ofer>-docclass.
      wa_puntuacio-objectid                 = <fs_punt_ofer>-objectid.
      wa_puntuacio-z_num_ofer               = <fs_punt_ofer>-z_num_ofer.
      wa_puntuacio-z_sec                    = <fs_punt_ofer>-z_sec.
      wa_puntuacio-z_punts                  = <fs_punt_ofer>-z_punts.
** >> INI MODIF ETODR SPEC-49075
      wa_puntuacio-z_punts_no_pond          = <fs_punt_ofer>-z_punts_no_pond.
** << FI MODIF ETODR SPEC-49075
      IF <fs_punt_ofer>-z_codi_subapar_punt IS INITIAL.

        READ TABLE lt_dades_equi TRANSPORTING NO FIELDS WITH KEY z_codi_crit_punt = <fs_punt_ofer>-z_codi_crit_punt.
        IF sy-subrc NE 0.

          CONCATENATE 'Z' im_objectid <fs_punt_ofer>-z_num_ofer <fs_punt_ofer>-z_codi_crit_punt
                      <fs_punt_ofer>-z_codi_subapar_punt <fs_punt_ofer>-z_sec l_dummy_recurs INTO lv_codi_text.

          CREATE OBJECT wa_puntuacio-z_motivacio
            EXPORTING
              i_docclass = im_docclass
              i_objectid = im_objectid
              i_tdid     = 'ZMOT'
              i_tdspras  = sy-langu
              i_tdname   = lv_codi_text
              i_tdobject = 'Z_PUNT_DYN'
            EXCEPTIONS
              OTHERS     = 0.

          CREATE OBJECT wa_puntuacio-z_comentaris
            EXPORTING
              i_docclass = im_docclass
              i_objectid = im_objectid
              i_tdid     = 'ZCOM'
              i_tdspras  = sy-langu
              i_tdname   = lv_codi_text
              i_tdobject = 'Z_PUNT_DYN'
            EXCEPTIONS
              OTHERS     = 0.
          APPEND wa_puntuacio TO lt_dades_punt.
        ELSE.
          LOOP AT lt_dades_equi ASSIGNING FIELD-SYMBOL(<fs_equi>)
           WHERE z_codi_crit_punt = <fs_punt_ofer>-z_codi_crit_punt AND
                 z_num_ofer       = <fs_punt_ofer>-z_num_ofer.


            CONCATENATE 'Z' im_objectid <fs_punt_ofer>-z_num_ofer <fs_punt_ofer>-z_codi_crit_punt
**        >> INI MODIF ETODR SPEC-49582
*                        <fs_punt_ofer>-z_codi_subapar_punt <fs_punt_ofer>-z_sec l_dummy_recurs <fs_equi>-z_comptador_equip INTO lv_codi_text.
                        <fs_punt_ofer>-z_codi_subapar_punt <fs_punt_ofer>-z_sec <fs_equi>-z_comptador_equip INTO lv_codi_text.
**        << FI MODIF ETODR SPEC-49582
            CREATE OBJECT wa_puntuacio-z_motivacio
              EXPORTING
                i_docclass = im_docclass
                i_objectid = im_objectid
                i_tdid     = 'ZMOT'
                i_tdspras  = sy-langu
                i_tdname   = lv_codi_text
                i_tdobject = 'Z_PUNT_DYN'
              EXCEPTIONS
                OTHERS     = 0.

            CREATE OBJECT wa_puntuacio-z_comentaris
              EXPORTING
                i_docclass = im_docclass
                i_objectid = im_objectid
                i_tdid     = 'ZCOM'
                i_tdspras  = sy-langu
                i_tdname   = lv_codi_text
                i_tdobject = 'Z_PUNT_DYN'
              EXCEPTIONS
                OTHERS     = 0.
            wa_puntuacio-z_pes = <fs_equi>-z_pes.
            wa_puntuacio-z_punts = <fs_equi>-z_punts.
            wa_puntuacio-z_num_equip = <fs_equi>-z_comptador_equip.
            APPEND wa_puntuacio TO lt_dades_punt.
          ENDLOOP.
        ENDIF.
**        >> INI MODIF ETODR SPEC-47173
        LOOP AT lt_punt_mult_sel ASSIGNING FIELD-SYMBOL(<fs_mult_sel>) WHERE z_codi_crit_punt = <fs_punt_ofer>-z_codi_crit_punt.
          CLEAR: wa_puntuacio_mult, lv_codi_text.

          wa_puntuacio_mult-z_codi_crit_punt         = <fs_punt_ofer>-z_codi_crit_punt.
          wa_puntuacio_mult-z_codi_subapar_punt      = <fs_punt_ofer>-z_codi_subapar_punt.
          wa_puntuacio_mult-docclass                 = <fs_punt_ofer>-docclass.
          wa_puntuacio_mult-objectid                 = <fs_punt_ofer>-objectid.
          wa_puntuacio_mult-z_num_ofer               = <fs_mult_sel>-z_num_ofer.
          wa_puntuacio_mult-z_sec                    = <fs_mult_sel>-z_sec.
          wa_puntuacio_mult-z_punts                  = <fs_punt_ofer>-z_punts.
          wa_puntuacio_mult-z_num_equip              = <fs_mult_sel>-z_comptador_recurs.  "SPEC-49499 ETJMD 11.06.2018
** >> INI MODIF ETODR SPEC-49075
          wa_puntuacio-z_km_oferta                   = <fs_mult_sel>-z_km_oferta.
          wa_puntuacio-z_km_verif                    = <fs_mult_sel>-z_km_verif.
          wa_puntuacio-z_num_ob_oferta               = <fs_mult_sel>-z_num_ob_oferta.
          wa_puntuacio-z_num_ob_tip_ok               = <fs_mult_sel>-z_num_ob_tip_ok.
          wa_puntuacio-z_num_ob_acredit_ok           = <fs_mult_sel>-z_num_ob_acredit_ok. "SPEC-49921
** << FI MODIF ETODR SPEC-49075
          CONCATENATE 'Z' im_objectid <fs_mult_sel>-z_num_ofer <fs_punt_ofer>-z_codi_crit_punt
**        >> INI MODIF ETODR SPEC-49582
*                      <fs_punt_ofer>-z_codi_subapar_punt <fs_mult_sel>-z_sec l_dummy_recurs <fs_mult_sel>-z_comptador_recurs INTO lv_codi_text.
                      <fs_punt_ofer>-z_codi_subapar_punt <fs_mult_sel>-z_sec <fs_mult_sel>-z_comptador_recurs INTO lv_codi_text.
**        << FI MODIF ETODR SPEC-49582
          CREATE OBJECT wa_puntuacio_mult-z_motivacio
            EXPORTING
              i_docclass = im_docclass
              i_objectid = im_objectid
              i_tdid     = 'ZMOT'
              i_tdspras  = sy-langu
              i_tdname   = lv_codi_text
              i_tdobject = 'Z_PUNT_DYN'
            EXCEPTIONS
              OTHERS     = 0.

          CREATE OBJECT wa_puntuacio_mult-z_comentaris
            EXPORTING
              i_docclass = im_docclass
              i_objectid = im_objectid
              i_tdid     = 'ZCOM'
              i_tdspras  = sy-langu
              i_tdname   = lv_codi_text
              i_tdobject = 'Z_PUNT_DYN'
            EXCEPTIONS
              OTHERS     = 0.
          READ TABLE lt_dades_mult_punt TRANSPORTING NO FIELDS WITH KEY z_codi_crit_punt = wa_puntuacio_mult-z_codi_crit_punt
                                                                        z_sec            = wa_puntuacio_mult-z_sec
                                                                        z_num_ofer       = wa_puntuacio_mult-z_num_ofer
                                                                        z_num_equip      = wa_puntuacio_mult-z_num_equip.      "SPEC-49499 ETJMD 11.06.2018
          IF sy-subrc <> 0.
            APPEND wa_puntuacio_mult TO lt_dades_mult_punt.
          ENDIF.
        ENDLOOP.
**        << FI MODIF ETODR SPEC-47173
***INI MOD ETJHG - SPEC-46407
      ELSE.
        "Si tiene código subapar miramos en la tabla ZRM_DT_PUNT_REC cual es el número de comptador para poder leer el motivo correctamente
        "añadiendo el campo z_comptador_recurs a la concatenación de campos que ya estaban por defecto
        LOOP AT lt_punt_mult_rec ASSIGNING FIELD-SYMBOL(<fs_mult_rec_pt>) WHERE z_num_ofer EQ <fs_punt_ofer>-z_num_ofer
                                                                            AND z_mod_crit_punt  EQ <fs_punt_ofer>-z_mod_crit_punt
                                                                            AND z_codi_crit_punt EQ <fs_punt_ofer>-z_codi_crit_punt.

          CONCATENATE 'Z' im_objectid <fs_punt_ofer>-z_num_ofer <fs_punt_ofer>-z_codi_crit_punt
                      <fs_punt_ofer>-z_codi_subapar_punt <fs_mult_rec_pt>-z_sec <fs_mult_rec_pt>-z_comptador_recurs INTO lv_codi_text.

          CREATE OBJECT wa_puntuacio-z_motivacio
            EXPORTING
              i_docclass = im_docclass
              i_objectid = im_objectid
              i_tdid     = 'ZMOT'
              i_tdspras  = sy-langu
              i_tdname   = lv_codi_text
              i_tdobject = 'Z_PUNT_DYN'
            EXCEPTIONS
              OTHERS     = 0.

          CREATE OBJECT wa_puntuacio-z_comentaris
            EXPORTING
              i_docclass = im_docclass
              i_objectid = im_objectid
              i_tdid     = 'ZCOM'
              i_tdspras  = sy-langu
              i_tdname   = lv_codi_text
              i_tdobject = 'Z_PUNT_DYN'
            EXCEPTIONS
              OTHERS     = 0.

          wa_puntuacio-z_sec = <fs_mult_rec_pt>-z_sec.
          wa_puntuacio-z_compta_rec = <fs_mult_rec_pt>-z_comptador_recurs.

          IF <fs_mult_rec_pt>-z_comptador_recurs EQ '000'.
            wa_puntuacio-z_punts = <fs_mult_rec_pt>-z_punts.
          ENDIF.

          APPEND wa_puntuacio TO lt_dades_punt.
        ENDLOOP.
**       >> INI MODIF ETODR SPEC-49500
*        IF sy-subrc NE 0. "ETLJS SPEC-47173
*          APPEND wa_puntuacio TO lt_dades_punt.
*        ENDIF.
**       << FI MODIF ETODR SPEC-49500
**        >> INI MODIF ETODR SPEC-47173
        LOOP AT lt_punt_mult_sel ASSIGNING <fs_mult_sel> WHERE z_codi_crit_punt = <fs_punt_ofer>-z_codi_crit_punt.
          CLEAR: wa_puntuacio_mult, lv_codi_text.

          wa_puntuacio_mult-z_codi_crit_punt         = <fs_punt_ofer>-z_codi_crit_punt.
          wa_puntuacio_mult-z_codi_subapar_punt      = <fs_punt_ofer>-z_codi_subapar_punt.
          wa_puntuacio_mult-docclass                 = <fs_punt_ofer>-docclass.
          wa_puntuacio_mult-objectid                 = <fs_punt_ofer>-objectid.
          wa_puntuacio_mult-z_num_ofer               = <fs_mult_sel>-z_num_ofer.          "SPEC-49499 ETJMD 07.06.2018
          wa_puntuacio_mult-z_sec                    = <fs_mult_sel>-z_sec.
          wa_puntuacio_mult-z_punts                  = <fs_punt_ofer>-z_punts.
          wa_puntuacio_mult-z_num_equip              = <fs_mult_sel>-z_comptador_recurs.  "SPEC-49499 ETJMD 07.06.2018

          CONCATENATE 'Z' im_objectid <fs_mult_sel>-z_num_ofer <fs_punt_ofer>-z_codi_crit_punt
**        >> INI MODIF ETODR SPEC-49582
*                      <fs_punt_ofer>-z_codi_subapar_punt <fs_mult_sel>-z_sec l_dummy_recurs <fs_mult_sel>-z_comptador_recurs INTO lv_codi_text.
                      <fs_punt_ofer>-z_codi_subapar_punt <fs_mult_sel>-z_sec <fs_mult_sel>-z_comptador_recurs INTO lv_codi_text.
**        << FI MODIF ETODR SPEC-49582
          CREATE OBJECT wa_puntuacio_mult-z_motivacio
            EXPORTING
              i_docclass = im_docclass
              i_objectid = im_objectid
              i_tdid     = 'ZMOT'
              i_tdspras  = sy-langu
              i_tdname   = lv_codi_text
              i_tdobject = 'Z_PUNT_DYN'
            EXCEPTIONS
              OTHERS     = 0.

          CREATE OBJECT wa_puntuacio_mult-z_comentaris
            EXPORTING
              i_docclass = im_docclass
              i_objectid = im_objectid
              i_tdid     = 'ZCOM'
              i_tdspras  = sy-langu
              i_tdname   = lv_codi_text
              i_tdobject = 'Z_PUNT_DYN'
            EXCEPTIONS
              OTHERS     = 0.
          READ TABLE lt_dades_mult_punt TRANSPORTING NO FIELDS WITH KEY z_codi_crit_punt = wa_puntuacio_mult-z_codi_crit_punt
                                                                        z_sec            = wa_puntuacio_mult-z_sec
                                                                        z_num_ofer       = wa_puntuacio_mult-z_num_ofer
                                                                        z_num_equip      = wa_puntuacio_mult-z_num_equip.      "SPEC-49499 ETJMD 07.06.2018
          IF sy-subrc <> 0.
            APPEND wa_puntuacio_mult TO lt_dades_mult_punt.
          ENDIF.
        ENDLOOP.
**        << FI MODIF ETODR SPEC-47173
**       >> INI MODIF ETODR SPEC-49500
        LOOP AT lt_dades_equi ASSIGNING FIELD-SYMBOL(<fs_mult_equi_pt>) WHERE z_num_ofer EQ <fs_punt_ofer>-z_num_ofer
                                                                          AND z_mod_crit_punt  EQ <fs_punt_ofer>-z_mod_crit_punt
                                                                          AND z_codi_crit_punt EQ <fs_punt_ofer>-z_codi_crit_punt.

          CONCATENATE 'Z' im_objectid <fs_punt_ofer>-z_num_ofer <fs_punt_ofer>-z_codi_crit_punt
                      <fs_punt_ofer>-z_codi_subapar_punt <fs_mult_equi_pt>-z_sec <fs_mult_equi_pt>-z_comptador_equip INTO lv_codi_text.

          CREATE OBJECT wa_puntuacio-z_motivacio
            EXPORTING
              i_docclass = im_docclass
              i_objectid = im_objectid
              i_tdid     = 'ZMOT'
              i_tdspras  = sy-langu
              i_tdname   = lv_codi_text
              i_tdobject = 'Z_PUNT_DYN'
            EXCEPTIONS
              OTHERS     = 0.

          CREATE OBJECT wa_puntuacio-z_comentaris
            EXPORTING
              i_docclass = im_docclass
              i_objectid = im_objectid
              i_tdid     = 'ZCOM'
              i_tdspras  = sy-langu
              i_tdname   = lv_codi_text
              i_tdobject = 'Z_PUNT_DYN'
            EXCEPTIONS
              OTHERS     = 0.

          wa_puntuacio-z_sec       = <fs_mult_equi_pt>-z_sec.
          wa_puntuacio-z_num_equip = <fs_mult_equi_pt>-z_comptador_equip.

*          IF <fs_mult_equi_pt>-z_comptador_equip EQ '000'. "SPEC-49500
          wa_puntuacio-z_punts = <fs_mult_equi_pt>-z_punts.
*          ENDIF.

          APPEND wa_puntuacio TO lt_dades_punt.
        ENDLOOP.
        IF sy-subrc NE 0.
          APPEND wa_puntuacio TO lt_dades_punt.
        ENDIF.
**      << FI MODIF ETODR SPEC-49500
      ENDIF.
***FIN MOD ETJHG - SPEC-46407
    ENDLOOP.
    gt_dades_punt = lt_dades_punt.
    gt_dades_motiv_multiples = lt_dades_mult_punt.

    "Guardem taula de relació per a poder fer els càlculs dinàmics
    LOOP AT my_crit_punt ASSIGNING FIELD-SYMBOL(<fs_crit_punt>).
      CLEAR: wa_crit_rel.
      wa_crit_rel-z_mod_crit_punt = <fs_crit_punt>-z_mod_crit_punt.
      wa_crit_rel-z_parent        = <fs_crit_punt>-z_codi_crit_punt.
      IF <fs_crit_punt>-sum_info IS NOT INITIAL.
        LOOP AT <fs_crit_punt>-sum_info ASSIGNING FIELD-SYMBOL(<fs_sum_info>).
          wa_crit_rel-z_child = <fs_sum_info>-z_codi_crit_punt.
          CHECK wa_crit_rel-z_parent IS NOT INITIAL.
          APPEND wa_crit_rel TO gt_crit_dyn_rel.
        ENDLOOP.
      ENDIF.
    ENDLOOP.

    "Eliminem de la taula de sumatoris els criteris amb el flag de resta informat
    DESCRIBE TABLE my_crit_punt LINES DATA(l_num_crits).
    l_tabix = l_num_crits .
    DO l_num_crits TIMES .
      READ TABLE my_crit_punt ASSIGNING FIELD-SYMBOL(<ls_crit_punt>) INDEX l_tabix .
      l_tabix = l_tabix - 1 .
      LOOP AT <ls_crit_punt>-sum_info ASSIGNING FIELD-SYMBOL(<fs_suminfo_aux>).
        READ TABLE my_crit_punt ASSIGNING FIELD-SYMBOL(<fs_crit>) WITH KEY z_codi_crit_punt = <fs_suminfo_aux>-z_codi_crit_punt.
        IF sy-subrc = 0 AND <fs_crit>-z_resta IS NOT INITIAL.
          DELETE <ls_crit_punt>-sum_info.
        ENDIF.
      ENDLOOP.
    ENDDO.

** >> INI MODIF ETODR SPEC-49806
    DATA: wa_punt_max_equip TYPE zst_equip_max.
    "Inicialitzem la taula d'equips màxims
    IF lt_dades_equi[] IS NOT INITIAL.
      READ TABLE lt_dades_equi TRANSPORTING NO FIELDS WITH KEY z_equip_max = abap_on. "Només entrem aquí si és un Model de Puntuació d'Equip Màxim
      IF sy-subrc = 0.
        LOOP AT lt_dades_equi ASSIGNING FIELD-SYMBOL(<fs_equip_max>) WHERE z_equip_max IS NOT INITIAL.
          READ TABLE my_punt_max_equip TRANSPORTING NO FIELDS WITH KEY z_num_ofer        = <fs_equip_max>-z_num_ofer
                                                                       z_comptador_equip = <fs_equip_max>-z_comptador_equip.
          IF sy-subrc <> 0.
            CLEAR: wa_punt_max_equip.
            LOOP AT my_punt_ofer ASSIGNING FIELD-SYMBOL(<fs_punt_ofer_equi>) WHERE z_num_equip = <fs_equip_max>-z_comptador_equip
                                                                               AND z_num_gen   = <fs_equip_max>-z_num_ofer.
              ADD <fs_punt_ofer_equi>-z_punts TO wa_punt_max_equip-z_punts.
            ENDLOOP.
            wa_punt_max_equip-z_descripcio      = <fs_equip_max>-z_descripcio.
*        wa_punt_max_equip-z_text_carrec     = ''.
            wa_punt_max_equip-z_carrec_equip    = <fs_equip_max>-z_carrec_equip.
            wa_punt_max_equip-z_comptador_equip = <fs_equip_max>-z_comptador_equip.
            wa_punt_max_equip-z_num_ofer        = <fs_equip_max>-z_num_ofer.
            wa_punt_max_equip-z_pes             = <fs_equip_max>-z_pes.
            wa_punt_max_equip-z_punts_pes       = wa_punt_max_equip-z_punts * ( <fs_equip_max>-z_pes / 100 ).
            APPEND wa_punt_max_equip TO my_punt_max_equip.
          ENDIF.
        ENDLOOP.
        IF my_punt_max_equip[] IS INITIAL.
          LOOP AT lt_dades_equi ASSIGNING FIELD-SYMBOL(<fs_equip_basic>) WHERE z_equip_basic IS NOT INITIAL.
            READ TABLE my_punt_max_equip TRANSPORTING NO FIELDS WITH KEY z_num_ofer        = <fs_equip_basic>-z_num_ofer
                                                                         z_comptador_equip = <fs_equip_basic>-z_comptador_equip.
            IF sy-subrc <> 0.
              CLEAR: wa_punt_max_equip.
              LOOP AT my_punt_ofer ASSIGNING FIELD-SYMBOL(<fs_punt_ofer_equi2>) WHERE z_num_equip = <fs_equip_basic>-z_comptador_equip
                                                                                  AND z_num_gen   = <fs_equip_basic>-z_num_ofer.
                ADD <fs_punt_ofer_equi2>-z_punts TO wa_punt_max_equip-z_punts.
              ENDLOOP.
              wa_punt_max_equip-z_descripcio      = <fs_equip_basic>-z_descripcio.
*        wa_punt_max_equip-z_text_carrec     = ''.
              wa_punt_max_equip-z_carrec_equip    = <fs_equip_basic>-z_carrec_equip.
              wa_punt_max_equip-z_comptador_equip = <fs_equip_basic>-z_comptador_equip.
              wa_punt_max_equip-z_num_ofer        = <fs_equip_basic>-z_num_ofer.
              wa_punt_max_equip-z_pes             = <fs_equip_basic>-z_pes.
              wa_punt_max_equip-z_punts_pes       = wa_punt_max_equip-z_punts * ( <fs_equip_basic>-z_pes / 100 ).
              APPEND wa_punt_max_equip TO my_punt_max_equip.
            ENDIF.
          ENDLOOP.
        ENDIF.
      ENDIF.
      ">> SPEC-66771, Inici Modificació - ETODR
      IF my_punt_gen_equi IS INITIAL.
        READ TABLE my_crit_punt TRANSPORTING NO FIELDS WITH KEY z_equip_sep = abap_on.
        IF sy-subrc = 0.
          SELECT *
            FROM zrm_dt_punt_equi
            INTO TABLE @DATA(lt_dades_equi_aux)
            WHERE docclass    = @im_docclass
              AND objectid    = @im_objectid
              AND z_is_header = @abap_on.
          DATA(lv_index) = sy-tabix.
          lv_index = 1.
          LOOP AT my_punt_ofer ASSIGNING FIELD-SYMBOL(<fs_punt_ofer_aux>).
            CLEAR: ls_punt_gen_equi.
            MOVE-CORRESPONDING <fs_punt_ofer_aux> TO ls_punt_gen_equi.
            LOOP AT lt_dades_equi_aux ASSIGNING FIELD-SYMBOL(<fs_equip_aux>)
              WHERE z_codi_crit_punt = <fs_punt_ofer_aux>-z_codi_crit_punt
                AND z_num_ofer       = <fs_punt_ofer_aux>-z_num_gen.
              ls_punt_gen_equi-z_carrec_equip = <fs_equip_aux>-z_carrec_equip.
              ls_punt_gen_equi-z_num_equip    = <fs_equip_aux>-z_comptador_equip.
              INSERT ls_punt_gen_equi INTO my_punt_gen_equi INDEX lv_index.
              lv_index = lv_index + 1.
            ENDLOOP.
            IF sy-subrc <> 0.
              INSERT ls_punt_gen_equi INTO my_punt_gen_equi INDEX lv_index.
              lv_index = lv_index + 1.
            ENDIF.
          ENDLOOP.
        ENDIF.
      ENDIF.
      "<< SPEC-66771, Final Modificació - ETODR

"INICI - SPEC-90501 - EVMRG - S'ha comentat al codi de la PEC-73458.
      ">> SPEC-74358, Inici Modificació - ETODR
*      IF my_punt_gen_equi IS INITIAL.
*        "Si hi ha coautors sempre que accedim sense fer canvis no recupera my_punt_Gen_equi, la simulem
*        READ TABLE my_crit_punt TRANSPORTING NO FIELDS WITH KEY z_equip_coautor   = abap_on
*                                                                z_equip_sep       = abap_off
*                                                                z_equip_pdm       = abap_off
*                                                                z_equip_max       = abap_off
*                                                                z_coeficient_iref = space.
*        IF sy-subrc = 0.
*          SELECT *
*            FROM zrm_dt_punt_equi
*            INTO TABLE @lt_dades_equi_aux
*            WHERE docclass    = @im_docclass
*              AND objectid    = @im_objectid.
**              AND z_is_header = @abap_on.
*          lv_index = 1.
*          LOOP AT my_punt_ofer ASSIGNING <fs_punt_ofer_aux>.
*            CLEAR: ls_punt_gen_equi.
*            MOVE-CORRESPONDING <fs_punt_ofer_aux> TO ls_punt_gen_equi.
*            LOOP AT lt_dades_equi_aux ASSIGNING <fs_equip_aux>
*              WHERE z_codi_crit_punt = <fs_punt_ofer_aux>-z_codi_crit_punt
*                AND z_num_ofer       = <fs_punt_ofer_aux>-z_num_gen
*                AND z_is_header      = abap_on.
*              ls_punt_gen_equi-z_carrec_equip = <fs_equip_aux>-z_carrec_equip.
*              ls_punt_gen_equi-z_num_equip    = <fs_equip_aux>-z_comptador_equip.
*              CLEAR: ls_punt_gen_equi-z_punts.
*              INSERT ls_punt_gen_equi INTO my_punt_gen_equi INDEX lv_index.
*              lv_index = lv_index + 1.
*            ENDLOOP.
*            IF sy-subrc <> 0.
*              INSERT ls_punt_gen_equi INTO my_punt_gen_equi INDEX lv_index.
*              lv_index = lv_index + 1.
*            ENDIF.
*          ENDLOOP.
*        ENDIF.
*      ENDIF.
      "<< SPEC-74358, Final Modificació - ETODR
"FI - SPEC-90501 - EVMRG
    ENDIF.
*** << FI MODIF ETODR SPEC-49806
*>> INICI - SPEC-75738 - ECMRG

    recalculate_val_basat_marc( EXPORTING ch_crit_punt = my_crit_punt
                                CHANGING ch_punt_gen = my_punt_ofer ).

*<< FI - SPEC-75738 - ECMRG


  ENDMETHOD.


  METHOD set_dyn_data_formulari.
*    DATA:
**    DATA: lt_dades_form_dyn  TYPE STANDARD TABLE OF zrm_dt_punt_form.
**          lt_dades_punt      TYPE zrm_cl_valoracio_ofertes=>ty_t_puntuacio_subapartats,
**          lt_dades_mult_punt TYPE zrm_cl_valoracio_ofertes=>ty_t_motiv_subapartats_mult,
**          wa_puntuacio       TYPE zrm_cl_valoracio_ofertes=>ty_s_puntuacio_subapartats,
**          wa_puntuacio_mult  TYPE zrm_cl_valoracio_ofertes=>ty_s_motiv_subapartats_mult,
*          wa_crit_rel        TYPE zrm_cl_valoracio_ofertes_fe=>ty_s_crit_rel,
**          lv_codi_text       TYPE thead-tdname,
**          l_dummy_recurs     TYPE z_compta_rec,
*          l_tabix            TYPE i.
*
**    CLEAR: gt_dades_punt[], gt_punt_ofer_dyn[].
**    CLEAR: my_punt_max_equip[], my_punt_gen_equi[].
*
*    CALL METHOD read_and_check_plec
*      EXPORTING
*        im_header    = my_exp_cont_db
*      IMPORTING
*        ex_crit_punt = my_crit_punt.
*
*
*    SELECT *
*      FROM zrm_dt_punt_form
*      INTO TABLE @DATA(lt_dades_form_dyn)
*      WHERE docclass = @im_docclass
*        AND objectid = @im_objectid.
*
*    SELECT *
*      FROM zrm_dt_punt_efor
*      INTO TABLE @DATA(lt_dades_efor_equi)
*      WHERE docclass    = @im_docclass
*        AND objectid    = @im_objectid
*        AND z_is_header = @abap_off.
*
*    IF lt_dades_form_dyn[] IS NOT INITIAL.
*      SELECT *
*        FROM zrm_dm_suapar_pt
*        INTO TABLE @DATA(lt_suapar_pt)
*        FOR ALL ENTRIES IN @lt_dades_form_dyn
*          WHERE z_codi_subapar_punt EQ @lt_dades_form_dyn-z_codi_subapar_punt
*            AND z_codi_subapar_punt_rel EQ @lt_dades_form_dyn-z_codi_subapar_punt.
*    ELSEIF my_crit_punt[] IS NOT INITIAL.
*      SELECT *
*        FROM zrm_dm_suapar_pt
*        INTO TABLE @lt_suapar_pt
*        FOR ALL ENTRIES IN @my_crit_punt
*          WHERE z_codi_subapar_punt     EQ @my_crit_punt-z_codi_subapar_punt
*            AND z_codi_subapar_punt_rel EQ @my_crit_punt-z_codi_subapar_punt.
*    ENDIF.
*
*
*    READ TABLE lt_dades_form_dyn ASSIGNING FIELD-SYMBOL(<fs_punt_form_db>) INDEX 1.
*    CHECK sy-subrc = 0.
*
*********************    set_dades_ofer_dyn( EXPORTING it_punt_ofer_dyn = lt_dades_ofer_dyn ).
**
**    LOOP AT lt_dades_ofer_dyn ASSIGNING FIELD-SYMBOL(<fs_punt_ofer>).
**      CLEAR: wa_puntuacio, lv_codi_text.
**
**      wa_puntuacio-z_codi_crit_punt         = <fs_punt_ofer>-z_codi_crit_punt.
**      wa_puntuacio-z_codi_subapar_punt      = <fs_punt_ofer>-z_codi_subapar_punt.
**      wa_puntuacio-docclass                 = <fs_punt_ofer>-docclass.
**      wa_puntuacio-objectid                 = <fs_punt_ofer>-objectid.
**      wa_puntuacio-z_num_ofer               = <fs_punt_ofer>-z_num_ofer.
**      wa_puntuacio-z_sec                    = <fs_punt_ofer>-z_sec.
**      wa_puntuacio-z_punts                  = <fs_punt_ofer>-z_punts.
**** >> INI MODIF ETODR SPEC-49075
**      wa_puntuacio-z_punts_no_pond          = <fs_punt_ofer>-z_punts_no_pond.
**** << FI MODIF ETODR SPEC-49075
**      IF <fs_punt_ofer>-z_codi_subapar_punt IS INITIAL.
**
**        READ TABLE lt_dades_equi TRANSPORTING NO FIELDS WITH KEY z_codi_crit_punt = <fs_punt_ofer>-z_codi_crit_punt.
**        IF sy-subrc NE 0.
**
**          CONCATENATE 'Z' im_objectid <fs_punt_ofer>-z_num_ofer <fs_punt_ofer>-z_codi_crit_punt
**                      <fs_punt_ofer>-z_codi_subapar_punt <fs_punt_ofer>-z_sec l_dummy_recurs INTO lv_codi_text.
**
**          CREATE OBJECT wa_puntuacio-z_motivacio
**            EXPORTING
**              i_docclass = im_docclass
**              i_objectid = im_objectid
**              i_tdid     = 'ZMOT'
**              i_tdspras  = sy-langu
**              i_tdname   = lv_codi_text
**              i_tdobject = 'Z_PUNT_DYN'
**            EXCEPTIONS
**              OTHERS     = 0.
**
**          CREATE OBJECT wa_puntuacio-z_comentaris
**            EXPORTING
**              i_docclass = im_docclass
**              i_objectid = im_objectid
**              i_tdid     = 'ZCOM'
**              i_tdspras  = sy-langu
**              i_tdname   = lv_codi_text
**              i_tdobject = 'Z_PUNT_DYN'
**            EXCEPTIONS
**              OTHERS     = 0.
**          APPEND wa_puntuacio TO lt_dades_punt.
**        ELSE.
**          LOOP AT lt_dades_equi ASSIGNING FIELD-SYMBOL(<fs_equi>)
**           WHERE z_codi_crit_punt = <fs_punt_ofer>-z_codi_crit_punt AND
**                 z_num_ofer       = <fs_punt_ofer>-z_num_ofer.
**
**
**            CONCATENATE 'Z' im_objectid <fs_punt_ofer>-z_num_ofer <fs_punt_ofer>-z_codi_crit_punt
****        >> INI MODIF ETODR SPEC-49582
***                        <fs_punt_ofer>-z_codi_subapar_punt <fs_punt_ofer>-z_sec l_dummy_recurs <fs_equi>-z_comptador_equip INTO lv_codi_text.
**                        <fs_punt_ofer>-z_codi_subapar_punt <fs_punt_ofer>-z_sec <fs_equi>-z_comptador_equip INTO lv_codi_text.
****        << FI MODIF ETODR SPEC-49582
**            CREATE OBJECT wa_puntuacio-z_motivacio
**              EXPORTING
**                i_docclass = im_docclass
**                i_objectid = im_objectid
**                i_tdid     = 'ZMOT'
**                i_tdspras  = sy-langu
**                i_tdname   = lv_codi_text
**                i_tdobject = 'Z_PUNT_DYN'
**              EXCEPTIONS
**                OTHERS     = 0.
**
**            CREATE OBJECT wa_puntuacio-z_comentaris
**              EXPORTING
**                i_docclass = im_docclass
**                i_objectid = im_objectid
**                i_tdid     = 'ZCOM'
**                i_tdspras  = sy-langu
**                i_tdname   = lv_codi_text
**                i_tdobject = 'Z_PUNT_DYN'
**              EXCEPTIONS
**                OTHERS     = 0.
**            wa_puntuacio-z_pes = <fs_equi>-z_pes.
**            wa_puntuacio-z_punts = <fs_equi>-z_punts.
**            wa_puntuacio-z_num_equip = <fs_equi>-z_comptador_equip.
**            APPEND wa_puntuacio TO lt_dades_punt.
**          ENDLOOP.
**        ENDIF.
**
*****INI MOD ETJHG - SPEC-46407
**      ELSE.
**        "Si tiene código subapar miramos en la tabla ZRM_DT_PUNT_REC cual es el número de comptador para poder leer el motivo correctamente
**        "añadiendo el campo z_comptador_recurs a la concatenación de campos que ya estaban por defecto
**        LOOP AT lt_punt_mult_rec ASSIGNING FIELD-SYMBOL(<fs_mult_rec_pt>) WHERE z_num_ofer EQ <fs_punt_ofer>-z_num_ofer
**                                                                            AND z_mod_crit_punt  EQ <fs_punt_ofer>-z_mod_crit_punt
**                                                                            AND z_codi_crit_punt EQ <fs_punt_ofer>-z_codi_crit_punt.
**
**          CONCATENATE 'Z' im_objectid <fs_punt_ofer>-z_num_ofer <fs_punt_ofer>-z_codi_crit_punt
**                      <fs_punt_ofer>-z_codi_subapar_punt <fs_mult_rec_pt>-z_sec <fs_mult_rec_pt>-z_comptador_recurs INTO lv_codi_text.
**
**          CREATE OBJECT wa_puntuacio-z_motivacio
**            EXPORTING
**              i_docclass = im_docclass
**              i_objectid = im_objectid
**              i_tdid     = 'ZMOT'
**              i_tdspras  = sy-langu
**              i_tdname   = lv_codi_text
**              i_tdobject = 'Z_PUNT_DYN'
**            EXCEPTIONS
**              OTHERS     = 0.
**
**          CREATE OBJECT wa_puntuacio-z_comentaris
**            EXPORTING
**              i_docclass = im_docclass
**              i_objectid = im_objectid
**              i_tdid     = 'ZCOM'
**              i_tdspras  = sy-langu
**              i_tdname   = lv_codi_text
**              i_tdobject = 'Z_PUNT_DYN'
**            EXCEPTIONS
**              OTHERS     = 0.
**
**          wa_puntuacio-z_sec = <fs_mult_rec_pt>-z_sec.
**          wa_puntuacio-z_compta_rec = <fs_mult_rec_pt>-z_comptador_recurs.
**
**          IF <fs_mult_rec_pt>-z_comptador_recurs EQ '000'.
**            wa_puntuacio-z_punts = <fs_mult_rec_pt>-z_punts.
**          ENDIF.
**
**          APPEND wa_puntuacio TO lt_dades_punt.
**        ENDLOOP.
****       >> INI MODIF ETODR SPEC-49500
***        IF sy-subrc NE 0. "ETLJS SPEC-47173
***          APPEND wa_puntuacio TO lt_dades_punt.
***        ENDIF.
****       << FI MODIF ETODR SPEC-49500
****        >> INI MODIF ETODR SPEC-47173
**        LOOP AT lt_punt_mult_sel ASSIGNING <fs_mult_sel> WHERE z_codi_crit_punt = <fs_punt_ofer>-z_codi_crit_punt.
**          CLEAR: wa_puntuacio_mult, lv_codi_text.
**
**          wa_puntuacio_mult-z_codi_crit_punt         = <fs_punt_ofer>-z_codi_crit_punt.
**          wa_puntuacio_mult-z_codi_subapar_punt      = <fs_punt_ofer>-z_codi_subapar_punt.
**          wa_puntuacio_mult-docclass                 = <fs_punt_ofer>-docclass.
**          wa_puntuacio_mult-objectid                 = <fs_punt_ofer>-objectid.
**          wa_puntuacio_mult-z_num_ofer               = <fs_mult_sel>-z_num_ofer.          "SPEC-49499 ETJMD 07.06.2018
**          wa_puntuacio_mult-z_sec                    = <fs_mult_sel>-z_sec.
**          wa_puntuacio_mult-z_punts                  = <fs_punt_ofer>-z_punts.
**          wa_puntuacio_mult-z_num_equip              = <fs_mult_sel>-z_comptador_recurs.  "SPEC-49499 ETJMD 07.06.2018
**
**          CONCATENATE 'Z' im_objectid <fs_mult_sel>-z_num_ofer <fs_punt_ofer>-z_codi_crit_punt
****        >> INI MODIF ETODR SPEC-49582
***                      <fs_punt_ofer>-z_codi_subapar_punt <fs_mult_sel>-z_sec l_dummy_recurs <fs_mult_sel>-z_comptador_recurs INTO lv_codi_text.
**                      <fs_punt_ofer>-z_codi_subapar_punt <fs_mult_sel>-z_sec <fs_mult_sel>-z_comptador_recurs INTO lv_codi_text.
****        << FI MODIF ETODR SPEC-49582
**          CREATE OBJECT wa_puntuacio_mult-z_motivacio
**            EXPORTING
**              i_docclass = im_docclass
**              i_objectid = im_objectid
**              i_tdid     = 'ZMOT'
**              i_tdspras  = sy-langu
**              i_tdname   = lv_codi_text
**              i_tdobject = 'Z_PUNT_DYN'
**            EXCEPTIONS
**              OTHERS     = 0.
**
**          CREATE OBJECT wa_puntuacio_mult-z_comentaris
**            EXPORTING
**              i_docclass = im_docclass
**              i_objectid = im_objectid
**              i_tdid     = 'ZCOM'
**              i_tdspras  = sy-langu
**              i_tdname   = lv_codi_text
**              i_tdobject = 'Z_PUNT_DYN'
**            EXCEPTIONS
**              OTHERS     = 0.
**          READ TABLE lt_dades_mult_punt TRANSPORTING NO FIELDS WITH KEY z_codi_crit_punt = wa_puntuacio_mult-z_codi_crit_punt
**                                                                        z_sec            = wa_puntuacio_mult-z_sec
**                                                                        z_num_ofer       = wa_puntuacio_mult-z_num_ofer
**                                                                        z_num_equip      = wa_puntuacio_mult-z_num_equip.      "SPEC-49499 ETJMD 07.06.2018
**          IF sy-subrc <> 0.
**            APPEND wa_puntuacio_mult TO lt_dades_mult_punt.
**          ENDIF.
**        ENDLOOP.
****        << FI MODIF ETODR SPEC-47173
****       >> INI MODIF ETODR SPEC-49500
**        LOOP AT lt_dades_equi ASSIGNING FIELD-SYMBOL(<fs_mult_equi_pt>) WHERE z_num_ofer EQ <fs_punt_ofer>-z_num_ofer
**                                                                          AND z_mod_crit_punt  EQ <fs_punt_ofer>-z_mod_crit_punt
**                                                                          AND z_codi_crit_punt EQ <fs_punt_ofer>-z_codi_crit_punt.
**
**          CONCATENATE 'Z' im_objectid <fs_punt_ofer>-z_num_ofer <fs_punt_ofer>-z_codi_crit_punt
**                      <fs_punt_ofer>-z_codi_subapar_punt <fs_mult_equi_pt>-z_sec <fs_mult_equi_pt>-z_comptador_equip INTO lv_codi_text.
**
**          CREATE OBJECT wa_puntuacio-z_motivacio
**            EXPORTING
**              i_docclass = im_docclass
**              i_objectid = im_objectid
**              i_tdid     = 'ZMOT'
**              i_tdspras  = sy-langu
**              i_tdname   = lv_codi_text
**              i_tdobject = 'Z_PUNT_DYN'
**            EXCEPTIONS
**              OTHERS     = 0.
**
**          CREATE OBJECT wa_puntuacio-z_comentaris
**            EXPORTING
**              i_docclass = im_docclass
**              i_objectid = im_objectid
**              i_tdid     = 'ZCOM'
**              i_tdspras  = sy-langu
**              i_tdname   = lv_codi_text
**              i_tdobject = 'Z_PUNT_DYN'
**            EXCEPTIONS
**              OTHERS     = 0.
**
**          wa_puntuacio-z_sec       = <fs_mult_equi_pt>-z_sec.
**          wa_puntuacio-z_num_equip = <fs_mult_equi_pt>-z_comptador_equip.
**
***          IF <fs_mult_equi_pt>-z_comptador_equip EQ '000'. "SPEC-49500
**          wa_puntuacio-z_punts = <fs_mult_equi_pt>-z_punts.
***          ENDIF.
**
**          APPEND wa_puntuacio TO lt_dades_punt.
**        ENDLOOP.
**        IF sy-subrc NE 0.
**          APPEND wa_puntuacio TO lt_dades_punt.
**        ENDIF.
****      << FI MODIF ETODR SPEC-49500
**      ENDIF.
*****FIN MOD ETJHG - SPEC-46407
**    ENDLOOP.
**    gt_dades_punt = lt_dades_punt.
**    gt_dades_motiv_multiples = lt_dades_mult_punt.
*
*    "Guardem taula de relació per a poder fer els càlculs dinàmics
*    LOOP AT my_crit_punt ASSIGNING FIELD-SYMBOL(<fs_crit_punt>).
*      CLEAR: wa_crit_rel.
*      wa_crit_rel-z_mod_crit_punt = <fs_crit_punt>-z_mod_crit_punt.
*      wa_crit_rel-z_parent        = <fs_crit_punt>-z_codi_crit_punt.
*      IF <fs_crit_punt>-sum_info IS NOT INITIAL.
*        LOOP AT <fs_crit_punt>-sum_info ASSIGNING FIELD-SYMBOL(<fs_sum_info>).
*          wa_crit_rel-z_child = <fs_sum_info>-z_codi_crit_punt.
*          CHECK wa_crit_rel-z_parent IS NOT INITIAL.
*          APPEND wa_crit_rel TO gt_crit_dyn_rel.
*        ENDLOOP.
*      ENDIF.
*    ENDLOOP.
*
*    "Eliminem de la taula de sumatoris els criteris amb el flag de resta informat
*    DESCRIBE TABLE my_crit_punt LINES DATA(l_num_crits).
*    l_tabix = l_num_crits .
*    DO l_num_crits TIMES .
*      READ TABLE my_crit_punt ASSIGNING FIELD-SYMBOL(<ls_crit_punt>) INDEX l_tabix .
*      l_tabix = l_tabix - 1 .
*      LOOP AT <ls_crit_punt>-sum_info ASSIGNING FIELD-SYMBOL(<fs_suminfo_aux>).
*        READ TABLE my_crit_punt ASSIGNING FIELD-SYMBOL(<fs_crit>) WITH KEY z_codi_crit_punt = <fs_suminfo_aux>-z_codi_crit_punt.
*        IF sy-subrc = 0 AND <fs_crit>-z_resta IS NOT INITIAL.
*          DELETE <ls_crit_punt>-sum_info.
*        ENDIF.
*      ENDLOOP.
*    ENDDO.
*
*
**    DATA: wa_punt_max_equip TYPE zst_equip_max.
**    "Inicialitzem la taula d'equips màxims
**    IF lt_dades_equi[] IS NOT INITIAL.
**      READ TABLE lt_dades_equi TRANSPORTING NO FIELDS WITH KEY z_equip_max = abap_on. "Només entrem aquí si és un Model de Puntuació d'Equip Màxim
**      IF sy-subrc = 0.
**        LOOP AT lt_dades_equi ASSIGNING FIELD-SYMBOL(<fs_equip_max>) WHERE z_equip_max IS NOT INITIAL.
**          READ TABLE my_punt_max_equip TRANSPORTING NO FIELDS WITH KEY z_num_ofer        = <fs_equip_max>-z_num_ofer
**                                                                       z_comptador_equip = <fs_equip_max>-z_comptador_equip.
**          IF sy-subrc <> 0.
**            CLEAR: wa_punt_max_equip.
**            LOOP AT my_punt_ofer ASSIGNING FIELD-SYMBOL(<fs_punt_ofer_equi>) WHERE z_num_equip = <fs_equip_max>-z_comptador_equip
**                                                                               AND z_num_gen   = <fs_equip_max>-z_num_ofer.
**              ADD <fs_punt_ofer_equi>-z_punts TO wa_punt_max_equip-z_punts.
**            ENDLOOP.
**            wa_punt_max_equip-z_descripcio      = <fs_equip_max>-z_descripcio.
***        wa_punt_max_equip-z_text_carrec     = ''.
**            wa_punt_max_equip-z_carrec_equip    = <fs_equip_max>-z_carrec_equip.
**            wa_punt_max_equip-z_comptador_equip = <fs_equip_max>-z_comptador_equip.
**            wa_punt_max_equip-z_num_ofer        = <fs_equip_max>-z_num_ofer.
**            wa_punt_max_equip-z_pes             = <fs_equip_max>-z_pes.
**            wa_punt_max_equip-z_punts_pes       = wa_punt_max_equip-z_punts * ( <fs_equip_max>-z_pes / 100 ).
**            APPEND wa_punt_max_equip TO my_punt_max_equip.
**          ENDIF.
**        ENDLOOP.
**        IF my_punt_max_equip[] IS INITIAL.
**          LOOP AT lt_dades_equi ASSIGNING FIELD-SYMBOL(<fs_equip_basic>) WHERE z_equip_basic IS NOT INITIAL.
**            READ TABLE my_punt_max_equip TRANSPORTING NO FIELDS WITH KEY z_num_ofer        = <fs_equip_basic>-z_num_ofer
**                                                                         z_comptador_equip = <fs_equip_basic>-z_comptador_equip.
**            IF sy-subrc <> 0.
**              CLEAR: wa_punt_max_equip.
**              LOOP AT my_punt_ofer ASSIGNING FIELD-SYMBOL(<fs_punt_ofer_equi2>) WHERE z_num_equip = <fs_equip_basic>-z_comptador_equip
**                                                                                  AND z_num_gen   = <fs_equip_basic>-z_num_ofer.
**                ADD <fs_punt_ofer_equi2>-z_punts TO wa_punt_max_equip-z_punts.
**              ENDLOOP.
**              wa_punt_max_equip-z_descripcio      = <fs_equip_basic>-z_descripcio.
***        wa_punt_max_equip-z_text_carrec     = ''.
**              wa_punt_max_equip-z_carrec_equip    = <fs_equip_basic>-z_carrec_equip.
**              wa_punt_max_equip-z_comptador_equip = <fs_equip_basic>-z_comptador_equip.
**              wa_punt_max_equip-z_num_ofer        = <fs_equip_basic>-z_num_ofer.
**              wa_punt_max_equip-z_pes             = <fs_equip_basic>-z_pes.
**              wa_punt_max_equip-z_punts_pes       = wa_punt_max_equip-z_punts * ( <fs_equip_basic>-z_pes / 100 ).
**              APPEND wa_punt_max_equip TO my_punt_max_equip.
**            ENDIF.
**          ENDLOOP.
**        ENDIF.
**      ENDIF.
**    ENDIF.
  ENDMETHOD.


  METHOD set_if_circul_punt_iniciada.
    DATA: lt_elements_id  TYPE rmps_soa_rec_element_identt,
          lt_elements_id2 TYPE rmps_soa_rec_element_identt,
          s_circulars     TYPE srmdpdisp,
          s_elements_id   TYPE bapisrmrec_element_ident,
          s_elements_id2  TYPE bapisrmrec_element_ident,
          lv_tabix        TYPE sy-tabix,
          lv_tabix2       TYPE sy-tabix.

    CALL FUNCTION 'BAPI_RECORD_GETELEMENTS'
      EXPORTING
        objectid               = my_exp_cont-objectid
        documentclass          = my_exp_cont-docclass
      TABLES
        element_identification = lt_elements_id.

    lt_elements_id2[] = lt_elements_id[].
    LOOP AT lt_elements_id INTO s_elements_id . "
      lv_tabix  = sy-tabix.
      lv_tabix2 = lv_tabix + 1.
      IF s_elements_id-value = 'ZSRM_DISPOSITION_PT'.
        READ TABLE lt_elements_id2 INTO s_elements_id2 INDEX lv_tabix2.
        IF s_elements_id2-name = 'DISPOSITION_ID'.
          SELECT COUNT(*)
            FROM srmdpdisp AS a
            INNER JOIN srmwfpath AS b
            ON a~pathid   = b~pathid AND
               a~actarea  = b~actarea
            WHERE a~disid  = s_elements_id2-value
              AND ( b~status = 1 OR b~status = 2 ).
          IF sy-subrc = 0.
            me->is_cp_iniciada = abap_on.
            DATA(l_disid) = s_elements_id2-value. "MODIF ETODR SPEC-48364
            EXIT.
          ENDIF.
        ENDIF.
      ENDIF.
    ENDLOOP.
**  >> INI MODIF ETODR SPEC-48364
    IF me->is_cp_iniciada = abap_on AND l_disid IS NOT INITIAL.


      ">>>SPEC:58153, Inici modificació  - ECJSA
      " afegim el condiciconal "AND DELFLAG = abap_false"
      " perque està tenint en compte els validadors eliminats
      "<<<SPEC:58153, Final modificació - ECJSA
      SELECT A~*
        FROM srmwfpthps AS a
        INNER JOIN srmdpdisp AS b
            ON a~pathid   = b~pathid AND
               a~actarea  = b~actarea
        INTO TABLE @DATA(lt_srmwfpthps)
        WHERE b~disid   = @l_disid
          AND a~delflag = @abap_false.


      IF sy-subrc = 0.
        DATA(l_num_validats) = 0.
        DESCRIBE TABLE lt_srmwfpthps LINES DATA(l_num_validadors).
        LOOP AT lt_srmwfpthps ASSIGNING FIELD-SYMBOL(<fs_validadors>).
          IF <fs_validadors>-enddate IS NOT INITIAL.
            ADD 1 TO l_num_validats.
          ENDIF.
        ENDLOOP.
        IF l_num_validats = l_num_validadors.
          me->is_cp_finished   = abap_on.
          SORT lt_srmwfpthps BY posid DESCENDING.
          READ TABLE lt_srmwfpthps ASSIGNING <fs_validadors> INDEX 1.
          IF sy-subrc = 0.
            me->g_cp_date_finished = <fs_validadors>-enddate.
          ENDIF.
        ENDIF.
      ENDIF.


    ENDIF.
**  >> INI MODIF ETODR SPEC-48364
  ENDMETHOD.


  METHOD set_is_nova_llei_92017.
    my_is_lcp_92017 = i_lcp_92017.
  ENDMETHOD.


  METHOD set_log_pt.
    TYPES t_lifnr TYPE STANDARD TABLE OF lifnr.

    DATA: lt_lifnr          TYPE t_lifnr,
          lt_lot_pt_clas    TYPE ty_t_log_pt_clas,
          wa_log_pt         TYPE zrm_dt_log_pt,
          wa_log_pt_clas    TYPE zrm_dt_log_pt_cl,
          wa_log_crit_punt  TYPE zrm_dt_log_pt_cr, "MODIF ETODR SPEC-41444
          l_compt           TYPE z_compt_reg_exp,
          l_ordre_puntuacio TYPE z_ordre,
          l_num_canvi       TYPE z_num_canvi.

    CHECK get_is_cp_iniciada( ) IS NOT INITIAL.

    "Es guarden els canvis a la BBDD en la DATA-HORA en que s'ha premut guardar
    DATA(l_data_mod_pt) = sy-datum.
    DATA(l_hora_mod_pt) = sy-uzeit.

    IF i_save_db IS NOT INITIAL .
      set_punt_ofer_calc_log( ). "Al guardar es recalculen els valors de la puntuació tècnica
      IF get_check_save_log( ) = abap_off. "Només s'han de guardar els canvis al guardar puntuacions i al confirmar puntuacions
        RETURN.
      ENDIF.
      IF my_log_pt_clas[] IS INITIAL OR my_log_pt[] IS INITIAL. "Només es guarda si hi ha hagut canvis al log
        RETURN.
      ENDIF.
    ENDIF.

    "Es recalcula la puntuació total de les ofertes per a tenir actualitzat el seu valor.
    TRY.
**      >> INI MODIF ETODR SPEC-49075
        DATA: l_mode TYPE char1.
        l_mode = co_mode_1_round.
        IF get_is_nova_llei_92017( ) = abap_on AND get_is_obert_preu( ) = abap_off.
          l_mode = zrm_cl_valoracio_ofertes=>co_mode_punt_quadre2b.
        ENDIF.
**      << FI MODIF ETODR SPEC-49075
        read_and_check_plec( EXPORTING  im_header              = my_exp_cont_db
                                        im_mode                = l_mode "co_mode_1_round "ETODR SPEC-49075
                             IMPORTING  ex_crit_punt           = DATA(lt_crit_punt)  ).

        recalculate_val_tecnic(  EXPORTING im_crit_punt = lt_crit_punt
                                 CHANGING  ch_punt_gen  = my_punt_ofer_calc_log  ).

        confirm_punt_tec_offers( EXPORTING  im_test       = abap_on       "En mode test per a no realitzar cap canvi a nivell de taules
                                            im_crit_punt  = lt_crit_punt  "Es passa el criteri de puntuació i no el de la ALV ja que pot ser que no es tingui el sumatori de punt. tècniques
                                            im_punt_ofer  = my_punt_ofer_calc_log
                                 IMPORTING  ex_ofertesx   = DATA(lt_ofertes) ).
      CATCH zcx_rm_valoracio.
        lt_ofertes = my_ofertesx.
    ENDTRY.

    IF i_save_db IS INITIAL.
      IF i_first_time IS NOT INITIAL.
        "El primer cop s'omple la taula amb les puntuacions inicials i la seva puntuació total
        LOOP AT lt_ofertes ASSIGNING FIELD-SYMBOL(<fs_ofertes_first_time>).
          wa_log_pt-z_codi_exp      = my_exp_cont-z_codi_exp.
          wa_log_pt-z_descrip_abr   = my_exp_cont-z_descrip_abr.
          wa_log_pt-z_proveidor     = <fs_ofertes_first_time>-proveidor.
          wa_log_pt-z_num_canvi     = my_num_canvi.
          APPEND wa_log_pt TO my_log_pt.

          wa_log_pt_clas-z_codi_exp   = my_exp_cont-z_codi_exp.
          wa_log_pt_clas-z_proveidor  = wa_log_pt-z_proveidor.
          wa_log_pt_clas-z_num_canvi  = wa_log_pt-z_num_canvi.
          wa_log_pt_clas-z_punt_tec   = <fs_ofertes_first_time>-z_punt_tec.
          APPEND wa_log_pt_clas TO my_log_pt_clas.
**>> INI MODIF ETODR SPEC-41444 "Es guarda la informació dels criteris de puntuació de cada proveidor per tenir una foto de les puntuacions que hi havia inicialment
          LOOP AT my_punt_ofer_calc_log INTO DATA(wa_aux_crit_punt) WHERE z_num_gen = <fs_ofertes_first_time>-z_num_ofer.
            CLEAR: wa_log_crit_punt.
            IF wa_aux_crit_punt-z_codi_crit_punt IS NOT INITIAL.
              wa_log_crit_punt-z_codi_exp         = my_exp_cont-z_codi_exp.
              wa_log_crit_punt-z_num_canvi        = my_num_canvi.
              wa_log_crit_punt-z_proveidor        = <fs_ofertes_first_time>-proveidor.
              wa_log_crit_punt-z_codi_crit_punt   = wa_aux_crit_punt-z_codi_crit_punt.
              wa_log_crit_punt-z_punts            = wa_aux_crit_punt-z_punts.
              APPEND wa_log_crit_punt TO my_log_pt_crit_punt.
            ENDIF.
          ENDLOOP.
**<< FI MODIF ETODR SPEC-41444
        ENDLOOP.
        SORT my_log_pt      BY z_num_canvi ASCENDING.
        SORT my_log_pt_clas BY z_num_canvi ASCENDING.
        "Incrementem en 1 el comptador de canvis ja que el canvi número 0 és una foto de com estaven les puntuacions abans de realitzra modificacions
        ADD 1 TO my_num_canvi.
      ELSE.
        IF it_canvis_punt IS NOT INITIAL.
          "Es guarden les entrades a la memòria local els canvis realitzats
          LOOP AT lt_ofertes ASSIGNING FIELD-SYMBOL(<fs_ofertes>).
            READ TABLE it_canvis_punt INTO DATA(wa_canvis_punt) WITH KEY proveidor = <fs_ofertes>-proveidor.
            IF sy-subrc = 0.
              wa_log_pt-z_codi_crit_punt  = wa_canvis_punt-z_codi_crit_punt.
              wa_log_pt-z_punt_anterior   = wa_canvis_punt-z_punt_ant.
              wa_log_pt-z_punt_posterior  = wa_canvis_punt-z_punt_post.
              wa_log_pt-z_codi_esm        = wa_canvis_punt-z_codi_esm.          "Modif SPEC-42402 ETXGL
              wa_log_pt-z_motiu           = wa_canvis_punt-z_motiu.
            ELSE.
              CONTINUE.
            ENDIF.
            "Es guarda la capçalera de log de canvis a PT
            wa_log_pt-z_codi_exp      = my_exp_cont-z_codi_exp.
            wa_log_pt-z_proveidor     = <fs_ofertes>-proveidor.
            wa_log_pt-z_descrip_abr   = my_exp_cont-z_descrip_abr.
            wa_log_pt-z_num_canvi     = my_num_canvi.
**>> INI MODIF ETABT SPEC-46669 " Afegir al LOG de puntuacions tècniques l'usuari que ha fet els canvis
            wa_log_pt-z_cod_usuari    = sy-uname.
            "Es guarden els canvis a la BBDD en la DATA-HORA en que s'ha premut guardar

            wa_log_pt-z_data_mod_pt = l_data_mod_pt.
            wa_log_pt-z_hora_mod_pt = l_hora_mod_pt.

**<< FI MODIF ETABT SPEC-46669
            APPEND wa_log_pt TO my_log_pt.

            "Es guarden les entrades de la classificació d'ofertes log de canvis PT
            READ TABLE my_log_pt_clas TRANSPORTING NO FIELDS WITH KEY z_num_canvi = wa_log_pt-z_num_canvi
                                                                      z_proveidor = wa_log_pt-z_proveidor.
            IF sy-subrc <> 0.
              wa_log_pt_clas-z_codi_exp   = my_exp_cont-z_codi_exp.
              wa_log_pt_clas-z_proveidor  = wa_log_pt-z_proveidor.
              wa_log_pt_clas-z_num_canvi  = wa_log_pt-z_num_canvi.
              APPEND wa_log_pt_clas TO my_log_pt_clas.
            ENDIF.
          ENDLOOP.
        ENDIF.
      ENDIF.

    ELSE.

*      DATA(l_data_mod_pt) = sy-datum.
*      DATA(l_hora_mod_pt) = sy-uzeit.

*----- Es recorren totes les ofertes per guardar també els registre als quals no s'ha realitzat cap canvi -----*
      LOOP AT lt_ofertes ASSIGNING FIELD-SYMBOL(<fs_ofertes_aux>).
        READ TABLE my_log_pt TRANSPORTING NO FIELDS WITH KEY z_num_canvi = my_num_canvi
                                                             z_proveidor = <fs_ofertes_aux>-proveidor.
        IF sy-subrc <> 0.
          "Es guarda la capçalera de log de canvis a PT
          wa_log_pt-z_codi_exp      = my_exp_cont-z_codi_exp.
          wa_log_pt-z_descrip_abr   = my_exp_cont-z_descrip_abr.
          wa_log_pt-z_proveidor     = <fs_ofertes_aux>-proveidor.
          wa_log_pt-z_num_canvi     = my_num_canvi.
          APPEND wa_log_pt TO my_log_pt.

          "Es guarden les entrades de la classificació d'ofertes log de canvis PT
          READ TABLE my_log_pt_clas TRANSPORTING NO FIELDS WITH KEY z_num_canvi = wa_log_pt-z_num_canvi
                                                                    z_proveidor = wa_log_pt-z_proveidor.
          IF sy-subrc <> 0.
            wa_log_pt_clas-z_codi_exp   = my_exp_cont-z_codi_exp.
            wa_log_pt_clas-z_proveidor  = wa_log_pt-z_proveidor.
            wa_log_pt_clas-z_num_canvi  = wa_log_pt-z_num_canvi.
            APPEND wa_log_pt_clas TO my_log_pt_clas.
          ENDIF.
        ENDIF.
        APPEND <fs_ofertes_aux>-proveidor TO lt_lifnr.
      ENDLOOP.
*---------------------------------------------------------------------------------------------------------------*

*----- Es defineix el nombre de registres per expedient tractats -----*
      LOOP AT my_log_pt ASSIGNING FIELD-SYMBOL(<fs_pt>).
        CLEAR: l_compt.
        LOOP AT my_log_pt ASSIGNING FIELD-SYMBOL(<fs_pt_aux>) WHERE z_num_canvi = <fs_pt>-z_num_canvi
                                                                AND z_compt IS INITIAL.
          ADD 1 TO l_compt.
          <fs_pt_aux>-z_compt   = l_compt.
          <fs_pt_aux>-z_data_mod_pt = l_data_mod_pt.
          <fs_pt_aux>-z_hora_mod_pt = l_hora_mod_pt.
        ENDLOOP.
      ENDLOOP.
*----------------------------------------------------------------------*

*----- Es defineix l'ordre de cada proveïdor en funció de la seva puntuació -----*
      LOOP AT lt_ofertes ASSIGNING <fs_ofertes_aux>.
        LOOP AT my_log_pt_clas ASSIGNING FIELD-SYMBOL(<fs_pt_clas>) WHERE z_proveidor = <fs_ofertes_aux>-proveidor
                                                                      AND ( z_num_canvi = my_num_canvi AND z_num_canvi <> 0 ).
          <fs_pt_clas>-z_punt_tec   = <fs_ofertes_aux>-z_punt_tec.
        ENDLOOP.
      ENDLOOP.

      DATA(l_count) = 0.
      DO ( my_num_canvi + 1 ) TIMES.
        CLEAR: l_ordre_puntuacio.
        CLEAR: lt_lot_pt_clas[].
        LOOP AT my_log_pt_clas ASSIGNING <fs_pt_clas> WHERE z_num_canvi = l_count
                                                        AND z_ordre IS INITIAL.
          APPEND <fs_pt_clas> TO lt_lot_pt_clas.
        ENDLOOP.
        ADD 1 TO l_count.
        SORT lt_lot_pt_clas BY z_punt_tec DESCENDING z_proveidor ASCENDING.
        LOOP AT lt_lot_pt_clas ASSIGNING FIELD-SYMBOL(<fs_pt_clas_sorted>).
          ADD 1 TO l_ordre_puntuacio.
          READ TABLE my_log_pt_clas ASSIGNING <fs_pt_clas> WITH KEY z_proveidor = <fs_pt_clas_sorted>-z_proveidor
                                                                    z_num_canvi = <fs_pt_clas_sorted>-z_num_canvi.
          <fs_pt_clas>-z_ordre = l_ordre_puntuacio.
        ENDLOOP.
      ENDDO.
*---------------------------------------------------------------------------------*

      MODIFY zrm_dt_log_pt    FROM TABLE @my_log_pt.
      MODIFY zrm_dt_log_pt_cl FROM TABLE @my_log_pt_clas.
**>> INI MODIF ETODR SPEC-41444 "Es guarda la informació dels criteris de puntuació de cada proveidor per tenir una foto de les puntuacions que hi havia inicialment
      IF my_log_pt_crit_punt IS NOT INITIAL.
        MODIFY zrm_dt_log_pt_cr FROM TABLE @my_log_pt_crit_punt.
        CLEAR: my_log_pt_crit_punt[].
      ENDIF.
**<< FI MODIF ETODR SPEC-41444
      CLEAR: my_log_pt[],my_log_pt_clas[].
      "Al guardar incrementem el comptador de canvis realitzats per si es torna a realitzar alguna modificació sense sortir de la valoració de puntuacions
      ADD 1 TO my_num_canvi.
    ENDIF.
  ENDMETHOD.


  METHOD set_max_punts_equi.

    LOOP AT it_punt_max_equip ASSIGNING FIELD-SYMBOL(<fs>).
      DELETE my_punt_max_equip WHERE z_num_ofer = <fs>-z_num_ofer.
    ENDLOOP.

    LOOP AT it_punt_max_equip ASSIGNING <fs>.
      APPEND <fs> TO my_punt_max_equip.
    ENDLOOP.


  ENDMETHOD.


  METHOD set_motiu_canvi_punt.
    DATA: lt_text   TYPE wcb_tdline_tab,
          l_title   TYPE sy-title,
          l_changed TYPE xfeld,
          lv_string TYPE string,
          lv_codi_esmena TYPE z_codi_esm.                   "Modif SPEC-42402 ETXGL

    "Es recupera el proveiïdor i el criteri de puntuació del qual es realitzen canvis per a mostar-ho al títol de la finestra de text
    READ TABLE ct_canvis_punt INTO DATA(wa_aux) INDEX 1.
    CHECK sy-subrc = 0.
    CONCATENATE 'Motiu del canvi del crit.punt.' wa_aux-z_codi_crit_punt 'de' wa_aux-nom_proveidor
                                                                   INTO l_title SEPARATED BY space.

**>> INICI Modif SPEC-42402 ETXGL
    DO.
      CLEAR: l_changed,lt_text[], lv_codi_esmena.

      CALL FUNCTION 'ZRM_EDIT_TEXT_ESMENA'
        EXPORTING
          i_title       = l_title
          i_editable    = abap_on
          i_small       = abap_on
        IMPORTING
          e_modified    = l_changed
          e_codi_esmena = lv_codi_esmena                    "Modif SPEC-42402 ETXGL
        CHANGING
          ct_text       = lt_text.

      IF l_changed IS INITIAL OR lt_text[] IS INITIAL
                              OR lv_codi_esmena  IS INITIAL.
        CASE sy-ucomm.
          WHEN 'OK'.
              IF ( lt_text[] IS INITIAL
                   AND lv_codi_esmena IS INITIAL ).
                    MESSAGE i102.
              ELSEIF lt_text[] IS INITIAL.
                    MESSAGE i098.
              ELSEIF lv_codi_esmena IS INITIAL.
                    MESSAGE i103.
              ENDIF.
          WHEN 'CANCEL'.
            MESSAGE i099.
            RAISE cancelled.
          WHEN OTHERS.
            MESSAGE i099.
            RAISE cancelled.
        ENDCASE.
      ELSE.
        EXIT.
      ENDIF.

    ENDDO.
**<< FI Modif SPEC-42402 ETXGL

    LOOP AT lt_text ASSIGNING FIELD-SYMBOL(<line>).
      CONCATENATE lv_string <line> INTO lv_string RESPECTING BLANKS.
    ENDLOOP.
    LOOP AT ct_canvis_punt ASSIGNING FIELD-SYMBOL(<fs>).
      <fs>-z_motiu = lv_string.
      <fs>-z_codi_esm =  lv_codi_esmena.                       "Modif SPEC-42402 ETXGL
    ENDLOOP.
  ENDMETHOD.


  METHOD set_motivacio_mult.
    DATA: wa_dades_motiv TYPE zrm_cl_valoracio_ofertes=>ty_s_motiv_subapartats_mult,
          wa_mult_aux    TYPE zrm_cl_valoracio_ofertes=>ty_t_puntuacio_subapartats.

**>> INI SPEC-48559 ETJMD 13.06.2018
    CLEAR: wa_mult_aux.
    wa_mult_aux = it_dades_subapart.
    DELETE ADJACENT DUPLICATES FROM wa_mult_aux COMPARING z_codi_subapar_punt z_num_ofer z_num_equip.
    LOOP AT wa_mult_aux ASSIGNING FIELD-SYMBOL(<fs2>).
      DELETE gt_dades_motiv_multiples WHERE z_codi_subapar_punt = <fs2>-z_codi_subapar_punt AND
                                            z_num_ofer          = <fs2>-z_num_ofer          AND
                                            z_num_equip         = <fs2>-z_num_equip.
    ENDLOOP.
**<< FIN SPEC-48559 ETJMD 13.06.2018

    LOOP AT it_dades_subapart ASSIGNING FIELD-SYMBOL(<fs>).
      CLEAR: wa_dades_motiv.
      READ TABLE gt_dades_motiv_multiples ASSIGNING FIELD-SYMBOL(<fs_tot>) WITH KEY z_codi_subapar_punt = <fs>-z_codi_subapar_punt
                                                                                    z_num_ofer          = <fs>-z_num_ofer
                                                                                    z_sec               = <fs>-z_sec
                                                                                    z_num_equip         = <fs>-z_num_equip.
      IF sy-subrc = 0.
        MOVE-CORRESPONDING <fs> TO <fs_tot>.
      ELSE.
        MOVE-CORRESPONDING <fs> TO wa_dades_motiv.
        APPEND wa_dades_motiv TO gt_dades_motiv_multiples.
      ENDIF.
    ENDLOOP.
  ENDMETHOD.


  METHOD set_new_equip.
    DATA lv_cont TYPE i.


    LOOP AT gt_equip ASSIGNING FIELD-SYMBOL(<fs_equip_actual>).
      READ TABLE it_equip TRANSPORTING NO FIELDS WITH KEY z_num_ofer        = <fs_equip_actual>-z_num_ofer.
      IF sy-subrc = 0.
        ">>>SPEC-52548, Inici modificació  - ETODR
*          READ TABLE it_equip TRANSPORTING NO FIELDS WITH KEY z_num_ofer        = <fs_equip_actual>-z_num_ofer
        "<<<SPEC-52548, Final modificació - ETODR
        READ TABLE it_equip ASSIGNING FIELD-SYMBOL(<fs_new>) WITH KEY z_num_ofer        = <fs_equip_actual>-z_num_ofer
                                                                      z_codi_crit_punt  = <fs_equip_actual>-z_codi_crit_punt
                                                                      z_comptador_equip = <fs_equip_actual>-z_comptador_equip
                                                                      z_carrec_equip    = <fs_equip_actual>-z_carrec_equip.
        IF sy-subrc <> 0.
          DELETE gt_equip[].
        ELSE.
          ">>>SPEC-52548, Inici modificació  - ETODR
          <fs_equip_actual>-z_pes           = <fs_new>-z_pes.
          <fs_equip_actual>-z_descripcio    = <fs_new>-z_descripcio.
          <fs_equip_actual>-z_dedicacio_min = <fs_new>-z_dedicacio_min.
          <fs_equip_actual>-z_exclusivitat  = <fs_new>-z_exclusivitat.
          <fs_equip_actual>-z_punts         = <fs_new>-z_punts.
          "<<<SPEC-52548, Final modificació - ETODR
          ">> SPEC-67070, Inici Modificació - ETODR
          <fs_equip_actual>-z_acr_sing      = <fs_new>-z_acr_sing.
          <fs_equip_actual>-z_aplica_bim    = <fs_new>-z_aplica_bim.
          <fs_equip_actual>-z_imin          = <fs_new>-z_imin.
          "<< SPEC-67070, Final Modificació - ETODR
          ">> SPEC-71554, Inici Modificació - ETODR
          <fs_equip_actual>-z_tcqcoef       = <fs_new>-z_tcqcoef.
          "<< SPEC-71554, Final Modificació - ETODR
        ENDIF.
      ENDIF.
    ENDLOOP.

    LOOP AT it_equip ASSIGNING FIELD-SYMBOL(<fs_equip_new>).
      READ TABLE gt_equip ASSIGNING FIELD-SYMBOL(<fs_equip_act>) WITH KEY z_num_ofer        = <fs_equip_new>-z_num_ofer
                                                                          z_codi_crit_punt  = <fs_equip_new>-z_codi_crit_punt
                                                                          z_comptador_equip = <fs_equip_new>-z_comptador_equip
                                                                          z_carrec_equip    = <fs_equip_new>-z_carrec_equip.
      IF sy-subrc <> 0.
        APPEND <fs_equip_new> TO gt_equip.
      ELSE.
        <fs_equip_act>-z_dedicacio_ofertada = <fs_equip_new>-z_dedicacio_ofertada.
**        >> INI MODIF ETODR SPEC-61754
        <fs_equip_act>-z_imp_incr_a1            = <fs_equip_new>-z_imp_incr_a1.
        <fs_equip_act>-z_imp_incr_a2            = <fs_equip_new>-z_imp_incr_a2.
        <fs_equip_act>-z_imp_incr_a3            = <fs_equip_new>-z_imp_incr_a3.
        <fs_equip_act>-z_imp_incr_tot           = <fs_equip_new>-z_imp_incr_tot.
        <fs_equip_act>-z_presenta_singularitat  = <fs_equip_new>-z_presenta_singularitat.
**        << FI MODIF ETODR SPEC-61754
        ">> SPEC-67070, Inici Modificació - ETODR
        <fs_equip_act>-z_acr_sing            = <fs_equip_new>-z_acr_sing.
        <fs_equip_act>-z_aplica_bim          = <fs_equip_new>-z_aplica_bim.
        <fs_equip_act>-z_imin                = <fs_equip_new>-z_imin.
        "<< SPEC-67070, Final Modificació - ETODR
        ">> SPEC-71554, Inici Modificació - ETODR
        <fs_equip_act>-z_tcqcoef             = <fs_equip_new>-z_tcqcoef.
        "<< SPEC-71554, Final Modificació - ETODR
      ENDIF.
    ENDLOOP.
*>>INI ETLJS SPEC-51713
*
*    CALL METHOD read_and_check_punt_ofer
*      EXPORTING
*        im_header        = my_exp_cont_db
*        im_mod_crit_punt = my_plec-z_mod_crit_punt
*        im_crit_punt     = my_crit_punt
*        im_ofertesx      = my_ofertesx
*      IMPORTING
*        ex_punt_ofer     = my_punt_ofer
*        ex_punt_ofer_db  = my_punt_ofer_db.
*<<FIN ETLJS SPEC-51713
  ENDMETHOD.


METHOD set_punctuation.
  FIELD-SYMBOLS: <ls_crit_punt> TYPE ty_s_crit_punt,
                 <lt_punt_gen>  TYPE ty_t_punt_gen,
                 <ls_punt_gen>  TYPE ty_s_punt_gen.
  DATA: l_dummy TYPE c .                                    "#EC NEEDED

  IF my_locked IS INITIAL .
    RAISE EXCEPTION TYPE zcx_rm_valoracio
      EXPORTING
        textid = zcx_rm_valoracio=>not_opened_for_update.
  ENDIF .

  CASE im_mod_crit_punt .
    WHEN space .
      RAISE EXCEPTION TYPE zcx_rm_valoracio .

    WHEN my_plec-z_mod_crit_punt .
      IF my_exp_cont-z_vo_conf_dades IS NOT INITIAL .
        RAISE EXCEPTION TYPE zcx_rm_valoracio
          EXPORTING
            textid = zcx_rm_valoracio=>already_confirmed.
      ENDIF .

      IF check_activity( co_act_punct_1st ) IS INITIAL .
        RAISE EXCEPTION TYPE zcx_rm_valoracio.
      ENDIF .

      ASSIGN my_punt_ofer TO <lt_punt_gen> .
      IF im_descripcio IS SUPPLIED.
        READ TABLE my_crit_punt ASSIGNING <ls_crit_punt>
               WITH KEY z_codi_crit_punt = im_codi_crit_punt
                              z_mod_crit_punt  = im_mod_crit_punt
                              z_descripcio     = im_descripcio.
      ELSE.
        READ TABLE my_crit_punt ASSIGNING <ls_crit_punt>
       WITH TABLE KEY z_codi_crit_punt = im_codi_crit_punt
                      z_mod_crit_punt  = im_mod_crit_punt .
      ENDIF.
    WHEN my_plec-z_mod_crit_prop .
      IF my_exp_cont-z_vo_conf_dades IS INITIAL .
        RAISE EXCEPTION TYPE zcx_rm_valoracio
          EXPORTING
            textid = zcx_rm_valoracio=>not_confirmed_1st_yet.
      ENDIF .

      IF check_activity( co_act_punct_2nd ) IS INITIAL .
        RAISE EXCEPTION TYPE zcx_rm_valoracio.
      ENDIF .

      ASSIGN my_punt_lema TO <lt_punt_gen> .
      READ TABLE my_crit_punt_prop_graf ASSIGNING <ls_crit_punt>
             WITH TABLE KEY z_codi_crit_punt = im_codi_crit_punt
                            z_mod_crit_punt  = im_mod_crit_punt .
    WHEN my_plec-z_mod_crit_sol.
      IF my_exp_cont-z_sp_conf_dades IS NOT INITIAL .
        RAISE EXCEPTION TYPE zcx_rm_valoracio
          EXPORTING
            textid = zcx_rm_valoracio=>already_confirmed.
      ENDIF .

      IF check_activity( co_act_punct_sp ) IS INITIAL .
        RAISE EXCEPTION TYPE zcx_rm_valoracio.
      ENDIF .

      ASSIGN my_punt_sol_part TO <lt_punt_gen> .
      READ TABLE my_crit_punt_sol_part ASSIGNING <ls_crit_punt>
             WITH TABLE KEY z_codi_crit_punt = im_codi_crit_punt
                            z_mod_crit_punt  = im_mod_crit_punt .

    WHEN OTHERS .
      RAISE EXCEPTION TYPE zcx_rm_valoracio .
  ENDCASE .
***ETOVB SPEC-45341
*  IF    im_value  LT 0" <ls_crit_punt>-z_punt_min
  IF    im_value  LT <ls_crit_punt>-z_punt_min
***ETOVB SPEC-45341
     OR im_value  GT <ls_crit_punt>-z_punt_max .
***ETOVB SPEC-45341
*    MESSAGE e040 WITH <ls_crit_punt>-z_codi_crit_punt 0 "<ls_crit_punt>-z_punt_min
    MESSAGE e040 WITH <ls_crit_punt>-z_codi_crit_punt <ls_crit_punt>-z_punt_min
***ETOVB SPEC-45341
                      <ls_crit_punt>-z_punt_max INTO l_dummy .
    zcx_rm_valoracio=>raise_from_message( ) .
  ENDIF .

  IF    <ls_crit_punt>-z_sumatori IS NOT INITIAL
     OR <ls_crit_punt>-z_crit_ve  IS NOT INITIAL .
    MESSAGE e041 WITH <ls_crit_punt>-z_codi_crit_punt INTO l_dummy .
*<<INS EEMGA SPEC-7298 : Copy/paste en llistats ALV GRID no controla.....
    sap_error = 'X'.
*>>INS EEMGA SPEC-7298 : Copy/paste en llistats ALV GRID no controla.....
    zcx_rm_valoracio=>raise_from_message( ) .
  ENDIF .

  my_changed = 'X' .
*  >> INI ETLJS SPEC-47173
  em_num_equip = <ls_crit_punt>-z_num_equip.
  IF <ls_crit_punt>-z_equip EQ abap_true.
    READ TABLE <lt_punt_gen> ASSIGNING <ls_punt_gen>
               WITH KEY z_codi_crit_punt = im_codi_crit_punt
                        z_mod_crit_punt  = im_mod_crit_punt
                        z_num_gen        = im_key_gen
                        z_num_equip      = <ls_crit_punt>-z_num_equip.
  ELSE.
*   << FIN ETLJS SPEC-47173
    READ TABLE <lt_punt_gen> ASSIGNING <ls_punt_gen>
               WITH TABLE KEY z_codi_crit_punt = im_codi_crit_punt
                              z_mod_crit_punt  = im_mod_crit_punt
                              z_num_gen        = im_key_gen .
  ENDIF.
  CHECK sy-subrc = 0."<---- INS EEMGA
  <ls_punt_gen>-z_punts = im_value .
ENDMETHOD.


  METHOD set_punts_gen_equi.
    LOOP AT it_punt_gen ASSIGNING FIELD-SYMBOL(<fs>).
      DELETE my_punt_gen_equi WHERE z_num_gen = <fs>-z_num_gen.
    ENDLOOP.
    LOOP AT it_punt_gen ASSIGNING <fs>.
      INSERT <fs> INTO TABLE my_punt_gen_equi.
    ENDLOOP.
  ENDMETHOD.


  METHOD set_punt_co2.

    CLEAR my_punt_co2.
    SELECT * FROM zrm_dt_punt_co2
       INTO TABLE @my_punt_co2
            WHERE docclass    EQ @my_docclass AND
                  objectid    EQ @my_objectid.

  ENDMETHOD.


  method SET_PUNT_INCR.
    data: ls_incr TYPE zrm_dt_punt_incr.

  LOOP AT it_punts_offer ASSIGNING FIELD-SYMBOL(<fs_punt_offer>).
    READ TABLE my_punt_ofer ASSIGNING FIELD-SYMBOL(<fs_of>)
      with KEY z_codi_crit_punt = <fs_punt_offer>-z_codi_crit_punt
               z_num_gen        = <fs_punt_offer>-z_num_gen.

    IF sy-subrc eq 0.
      <fs_of>-z_punts = <fs_punt_offer>-z_punts.
    ENDIF.

  ENDLOOP.

  READ TABLE it_incr INTO ls_incr INDEX 1.
  DELETE my_incr WHERE z_num_ofer = ls_incr-z_num_ofer.

  APPEND LINES OF it_incr TO my_incr.

  endmethod.


  METHOD set_punt_incr_obj.

    DATA: ls_incr  TYPE zrm_dt_punt_equi.
    DATA: ls_inc2  TYPE zrm_dt_punt_equi.
    DATA: iv_punts TYPE z_punts.
    DATA: lv_coeficient_iref TYPE z_coeficient_iref.
    DATA: l_changed TYPE xfeld .

    FIELD-SYMBOLS <fs_ofer> TYPE ty_s_punt_gen.

    LOOP AT it_punts_offer ASSIGNING FIELD-SYMBOL(<fs_punt_offer>).

      MOVE-CORRESPONDING <fs_punt_offer> TO ls_incr.

      SELECT SINGLE z_coeficient_iref INTO lv_coeficient_iref
          FROM zrm_dm_crit_punt
          WHERE z_mod_crit_punt   EQ ls_incr-z_mod_crit_punt  AND
                z_codi_crit_punt  EQ ls_incr-z_codi_crit_punt AND
                ( z_coeficient_iref EQ '01' OR z_coeficient_iref EQ '02' ).

      CHECK sy-subrc EQ 0.

      ASSIGN COMPONENT iv_column-fieldname OF STRUCTURE <fs_punt_offer>
           TO FIELD-SYMBOL(<fs_punts>).

      READ TABLE my_punt_ofer ASSIGNING <fs_ofer>
           WITH KEY z_num_gen        = iv_oferta
                    z_mod_crit_punt  = ls_incr-z_mod_crit_punt
                    z_codi_crit_punt = ls_incr-z_codi_crit_punt.

      CLEAR: iv_punts.
      LOOP AT it_incr INTO ls_inc2.

        MODIFY gt_equip FROM ls_inc2
        TRANSPORTING z_punts z_imin z_imp_incr_tot z_acr_sing
                     z_imp_incr_a1 z_imp_incr_a2 z_imp_incr_a3
        WHERE z_num_ofer        = ls_inc2-z_num_ofer        AND
              z_mod_crit_punt   = ls_inc2-z_mod_crit_punt   AND
              z_codi_crit_punt  = ls_inc2-z_codi_crit_punt  AND
              z_carrec_equip    = ls_inc2-z_carrec_equip.

        IF lv_coeficient_iref EQ '02'.

          IF ls_inc2-z_aplica_bim IS NOT INITIAL.
            iv_punts = iv_punts + ( 1 * ( ls_inc2-z_punts * ls_inc2-z_pes / 100 ) ) .
          ELSE.
            iv_punts = iv_punts + ( 0 * ( ls_inc2-z_punts * ls_inc2-z_pes / 100 ) ).
          ENDIF.

        ELSE.
          iv_punts = iv_punts + ( ls_inc2-z_punts * ls_inc2-z_pes / 100 ).
        ENDIF.

        AT LAST.

          <fs_punts> = iv_punts.
          <fs_ofer>-z_punts = iv_punts.
          CONDENSE <fs_punts> NO-GAPS.

        ENDAT.

      ENDLOOP.

    ENDLOOP.

    l_changed = abap_true.
    CALL METHOD me->recalculate_val_tecnic2
      EXPORTING
        im_crit_punt = my_crit_punt
      IMPORTING
        ex_changed   = l_changed
      CHANGING
        ch_punt_gen  = my_punt_ofer.

  ENDMETHOD.


  METHOD set_punt_ofer_calc_log.

    DATA: wa_punt_ofer TYPE ty_s_punt_gen.

    CLEAR: my_punt_ofer_calc_log[].
    SELECT *
      FROM zrm_dt_punt_ofer
      INTO TABLE @DATA(lt_punt_ofer_db)
      WHERE docclass = @my_exp_cont_db-docclass
        AND objectid = @my_exp_cont_db-objectid.

    LOOP AT lt_punt_ofer_db ASSIGNING FIELD-SYMBOL(<fs_punt_gen_db>).
      wa_punt_ofer-z_mod_crit_punt  = <fs_punt_gen_db>-z_mod_crit_punt.
      wa_punt_ofer-z_codi_crit_punt = <fs_punt_gen_db>-z_codi_crit_punt.
      wa_punt_ofer-z_num_gen        = <fs_punt_gen_db>-z_num_ofer.
      wa_punt_ofer-z_punts          = <fs_punt_gen_db>-z_punts.
      APPEND wa_punt_ofer TO my_punt_ofer_calc_log.
    ENDLOOP.
  ENDMETHOD.


  method SET_PUNT_OFFER_PDM.
    LOOP AT it_punt_offer ASSIGNING FIELD-SYMBOL(<fs_punts_pdm>).
      LOOP AT my_punt_ofer ASSIGNING FIELD-SYMBOL(<fs_punt_offer>) WHERE z_codi_crit_punt = <fs_punts_pdm>-z_codi_crit_punt
                                                                     AND z_carrec_equip   = <fs_punts_pdm>-z_carrec_equip
                                                                     AND z_num_equip      = <fs_punts_pdm>-z_num_equip
                                                                     AND z_num_gen        = <fs_punts_pdm>-z_num_gen.
        <fs_punt_offer>-z_punts = <fs_punts_pdm>-z_punts.
      ENDLOOP.
    ENDLOOP.
  endmethod.


  METHOD set_punt_subapart.
    DATA: lv_punts     TYPE z_punts,
          lv_punt_t    TYPE z_punts,
          lv_pes       TYPE z_pes,
          ls_punt_ofer LIKE LINE OF my_punt_ofer.
***INI MOD ETJHG - SPEC-46407
    FIELD-SYMBOLS: <fs>           LIKE LINE OF it_dades_subapart,
                   <fs_tot>       LIKE LINE OF gt_dades_punt,
                   <fs_punt_ofer> LIKE LINE OF my_punt_ofer,
                   <fs_equi_sep>  TYPE zrm_dt_punt_equi.

    "En el caso que sea multi recurs agregamos el total de todos los subapartats con la variable de importing LV_PUNT
    "actualizando las tablas gt_dades_punt y my_punt_ofer encargada de la visualización de los datos que vemos en pantalla
    IF it_equip_sep IS NOT INITIAL.

      DATA(lt_equip_sep) = it_equip_sep.

      SORT lt_equip_sep.
      DELETE ADJACENT DUPLICATES FROM lt_equip_sep.
      DELETE lt_equip_sep WHERE z_num_ofer NE iv_num_oferta.

      "">> INI MODIF ETODR SPEC-61918 El pes sempre ha de ser el que toca pel càrrec...
*      IF lt_equip_sep IS NOT INITIAL.
*        lv_pes = 100 / lines( lt_equip_sep ).
*      ENDIF.
      ""<< FI MODIF ETODR SPEC-61918

      LOOP AT lt_equip_sep ASSIGNING <fs_equi_sep>.

*        <fs_equi_sep>-z_pes = lv_pes. "ETODR SPEC-61918

        READ TABLE gt_dades_punt ASSIGNING <fs_tot>
          WITH KEY z_codi_crit_punt = <fs_equi_sep>-z_codi_crit_punt
                   z_num_ofer       = <fs_equi_sep>-z_num_ofer
                   z_num_equip      = <fs_equi_sep>-z_comptador_equip.
        IF sy-subrc = 0.
          <fs_tot>-z_punts = <fs_equi_sep>-z_punts.
          "">> INI MODIF ETODR SPEC-61918
*          <fs_tot>-z_pes   = lv_pes.
          <fs_tot>-z_pes   = <fs_equi_sep>-z_pes.
          ""<< FI MODIF ETODR SPEC-61918
        ENDIF.

        READ TABLE  my_punt_ofer ASSIGNING <fs_punt_ofer>
          WITH KEY z_codi_crit_punt = <fs_equi_sep>-z_codi_crit_punt
                   z_num_gen        = <fs_equi_sep>-z_num_ofer
                   z_num_equip      = <fs_equi_sep>-z_comptador_equip
                   z_carrec_equip    = <fs_equi_sep>-z_carrec_equip.
        IF sy-subrc = 0.
          <fs_punt_ofer>-z_punts     = <fs_equi_sep>-z_punts.
          <fs_punt_ofer>-z_pes       = lv_pes.
        ELSE.
**          ">> SPEC-66771, Inici Modificació - ETODR
*          READ TABLE my_punt_ofer ASSIGNING <fs_punt_ofer> WITH KEY
*            z_codi_crit_punt = <fs_equi_sep>-z_codi_crit_punt
*            z_num_gen        = <fs_equi_sep>-z_num_ofer.
*          IF sy-subrc = 0.
*            <fs_punt_ofer>-z_punts        = <fs_equi_sep>-z_punts.
**            <fs_punt_ofer>-z_num_equip    = <fs_equi_sep>-z_comptador_equip.
**            <fs_punt_ofer>-z_carrec_equip = <fs_equi_sep>-z_carrec_equip.
**            <fs_punt_ofer>-z_pes          = lv_pes.
*          ELSE.
**            "<< SPEC-66771, Final Modificació - ETODR
            DATA(lv_comt) = <fs_equi_sep>-z_comptador_equip - 1.
            READ TABLE  my_punt_ofer
            INTO ls_punt_ofer
            WITH KEY z_codi_crit_punt = <fs_equi_sep>-z_codi_crit_punt
            z_num_gen        = <fs_equi_sep>-z_num_ofer
            z_num_equip = lv_comt.
            IF sy-subrc = 0.
              DATA(index) = sy-tabix + 1.
              ls_punt_ofer-z_num_equip   = <fs_equi_sep>-z_comptador_equip.
              ls_punt_ofer-z_punts     = <fs_equi_sep>-z_punts.
              ls_punt_ofer-z_pes       = lv_pes.
              INSERT ls_punt_ofer INTO my_punt_ofer INDEX index.
            ENDIF.
*          ENDIF.
        ENDIF.

        READ TABLE gt_equip ASSIGNING FIELD-SYMBOL(<fs_ofer_dyn_equi>)
          WITH KEY z_codi_crit_punt  = <fs_equi_sep>-z_codi_crit_punt
                   z_num_ofer        = <fs_equi_sep>-z_num_ofer
                   z_comptador_equip = <fs_equi_sep>-z_comptador_equip
                   z_carrec_equip    = <fs_equi_sep>-z_carrec_equip.
        IF sy-subrc = 0.
          <fs_ofer_dyn_equi>-z_punts           = <fs_equi_sep>-z_punts.
          <fs_ofer_dyn_equi>-z_sec             = <fs_equi_sep>-z_sec.
          ">> SPEC-66771, Inici Modificació - ETODR
*          <fs_ofer_dyn_equi>-z_pes             = lv_pes.
          "<< SPEC-66771, Final Modificació - ETODR
        ENDIF.


        lv_punts = lv_punts + <fs_equi_sep>-z_punts * <fs_equi_sep>-z_pes / 100.


        AT END OF z_codi_crit_punt.
          READ TABLE gt_punt_ofer_dyn ASSIGNING FIELD-SYMBOL(<fs_ofer_dyn>) WITH KEY z_codi_crit_punt = <fs_equi_sep>-z_codi_crit_punt
          z_num_ofer       = <fs_equi_sep>-z_num_ofer.
          IF sy-subrc = 0.
            <fs_ofer_dyn>-z_punts      = lv_punts.
            <fs_ofer_dyn>-z_punts_no_pond   = lv_punts.
          ENDIF.

          lv_punt_t = lv_punt_t + lv_punts.
          CLEAR lv_punts.

        ENDAT.
      ENDLOOP.

*      IF <fs_equi_sep> IS ASSIGNED.
*        READ TABLE gt_punt_ofer_dyn ASSIGNING <fs_ofer_dyn>
*          WITH KEY z_codi_crit_punt = <fs_equi_sep>-z_codi_crit_punt
*                   z_num_ofer       = <fs_equi_sep>-z_num_ofer.
*        IF sy-subrc = 0.
*          <fs_ofer_dyn>-z_punts      = lv_punts.
*          <fs_ofer_dyn>-z_punts_no_pond   = lv_punts.
*        ENDIF.
*      ENDIF.

    ELSEIF lv_mult_rec IS NOT INITIAL.
      LOOP AT it_dades_subapart ASSIGNING <fs>.

        IF <fs>-z_motivacio IS NOT INITIAL.
          <fs>-z_punts = lv_punt.
          READ TABLE gt_dades_punt ASSIGNING <fs_tot> WITH KEY z_codi_subapar_punt = <fs>-z_codi_subapar_punt
                                                               z_num_ofer          = <fs>-z_num_ofer
                                                               z_compta_rec        = <fs>-z_compta_rec.
          IF sy-subrc = 0.
            <fs_tot> = <fs>.
          ELSE.
            APPEND <fs> TO gt_dades_punt.
          ENDIF.
          READ TABLE  my_punt_ofer ASSIGNING <fs_punt_ofer> WITH KEY z_codi_crit_punt = <fs>-z_codi_crit_punt
                                                                     z_num_gen        = <fs>-z_num_ofer.
          IF sy-subrc = 0.
            <fs_punt_ofer>-z_punts     = <fs>-z_punts.
          ENDIF.


        ENDIF.
      ENDLOOP.

      READ TABLE it_dades_subapart ASSIGNING <fs> INDEX 1.

      IF sy-subrc EQ 0.
        READ TABLE gt_dades_punt ASSIGNING <fs_tot> WITH KEY z_codi_subapar_punt = <fs>-z_codi_subapar_punt
                                                             z_num_ofer          = <fs>-z_num_ofer.
        IF sy-subrc = 0.
          <fs_tot> = <fs>.
        ENDIF.
      ENDIF.
**  >> INI MODIF ETODR SPEC-49500
    ELSEIF is_mult_equip = abap_on.
      LOOP AT it_dades_subapart ASSIGNING <fs>.
        IF <fs>-z_motivacio IS NOT INITIAL.
          <fs>-z_punts = lv_punt.
          READ TABLE gt_dades_punt ASSIGNING <fs_tot> WITH KEY z_codi_subapar_punt = <fs>-z_codi_subapar_punt
                                                               z_num_ofer          = <fs>-z_num_ofer
                                                               z_num_equip         = <fs>-z_num_equip.
          IF sy-subrc = 0.
            <fs_tot> = <fs>.
          ELSE.
            APPEND <fs> TO gt_dades_punt.
          ENDIF.
          READ TABLE  my_punt_ofer ASSIGNING <fs_punt_ofer> WITH KEY z_codi_crit_punt = <fs>-z_codi_crit_punt
                                                                     z_num_gen        = <fs>-z_num_ofer
                                                                     z_num_equip      = <fs>-z_num_equip.
          IF sy-subrc = 0.
            <fs_punt_ofer>-z_punts     = <fs>-z_punts.

          ENDIF.
        ENDIF.
      ENDLOOP.

      READ TABLE it_dades_subapart ASSIGNING <fs> INDEX 1.

      IF sy-subrc EQ 0.
        READ TABLE gt_dades_punt ASSIGNING <fs_tot> WITH KEY z_codi_subapar_punt = <fs>-z_codi_subapar_punt
                                                             z_num_ofer          = <fs>-z_num_ofer
                                                             z_num_equip         = <fs>-z_num_equip.
        IF sy-subrc = 0.
          <fs_tot> = <fs>.
        ENDIF.

*        READ TABLE gt_punt_ofer_dyn_equi ASSIGNING FIELD-SYMBOL(<fs_ofer_dyn_equi>) WITH KEY z_codi_crit_punt  = <fs>-z_codi_crit_punt
*                                                                                             z_num_ofer        = <fs>-z_num_ofer
*                                                                                             z_comptador_equip = <fs>-z_num_equip.
        READ TABLE gt_equip ASSIGNING <fs_ofer_dyn_equi> WITH KEY z_codi_crit_punt  = <fs>-z_codi_crit_punt
                                                                                z_num_ofer        = <fs>-z_num_ofer
                                                                                z_comptador_equip = <fs>-z_num_equip.
        IF sy-subrc = 0.
          <fs_ofer_dyn_equi>-z_punts           = <fs>-z_punts.
          <fs_ofer_dyn_equi>-z_sec             = <fs>-z_sec.
        ENDIF.
      ENDIF.
**  << FI MODIF ETODR SPEC-49500
    ELSE.
***FIN MOD ETJHG - SPEC-46407
      READ TABLE it_dades_subapart ASSIGNING <fs> INDEX 1.
      IF sy-subrc EQ 0.
*        READ TABLE gt_dades_punt ASSIGNING <fs_tot> WITH KEY z_codi_subapar_punt = <fs>-z_codi_subapar_punt ETLJS SPEC-47727
        READ TABLE gt_dades_punt ASSIGNING <fs_tot> WITH KEY z_codi_crit_punt = <fs>-z_codi_crit_punt
                                                             z_num_ofer       = <fs>-z_num_ofer
                                                             z_num_equip      = <fs>-z_num_equip.
        IF sy-subrc = 0.
          <fs_tot> = <fs>.
        ELSE.
          APPEND <fs> TO gt_dades_punt.
        ENDIF.

        READ TABLE  my_punt_ofer ASSIGNING <fs_punt_ofer> WITH KEY z_codi_crit_punt = <fs>-z_codi_crit_punt
                                                                   z_num_gen        = <fs>-z_num_ofer
                                                                   z_num_equip      = <fs>-z_num_equip.
        IF sy-subrc = 0.
          <fs_punt_ofer>-z_punts           = <fs>-z_punts.
          <fs_punt_ofer>-z_punts_no_pond   = <fs>-z_punts. "MODIF ETODR SPEC-49075
        ENDIF.
      ENDIF.

      READ TABLE gt_punt_ofer_dyn ASSIGNING <fs_ofer_dyn> WITH KEY z_codi_crit_punt = <fs>-z_codi_crit_punt
                                                                                 z_num_ofer       = <fs>-z_num_ofer.
      IF sy-subrc = 0.
        <fs_ofer_dyn>-z_punts      = <fs>-z_punts.
        <fs_ofer_dyn>-z_sec        = <fs>-z_sec.
        <fs_ofer_dyn>-z_sec_resta  = <fs>-z_sec_resta.
**      >> INI MODIF ETODR SPEC-49075
        <fs_ofer_dyn>-z_punts_no_pond   = <fs>-z_punts.
**      << FI MODIF ETODR SPEC-49075
      ENDIF.
    ENDIF.
    my_changed      = abap_on.
  ENDMETHOD.


  METHOD set_save_log_pt.
    CHECK i_set_save_to_log EQ abap_true.
    CLEAR my_save_to_log_pt.
    LOOP AT me->my_log_pt TRANSPORTING NO FIELDS WHERE z_motiu IS NOT INITIAL.
      my_save_to_log_pt = abap_true.
      EXIT.
    ENDLOOP.
  ENDMETHOD.


  METHOD set_taules_rel_ofer.
    my_punt_rec  = it_punt_rec.
    my_punt_equi = it_punt_equi.
    my_punt_sel  = it_punt_sel.
  ENDMETHOD.


  METHOD set_temporal_log_pt.
    IF gt_temporal_canvis_punt[] IS NOT INITIAL.
      set_log_pt( i_first_time   = abap_off
                  it_canvis_punt = gt_temporal_canvis_punt ).
    ENDIF.
    CLEAR: gt_temporal_canvis_punt[].
  ENDMETHOD.


  METHOD set_te_exclusio_clausula_plec.
    LOOP AT my_ofertesx ASSIGNING FIELD-SYMBOL(<fs_oferta>) WHERE z_num_ofer = i_num_ofer.
      IF <fs_oferta>-z_exclos_plec = abap_on.
        <fs_oferta>-z_exclos_plec = abap_off.
      ELSE.
        <fs_oferta>-z_exclos_plec = abap_on.
      ENDIF.
      my_ob_ofertes->modificar_oferta( <fs_oferta>-offer_data ).
    ENDLOOP.
    IF sy-subrc = 0.
      my_changed = abap_on.
    ENDIF.
  ENDMETHOD.


  METHOD set_te_exclusio_plec_equip.
    LOOP AT my_ofertesx ASSIGNING FIELD-SYMBOL(<fs_oferta>) WHERE z_num_ofer = i_num_ofer.

      IF i_modif_equip IS NOT INITIAL.
        <fs_oferta>-z_exclos_plec = abap_on.
      ELSE.
        <fs_oferta>-z_exclos_plec = abap_off.
      ENDIF.
      my_ob_ofertes->modificar_oferta( <fs_oferta>-offer_data ).
    ENDLOOP.
    IF sy-subrc = 0.
      my_changed = abap_on.
    ENDIF.

    IF it_equip IS SUPPLIED.
      LOOP AT it_equip ASSIGNING FIELD-SYMBOL(<fs_equip>).

        LOOP AT gt_equip ASSIGNING FIELD-SYMBOL(<fs_mod_equip>)
         WHERE z_num_ofer        EQ i_num_ofer AND
               z_comptador_equip EQ <fs_equip>-z_comptador_equip.
          <fs_mod_equip>-z_exclos = <fs_equip>-z_exclos.
        ENDLOOP.
      ENDLOOP.
    ENDIF.
  ENDMETHOD.


  METHOD sim_recalc_punt.
    FIELD-SYMBOLS: <lt_punt_ofer> TYPE ty_t_punt_gen.

    DATA: lt_punt_ofer TYPE ty_t_punt_gen.
    lt_punt_ofer = my_punt_ofer .

    ASSIGN: lt_punt_ofer TO <lt_punt_ofer>.

    me->recalculate_val_tecnic( EXPORTING im_crit_punt = my_crit_punt
                                CHANGING  ch_punt_gen  = <lt_punt_ofer> ).
    me->recalculate_val_econ_n( EXPORTING im_crit_punt = my_crit_punt
                                CHANGING  ch_punt_gen  = <lt_punt_ofer> ).
    me->recalculate_val_tecnic( EXPORTING im_crit_punt = my_crit_punt
                                CHANGING  ch_punt_gen  = <lt_punt_ofer> ).
    et_punt_offer_nopond = <lt_punt_ofer>.

    recalculate_crit_dyn( EXPORTING im_crit_punt      = my_crit_punt
                          CHANGING  ch_punt_gen       = <lt_punt_ofer> ).
    et_punt_offer_pond = <lt_punt_ofer>.

  ENDMETHOD.


  METHOD sim_recalc_val_econ.
    DATA: lt_ofertesx TYPE  ty_t_ofertax.
    FIELD-SYMBOLS: <lt_ofertesx>  TYPE ty_t_ofertax,
                   <lt_punt_ofer> TYPE ty_t_punt_gen,
                   <ls_ofertax>   TYPE ty_s_ofertax.


    IF my_opened IS INITIAL .
      RAISE EXCEPTION TYPE zcx_rm_valoracio .
    ENDIF .

    ex_punt_ofer = my_punt_ofer .
    lt_ofertesx  = my_ofertesx .

    ASSIGN: ex_punt_ofer TO <lt_punt_ofer>,
            lt_ofertesx  TO <lt_ofertesx> .


    recalculate_val_econ_n( EXPORTING im_crit_punt = my_crit_punt
                            CHANGING  ch_punt_gen  = <lt_punt_ofer> ).

    me->recalculate_val_tecnic( EXPORTING im_crit_punt = my_crit_punt
                                CHANGING  ch_punt_gen  = <lt_punt_ofer> ).

    IF get_my_crit_dyn( ) = abap_on.
      recalculate_crit_dyn( EXPORTING im_crit_punt      = my_crit_punt
                            CHANGING  ch_punt_gen       = <lt_punt_ofer> ).

      confirm_punt_offers_int_tec( EXPORTING  im_crit_punt           = my_crit_punt
                                              im_plec                = my_plec
                                              im_2_round             = is_2_round( )
                                   CHANGING   ch_punt_ofer           = <lt_punt_ofer>
                                              ch_ofertesx            = <lt_ofertesx> ).
    ENDIF.

  ENDMETHOD.


METHOD start.
  read_data(  ) .
* EDCPC 25-09-2009  En el cas que sigui un expedient de reial decret el marquem també per a que
* no surti el missatge i054(zrm_valoracio) " Les puntuacions han canviat
  IF my_punt_ofer_db IS INITIAL OR my_exp_cont-z_rd817_2009 = 'X'
    OR my_exp_cont-z_obres_2m5m = 'X'. "SPEC-27608 Canvis Consell(Regulació 2M5M)
    ex_first_time = 'X' .
  ENDIF.
ENDMETHOD.


METHOD summatory.
  FIELD-SYMBOLS: <ls_sum_info>   LIKE LINE OF im_sum_info,
                 <ls_crit_ahead> LIKE LINE OF im_crit_punt,
                 <ls_punt_ahead> LIKE LINE OF im_punt_gen.
  DATA: l_punts       TYPE z_punts,
        l_sum_prec(9) TYPE p DECIMALS 4,
        lv_cont       TYPE i.

  CLEAR: ch_sum,
         l_sum_prec .

  LOOP AT im_sum_info ASSIGNING <ls_sum_info> .
    READ TABLE im_crit_punt ASSIGNING <ls_crit_ahead>
       WITH TABLE KEY z_mod_crit_punt  = <ls_sum_info>-z_mod_crit_punt
                      z_codi_crit_punt = <ls_sum_info>-z_codi_crit_punt.
    CHECK sy-subrc EQ 0.
    IF <ls_crit_ahead>-z_num_equip IS INITIAL.
      READ TABLE im_punt_gen ASSIGNING <ls_punt_ahead>
         WITH TABLE KEY z_codi_crit_punt = <ls_crit_ahead>-z_codi_crit_punt
                        z_mod_crit_punt  = <ls_crit_ahead>-z_mod_crit_punt
                        z_num_gen        = im_num_gen .

      CHECK <ls_punt_ahead> IS ASSIGNED.  " SPEC-88482 DUMP per FS not assigned

      l_punts = <ls_punt_ahead>-z_punts .
      l_sum_prec = l_sum_prec + ( <ls_sum_info>-z_ponderacio * l_punts ) / 100 .

    ELSE. " ETLJS SPEC-47173 Son equipo
      LOOP AT im_crit_punt ASSIGNING <ls_crit_ahead>
        WHERE z_mod_crit_punt  = <ls_sum_info>-z_mod_crit_punt AND
              z_codi_crit_punt = <ls_sum_info>-z_codi_crit_punt.

        READ TABLE im_punt_gen ASSIGNING <ls_punt_ahead>
           WITH KEY z_codi_crit_punt = <ls_crit_ahead>-z_codi_crit_punt
                    z_mod_crit_punt  = <ls_crit_ahead>-z_mod_crit_punt
                    z_num_equip      = <ls_crit_ahead>-z_num_equip
                    z_num_gen        = im_num_gen .

        CHECK <ls_punt_ahead> IS ASSIGNED.

        l_punts = <ls_punt_ahead>-z_punts .
        l_sum_prec = l_sum_prec + ( <ls_crit_ahead>-z_ponderacio * l_punts ) / 100 .

      ENDLOOP.
    ENDIF.
  ENDLOOP .

*>> SPEC-53130, Inici modificació - ETLJS
  IF <ls_sum_info> IS ASSIGNED AND im_sum_info IS NOT INITIAL.
    SELECT z_codi_crit_punt, Z_PONDERACIO
      INTO TABLE @DATA(lt_equip_sep)
      FROM zrm_dm_crit_punt
       FOR ALL ENTRIES IN @im_sum_info
     WHERE z_mod_crit_punt = @<ls_sum_info>-z_mod_crit_punt
       AND z_codi_crit_punt = @im_sum_info-z_codi_crit_punt
      AND z_equip_sep = @abap_true.
    IF sy-subrc EQ 0.
      LOOP AT lt_equip_sep ASSIGNING FIELD-SYMBOL(<fs_equip_sep>).
        CLEAR lv_cont.
        CLEAR l_punts.
        LOOP AT IM_PUNT_GEN
          ASSIGNING FIELD-SYMBOL(<fs_crit>)
          WHERE z_codi_crit_punt = <fs_equip_sep>-z_codi_crit_punt
            AND z_num_gen = im_num_gen.

          l_punts = l_punts + <fs_crit>-z_punts * <fs_crit>-z_pes / 100.
*          lv_cont = lv_cont + 1.

        ENDLOOP.
*          if lv_cont IS NOT INITIAL.
*          l_punts = l_punts / lv_cont.
*          endif.
          if <fs_equip_sep>-z_ponderacio IS NOT INITIAL.
             l_sum_prec = l_sum_prec + l_punts * <fs_equip_sep>-z_ponderacio  / 100.
             data(lv_pond) = abap_true.
          else.
             l_sum_prec = l_sum_prec + l_punts.
             lv_pond = abap_false.
          ENDIF.
      ENDLOOP.
    ENDIF.
*    IF lv_pond = abap_false.
*      l_sum_prec = l_sum_prec / LINES( im_sum_info ).
*    ENDIF.
  ENDIF.
*<< SPEC-53130, Final modificació - ETLJS
  ch_sum = l_sum_prec .
ENDMETHOD.


  METHOD summatory_curr_dyn.
    FIELD-SYMBOLS: <ls_sum_info>   LIKE LINE OF im_sum_info,
                   <ls_crit_ahead> LIKE LINE OF im_crit_punt,
                   <ls_punt_ahead> LIKE LINE OF im_punt_gen.
    DATA: l_punts       TYPE z_punt_max,
          l_sum_prec(9) TYPE p DECIMALS 4.

    CLEAR: ch_sum,
           l_sum_prec .

    DATA(lt_punt_gent) = im_punt_gen[].
    recalculate_si_resta( EXPORTING im_crit_punt    = im_crit_punt
*                                    i_recalculated  = abap_on
                          CHANGING  ch_punt_gen     = lt_punt_gent ).

    LOOP AT im_sum_info ASSIGNING <ls_sum_info> .
      READ TABLE im_crit_punt ASSIGNING <ls_crit_ahead>
         WITH TABLE KEY z_mod_crit_punt  = <ls_sum_info>-z_mod_crit_punt
                        z_codi_crit_punt = <ls_sum_info>-z_codi_crit_punt.
      CHECK sy-subrc EQ 0.
      CHECK <ls_crit_ahead>-z_no_aplica IS INITIAL.

      READ TABLE lt_punt_gent ASSIGNING <ls_punt_ahead>
         WITH TABLE KEY z_codi_crit_punt = <ls_crit_ahead>-z_codi_crit_punt
                        z_mod_crit_punt  = <ls_crit_ahead>-z_mod_crit_punt
                        z_num_gen        = im_num_gen .
      l_punts = <ls_punt_ahead>-z_punts + l_punts.
*      l_sum_prec = l_sum_prec + ( <ls_sum_info>-z_ponderacio * l_punts ) / 100 .
    ENDLOOP .
    ch_sum = l_punts .
  ENDMETHOD.


  METHOD summatory_equip_max.
    FIELD-SYMBOLS: <ls_sum_info>   LIKE LINE OF im_sum_info,
                   <ls_crit_ahead> LIKE LINE OF im_crit_punt,
                   <ls_punt_ahead> LIKE LINE OF im_punt_gen.
    DATA: l_punts       TYPE z_punt_max,
          l_sum_prec(9) TYPE p DECIMALS 4.

    CLEAR: ch_sum,
           l_sum_prec .

    DATA(lt_punt_gent) = im_punt_gen[].

    LOOP AT im_sum_info ASSIGNING <ls_sum_info> .
      READ TABLE im_crit_punt ASSIGNING <ls_crit_ahead>
         WITH TABLE KEY z_mod_crit_punt  = <ls_sum_info>-z_mod_crit_punt
                        z_codi_crit_punt = <ls_sum_info>-z_codi_crit_punt.
      CHECK sy-subrc EQ 0.
      CHECK <ls_crit_ahead>-z_no_aplica IS INITIAL.

      READ TABLE lt_punt_gent ASSIGNING <ls_punt_ahead>
         WITH KEY z_codi_crit_punt = <ls_crit_ahead>-z_codi_crit_punt
                  z_mod_crit_punt  = <ls_crit_ahead>-z_mod_crit_punt
                  z_num_gen        = im_num_gen
                  z_equip_max      = abap_on.
      l_punts = <ls_punt_ahead>-z_punts .
      l_sum_prec = l_sum_prec + ( <ls_crit_ahead>-z_ponderacio * l_punts ) / 100 .
    ENDLOOP .
    ch_sum = l_sum_prec .
  ENDMETHOD.


  METHOD summatory_max_dyn.
    FIELD-SYMBOLS: <ls_sum_info>   LIKE LINE OF im_sum_info,
                   <ls_crit_ahead> LIKE LINE OF im_crit_punt,
                   <ls_punt_ahead> LIKE LINE OF im_punt_gen.
    DATA: l_punts       TYPE z_punt_max,
          l_sum_prec(9) TYPE p DECIMALS 4.
    ">> SPEC-85003, Inici Modificació - EVODR
    DATA: lv_codi_equip       TYPE z_codi_crit_punt,
          lv_punts_subcriteri TYPE zrm_dm_crit_punt-z_punt_max.
    "<< SPEC-85003, Final Modificació - EVODR

    CLEAR: ch_sum,
           l_sum_prec .

    LOOP AT im_sum_info ASSIGNING <ls_sum_info> .
      READ TABLE im_crit_punt ASSIGNING <ls_crit_ahead>
         WITH TABLE KEY z_mod_crit_punt  = <ls_sum_info>-z_mod_crit_punt
                        z_codi_crit_punt = <ls_sum_info>-z_codi_crit_punt.
*                        z_no_aplica      = abap_off.
*                        z_resta          = abap_off.
      CHECK sy-subrc EQ 0.
      CHECK <ls_crit_ahead>-z_no_aplica IS INITIAL.
      ">> SPEC-83700, Inici Modificació - EVODR

      DESCRIBE TABLE <ls_crit_ahead>-sum_info LINES DATA(lv_lines_sumatori).
      IF lv_lines_sumatori > 0.
        CLEAR: lv_punts_subcriteri. "SPEC-85003
        LOOP AT <ls_crit_ahead>-sum_info ASSIGNING FIELD-SYMBOL(<fs_criteris_sum>).
          READ TABLE im_crit_punt ASSIGNING FIELD-SYMBOL(<fs_check_subcriteri>) WITH KEY z_codi_crit_punt = <fs_criteris_sum>-z_codi_crit_punt.
          ">> SPEC-84920, Inici Modificació - EVODR
          IF sy-subrc = 0.
            IF <fs_check_subcriteri>-z_no_factor_mult = abap_true.
              "Si té aquest flag marcat vol dir que si algun dels seus subcriteris no aplica
              "el total seu no es veu ponderat, per tant passa a ser menys
              LOOP AT im_crit_punt ASSIGNING FIELD-SYMBOL(<fs_subcriteri>) WHERE z_codi_crit_punt = <fs_criteris_sum>-z_codi_crit_punt
                                                                             AND z_no_aplica      = abap_off
                                                                             AND z_no_factor_mult = abap_true.
*                l_punts = <fs_subcriteri>-z_punt_max + l_punts."SPEC-85003
                lv_punts_subcriteri = <fs_subcriteri>-z_punt_max + lv_punts_subcriteri. "SPEC-85003
              ENDLOOP.
            ELSE.
*              l_punts = <fs_check_subcriteri>-z_punt_max + l_punts. "SPEC-85003
              lv_punts_subcriteri = <fs_check_subcriteri>-z_punt_max + lv_punts_subcriteri. "SPEC-85003
            ENDIF.
          ELSE.
            "Si no trobem registre del z_codi_crit_punt, pot ser que sigui perquè es tracta d'un criteri d'equip o d'un criteri que no es mostra directament
            "a la graella sinó que es calcula des d'una altra banda
            "Llavors el que fem es buscar a la MY_CRIT_PUNT_ALL
            READ TABLE my_crit_punt_all ASSIGNING FIELD-SYMBOL(<fs_check2_subcriteri>) WITH KEY z_codi_crit_punt = <fs_criteris_sum>-z_codi_crit_punt.
            IF sy-subrc = 0.
              ">> SPEC-85003, Inici Modificació - EVODR
              IF <ls_crit_ahead>-z_mult_equip = abap_on.
                IF lv_codi_equip IS INITIAL OR lv_codi_equip <> <ls_crit_ahead>-z_codi_crit_punt.
                  lv_codi_equip = <ls_crit_ahead>-z_codi_crit_punt.
                  "Si es l'equip, agafem la puntuació total de l'equip, però només el comptem 1 vegada, no per cada subcriteri
*                  l_punts = <ls_crit_ahead>-z_punt_max + l_punts.
                  lv_punts_subcriteri = <ls_crit_ahead>-z_punt_max.
                ELSE.
                  CONTINUE.
                ENDIF.
              ELSE.
                "<< SPEC-85003, Final Modificació - EVODR
                IF <fs_check2_subcriteri>-z_no_factor_mult = abap_true.
                  "Si té aquest flag marcat vol dir que si algun dels seus subcriteris no aplica
                  "el total seu no es veu ponderat, per tant passa a ser menys
                  LOOP AT im_crit_punt ASSIGNING <fs_subcriteri> WHERE z_codi_crit_punt = <fs_criteris_sum>-z_codi_crit_punt
                                                                   AND z_no_aplica      = abap_off
                                                                   AND z_no_factor_mult = abap_true.
*                    l_punts = <fs_subcriteri>-z_punt_max + l_punts."SPEC-85003
                    lv_punts_subcriteri = <fs_subcriteri>-z_punt_max + lv_punts_subcriteri. "SPEC-85003
                  ENDLOOP.
                ELSE.
*                  l_punts = <fs_check2_subcriteri>-z_punt_max + l_punts."SPEC-85003
                  lv_punts_subcriteri = <fs_check2_subcriteri>-z_punt_max + lv_punts_subcriteri. "SPEC-85003
                ENDIF.
              ENDIF.
            ENDIF.
          ENDIF.
*          IF sy-subrc = 0 AND <fs_check_subcriteri>-z_no_factor_mult = abap_true.
*            "Si té aquest flag marcat vol dir que si algun dels seus subcriteris no aplica
*            "el total seu no es veu ponderat, per tant passa a ser menys
*            LOOP AT im_crit_punt ASSIGNING FIELD-SYMBOL(<fs_subcriteri>) WHERE z_codi_crit_punt = <fs_criteris_sum>-z_codi_crit_punt
*                                                                           AND z_no_aplica      = abap_off
*                                                                           AND z_no_factor_mult = abap_true.
*              l_punts = <fs_subcriteri>-z_punt_max + l_punts.
*            ENDLOOP.
*          ELSEIF sy-subrc = 0 AND <fs_check_subcriteri>-z_no_factor_mult = abap_false. " EVAGM SPEC-84594 dump
*            ">> SPEC-84485, Inici Modificació - EVODR
**              l_punts = <ls_crit_ahead>-z_punt_max + l_punts.
*            l_punts = <fs_check_subcriteri>-z_punt_max + l_punts.
*            "<< SPEC-84485, Final Modificació - EVODR
*          ENDIF.
          "<< SPEC-84920, Final Modificació - EVODR
        ENDLOOP.
        ">> SPEC-85003, Inici Modificació - EVODR
        IF lv_punts_subcriteri <= <ls_crit_ahead>-z_punt_max.
          l_punts = lv_punts_subcriteri + l_punts.
        ELSE.
          l_punts = <ls_crit_ahead>-z_punt_max + l_punts.
        ENDIF.
        "<< SPEC-85003, Final Modificació - EVODR
      ELSE.
        l_punts = <ls_crit_ahead>-z_punt_max + l_punts.
      ENDIF.
      "<< SPEC-83700, Final Modificació - EVODR
*
*      READ TABLE im_punt_gen ASSIGNING <ls_punt_ahead>
*         WITH TABLE KEY z_codi_crit_punt = <ls_crit_ahead>-z_codi_crit_punt
*                        z_mod_crit_punt  = <ls_crit_ahead>-z_mod_crit_punt
*                        z_num_gen        = im_num_gen .
      ">> SPEC-83700, Inici Modificació - EVODR
*      l_punts = <ls_crit_ahead>-z_punt_max + l_punts.
      "<< SPEC-83700, Final Modificació - EVODR
*      l_sum_prec = l_sum_prec + ( <ls_sum_info>-z_ponderacio * l_punts ) / 100 .
    ENDLOOP .
    ch_sum = l_punts .
  ENDMETHOD.


  METHOD te_equip_add.
    r_has_equip_add = abap_off.
**  >> INI MODIF ETODR SPEC-61754
    "A part de verificar les dades temporals, també verifiquem les dades de la bbdd
    SELECT COUNT(*)
      FROM zrm_dt_punt_equi
      WHERE objectid      = my_objectid
        AND z_is_header   = abap_on
        AND z_equip_basic = abap_off.
    IF sy-subrc = 0.
      r_has_equip_add = abap_on.
    ENDIF.
**  << INI MODIF ETODR SPEC-61754
    LOOP AT gt_equip TRANSPORTING NO FIELDS WHERE z_equip_basic IS INITIAL.
      r_has_equip_add = abap_on.
      EXIT.
    ENDLOOP.
  ENDMETHOD.


  METHOD te_valor_incr.
    r_has_incr_done = abap_off.
    LOOP AT my_incr ASSIGNING FIELD-SYMBOL(<fs_incr>).
      IF <fs_incr>-z_punts IS NOT INITIAL.
        r_has_incr_done = abap_on.
        EXIT.
      ENDIF.
    ENDLOOP.
  ENDMETHOD.


  METHOD te_valor_iref.
    r_has_incr_done = abap_off.
    IF my_exp_cont_db-z_iref IS NOT INITIAL.
      LOOP AT gt_equip ASSIGNING FIELD-SYMBOL(<fs_iref>) WHERE z_codi_formula_incr_punts IS NOT INITIAL
                                                           AND z_codi_subapar_punt_equip IS NOT INITIAL.
        IF <fs_iref>-z_punts IS NOT INITIAL.
          r_has_incr_done = abap_on.
          EXIT.
        ENDIF.
      ENDLOOP.
    ENDIF.
  ENDMETHOD.


METHOD unconfirm_awardee.
  DATA: l_dummy  TYPE c .                                   "#EC NEEDED
  FIELD-SYMBOLS: <ls_ofertax>   TYPE ty_s_ofertax.

  IF my_locked IS INITIAL .
    RAISE EXCEPTION TYPE zcx_rm_valoracio
      EXPORTING textid = zcx_rm_valoracio=>not_opened_for_update .
  ENDIF .

  IF my_exp_cont-z_adjudicatari IS INITIAL .
    RAISE EXCEPTION TYPE zcx_rm_valoracio
      EXPORTING textid = zcx_rm_valoracio=>no_awardee .
  ENDIF .

  IF  check_activity( co_act_unconfirm_adj ) IS INITIAL .
    RAISE EXCEPTION TYPE zcx_rm_valoracio.
  ENDIF .

  IF is_2_round( ) IS INITIAL .
    IF my_quadres-quadre4 IS NOT INITIAL .
      RAISE EXCEPTION TYPE zcx_rm_valoracio
        EXPORTING textid = zcx_rm_valoracio=>q4_already_exists .
    ENDIF .
  ELSE .
    IF my_quadres-quadre4b IS NOT INITIAL .
      RAISE EXCEPTION TYPE zcx_rm_valoracio
        EXPORTING textid = zcx_rm_valoracio=>q4b_already_exists .
    ENDIF .
  ENDIF .

* Pas A: Inicialitzar valors de capçalera de licitació -------------------------------
  CLEAR: ex_punctuation_changed,
         my_exp_cont-z_adjudicatari,
         my_exp_cont-z_import_adj,
         my_exp_cont-z_import_adj_b.

* Pas B: Inicialitzar adjudicació provisional ----------------------------------------
  LOOP AT my_ofertesx ASSIGNING <ls_ofertax> .
    CLEAR: <ls_ofertax>-offer_data-z_adj_prov .
    my_ob_ofertes->modificar_oferta( <ls_ofertax>-offer_data ).
  ENDLOOP .

  build_activity_list( ) .
  my_changed = 'X' .

ENDMETHOD.


METHOD unconfirm_lemes.
  DATA: l_dummy TYPE c .                                    "#EC NEEDED
  FIELD-SYMBOLS: <ls_lema> LIKE LINE OF my_lemes .

*
  IF my_locked IS INITIAL .
    RAISE EXCEPTION TYPE zcx_rm_valoracio
      EXPORTING textid = zcx_rm_valoracio=>not_opened_for_update .
  ENDIF .

  IF my_exp_cont-z_v2_conf_dades IS INITIAL .
    RAISE EXCEPTION TYPE zcx_rm_valoracio
      EXPORTING textid = zcx_rm_valoracio=>not_confirmed_yet .
  ENDIF .

  IF check_activity( co_act_unconfirm_2nd ) IS INITIAL .
    RAISE EXCEPTION TYPE zcx_rm_valoracio.
  ENDIF .

  IF my_quadres-quadre4_lemes IS NOT INITIAL .
    RAISE EXCEPTION TYPE zcx_rm_valoracio
      EXPORTING textid = zcx_rm_valoracio=>q4_lemes_already_exists .
  ENDIF .

* Pas A: Inicialitzar valors de capçalera de licitació -------------------------------
  CLEAR: my_exp_cont-z_adjudicatari,
         my_exp_cont-z_import_adj,
         my_exp_cont-z_import_adj_b,
         my_exp_cont-z_v2_conf_dades,
         my_exp_cont-z_v2_conf_user,
         my_exp_cont-z_v2_conf_data .

* Pas B: Inicialitzar adjudicació provisional, puntuacions i exclusions tècniques  ----
  LOOP AT my_lemes ASSIGNING <ls_lema> .
    CLEAR: <ls_lema>-z_punts_lema.
  ENDLOOP .

  build_activity_list( ) .
  my_changed = 'X' .

ENDMETHOD.


METHOD unconfirm_offers.
  DATA: l_dummy TYPE c .                                    "#EC NEEDED
  FIELD-SYMBOLS: <ls_ofertax>   TYPE ty_s_ofertax.


  IF my_locked IS INITIAL .
    RAISE EXCEPTION TYPE zcx_rm_valoracio
      EXPORTING
        textid = zcx_rm_valoracio=>not_opened_for_update.
  ENDIF .

  IF my_exp_cont-z_vo_conf_dades IS INITIAL .
    RAISE EXCEPTION TYPE zcx_rm_valoracio
      EXPORTING
        textid = zcx_rm_valoracio=>not_confirmed_yet.
  ENDIF .

  IF      check_activity( co_act_unconfirm_1st ) IS INITIAL .
    RAISE EXCEPTION TYPE zcx_rm_valoracio.
  ENDIF .

  IF    is_2_round( ) IS INITIAL .
    IF     my_quadres-quadre4 IS NOT INITIAL
       AND my_exp_cont-z_adjudicatari IS NOT INITIAL .
      RAISE EXCEPTION TYPE zcx_rm_valoracio
        EXPORTING
          textid = zcx_rm_valoracio=>q4_already_exists.
    ENDIF .
  ELSE .
    IF     my_quadres-quadre4a IS NOT INITIAL .
      RAISE EXCEPTION TYPE zcx_rm_valoracio
        EXPORTING
          textid = zcx_rm_valoracio=>q4a_already_exists.
    ENDIF .
  ENDIF .

* Pas A: Inicialitzar valors de capçalera de licitació -------------------------------
  CLEAR: ex_punctuation_changed,
         my_exp_cont-z_adjudicatari,
         my_exp_cont-z_import_adj,
         my_exp_cont-z_import_adj_b,
         my_exp_cont-z_vo_conf_dades,
         my_exp_cont-z_vo_conf_user,
         my_exp_cont-z_vo_conf_data,
         my_exp_cont-z_v2_conf_dades,
         my_exp_cont-z_v2_conf_user,
         my_exp_cont-z_v2_conf_data.

* Pas B: Inicialitzar adjudicació provisional, puntuacions i exclusions tècniques  ----
  LOOP AT my_ofertesx ASSIGNING <ls_ofertax> .
    CLEAR: <ls_ofertax>-offer_data-z_punts_ofert,
           <ls_ofertax>-offer_data-z_punt_econ,
           <ls_ofertax>-offer_data-z_punt_total,
           <ls_ofertax>-offer_data-z_adj_prov .
*    CLEAR <ls_ofertax>-exclos.    "SPEC-37724 "ETOVB

* Per RD817/2009 la punt. tèc. es reseteja a la tasca de Puntuació tècnica!
    IF my_exp_cont-z_rd817_2009 IS INITIAL.
      CLEAR: <ls_ofertax>-offer_data-z_punt_tec,
             <ls_ofertax>-offer_data-z_excl_punt_tec.
    ENDIF.

    my_ob_ofertes->modificar_oferta( <ls_ofertax>-offer_data ).
  ENDLOOP .

  build_activity_list( ) .
  my_changed = 'X' .

ENDMETHOD.


METHOD unconfirm_offers_best_classif.
*>> Ini  SPEC-54695  - ETMAE

  DATA: l_dummy   TYPE c ,              "#ec needed
        lv_d      TYPE d,
        lv_found  TYPE flag,
        ls_column TYPE ty_s_column,
        ls_oferta TYPE ty_s_ofertax.
  FIELD-SYMBOLS: <fs_ofertax>   TYPE ty_s_ofertax .

* Con el mismo botón 'Desbloquejar' (UNL) se hace:
* 1) Resetear Puntuaciones
* 2) Resetear la oferta millor clasificada.

* 1)
* Resetear puntuaciones igual que co_mode_punt_quadre4b

******  unconfirm_offers( IMPORTING ex_punctuation_changed = ex_punctuation_changed ) .
******  recalculate( ).


* 2)
* Pas A: Inicialitzar valors de capçalera de licitació -------------------------------
  CLEAR: my_exp_cont-z_data_sel_m_clas ,
         my_exp_cont-z_user_sel_m_clas,
         my_exp_cont-z_conf_mill_class .

* Pas B: Inicialitzar adjudicació provisional
  LOOP AT my_ofertesx ASSIGNING <fs_ofertax> .
    CLEAR: <fs_ofertax>-z_mill_class .
    my_ob_ofertes->modificar_oferta( <fs_ofertax>-offer_data ).
  ENDLOOP .


  CLEAR lv_d  .

* Actualizar en el expediente Usuario y Fecha. Millor Classificat.
  UPDATE zrm_dt_exp_cont
     SET z_data_sel_m_clas  = lv_d
         z_user_sel_m_clas  = space
         z_conf_mill_class  = abap_off
   WHERE docclass  =  my_exp_cont-docclass
     AND objectid  =  my_exp_cont-objectid .


* Actualizar en las ofertas con flag de millor classificat.
  UPDATE zrm_dt_ofertes
     SET z_mill_class = abap_false
   WHERE docclass     = my_exp_cont-docclass
     AND objectid     = my_exp_cont-objectid
*    and z_num_ofer   = ls_ofertax-z_num_ofer
     AND z_mill_class = abap_true .


  build_activity_list( ) .
*  my_changed = 'X' .

*<< Fi  SPEC-54695  - ETMAE
ENDMETHOD.


  METHOD unconfirm_q3_offers.
    DATA: l_dummy TYPE c .                                  "#EC NEEDED
    FIELD-SYMBOLS: <ls_ofertax>   TYPE ty_s_ofertax.


    IF my_locked IS INITIAL .
      RAISE EXCEPTION TYPE zcx_rm_valoracio
        EXPORTING
          textid = zcx_rm_valoracio=>not_opened_for_update.
    ENDIF .

    IF my_exp_cont-z_q3_conf_dades IS INITIAL .
      RAISE EXCEPTION TYPE zcx_rm_valoracio
        EXPORTING
          textid = zcx_rm_valoracio=>not_confirmed_yet.
    ENDIF .

    IF      check_activity( co_act_unconfirm_q3b ) IS INITIAL .
      RAISE EXCEPTION TYPE zcx_rm_valoracio.
    ENDIF .

*    IF my_quadres-quadre3b IS NOT INITIAL .
*      RAISE EXCEPTION TYPE zcx_rm_valoracio
*        EXPORTING
*          textid = zcx_rm_valoracio=>q4a_already_exists.
*    ENDIF .

* Pas A: Inicialitzar valors de capçalera de licitació -------------------------------
    CLEAR: ex_punctuation_changed,
           my_exp_cont-z_q3_conf_dades,
           my_exp_cont-z_q3_conf_user,
           my_exp_cont-z_q3_conf_data.

** Pas B: Inicialitzar adjudicació provisional, puntuacions i exclusions tècniques  ----
*    LOOP AT my_ofertesx ASSIGNING <ls_ofertax> .
*      CLEAR: <ls_ofertax>-offer_data-z_punts_ofert,
*             <ls_ofertax>-offer_data-z_punt_econ,
*             <ls_ofertax>-offer_data-z_punt_total,
*             <ls_ofertax>-offer_data-z_adj_prov .
**    CLEAR <ls_ofertax>-exclos.    "SPEC-37724 "ETOVB
*
** Per RD817/2009 la punt. tèc. es reseteja a la tasca de Puntuació tècnica!
*      IF my_exp_cont-z_rd817_2009 IS INITIAL.
*        CLEAR: <ls_ofertax>-offer_data-z_punt_tec,
*               <ls_ofertax>-offer_data-z_excl_punt_tec.
*      ENDIF.
*
*      my_ob_ofertes->modificar_oferta( <ls_ofertax>-offer_data ).
*    ENDLOOP .

    build_activity_list( ) .
    my_changed = 'X' .
  ENDMETHOD.


METHOD unconfirm_sol_part.
  DATA: l_dummy TYPE c .                                    "#EC NEEDED
  FIELD-SYMBOLS: <ls_ofertax>   TYPE ty_s_ofertax.

  IF my_locked IS INITIAL .
    RAISE EXCEPTION TYPE zcx_rm_valoracio
      EXPORTING textid = zcx_rm_valoracio=>not_opened_for_update .
  ENDIF .

  IF my_exp_cont-z_sp_conf_dades IS INITIAL .
    RAISE EXCEPTION TYPE zcx_rm_valoracio
      EXPORTING textid = zcx_rm_valoracio=>not_confirmed_yet .
  ENDIF .

  IF check_activity( co_act_unconfirm_sp ) IS INITIAL .
    RAISE EXCEPTION TYPE zcx_rm_valoracio.
  ENDIF .

  IF my_quadres-quadre1b IS NOT INITIAL.
    RAISE EXCEPTION TYPE zcx_rm_valoracio
      EXPORTING textid = zcx_rm_valoracio=>q1b_already_exists .
  ENDIF .

* Pas A: Inicialitzar valors de capçalera de licitació -------------------------------
  CLEAR: my_exp_cont-z_sp_conf_dades,
         my_exp_cont-z_sp_conf_user,
         my_exp_cont-z_sp_conf_data .

* Pas B: Inicialitzar adjudicació provisional, puntuacions i exclusions tècniques  ----
  LOOP AT my_ofertesx ASSIGNING <ls_ofertax> .
    CLEAR: <ls_ofertax>-offer_data-z_punt_sol,
           <ls_ofertax>-offer_data-z_excl_solv_tec.
    my_ob_ofertes->modificar_oferta( <ls_ofertax>-offer_data ).
  ENDLOOP .

  build_activity_list( ) .
  my_changed = 'X' .

ENDMETHOD.


METHOD unconfirm_tec_offers.
  DATA: l_dummy TYPE c .                                    "#EC NEEDED
  FIELD-SYMBOLS: <ls_ofertax>   TYPE ty_s_ofertax.


  IF my_locked IS INITIAL .
    RAISE EXCEPTION TYPE zcx_rm_valoracio
      EXPORTING
        textid = zcx_rm_valoracio=>not_opened_for_update.
  ENDIF .

  IF my_exp_cont-z_pt_conf_dades IS INITIAL .
    RAISE EXCEPTION TYPE zcx_rm_valoracio
      EXPORTING
        textid = zcx_rm_valoracio=>not_confirmed_yet.
  ENDIF .

  IF      check_activity( co_act_unconfirm_1st ) IS INITIAL .
    RAISE EXCEPTION TYPE zcx_rm_valoracio.
  ENDIF .

  IF my_quadres-quadre2b IS NOT INITIAL.
    RAISE EXCEPTION TYPE zcx_rm_valoracio
      EXPORTING
        textid = zcx_rm_valoracio=>q2b_already_exists.
  ENDIF .

* Pas A: Inicialitzar valors de capçalera de licitació -------------------------------
  CLEAR: ex_punctuation_changed,
         my_exp_cont-z_pt_conf_dades,
         my_exp_cont-z_pt_conf_user,
         my_exp_cont-z_pt_conf_data.

* Pas B: Inicialitzar adjudicació provisional, puntuacions i exclusions tècniques  ----
  LOOP AT my_ofertesx ASSIGNING <ls_ofertax> .
    CLEAR: <ls_ofertax>-offer_data-z_punts_ofert,
           <ls_ofertax>-offer_data-z_punt_tec,
           <ls_ofertax>-offer_data-z_punt_total,
           <ls_ofertax>-offer_data-z_excl_punt_tec.
    my_ob_ofertes->modificar_oferta( <ls_ofertax>-offer_data ).
  ENDLOOP .

  build_activity_list( ) .
  my_changed = 'X' .

ENDMETHOD.


  METHOD update_dyn_data.
    set_dyn_data( EXPORTING   im_docclass   = my_docclass
                              im_objectid   = my_objectid
                  EXCEPTIONS  not_punt_ofer = 1
                              OTHERS        = 2 ).
    IF sy-subrc <> 0.
      RAISE not_punt_ofer.
    ENDIF.
  ENDMETHOD.


  METHOD update_punt_co2.
    DATA: ls_punt_co2 TYPE zrm_dt_punt_co2.

    LOOP AT it_punts_offer ASSIGNING FIELD-SYMBOL(<fs_punt_offer>).
      READ TABLE my_punt_ofer ASSIGNING FIELD-SYMBOL(<fs_of>)
        WITH KEY z_codi_crit_punt = <fs_punt_offer>-z_codi_crit_punt
                 z_num_gen        = <fs_punt_offer>-z_num_gen.

      IF sy-subrc EQ 0.
        <fs_of>-z_punts = <fs_punt_offer>-z_punts.
      ENDIF.

    ENDLOOP.

    READ TABLE it_punt_co2 INTO ls_punt_co2 INDEX 1.
    IF sy-subrc = 0.
      DELETE my_punt_co2 WHERE z_num_ofer = ls_punt_co2-z_num_ofer.

      APPEND LINES OF it_punt_co2 TO my_punt_co2.
    ENDIF.
  ENDMETHOD.
ENDCLASS.