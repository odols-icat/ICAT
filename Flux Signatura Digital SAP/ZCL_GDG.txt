class ZCL_GDG definition
  public
  final
  create public .

public section.

  constants GC_BODY_MAIL_CHECK_ISO type TDOBNAME value 'Z_MAIL_CHECK_ISO' ##NO_TEXT.
  data ARE_SIGNED type ABAP_BOOL .
  constants GC_MSG_ID type SYMSGID value 'ZSIGNATURA' ##NO_TEXT.
  constants GC_CHECK_ISO_KO type SYMSGNO value '017' ##NO_TEXT.
  constants GC_CHECK_ISO_ERR type SYMSGNO value '018' ##NO_TEXT.
  constants GC_MOTIU_CHECK_ISO type DD07V-DOMNAME value 'ZD_MOTIU_CHECK' ##NO_TEXT.
  constants GC_ANCHOR_BPM_CO_CA type ZGDG_ANCHOR value 'BPM_CO_CA' ##NO_TEXT.

  class-events DOCUMENT_SIGNAT
    exporting
      value(ES_ZGDG_DOCS) type ZGDG_DOCS .

  methods CONSTRUCTOR
    importing
      !ZGDG_TIPUS type ZGDG_TIPUS default 'C'
      !ZGDG_FORMAT type SSFFORM default 'PDFTSA'
      !BUKRS type BUKRS optional
      !SIGNATARI type SYSUNAME optional
    exceptions
      Z_ACCION_CANCELADA .
  methods FIRMA_DOC_CS
    importing
      !Z_DOCID type BAPIGUID optional
      !Z_CLASSID type BAPIDCLASS optional
      !Z_NEW_VERSION type BAPIGSBOOL optional
      !GDG_ANCHOR type ZGDG_ANCHOR optional
      !POS type NUM2 optional
      !POS_HASH type CHAR8 optional
      !RESSEGELLAT type ABAP_BOOL optional
      !VALIDATE_DNI type ABAP_BOOL default ABAP_FALSE
      !IV_DESATESA type ABAP_BOOL optional
      !IV_CHECK_ISO type ABAP_BOOL default ABAP_TRUE
    exporting
      !EV_NEW_SIZE type BAPIPOS
    returning
      value(RC) type ABAP_BOOL
    exceptions
      ZGDG_USER_NOT_FOUND
      ZGDG_DOC_NOT_FOUND
      ZGDG_VALIDATE
      ZGDG_UPLOAD
      NO_POS
      ZGDG_DNI
      NO_SIGNED
      USER_NOT_ACTIVE
      NO_VALIDAT
      ISO_KO .
  methods FIRMA_DOC_RAW
    importing
      !DOWNLOAD type C default SPACE
      value(IV_CHECK_ISO) type ABAP_BOOL optional
    changing
      value(DOC_RAW) type SRM_T_BINTAB
      !DOC_LEGTH type I .
  methods ADD_LOG
    importing
      !DOCCLASS type BAPIDCLASS optional
      !OBJECTID type BAPIGUID optional .
  methods SAVE_DOCUMENT
    changing
      !DOC_RAW type SRM_T_BINTAB
      !DOC_LEGTH type I
      !Z_BUKRS type BUKRS
      !Z_DOCID type BAPIGUID
      !Z_CLASSID type BAPIDCLASS
      !LT_BIN_CONTENT type SRM_T_BINTAB .
  methods CODIFICAR_DOC_RAW
    importing
      !I_DATA type XSTRING
      !OPT type BOOLEAN
    exporting
      !E_DATA type XSTRING
    changing
      !DOC_LEGTH type I optional .
  methods OLD_FIRMA_DOCS_CS
    changing
      !FIRMA_DOCS type ZTT_FIRMA_DOC_CS .
  class-methods ADD_SIGN_PAGE
    importing
      !Z_DOCID type BAPIGUID
      !Z_CLASSID type BAPIDCLASS
    returning
      value(RC) type ABAP_BOOL .
  methods FIRMA_DOC_RAW_XML
    importing
      !DOWNLOAD type C default SPACE
      !GDG_ANCHOR type ZGDG_ANCHOR
      !POS type NUM2
      !FORMAT_XML type ZGDG_FORMAT default 'PDFTSA'
    changing
      value(DOC_RAW) type XSTRING
      !DOC_LEGTH type I
    returning
      value(RC) type ABAP_BOOL .
  methods LOCK_UNLOCK_DOC
    importing
      !ZGUID type BAPISRMDOC-GUID
      !ZDOCCLASS type BAPISRMDOC-DOCCLASS
      !LOCK type ABAP_BOOL optional
      !UNLOCK type ABAP_BOOL optional .
  methods FIRMA_DOC_PC .
  methods SET_FORMAT
    importing
      !I_FORMAT type SSFFORM .
  class-methods GET_DNI_FROM_USER
    importing
      !IV_USUARI type UNAME
    exporting
      !EV_DNI type PRDNI
    exceptions
      ZGDG_DNI
      ZNO_EMPLOYEE .
  class-methods GET_EVIDENCIA
    importing
      !I_GDG_DOCS type ZGDG_DOCS .
  methods GUARDAR_LOG_ZGDG_DOCS
    importing
      !IS_ZGDG_DOCS type ZGDG_DOCS
      !IS_ABAP_CALLSTACK type ABAP_CALLSTACK
      !IV_RESULTAT type ZPROC_RESULT optional .
  class-methods CHECK_MIMETYPE
    importing
      !IV_MIMETYPE type BAPIMIMETYPE
      !IV_SISTEMA type Z_SISTEMA_DESTI
      !IV_BUKRS type BUKRS
      !IV_SYSID type SYST_SYSID
    returning
      value(RV_VALID) type XFELD .
  methods GET_DEMORA_SSF
    exporting
      value(EV_DATA) type ZGDG_DEMORA_SSF
    returning
      value(EV_RC) type SYST_SUBRC .
  methods SET_DEMORA_SSF
    importing
      !IV_TEMPS_DEMORA type NUM03 optional
      !IV_ACCIO type ABAP_BOOL
    changing
      value(CV_DATA) type ZGDG_DEMORA_SSF
    returning
      value(RV_RC) type SYST_SUBRC .
  methods ENVIAR_CORREU_DEMORA
    importing
      !IV_TEMPS_DEMORA type NUM03 optional
      !IV_TIPUS_CORREU type STRING
      !IS_DATA type ZGDG_DEMORA_SSF
    returning
      value(RV_RC) type SYST_SUBRC .
  methods REGISTRAR_TEMPS_SIGNAR
    importing
      value(IS_DATA) type ZGDG_DEMORA_SSF
    returning
      value(RV_RC) type SYST_SUBRC .
  methods GET_SIGNATURES_TEMPS
    importing
      !IV_DOCCLASS type BAPIDCLASS
      !IV_OBJECTID type BAPIGUID
      !IV_VERSION type Z_VERSIO
    exporting
      value(ET_DOC_SIGNATURES) type ZT_ZGDG_DEMORA_SSF .
  class-methods GET_AUTORITZACIO
    importing
      !IV_PERNR type PERNR_D
    exceptions
      NO_AUTH
      NO_USERID .
  class-methods SUBSANAR_DOC
    importing
      !IV_OBJECTID type BAPIGUID
      !IV_DOCUMENTCLASS type BAPIDCLASS
      !IV_VERSION type ZGDG_DOCS-VERSION
      !IV_CODI_EXP type Z_CODI_EXP2
      !IV_ANCHOR type Z_ANCHOR
    returning
      value(EV_RC) type SYST_SUBRC .
  methods GET_NOM_CARREC
    importing
      value(I_WEB_HASH) type ZGDG_WEB_HASH optional
    returning
      value(XML) type STRING .
  class-methods CHECK_ISO
    importing
      value(Z_DOCID) type BAPIGUID optional
      value(Z_CLASSID) type BAPIDCLASS optional
      !Z_RAW type XSTRING optional
      value(IV_SIZE) type I optional
      value(IV_CONV) type ABAP_BOOL optional
      value(IV_SIGN) type ABAP_BOOL optional
    exporting
      !RC_TEXT type STRING
      !RC_XML type XSTRING
    returning
      value(RC) type ABAP_BOOL
    exceptions
      NO_DATA
      NO_VALIDAT
      ISO_KO .
  class-methods CHECK_SIZE
    importing
      !IV_DOCCLASS type BAPIDCLASS optional
      !IV_OBJECTID type BAPIGUID optional
      !IV_NUMSIGNATARIS type INTEGER2 optional
      !IV_XSTRING type XSTRING optional
      !IV_TAM_ANNEX type DEC5_2 optional
    exporting
      !EV_ERRONI type XFELD
      !EV_TEXT_M type ZSTRING
      !EV_MSIZE type DEC5_2
      !EV_SIZE type DEC5_2
    exceptions
      NO_DOC .
  class-methods CHECK_ISO_ACTIVE
    importing
      !IV_METHODNAME type STRING
    returning
      value(RV_ACTIVE) type Z_CHECK_IS_ACTIVE .
  class-methods CHECK_ISO_SEND_MAIL
    importing
      value(IS_ZGDG_CHECK_ISO) type ZGDG_CHECK_ISO .
  methods SSF_SIGN_TEST
    changing
      !FILELENGTH type I
      !FILEDATA type RMPS_SSFBIN .
protected section.
private section.

  data ST_SSFPARMS type SSFPARMS .
  data _TIPUS type ZGDG_TIPUS .
  data _FORMAT type SSFFORM .
  data ZGDGUSERS type ZGDGUSERS .
  data ZGDGLOG type ZGDG_LOG .
  data IS_ACTIVE type ABAP_BOOL .
  data _BUKRS type BUKRS .
  data POS_SIGNA type ZGDG_POS_SIGNA .
  data ARE_LOCKED type ABAP_BOOL .
  data GV_COMPUTER_NAME type ZSTRING .
  data GO_LOG_GLOBAL type ref to ZCL_LOG_GLOBAL .
  data GV_DOCCLASS type BAPIDCLASS .
  data GV_OBJECTID type BAPIGUID .

  methods SSF_SIGN
    importing
      !FILELENGTH type I
    changing
      !FILEDATA type RMPS_SSFBIN .
  methods _INIT .
  methods SSF_PKCS7
    importing
      !FILELENGTH type I
      !OPT type BOOLEAN
    changing
      !FILEDATA type RMPS_SSFBIN .
  methods CREATE_XML
    importing
      !FIRMA_DOCS type ZTT_FIRMA_DOC_CS
    exporting
      !XML type STRING .
  methods GET_PAGE_FROM_PDF
    importing
      !I_DATA type XSTRING
    returning
      value(PAGES) type I .
  methods VALID_SELECCIONS_PREVI_FIRMA
    importing
      !IM_CLASSID type BAPIDCLASS
      !IM_DOCID type BAPIGUID
      !IM_POS type NUM2
      !IM_POS_HASH type CHAR8
    exporting
      !EX_ZGDG_DOCS type ZGDG_DOCS
    changing
      !CH_ZGDG_POS_SIGNA_BKP type ZGDG_POS_SIGNA
      !CH_WEB_HASH type ZGDG_WEB_HASH
    exceptions
      USER_NOT_ACTIVE
      ZGDG_DOC_NOT_FOUND .
  methods CREACIO_XML_PDF
    importing
      !IM_POS_HASH type CHAR8 optional
      !IM_DESATESA type ABAP_BOOL
      !IM_WEB_HASH type ZGDG_WEB_HASH
      !IM_VALIDATE_DNI type ABAP_BOOL
      !IM_BIN_CONTENT type BAPIDOCCONTENTAB
      !IM_FS type BAPIDOCCOMP
      !IM_ROTATE type CHAR2
    exporting
      !EX_SSFBIN type RMPS_SSFBIN
      !EX_LONG type I
    changing
      !CH_ZGDG_POS_SIGN_BKP type ZGDG_POS_SIGNA
      !CH_XSTRING type XSTRING
    exceptions
      ZGDG_DNI .
  methods COMPROVAR_VALID_SIGNS_PARAL
    importing
      !IM_ZGDGDOCS type ZGDG_DOCS
      !IM_USUARI_W type UNAME
      !IM_COD_EXP_S type STRING .
  methods GUARDAR_FITXER_LOG_SERVIDOR
    importing
      !Z_DOCID type BAPIGUID
      !Z_CLASSID type BAPIDCLASS
      !Z_ACCIO type CHAR10
      !Z_BINARI type BAPIDOCCONTENTAB optional
      !Z_XSTRING type XSTRING optional
      !Z_SIZE type BAPIPOS
      !Z_EXTENSIO type CHAR10 .
  class-methods GUARDAR_TXT_LOG_SERVIDOR
    importing
      !IS_SIGNER type SSFINFO
      !IS_SSFPARMS type SSFPARMS .
ENDCLASS.



CLASS ZCL_GDG IMPLEMENTATION.


  METHOD add_log.

    DATA: it_zgdglog TYPE TABLE OF zgdg_log.
    DATA: wa_zgdg_log LIKE LINE OF it_zgdglog.

    REFRESH it_zgdglog.
    CLEAR it_zgdglog.
    CLEAR wa_zgdg_log.

    wa_zgdg_log-zgdg_docclass_log = docclass.
    wa_zgdg_log-zgdg_objectid_log = objectid.
    wa_zgdg_log-zgdg_data_log     = sy-datum.
    wa_zgdg_log-zgdg_hora_log     = sy-uzeit.
    wa_zgdg_log-zgdg_bukrs_log    = _bukrs.
    wa_zgdg_log-zgdg_tipus_log    = _tipus.
    wa_zgdg_log-zgdg_format_log   = _format.
    wa_zgdg_log-zgdg_tsa_log      = zgdglog-zgdg_tsa_log.
    wa_zgdg_log-zgdg_signat_log   = zgdglog-zgdg_signat_log.
    wa_zgdg_log-zgdg_ltv_log      = zgdglog-zgdg_ltv_log .
    wa_zgdg_log-zgdg_is_active    = is_active.


    APPEND wa_zgdg_log TO it_zgdglog.
    MODIFY zgdg_log FROM TABLE it_zgdglog.

  ENDMETHOD.


  METHOD add_sign_page.

    DATA lt_pdf_files    TYPE ztt_pdf_files.
    DATA ls_pdf_files    TYPE LINE OF ztt_pdf_files.
    DATA lt_pdf_merged   TYPE zt_bapicontent255.
    DATA lv_len          TYPE i.

    DATA: lt_components  TYPE TABLE OF bapidoccomp,

          lt_bin_content TYPE TABLE OF bapiconten.

    FIELD-SYMBOLS <fs_comp> TYPE bapidoccomp.
    DATA l_long TYPE i.
    DATA ssfbin TYPE rmps_ssfbin.

    FIELD-SYMBOLS <fs>    TYPE  bapidoccomp.

    "Recuperem el Document a Signar

    CALL FUNCTION 'SRM_DOCUMENT_CHECKOUT_VIA_TAB'
      EXPORTING
        objectid        = z_docid
        documentclass   = z_classid
      TABLES
        components      = lt_components
        bin_content     = lt_bin_content
      EXCEPTIONS
        internal_error  = 1
        parameter_error = 2
        not_authorized  = 3
        doc_not_found   = 4
        OTHERS          = 5.
    IF sy-subrc <> 0.
      rc = abap_false.
      EXIT.
    ENDIF.

    READ TABLE lt_components ASSIGNING <fs> INDEX 1.
    DATA : xtab TYPE solix_tab.
    CALL METHOD cl_rmps_general_functions=>convert_1022_to_255
      EXPORTING
        im_tab_1022 = lt_bin_content
      RECEIVING
        re_tab_255  = xtab.


    ls_pdf_files-id = 1.
    ls_pdf_files-length = <fs>-comp_size.
    ls_pdf_files-content = xtab.
    APPEND ls_pdf_files TO lt_pdf_files.

    "Recuperem la plantilla de signatures del final


    DATA: l_objectid_fin      TYPE bapisrmdoc-guid,
          l_documentclass_fin TYPE  bapisrmdoc-docclass.

    DATA l_hc TYPE zsap_dt_param_hc.

    SELECT SINGLE * INTO l_hc
      FROM zsap_dt_param_hc
      WHERE repid = 'GDG'
      AND field_info = 'PLANTILLA_SIGNATURES'.
    l_documentclass_fin = l_hc-value.
    l_objectid_fin = l_hc-value2.

    CALL FUNCTION 'SRM_DOCUMENT_CHECKOUT_VIA_TAB'
      EXPORTING
        objectid        = l_objectid_fin
        documentclass   = l_documentclass_fin
      TABLES
        components      = lt_components
        bin_content     = lt_bin_content
      EXCEPTIONS
        internal_error  = 1
        parameter_error = 2
        not_authorized  = 3
        doc_not_found   = 4
        OTHERS          = 5.
    IF sy-subrc <> 0.
      rc = abap_false.
      EXIT.
    ENDIF.

    READ TABLE lt_components ASSIGNING <fs> INDEX 1.
*    DATA : xtab TYPE solix_tab.
    CALL METHOD cl_rmps_general_functions=>convert_1022_to_255
      EXPORTING
        im_tab_1022 = lt_bin_content
      RECEIVING
        re_tab_255  = xtab.

    ls_pdf_files-length = <fs>-comp_size.
    ls_pdf_files-content = xtab.
    ls_pdf_files-id = 2.
    APPEND ls_pdf_files TO lt_pdf_files.


    CALL FUNCTION 'ZFM_PDF_MERGE'
      EXPORTING
        it_files    = lt_pdf_files
      IMPORTING
        et_pdfmerge = lt_pdf_merged
        ev_length   = lv_len.

    IF lv_len IS INITIAL OR lt_pdf_merged IS INITIAL.
      rc = abap_false.
    ENDIF.

    REFRESH lt_bin_content.
    CALL METHOD cl_rmps_general_functions=>convert_255_to_1022
      EXPORTING
        im_tab_255  = lt_pdf_merged
      RECEIVING
        re_tab_1022 = lt_bin_content.

    DELETE lt_components INDEX 2.
    READ TABLE lt_components ASSIGNING <fs_comp>  INDEX 1.

    <fs_comp>-comp_size = lv_len.

    CALL FUNCTION 'SRM_DOCUMENT_CHECKIN_VIA_TAB'
      EXPORTING
        objectid        = z_docid
        documentclass   = z_classid
        as_new_version  = 'X'
        do_commit       = 'X'
      TABLES
        components      = lt_components
        bin_content     = lt_bin_content
      EXCEPTIONS
        internal_error  = 1
        parameter_error = 2
        not_authorized  = 3
        doc_not_found   = 4
        yet_locked      = 5
        OTHERS          = 6.

    IF sy-subrc <> 0.
      rc = abap_false.
    ELSE.
      rc = abap_true.
    ENDIF.


  ENDMETHOD.


METHOD check_iso.
  DATA: lt_components         TYPE TABLE OF bapidoccomp,
        lt_bin_content        TYPE TABLE OF bapiconten,
        lt_it_signer          TYPE TABLE OF ssfinfo,
        lt_versig_list        TYPE TABLE OF ssfinfoext,
        lt_in_data_table      TYPE TABLE OF ssfbin,
        lt_out_data_table     TYPE TABLE OF ssfbin,
        lt_ver_data_table     TYPE TABLE OF ssfbin,
        lt_resp               TYPE TABLE OF smum_xmltb,
        lt_bapiret            TYPE TABLE OF bapiret2,
        ls_resp               TYPE smum_xmltb,
        l_xresposta           TYPE xstring,
        lt_xtab               TYPE solix_tab,
        ssfrc                 TYPE ssfreturn,
        wa_signer             TYPE ssfinfo,
        ostr_output_data_l    TYPE int4,
        crc                   TYPE int4,
        ld_size               TYPE int4,
        l_out_long            TYPE ssflen,
        l_bapidoccomp         TYPE bapidoccomp,
        ostr_output_data(255),
*>>>SPEC:66792, Inici modificació - ECMLS
        lt_abap_stack         TYPE abap_callstack,
        ls_abap_stack         TYPE abap_callstack_line,
        ls_zgdg_check_iso     TYPE zgdg_check_iso,
        lt_properties         TYPE TABLE OF bapiproptb,
        ls_properties         TYPE bapiproptb,
        lv_version            TYPE numc3,
        lv_xstring            TYPE xstring.

  CALL FUNCTION 'SYSTEM_CALLSTACK'
    IMPORTING
      callstack = lt_abap_stack.

  "Obtenim el mètode actual
  READ TABLE lt_abap_stack INTO ls_abap_stack INDEX 1.

  "Comprovem que la validació està activa
  IF zcl_gdg=>check_iso_active( iv_methodname = ls_abap_stack-blockname ) EQ abap_false.
    RETURN.
  ENDIF.
*<<<SPEC:66792, Final modificació - ECMLS

  IF z_docid IS NOT INITIAL AND z_classid IS NOT INITIAL.
*>>>SPEC:66792, Inici modificació - ECMLS
    CALL FUNCTION 'SRM_DOCUMENT_GETPROPERTIES'
      EXPORTING
        objectid          = z_docid
        documentclass     = z_classid
      TABLES
        properties        = lt_properties
      EXCEPTIONS
        internal_error    = 1
        parameter_error   = 2
        not_authorized    = 3
        doc_not_found     = 4
        variant_not_found = 5
        version_not_found = 6
        OTHERS            = 7.
    IF sy-subrc EQ 0.
      READ TABLE lt_properties INTO ls_properties WITH KEY name = 'SRM_VERSION_ID'.
      IF sy-subrc EQ 0.
        lv_version = ls_properties-value.
      ENDIF.
    ENDIF.

    SELECT SINGLE docclass, objectid, check_iso_passat, z_motiu_check
      INTO CORRESPONDING FIELDS OF @ls_zgdg_check_iso
      FROM zgdg_check_iso
     WHERE objectid EQ @z_docid
       AND docclass EQ @z_classid
       AND version  EQ @lv_version.

    "Si ha trobat registres del document
    IF sy-subrc EQ 0.
      "Si compleix la ISO o si està signat tornem
      IF ls_zgdg_check_iso-check_iso_passat EQ abap_true OR
         ls_zgdg_check_iso-z_motiu_check    EQ 5.
        rc = abap_true.
        RETURN.
      ENDIF.

      "Ha passat la validació però no compleix la ISO
      "Enviem un correu al cau
      check_iso_send_mail(
        EXPORTING
          is_zgdg_check_iso = ls_zgdg_check_iso
      ).

      RAISE iso_ko.
    ELSE.
      "Omplim els camps comuns
      ls_zgdg_check_iso-docclass = z_classid.
      ls_zgdg_check_iso-objectid = z_docid.
      ls_zgdg_check_iso-version  = lv_version.
    ENDIF.
*<<<SPEC:66792, Final modificació - ECMLS

    "Recuperamos el documento del CS
    CALL FUNCTION 'SRM_DOCUMENT_CHECKOUT_VIA_TAB'
      EXPORTING
        objectid        = z_docid
        documentclass   = z_classid
      TABLES
        components      = lt_components
        bin_content     = lt_bin_content
      EXCEPTIONS
        internal_error  = 1
        parameter_error = 2
        not_authorized  = 3
        doc_not_found   = 4
        OTHERS          = 5.

    "Recuperem l'a informació dels seus atributs.
    READ TABLE lt_components INTO l_bapidoccomp INDEX 1.

  ELSEIF  z_raw IS NOT INITIAL.

    CALL METHOD cl_rmps_general_functions=>convert_xstring_to_1022_raw
      EXPORTING
        im_xstring  = z_raw
      RECEIVING
        re_tab_1022 = lt_bin_content.

    DESCRIBE TABLE lt_bin_content.

    IF iv_size IS NOT INITIAL.
      l_bapidoccomp-comp_size = iv_size.
    ELSE.
      l_bapidoccomp-comp_size = sy-tfill * sy-tleng.
    ENDIF.

  ELSE.
    RAISE no_data.
  ENDIF.

  CALL METHOD cl_rmps_general_functions=>convert_1022_to_255
    EXPORTING
      im_tab_1022 = lt_bin_content
    RECEIVING
      re_tab_255  = lt_xtab.

  IF lt_xtab IS INITIAL.
    RAISE no_data.
  ENDIF.

*Antes de operar hay que inicializar el producto de seguridad
  CALL FUNCTION 'SSF_KRN_VERSION'
    EXPORTING
      ssftoolkit             = 'gdgcrypt'
    IMPORTING
      ostr_output_data       = ostr_output_data
      ostr_output_data_l     = ostr_output_data_l
      crc                    = crc
    EXCEPTIONS
      ssf_krn_error          = 1
      ssf_krn_noop           = 2
      ssf_krn_opinv          = 3
      ssf_krn_nossflib       = 4
      ssf_krn_invalid_par    = 5
      ssf_krn_invalid_parlen = 6
      OTHERS                 = 7.

  IF sy-subrc <> 0.
    RAISE no_validat.
  ENDIF.

  CALL FUNCTION 'SSF_KRN_QUERYPROPERTIES'
    EXPORTING
      ssftoolkit             = 'gdgcrypt'
      property               = 'PROPERTIES'
      argument               = ''
    IMPORTING
      ostr_output_data       = ostr_output_data
      ostr_output_data_l     = ostr_output_data_l
      crc                    = crc
    EXCEPTIONS
      ssf_krn_error          = 1
      ssf_krn_noop           = 2
      ssf_krn_opinv          = 3
      ssf_krn_nossflib       = 4
      ssf_krn_invalid_par    = 5
      ssf_krn_invalid_parlen = 6
      OTHERS                 = 7.
  IF sy-subrc <> 0.
    RAISE no_validat.
  ENDIF.

  SELECT SINGLE ssfid_hash ssf_prof FROM zgdgusers
    INTO (wa_signer-id, wa_signer-profile)
    WHERE bname = 'GISA_SOFT'.

  APPEND wa_signer TO lt_it_signer.


  CALL FUNCTION 'SSF_KRN_DIGEST'
    EXPORTING
      ssftoolkit                   = 'gdgcrypt'
      str_format                   = 'PKCS7'
      b_detached                   = ' '
      b_inenc                      = 'X'
      io_spec                      = 'T'
      ostr_input_data_l            = l_bapidoccomp-comp_size
      str_hashalg                  = 'PDFVALID'
    IMPORTING
      ostr_digested_data_l         = l_out_long
      crc                          = ssfrc
    TABLES
      ostr_input_data              = lt_xtab
      ostr_digested_data           = lt_out_data_table
    EXCEPTIONS
      ssf_krn_error                = 399
      ssf_krn_noop                 = 201
      ssf_krn_nomemory             = 202
      ssf_krn_opinv                = 203
      ssf_krn_input_data_error     = 208
      ssf_krn_invalid_par          = 209
      ssf_krn_invalid_parlen       = 210
      ssf_fb_input_parameter_error = 109
      OTHERS                       = 212.

  IF sy-subrc <> 0.
    RAISE no_validat.
  ENDIF.



  CALL FUNCTION 'SCMS_BINARY_TO_XSTRING'
    EXPORTING
      input_length = l_out_long
*     FIRST_LINE   = 0
*     LAST_LINE    = 0
    IMPORTING
      buffer       = l_xresposta
    TABLES
      binary_tab   = lt_out_data_table
    EXCEPTIONS
      failed       = 1
      OTHERS       = 2.
  IF sy-subrc <> 0.
    RAISE no_data.
  ELSE.
*>>>SPEC:66792, Inici modificació - ECMLS
    CALL FUNCTION 'SCMS_BINARY_TO_XSTRING'
      EXPORTING
        input_length = l_bapidoccomp-comp_size
*       FIRST_LINE   = 0
*       LAST_LINE    = 0
      IMPORTING
        buffer       = lv_xstring
      TABLES
        binary_tab   = lt_xtab
      EXCEPTIONS
        failed       = 1
        OTHERS       = 2.
    IF sy-subrc <> 0.
      RAISE no_data.
    ELSE.
">> SPEC-72653, Inici Modificació - ETODR
      "Es comenta aquesta part ja que no té sentit verificar el PSIS en termes de ISO del document
**      "Si ja està signat l'afegim a ZGDG_CHECK_ISO i saltem comprovació
**      IF zcl_psis=>validate_signature( i_file = lv_xstring ) = 'OK'.
**        ls_zgdg_check_iso-z_motiu_check = 5. "El document ja està signat
**        INSERT zgdg_check_iso FROM ls_zgdg_check_iso.
**        RETURN.
**      ENDIF.
"<< SPEC-72653, Final Modificació - ETODR
    ENDIF.
*<<<SPEC:66792, Final modificació - ECMLS
  ENDIF.


  CALL FUNCTION 'SMUM_XML_PARSE'
    EXPORTING
      xml_input = l_xresposta
    TABLES
      xml_table = lt_resp
      return    = lt_bapiret.

  rc_xml = l_xresposta.

  LOOP AT lt_resp INTO ls_resp WHERE cname = 'CODE' OR cname = 'ESTATUS'.

    IF ls_resp-cname = 'CODE'.
      IF ls_resp-cvalue = '00'.
        rc = abap_true.
*>>>SPEC:66792, Inici modificació - ECMLS
        "Si el GUID i DOCCLASS estàn informats
        IF z_docid IS NOT INITIAL AND z_classid IS NOT INITIAL.
          ls_zgdg_check_iso-check_iso_passat = rc.
          "Si compleix la ISO i s'ha convertit
          IF iv_conv EQ abap_true.
            ls_zgdg_check_iso-z_motiu_check = 1. "El document compleix amb la ISO en convertir-lo
            INSERT zgdg_check_iso FROM ls_zgdg_check_iso.
          ELSEIF iv_sign EQ abap_true.
            ls_zgdg_check_iso-z_motiu_check = 2. "El document compleix amb la ISO abans de signar-lo
            INSERT zgdg_check_iso FROM ls_zgdg_check_iso.
          ENDIF.
        ENDIF.
*<<<SPEC:66792, Final modificació - ECMLS
      ELSE.
        rc = abap_false.
*>>>SPEC:66792, Inici modificació - ECMLS
        "Si el GUID i DOCCLASS estàn informats
        IF z_docid IS NOT INITIAL AND z_classid IS NOT INITIAL.
          ls_zgdg_check_iso-check_iso_passat = rc.
          "Si no compleix la ISO i s'ha convertit
          IF iv_conv EQ abap_true.
            ls_zgdg_check_iso-z_motiu_check = 3. "El document no compleix amb la ISO en convertir-lo
            INSERT zgdg_check_iso FROM ls_zgdg_check_iso.
          ELSEIF iv_sign EQ abap_true.
            ls_zgdg_check_iso-z_motiu_check = 4. "El document no compleix amb la ISO abans de signar-lo
            INSERT zgdg_check_iso FROM ls_zgdg_check_iso.
          ENDIF.

          "Enviem un correu al cau
          check_iso_send_mail(
            EXPORTING
              is_zgdg_check_iso = ls_zgdg_check_iso
          ).
        ENDIF.

        RAISE iso_ko.
*<<<SPEC:66792, Final modificació - ECMLS
      ENDIF.
    ENDIF.
    IF ls_resp-cname = 'ESTATUS'.
      rc_text =  ls_resp-cvalue.
    ENDIF.
  ENDLOOP.
  IF sy-subrc <> 0. "Si no tenemos respuesta...
    RAISE no_validat.
  ENDIF.

ENDMETHOD.


  METHOD check_iso_active.

    DATA: lv_z_check_is_active TYPE zgestiona_check-z_check_is_active.

    SELECT SINGLE z_check_is_active
      INTO lv_z_check_is_active
      FROM zgestiona_check
      WHERE methodname EQ iv_methodname.

    IF sy-subrc EQ 0.
      rv_active = lv_z_check_is_active.
    ENDIF.

  ENDMETHOD.


  METHOD check_iso_send_mail.

    DATA: lt_replace   TYPE /dsd/hh_value_text_tt,
          lt_docs_doc  TYPE TABLE OF zrm_dt_docs_doc,
          lt_prop      TYPE TABLE OF bapiproptb,
          ls_replace   TYPE /dsd/hh_value_text,
          ls_docs_doc  TYPE zrm_dt_docs_doc,
          ls_prop      TYPE bapiproptb,
          lv_sent      TYPE abap_bool,
          lv_motiu     TYPE dd07v-domvalue_l,
          lv_motiu_t   TYPE dd07v-ddtext,
          lv_recipient TYPE ad_smtpadr,
          lv_sender    TYPE ad_smtpadr,
          lv_subject   TYPE so_obj_des.




    FIELD-SYMBOLS <fs_replace> TYPE /dsd/hh_value_text.


    "Obtenir remitent
    SELECT SINGLE value
      INTO lv_sender
      FROM zsap_dt_param_hc
     WHERE repid      = zsubc_repid
       AND langu      = sy-langu
       AND field_info = zsubc_info.

    IF sy-subrc EQ 0.
      "TEXTO
    ENDIF.

    "Obtenim GUID
    CLEAR: ls_replace.
    ls_replace-keyfield = 'OBJECTID'.
    ls_replace-text = is_zgdg_check_iso-objectid.
    APPEND ls_replace TO lt_replace.

    "Obtenim classe doc
    CLEAR: ls_replace.
    ls_replace-keyfield = 'DOCCLASS'.
    ls_replace-text = is_zgdg_check_iso-docclass.
    APPEND ls_replace TO lt_replace.

    "Obtenim codi del document
    CALL FUNCTION 'SRM_DOCUMENT_GETPROPERTIES'
      EXPORTING
        objectid          = is_zgdg_check_iso-objectid
        documentclass     = is_zgdg_check_iso-docclass
        whole_document    = ''
      TABLES
        properties        = lt_prop
      EXCEPTIONS
        internal_error    = 1
        parameter_error   = 2
        not_authorized    = 3
        doc_not_found     = 4
        variant_not_found = 5
        version_not_found = 6
        OTHERS            = 7.

    IF sy-subrc EQ 0.
      READ TABLE lt_prop INTO ls_prop WITH KEY name = 'SRM_DOCUMENT_ID'.

      IF sy-subrc EQ 0.
        CLEAR: ls_replace.
        ls_replace-keyfield = 'Z_COD_DOC'.
        ls_replace-text = ls_prop-value.
        APPEND ls_replace TO lt_replace.
      ENDIF.
    ENDIF.

    "Obtenim text amb el motiu
    lv_motiu = is_zgdg_check_iso-z_motiu_check.
    CONDENSE lv_motiu.

    CALL FUNCTION 'DOMAIN_VALUE_GET'
      EXPORTING
        i_domname      = zcl_gdg=>gc_motiu_check_iso
        i_domvalue     = lv_motiu
      IMPORTING
        e_ddtext       = lv_motiu_t
      EXCEPTIONS
        wrong_textflag = 1
        OTHERS         = 2.

    IF sy-subrc EQ 0.
      CLEAR: ls_replace.
      ls_replace-keyfield = 'Z_MOTIU_CHECK'.
      ls_replace-text = lv_motiu_t.
      APPEND ls_replace TO lt_replace.
    ENDIF.

    "Indiquem posició de la variable a substituir i l'idioma
    LOOP AT lt_replace ASSIGNING <fs_replace>.
      <fs_replace>-language = sy-langu.
    ENDLOOP.


    "Asignem els textos als paràmetres
    lv_recipient = text-m01.
    lv_subject   = text-m02.

    "Send mail
    zcl_utilities=>mail_send_2_external(
      EXPORTING
        i_recipient = lv_recipient
        i_sender    = lv_sender
        i_subject   = lv_subject
        i_body      = zcl_gdg=>gc_body_mail_check_iso
        it_replace  = lt_replace
      RECEIVING
        o_sent      = lv_sent
    ).

  ENDMETHOD.


  METHOD check_mimetype.
    SELECT *
      FROM zpsig_dt_cus_doc
      INTO TABLE @DATA(lt_cus_doc)
     WHERE zrtf_bukrs      EQ @iv_bukrs AND
           sysid           EQ @sy-sysid  AND
           z_sistema_desti EQ @iv_sistema.
*
    DATA(lv_subrc) = sy-subrc.

    CHECK lv_subrc EQ 0.
    SELECT *
    FROM zpsig_tipus_doc
    INTO TABLE @DATA(lt_tipus)
          FOR ALL ENTRIES IN @lt_cus_doc
          WHERE z_identif = @lt_cus_doc-z_tipus_doc.

    CHECK sy-subrc EQ 0.
    LOOP AT lt_tipus ASSIGNING FIELD-SYMBOL(<fs_tipus>).

      IF iv_mimetype = <fs_tipus>-mimetype.
        rv_valid = abap_true.
      ENDIF.
    ENDLOOP.
  ENDMETHOD.


  METHOD check_size.
    DATA: lt_compo       TYPE TABLE OF bapidoccomp,
          ls_compo       TYPE          bapidoccomp,
          lt_bin_content TYPE TABLE OF bapiconten,
          lv_length      TYPE i,
          lv_max_length  TYPE i,
          lv_size_s      TYPE i,
          lt_param_hc    TYPE zsap_tt_param_hc,
          ls_param_hc    TYPE zsap_dt_param_hc,
          lv_length_d    TYPE dec5_2.

*    recuperamos el contenido y el tamaño del fichero a firmar

    IF iv_docclass IS NOT INITIAL AND iv_objectid IS NOT INITIAL.
      CLEAR: lt_compo,
             lt_bin_content.

      CALL FUNCTION 'SRM_DOCUMENT_CHECKOUT_VIA_TAB'
        EXPORTING
          objectid        = iv_objectid
          documentclass   = iv_docclass
        TABLES
          components      = lt_compo
          bin_content     = lt_bin_content
        EXCEPTIONS
          internal_error  = 1
          parameter_error = 2
          not_authorized  = 3
          doc_not_found   = 4
          yet_locked      = 5
          OTHERS          = 6.
      IF sy-subrc <> 0.
        RAISE no_doc.
      ELSE.
        READ TABLE lt_compo INTO ls_compo INDEX 1.
        IF sy-subrc EQ 0.
          lv_length = ls_compo-comp_size.
        ENDIF.
      ENDIF.
    ELSEIF iv_xstring IS NOT INITIAL.
      CALL FUNCTION 'SCMS_XSTRING_TO_BINARY'
        EXPORTING
          buffer        = iv_xstring
        IMPORTING
          output_length = lv_length
        TABLES
          binary_tab    = lt_bin_content.
    ENDIF.

*   Recuperamos la parametrización máxima del fichero
    CLEAR lt_param_hc.
    CALL METHOD zcl_utils_parametritzacio=>get_dades_parametritzades
      EXPORTING
        iv_repid            = 'SIGNATURA'
        iv_langu            = sy-langu
*       iv_field_info       =
*       iv_field_info2      =
      IMPORTING
        et_zsap_dt_param_hc = lt_param_hc
      EXCEPTIONS
        not_found           = 1
        OTHERS              = 2.

    IF iv_numsignataris IS NOT INITIAL.
      READ TABLE lt_param_hc INTO ls_param_hc WITH KEY field_info = 'SIGN_SIZE'.
      IF sy-subrc EQ 0.
        lv_size_s = ls_param_hc-value.
        lv_length = lv_size_s * iv_numsignataris + lv_length.
      ENDIF.
    ENDIF.

    READ TABLE lt_param_hc INTO ls_param_hc WITH KEY field_info = 'FILE_SIZE_MAX'.
    IF sy-subrc EQ 0.
      lv_max_length = ls_param_hc-value.
      ev_msize = ls_param_hc-value.
    ENDIF.

      ev_size = lv_length_d = lv_length / 1000000.

    IF lv_length_d + iv_tam_annex GT lv_max_length.
      ev_erroni = abap_true.
      IF iv_tam_annex IS NOT INITIAL.
        ev_text_m =  `El fitxer té una grandària de ` && lv_length_d && ` Mb (més ` &&  iv_tam_annex  && ` Mb pels annexos). El màxim permès és `
                   && lv_max_length && ` Mb. No es pot realitzar l'enviament.`.
      else.
        ev_text_m =  `El fitxer té una grandària de ` && lv_length_d && ` Mb. El màxim permès és `
                   && lv_max_length && ` Mb. No es pot realitzar l'enviament.`.

      ENDIF.
    ENDIF.

  ENDMETHOD.


  METHOD codificar_doc_raw.

    " Declaración de variables
    DATA: flen TYPE i,
          xtab TYPE TABLE OF x255.
    DATA: ssfbin TYPE rmps_ssfbin,
          wssfbin TYPE LINE OF rmps_ssfbin.

    " Conversión STRING to 255
    CALL FUNCTION 'SCMS_XSTRING_TO_BINARY'
      EXPORTING
        buffer        = i_data
      IMPORTING
        output_length = flen
      TABLES
        binary_tab    = ssfbin.

    " Encriptar/Desencriptar Archivo
    CALL METHOD me->ssf_pkcs7
      EXPORTING
        filelength = doc_legth
        opt        = opt
      CHANGING
        filedata   = ssfbin.

    doc_legth = st_ssfparms-outdatalen.

    "Eliminamos posibles lineas en blanco

    LOOP AT ssfbin INTO wssfbin.
      IF wssfbin IS INITIAL.
        DELETE ssfbin  INDEX sy-tabix.
      ENDIF.
    ENDLOOP.


    " Conversión 255 to STRING
    CHECK doc_legth > 0.
    CALL FUNCTION 'SCMS_BINARY_TO_XSTRING'
      EXPORTING
        input_length = doc_legth
      IMPORTING
        buffer       = e_data
      TABLES
        binary_tab   = ssfbin
      EXCEPTIONS
        failed       = 1
        OTHERS       = 2.

  ENDMETHOD.


  METHOD comprovar_valid_signs_paral.

*   Busquem totes les posiciones del document amb estat pendent de firma o
*   pendent de validar.
    SELECT * FROM zgdg_docs
    INTO TABLE @DATA(lt_sign)
    WHERE docclass  EQ @im_zgdgdocs-docclass
      AND objectid  EQ @im_zgdgdocs-objectid
      AND version   EQ @im_zgdgdocs-version
      AND status    EQ 'P'
      AND pos       NE @im_zgdgdocs-pos.

*   Busquem si el document te alguna posició pendent de firma
    READ TABLE lt_sign ASSIGNING FIELD-SYMBOL(<fs_sign>)
                       WITH KEY accions = 'F'.

*   Si no trobem cap posició més de firma, mirem si tenim alguna posició
*   per validar.
    IF sy-subrc <> 0.

      READ TABLE lt_sign ASSIGNING <fs_sign> WITH KEY accions = 'V'.

*     Si trobem alguna posició per validar modifiquem el seu estat a cancel·lat
      IF sy-subrc EQ 0.

        LOOP AT lt_sign ASSIGNING <fs_sign> WHERE accions = 'V'.

          UPDATE zgdg_docs
          SET status = 'V'
              accions = ''
          WHERE docclass  EQ im_zgdgdocs-docclass
            AND objectid  EQ im_zgdgdocs-objectid
            AND version   EQ im_zgdgdocs-version
            AND status    EQ 'P'
            AND accions   EQ 'V'
            AND pos       EQ <fs_sign>-pos.

          UPDATE zrm_dt_resp_doc
          SET z_subsanat = abap_true
          WHERE z_rol_dig = 'V'
            AND z_posicio_hash = <fs_sign>-z_posicio_hash.

          UPDATE zdocs_signa_des
          SET z_entorn  = 'SAP'
              z_estat   = 'SIF'
          WHERE docclass   EQ im_zgdgdocs-docclass
            AND objectid   EQ im_zgdgdocs-objectid
            AND version    EQ im_zgdgdocs-version
            AND usuari_sig EQ <fs_sign>-usuari.

          zcl_signatura_desatesa=>informar_enviament_a_web(
          EXPORTING
            iv_estat          = 'F'
            iv_docclass       = im_zgdgdocs-docclass
            iv_objectid       = im_zgdgdocs-objectid
            iv_version        = im_zgdgdocs-version
            iv_usuari         = im_usuari_w
            iv_hora_enviament = im_zgdgdocs-hora_envio    " Hora del dia
            iv_data_enviament = im_zgdgdocs-data_envio    " Data
            iv_codi_exped     = im_cod_exp_s
            iv_annex          = im_zgdgdocs-annexos ).

        ENDLOOP.

      ENDIF.

    ENDIF.

  ENDMETHOD.


  METHOD constructor.

    DATA: lv_name TYPE xubname.
    DATA: L_BNAME TYPE XUBNAME.

    _tipus     = zgdg_tipus.
    _format    = zgdg_format.
    _bukrs     = bukrs.

">> SPEC-67085, Inici Modificació - ETODR
  IF go_log_global IS INITIAL.
    go_log_global =  zcl_log_global=>get_instancia( ).
  ENDIF.
  IF go_log_global IS BOUND.
    go_log_global->afegir_entrada( EXPORTING  iv_tasca = zglog_tasca_inicial
                                   EXCEPTIONS OTHERS   = 0 ).
  ENDIF.
"<< SPEC-67085, Final Modificació - ETODR

    ">>>>> INI SPEC-58451 ECRCM
    IF zgdg_tipus = 'U'.
      DATA l_resp TYPE c.
      lv_name = sy-uname && '_SOFT'.
      SELECT COUNT(*) FROM zgdgusers INTO zgdgusers
        WHERE ( bname = sy-uname OR bname = lv_name )
        AND sysysid = sy-sysid.

      IF sy-dbcnt = 2.
    CALL FUNCTION 'POPUP_TO_CONFIRM'
          EXPORTING
            titlebar              = 'Seleccioni el tipus de Signatura'
            text_question         = 'Com vol realitzar la signatura?'
            text_button_1         = 'Serv. Segur'
            icon_button_1         = 'ICON_SAP_LOGON_SERVER_SSO'
            text_button_2         = 'Targ. TCAT'
            icon_button_2         = 'ICON_PATIENT_SMARTCARD'
            iv_quickinfo_button_1 = 'Des del servidor segur'
            iv_quickinfo_button_2 = 'Amb targeta TCAT'
          IMPORTING
            answer                = l_resp
          EXCEPTIONS
            text_not_found        = 1
            OTHERS                = 2.

      IF sy-subrc <> 0.
          is_active = abap_false.
      ENDIF.
        CASE l_resp.
          WHEN '1'. "Simuleamos firma Masiva para usar el Certificado del HSM
            _tipus = 'F'.
          WHEN '2'. "Firma con TCAT - No hacemos nada
          WHEN OTHERS. "Cancela, no hacemos nada mas
            "is_active = abap_false.
            raise z_accion_cancelada.
            "EXIT.
        ENDCASE.
        CLEAR lv_name.
      ENDIF.

*<< INCI SPEC-65581 ECBAC
       IF sy-dbcnt = 1.
         SELECT SINGLE bname FROM zgdgusers INTO l_bname
          WHERE ( bname = sy-uname OR bname = lv_name )
          AND sysysid = sy-sysid.

        IF  l_bname eq lv_name. " TCATP ( servidor)
           _tipus = 'F'.
        ENDIF.
        CLEAR l_bname.
*>> FIN SPEC-65581 ECBAC
        CLEAR lv_name.
      ENDIF.
  ENDIF.
    ">>>>> FIN SPEC-58451 ECRCM


    st_ssfparms-ssftoolkit    = 'gdgcrypt'.
    st_ssfparms-ssfformat     = zgdg_format.
    st_ssfparms-binccerts     = 'X'.
    st_ssfparms-bdetached     = ' '.
    st_ssfparms-binenc        = 'X'.
    st_ssfparms-iospec        = 'T'.
    st_ssfparms-ssfhashalg    = 'SHA1'.

    DATA l_bukrs TYPE char20.
    DATA l_hosts TYPE char20.

    CONCATENATE _bukrs  '%' INTO l_bukrs.
*    CONCATENATE sy-host '%' INTO l_hosts.

    CASE _tipus.
      WHEN 'C'. "Centralizado

        SELECT SINGLE * FROM zgdgusers INTO zgdgusers
          WHERE bname LIKE l_bukrs
*          AND host LIKE l_hosts
          AND addrnumber = space
          AND persnumber = space
          AND sysysid = sy-sysid.
        IF sy-subrc = 0.
          is_active = abap_true.
        ELSE.
          is_active = abap_false.
        ENDIF.

      WHEN 'F'. "Firma masiva

        IF signatari IS INITIAL.
          lv_name = sy-uname && '_SOFT'.
        ELSE.
          lv_name = signatari && '_SOFT'.
        ENDIF.

*        IF  signatari EQ 'ETLJS'.
*          TRANSLATE l_hosts TO UPPER CASE.
*        ENDIF.

        SELECT SINGLE * FROM zgdgusers INTO zgdgusers
         WHERE bname LIKE lv_name
*           AND host LIKE l_hosts
           AND sysysid = sy-sysid.

        IF sy-subrc = 0.
          st_ssfparms-ssfformat = _format = 'RICHDOC'.
          is_active = abap_true.
        ELSE.
          is_active = abap_false.
        ENDIF.

      WHEN 'U'.
        SELECT SINGLE * FROM zgdgusers INTO zgdgusers
          WHERE bname = sy-uname
          AND sysysid = sy-sysid.
        IF sy-subrc = 0.
          is_active = abap_true.
        ELSE.
          is_active = abap_false.
        ENDIF.
        IF  _tipus = 'U'  AND _format = 'PDFTSA'.
          st_ssfparms-ssfformat = _format = 'RICHDOC'.
        ENDIF.
      WHEN OTHERS.
        is_active = abap_false.
    ENDCASE.






  ENDMETHOD.


  METHOD creacio_xml_pdf.

    DATA: lv_page          TYPE string,
          lv_string        TYPE string,
          lv_lv_xml        TYPE string,
          lv_web_hash      TYPE zgdg_web_hash,
          lv_xml_aux       TYPE string,
          lv_xml_nomcarrec TYPE string,
          lv_xml           TYPE string,
          lv_dni           TYPE prdni,
          lv_flen          TYPE i,
          lv_rotate(2)     TYPE c,
          lo_utility       TYPE REF TO cl_http_utility,
          img_firma        TYPE xstring,
          lv_doc_xml       TYPE zlog_global_clau-xml, "SPEC-67085
          img_firma_full   TYPE string.

    DATA: lt_param  TYPE zsap_tt_param_hc,
          ls_param  TYPE LINE OF zsap_tt_param_hc,
          lv_format TYPE ssfform.

    ">> SPEC-67085, Inici Modificació - ETODR
    IF go_log_global IS BOUND.
      go_log_global->crea_clau( EXPORTING iv_z_posicio_hash   = im_pos_hash
                                          iv_usuari           = sy-uname
                                IMPORTING es_log_clau         = DATA(ls_log_clau) ).

      go_log_global->afegir_entrada( EXPORTING  iv_tasca = zglog_tasca_inicial
                                                is_clau  = ls_log_clau
                                     EXCEPTIONS OTHERS   = 0 ).
    ENDIF.
    "<< SPEC-67085, Final Modificació - ETODR

    IF _tipus = 'U' OR _tipus = 'F'."Generamos ssfbin con XML

      IF im_pos_hash IS INITIAL AND im_desatesa = abap_false.
        IF pos_signa-pagina = 0 OR _tipus NE 'F'.
          lv_page = me->get_page_from_pdf( i_data = ch_xstring ).
        ELSE.
          lv_page = pos_signa-pagina.
        ENDIF.
      ELSE.
        lv_page = pos_signa-pagina .
      ENDIF.

      " Conversió :  XSTRING a BASE64
      CREATE OBJECT lo_utility.
      CALL METHOD lo_utility->encode_x_base64
        EXPORTING
          unencoded = ch_xstring
        RECEIVING
          encoded   = lv_string.

      lv_rotate        = im_rotate.
      IF lv_rotate IS INITIAL.
        lv_rotate = 0.
      ENDIF.

      "INI SPEC-92704
      "Parametritzar el format, per quan falla la selladora de temps
      "Obtenim la demora parametritzada
      zcl_utils_parametritzacio=>get_dades_parametritzades(
       EXPORTING
         iv_repid            = 'GDG'
         iv_field_info       = 'FORMAT'
         iv_langu            = sy-langu
       IMPORTING
         et_zsap_dt_param_hc = lt_param ).

      READ TABLE lt_param INTO ls_param INDEX 1.
      IF sy-subrc = 0.
        lv_format = ls_param-value.
      ELSE.
        lv_format = 'PDFTSA'.
      ENDIF.

      "FI SPEC-92704

      lv_xml = '<?xml version="1.0"  encoding="UTF-8"?>'.
      CONCATENATE lv_xml '<GDGSIG>' INTO lv_xml.
      "INI SPEC-92704
*      CONCATENATE lv_xml '<FORMAT>PDFTSA</FORMAT>' INTO lv_xml.
      CONCATENATE lv_xml '<FORMAT>' lv_format '</FORMAT>' INTO lv_xml.
      "FI SPEC-92704
      CONCATENATE lv_xml '<DOC>' lv_string '</DOC>' INTO lv_xml.
      CONCATENATE lv_xml '<IMAGE>' INTO lv_xml.
      CONCATENATE lv_xml '<TYPE>JPG</TYPE>' INTO lv_xml.
      IF im_web_hash-orientacio = 'V'.
        IF ch_zgdg_pos_sign_bkp-imatge_v_buffer IS INITIAL.
          OPEN DATASET ch_zgdg_pos_sign_bkp-imatge_v FOR INPUT IN BINARY MODE.
          IF sy-subrc = 0.

            READ DATASET ch_zgdg_pos_sign_bkp-imatge_v INTO img_firma.

            CALL METHOD lo_utility->encode_x_base64
              EXPORTING
                unencoded = img_firma
              RECEIVING
                encoded   = img_firma_full.
            CLOSE DATASET pos_signa-imatge_v.
            ch_zgdg_pos_sign_bkp-imatge_v_buffer = img_firma_full.
            MODIFY zgdg_pos_signa FROM ch_zgdg_pos_sign_bkp.
          ENDIF.
        ELSE.
          img_firma_full = ch_zgdg_pos_sign_bkp-imatge_v_buffer.
        ENDIF.

      ELSE.
        IF ch_zgdg_pos_sign_bkp-imatge_buffer IS INITIAL.
          OPEN DATASET ch_zgdg_pos_sign_bkp-imatge FOR INPUT IN BINARY MODE.
          IF sy-subrc = 0.

            READ DATASET ch_zgdg_pos_sign_bkp-imatge INTO img_firma.

            CALL METHOD lo_utility->encode_x_base64
              EXPORTING
                unencoded = img_firma
              RECEIVING
                encoded   = img_firma_full.

            CLOSE DATASET pos_signa-imatge.
            ch_zgdg_pos_sign_bkp-imatge_buffer = img_firma_full.
            MODIFY zgdg_pos_signa FROM ch_zgdg_pos_sign_bkp.
          ENDIF.
        ELSE.
          img_firma_full = pos_signa-imatge_buffer.
        ENDIF.
      ENDIF.

      IF img_firma_full IS NOT INITIAL.
        CONCATENATE lv_xml '<RAW>' img_firma_full '</RAW>' INTO lv_xml.
      ELSE.
        CONCATENATE lv_xml '<RAW>'
'/9j/4AAQSkZJRgABAQEAYABgAAD/2wBDAAIBAQIBAQICAgICAgICAwUDAwMDAwYEBAMFBwYHBwcGBwc'
'ICQsJCAgKCAcHCg0KCgsMDAwMBwkODw0MDgsMDAz/2wBDAQICAgMDAwYDAwYMCAcIDAwMDAwMDAwMDAw'
'MDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAz/wAARCAABAAEDASIAAhEBAxEB/8QA'
'HwAAAQUBAQEBAQEAAAAAAAAAAAECAwQFBgcICQoL/8QAtRAAAgEDAwIEAwUFBAQAAAF9AQIDAAQRBRIhM'
'UEGE1FhByJxFDKBkaEII0KxwRVS0fAkM2JyggkKFhcYGRolJicoKSo0NTY3ODk6Q0RFRkdISUpTVFVWV1'
'hZWmNkZWZnaGlqc3R1dnd4eXqDhIWGh4iJipKTlJWWl5iZmqKjpKWmp6ipqrKztLW2t7i5usLDxMXGx8j'
'JytLT1NXW19jZ2uHi4+Tl5ufo6erx8vP09fb3+Pn6/8QAHwEAAwEBAQEBAQEBAQAAAAAAAAECAwQFBgcI'
'CQoL/8QAtREAAgECBAQDBAcFBAQAAQJ3AAECAxEEBSExBhJBUQdhcRMiMoEIFEKRobHBCSMzUvAVYnLRCh'
'YkNOEl8RcYGRomJygpKjU2Nzg5OkNERUZHSElKU1RVVldYWVpjZGVmZ2hpanN0dXZ3eHl6goOEhYaHiImK'
'kpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4uPk5ebn6Onq8vP09fb3+P'
'n6/9oADAMBAAIRAxEAPwD9/KKKKAP/2Q=='
'</RAW>' INTO lv_xml.
      ENDIF.

      CONCATENATE '<PAGE>' lv_page '</PAGE>' INTO lv_xml_aux.
      CONDENSE lv_xml_aux NO-GAPS.
      CONCATENATE lv_xml lv_xml_aux INTO lv_xml.
****************************************
********************************************

      CONCATENATE lv_xml '<POS>' pos_signa-x_pos ',' pos_signa-y_pos ','
               pos_signa-w_pos ',' pos_signa-h_pos '</POS>' INTO lv_xml.
      CONCATENATE lv_xml '<ROTATE>' lv_rotate '</ROTATE>' INTO lv_xml.

      lv_xml_nomcarrec = me->get_nom_carrec( im_web_hash ). "ADD SPEC-58393
      CONCATENATE  lv_xml lv_xml_nomcarrec INTO lv_xml.
      CONCATENATE lv_xml '<CODING>CP1252</CODING>' INTO lv_xml. "ADD SPEC-61247
      CONCATENATE lv_xml '</IMAGE>' INTO lv_xml.

      IF pos_signa-x_pos_csv IS NOT INITIAL. "Agregamos el CSV

        CONCATENATE lv_xml '<CSV><CSVTYPE>TEXT</CSVTYPE><IMAGETYPE/>' INTO lv_xml.
        CONCATENATE lv_xml '<VALUE>' 'Signat digitalment per:' '</VALUE>' INTO lv_xml.
        CONCATENATE '<PAGE>' lv_page '</PAGE>' INTO lv_xml_aux.
        CONDENSE lv_xml_aux NO-GAPS.
        CONCATENATE lv_xml lv_xml_aux INTO lv_xml.
        CONCATENATE lv_xml '<POS>' pos_signa-x_pos_csv ',' pos_signa-y_pos_csv ','
             pos_signa-w_pos_csv ',' pos_signa-h_pos_csv '</POS>' INTO lv_xml.
        CONCATENATE lv_xml '<ROTATE>' lv_rotate ' </ROTATE>' INTO lv_xml.

        CONCATENATE lv_xml '</CSV>' INTO lv_xml.
      ENDIF.


      "*******************************************************************
      "Si hem de Validar el DNI que entra per paràmetre, construïm el node
      "*******************************************************************
      IF im_validate_dni EQ abap_true.

        "Obtenim el dni del signatari per comprobar a l'XML del PDF
        get_dni_from_user(
          EXPORTING
            iv_usuari    = sy-uname
          IMPORTING
            ev_dni       =  lv_dni   " Número Identificació Fiscal
          EXCEPTIONS
            zgdg_dni     = 1
            zno_employee = 2
            OTHERS       = 3
        ).
        IF sy-subrc <> 0.
          ">> SPEC-67085, Inici Modificació - ETODR
          IF go_log_global IS BOUND.
            go_log_global->afegir_entrada( EXPORTING  iv_tasca    = zglog_tasca_val_dni
                                                      iv_resultat = zglog_resultat_ko
                                                      is_clau     = ls_log_clau
                                           EXCEPTIONS OTHERS      = 0 ).
          ENDIF.
          "<< SPEC-67085, Final Modificació - ETODR
          "Per qualsevol error raise d'aquest que es captura per sobre
          RAISE zgdg_dni.
        ELSE.
          ">> SPEC-67085, Inici Modificació - ETODR
          IF go_log_global IS BOUND.
            go_log_global->afegir_entrada( EXPORTING  iv_tasca    = zglog_tasca_val_dni
                                                      iv_resultat = zglog_resultat_ok
                                                      is_clau     = ls_log_clau
                                           EXCEPTIONS OTHERS      = 0 ).
          ENDIF.
          "<< SPEC-67085, Final Modificació - ETODR
          "Si tot és correcte, afegim el node
          CONCATENATE lv_xml '<DNI>' INTO lv_xml.
          CONCATENATE lv_xml lv_dni INTO lv_xml.
          CONCATENATE lv_xml '</DNI>' INTO lv_xml.
        ENDIF.

      ENDIF.
      "*******************************************************************
      CONCATENATE lv_xml '<GDGNODATE>0</GDGNODATE>' INTO lv_xml. "ADD SPEC-65478
      CONCATENATE lv_xml '</GDGSIG>' INTO lv_xml.

      CALL FUNCTION 'SCMS_STRING_TO_XSTRING'
        EXPORTING
          text   = lv_xml
        IMPORTING
          buffer = ch_xstring.


      CALL FUNCTION 'SCMS_XSTRING_TO_BINARY'
        EXPORTING
          buffer        = ch_xstring
        IMPORTING
          output_length = lv_flen
        TABLES
          binary_tab    = ex_ssfbin.
      ex_long = lv_flen.

    ELSE. "Generamos ssfbin con el PDF
      CALL METHOD cl_rmps_general_functions=>convert_1022_to_255
        EXPORTING
          im_tab_1022 = im_bin_content
          im_len      = im_fs-comp_size
        RECEIVING
          re_tab_255  = ex_ssfbin.

      ex_long = im_fs-comp_size.
    ENDIF.
    ">> SPEC-67085, Inici Modificació - ETODR
    IF go_log_global IS BOUND.
      CLEAR: lv_doc_xml.
      lv_doc_xml = ch_xstring.
      IF lv_doc_xml IS NOT INITIAL.
        go_log_global->crea_clau( EXPORTING iv_z_posicio_hash   = im_pos_hash
                                            iv_xml              = lv_doc_xml
                                  IMPORTING es_log_clau         = ls_log_clau ).
      ENDIF.
      go_log_global->afegir_entrada( EXPORTING  iv_tasca    = zglog_tasca_final
                                                iv_resultat = zglog_resultat_ok
                                                is_clau     = ls_log_clau
                                     EXCEPTIONS OTHERS      = 0 ).
    ENDIF.
    "<< SPEC-67085, Final Modificació - ETODR
  ENDMETHOD.


  METHOD create_xml.

    DATA: lv_string  TYPE string,
          lv_date    TYPE string,
          lv_time    TYPE string,
          "variables a definir
          lv_format  TYPE char10,    "<FORMAT>PADES</FORMAT>
          lv_font    TYPE char2,     "<FONT>12</FONT>
          lv_l1      TYPE char10,    "<L1>Texto en cualquier linea hasta patrones: $CA</L1>
          lv_l2      TYPE char10,    "<L2>Texto previo a  firmado por: $CN</L2>
          lv_l3      TYPE sy-datum,  "<L3>Texto opcional a Fecha $DATE</L3>
          lv_l4      TYPE char10,    "<L4>Texto de la huella  $HLL</L4>
          lv_type    TYPE char3,     "<TYPE>PNG</TYPE> <TYPE>JPG</TYPE>
          lv_raw     TYPE string,    "<RAW>iVBORw*</RAW>
          lv_page    TYPE char2,     "<PAGE>6</PAGE>  <PAGES>0</PAGES>
          lv_pos     TYPE char20,    "<POS>10,15,285,42</POS>
          lv_rotate  TYPE char3,     "<ROTATE>0</ROTATE>
          lv_csvtype TYPE char10,    "<CSVTYPE>TEXT</CSVTYPE>
          lv_value   TYPE string,    "<VALUE>Código Seguro de Verificación  MFPhX* </VALUE>
          lv_trans   TYPE char2.     "<TRANS>50</TRANS>

    FIELD-SYMBOLS:<firma_docs> LIKE LINE OF firma_docs.

  " NUEVO XML

    "<?xml version="1.0"  encoding="utf-8"?>
    xml = '<?xml version="1.0"  encoding="UTF-8"?>'.

    "<GDGSIG>
    CONCATENATE xml '<GDGSIG>' INTO xml.

    "<FORMAT>PADES</FORMAT>
    CONCATENATE xml '<FORMAT>' _FORMAT '</FORMAT>' INTO xml.

    LOOP AT firma_docs ASSIGNING <firma_docs>.
      "<DOC> * </DOC>
      CONCATENATE xml '<DOC>' <firma_docs>-z_bin_content '</DOC>' INTO xml.
      CLEAR: lv_string.
    ENDLOOP.

*    "<TEXTBOX>
*    CONCATENATE xml '<TEXTBOX>' INTO xml.
*
*    "<FONT>12</FONT>
*    CONCATENATE xml '<FONT>' lv_font '</FONT>' INTO xml.
*
*    "<DATE>yyyy-MM-dd HH:mm:ss</DATE>
*    CONCATENATE sy-datum(4) '-' sy-datum+4(2) '-' sy-datum+6(2) INTO lv_date.
*    CONCATENATE sy-uzeit(2) ':' sy-uzeit+2(2) ':' sy-uzeit+4(2) INTO lv_time.
*    CONCATENATE lv_date lv_time INTO lv_date SEPARATED BY space.
*    CONCATENATE xml '<DATE>' lv_date '</DATE>' INTO xml.
*
*    "<L1>Texto en cualquier linea hasta patrones: $CA</L1>
*    CONCATENATE xml '<L1>Texto en cualquier linea hasta patrones:' lv_l1 '</L1>' INTO xml.
*
*    "<L2>Texto previo a  firmado por: $CN</L2>
*    CONCATENATE xml '<L2>Texto previo a  firmado por:' lv_l2 '</L2>' INTO xml.
*
*    "<L3>Texto opcional a Fecha $DATE</L3>
*    CONCATENATE xml '<L3>Texto opcional a Fecha' lv_l3 '</L3>' INTO xml.
*
*    "<L4>Texto de la huella  $HLL</L4>
*    CONCATENATE xml '<L4>Texto de la huella' lv_l4 '</L4>' INTO xml.
*
*    "</TEXTBOX>
*    CONCATENATE xml '</TEXTBOX>' INTO xml.

    "<IMAGE>
    CONCATENATE xml '<IMAGE>' INTO xml.
    CONCATENATE xml '<TYPE>JPG</TYPE>' INTO xml.
    CONCATENATE xml '<RAW>'
    '/9j/4AAQSkZJRgABAQEAYABgAAD/2wBDAAIBAQIBAQICAgICAgICAwUDAwMDAwYEBAMFBwYHBwcGBwc'
    'ICQsJCAgKCAcHCg0KCgsMDAwMBwkODw0MDgsMDAz/2wBDAQICAgMDAwYDAwYMCAcIDAwMDAwMDAwMDAw'
    'MDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAz/wAARCAABAAEDASIAAhEBAxEB/8QA'
    'HwAAAQUBAQEBAQEAAAAAAAAAAAECAwQFBgcICQoL/8QAtRAAAgEDAwIEAwUFBAQAAAF9AQIDAAQRBRIhM'
    'UEGE1FhByJxFDKBkaEII0KxwRVS0fAkM2JyggkKFhcYGRolJicoKSo0NTY3ODk6Q0RFRkdISUpTVFVWV1'
    'hZWmNkZWZnaGlqc3R1dnd4eXqDhIWGh4iJipKTlJWWl5iZmqKjpKWmp6ipqrKztLW2t7i5usLDxMXGx8j'
    'JytLT1NXW19jZ2uHi4+Tl5ufo6erx8vP09fb3+Pn6/8QAHwEAAwEBAQEBAQEBAQAAAAAAAAECAwQFBgcI'
    'CQoL/8QAtREAAgECBAQDBAcFBAQAAQJ3AAECAxEEBSExBhJBUQdhcRMiMoEIFEKRobHBCSMzUvAVYnLRCh'
    'YkNOEl8RcYGRomJygpKjU2Nzg5OkNERUZHSElKU1RVVldYWVpjZGVmZ2hpanN0dXZ3eHl6goOEhYaHiImK'
    'kpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4uPk5ebn6Onq8vP09fb3+P'
    'n6/9oADAMBAAIRAxEAPwD9/KKKKAP/2Q=='
    '</RAW>' INTO xml.

    CONCATENATE xml '<PAGE>1</PAGE>' INTO xml.
    CONCATENATE xml '<POS>10,15,257,40</POS>' INTO xml.
    CONCATENATE xml '<ROTATE>0</ROTATE>' INTO xml.
    CONCATENATE xml '<CODING>CP1252</CODING>' INTO xml. "ADD SPEC-61247
    CONCATENATE xml '</IMAGE>' INTO xml.
*
*    "<CSV>
*    CONCATENATE xml '<CSV>' INTO xml.
*
*    "<CSVTYPE>TEXT</CSVTYPE>
*    CONCATENATE xml '<CSVTYPE>' lv_csvtype '</CSVTYPE>' INTO xml.
*
*    "<IMAGETYPE/>
*    CONCATENATE xml '<IMAGETYPE/>' INTO xml.
*
*    "<VALUE>Código Seguro de Verificación </VALUE>
*    CONCATENATE xml '<VALUE>' lv_value '</VALUE>' INTO xml.
*
*    "<PAGES>2</PAGES>
*    CONCATENATE xml '<PAGES>' lv_page '</PAGES>' INTO xml.
*
*    "<POS>0,5,40,80</POS>
*    CONCATENATE xml '<POS>' lv_pos '</POS>' INTO xml.
*
*    "<ROTATE>180</ROTATE>
*    CONCATENATE xml '<ROTATE>' lv_rotate '</ROTATE>' INTO xml.
*
*    "</CSV>
*    CONCATENATE xml '</CSV>' INTO xml.
*
*    "<WATERMARK>
*    CONCATENATE xml '<WATERMARK>' INTO xml.
*
*    "<TYPE>JPG</TYPE>
*    CONCATENATE xml '<TYPE>' lv_type '</TYPE>' INTO xml.
*
*    "<VALUE> * </VALUE >
*    CONCATENATE xml '<VALUE>' lv_value '</VALUE >' INTO xml.
*
*    "<PAGES>0</PAGES>
*    CONCATENATE xml '<PAGES>' lv_page '</PAGES>' INTO xml.
*
*    "<TRANS>50</TRANS>
*    CONCATENATE xml '<TRANS>' lv_trans '</TRANS>' INTO xml.
*
*    "<POS>120,150,432,410</POS>
*    CONCATENATE xml '<POS>' lv_pos '</POS>' INTO xml.
*
*    "<ROTATE>300</ROTATE>
*    CONCATENATE xml '<ROTATE>' lv_rotate '</ROTATE>' INTO xml.
*
*    "</WATERMARK>
*    CONCATENATE xml '</WATERMARK>' INTO xml.

    "</GDGSIG>
    CONCATENATE xml '</GDGSIG>' INTO xml.


*    "<?xml version="1.0"  encoding="utf-8"?>
*    xml = '<?xml version="1.0"  encoding="utf-8"?>'.
*
*    "<GDGSIG>
*    CONCATENATE xml '<GDGSIG>' INTO xml.
*
*    "<FORMAT>PADES</FORMAT>
*    CONCATENATE xml '<FORMAT>' lv_format '</FORMAT>' INTO xml.
*
*    LOOP AT firma_docs ASSIGNING <firma_docs>.
*      "<DOC> * </DOC>
*      CONCATENATE xml '<DOC>' <firma_docs>-z_bin_content '</DOC>' INTO xml.
*      CLEAR: lv_string.
*    ENDLOOP.
*
*    "<TEXTBOX>
*    CONCATENATE xml '<TEXTBOX>' INTO xml.
*
*    "<FONT>12</FONT>
*    CONCATENATE xml '<FONT>' lv_font '</FONT>' INTO xml.
*
*    "<DATE>yyyy-MM-dd HH:mm:ss</DATE>
*    CONCATENATE sy-datum(4) '-' sy-datum+4(2) '-' sy-datum+6(2) INTO lv_date.
*    CONCATENATE sy-uzeit(2) ':' sy-uzeit+2(2) ':' sy-uzeit+4(2) INTO lv_time.
*    CONCATENATE lv_date lv_time INTO lv_date SEPARATED BY space.
*    CONCATENATE xml '<DATE>' lv_date '</DATE>' INTO xml.
*
*    "<L1>Texto en cualquier linea hasta patrones: $CA</L1>
*    CONCATENATE xml '<L1>Texto en cualquier linea hasta patrones:' lv_l1 '</L1>' INTO xml.
*
*    "<L2>Texto previo a  firmado por: $CN</L2>
*    CONCATENATE xml '<L2>Texto previo a  firmado por:' lv_l2 '</L2>' INTO xml.
*
*    "<L3>Texto opcional a Fecha $DATE</L3>
*    CONCATENATE xml '<L3>Texto opcional a Fecha' lv_l3 '</L3>' INTO xml.
*
*    "<L4>Texto de la huella  $HLL</L4>
*    CONCATENATE xml '<L4>Texto de la huella' lv_l4 '</L4>' INTO xml.
*
*    "</TEXTBOX>
*    CONCATENATE xml '</TEXTBOX>' INTO xml.
*
*    "<IMAGE>
*    CONCATENATE xml '<IMAGE>' INTO xml.
*
*    "<TYPE>PNG</TYPE>
*    CONCATENATE xml '<TYPE>' lv_type '</TYPE>' INTO xml.
*
*    "<RAW> * </RAW>
*    CONCATENATE xml '<RAW>' lv_raw '</RAW>' INTO xml.
*
*    "<PAGE>6</PAGE>
*    CONCATENATE xml '<PAGE>' lv_page '</PAGE>' INTO xml.
*
*    "<POS>10,15,285,42</POS>
*    CONCATENATE xml '<POS>' lv_pos '</POS>' INTO xml.
*
*    "<ROTATE>0</ROTATE>
*    CONCATENATE xml '<ROTATE>' lv_rotate '</ROTATE>' INTO xml.
*
*    "</IMAGE>
*    CONCATENATE xml '</IMAGE>' INTO xml.
*
*    "<CSV>
*    CONCATENATE xml '<CSV>' INTO xml.
*
*    "<CSVTYPE>TEXT</CSVTYPE>
*    CONCATENATE xml '<CSVTYPE>' lv_csvtype '</CSVTYPE>' INTO xml.
*
*    "<IMAGETYPE/>
*    CONCATENATE xml '<IMAGETYPE/>' INTO xml.
*
*    "<VALUE>Código Seguro de Verificación </VALUE>
*    CONCATENATE xml '<VALUE>' lv_value '</VALUE>' INTO xml.
*
*    "<PAGES>2</PAGES>
*    CONCATENATE xml '<PAGES>' lv_page '</PAGES>' INTO xml.
*
*    "<POS>0,5,40,80</POS>
*    CONCATENATE xml '<POS>' lv_pos '</POS>' INTO xml.
*
*    "<ROTATE>180</ROTATE>
*    CONCATENATE xml '<ROTATE>' lv_rotate '</ROTATE>' INTO xml.
*
*    "</CSV>
*    CONCATENATE xml '</CSV>' INTO xml.
*
*    "<WATERMARK>
*    CONCATENATE xml '<WATERMARK>' INTO xml.
*
*    "<TYPE>JPG</TYPE>
*    CONCATENATE xml '<TYPE>' lv_type '</TYPE>' INTO xml.
*
*    "<VALUE> * </VALUE >
*    CONCATENATE xml '<VALUE>' lv_value '</VALUE >' INTO xml.
*
*    "<PAGES>0</PAGES>
*    CONCATENATE xml '<PAGES>' lv_page '</PAGES>' INTO xml.
*
*    "<TRANS>50</TRANS>
*    CONCATENATE xml '<TRANS>' lv_trans '</TRANS>' INTO xml.
*
*    "<POS>120,150,432,410</POS>
*    CONCATENATE xml '<POS>' lv_pos '</POS>' INTO xml.
*
*    "<ROTATE>300</ROTATE>
*    CONCATENATE xml '<ROTATE>' lv_rotate '</ROTATE>' INTO xml.
*
*    "</WATERMARK>
*    CONCATENATE xml '</WATERMARK>' INTO xml.
*
*    "</GDGSIG>
*    CONCATENATE xml '</GDGSIG>' INTO xml.

  ENDMETHOD.


  METHOD enviar_correu_demora.
* Creat per .............: ECDRB
* Data de creació ..: 03.06.2020
* Descripció ..........: Quan es produeix una demora, enviar correu a la DSI i
* al CAU, quan s'inicia la demora i quan es repara la demora
* SPEC relacionat..: SPEC-59184
    CONSTANTS: lc_repid               TYPE repid VALUE 'SSFSIGN',
               lc_correu_inici_demora TYPE text30 VALUE 'INICI_DEMORA',
               lc_correu_fi_demora    TYPE text30 VALUE 'FI_DEMORA'.

    DATA: lt_packing_list    TYPE sopcklsti1_t,
          ls_packing_list    TYPE sopcklsti1,
          lv_entries         TYPE sy-tabix,
          lt_reclist         TYPE somlreci1_t,
          ls_reclist         TYPE somlreci1,
          lt_objcont         TYPE TABLE OF solisti1,
          ls_objcont         TYPE solisti1,
          ls_doc_chng        TYPE sodocchgi1,
          lv_subj            TYPE string,
          lv_value           TYPE zsap_de_value,
          lv_value2          TYPE zsap_de_value,
          lv_value3          TYPE zsap_de_value,
          lv_value4          TYPE zsap_de_value,
          ls_demores         TYPE zsap_dt_param_hc,
          lt_demores         TYPE TABLE OF zsap_dt_param_hc,
          lv_att             TYPE so_text255,
          lv_data_demora     TYPE char10,
          lv_hora_demora(8)  TYPE c,
          lv_hora_reparat(8) TYPE c,
          lv_user_data       TYPE soudatai1,
          lv_user            TYPE soudnamei1,
          lv_fullname        TYPE so_adrnam,
          lv_text_temps      TYPE so_text255.

    "Obtenim tots els parámetres de les demores
    "Obtenim els textos de la demora
    zcl_utils_parametritzacio=>get_dades_parametritzades(
      EXPORTING
        iv_repid            = lc_repid
        iv_langu            = sy-langu
      IMPORTING
        et_zsap_dt_param_hc = lt_demores
    ).

**** Destinataris
    "Destinataris es el field_info = 'SSFDEMORA_MAIL_TO'
    READ TABLE lt_demores INTO ls_demores
    WITH KEY field_info = 'SSFDEMORA_MAIL_TO'.

    lv_value  = ls_demores-value.
    lv_value2 = ls_demores-value2.
    lv_value3 = ls_demores-value3.
    lv_value4 = ls_demores-value4.

    IF lv_value IS NOT INITIAL.
      ls_reclist-rec_type   = 'U'.
      ls_reclist-receiver   = lv_value.
      ls_reclist-com_type   = 'INT'.
      ls_reclist-notif_del  = 'X'.
      ls_reclist-notif_ndel = 'X'.
      APPEND ls_reclist TO lt_reclist .
    ENDIF.

    IF lv_value2 IS NOT INITIAL.
      ls_reclist-rec_type   = 'U'.
      ls_reclist-receiver   = lv_value2.
      ls_reclist-com_type   = 'INT'.
      ls_reclist-notif_del  = 'X'.
      ls_reclist-notif_ndel = 'X'.
      APPEND ls_reclist TO lt_reclist .
    ENDIF.

    IF lv_value3 IS NOT INITIAL.
      ls_reclist-rec_type   = 'U'.
      ls_reclist-receiver   = lv_value3.
      ls_reclist-com_type   = 'INT'.
      ls_reclist-notif_del  = 'X'.
      ls_reclist-notif_ndel = 'X'.
      APPEND ls_reclist TO lt_reclist .
    ENDIF.

    IF lv_value4 IS NOT INITIAL.
      ls_reclist-rec_type   = 'U'.
      ls_reclist-receiver   = lv_value4.
      ls_reclist-com_type   = 'INT'.
      ls_reclist-notif_del  = 'X'.
      ls_reclist-notif_ndel = 'X'.
      APPEND ls_reclist TO lt_reclist .
    ENDIF.

    CLEAR ls_demores.

**** ASSUMPTE DEL MISSATGE ****
***** Contingut del missatge *****

    ls_objcont-line = ' '.
    APPEND ls_objcont TO lt_objcont.

    IF iv_tipus_correu EQ lc_correu_inici_demora.

      "Recuperar text assumpte
      READ TABLE lt_demores INTO ls_demores
      WITH KEY field_info = 'SSFDEMORA_TXT2_MAIL'.

      lv_subj = ls_demores-value.

      "S'ha produït una primera demora:
      CLEAR ls_demores.
      "Recuperar text inici correu
      READ TABLE lt_demores INTO ls_demores
      WITH KEY field_info = 'SSFDEMORA_MAIL_TEXT_INICI'.
      CONCATENATE ls_demores-value ls_demores-value2
            INTO ls_objcont-line SEPARATED BY space RESPECTING BLANKS.
      APPEND ls_objcont TO lt_objcont.



      "Text correu electrònic
      "Recuperar text dades demora (data/hora inici/temps consumit)
      CLEAR ls_demores.
      READ TABLE lt_demores INTO ls_demores
      WITH KEY field_info = 'SSFDEMORA_TXT2_MAIL'.

      CALL FUNCTION 'CONVERT_DATE_TO_EXTERNAL'
        EXPORTING
          date_internal = is_data-zgdg_data_demora
        IMPORTING
          date_external = lv_data_demora.

      CONCATENATE ls_demores-value2 '' lv_data_demora
            INTO ls_objcont-line SEPARATED BY space.

      APPEND ls_objcont TO lt_objcont.

      CONCATENATE is_data-zgdg_hora_demora(2) is_data-zgdg_hora_demora+2(2)
      is_data-zgdg_hora_demora+4(2) INTO lv_hora_demora SEPARATED BY ':'.

      CONCATENATE ls_demores-value3 '' lv_hora_demora
      INTO ls_objcont-line SEPARATED BY space.
      APPEND ls_objcont TO lt_objcont.

      CONCATENATE ls_demores-value4 '' iv_temps_demora
      INTO ls_objcont-line SEPARATED BY space.

      CLEAR ls_demores.
      READ TABLE lt_demores INTO ls_demores
      WITH KEY field_info = 'SSFDEMORA_TXT3_MAIL'.

      lv_text_temps = ls_objcont-line.

      CONCATENATE  lv_text_temps '' ls_demores-value
      INTO ls_objcont-line SEPARATED BY space.
      APPEND ls_objcont TO lt_objcont.

      "Recuperar text dades demora (usuari que ha tingut la demora)
      CLEAR ls_demores.
      READ TABLE lt_demores INTO ls_demores
      WITH KEY field_info = 'SSFDEMORA_TXT3_MAIL'.

      "Obtenir nom usuari a partir del user sap
      lv_user-sapname = is_data-zgdg_usuari.
      CALL FUNCTION 'SO_USER_READ_API1'
        EXPORTING
          user            = lv_user
        IMPORTING
          user_data       = lv_user_data
        EXCEPTIONS
          user_not_exist  = 1
          parameter_error = 2
          x_error         = 3
          OTHERS          = 4.

      lv_fullname = lv_user_data-fullname.

      CONCATENATE ls_demores-value2 ls_demores-value3 ''
      lv_fullname
      INTO ls_objcont-line SEPARATED BY space.
      APPEND ls_objcont TO lt_objcont.

      lv_att = ls_demores-value4.

    ENDIF.

    IF iv_tipus_correu EQ lc_correu_fi_demora.


      "Recuperar text fi demora
      CLEAR ls_demores.
      READ TABLE lt_demores INTO ls_demores
      WITH KEY field_info = 'SSFDEMORA_MAIL_TEXT_FI'.

      lv_subj = ls_demores-value4.

      CALL FUNCTION 'CONVERT_DATE_TO_EXTERNAL'
        EXPORTING
          date_internal = is_data-zgdg_data_demora
        IMPORTING
          date_external = lv_data_demora.

      CONCATENATE is_data-zgdg_inici_demora(2) is_data-zgdg_inici_demora+2(2)
      is_data-zgdg_inici_demora+4(2) INTO lv_hora_demora SEPARATED BY ':'.


      CONCATENATE is_data-zgdg_hora_reparat(2) is_data-zgdg_hora_reparat+2(2)
      is_data-zgdg_hora_reparat+4(2) INTO lv_hora_reparat SEPARATED BY ':'.

      CONCATENATE ls_demores-value lv_data_demora ls_demores-value2
            lv_hora_demora  ls_demores-value3
            lv_hora_reparat
            INTO ls_objcont-line SEPARATED BY space. " RESPECTING BLANKS.
      APPEND ls_objcont TO lt_objcont.

      CLEAR ls_demores.
      READ TABLE lt_demores INTO ls_demores
      WITH KEY field_info = 'SSFDEMORA_TXT3_MAIL'.

      lv_att = ls_demores-value4.

    ENDIF.

    ls_doc_chng-obj_name    = 'URGENT'.
    ls_doc_chng-obj_descr   = lv_subj.  "Assumpte del missatge
    ls_doc_chng-sensitivty  = '='.     "Estandar


    ls_objcont-line = ' '.
    APPEND ls_objcont TO lt_objcont.

    ls_objcont-line = lv_att.
    APPEND ls_objcont TO lt_objcont.

*************************************
**--------ENVIA EL MISSATGE--------**
*************************************
*Calcular el tamany del missatge
    DESCRIBE TABLE lt_objcont LINES lv_entries.
    READ TABLE lt_objcont INDEX lv_entries INTO ls_objcont.
    ls_doc_chng-doc_size = ( lv_entries - 1 ) * 255 + strlen( ls_objcont ).

*Preparar el body del missatge
    CLEAR ls_packing_list.
    REFRESH lt_packing_list.
    DESCRIBE TABLE lt_objcont LINES ls_packing_list-body_num.
    ls_packing_list-transf_bin = space.
    ls_packing_list-head_start = 1.
    ls_packing_list-head_num   = 0.
    ls_packing_list-body_start = 1.
    ls_packing_list-doc_type   = 'RAW'.
    APPEND ls_packing_list TO lt_packing_list.


    "Cridar a funció que fa l'enviament de correu
    CALL FUNCTION 'ZSO_NEW_DOCUMENT_ATT_SEND_API1'
      EXPORTING
        document_data              = ls_doc_chng
        put_in_outbox              = abap_off
        sender_address             = zsubc_sender
        sender_address_type        = zsubc_setype
        commit_work                = abap_on
      TABLES
        packing_list               = lt_packing_list
        contents_txt               = lt_objcont
        receivers                  = lt_reclist
      EXCEPTIONS
        too_many_receivers         = 1
        document_not_sent          = 2
        document_type_not_exist    = 3
        operation_no_authorization = 4
        parameter_error            = 5
        x_error                    = 6
        enqueue_error              = 7
        OTHERS                     = 8.

    rv_rc = sy-subrc.

  ENDMETHOD.


  METHOD firma_doc_cs.

* ">>>SPEC:59184, Inici modificació  -  ECTRP
    CONSTANTS: lc_repid          TYPE repid VALUE 'SSFSIGN',
               lc_field_info     TYPE zsap_de_field VALUE 'SSFDEMORA',
               lc_field_info_txt TYPE zsap_de_field VALUE 'SSFDEMORA_TXT',
               lc_accio_alta     TYPE abap_bool VALUE 'I',
               lc_accio_actu     TYPE abap_bool VALUE 'U',
               lc_accio_hash     TYPE char1     VALUE 'C'.
* ">>>SPEC:59184, Final modificació  -  ECTRP

    DATA: lv_text                TYPE string,
          lv_text2               TYPE string,
          lv_text_popup          TYPE string,
          l_web_hash             TYPE zgdg_web_hash,
          l_y_pos                TYPE p LENGTH 16 DECIMALS 2,
          l_x_pos                TYPE p LENGTH 16 DECIMALS 2,
          lt_components          TYPE TABLE OF bapidoccomp,
          lt_bin_content         TYPE TABLE OF bapiconten,
          l_rotate(2)            TYPE c,
          l_long                 TYPE i,
          ssfbin                 TYPE rmps_ssfbin,
          l_zgdg_docs            TYPE zgdg_docs,
          l_page                 TYPE string,
          l_zgdg_pos_signa_bkp   TYPE zgdg_pos_signa,
          img_firma              TYPE xstring,
          img_firma_full         TYPE string,
          utility                TYPE REF TO cl_http_utility,
          l_string               TYPE string,
          c_xstring              TYPE xstring,
          flen                   TYPE i,
          xtab                   TYPE solix_tab,
          lv_dni                 TYPE prdni,
          lv_flag                TYPE flag,
          lv_usuari_sig          TYPE zusuari_sig ,     " char12
          lv_motiu_rebuig        TYPE z_motiu_rebuig,
          lv_entorn              TYPE char3,
          lv_usuari_w            TYPE uname,
          lv_cod_exp_s           TYPE string,
          lv_desatesa            TYPE abap_bool,
          ls_side                TYPE zdocs_signa_des,
          lv_result              TYPE abap_bool,
          lv_data                TYPE zgdg_demora_ssf,
          lv_rc                  TYPE sysubrc,
          lv_hora_inici          TYPE sy-uzeit,
          lv_hora_final          TYPE sy-uzeit,
          lv_value               TYPE zsap_de_value,
          lv_segons_param        TYPE num03,
          lv_segons_syst         TYPE num03,
          lv_accio               TYPE abap_bool,
          lt_demores             TYPE zsap_tt_param_hc,
          ls_demores             TYPE LINE OF zsap_tt_param_hc,
          gv_popup_demora_showed TYPE xfeld,
          ls_pos_signa_aux       LIKE pos_signa,
          lv_maquina             TYPE z_maquina_remote,
          lv_result_hashback     TYPE xflag,
          lv_message_hb          TYPE char255,
          lv_factor              TYPE p LENGTH 4 DECIMALS 2,
          xml                    TYPE string,
          l_xml_nomcarrec        TYPE string,
          c_string               TYPE string,
          xml_aux                TYPE string,
          lv_sysubrc_firma       TYPE sy-subrc, "ETODR SPEC-67085
          lv_resultat_log        TYPE zlog_global-resultat, "ETODR SPEC-67085
*<<<SPEC:66792, Final modificació - ECMLS
          lv_iso_ok              TYPE abap_bool,
*>>>SPEC:66792, Inici modificació - ECMLS
          lt_bin_content_log     TYPE TABLE OF bapiconten.

    FIELD-SYMBOLS <fs>    TYPE  bapidoccomp.

    gv_docclass = z_classid.
    gv_objectid = z_docid.

    ">> SPEC-67085, Inici Modificació - ETODR
    CLEAR: lv_sysubrc_firma.
    IF go_log_global IS BOUND.
      go_log_global->crea_clau( EXPORTING iv_docclass       = z_classid
                                          iv_objectid       = z_docid
                                          iv_pos            = pos
                                          iv_usuari         = sy-uname
                                          iv_z_posicio_hash = pos_hash
                                          iv_gdg_anchor     = gdg_anchor
                                IMPORTING es_log_clau       = DATA(ls_log_clau) ).
      go_log_global->afegir_entrada( EXPORTING  iv_tasca = zglog_tasca_inicial
                                                is_clau  = ls_log_clau
                                     EXCEPTIONS OTHERS   = 0 ).
    ENDIF.
    "<< SPEC-67085, Final Modificació - ETODR

    "¿Él usuario es válido?
    IF is_active IS INITIAL  AND _tipus <> 'C'.
      RAISE zgdg_user_not_found.
    ENDIF.

*   Es valida que el document s'ha enviat a signar, es recupera
*   la posició de signar i comprovem que la persona hagi punxat a la pàgina
    CALL METHOD me->valid_seleccions_previ_firma
      EXPORTING
        im_classid            = z_classid
        im_docid              = z_docid
        im_pos                = pos
        im_pos_hash           = pos_hash
      IMPORTING
        ex_zgdg_docs          = l_zgdg_docs
      CHANGING
        ch_zgdg_pos_signa_bkp = l_zgdg_pos_signa_bkp
        ch_web_hash           = l_web_hash
      EXCEPTIONS
        user_not_active       = 1
        zgdg_doc_not_found    = 2
        OTHERS                = 3.

    "Recuperamos el documento
    CALL FUNCTION 'SRM_DOCUMENT_CHECKOUT_VIA_TAB'
      EXPORTING
        objectid        = z_docid
        documentclass   = z_classid
      TABLES
        components      = lt_components
        bin_content     = lt_bin_content
      EXCEPTIONS
        internal_error  = 1
        parameter_error = 2
        not_authorized  = 3
        doc_not_found   = 4
        OTHERS          = 5.

    IF sy-subrc <> 0.
      rc = abap_false.
      RAISE zgdg_doc_not_found.
      EXIT.
    ENDIF.

    READ TABLE lt_components ASSIGNING <fs> INDEX 1.

    "INI SPEC-90904
    """GUARDAR DOCUMENT EN SERVIDOR _INICI 1.
    lt_bin_content_log = lt_bin_content.
    CALL METHOD me->guardar_fitxer_log_servidor
      EXPORTING
        z_docid    = z_docid
        z_classid  = z_classid
        z_accio    = '1'
        z_binari   = lt_bin_content_log
        z_size     = <fs>-comp_size
        z_extensio = '.pdf'.
    "FI SPEC-90904


    CALL METHOD cl_rmps_general_functions=>convert_1022_to_255
      EXPORTING
        im_tab_1022 = lt_bin_content
      RECEIVING
        re_tab_255  = xtab.

    CALL FUNCTION 'SCMS_BINARY_TO_XSTRING'
      EXPORTING
        input_length = <fs>-comp_size
      IMPORTING
        buffer       = c_xstring
      TABLES
        binary_tab   = xtab
      EXCEPTIONS
        failed       = 1
        OTHERS       = 2.

    ">> SPEC-67085, Inici Modificació - ETODR
    IF go_log_global IS BOUND.
      go_log_global->afegir_entrada( EXPORTING iv_tasca = zglog_tasca_ini_get_posicio
                                               is_clau  = ls_log_clau
                                    EXCEPTIONS OTHERS   = 0 ).
    ENDIF.
    "<< SPEC-67085, Final Modificació - ETODR

    ">>>SPEC:64532, Inici modificació  -  ECJSA
    "Hem detecatat que tot i que la graella genera correctament
    "el document PDF amb les caxxes, hi ha cops que en la taula
    "de hash, es perd alguna posició.
    "Al generar el PDF, ens guardem les posicions també i si al propocessar
    "la signatura ens falta alguna posició, la recuperem d'aquesta taula auxiliar.
    "-----------------------------------------------------------------------------
    IF l_web_hash IS INITIAL.
      CALL FUNCTION 'ZGDG_BACKUP_POS'
        EXPORTING
          pos         = l_zgdg_docs-pos
          actividad   = lc_accio_hash
          docclass    = l_zgdg_docs-docclass
          objectid    = l_zgdg_docs-objectid
          version     = l_zgdg_docs-version
        IMPORTING
          result      = lv_result_hashback
          message     = lv_message_hb
          es_web_hash = l_web_hash.

      "Si hem trobat la posició, l'afegim a la taula original
      IF l_web_hash IS NOT INITIAL.
        MODIFY zgdg_web_hash FROM l_web_hash.
      ENDIF.
    ENDIF.
    "<<<SPEC:64532, Final modificació -  ECJSA

    "INI BOOKMARK SPEC-52246
    "Vamos a recuperar la posición donde poner la firma
    "1º miramos si el documento tiene BOOKMARK
*    IF pos_signa-bookmark IS NOT INITIAL.
    "Miramos si tiene Bookmark
    CONCATENATE 'ZSIGNA_' pos   INTO ls_pos_signa_aux-bookmark.
    CALL METHOD zcl_util_pdf=>get_bookmarks
      EXPORTING
        i_pdf       = c_xstring
        i_bookmark  = ls_pos_signa_aux-bookmark
      CHANGING
        e_pagina    = ls_pos_signa_aux-pagina
        x_pos       = ls_pos_signa_aux-x_pos
        y_pos       = ls_pos_signa_aux-y_pos
      EXCEPTIONS
        no_bookmark = 1
        OTHERS      = 2.

    ">>>SPEC:58683, Inici modificació  -  ECJSA
    "Permetre trobar marcadors amb el format "ZSIGNAnn"
    "Si no ha trobat el marcador amb el format "ZSIGNA_nn",
    "fem una segona crida amb el nou format i si no troba res, llencem error
    "-------------------------------------------------------------------------
    IF sy-subrc <> 0.

      CONCATENATE 'ZSIGNA' pos   INTO ls_pos_signa_aux-bookmark.
      CALL METHOD zcl_util_pdf=>get_bookmarks
        EXPORTING
          i_pdf       = c_xstring
          i_bookmark  = ls_pos_signa_aux-bookmark
        CHANGING
          e_pagina    = ls_pos_signa_aux-pagina
          x_pos       = ls_pos_signa_aux-x_pos
          y_pos       = ls_pos_signa_aux-y_pos
        EXCEPTIONS
          no_bookmark = 1
          OTHERS      = 2.

    ENDIF.
    "-------------------------------------------------------------------------
    "<<<SPEC:58683, Final modificació -  ECJSA

    IF sy-subrc = 0 AND l_web_hash IS INITIAL. "Te BookMarks y NO han punxat
      ">> SPEC-67085, Inici Modificació - ETODR
      IF go_log_global IS BOUND.
        ls_log_clau-bookmark = ls_pos_signa_aux-bookmark.
        go_log_global->afegir_entrada( EXPORTING iv_tasca = zglog_tasca_get_posicio
                                                 is_clau  = ls_log_clau
                                      EXCEPTIONS OTHERS   = 0 ).
      ENDIF.
      "<< SPEC-67085, Final Modificació - ETODR
      pos_signa-bookmark = ls_pos_signa_aux-bookmark.
      pos_signa-pagina   = ls_pos_signa_aux-pagina.
      pos_signa-x_pos    = ls_pos_signa_aux-x_pos.
      pos_signa-y_pos    = ls_pos_signa_aux-y_pos.
      "Tamany per defete de la signatura
      pos_signa-w_pos = '150'.
      pos_signa-h_pos = '75'.

      "ECLJS - Sense aixó no signa
      l_rotate        = '0'.

    ELSE. "Vamos a mirar si tiene posición mediante hash

      "Ubicación de la firma manual
      IF pos_hash IS NOT INITIAL.

        IF l_web_hash IS NOT INITIAL.

          ">> SPEC-69466, Inici Modificació - ECAGE
          IF gdg_anchor = gc_anchor_bpm_co_ca.

            pos_signa-x_pos = l_web_hash-x.
            pos_signa-y_pos = l_web_hash-y.
            pos_signa-h_pos = l_web_hash-z.
            pos_signa-w_pos = l_web_hash-w.
            pos_signa-pagina = l_web_hash-pagina.

            IF  l_web_hash-x = 0
            AND l_web_hash-y = 0
            AND l_web_hash-z = 0
            AND l_web_hash-w = 0 .
              RAISE no_pos.
            ENDIF.
            IF go_log_global IS BOUND.
              go_log_global->afegir_entrada( EXPORTING iv_tasca = zglog_tasca_get_posicio
                                                       is_clau  = ls_log_clau
                                            EXCEPTIONS OTHERS   = 0 ).
            ENDIF.
            "<< SPEC-69466, Final Modificació - ECAGE
          ELSE.

            "Obtenim el factor de conversió
            lv_factor = l_web_hash-factor.

            "Inicialitzem el factor si no té valor
            IF l_web_hash-factor IS INITIAL.
              lv_factor = '1.01'.
            ENDIF.

            "Convertim les posicions per repectar la proporcionalitat
            l_x_pos   = l_web_hash-x * lv_factor.
            WRITE l_x_pos TO pos_signa-x_pos NO-GROUPING DECIMALS 0.
            l_y_pos   = ( l_web_hash-y * lv_factor ) - l_web_hash-z.
            WRITE l_y_pos TO pos_signa-y_pos NO-GROUPING DECIMALS 0.

            pos_signa-pagina  = l_web_hash-pagina.

            IF l_web_hash-orientacio = 'V'.
              pos_signa-w_pos = l_web_hash-z.
              pos_signa-h_pos = l_web_hash-w.
              l_rotate = '90'.
            ELSE.
              pos_signa-w_pos = l_web_hash-w.
              pos_signa-h_pos = l_web_hash-z.
              l_rotate = '0'.
            ENDIF.

            CLEAR pos_signa-add_sign_page.
            IF l_web_hash-x = 0 AND
               l_web_hash-y = 0 AND
               l_web_hash-z = 0 AND
               l_web_hash-w = 0 .
              RAISE no_pos.
            ENDIF.
            ">> SPEC-67085, Inici Modificació - ETODR
            IF go_log_global IS BOUND.
              go_log_global->afegir_entrada( EXPORTING iv_tasca = zglog_tasca_get_posicio
                                                       is_clau  = ls_log_clau
                                            EXCEPTIONS OTHERS   = 0 ).
            ENDIF.
            "<< SPEC-67085, Final Modificació - ETODR
          ENDIF.
        ELSE.

          "Si no hi ha bookmarks(Word marcadors) ni han punxat
          "potser perque venen de desatesa i no els deixem punxar
          "mirem si el document te anchors parametritzats
          "Si s'ha enviat alguna cosa a signatura desatesa,
          "verifiquem si s'ha enviat per aquest usuari i si hi ha
          "Bookmark per la meva posició
          zcl_signatura_desatesa=>enviat_a_desatesa(
            EXPORTING
              iv_objectid = l_zgdg_docs-objectid
              iv_docclass = l_zgdg_docs-docclass
              iv_version  = l_zgdg_docs-version
              iv_uname    = sy-uname
            RECEIVING
              rv_enviat   = lv_desatesa ).

          IF lv_desatesa = abap_true.

            "Si és desatesa i no té marcadors, hem de tenir anchors
            SELECT SINGLE *
              FROM zgdg_pos_signa
              INTO pos_signa
             WHERE gdg_anchor = gdg_anchor
               AND pos = pos.

            l_rotate = '0'.

            IF sy-subrc <> 0.
              RAISE no_pos.
            ENDIF.
            ">> SPEC-67085, Inici Modificació - ETODR
            IF go_log_global IS BOUND.
              ls_log_clau-enviat_psigint = lv_desatesa.
              go_log_global->afegir_entrada( EXPORTING iv_tasca = zglog_tasca_get_posicio
                                                       is_clau  = ls_log_clau
                                            EXCEPTIONS OTHERS   = 0 ).
            ENDIF.
            "<< SPEC-67085, Final Modificació - ETODR
          ELSE.
            RAISE no_pos.
          ENDIF.

        ENDIF.
      ELSE."Vamos a mirar si tiene posición mediante las tablas

        l_rotate = '0'.

        SELECT SINGLE *
         FROM zgdg_pos_signa
         INTO pos_signa
        WHERE gdg_anchor = gdg_anchor
          AND pos = pos
          AND bukrs = _bukrs.

        IF sy-subrc <> 0.
          SELECT SINGLE *
            FROM zgdg_pos_signa
            INTO pos_signa
           WHERE gdg_anchor = gdg_anchor
             AND pos = pos .

          IF sy-subrc <> 0 AND _tipus NE 'C'. "SPEC-55389 miramos que no sea Centralizada para lanzar la excepción
            RAISE no_pos.
          ENDIF.
          ">> SPEC-67085, Inici Modificació - ETODR
          IF go_log_global IS BOUND.
            ls_log_clau-taula_pos_signa = abap_true.
            go_log_global->afegir_entrada( EXPORTING iv_tasca = zglog_tasca_get_posicio
                                                     is_clau  = ls_log_clau
                                          EXCEPTIONS OTHERS   = 0 ).
          ENDIF.
          "<< SPEC-67085, Final Modificació - ETODR
        ENDIF.
      ENDIF.
    ENDIF.


    IF ressegellat = abap_true.
      TRY .
          IF zcl_psis=>validate_signature( i_file = c_xstring ) = 'OK'.
            are_signed = abap_true.
          ELSE.
            rc = abap_false.
            RAISE zgdg_validate.
            EXIT.
          ENDIF.
        CATCH cx_root.
      ENDTRY.
    ENDIF.

    ">>>SPEC:66791, Inici modificació - ECACM
    " Creació del xml que conté al info del pdf a signar
    CALL METHOD me->creacio_xml_pdf
      EXPORTING
        im_pos_hash          = pos_hash
        im_desatesa          = lv_desatesa
        im_web_hash          = l_web_hash
        im_validate_dni      = validate_dni
        im_bin_content       = lt_bin_content
        im_fs                = <fs>
        im_rotate            = l_rotate
      IMPORTING
        ex_ssfbin            = ssfbin
        ex_long              = l_long
      CHANGING
        ch_zgdg_pos_sign_bkp = l_zgdg_pos_signa_bkp
        ch_xstring           = c_xstring
      EXCEPTIONS
        zgdg_dni             = 1
        OTHERS               = 2.
*    <<<SPEC:66791, Final modificació - ECACM

*    >>>SPEC:59184, Inici modificació  -  ECTRP
    ">>>SPEC:67312, Inici modificació - ECACM
*    IF sy-batch IS INITIAL.
*       Carregar la hora del sistema (inici_signatura)
    lv_hora_inici = sy-uzeit.
*    ENDIF.
    "<<<SPEC:67312, Final modificació - ECACM
    ">>>SPEC:59184, Final modificació  -  ECTRP

*<<<SPEC:66792, Inici modificació - ECMLS
    IF iv_check_iso EQ abap_true.
      zcl_gdg=>check_iso(
        EXPORTING
          z_docid    = z_docid
          z_classid  = z_classid
          iv_sign    = abap_true
        RECEIVING
          rc         = lv_iso_ok
        EXCEPTIONS
          no_data    = 1
          no_validat = 2
          iso_ko     = 3
          OTHERS     = 4
      ).

      IF sy-subrc <> 0.
        IF sy-subrc EQ 3.
          RAISE iso_ko.
        ENDIF.
        RAISE no_validat.
      ENDIF.
    ENDIF.
*<<<SPEC:66792, Final modificació - ECMLS

    "INI SPEC-90904
    """GUARDAR DOCUMENT EN SERVIDOR _PREVI_GDG 2.
*    IF _tipus = 'U' OR _tipus = 'F'."Caso en el que se genera XML
*      CALL METHOD me->guardar_fitxer_log_servidor
*        EXPORTING
*          z_docid    = z_docid
*          z_classid  = z_classid
*          z_accio    = '2'
*          z_xstring  = c_xstring
*          z_size     = l_long
*          z_extensio = '.xml'.
*    ENDIF.
    "FI SPEC-90904

    CALL METHOD me->ssf_sign
      EXPORTING
        filelength = l_long
      CHANGING
        filedata   = ssfbin.


    IF st_ssfparms-outdatalen > <fs>-comp_size.

      lv_sysubrc_firma = 0. "ETODR SPEC-67085
      <fs>-comp_size = st_ssfparms-outdatalen.
      ev_new_size    = st_ssfparms-outdatalen." DATAMON SPEC-66422

      REFRESH lt_bin_content.
      CALL METHOD cl_rmps_general_functions=>convert_255_to_1022
        EXPORTING
          im_tab_255  = ssfbin
        RECEIVING
          re_tab_1022 = lt_bin_content.

*      "INI SPEC-90904
*      """GUARDAR DOCUMENT EN SERVIDOR _POST_GDG 3.
*      REFRESH lt_bin_content_log.
*      lt_bin_content_log = lt_bin_content.
*      CALL METHOD me->guardar_fitxer_log_servidor
*        EXPORTING
*          z_docid   = z_docid
*          z_classid = z_classid
*          z_accio   = '3'
*          z_binari  = lt_bin_content_log
*          z_size    = st_ssfparms-outdatalen
*          z_extensio = '.pdf'.
*      "FI SPEC-90904

      add_log( objectid = z_docid
               docclass = z_classid ).

      me->lock_unlock_doc( zguid =  z_docid zdocclass =  z_classid  unlock = abap_true ).

      CALL FUNCTION 'SRM_DOCUMENT_CHECKIN_VIA_TAB'
        EXPORTING
          objectid        = z_docid
          documentclass   = z_classid
          as_new_version  = z_new_version
          do_commit       = 'X'
        TABLES
          components      = lt_components
          bin_content     = lt_bin_content
        EXCEPTIONS
          internal_error  = 1
          parameter_error = 2
          not_authorized  = 3
          doc_not_found   = 4
          yet_locked      = 5
          OTHERS          = 6.

      IF sy-subrc <> 0.
        RAISE zgdg_upload.
        rc = abap_false.
      ELSE.
        rc = abap_true.
        me->lock_unlock_doc( zguid =  z_docid zdocclass =  z_classid  lock = abap_true ).

        ">>>SPEC:59184, Inici modificació  -  ECTRP
        ">>>SPEC:67312, Inici modificació - ECACM
*        IF sy-batch IS INITIAL.
        "<<<SPEC:67312, Final modificació - ECACM
        " Tornar a carregar la hora del sistema (final_signatura)
        lv_hora_final = sy-uzeit.

        " Cal saber, si en el nostre cas, el procés va lent
        "Obtenim la demora parametritzada
        zcl_utils_parametritzacio=>get_dades_parametritzades(
         EXPORTING
           iv_repid            = lc_repid
           iv_langu            = sy-langu
         IMPORTING
           et_zsap_dt_param_hc = lt_demores ).

        READ TABLE lt_demores INTO ls_demores WITH KEY field_info = lc_field_info.
        lv_segons_syst = ls_demores-value.

        "Calculem la demora real
        lv_segons_param = lv_hora_final - lv_hora_inici.

        " Si la demora real es major que la parametritzada...
        CLEAR lv_data.
        IF lv_segons_param > lv_segons_syst.

          " OBJECT_ID/CLASS_ID del document que se està tractant.
          lv_data-zgdg_objectid = z_docid.
          lv_data-zgdg_class_id = z_classid.
          lv_accio = lc_accio_alta.

          " Insertar a la Taula de demora
          CALL METHOD me->set_demora_ssf
            EXPORTING
              iv_temps_demora = lv_segons_param
              iv_accio        = lv_accio
            CHANGING
              cv_data         = lv_data
            RECEIVING
              rv_rc           = lv_rc.

          " Si NO hi ha Demora
        ELSE.

          " Obtenir el Registre més recent de la Taula de Demora
          CLEAR lv_data.
          CALL METHOD me->get_demora_ssf
            IMPORTING
              ev_data = lv_data
            RECEIVING
              ev_rc   = lv_rc.

          IF lv_rc = 0 AND lv_data-zgdg_reparat = abap_false.

            " Actualitzar a la Taula de demora
            lv_accio = lc_accio_actu.
            CALL METHOD me->set_demora_ssf
              EXPORTING
                iv_accio = lv_accio
              CHANGING
                cv_data  = lv_data
              RECEIVING
                rv_rc    = lv_rc.

          ENDIF.

        ENDIF.

        "Registrar la duració de la signatura sempre (hagi demora o no)
        CLEAR lv_data.
        lv_data-zgdg_objectid = z_docid.
        lv_data-zgdg_class_id = z_classid.
        lv_data-zgdg_duracio_signa = lv_segons_param.
        CALL METHOD me->registrar_temps_signar
          EXPORTING
            is_data = lv_data
          RECEIVING
            rv_rc   = lv_rc.
        "<<<SPEC:67312, Inici modificació - ECACM
*        ENDIF.
        "<<<SPEC:67312, Final modificació - ECACM
        ">>>SPEC:59184, Final modificació  -  ECTRP

      ENDIF.
    ELSE.
      lv_sysubrc_firma = 1. "ETODR SPEC-67085
      RAISE no_signed.
      rc = abap_false.
    ENDIF.

    ">>>SPEC:53294, Inici modificació  - ECJSA
    "Si arribem aquí és que no ha saltat cap excepció!!!
    "Llencem event perque tothom pugui fer el que calgui després de signar
    IF rc = abap_true.

      "Si hi ha aquesta entrada a la taula de signatura desatesa,
      "la marquem com a signada.
      lv_usuari_sig   = l_zgdg_docs-usuari .
      lv_motiu_rebuig = l_zgdg_docs-motiu_rebutj . " CHAR100

      "Modifiquem el paràmetre si signem des de ZSIGNA.
      lv_entorn = 'WEB'.
      IF sy-tcode = 'ZSIGNA' OR sy-tcode = 'ORGANIZER'.
        lv_entorn = 'SAP'.
      ENDIF.

      ">>>SPEC:62685, Inici modificació  - ECFA
      cl_gui_frontend_services=>get_computer_name(
        CHANGING
          computer_name        = gv_computer_name
        EXCEPTIONS
          cntl_error           = 1
          error_no_gui         = 2
          not_supported_by_gui = 3
          OTHERS               = 4 ).

      IF sy-subrc <> 0.
* Implement suitable error handling here
      ELSE.

        CALL METHOD cl_gui_cfw=>flush
          EXCEPTIONS
            OTHERS = 1.

        lv_maquina = gv_computer_name.
      ENDIF.

      "<<<SPEC:62685, Final modificació - ECFA

      "és un update, si no hi ha entrada no la crearà
      CALL FUNCTION 'ZFM_UPDATE_ESTAT_SIGN_DESATESA'
        EXPORTING
          i_docclass         = l_zgdg_docs-docclass
          i_objectid         = l_zgdg_docs-objectid
          i_version          = l_zgdg_docs-version
          i_usuari_sig       = lv_usuari_sig
          i_data_envio       = l_zgdg_docs-data_envio
          i_hora_envio       = l_zgdg_docs-hora_envio
          i_upd_estat        = 'F'
          i_upd_entorn       = lv_entorn
          i_upd_data_accio   = sy-datum
          i_upd_hora_accio   = sy-timlo
          i_upd_motiu_rebuig = lv_motiu_rebuig
          i_maquina          = lv_maquina
        IMPORTING
          e_resultat         = lv_flag.

      "Si hi ha aquesta entrada a la taula de signatura desatesa,
      "enviem la informació a la web per que no estigui com a pendent.
      "Mapejat de dades a String
      lv_usuari_w   = l_zgdg_docs-usuari.
      lv_cod_exp_s  = l_zgdg_docs-aux1.

      CALL METHOD zcl_subscripcions=>mail_subs_gdg( l_zgdg_docs ). "ADD PSPEC-2445 - Preavís Adjudicació

      ">>>SPEC:69974, Inici modificació - ECACM
*   Si es la signatura es de tipus paral·lela, comprovem si tenim alguna
*   posició més per validar i en cas de que n'hi hagi i no es trobi cap signatari
*   cancel·lem les tasques de validació.
      IF l_zgdg_docs-signa_parallel EQ abap_true.

        CALL METHOD me->comprovar_valid_signs_paral
          EXPORTING
            im_zgdgdocs  = l_zgdg_docs
            im_usuari_w  = lv_usuari_w
            im_cod_exp_s = lv_cod_exp_s.

      ENDIF.
      ">>>SPEC:69974, Final modificació - ECACM

*>> Ini  SPEC-58422  - ETMAE
      CHECK lv_flag = abap_true. " 16/03/2020
*<< Fi  SPEC-58422  - ETMAE

      zcl_signatura_desatesa=>informar_enviament_a_web(
        EXPORTING
          iv_estat          = 'F'
          iv_docclass       = l_zgdg_docs-docclass
          iv_objectid       = l_zgdg_docs-objectid
          iv_version        = l_zgdg_docs-version
*         IV_NOM_EXPED      = solo se envian la primera vez.
*         IV_NOMDOCUMENT    = solo se envian la primera vez.
          iv_usuari         = lv_usuari_w
          iv_hora_enviament = l_zgdg_docs-hora_envio    " Hora del dia
          iv_data_enviament = l_zgdg_docs-data_envio    " Data
          iv_codi_exped     = lv_cod_exp_s
          iv_annex          = l_zgdg_docs-annexos
      ).

    ENDIF.
    "<<<SPEC:53294, Final modificació - ECJSA

    ">> SPEC-67085, Inici Modificació - ETODR
    IF go_log_global IS BOUND.
      "Tornem a carregar la clau per si de cas, afegint el paràmetre RC
      CLEAR: ls_log_clau.
      go_log_global->crea_clau( EXPORTING iv_docclass       = z_classid
                                          iv_objectid       = z_docid
                                          iv_pos            = pos
                                          iv_z_posicio_hash = pos_hash
                                          iv_gdg_anchor     = gdg_anchor
                                          iv_sysubrc        = lv_sysubrc_firma
                                IMPORTING es_log_clau       = ls_log_clau ).
      IF lv_sysubrc_firma <> 0.
        lv_resultat_log = zglog_resultat_ko.
      ELSE.
        lv_resultat_log = zglog_resultat_ok.
      ENDIF.
      go_log_global->afegir_entrada( EXPORTING  iv_tasca    = zglog_tasca_final
                                                iv_resultat = lv_resultat_log
                                                is_clau     = ls_log_clau
                                     EXCEPTIONS OTHERS      = 0 ).
    ENDIF.
    "<< SPEC-67085, Final Modificació - ETODR

  ENDMETHOD.


  METHOD firma_doc_pc.
    DATA: lt_file_table  TYPE filetable,
          l_rc           TYPE sy-subrc,
          l_user_action  TYPE i,
          l_filename     TYPE string,
          lv_length      TYPE i,
          lv_length_o    TYPE i,
          lt_bapidoccomp TYPE srm_t_bintab,
          lv_sign        TYPE xfeld.

    DATA: lt_graella_signataris TYPE TABLE OF zsigna_des_s_signants,
          ls_graella_signatari  TYPE zsigna_des_s_signants,
          l_random_hash         TYPE string,
          lt_web_hash           TYPE ztt_web_hash,
          ls_web_hash           TYPE zgdg_web_hash,
          lt_bin_content        TYPE bapidoccontentab,
          lt_components         TYPE bapidoccompt,
          lv_answ               TYPE c,
          xtab                  TYPE solix_tab,
          c_xstring             TYPE xstring,
          l_rotate(2)           TYPE c,
          l_page                TYPE string,
          utility               TYPE REF TO cl_http_utility,
          l_string              TYPE string,
          img_firma             TYPE xstring,
          img_firma_full        TYPE string,
          l_zgdg_pos_signa_bkp  TYPE zgdg_pos_signa,
          lv_dni                TYPE prdni,
          flen                  TYPE i,
          ssfbin                TYPE rmps_ssfbin,
          l_long                TYPE i,
          ls_name               TYPE soud3,
          lv_rc                 TYPE xfeld,
          ls_components         TYPE srmgs_components_entry,
          lv_factor             TYPE p LENGTH 4 DECIMALS 2.

    DATA l_filedownload TYPE string.
    DATA l_filedownload2 TYPE string.
    DATA l_filedownload3 TYPE string.
*<<<SPEC:66792, Inici modificació - ECMLS
    DATA lv_iso_ok TYPE abap_bool.
*>>>SPEC:66792, Final modificació - ECMLS
*    FIELD-SYMBOLS <fs>    TYPE  bapidoccomp.

    DATA: l_y_pos TYPE p LENGTH 16 DECIMALS 2, "ECJBG 09/05/2022 SPEC-70679
          l_x_pos TYPE p LENGTH 16 DECIMALS 2. "ECJBG 09/05/2022 SPEC-70679

    DATA: lt_param  TYPE zsap_tt_param_hc,
          ls_param  TYPE LINE OF zsap_tt_param_hc,
          lv_format TYPE ssfform.

    CHECK is_active = abap_true.

* SPEC-59583 - Obrir la nova graella per posicionar signatures
* El gui upload es fa dintre del FUNCTION 'ZSIGNA_DES_GRAELLA'
*    cl_gui_frontend_services=>file_open_dialog(
*     EXPORTING   multiselection          = abap_off
*                  file_filter = 'PDF (*.pdf)|*.pdf'
*     CHANGING    file_table              = lt_file_table
*                 rc                      = l_rc
*                 user_action             = l_user_action
*     EXCEPTIONS  OTHERS                  = 5 ).
*
*    READ TABLE lt_file_table INTO l_filename INDEX 1.
*    IF  sy-subrc = 0 AND NOT ( l_filename CP '*.PDF' OR l_filename CP '*.pdf').
*      MESSAGE 'El document no es un PDF.' TYPE 'I'.
*      EXIT.
*    ENDIF.
*    cl_gui_frontend_services=>gui_upload( EXPORTING  filename       = l_filename
*                                                     filetype       = 'BIN'
*                                          IMPORTING  filelength     = lv_length
*                                          CHANGING   data_tab       = lt_bapidoccomp
*                                          EXCEPTIONS OTHERS         = 2 ).

*    SPEC-59583 - Obrir la nova graella per posicionar signatures
    CALL FUNCTION 'GENERAL_GET_RANDOM_STRING'
      EXPORTING
        number_chars  = 8
      IMPORTING
        random_string = l_random_hash.
    ls_graella_signatari-zhash = l_random_hash.
    ls_graella_signatari-z_ordre = 1.
    ls_graella_signatari-zsignatari = sy-uname.
    ls_name-sapnam = sy-uname.

*    Recuperamos el nombre de la person a partir del usuario
    CALL FUNCTION 'SO_NAME_CONVERT'
      EXPORTING
        name_in               = ls_name
      IMPORTING
        name_out              = ls_name
      EXCEPTIONS
        communication_failure = 1
        office_name_not_exist = 2
        parameter_error       = 3
        sap_name_not_exist    = 4
        system_failure        = 5
        user_not_exist        = 6
        OTHERS                = 7.
    IF sy-subrc EQ 0.
      ls_graella_signatari-nom = ls_name-adrname.
    ENDIF.


    APPEND ls_graella_signatari TO lt_graella_signataris.

    CALL FUNCTION 'ZSIGNA_DES_GRAELLA'
      EXPORTING
        iv_extern      = 'X'
        it_signataris  = lt_graella_signataris
      IMPORTING
        et_bin_content = lt_bin_content
        et_web_hash    = lt_web_hash
        et_components  = lt_components
        ev_filename    = l_filename
        ev_sign        = lv_sign.

    CHECK lv_sign = abap_true AND lt_bin_content IS NOT INITIAL AND lt_components IS NOT INITIAL. "Comprobamos que se haya mandado a firmar y hayan datos

    READ TABLE lt_components ASSIGNING FIELD-SYMBOL(<fs_comps>) INDEX 1.

    MOVE-CORRESPONDING <fs_comps> TO  ls_components.

    IF ls_components-comp_id NP '*.pdf'.
      CALL METHOD zcl_utils_docs=>office_2_pdf_cs_from_bin
        IMPORTING
          rc             = lv_rc
        CHANGING
          ct_bin_content = lt_bin_content
          cs_components  = ls_components.
    ELSE.
      lv_rc = abap_true.
    ENDIF.

    IF lv_rc = abap_true.

*en tabla et_web_hash, si is not initial es que lo han posicionado

*    IF lt_web_hash IS NOT INITIAL. "Han posicionat
**preguntar si quieren firmar
*      CALL FUNCTION 'POPUP_TO_CONFIRM'
*        EXPORTING
*          titlebar              = text-t01
*          text_question         = text-t02
*          text_button_1         = text-t03
*          icon_button_1         = 'ICON_OKAY'
*          text_button_2         = text-t04
*          icon_button_2         = 'ICON_CANCEL'
*          display_cancel_button = abap_false
*        IMPORTING
*          answer                = lv_answ
*        EXCEPTIONS
*          text_not_found        = 1
*          OTHERS                = 2.
*
*      CHECK lv_answ NE '2'.
* recuperar et_Bin_content y meterlo en lt_bapidoccomp
*replicar mètodo FIRMA_DOC_CS la parte de firma (linia 105 a 519)
* quitar parte del bookmarks
* quitar de 240 a 318


*    READ TABLE lt_components ASSIGNING <fs> INDEX 1.
*>>>SPEC:66792, Inici modificació - ECMLS
      CALL METHOD cl_rmps_general_functions=>convert_1022_to_255
        EXPORTING
          im_tab_1022 = lt_bin_content
        RECEIVING
          re_tab_255  = xtab.

      CALL FUNCTION 'SCMS_BINARY_TO_XSTRING'
        EXPORTING
          input_length = ls_components-comp_size
        IMPORTING
          buffer       = c_xstring
        TABLES
          binary_tab   = xtab
        EXCEPTIONS
          failed       = 1
          OTHERS       = 2.

      zcl_gdg=>check_iso(
        EXPORTING
          z_raw      = c_xstring
          iv_size    = ls_components-comp_size
          iv_sign    = abap_true
        RECEIVING
          rc         = lv_iso_ok
        EXCEPTIONS
          no_data    = 1
          no_validat = 2
          iso_ko     = 3
          OTHERS     = 4
      ).

      IF sy-subrc <> 0.
        IF sy-subrc EQ 3.
          MESSAGE i017(zsignatura).
        ELSE.
          MESSAGE i018(zsignatura).
        ENDIF.
        EXIT.
      ENDIF.
*<<<SPEC:66792, Final modificació - ECMLS

      "ECJSA - per evitar que les signatures horitzontals no disposin d'imatge
      "(a signatura desatesa amb bookmark o Anchor), agafem la primera
      SELECT SINGLE * FROM zgdg_pos_signa
        INTO  l_zgdg_pos_signa_bkp
        WHERE gdg_anchor = 'DEFAULT'
          AND pos = 1.

      READ TABLE lt_web_hash INTO ls_web_hash  INDEX 1.

      "Obtenim el factor de conversió
      lv_factor = ls_web_hash-factor.

      "Inicialitzem el factor si no té valor
      IF ls_web_hash-factor IS INITIAL.
        lv_factor = '1.01'.
      ENDIF.

      "INI ECJBG 09/05/2022 SPEC-70679
      "Convertim les posicions per repectar la proporcionalitat
      pos_signa-x_pos   = ls_web_hash-x  * lv_factor.
      pos_signa-y_pos   = ( ls_web_hash-y - ls_web_hash-z )  * lv_factor.
      pos_signa-pagina  = ls_web_hash-pagina.

      "Convertim les posicions per repectar la proporcionalitat
*      l_x_pos   = ls_web_hash-x * lv_factor.
*      WRITE l_x_pos TO pos_signa-x_pos NO-GROUPING DECIMALS 0.
*      l_y_pos   = ( ls_web_hash-y * lv_factor ) - ls_web_hash-z.
*      WRITE l_y_pos TO pos_signa-y_pos NO-GROUPING DECIMALS 0.
      "FIN ECJBG 09/05/2022 SPEC-70679


      ">>>SPEC:54948, Inici modificació  - ECJSA
      "Es detecta que s'està posicionant malament la signatura
      "per un tema de GDG.
      "Comentem aquesta línia i es posa la línia 135, on s'agafa la pàgina
      "de la consulta a la taula zgdg_web_hash.
      "-----------------------------------------
      "pos_signa-pagina = l_web_hash-pagina + 1.
      "-----------------------------------------
      "<<<SPEC:54948, Final modificació - ECJSA

      IF ls_web_hash-orientacio = 'V'.
        pos_signa-w_pos = ls_web_hash-z.
        pos_signa-h_pos = ls_web_hash-w.
        l_rotate = '90'.
      ELSE.
        pos_signa-w_pos = ls_web_hash-w.
        pos_signa-h_pos = ls_web_hash-z.
        l_rotate = '0'.
      ENDIF.

      CLEAR pos_signa-add_sign_page.
*      IF ls_web_hash-x = 0 AND
*         ls_web_hash-y = 0 AND
*         ls_web_hash-z = 0 AND
*         ls_web_hash-w = 0 .
*        RAISE no_pos.
*      ENDIF.

*      IF _tipus = 'U' OR _tipus = 'F'."Generamos ssfbin con XML

      l_page = pos_signa-pagina .


      " Conversió :  XSTRING a BASE64
      CREATE OBJECT utility.
      CALL METHOD utility->encode_x_base64
        EXPORTING
          unencoded = c_xstring
        RECEIVING
          encoded   = l_string.

      DATA xml TYPE string.

      "INI SPEC-92704
      "Parametritzar el format, per quan falla la selladora de temps
      "Obtenim la demora parametritzada
      zcl_utils_parametritzacio=>get_dades_parametritzades(
       EXPORTING
         iv_repid            = 'GDG'
         iv_field_info       = 'FORMAT'
         iv_langu            = sy-langu
       IMPORTING
         et_zsap_dt_param_hc = lt_param ).

      READ TABLE lt_param INTO ls_param INDEX 1.
      IF sy-subrc = 0.
        lv_format = ls_param-value.
      ELSE.
        lv_format = 'PDFTSA'.
      ENDIF.

      "FI SPEC-92704

      xml = '<?xml version="1.0"  encoding="UTF-8"?>'.
      CONCATENATE xml '<GDGSIG>' INTO xml.
      "INI SPEC-92704
*     CONCATENATE xml '<FORMAT>PDFTSA</FORMAT>' INTO xml.
      CONCATENATE xml '<FORMAT>' lv_format '</FORMAT>' INTO xml.
      "FI SPEC-92704
      CONCATENATE xml '<DOC>' l_string '</DOC>' INTO xml.
      CONCATENATE xml '<IMAGE>' INTO xml.
      CONCATENATE xml '<TYPE>JPG</TYPE>' INTO xml.
      IF ls_web_hash-orientacio = 'V'.
        IF l_zgdg_pos_signa_bkp-imatge_v_buffer IS INITIAL.
          OPEN DATASET l_zgdg_pos_signa_bkp-imatge_v FOR INPUT IN BINARY MODE.
          IF sy-subrc = 0.
*          WHILE sy-subrc = 0.
            READ DATASET l_zgdg_pos_signa_bkp-imatge_v INTO img_firma.

            CALL METHOD utility->encode_x_base64
              EXPORTING
                unencoded = img_firma
              RECEIVING
                encoded   = img_firma_full.
*            CONCATENATE img_firma_full  img_firma INTO img_firma_full.          ENDWHILE.
            CLOSE DATASET pos_signa-imatge_v.
            l_zgdg_pos_signa_bkp-imatge_v_buffer = img_firma_full.
            MODIFY zgdg_pos_signa FROM l_zgdg_pos_signa_bkp.
          ENDIF.
        ELSE.
          img_firma_full = l_zgdg_pos_signa_bkp-imatge_v_buffer.
        ENDIF.

      ELSE.
        IF l_zgdg_pos_signa_bkp-imatge_buffer IS INITIAL.
          OPEN DATASET l_zgdg_pos_signa_bkp-imatge FOR INPUT IN BINARY MODE.
          IF sy-subrc = 0.
*          WHILE sy-subrc = 0.
            READ DATASET l_zgdg_pos_signa_bkp-imatge INTO img_firma.

            CALL METHOD utility->encode_x_base64
              EXPORTING
                unencoded = img_firma
              RECEIVING
                encoded   = img_firma_full.
*            CONCATENATE img_firma_full  img_firma INTO img_firma_full.          ENDWHILE.
            CLOSE DATASET pos_signa-imatge.
            l_zgdg_pos_signa_bkp-imatge_buffer = img_firma_full.
            MODIFY zgdg_pos_signa FROM l_zgdg_pos_signa_bkp.
          ENDIF.
        ELSE.
          img_firma_full = l_zgdg_pos_signa_bkp-imatge_buffer.
        ENDIF.
      ENDIF.

      IF img_firma_full IS NOT INITIAL.
        CONCATENATE xml '<RAW>' img_firma_full '</RAW>' INTO xml.
      ELSE.
        CONCATENATE xml '<RAW>'
        '/9j/4AAQSkZJRgABAQEAYABgAAD/2wBDAAIBAQIBAQICAgICAgICAwUDAwMDAwYEBAMFBwYHBwcGBwc'
        'ICQsJCAgKCAcHCg0KCgsMDAwMBwkODw0MDgsMDAz/2wBDAQICAgMDAwYDAwYMCAcIDAwMDAwMDAwMDAw'
        'MDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAz/wAARCAABAAEDASIAAhEBAxEB/8QA'
        'HwAAAQUBAQEBAQEAAAAAAAAAAAECAwQFBgcICQoL/8QAtRAAAgEDAwIEAwUFBAQAAAF9AQIDAAQRBRIhM'
        'UEGE1FhByJxFDKBkaEII0KxwRVS0fAkM2JyggkKFhcYGRolJicoKSo0NTY3ODk6Q0RFRkdISUpTVFVWV1'
        'hZWmNkZWZnaGlqc3R1dnd4eXqDhIWGh4iJipKTlJWWl5iZmqKjpKWmp6ipqrKztLW2t7i5usLDxMXGx8j'
        'JytLT1NXW19jZ2uHi4+Tl5ufo6erx8vP09fb3+Pn6/8QAHwEAAwEBAQEBAQEBAQAAAAAAAAECAwQFBgcI'
        'CQoL/8QAtREAAgECBAQDBAcFBAQAAQJ3AAECAxEEBSExBhJBUQdhcRMiMoEIFEKRobHBCSMzUvAVYnLRCh'
        'YkNOEl8RcYGRomJygpKjU2Nzg5OkNERUZHSElKU1RVVldYWVpjZGVmZ2hpanN0dXZ3eHl6goOEhYaHiImK'
        'kpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4uPk5ebn6Onq8vP09fb3+P'
        'n6/9oADAMBAAIRAxEAPwD9/KKKKAP/2Q=='
        '</RAW>' INTO xml.
      ENDIF.
      DATA xml_aux TYPE string.

      CONCATENATE '<PAGE>' l_page '</PAGE>' INTO xml_aux.
      CONDENSE xml_aux NO-GAPS.
      CONCATENATE xml xml_aux INTO xml.
****************************************
********************************************

      CONCATENATE xml '<POS>' pos_signa-x_pos ',' pos_signa-y_pos ','
                              pos_signa-w_pos ',' pos_signa-h_pos '</POS>' INTO xml.
      CONCATENATE xml '<ROTATE>' l_rotate '</ROTATE>' INTO xml.

      "---------------------------------------------------------------------------------
      "Prova signatures prefixades
      DATA lv_singggg TYPE string.
      lv_singggg = '[SIGNATURE_FIELD_0]16105323550970'.
      IF sy-uname = 'ETLJS' OR sy-uname = 'ETOVB'.
        CONCATENATE xml '<FONT>10</FONT>' INTO xml.
        CONCATENATE xml '<VINDENT>0</VINDENT>' INTO xml.
        CONCATENATE xml '<SIGLABEL>' lv_singggg '</SIGLABEL>' INTO xml.
      ENDIF.
      "---------------------------------------------------------------------------------
*      IF ls_web_hash-orientacio = 'V'.
*        CONCATENATE xml '<FONT>8</FONT>' INTO xml.
*      ENDIF.

      DATA l_xml_nomcarrec TYPE string.
      l_xml_nomcarrec = me->get_nom_carrec( ls_web_hash ). "ADD SPEC-58393
      CONCATENATE  xml l_xml_nomcarrec INTO xml.
      CONCATENATE xml '<CODING>CP1252</CODING>' INTO xml. "ADD SPEC-61247
      CONCATENATE xml '</IMAGE>' INTO xml.

      IF pos_signa-x_pos_csv IS NOT INITIAL. "Agregamos el CSV

        CONCATENATE xml '<CSV><CSVTYPE>TEXT</CSVTYPE><IMAGETYPE/>' INTO xml.
        CONCATENATE xml '<VALUE>' 'Signat digitalment per:' '</VALUE>' INTO xml.
        CONCATENATE '<PAGE>' l_page '</PAGE>' INTO xml_aux.
        CONDENSE xml_aux NO-GAPS.
        CONCATENATE xml xml_aux INTO xml.
        CONCATENATE xml '<POS>' pos_signa-x_pos_csv ',' pos_signa-y_pos_csv ','
                                pos_signa-w_pos_csv ',' pos_signa-h_pos_csv '</POS>' INTO xml.
        CONCATENATE xml '<ROTATE>' l_rotate ' </ROTATE>' INTO xml.

        CONCATENATE xml '</CSV>' INTO xml.
      ENDIF.


      "Obtenim el dni del signatari per comprobar a l'XML del PDF
*    get_dni_from_user(
*      EXPORTING
*        iv_usuari    = sy-uname
*      IMPORTING
*        ev_dni       =  lv_dni   " Número Identificació Fiscal
*      EXCEPTIONS
*        zgdg_dni     = 1
*        zno_employee = 2
*        OTHERS       = 3
*    ).
*    IF sy-subrc <> 0.
*      "Per qualsevol error raise d'aquest que es captura per sobre
**          RAISE zgdg_dni.
*      MESSAGE 'El seu DNI és incorrecte' TYPE 'E'.
*    ELSE.
*      "Si tot és correcte, afegim el node
*      CONCATENATE xml '<DNI>' INTO xml.
*      CONCATENATE xml lv_dni INTO xml.
*      CONCATENATE xml '</DNI>' INTO xml.
*    ENDIF.


      "*******************************************************************
      CONCATENATE xml '<GDGNODATE>0</GDGNODATE>' INTO xml. "ADD SPEC-65478
      CONCATENATE xml '</GDGSIG>' INTO xml.

      CALL FUNCTION 'SCMS_STRING_TO_XSTRING'
        EXPORTING
          text   = xml
        IMPORTING
          buffer = c_xstring.

      DATA : c_string TYPE string.
      CALL FUNCTION 'SCMS_XSTRING_TO_BINARY'
        EXPORTING
          buffer        = c_xstring
        IMPORTING
          output_length = flen
        TABLES
          binary_tab    = ssfbin.
      l_long = flen.
      IF 1 = 2.
        DATA l_file TYPE string.
        l_file = '.\richdoc.xml'.
        OPEN DATASET l_file FOR OUTPUT IN BINARY MODE.
        TRANSFER c_xstring TO l_file.
        CLOSE DATASET l_file.

      ENDIF.
*      ELSE. "Generamos ssfbin con el PDF
*        CALL METHOD cl_rmps_general_functions=>convert_1022_to_255
*          EXPORTING
*            im_tab_1022 = lt_bin_content
*            im_len      = <fs>-comp_size
*          RECEIVING
*            re_tab_255  = ssfbin.
*
*        l_long = <fs>-comp_size.
*      ENDIF.

      CALL METHOD me->ssf_sign
        EXPORTING
          filelength = l_long
        CHANGING
          filedata   = ssfbin.

      IF st_ssfparms-outdatalen > ls_components-comp_size.
        ls_components-comp_size = st_ssfparms-outdatalen.

        REFRESH lt_bin_content.
        CALL METHOD cl_rmps_general_functions=>convert_255_to_1022
          EXPORTING
            im_tab_255  = ssfbin
          RECEIVING
            re_tab_1022 = lt_bin_content.


        l_filedownload2  = l_filename.
        cl_gui_frontend_services=>file_save_dialog( EXPORTING file_filter = 'PDF (*.pdf)|*.pdf'
                                                    CHANGING
                                                                filename    = l_filedownload2
                                                                path        = l_filedownload3
                                                                fullpath    = l_filedownload
                                                    EXCEPTIONS  OTHERS      = 5 ).
        IF sy-subrc <> 0 OR l_filedownload IS INITIAL.
          MESSAGE `Signatura cancel·lada per l'usuari` TYPE 'S'.
          EXIT.
        ENDIF.

        cl_gui_frontend_services=>gui_download( EXPORTING   bin_filesize = lv_length_o
                                                            filename     = l_filedownload
                                                            filetype     = 'BIN'
                                                CHANGING    data_tab     = ssfbin
                                                EXCEPTIONS  OTHERS       = 24 ).
        MESSAGE 'Document signat correctament' TYPE 'S'.

      ELSE.

        MESSAGE 'Error en realitzar la signatura del PDF' TYPE 'I'.

      ENDIF.

*    ENDIF.


*      CHECK sy-subrc = 0.
*      DATA :  c_xstring TYPE xstring.
*      DATA l_string TYPE string.
**    CALL FUNCTION 'SCMS_BINARY_TO_XSTRING'
**      EXPORTING
**        input_length = lv_length
**      IMPORTING
**        buffer       = c_xstring
**      TABLES
**        binary_tab   = lt_bapidoccomp
**      EXCEPTIONS
**        failed       = 1
**        OTHERS       = 2.
**    DATA: utility TYPE REF TO cl_http_utility.
**
**    CREATE OBJECT utility.
**    CALL METHOD utility->encode_x_base64
**      EXPORTING
**        unencoded = c_xstring
**      RECEIVING
**        encoded   = l_string.
**
**    DATA xml TYPE string.
**
**    xml = '<?xml version="1.0"  encoding="UTF-8"?>'.
**    CONCATENATE xml '<GDGSIG>' INTO xml.
**    CONCATENATE xml '<FORMAT>PDFTSA</FORMAT>' INTO xml.
**    CONCATENATE xml '<DOC>' l_string '</DOC>' INTO xml.
**    CONCATENATE xml '<IMAGE>' INTO xml.
**    CONCATENATE xml '<TYPE>JPG</TYPE>' INTO xml.
**    CONCATENATE xml '<RAW>'
**      '/9j/4AAQSkZJRgABAQEAYABgAAD/2wBDAAIBAQIBAQICAgICAgICAwUDAwMDAwYEBAMFBwYHBwcGBwc'
**      'ICQsJCAgKCAcHCg0KCgsMDAwMBwkODw0MDgsMDAz/2wBDAQICAgMDAwYDAwYMCAcIDAwMDAwMDAwMDAw'
**      'MDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAz/wAARCAABAAEDASIAAhEBAxEB/8QA'
**      'HwAAAQUBAQEBAQEAAAAAAAAAAAECAwQFBgcICQoL/8QAtRAAAgEDAwIEAwUFBAQAAAF9AQIDAAQRBRIhM'
**      'UEGE1FhByJxFDKBkaEII0KxwRVS0fAkM2JyggkKFhcYGRolJicoKSo0NTY3ODk6Q0RFRkdISUpTVFVWV1'
**      'hZWmNkZWZnaGlqc3R1dnd4eXqDhIWGh4iJipKTlJWWl5iZmqKjpKWmp6ipqrKztLW2t7i5usLDxMXGx8j'
**      'JytLT1NXW19jZ2uHi4+Tl5ufo6erx8vP09fb3+Pn6/8QAHwEAAwEBAQEBAQEBAQAAAAAAAAECAwQFBgcI'
**      'CQoL/8QAtREAAgECBAQDBAcFBAQAAQJ3AAECAxEEBSExBhJBUQdhcRMiMoEIFEKRobHBCSMzUvAVYnLRCh'
**      'YkNOEl8RcYGRomJygpKjU2Nzg5OkNERUZHSElKU1RVVldYWVpjZGVmZ2hpanN0dXZ3eHl6goOEhYaHiImK'
**      'kpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4uPk5ebn6Onq8vP09fb3+P'
**      'n6/9oADAMBAAIRAxEAPwD9/KKKKAP/2Q=='
**      '</RAW>' INTO xml.
**    CONCATENATE xml '<PAGE>1</PAGE>' INTO xml.
**    CONCATENATE xml '<POS>1,1,1,1</POS>' INTO xml.
**    CONCATENATE xml '<ROTATE>0</ROTATE>' INTO xml.
**    CONCATENATE xml '</IMAGE>' INTO xml.
**    CONCATENATE xml '</GDGSIG>' INTO xml.
**
**    CALL FUNCTION 'SCMS_STRING_TO_XSTRING'
**      EXPORTING
**        text   = xml
**      IMPORTING
**        buffer = c_xstring.
**    DATA : flen TYPE i.
*      DATA ssfbin TYPE rmps_ssfbin.
**    CALL FUNCTION 'SCMS_XSTRING_TO_BINARY'
**      EXPORTING
**        buffer        = c_xstring
**      IMPORTING
**        output_length = flen
**      TABLES
**        binary_tab    = ssfbin.
**    DATA l_long TYPE i.
**    l_long = flen.
**
**
**    CALL METHOD me->ssf_sign
**      EXPORTING
**        filelength = l_long
**      CHANGING
**        filedata   = ssfbin.

*      IF st_ssfparms-outdatalen > 0.


*        DATA l_filedownload TYPE string.
*        DATA l_filedownload2 TYPE string.
*        DATA l_filedownload3 TYPE string.
*        l_filedownload2  = l_filename.
*        cl_gui_frontend_services=>file_save_dialog( EXPORTING file_filter = 'PDF (*.pdf)|*.pdf'
*                                                    CHANGING
*                                                                filename    = l_filedownload2
*                                                                path        = l_filedownload3
*                                                                fullpath    = l_filedownload
*                                                    EXCEPTIONS  OTHERS      = 5 ).
*        IF sy-subrc <> 0 OR l_filedownload IS INITIAL.
*          MESSAGE `Signatura cancel·lada per l'usuari` TYPE 'S'.
*          EXIT.
*        ENDIF.
*
*        cl_gui_frontend_services=>gui_download( EXPORTING   bin_filesize = lv_length_o
*                                                            filename     = l_filedownload
*                                                            filetype     = 'BIN'
*                                                CHANGING    data_tab     = ssfbin
*                                                EXCEPTIONS  OTHERS       = 24 ).
*        MESSAGE 'Document signat correctament' TYPE 'S'.






*    ELSE."No han posicionat
**    Missatge emergent indicant de que no
**    s'ha posicionat la signatura i no es signarà el document
*      MESSAGE 'No s''ha posicionat la signatura i no es signarà el document' TYPE 'E'.
*      EXIT.
*    ENDIF.
    ELSE.
      MESSAGE 'No s''ha pogut convertir el document a pdf' TYPE 'I'.
    ENDIF.

  ENDMETHOD.


  METHOD firma_doc_raw.
    DATA: ssfbin    TYPE rmps_ssfbin,
*>>>SPEC:62854, Inici modificació - ECMLS
          c_xstring TYPE xstring,
          lv_iso_ok TYPE abap_bool.
*<<<SPEC:62854, Final  modificació - ECMLS

    CHECK is_active = abap_true.

    ssfbin = cl_rmps_general_functions=>convert_1022_to_255( im_tab_1022 = doc_raw
                                                             im_len      = doc_legth ).

*>>>SPEC:62854, Inici modificació - ECMLS
    CALL FUNCTION 'SCMS_BINARY_TO_XSTRING'
      EXPORTING
        input_length = doc_legth
      IMPORTING
        buffer       = c_xstring
      TABLES
        binary_tab   = ssfbin
      EXCEPTIONS
        failed       = 1
        OTHERS       = 2.

    IF iv_check_iso EQ abap_true.
      zcl_gdg=>check_iso(
        EXPORTING
          z_raw      = c_xstring
          iv_sign    = abap_true
        RECEIVING
          rc         = lv_iso_ok
        EXCEPTIONS
          no_data    = 1
          no_validat = 2
          OTHERS     = 3
      ).
    ENDIF.

*<<<SPEC:62854, Final  modificació - ECMLS

    me->_init( ). "Inicializamos la firma

    CALL METHOD me->ssf_sign
      EXPORTING
        filelength = doc_legth
      CHANGING
        filedata   = ssfbin.



    CHECK st_ssfparms-outdatalen > 0.
    doc_legth = st_ssfparms-outdatalen.
    REFRESH doc_raw.
    doc_raw =  cl_rmps_general_functions=>convert_255_to_1022( ssfbin ).

  ENDMETHOD.


  METHOD firma_doc_raw_xml.


    DATA: lt_components  TYPE TABLE OF bapidoccomp,
          lt_bin_content TYPE TABLE OF bapiconten.
    DATA l_long TYPE i.
    DATA: ssfbin    TYPE rmps_ssfbin.

    FIELD-SYMBOLS <fs>    TYPE  bapidoccomp.

    SELECT SINGLE * FROM zgdg_pos_signa INTO pos_signa WHERE gdg_anchor = gdg_anchor AND pos = pos AND bukrs = _bukrs.
    IF sy-subrc <> 0.
      SELECT SINGLE * FROM zgdg_pos_signa INTO pos_signa WHERE gdg_anchor = gdg_anchor AND pos = pos .

      IF sy-subrc <> 0.
        SELECT SINGLE * FROM zgdg_pos_signa INTO pos_signa WHERE gdg_anchor = 'DEFAULT'.
      ENDIF.
    ENDIF.
    CHECK is_active = abap_true.

    DATA l_page TYPE string.
    IF pos_signa-add_sign_page = 'X'. "Firma en la ultima página
      l_page = me->get_page_from_pdf( i_data = doc_raw ).
    ELSE.
      l_page = pos_signa-pagina . "-1 SPEC-55294
    ENDIF.


    " Conversió :  XSTRING a BASE64
    DATA: utility TYPE REF TO cl_http_utility.
    DATA l_string TYPE string.

    CREATE OBJECT utility.

    CALL METHOD utility->encode_x_base64
      EXPORTING
        unencoded = doc_raw
      RECEIVING
        encoded   = l_string.



    "--------------------------------------------------------------------------------------------
    "INICI montatge de l'XML que s'enviarà a signar
    "--------------------------------------------------------------------------------------------
    DATA xml TYPE string.

    xml = '<?xml version="1.0"  encoding="UTF-8"?>'.
    CONCATENATE xml '<GDGSIG>' INTO xml.
    CONCATENATE xml '<FORMAT>' format_xml '</FORMAT>' INTO xml.
    CONCATENATE xml '<DOC>' l_string '</DOC>' INTO xml.
    CONCATENATE xml '<IMAGE>' INTO xml.
    CONCATENATE xml '<TYPE>JPG</TYPE>' INTO xml.
    IF pos_signa-imatge IS NOT INITIAL.
      DATA img_firma TYPE xstring.
      DATA img_firma_full TYPE string.
      OPEN DATASET pos_signa-imatge FOR INPUT IN BINARY MODE.
      IF sy-subrc = 0.
*          WHILE sy-subrc = 0.
        READ DATASET pos_signa-imatge INTO img_firma.
        CALL METHOD utility->encode_x_base64
          EXPORTING
            unencoded = img_firma
          RECEIVING
            encoded   = img_firma_full.
*            CONCATENATE img_firma_full  img_firma INTO img_firma_full.          ENDWHILE.
        CLOSE DATASET pos_signa-imatge.
      ENDIF.
    ENDIF.
    IF img_firma_full IS NOT INITIAL.
      CONCATENATE xml '<RAW>' img_firma_full '</RAW>' INTO xml.
    ELSE.
      CONCATENATE xml '<RAW>'
      '/9j/4AAQSkZJRgABAQEAYABgAAD/2wBDAAIBAQIBAQICAgICAgICAwUDAwMDAwYEBAMFBwYHBwcGBwc'
      'ICQsJCAgKCAcHCg0KCgsMDAwMBwkODw0MDgsMDAz/2wBDAQICAgMDAwYDAwYMCAcIDAwMDAwMDAwMDAw'
      'MDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAz/wAARCAABAAEDASIAAhEBAxEB/8QA'
      'HwAAAQUBAQEBAQEAAAAAAAAAAAECAwQFBgcICQoL/8QAtRAAAgEDAwIEAwUFBAQAAAF9AQIDAAQRBRIhM'
      'UEGE1FhByJxFDKBkaEII0KxwRVS0fAkM2JyggkKFhcYGRolJicoKSo0NTY3ODk6Q0RFRkdISUpTVFVWV1'
      'hZWmNkZWZnaGlqc3R1dnd4eXqDhIWGh4iJipKTlJWWl5iZmqKjpKWmp6ipqrKztLW2t7i5usLDxMXGx8j'
      'JytLT1NXW19jZ2uHi4+Tl5ufo6erx8vP09fb3+Pn6/8QAHwEAAwEBAQEBAQEBAQAAAAAAAAECAwQFBgcI'
      'CQoL/8QAtREAAgECBAQDBAcFBAQAAQJ3AAECAxEEBSExBhJBUQdhcRMiMoEIFEKRobHBCSMzUvAVYnLRCh'
      'YkNOEl8RcYGRomJygpKjU2Nzg5OkNERUZHSElKU1RVVldYWVpjZGVmZ2hpanN0dXZ3eHl6goOEhYaHiImK'
      'kpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4uPk5ebn6Onq8vP09fb3+P'
      'n6/9oADAMBAAIRAxEAPwD9/KKKKAP/2Q=='
      '</RAW>' INTO xml.
    ENDIF.
    DATA xml_aux TYPE string.

    CONCATENATE '<PAGE>' l_page '</PAGE>' INTO xml_aux.
    CONDENSE xml_aux NO-GAPS.
    CONCATENATE xml xml_aux INTO xml.
*      CONCATENATE xml '<POS>300,125,257,50</POS>' INTO xml.

    CONCATENATE xml '<POS>' pos_signa-x_pos ',' pos_signa-y_pos ','
                            pos_signa-w_pos ',' pos_signa-h_pos '</POS>' INTO xml.
    CONCATENATE xml '<ROTATE>0</ROTATE><FONT>6</FONT>' INTO xml.
    DATA l_xml_nomcarrec TYPE string.
    l_xml_nomcarrec = me->get_nom_carrec(  ). "ADD SPEC-58393
    CONCATENATE  xml l_xml_nomcarrec INTO xml.
    CONCATENATE xml '<CODING>CP1252</CODING>' INTO xml. "ADD SPEC-61247
    CONCATENATE xml '</IMAGE>' INTO xml.
    IF pos_signa-x_pos_csv IS NOT INITIAL. "Agregamos el CSV

      CONCATENATE xml '<CSV><CSVTYPE>TEXT</CSVTYPE><IMAGETYPE/>' INTO xml.
      CONCATENATE xml '<VALUE>' pos_signa-csv_text '</VALUE>' INTO xml.
      CONCATENATE '<PAGE>' l_page '</PAGE>' INTO xml_aux.
      CONDENSE xml_aux NO-GAPS.
      CONCATENATE xml xml_aux INTO xml.
      CONCATENATE xml '<POS>' pos_signa-x_pos_csv ',' pos_signa-y_pos_csv ','
                              pos_signa-w_pos_csv ',' pos_signa-h_pos_csv '</POS>' INTO xml.
      CONCATENATE xml '<ROTATE>0</ROTATE>' INTO xml.

      CONCATENATE xml '</CSV>' INTO xml.
    ENDIF.

    CONCATENATE xml '</GDGSIG>' INTO xml.
    "--------------------------------------------------------------------------------------------
    "FI montatge de l'XML que s'enviarà a signar
    "--------------------------------------------------------------------------------------------



    DATA c_xstring TYPE xstring.
    CALL FUNCTION 'SCMS_STRING_TO_XSTRING'
      EXPORTING
        text   = xml
      IMPORTING
        buffer = c_xstring.

    DATA : c_string TYPE string.
    DATA flen TYPE i.
    CALL FUNCTION 'SCMS_XSTRING_TO_BINARY'
      EXPORTING
        buffer        = c_xstring
      IMPORTING
        output_length = flen
      TABLES
        binary_tab    = ssfbin.
    l_long = flen.

    "-----------------------------------
    "Signatura del document ja preparat
    "-----------------------------------
    CALL METHOD me->ssf_sign
      EXPORTING
        filelength = l_long
      CHANGING
        filedata   = ssfbin.

    IF st_ssfparms-outdatalen > 0.

      doc_legth = st_ssfparms-outdatalen.

      REFRESH lt_bin_content.
      CALL METHOD cl_rmps_general_functions=>convert_255_to_1022
        EXPORTING
          im_tab_255  = ssfbin
        RECEIVING
          re_tab_1022 = lt_bin_content.

      CALL METHOD cl_rmps_general_functions=>convert_1022_raw_to_xstring
        EXPORTING
          im_tab_1022 = lt_bin_content
        IMPORTING
          ex_xstring  = doc_raw.
      doc_legth = xstrlen( doc_raw ).

      IF sy-subrc <> 0.
        rc = abap_false.
      ELSE.
        rc = abap_true.
      ENDIF.
    ELSE.
      rc = abap_false.
    ENDIF.

  ENDMETHOD.


  METHOD get_autoritzacio.
    DATA: lv_name    TYPE xubname,
          lv_user_id TYPE usr02-bname,
          lv_numusers TYPE i.

    CALL FUNCTION 'PTRV_CONVERT_PERNR_TO_USERID'
      EXPORTING
        personnel_number  = iv_pernr
        validity_date     = sy-datum
      IMPORTING
        user_id           = lv_user_id
      EXCEPTIONS
        user_id_not_found = 1
        OTHERS            = 2.
    IF sy-subrc <> 0.
      "No se encuentra el usuario de sap
      RAISE  no_userid.

    ELSE.

      lv_name = lv_user_id && '_SOFT'.

      SELECT COUNT(*) FROM zgdgusers INTO lv_numusers
*       WHERE bname = lv_user_id
      WHERE ( bname = lv_user_id OR bname = lv_name )
      AND sysysid = sy-sysid.
*      IF lv_numusers < 2.
        if sy-subrc ne 0.
        RAISE no_auth.
      ENDIF.
    ENDIF.
  ENDMETHOD.


  METHOD get_demora_ssf.
    DATA: lt_data TYPE TABLE OF zgdg_demora_ssf.

    " LLegir Taula de Demores en la Signatura
    SELECT * INTO TABLE lt_data FROM zgdg_demora_ssf
             WHERE zgdg_data_demora = sy-datum
              AND zgdg_demora = abap_true.

    " Omplir codi de retorn
    ev_rc = sy-subrc.

    " En el cas de que hi hagi registre
    CHECK sy-subrc = 0.

    " Ordenar per hora més recent
    SORT lt_data BY zgdg_hora_demora DESCENDING.

    " Retornar el Registre més recent
    READ TABLE lt_data INTO ev_data INDEX 1.

  ENDMETHOD.


  METHOD get_dni_from_user.

    DATA: lv_user  TYPE syuname,
          lt_users TYPE pernr_us_tab,
          ls_user  TYPE pernr_us,
          lv_dni   TYPE prdni,
          lv_dni2  TYPE prdni,
          lv_line  TYPE i,
          lv_resp  TYPE c.

    "Treballem amb el paràmetre d'entrada
    "variable 'pont' per si debuguem
    lv_user = iv_usuari.

    CALL FUNCTION 'HR_GET_EMPLOYEES_FROM_USER'
      EXPORTING
        user   = lv_user
        begda  = sy-datum
        endda  = sy-datum
      TABLES
        ee_tab = lt_users.

    READ TABLE lt_users INTO ls_user INDEX 1.
    IF sy-subrc = 0.

      SELECT SINGLE perid
       FROM pa0002 AS a
        INNER JOIN pa0000 AS b ON b~pernr = a~pernr
          INTO lv_dni
            WHERE a~pernr  = ls_user-pernr
             AND  a~begda <= sy-datum
             AND  a~endda >= sy-datum
             AND  b~begda <= sy-datum
             AND  b~endda >= sy-datum
             AND  stat2 = '3'
             AND  massn <> '10'.

      SPLIT lv_dni AT space INTO lv_dni lv_dni2.
      IF sy-subrc = 0 AND lv_dni IS NOT INITIAL.
        ev_dni = lv_dni.
      ELSE.
        RAISE zgdg_dni.
      ENDIF.

    ENDIF.

  ENDMETHOD.


  METHOD get_evidencia.


    DATA: fm_name         TYPE rs38l_fnam,      " CHAR 30 0 Name of Function Module
          fp_docparams    TYPE sfpdocparams,    " Structure  SFPDOCPARAMS Short Description  Form Parameters for Form Processing
          fp_outputparams TYPE sfpoutputparams " Structure  SFPOUTPUTPARAMS Short Description  Form Processing Output Parameter
*      it_mari           TYPE zmari_tbl
          .       " Table Type ZMARI_TBL MARI Table Tyoe
* Sets the output parameters and opens the spool job
    IF i_gdg_docs IS INITIAL.
      MESSAGE 'Seleccioni un document' TYPE 'S'.
      EXIT.
    ENDIF.
    CALL FUNCTION 'FP_JOB_OPEN'                   "& Form Processing: Call Form
      CHANGING
        ie_outputparams = fp_outputparams
      EXCEPTIONS
        cancel          = 1
        usage_error     = 2
        system_error    = 3
        internal_error  = 4
        OTHERS          = 5.
    IF sy-subrc <> 0.
      EXIT.
    ENDIF.
*&---- Get the name of the generated function module
    CALL FUNCTION 'FP_FUNCTION_MODULE_NAME'           "& Form Processing Generation
      EXPORTING
        i_name     = 'ZGDG_EVIDENCIA'
      IMPORTING
        e_funcname = fm_name.
    IF sy-subrc <> 0.
*  <error handling>
    ENDIF.
*-- Fetch the Data and store it in the Internal Table

* Language and country setting (here US as an example)
    fp_docparams-langu   = 'E'.
    fp_docparams-country = 'US'.
*&--- Call the generated function module


    DATA ls_doc TYPE zgdg_docs.
    CALL FUNCTION fm_name
      EXPORTING
        /1bcdwb/docparams = fp_docparams
        doc_ref           = i_gdg_docs
*    IMPORTING
*       /1BCDWB/FORMOUTPUT       =
      EXCEPTIONS
        usage_error       = 1
        system_error      = 2
        internal_error    = 3.
    IF sy-subrc <> 0.
*  <error handling>
    ENDIF.
*&---- Close the spool job
    CALL FUNCTION 'FP_JOB_CLOSE'
*    IMPORTING
*     E_RESULT             =
      EXCEPTIONS
        usage_error    = 1
        system_error   = 2
        internal_error = 3
        OTHERS         = 4.
    IF sy-subrc <> 0.
*            <error handling>
    ENDIF.
  ENDMETHOD.


  METHOD get_nom_carrec.


    DATA: l_user           TYPE          sysid,
          org_assignment   TYPE TABLE OF bapip0001b,
          l_org_assignment TYPE          bapip0001b,
          lt_personal_data TYPE TABLE OF bapip0002b,
          ls_personal_data TYPE          bapip0002b,
          l_pa0002         TYPE          pa0002,
          l_nom            TYPE          string,
          l_pos            TYPE          string,
          l_div            TYPE          string,
          lv_size          TYPE          i,
          ls_font_sign     TYPE          zparam_font_sign,
          lv_nodate        TYPE          string,
          lv_font          TYPE          string,
          lv_stylo         TYPE          string,
          lv_color         TYPE          string,
          lv_midaf         TYPE          string.


    "Verifiquem que la funcionalitat está activa
    SELECT SINGLE COUNT(*) FROM zsap_dt_param_hc
      WHERE repid = 'ZGDG_CARRECS' AND field_info = 'ACTIU'
      AND value = 'X'.
    IF sy-subrc <> 0.
      CLEAR xml.
      IF i_web_hash-orientacio = 'V'.
        xml = '<FONT>8</FONT>'.
      ENDIF.
      EXIT.
    ENDIF.

    l_user = zgdgusers-bname.
    REPLACE ALL OCCURRENCES OF '_SOFT' IN l_user WITH ''.

    IF l_user IS INITIAL.
      l_user = sy-uname.
    ENDIF.

    CALL FUNCTION 'BAPI_EMPLOYEE_GETDATA'
      EXPORTING
        userid         = l_user
      TABLES
        org_assignment = org_assignment
        personal_data  = lt_personal_data.

    READ TABLE lt_personal_data INTO ls_personal_data INDEX 1.



*****************************
* NOM
*****************************
    "Primer mirem si el seu nom te alguna parametrització especial
    SELECT SINGLE description FROM zgdg_carrecs INTO l_nom WHERE otype = 'P' AND objid = ls_personal_data-perno.
    IF sy-subrc <> 0. "En caso contrario, recuperamos el nombre estandard.
      SELECT SINGLE * FROM pa0002 INTO l_pa0002 WHERE pernr = ls_personal_data-perno AND begda <= sy-datum AND endda >= sy-datum.
      CONCATENATE l_pa0002-vorna  l_pa0002-nachn   l_pa0002-nach2 INTO l_nom SEPARATED BY space.
    ENDIF.



*****************************
* POSICIó
*****************************
    "Primer mirem si el seu carrec te alguna parametrització especial
    SELECT SINGLE description FROM zgdg_carrecs INTO l_pos WHERE otype = 'S' AND selected = 'X' AND uname = l_user.
    IF sy-subrc <> 0. "En caso contrario, recuperamos el estandard
      READ TABLE org_assignment INTO l_org_assignment INDEX 1.
      "Miramos si tiene alguna descripción verbal específica
      DATA lt_text TYPE TABLE OF pt1002.
      DATA ls_text TYPE          pt1002.
      CALL FUNCTION 'HR_RU_GET_DETAIL_DESCR'
        EXPORTING
          plvar         = '01'
          otype         = 'S'
          objid         = l_org_assignment-position
          subty         = '0125'
        TABLES
          descr_tx      = lt_text
        EXCEPTIONS
          nothing_found = 1
          infty_empty   = 2
          undefined     = 3
          OTHERS        = 4.
      IF sy-subrc <> 0 OR lt_text[] IS INITIAL.
        SELECT SINGLE stext INTO  l_pos FROM hrp1000  WHERE plvar = '01' AND otype = 'S'
         AND objid = l_org_assignment-position  AND begda <= sy-datum AND endda >= sy-datum.
      ELSE.
        LOOP AT lt_text INTO ls_text.
          CONCATENATE l_pos ls_text-tline INTO l_pos.
        ENDLOOP.
      ENDIF.
    ENDIF.


*****************************
* DIVISIó
*****************************
    "Primer mirem si el seu carrec te alguna parametrització especial
    ">> SPEC-75907, Inici Modificació - ETODR
    CLEAR: l_div.
*    SELECT SINGLE description FROM zgdg_carrecs INTO l_pos WHERE otype = 'O' AND selected = 'X' AND uname = l_user.
    SELECT SINGLE description FROM zgdg_carrecs INTO l_div WHERE otype = 'O' AND selected = 'X' AND uname = l_user.
    "<< SPEC-75907, Final Modificació - ETODR
    IF sy-subrc <> 0. "En caso contrario, recuperamos el estandard
      READ TABLE org_assignment INTO l_org_assignment INDEX 1.
      "Miramos si tiene alguna descripción verbal específica
      CLEAR: lt_text, ls_text.
      CALL FUNCTION 'HR_RU_GET_DETAIL_DESCR'
        EXPORTING
          plvar         = '01'
          otype         = 'O'
          objid         = l_org_assignment-position
          subty         = '0125'
        TABLES
          descr_tx      = lt_text
        EXCEPTIONS
          nothing_found = 1
          infty_empty   = 2
          undefined     = 3
          OTHERS        = 4.
      IF sy-subrc <> 0 OR lt_text[] IS INITIAL.
        SELECT SINGLE stext INTO  l_div FROM hrp1000  WHERE plvar = '01' AND otype = 'O'
         AND objid = l_org_assignment-org_unit  AND begda <= sy-datum AND endda >= sy-datum.
      ELSE.
        LOOP AT lt_text INTO ls_text.
          CONCATENATE l_div  ls_text-tline INTO l_div .
        ENDLOOP.
      ENDIF.
    ENDIF.


    "Si la determinación de nombre y cargo falla, lo dejamos igual que antes.
    IF l_nom IS INITIAL OR l_pos IS INITIAL.
      CLEAR xml.
      IF i_web_hash-orientacio = 'V'.
        xml = '<FONT>8</FONT>'.
      ENDIF.
      EXIT.
    ENDIF.


    "Genero

    DATA l_genero TYPE gesch.
    SELECT SINGLE gesch  FROM pa0002  INTO l_genero WHERE pernr = ls_personal_data-perno
      AND  begda <= sy-datum AND endda >= sy-datum.

    IF l_genero = '2'. "Si es Femení
      CASE l_pos.
        WHEN 'Administratiu/va'.
          l_pos = 'Administrativa'.
        WHEN 'Tècnic/a'.
          l_pos = 'Tècnica'.
        WHEN 'Auxiliar Tècnic/a'.
          l_pos = 'Auxiliar Tècnica'.
        WHEN OTHERS.
      ENDCASE.

    ELSE. "Si es Masculí
      CASE l_pos.
        WHEN 'Administratiu/va'.
          l_pos = 'Administratiu'.
        WHEN 'Tècnic/a'.
          l_pos = 'Tècnic'.
        WHEN 'Auxiliar Tècnic/a'.
          l_pos = 'Auxiliar Tècnic'.
        WHEN OTHERS.
      ENDCASE.
    ENDIF.


    "Conformamos el XML

    lv_size = strlen( l_div ) + strlen( l_nom ) + strlen( l_pos ).

    SELECT SINGLE *
      FROM zparam_font_sign
      INTO ls_font_sign
     WHERE mida = i_web_hash-mida
       AND char_min LT lv_size
       AND char_max GT lv_size
       AND orientacio = i_web_hash-orientacio.

    lv_nodate = ls_font_sign-nodate.
    CONDENSE lv_nodate.
    lv_font = ls_font_sign-font.
    CONDENSE lv_font.
    lv_color = ls_font_sign-color.
    CONDENSE lv_color.
    lv_stylo = ls_font_sign-style.
    CONDENSE lv_stylo.
    lv_midaf = ls_font_sign-midaf.
    CONDENSE lv_midaf.

    "INI SPEC-70679 - Correcció punts
    IF i_web_hash-orientacio = 'V'. "Si es vertical
      REPLACE ALL OCCURRENCES OF '.' IN l_nom WITH space.
      REPLACE ALL OCCURRENCES OF '.' IN l_pos WITH space.
      REPLACE ALL OCCURRENCES OF '.' IN l_div WITH space.
    ENDIF.
    "FIN SPEC-70679 - Correcció punts


    CONCATENATE '<GDGNODATE>' lv_nodate '</GDGNODATE><GDGTEXT>  ' l_nom INTO xml RESPECTING BLANKS.
*    CONCATENATE '<GDGNODATE>0</GDGNODATE><GDGTEXT>  ' l_nom INTO xml RESPECTING BLANKS.
    CONCATENATE xml '<BR>  '  l_pos  INTO xml RESPECTING BLANKS.
    CONCATENATE xml '<BR>  '  l_div '<BR>  ' '</GDGTEXT>' INTO xml RESPECTING BLANKS.


    "Finalment afegim el paràmetres de lletra per defecte
    CONCATENATE xml '<FONTTYPE>' lv_font '</FONTTYPE>'
                    '<STYLO>' lv_stylo '</STYLO>'
                    '<COLOR>' lv_color '</COLOR>'            INTO xml.



*    IF i_web_hash-mida = 'P'.
    CONCATENATE xml '<FONT>' lv_midaf '</FONT>' INTO xml.
*    ELSE.
*      CONCATENATE xml '<FONT>7</FONT>' INTO xml.
*    ENDIF.

  ENDMETHOD.


  METHOD get_page_from_pdf.
*

    DATA l_string TYPE string.
    CALL FUNCTION 'CRM_IC_XML_XSTRING2STRING'
      EXPORTING
        inxstring = i_data
      IMPORTING
        outstring = l_string.

    DATA it_result TYPE match_result_tab.
    DATA ls_result TYPE LINE OF match_result_tab.

    FIND '/Count' IN l_string IN CHARACTER MODE RESULTS it_result.

    DATA l_pos TYPE i.
    DATA l_num TYPE i VALUE 1.


    LOOP AT it_result INTO ls_result.

      l_pos = ls_result-offset + ls_result-length + 1.

      DO 4 TIMES.

        IF l_string+l_pos(l_num) CO '0123456789'.
          pages = l_string+l_pos(l_num).
          add 1 to l_num.
        ENDIF.
      ENDDO.
    ENDLOOP.

*    DATA : go_fp TYPE REF TO if_fp.
*    DATA : go_pdf_object TYPE REF TO if_fp_pdf_object.
*
*    DATA l_pdldata  TYPE xstring.
*
*
*    go_fp = cl_fp=>get_reference( ).
*    go_pdf_object = go_fp->create_pdf_object( ).
*    go_pdf_object->set_template( xftdata = i_data ).
*    go_pdf_object->set_document( pdfdata = i_data ).
*
*    go_pdf_object->set_task_renderpdf( ).
*
**    rpdl( pdltype = 'pdf'
**                                       xdcname = 'hppcl5c.xdc' ).
*
*    go_pdf_object->execute( ).
*    go_pdf_object->get_pdf( IMPORTING pdfdata =  l_pdldata renderpagecount = pages ).


  ENDMETHOD.


  METHOD get_signatures_temps.
* Creat per .............: ECDRB
* Data de creació ..: 03.06.2020
* Descripció ..........: Recuperar el temps que es triga en signar
* SPEC relacionat..: SPEC-59184
    DATA: lv_docclass TYPE bapidclass,
          lv_objectid TYPE bapiguid.

    DATA: lt_docs           TYPE zty_gdg_docs,
          ls_docs           LIKE LINE OF lt_docs,
          lt_doc_signatures TYPE zt_zgdg_demora_ssf,
          ls_doc_signatures TYPE zgdg_demora_ssf.

    FIELD-SYMBOLS <fs_signatures> TYPE zgdg_demora_ssf.

    lv_docclass = iv_docclass.
    lv_objectid = iv_objectid.

    ">>>SPEC:67261, Inici modificació - ECACM
    SELECT *
    FROM zgdg_docs
    INTO TABLE lt_docs
    WHERE docclass  = lv_docclass
    AND objectid = lv_objectid
    AND version = iv_version
    AND data_signatura <> '00000000'.

    "S'obtenen els temps que s'ha trigat en signar un document per cada signatari
    SELECT *
    FROM zgdg_demora_ssf
    INTO TABLE lt_doc_signatures
    WHERE zgdg_objectid = lv_objectid
      AND zgdg_class_id = lv_docclass
      AND zgdg_demora = abap_false.

    LOOP AT lt_docs INTO ls_docs.

      APPEND INITIAL LINE TO et_doc_signatures ASSIGNING <fs_signatures>.
      <fs_signatures>-zgdg_hora_demora = ls_docs-hora_signatura.
      <fs_signatures>-zgdg_data_demora = ls_docs-data_signatura.
      <fs_signatures>-zgdg_usuari = ls_docs-usuari.

      READ TABLE lt_doc_signatures INTO ls_doc_signatures WITH KEY zgdg_objectid = lv_objectid
                                                                   zgdg_class_id = lv_docclass.

      IF sy-subrc EQ 0.
        <fs_signatures>-zgdg_duracio_signa = ls_doc_signatures-zgdg_duracio_signa.
      ENDIF.

    ENDLOOP.

    "<<<SPEC:67261, Final modificació - ECACM

  ENDMETHOD.


  METHOD guardar_fitxer_log_servidor.

    DATA: lv_string_ruta TYPE string,
          lv_length      TYPE i,
          lv_doc         TYPE xstring,
          lv_value       TYPE zsap_de_value,
          lv_value2      TYPE zsap_de_value,
          lv_url         TYPE text200,
          lv_extensio    TYPE char10.

    DATA: wp_index TYPE wpinfo-wp_index.
    DATA: wp_info TYPE wpinfo.

    lv_length = z_size.

    IF z_binari IS NOT INITIAL.
      CALL FUNCTION 'SCMS_BINARY_TO_XSTRING'
        EXPORTING
          input_length = lv_length
        IMPORTING
          buffer       = lv_doc
        TABLES
          binary_tab   = z_binari.
*      lv_extensio = '.pdf'.
    ELSE.
      lv_doc = z_xstring.
*      lv_extensio = '.xml'.
    ENDIF.

    lv_extensio = z_extensio.

    SELECT SINGLE value value2
     FROM zsap_dt_param_hc
     INTO ( lv_value, lv_value2 )
    WHERE repid = 'GUARDAR_FITXER_LOG_SERVIDOR'
         AND field_info = sy-sysid.
*          \\SRVPOPROD01.gisa.org\sapintegracion\GDG

    CHECK sy-subrc = 0.

    lv_url = lv_value && lv_value2.


    CALL FUNCTION 'TH_GET_OWN_WP_NO'
      IMPORTING
        wp_index = wp_index.

    CALL FUNCTION 'TH_WP_DETAIL_INFO'
      EXPORTING
        wp_index = wp_index
      IMPORTING
        wpinfo   = wp_info
      EXCEPTIONS
        OTHERS   = 99.

    lv_string_ruta = lv_url
    && '\' && z_accio && '_' && _tipus && '_' && wp_info-wp_pid && '_' && z_docid && '_' && sy-datum &&  '_' &&  sy-uzeit && lv_extensio.

    OPEN DATASET lv_string_ruta  FOR OUTPUT IN BINARY MODE.
    IF sy-subrc IS NOT INITIAL.
*      MESSAGE 'No s''ha pogut enviar el document al servidor de PDF'(PDF) TYPE 'I'.
      EXIT.
    ENDIF.

    TRANSFER lv_doc TO lv_string_ruta .
    IF sy-subrc IS NOT INITIAL.
      CLOSE DATASET lv_string_ruta.
      EXIT.
    ENDIF.

    CLOSE DATASET lv_string_ruta.


  ENDMETHOD.


  METHOD guardar_log_zgdg_docs.

    DATA: s_zgdg_reg_log   TYPE zgdg_reg_log,
          s_abap_callstack TYPE abap_callstack_line.

    READ TABLE is_abap_callstack INTO s_abap_callstack INDEX 1.

    MOVE-CORRESPONDING s_abap_callstack  TO s_zgdg_reg_log.
    MOVE-CORRESPONDING is_zgdg_docs TO s_zgdg_reg_log.
    ">> SPEC-75138, Inici Modificació - ETODR
    s_zgdg_reg_log-resultat = iv_resultat.
    s_zgdg_reg_log-data_log = sy-datum.
    s_zgdg_reg_log-hora_log = sy-uzeit.
    "<< SPEC-75138, Final Modificació - ETODR

    INSERT INTO zgdg_reg_log VALUES s_zgdg_reg_log.

  ENDMETHOD.


  method GUARDAR_TXT_LOG_SERVIDOR.
  endmethod.


  METHOD lock_unlock_doc.

    DATA lt_prop_doc     TYPE STANDARD TABLE OF bapiproptb.
    DATA lif_sp_document TYPE REF TO if_srm_sp_document.
    DATA: lv_resultat     TYPE zlog_global-resultat. "ETODR SPEC-67085

    ">> SPEC-67085, Inici Modificació - ETODR
    IF go_log_global IS BOUND.
      go_log_global->crea_clau( EXPORTING iv_objectid   = zguid
                                          iv_docclass   = zdocclass
                                IMPORTING es_log_clau   = DATA(ls_log_clau) ).

      go_log_global->afegir_entrada( EXPORTING  iv_tasca = zglog_tasca_inicial
                                                is_clau  = ls_log_clau
                                     EXCEPTIONS OTHERS   = 0 ).
    ENDIF.
    "<< SPEC-67085, Final Modificació - ETODR

    CALL FUNCTION 'BAPI_SRM_DOC_GETPROPERTIES'
      EXPORTING
        objectid      = zguid
        documentclass = zdocclass
*       whole_document = 'X'
      TABLES
        properties    = lt_prop_doc.

    READ TABLE lt_prop_doc TRANSPORTING NO FIELDS WITH KEY name  = 'SRM_DOCUMENT_STATE'
                                                           value = 'frozen'.
    IF sy-subrc = 0.
      are_locked = abap_true.
    ENDIF.
    CALL METHOD zrm_cl_gmd=>get_content_connection_documen
      EXPORTING
        im_objectid = zguid
        im_docclass = zdocclass
      RECEIVING
        re_document = lif_sp_document.

    IF unlock = abap_true AND are_locked = abap_true.

      TRY.
          lif_sp_document->open( for_update = if_srm=>true ) .
          lif_sp_document->update_state_closed( im_do_close = if_srm=>false ).
          lif_sp_document->close(  ).
        CATCH cx_srm.
          lv_resultat = zglog_resultat_ko. "ETODR SPEC-67085
      ENDTRY.
    ENDIF.
    IF are_locked = abap_true AND lock = abap_true.
      TRY.
          lif_sp_document->open( for_update = if_srm=>true ) .

          lif_sp_document->update_state_closed( im_do_close = if_srm=>true ).
          lif_sp_document->close(  ).
        CATCH cx_srm.
          lv_resultat = zglog_resultat_ko. "ETODR SPEC-67085
      ENDTRY.
    ENDIF.

    ">> SPEC-67085, Inici Modificació - ETODR
    IF go_log_global IS BOUND.
      go_log_global->afegir_entrada( EXPORTING  iv_tasca = zglog_tasca_final
                                              iv_resultat = lv_resultat
                                                is_clau  = ls_log_clau
                                     EXCEPTIONS OTHERS   = 0 ).
    ENDIF.
    "<< SPEC-67085, Final Modificació - ETODR



  ENDMETHOD.


  METHOD OLD_FIRMA_DOCS_CS.

    DATA: lt_components  TYPE TABLE OF bapidoccomp,
          lt_bin_content TYPE TABLE OF bapiconten.

    DATA: lv_xml     TYPE string,
          lv_content TYPE string,
          lv_aux     TYPE string.
    FIELD-SYMBOLS <fs>    TYPE  bapidoccomp.
    FIELD-SYMBOLS: <firma_docs>  LIKE LINE OF firma_docs,
                   <bin_content> LIKE LINE OF lt_bin_content.

    LOOP AT firma_docs ASSIGNING <firma_docs>.

      CLEAR: lt_components, lt_bin_content.

      CALL FUNCTION 'SRM_DOCUMENT_CHECKOUT_VIA_TAB'
        EXPORTING
          objectid        = <firma_docs>-z_docid
          documentclass   = <firma_docs>-z_classid
        TABLES
          components      = lt_components
          bin_content     = lt_bin_content
        EXCEPTIONS
          internal_error  = 1
          parameter_error = 2
          not_authorized  = 3
          doc_not_found   = 4
          OTHERS          = 5.

      LOOP AT lt_bin_content ASSIGNING <bin_content>.
        lv_aux = <bin_content>-line.
        CONCATENATE lv_content lv_aux INTO lv_content.
        CLEAR: lv_aux.
      ENDLOOP.

      <firma_docs>-z_bin_content = lv_content.

      CLEAR: lv_content.
      READ TABLE lt_components ASSIGNING <fs> INDEX 1.



    " Convertir LT_BIN_CONTENT 1022 TO 255
      DATA : xtab TYPE solix_tab.
      CALL METHOD cl_rmps_general_functions=>convert_1022_to_255
        EXPORTING
          im_tab_1022 = lt_bin_content
        RECEIVING
          re_tab_255 = xtab.
      DESCRIBE TABLE xtab.
*    " Encontrar longitud de XTAB
*      CALL METHOD cl_gui_frontend_services=>file_get_size
*        EXPORTING
*          file_name  = xtab
*        IMPORTING
*          file_size  = flen.

    " Convertir de binario a xstring
      DATA :  c_xstring TYPE xstring.
      DATA : flen TYPE i.
      CALL FUNCTION 'SCMS_BINARY_TO_XSTRING'
        EXPORTING
          input_length = <fs>-comp_size
        IMPORTING
          buffer       = c_xstring
        TABLES
          binary_tab   = xtab
        EXCEPTIONS
          failed       = 1
          OTHERS       = 2.

    " Conversió :  XSTRING a BASE64
      DATA: utility TYPE REF TO cl_http_utility.
      DATA l_string TYPE string.

      CREATE OBJECT utility.

      CALL METHOD utility->encode_x_base64
        EXPORTING
          unencoded = c_xstring
        RECEIVING
          encoded = l_string.

      <firma_docs>-z_bin_content = l_string.

    ENDLOOP.

  " Creació XML
    CALL METHOD create_xml
      EXPORTING
        firma_docs = firma_docs
      IMPORTING
        xml        = lv_xml.

  " Conversió :  BASE64 to STRING
*    CALL METHOD utility->encode_base64
*      EXPORTING
*        unencoded = lv_xml
*      RECEIVING
*        encoded = l_string.

  " Conversió :  STRING to XSTRING
    CALL FUNCTION 'SCMS_STRING_TO_XSTRING'
      EXPORTING
        text = lv_xml
      IMPORTING
        buffer = c_xstring.

  " Conversió :  XSTRING to BINARY
    DATA : c_string TYPE string.
    CALL FUNCTION 'SCMS_XSTRING_TO_BINARY'
      EXPORTING
        buffer        = c_xstring
      IMPORTING
        output_length = flen
      TABLES
        binary_tab    = xtab.

*        " Descargar archivo a local (devuelve archivo en binario)
*          cl_gui_frontend_services=>gui_download(
*            EXPORTING
*              filename    = 'C:\Users\Datamon\Desktop\MARC_V3.pdf'
*              filetype    = 'BIN'
*            IMPORTING
*              filelength  = flen
*            CHANGING
*              data_tab    = xtab ).

  " Firmar
    CALL METHOD me->ssf_sign
      EXPORTING
        filelength = flen
      CHANGING
        filedata   = xtab.

*        " Descargar archivo a local (devuelve archivo en binario)
          cl_gui_frontend_services=>gui_download(
            EXPORTING
              filename    = 'C:\Users\Datamon\Desktop\MARC_V4.pdf'
              filetype    = 'BIN'
*            IMPORTING
*              filelength  = st_ssfparms-outdatalen
            CHANGING
              data_tab    = xtab ).

  ENDMETHOD.


  METHOD registrar_temps_signar.
* Creat per .............: ECDRB
* Data de creació ..: 03.06.2020
* Descripció ..........: Guardar el temps que es triga en signar
* SPEC relacionat..: SPEC-59184
    DATA: ls_data TYPE zgdg_demora_ssf.
    ls_data = is_data.
    "S'inserta a taula el temps que s'ha trigat en signar un document
    "El temps s'emplena al camp zgdg_duracio_signa abans de cridar a aquest mètode

    "Afegim 1 segon perquè no hi hagi problemes amb la clau primària de la
    "taula
    ls_data-zgdg_data_demora = sy-datum.
    ls_data-zgdg_hora_demora = sy-uzeit + 1.
    ls_data-zgdg_usuari = sy-uname.
    ls_data-zgdg_demora = abap_false.

    INSERT zgdg_demora_ssf FROM ls_data.
  ENDMETHOD.


  METHOD save_document.

***     Preparat per probar !!!!!!
**
***    DATA: l_answer TYPE c.

***    break etxgl.
***
***    CALL FUNCTION 'POPUP_TO_CONFIRM'
***      EXPORTING
***        titlebar              = 'Que dessitja fer?'
***        diagnose_object       = ' '
***        text_question         = 'Descarregar Document'
***        text_button_1         = 'Si'(001)
***        icon_button_1         = 'ICON_CHECKED'
***        text_button_2         = 'No'(002)
***        icon_button_2         = 'ICON_INCOMPLETE'
***        default_button        = '1'
***        display_cancel_button = ' '
***        userdefined_f1_help   = ' '
***        start_column          = 25
***        start_row             = 6
***        iv_quickinfo_button_1 = 'Si'
***        iv_quickinfo_button_2 = 'No'
***      IMPORTING
***        answer                = l_answer
****          TABLES
****       PARAMETER             =
***      EXCEPTIONS
***        text_not_found        = 1
***        OTHERS                = 2.
***
***    IF l_answer = 1.
***
***      DATA: filesize TYPE i.
***      DATA: filestrg TYPE string.
***      DATA: fileleng TYPE i.
***
***      filesize = st_ssfparms-outdatalen.
***
***      IF ( doc_raw IS NOT INITIAL
***       AND doc_legth IS NOT INITIAL ).
***
***
***        CALL FUNCTION 'GUI_DOWNLOAD'
***          EXPORTING
***            bin_filesize            = filesize
***            filename                = 'C:\desktop\test.pdf'
***            filetype                = 'BIN'
***          TABLES
***            data_tab                = doc_raw
***          EXCEPTIONS
***            file_write_error        = 1
***            no_batch                = 2
***            gui_refuse_filetransfer = 3
***            invalid_type            = 4
***            no_authority            = 5
***            unknown_error           = 6
***            header_not_allowed      = 7
***            separator_not_allowed   = 8
***            filesize_not_allowed    = 9
***            header_too_long         = 10
***            dp_error_create         = 11
***            dp_error_send           = 12
***            dp_error_write          = 13
***            unknown_dp_error        = 14
***            access_denied           = 15
***            dp_out_of_memory        = 16
***            disk_full               = 17
***            dp_timeout              = 18
***            file_not_found          = 19
***            dataprovider_exception  = 20
***            control_flush_error     = 21
***            OTHERS                  = 22.
***
***        LEAVE SCREEN.
***
***      ELSE.
***
***        CALL FUNCTION 'GUI_DOWNLOAD'
***          EXPORTING
***            bin_filesize            = filesize
***            filename                = 'C:\desktop\test.pdf'
***            filetype                = 'BIN'
***          TABLES
***            data_tab                = lt_bin_content
***          EXCEPTIONS
***            file_write_error        = 1
***            no_batch                = 2
***            gui_refuse_filetransfer = 3
***            invalid_type            = 4
***            no_authority            = 5
***            unknown_error           = 6
***            header_not_allowed      = 7
***            separator_not_allowed   = 8
***            filesize_not_allowed    = 9
***            header_too_long         = 10
***            dp_error_create         = 11
***            dp_error_send           = 12
***            dp_error_write          = 13
***            unknown_dp_error        = 14
***            access_denied           = 15
***            dp_out_of_memory        = 16
***            disk_full               = 17
***            dp_timeout              = 18
***            file_not_found          = 19
***            dataprovider_exception  = 20
***            control_flush_error     = 21
***            OTHERS                  = 22.
***
***        LEAVE SCREEN.
***
***      ENDIF.
***    ELSE.
***      LEAVE SCREEN.
***    ENDIF.


  ENDMETHOD.


  METHOD set_demora_ssf.
    CONSTANTS: lc_accio_alta          TYPE abap_bool VALUE 'I',
               lc_accio_actu          TYPE abap_bool VALUE 'U',
               lc_repid               TYPE repid VALUE 'SSFSIGN',
               lc_correu_inici_demora TYPE string VALUE 'INICI_DEMORA',
               lc_correu_fi_demora    TYPE string VALUE 'FI_DEMORA'.
    DATA: lt_data            TYPE TABLE OF zgdg_demora_ssf,
          ls_data            TYPE zgdg_demora_ssf,
          lv_data            TYPE datum,
          lv_rc              TYPE sysubrc,
          lc_field_info      TYPE zsap_de_field VALUE 'SSFDEMORA_NUM_OK',
          lv_intents_param   TYPE num03,
          lt_demores         TYPE zsap_tt_param_hc,
          ls_demores         TYPE LINE OF zsap_tt_param_hc,
          ls_data_ult_demora TYPE zgdg_demora_ssf.

    ls_data = cv_data.

    IF iv_accio = lc_accio_alta. " Donar d'alta a la Taula de Demores

      " El comptador es posarà a 0, es marcarà el camp DEMORA i els
      " camps DATA i HORA DEMORA amb els que facilita el propi sistema
      CLEAR: ls_data-zgdg_comptador,
             ls_data-zgdg_hora_reparat,
             ls_data-zgdg_reparat.

      "Fixem la data i la hora inicial
      ls_data-zgdg_data_demora = sy-datum.
      ls_data-zgdg_hora_demora = ls_data-zgdg_inici_demora = sy-uzeit.

      ls_data-zgdg_usuari = sy-uname.
      ls_data-zgdg_demora = abap_true.

      " Verificar que no hi hagi un registre amb els mateixos camps clau
      SELECT SINGLE zgdg_data_demora INTO lv_data FROM  zgdg_demora_ssf
             WHERE  zgdg_data_demora  = ls_data-zgdg_data_demora
             AND    zgdg_hora_demora  = ls_data-zgdg_hora_demora.

      IF sy-subrc NE 0.

* Enviar correu inici demora a DSI i CAU
* Només s'ha d'enviar el correu quan el registre més recent del dia que compleix
* que el camp ZGDG_DEMORA = 'X' té el camp ZGDG_REPARAT = '', o quan encara no
* hi ha registre de demora

        CALL METHOD me->get_demora_ssf
          IMPORTING
            ev_data = ls_data_ult_demora
          RECEIVING
            ev_rc   = lv_rc.

        "Arrastrem la data inici de la primera demora quan l'ultim registre no està reparat
        IF  lv_rc = 0 AND ls_data_ult_demora-zgdg_reparat = abap_false.
          ls_data-zgdg_inici_demora = ls_data_ult_demora-zgdg_inici_demora.
        ENDIF.

        IF ( lv_rc = 0 AND ls_data_ult_demora-zgdg_reparat = abap_true )
          OR ( lv_rc NE 0 ).

          CALL METHOD me->enviar_correu_demora
            EXPORTING
              iv_temps_demora = iv_temps_demora
              iv_tipus_correu = lc_correu_inici_demora
              is_data         = ls_data
            RECEIVING
              rv_rc           = lv_rc.
        ENDIF.

        INSERT zgdg_demora_ssf FROM ls_data.
      ENDIF.

    ELSEIF iv_accio = lc_accio_actu. " Actualitzar la Taula de Demores

      " Es sumarà 1 al comptador
      ls_data-zgdg_comptador    = ls_data-zgdg_comptador + 1.

      "obtenir el valor parametritzat del numero de OK's
      zcl_utils_parametritzacio=>get_dades_parametritzades(
      EXPORTING
        iv_repid            = lc_repid
        iv_langu            = sy-langu
      IMPORTING
        et_zsap_dt_param_hc = lt_demores
     ).

      READ TABLE lt_demores INTO ls_demores WITH KEY field_info = lc_field_info.
      lv_intents_param = ls_demores-value.

      IF ls_data-zgdg_comptador GE lv_intents_param.

        "  Si arriba al num. parametritzat, es marcarà el camp REPARAT i s'omplirà el HORA REPARAT
        ls_data-zgdg_hora_reparat = sy-uzeit.
        ls_data-zgdg_reparat = abap_true.

** Enviar correu fi demora a DSI i CAU
        CALL METHOD me->enviar_correu_demora
          EXPORTING
            iv_tipus_correu = lc_correu_fi_demora
            is_data         = ls_data
          RECEIVING
            rv_rc           = lv_rc.

      ELSE.
        "  Si no arriba a 5, no es marcarà el camp REPARAT ni el HORA REPARAT.
        CLEAR: ls_data-zgdg_hora_reparat,
               ls_data-zgdg_reparat.
      ENDIF.

      " S'actualitza la Taula de Demores
      UPDATE zgdg_demora_ssf
          SET zgdg_comptador    = ls_data-zgdg_comptador
              zgdg_hora_reparat = ls_data-zgdg_hora_reparat
              zgdg_reparat      = ls_data-zgdg_reparat
          WHERE zgdg_data_demora = ls_data-zgdg_data_demora
            AND zgdg_hora_demora = ls_data-zgdg_hora_demora.
    ENDIF.

    " Omplir codi de retorn
    rv_rc = sy-subrc.

  ENDMETHOD.


  METHOD set_format.

    _format               = i_format.
    st_ssfparms-ssfformat = i_format.

  ENDMETHOD.


  METHOD ssf_pkcs7.

    DATA:      it_signer TYPE TABLE OF ssfinfo,
               wa_signer TYPE ssfinfo,
               lv_lines  TYPE c.
    DATA filedata2 TYPE rmps_ssfbin.


    wa_signer-id      = zgdgusers-ssfid_hash.
    wa_signer-profile = zgdgusers-ssf_prof.
    APPEND wa_signer TO it_signer.



    DO 3 TIMES.
    _init( ). "Inicializamos la firma

      IF opt IS NOT INITIAL.
        CALL FUNCTION 'SSF_KRN_ENVELOPE'
          EXPORTING
            ssftoolkit                   = st_ssfparms-ssftoolkit
            str_format                   = st_ssfparms-ssfformat
            b_inenc                      = st_ssfparms-binenc
            io_spec                      = st_ssfparms-iospec
            ostr_input_data_l            = filelength
            str_pab                      = ''
            str_pab_password             = ''
          IMPORTING
            ostr_enveloped_data_l        = st_ssfparms-outdatalen
            crc                          = st_ssfparms-ssfcrc
          TABLES
            ostr_input_data              = filedata
            recipient_list               = it_signer
            ostr_enveloped_data          = filedata2
          EXCEPTIONS
            ssf_krn_error                = 399
            ssf_krn_noop                 = 201
            ssf_krn_nomemory             = 202
            ssf_krn_opinv                = 203
            ssf_krn_recipient_list_error = 207
            ssf_krn_input_data_error     = 999
            ssf_krn_invalid_par          = 209
            ssf_krn_invalid_parlen       = 210
            ssf_fb_input_parameter_error = 211
            OTHERS                       = 212.
        IF sy-subrc = 0.
          filedata =  filedata2.
          EXIT.
        ENDIF.

      ELSE.
        CALL FUNCTION 'SSF_KRN_DEVELOPE'
          EXPORTING
            ssftoolkit                   = st_ssfparms-ssftoolkit
            str_format                   = st_ssfparms-ssfformat
            b_outdec                     = st_ssfparms-boutdec
            io_spec                      = st_ssfparms-iospec
            ostr_enveloped_data_l        = filelength
          IMPORTING
            ostr_output_data_l           = st_ssfparms-outdatalen
            crc                          = st_ssfparms-ssfcrc
          TABLES
            ostr_enveloped_data          = filedata
            recipient                    = it_signer
            ostr_output_data             = filedata2
          EXCEPTIONS
            ssf_krn_error                = 399
            ssf_krn_noop                 = 201
            ssf_krn_nomemory             = 202
            ssf_krn_opinv                = 203
            ssf_krn_recipient_error      = 206
            ssf_krn_input_data_error     = 208
            ssf_krn_invalid_par          = 209
            ssf_krn_invalid_parlen       = 210
            ssf_fb_input_parameter_error = 211
            OTHERS                       = 212.

        IF sy-subrc = 0.
          filedata =  filedata2.
          EXIT.
        ENDIF.
      ENDIF.

    ENDDO.

  ENDMETHOD.


  METHOD ssf_sign.

    DATA: it_signer TYPE TABLE OF ssfinfo,
          wa_signer TYPE ssfinfo,
          lv_lines  TYPE c.
    DATA filedata2 TYPE rmps_ssfbin.

    ">> SPEC-67085, Inici Modificació - ETODR
    DATA: lv_resultat TYPE zlog_global-resultat,
          ls_log_clau TYPE zlog_global_clau.
    DATA: lt_bin_content_log TYPE TABLE OF bapiconten,
          lv_extensio        TYPE char10.

    lv_resultat         = zglog_resultat_ok.
    IF go_log_global IS BOUND.
      go_log_global->afegir_entrada( EXPORTING  iv_tasca = zglog_tasca_inicial
                                     EXCEPTIONS OTHERS   = 0 ).
    ENDIF.
    "<< SPEC-67085, Final Modificació - ETODR

    IF _tipus = 'C' OR _tipus EQ 'F'. "Centralizado
      _init( ). "Inicializamos la firma

      wa_signer-id      = zgdgusers-ssfid_hash.
      wa_signer-profile = zgdgusers-ssf_prof.
      APPEND wa_signer TO it_signer.

      IF _tipus EQ 'F'.
        st_ssfparms-binccerts = 'X'.
        st_ssfparms-bdetached = ' '.
        st_ssfparms-binenc = 'X'.
        st_ssfparms-iospec = 'T'.
        st_ssfparms-ssfhashalg = 'SHA1'.
        st_ssfparms-ssfcrc = '0'.
      ENDIF.

      "INI SPEC-90904
      """GUARDAR DOCUMENT EN SERVIDOR _PREVI_GDG 1.
      REFRESH lt_bin_content_log.
      CALL METHOD cl_rmps_general_functions=>convert_255_to_1022
        EXPORTING
          im_tab_255  = filedata
        RECEIVING
          re_tab_1022 = lt_bin_content_log.

      IF _tipus = 'U' OR _tipus = 'F'.
        lv_extensio = '.xml'.
      ELSE.
        lv_extensio = '.pdf'.
      ENDIF.

      CALL METHOD me->guardar_fitxer_log_servidor
        EXPORTING
          z_docid    = gv_objectid
          z_classid  = gv_docclass
          z_accio    = '3_1'
          z_binari   = lt_bin_content_log
          z_size     = filelength
          z_extensio = lv_extensio.
      "FI SPEC-90904

      CALL FUNCTION 'SSF_KRN_SIGN'
        EXPORTING
          ssftoolkit                   = st_ssfparms-ssftoolkit
          str_format                   = st_ssfparms-ssfformat
          b_inc_certs                  = st_ssfparms-binccerts
          b_detached                   = st_ssfparms-bdetached
          b_inenc                      = st_ssfparms-binenc
          io_spec                      = st_ssfparms-iospec
          ostr_input_data_l            = filelength "tamaño del fichero binario
          str_hashalg                  = st_ssfparms-ssfhashalg
        IMPORTING
          ostr_signed_data_l           = st_ssfparms-outdatalen
          crc                          = st_ssfparms-ssfcrc
        TABLES
          ostr_input_data              = filedata "fichero convertido a binario
          signer                       = it_signer
          ostr_signed_data             = filedata2
        EXCEPTIONS
          ssf_krn_error                = 399
          ssf_krn_noop                 = 201
          ssf_krn_nomemory             = 202
          ssf_krn_opinv                = 203
          ssf_krn_signer_list_error    = 205
          ssf_krn_input_data_error     = 208
          ssf_krn_invalid_par          = 209
          ssf_krn_invalid_parlen       = 210
          ssf_fb_input_parameter_error = 211
          OTHERS                       = 212.
      ">> SPEC-67085, Inici Modificació - ETODR
      IF sy-subrc <> 0.
        ls_log_clau-sysubrc = sy-subrc.
        lv_resultat         = zglog_resultat_ko.
      ENDIF.
      "<< SPEC-67085, Final Modificació - ETODR

      "INI SPEC-90904
      """GUARDAR DOCUMENT EN SERVIDOR _POST_GDG 2.
      REFRESH lt_bin_content_log.
      CALL METHOD cl_rmps_general_functions=>convert_255_to_1022
        EXPORTING
          im_tab_255  = filedata2
        RECEIVING
          re_tab_1022 = lt_bin_content_log.


      CALL METHOD me->guardar_fitxer_log_servidor
        EXPORTING
          z_docid    = gv_objectid
          z_classid  = gv_docclass
          z_accio    = '3_2'
          z_binari   = lt_bin_content_log
          z_size     = st_ssfparms-outdatalen
          z_extensio = '.pdf'.
      "FI SPEC-90904
    ENDIF.
    IF _tipus = 'U'. "Centralizado

*      wa_signer-id      = zgdgusers-ssfid_hash.
      wa_signer-profile = zgdgusers-ssf_prof.
      wa_signer-password = ''.
      wa_signer-result = '28'.
      APPEND wa_signer TO it_signer.
      st_ssfparms-ssftoolkit = 'gdgcrypt'.

      st_ssfparms-binccerts = 'X'.
      st_ssfparms-bdetached = ' '.
      st_ssfparms-binenc = 'X'.
      st_ssfparms-iospec = 'T'.
      st_ssfparms-ssfhashalg = 'SHA1'.
      st_ssfparms-ssfcrc = '0'.


      "INI SPEC-90904
      """GUARDAR DOCUMENT EN SERVIDOR _PREVI_GDG 1.
      REFRESH lt_bin_content_log.
      CALL METHOD cl_rmps_general_functions=>convert_255_to_1022
        EXPORTING
          im_tab_255  = filedata
        RECEIVING
          re_tab_1022 = lt_bin_content_log.


      CALL METHOD me->guardar_fitxer_log_servidor
        EXPORTING
          z_docid    = gv_objectid
          z_classid  = gv_docclass
          z_accio    = '3_1'
          z_binari   = lt_bin_content_log
          z_size     = filelength
          z_extensio = '.xml'.
      "FI SPEC-90904

      CALL FUNCTION 'SSF_SIGN'
        EXPORTING
          ssf_dest                     = 'SAP_SSFATGUI'
          str_format                   = st_ssfparms-ssfformat
          b_inc_certs                  = st_ssfparms-binccerts
          b_detached                   = st_ssfparms-bdetached
          b_inenc                      = st_ssfparms-binenc
          io_spec                      = st_ssfparms-iospec
          ostr_input_data_l            = filelength "tamaño del fichero binario
          str_hashalg                  = st_ssfparms-ssfhashalg
        IMPORTING
          ostr_signed_data_l           = st_ssfparms-outdatalen
          crc                          = st_ssfparms-ssfcrc
        TABLES
          ostr_input_data              = filedata
          signer                       = it_signer
          ostr_signed_data             = filedata2
        EXCEPTIONS
          ssf_rfc_error                = 1
          ssf_rfc_no_memory            = 2
          ssf_rfc_get_data_error       = 3
          ssf_rfc_send_data_error      = 4
          ssf_rfc_signer_list_error    = 5
          ssf_rfc_input_data_error     = 6
          ssf_fb_input_parameter_error = 7
          ssf_rfc_destination_error    = 8
          OTHERS                       = 9.

      ">> SPEC-67085, Inici Modificació - ETODR
      IF sy-subrc <> 0.
        ls_log_clau-sysubrc = sy-subrc.
        lv_resultat         = zglog_resultat_ko.
      ENDIF.
      "<< SPEC-67085, Final Modificació - ETODR

      CALL FUNCTION 'RFC_CONNECTION_CLOSE'
        EXPORTING
          destination          = 'SAP_SSFATGUI'
        EXCEPTIONS
          destination_not_open = 1
          OTHERS               = 2.
      IF sy-subrc <> 0.
        ">> SPEC-67085, Inici Modificació - ETODR
        ls_log_clau-sysubrc = sy-subrc.
        lv_resultat         = zglog_resultat_ko.
        "<< SPEC-67085, Final Modificació - ETODR
      ENDIF.


      "INI SPEC-90904
      """GUARDAR DOCUMENT EN SERVIDOR _POST_GDG 2.
      REFRESH lt_bin_content_log.
      CALL METHOD cl_rmps_general_functions=>convert_255_to_1022
        EXPORTING
          im_tab_255  = filedata2
        RECEIVING
          re_tab_1022 = lt_bin_content_log.


      CALL METHOD me->guardar_fitxer_log_servidor
        EXPORTING
          z_docid    = gv_objectid
          z_classid  = gv_docclass
          z_accio    = '3_2'
          z_binari   = lt_bin_content_log
          z_size     = st_ssfparms-outdatalen
          z_extensio = '.pdf'.
      "FI SPEC-90904

    ENDIF.



    IF st_ssfparms-outdatalen > 0 AND filedata2 IS NOT INITIAL. "Todo correcto. Marcamos la info
      filedata = filedata2.
      CLEAR lv_lines.

      CASE st_ssfparms-ssfformat.
        WHEN 'PDFTSA'.
          zgdglog-zgdg_signat_log   = 'X'.
          zgdglog-zgdg_tsa_log      = 'X'.
          zgdglog-zgdg_ltv_log      = space.

        WHEN 'STMPLTV'.
          zgdglog-zgdg_signat_log   = 'X'.
          zgdglog-zgdg_tsa_log      = space.
          zgdglog-zgdg_ltv_log      = space.

        WHEN ''.
          CLEAR zgdglog.

        WHEN OTHERS.

      ENDCASE.
    ELSE.
      CLEAR zgdglog.
      ">> SPEC-67085, Inici Modificació - ETODR
      lv_resultat = zglog_resultat_ko.
      "<< SPEC-67085, Final Modificació - ETODR
    ENDIF.

    ">> SPEC-67085, Inici Modificació - ETODR
    IF go_log_global IS BOUND.
      go_log_global->afegir_entrada( EXPORTING  iv_tasca    = zglog_tasca_final
                                                iv_resultat = lv_resultat
                                                is_clau     = ls_log_clau
                                     EXCEPTIONS OTHERS      = 0 ).
    ENDIF.
    "<< SPEC-67085, Final Modificació - ETODR

  ENDMETHOD.


  METHOD SSF_SIGN_TEST.

    DATA: it_signer TYPE TABLE OF ssfinfo,
          wa_signer TYPE ssfinfo,
          lv_lines  TYPE c.
    DATA filedata2 TYPE rmps_ssfbin.

    ">> SPEC-67085, Inici Modificació - ETODR
    DATA: lv_resultat TYPE zlog_global-resultat,
          ls_log_clau TYPE zlog_global_clau.

    lv_resultat         = zglog_resultat_ok.
    IF go_log_global IS BOUND.
      go_log_global->afegir_entrada( EXPORTING  iv_tasca = zglog_tasca_inicial
                                     EXCEPTIONS OTHERS   = 0 ).
    ENDIF.
    "<< SPEC-67085, Final Modificació - ETODR

    IF _tipus = 'C' OR _tipus EQ 'F'. "Centralizado
      _init( ). "Inicializamos la firma

      wa_signer-id      = zgdgusers-ssfid_hash.
      wa_signer-profile = zgdgusers-ssf_prof.
      APPEND wa_signer TO it_signer.

      IF _tipus EQ 'F'.
        st_ssfparms-binccerts = 'X'.
        st_ssfparms-bdetached = ' '.
        st_ssfparms-binenc = 'X'.
        st_ssfparms-iospec = 'T'.
        st_ssfparms-ssfhashalg = 'SHA1'.
        st_ssfparms-ssfcrc = '0'.
      ENDIF.

      CALL FUNCTION 'SSF_KRN_SIGN'
        EXPORTING
          ssftoolkit                   = st_ssfparms-ssftoolkit
          str_format                   = st_ssfparms-ssfformat
          b_inc_certs                  = st_ssfparms-binccerts
          b_detached                   = st_ssfparms-bdetached
          b_inenc                      = st_ssfparms-binenc
          io_spec                      = st_ssfparms-iospec
          ostr_input_data_l            = filelength "tamaño del fichero binario
          str_hashalg                  = st_ssfparms-ssfhashalg
        IMPORTING
          ostr_signed_data_l           = st_ssfparms-outdatalen
          crc                          = st_ssfparms-ssfcrc
        TABLES
          ostr_input_data              = filedata "fichero convertido a binario
          signer                       = it_signer
          ostr_signed_data             = filedata2
        EXCEPTIONS
          ssf_krn_error                = 399
          ssf_krn_noop                 = 201
          ssf_krn_nomemory             = 202
          ssf_krn_opinv                = 203
          ssf_krn_signer_list_error    = 205
          ssf_krn_input_data_error     = 208
          ssf_krn_invalid_par          = 209
          ssf_krn_invalid_parlen       = 210
          ssf_fb_input_parameter_error = 211
          OTHERS                       = 212.
      ">> SPEC-67085, Inici Modificació - ETODR
      IF sy-subrc <> 0.
        ls_log_clau-sysubrc = sy-subrc.
        lv_resultat         = zglog_resultat_ko.
      ENDIF.
      "<< SPEC-67085, Final Modificació - ETODR
    ENDIF.
    IF _tipus = 'U'. "Centralizado

*      wa_signer-id      = zgdgusers-ssfid_hash.
      wa_signer-profile = zgdgusers-ssf_prof.
      wa_signer-password = ''.
      wa_signer-result = '28'.
      APPEND wa_signer TO it_signer.
      st_ssfparms-ssftoolkit = 'gdgcrypt'.

      st_ssfparms-binccerts = 'X'.
      st_ssfparms-bdetached = ' '.
      st_ssfparms-binenc = 'X'.
      st_ssfparms-iospec = 'T'.
      st_ssfparms-ssfhashalg = 'SHA1'.
      st_ssfparms-ssfcrc = '0'.



      CALL FUNCTION 'SSF_SIGN'
        EXPORTING
          ssf_dest                     = 'SAP_SSFATGUI'
          str_format                   = st_ssfparms-ssfformat
          b_inc_certs                  = st_ssfparms-binccerts
          b_detached                   = st_ssfparms-bdetached
          b_inenc                      = st_ssfparms-binenc
          io_spec                      = st_ssfparms-iospec
          ostr_input_data_l            = filelength "tamaño del fichero binario
          str_hashalg                  = st_ssfparms-ssfhashalg
        IMPORTING
          ostr_signed_data_l           = st_ssfparms-outdatalen
          crc                          = st_ssfparms-ssfcrc
        TABLES
          ostr_input_data              = filedata
          signer                       = it_signer
          ostr_signed_data             = filedata2
        EXCEPTIONS
          ssf_rfc_error                = 1
          ssf_rfc_no_memory            = 2
          ssf_rfc_get_data_error       = 3
          ssf_rfc_send_data_error      = 4
          ssf_rfc_signer_list_error    = 5
          ssf_rfc_input_data_error     = 6
          ssf_fb_input_parameter_error = 7
          ssf_rfc_destination_error    = 8
          OTHERS                       = 9.

      ">> SPEC-67085, Inici Modificació - ETODR
      IF sy-subrc <> 0.
        ls_log_clau-sysubrc = sy-subrc.
        lv_resultat         = zglog_resultat_ko.
      ENDIF.
      "<< SPEC-67085, Final Modificació - ETODR

      CALL FUNCTION 'RFC_CONNECTION_CLOSE'
        EXPORTING
          destination          = 'SAP_SSFATGUI'
        EXCEPTIONS
          destination_not_open = 1
          OTHERS               = 2.
      IF sy-subrc <> 0.
        ">> SPEC-67085, Inici Modificació - ETODR
        ls_log_clau-sysubrc = sy-subrc.
        lv_resultat         = zglog_resultat_ko.
        "<< SPEC-67085, Final Modificació - ETODR
      ENDIF.

    ENDIF.



    IF st_ssfparms-outdatalen > 0 AND filedata2 IS NOT INITIAL. "Todo correcto. Marcamos la info
      FILELENGTH = st_ssfparms-outdatalen.
      filedata = filedata2.
      CLEAR lv_lines.

      CASE st_ssfparms-ssfformat.
        WHEN 'PDFTSA'.
          zgdglog-zgdg_signat_log   = 'X'.
          zgdglog-zgdg_tsa_log      = 'X'.
          zgdglog-zgdg_ltv_log      = space.

        WHEN 'STMPLTV'.
          zgdglog-zgdg_signat_log   = 'X'.
          zgdglog-zgdg_tsa_log      = space.
          zgdglog-zgdg_ltv_log      = space.

        WHEN ''.
          CLEAR zgdglog.

        WHEN OTHERS.

      ENDCASE.
    ELSE.
      CLEAR zgdglog.
      ">> SPEC-67085, Inici Modificació - ETODR
      lv_resultat = zglog_resultat_ko.
      "<< SPEC-67085, Final Modificació - ETODR
    ENDIF.

    ">> SPEC-67085, Inici Modificació - ETODR
    IF go_log_global IS BOUND.
      go_log_global->afegir_entrada( EXPORTING  iv_tasca    = zglog_tasca_final
                                                iv_resultat = lv_resultat
                                                is_clau     = ls_log_clau
                                     EXCEPTIONS OTHERS      = 0 ).
    ENDIF.
    "<< SPEC-67085, Final Modificació - ETODR

  ENDMETHOD.


  METHOD subsanar_doc.

    DATA: lv_aux3     TYPE char50,
          lv_subrc    TYPE sy-subrc,
          lv_error_rc TYPE sy-subrc,
          lv_env_des  TYPE flag ,                     "  SPEC-52934
          lv_version  TYPE zdocs_signa_des-version ,  "  SPEC-52934
          lt_sides    TYPE TABLE OF zdocs_signa_des . "  SPEC-52934

    DATA: s_zgdg_docs      TYPE zgdg_docs,
          lv_callstack     TYPE abap_callstack,
          lr_gdg           TYPE REF TO   zcl_gdg,
          lv_proces        TYPE zgdg_proces,
          lv_answer        TYPE char1,
          lv_docclass_exp  TYPE bapidclass,
          lv_objectid_exp  TYPE bapiguid,
          ls_docs_doc      TYPE zrm_dt_docs_doc,
          lv_computer_name TYPE string,
          lv_maquina       TYPE z_maquina_remote,
          lt_text_popup    TYPE catsxt_longtext_itab,
          ls_text_popup    TYPE txline,
          lv_text_popup    TYPE string,
          lv_motiu         TYPE char200, " SPEC-72942 - ECMRG
          lv_titel(4)      VALUE 'Avis', "spec 68353 ecbac 18.01.2022
          lv_long          TYPE i, "spec 68353 ecbac 18.01.2022
          l_rc             TYPE abap_bool,
          ls_log2          TYPE zfi_dt_mant_log2,
          ls_log2_aux      TYPE zfi_dt_mant_log2,
          lt_gdgdocs       TYPE TABLE OF zgdg_docs. "SPEC-87166

    CONSTANTS: gc_cancel     TYPE char1   VALUE 'C'.
    CONSTANTS: lc_cont       TYPE char7   VALUE 'CX_CONT'. "spec 68353 ecbac 18.01.2022

*   SPEC-60538 Si és un document Mod. Aut. BPM, el popup ja s'ha preguntat abans de
*   cridar a aquest mètode
    IF iv_anchor NE 'CT004'.
      CALL FUNCTION 'POPUP_TO_CONFIRM'
        EXPORTING
          titlebar              = 'Refusar'
          text_question         = 'Es cancel·larà el flux de signatura. Voleu continuar?'
          text_button_1         = 'Continuar'
          text_button_2         = 'Cancel·lar'
          display_cancel_button = abap_false
        IMPORTING
          answer                = lv_answer
        EXCEPTIONS
          text_not_found        = 1
          OTHERS                = 2.
      CHECK lv_answer = '1'.
    ENDIF.
    "1.Entrem i bloquegem el document

    CALL FUNCTION 'ENQUEUE_EZLOCKGDG_DOCS'
      EXPORTING
        docclass       = iv_documentclass
        objectid       = iv_objectid
      EXCEPTIONS
        foreign_lock   = 1
        system_failure = 2
        OTHERS         = 3.

    lv_error_rc  = sy-subrc.

    IF iv_anchor NE 'CT004'.
      " Popup motiu de rebutj
      CALL FUNCTION 'CATSXT_SIMPLE_TEXT_EDITOR'
        EXPORTING
          im_title = 'Motiu de rebuig'
        CHANGING
          ch_text  = lt_text_popup.

      CHECK sy-ucomm EQ 'CX_CONT'.

      IF lt_text_popup IS INITIAL.
        MESSAGE 'Si us plau, informeu el motiu de l''esmena.' TYPE 'I' DISPLAY LIKE 'E'.
      ENDIF.
      CHECK lt_text_popup IS NOT INITIAL.

      IF lt_text_popup IS NOT INITIAL.

        LOOP AT lt_text_popup INTO ls_text_popup.
          lv_text_popup = lv_text_popup && ` ` && ls_text_popup.
          lv_long = strlen( lv_text_popup ). "spec 68353 ecbac 18.01.2022
        ENDLOOP.

        WHILE lv_long GT 200.
          CLEAR lv_long.
          CALL FUNCTION 'POPUP_TO_DISPLAY_TEXT_LO'
            EXPORTING
              titel     = lv_titel
              textline1 = text-001.

          " Popup motiu de rebutj
          CALL FUNCTION 'CATSXT_SIMPLE_TEXT_EDITOR'
            EXPORTING
              im_title = text-002 "'Motiu de rebuig'
            CHANGING
              ch_text  = lt_text_popup.

          CHECK sy-ucomm EQ lc_cont. "'CX_CONT'.

          IF lt_text_popup IS INITIAL.
            MESSAGE text-003 TYPE 'I' DISPLAY LIKE 'E'.
          ENDIF.
          CHECK lt_text_popup IS NOT INITIAL.
          CLEAR lv_text_popup.
          LOOP AT lt_text_popup INTO ls_text_popup.
            lv_text_popup = lv_text_popup && ` ` && ls_text_popup.
            lv_long = strlen( lv_text_popup ).
          ENDLOOP.

        ENDWHILE.

        CHECK sy-ucomm EQ  lc_cont. "'CX_CONT'.

        CONDENSE lv_text_popup.
        lv_motiu = lv_text_popup.

      ENDIF.

    ENDIF.


    ev_rc = lv_error_rc.

    IF lv_error_rc = 0.  " 2.Si hem pogut bloquejar, subsanem

      lv_aux3 = iv_version.
      lv_version = iv_version. " 29/07/2109

      UPDATE zgdg_docs     " Actualitzem la taula de documents
         SET status        = gc_cancel
             accions       = ''
             motiu_rebutj  = lv_motiu
             data_rebutj   = sy-datum
             hora_rebutj   = sy-uzeit
       WHERE docclass    = iv_documentclass   " Class  Document
         AND objectid    = iv_objectid   " Object Document
         AND version     = lv_version.

*     Passem el resultat
      lv_subrc = sy-subrc.
      ev_rc    = lv_subrc.

*     ini SPEC-52934 - Signatura Desatesa
      CALL METHOD zcl_signatura_desatesa=>enviat_a_desatesa
        EXPORTING
          iv_objectid = iv_objectid
          iv_docclass = iv_documentclass
          iv_version  = lv_version
        RECEIVING
          rv_enviat   = lv_env_des.

      IF lv_env_des = abap_true.
        SELECT *
          INTO TABLE lt_sides
          FROM zdocs_signa_des
         WHERE docclass = iv_documentclass
           AND objectid = iv_objectid
           AND version  = lv_version  .

        CALL METHOD zcl_signatura_desatesa=>esmena_massiva
          EXPORTING
            it_docs_signa_des = lt_sides
            iv_desde_desatesa = abap_false.
      ENDIF.
*     fin SPEC-52934

*     Si ha anat tot be, seguim actualitzant els responsables del document
      IF lv_subrc = 0.

        CLEAR: lv_docclass_exp, lv_objectid_exp.
*       primero buscamos con el objectid de expediente por si se tratara de un envio
*       desde el gestor documental. El objecid del expediente en el gestor es el mismo que
*       el del documento
        SELECT SINGLE   docclass  objectid
          INTO ( lv_docclass_exp, lv_objectid_exp )
          FROM zrm_dt_resp_doc
         WHERE z_codi_exp = iv_codi_exp
           AND objectid   = iv_objectid.
        IF sy-subrc NE 0.
          SELECT SINGLE docclass objectid
            FROM zrm_dt_resp_doc
            INTO ( lv_docclass_exp, lv_objectid_exp )
           WHERE z_codi_exp = iv_codi_exp.
        ENDIF.

*       Obtenim el nom del portatil de l'usuari que subsana
        cl_gui_frontend_services=>get_computer_name(
           CHANGING       computer_name        = lv_computer_name
           EXCEPTIONS     cntl_error           = 1
                          error_no_gui         = 2
                          not_supported_by_gui = 3
                          OTHERS               = 4 ).
        IF sy-subrc <> 0.
*       Implement suitable error handling here
        ELSE.
          CALL METHOD cl_gui_cfw=>flush
            EXCEPTIONS
              OTHERS = 1.
          lv_maquina = lv_computer_name.
        ENDIF.

        UPDATE zrm_dt_resp_doc  "Actualitzem la taula de responsables dels document
           SET z_subsanat          = abap_on
               z_data_subsanacio   = sy-datum
               z_hora_subsanacio   = sy-uzeit
               z_usuari_subsanacio = sy-uname
               maquina_subsa       = lv_maquina
         WHERE z_codi_exp    = iv_codi_exp
           AND docclass      = lv_docclass_exp
           AND objectid      = lv_objectid_exp
           AND z_anchor      = iv_anchor
           AND z_versio      = iv_version.

        lv_subrc = sy-subrc.
        ev_rc    = lv_subrc.

        IF lv_subrc EQ 0.  " Si ha anat tot be, desbloquegem el document



          CALL FUNCTION 'DEQUEUE_EZLOCKGDG_DOCS'  " 3.Desbloquegem perquè ja hem acabat amb aquest document
            EXPORTING
              docclass = iv_documentclass
              objectid = iv_objectid.

          IF sy-subrc <> 0.
*            Sempre es desbloqueja be... no controlem l'error
          ENDIF.

*         Comuniquem la subsanació als interesats


          SELECT SINGLE tipus_proces   " Obtenim el tipus de procés
            FROM zgdg_docs INTO (lv_proces)
           WHERE objectid = iv_objectid
             AND docclass = iv_documentclass.

          SELECT SINGLE *
            FROM zrm_dt_docs_doc
            INTO ls_docs_doc
           WHERE docclass      = lv_docclass_exp
             AND objectid      = lv_objectid_exp
             AND docclass_doc  = iv_documentclass
             AND objectid_doc  = iv_objectid
             AND z_anchor      = iv_anchor
             AND z_versio      = iv_version.

          "Comuniquem la esmena als interessats
          zcl_utilitats_signa=>comunicar_esmena(
            EXPORTING iv_codi_exp     =  iv_codi_exp
                      iv_objectid     =  iv_objectid
                      iv_docclass     =  iv_documentclass
                      iv_tipus_proces =  lv_proces
                      iv_esmena_total =  'X'
                      iv_iniciador    =  ls_docs_doc-z_usuari_enviament
                      iv_desde_desatesa = abap_false ).

          ">> SPEC-87166, Inici Modificació - EVCHA
          SELECT SINGLE *
            FROM zfi_dt_mant_log2
            INTO ls_log2_aux
           WHERE docclass_doc = iv_documentclass
             AND objectid_doc = iv_objectid
             AND zinterfase   = 'PLA_EXPED'.
          IF sy-subrc = 0.
            SELECT SINGLE *
              FROM zfi_dt_mant_log2
              INTO ls_log2
             WHERE projecte   = ls_log2_aux-projecte
               AND zinterfase = 'COMANDA'
               AND idnot      = ls_log2_aux-idnot.
          ENDIF.
          ">> SPEC-87166, Fi Modificació - EVCHA

          "INI SPEC-87167
          "En cas que hi hagi registre a manttest, l'esborrem
          DELETE FROM zfi_dt_mant_log2
           WHERE projecte = ls_log2_aux-projecte
             AND idnot    = ls_log2_aux-idnot. "docclass_doc = iv_documentclass AND objectid_doc = iv_objectid. "AND zinterfase = 'PLA_EXPED'.
          ">> SPEC-87166, Inici Modificació - EVCHA
          IF sy-subrc = 0.

            SELECT *
              FROM zgdg_docs
              INTO TABLE lt_gdgdocs
              WHERE docclass = iv_documentclass AND
                    objectid = iv_objectid.
            IF sy-subrc = 0.
              LOOP AT lt_gdgdocs ASSIGNING FIELD-SYMBOL(<lfs_gdgdocs>).
                <lfs_gdgdocs>-status = 'C'.
                <lfs_gdgdocs>-accions = ''.
              ENDLOOP.
              IF lt_gdgdocs IS NOT INITIAL.
                MODIFY zgdg_docs FROM TABLE lt_gdgdocs.
              ENDIF.
            ENDIF.
            CALL METHOD zcl_utils_docs=>moure_doc_a_esmenats
              EXPORTING
                iv_docclass_exp = lv_docclass_exp
                iv_objectid_exp = lv_objectid_exp
                iv_docclass_doc = iv_documentclass
                iv_objectid_doc = iv_objectid
                iv_version      = lv_version
                iv_model_id     = '158' "anchor ESMENATS         "'163' "anchor PLAINTERVENCIONS
                iv_log2         = ls_log2
              RECEIVING
                rc              = l_rc.
          ENDIF.
          "<< SPEC-87166, Final Modificació - EVCHA
          "FI SPEC-87167

          MESSAGE 'Document subsanat' TYPE 'S'.
          SET PARAMETER ID 'ZRM_LOCKED' FIELD abap_true.

        ELSE.
          "Si la segona actualització ha anat malament, desdem la primera
          ROLLBACK WORK.
        ENDIF.

      ENDIF.
*     Si alguna cosa ha sortit malament, missatge...
      IF lv_subrc <> 0.
        MESSAGE 'No s''ha pogut subsanar el document' TYPE 'S'.
      ENDIF.

    ELSE.
*     En cas que No es pugui bloquejar l’objecte, missatge...
      MESSAGE 'El document està essent bloquejat ara mateix per altre usuari'(EX1)
      TYPE 'S' DISPLAY LIKE 'W'.
      EXIT.
    ENDIF.

*   En cas que No es pugui desbloquejar l’objecte, message
    IF lv_error_rc <> 0.
      MESSAGE 'El document no es pot desbloquejar'(EX2) TYPE 'S' DISPLAY LIKE 'W'.
      EXIT.
    ENDIF.

  ENDMETHOD.


  METHOD valid_seleccions_previ_firma.

    ">> SPEC-67085, Inici Modificació - ETODR
    DATA: lv_resultat TYPE zlog_global-resultat.

    IF go_log_global IS BOUND.
      go_log_global->crea_clau( EXPORTING iv_objectid       = im_docid
                                          iv_docclass       = im_classid
                                          iv_pos            = im_pos
                                          iv_z_posicio_hash = im_pos_hash
                                IMPORTING es_log_clau       = DATA(ls_log_clau) ).

      go_log_global->afegir_entrada( EXPORTING  iv_tasca = zglog_tasca_inicial
                                                is_clau  = ls_log_clau
                                     EXCEPTIONS OTHERS   = 0 ).
    ENDIF.
    "<< SPEC-67085, Final Modificació - ETODR

    "Comprobamos que el documento se ha enviado a firmar
    SELECT SINGLE *
      FROM zgdg_docs
      INTO ex_zgdg_docs
     WHERE docclass       = im_classid
       AND objectid       = im_docid
       AND pos            = im_pos
       AND z_posicio_hash = im_pos_hash
       AND accions        = 'F'.

    IF sy-subrc <> 0 AND _tipus <> 'C'.
      RAISE zgdg_doc_not_found.
    ENDIF.

    SELECT SINGLE *
    FROM zgdg_pos_signa
    INTO pos_signa
    WHERE gdg_anchor = 'DEFAULT'
    AND pos = 1 .

    ch_zgdg_pos_signa_bkp = pos_signa .

    IF is_active = abap_false.
      RAISE user_not_active.
    ENDIF.

    "ECJSA - per evitar que les signatures no disposin d'imatge
    "(a signatura desatesa amb bookmark o Anchor), agafem la primera
    "Mirem si la persona ha punxat a la pàgina
    SELECT SINGLE *
      FROM zgdg_web_hash
      INTO ch_web_hash
     WHERE hash   = im_pos_hash
       AND pos    = im_pos AND
           usuari = ex_zgdg_docs-usuari.

    ">> SPEC-67085, Inici Modificació - ETODR
    IF go_log_global IS BOUND.
      IF is_active = abap_false.
        lv_resultat = zglog_resultat_ko.
      ELSE.
        lv_resultat = zglog_resultat_ok.
      ENDIF.
      go_log_global->afegir_entrada( EXPORTING  iv_tasca    = zglog_tasca_final
                                                iv_resultat = lv_resultat
                                                is_clau     = ls_log_clau
                                     EXCEPTIONS OTHERS      = 0 ).
    ENDIF.
    "<< SPEC-67085, Final Modificació - ETODR

  ENDMETHOD.


  METHOD _init.

    DATA ostr_output_data(255).
    DATA ostr_output_data_l TYPE int4.
    DATA crc TYPE int4.
    DO 30 TIMES.


*Antes de operar hay que inicializar el producto de seguridad
      CALL FUNCTION 'SSF_KRN_VERSION'
        EXPORTING
          ssftoolkit             = st_ssfparms-ssftoolkit
        IMPORTING
          ostr_output_data       = ostr_output_data
          ostr_output_data_l     = ostr_output_data_l
          crc                    = crc
        EXCEPTIONS
          ssf_krn_error          = 1
          ssf_krn_noop           = 2
          ssf_krn_opinv          = 3
          ssf_krn_nossflib       = 4
          ssf_krn_invalid_par    = 5
          ssf_krn_invalid_parlen = 6
          OTHERS                 = 7.

      IF sy-subrc <> 0.
* Implement suitable error handling here
      ENDIF.

      CALL FUNCTION 'SSF_KRN_QUERYPROPERTIES'
        EXPORTING
          ssftoolkit             = st_ssfparms-ssftoolkit
          property               = 'PROPERTIES'
          argument               = ''
        IMPORTING
          ostr_output_data       = ostr_output_data
          ostr_output_data_l     = ostr_output_data_l
          crc                    = crc
        EXCEPTIONS
          ssf_krn_error          = 1
          ssf_krn_noop           = 2
          ssf_krn_opinv          = 3
          ssf_krn_nossflib       = 4
          ssf_krn_invalid_par    = 5
          ssf_krn_invalid_parlen = 6
          OTHERS                 = 7.
      IF sy-subrc <> 0.
* Implement suitable error handling here
      ENDIF.
      IF ostr_output_data IS INITIAL.
        WAIT UP TO 1 SECONDS.
      ELSE.
        EXIT.
      ENDIF.
    ENDDO.

  ENDMETHOD.
ENDCLASS.